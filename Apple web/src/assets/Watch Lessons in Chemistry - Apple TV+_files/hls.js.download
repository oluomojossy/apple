/*! For license information please see hls.js.LICENSE.txt */
!function ov(lv){const dv=this;var e,t;e=this,t=function(){"use strict";var j,e=e=>e&&e.Math===Math&&e,u=e("object"==typeof globalThis&&globalThis)||e("object"==typeof window&&window)||e("object"==typeof dv&&dv)||e("object"==typeof global&&global)||Function("return this")();class l{constructor(){this.rcon=[],this.subMix=[],this.invSubMix=[],this.keySize=null,this.ksRows=null,this.keySchedule=null,this.invKeySchedule=null,this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.initTable()}uint8ArrayToUint32Array_(e){const t=new DataView(e),i=Math.floor(t.byteLength/4),r=new Uint32Array(i);for(let e=0;e<i;e++)r[e]=t.getUint32(4*e);return r}initTable(){const e=this["sBox"],t=this["invSBox"],i=this["subMix"],r=i[0],n=i[1],a=i[2],s=i[3],o=this["invSubMix"],l=o[0],d=o[1],u=o[2],c=o[3],h=new Uint32Array(256);let p=0,m=0,f=0;for(f=0;f<256;f++)h[f]=f<128?f<<1:f<<1^283;for(f=0;f<256;f++){var g=(g=m^m<<1^m<<2^m<<3^m<<4)>>>8^255&g^99;e[p]=g,t[g]=p;const o=h[p],f=h[o],v=h[f];var y=257*h[g]^16843008*g;r[p]=y<<24|y>>>8,n[p]=y<<16|y>>>16,a[p]=y<<8|y>>>24,s[p]=y,y=16843009*v^65537*f^257*o^16843008*p,l[g]=y<<24|y>>>8,d[g]=y<<16|y>>>16,u[g]=y<<8|y>>>24,c[g]=y,p?(p=o^h[h[h[v^o]]],m^=h[h[m]]):p=m=1}}expandKey(e){var n=this.uint8ArrayToUint32Array_(e);let t=!0,i=0;for(;i<n.length&&t;)t=n[i]===this.key[i],i++;if(!t){this.key=n;var a=this.keySize=n.length;if(4!==a&&6!==a&&8!==a)throw new Error("Invalid aes key size="+a);var s=this.ksRows=4*(a+6+1);let e,t;const o=this.keySchedule=new Uint32Array(s),l=this.invKeySchedule=new Uint32Array(s),d=this.sBox,u=this["rcon"],c=this["invSubMix"],h=c[0],p=c[1],m=c[2],f=c[3];let i,r;for(e=0;e<s;e++)e<a?i=o[e]=n[e]:(r=i,r&&(e%a==0?(r=r<<8|r>>>24,r=d[r>>>24]<<24|d[r>>>16&255]<<16|d[r>>>8&255]<<8|d[255&r],r^=u[e/a|0]<<24):6<a&&e%a==4&&(r=d[r>>>24]<<24|d[r>>>16&255]<<16|d[r>>>8&255]<<8|d[255&r]),o[e]=i=(o[e-a]^r)>>>0));for(t=0;t<s;t++)e=s-t,r=3&t?o[e]:o[e-4],l[t]=t<4||e<=4?r:h[d[r>>>24]]^p[d[r>>>16&255]]^m[d[r>>>8&255]]^f[d[255&r]],l[t]=l[t]>>>0}}networkToHostOrderSwap(e){return e<<24|(65280&e)<<8|(16711680&e)>>8|e>>>24}decrypt(e,t,i){var r,n,a=this.keySize?this.keySize+6:0,s=this["invKeySchedule"],o=this.invSBox,l=this["invSubMix"],d=l[0],u=l[1],c=l[2],h=l[3],i=this.uint8ArrayToUint32Array_(i);let p=i[0],m=i[1],f=i[2],g=i[3];const y=new Int32Array(e),v=new Int32Array(y.length);let S,I,b,T,E,A,O,w,R,C,k,M,P,L;const x=this.networkToHostOrderSwap;for(;t<y.length;){for(R=x(y[t]),C=x(y[t+1]),k=x(y[t+2]),M=x(y[t+3]),E=R^(null!==(n=null==s?void 0:s[0])&&void 0!==n?n:0),A=M^(null!==(n=null==s?void 0:s[1])&&void 0!==n?n:0),O=k^(null!==(n=null==s?void 0:s[2])&&void 0!==n?n:0),w=C^(null!==(n=null==s?void 0:s[3])&&void 0!==n?n:0),P=4,L=1;L<a;L++)S=d[E>>>24]^u[A>>16&255]^c[O>>8&255]^h[255&w]^(null!==(r=null==s?void 0:s[P])&&void 0!==r?r:0),I=d[A>>>24]^u[O>>16&255]^c[w>>8&255]^h[255&E]^(null!==(r=null==s?void 0:s[P+1])&&void 0!==r?r:0),b=d[O>>>24]^u[w>>16&255]^c[E>>8&255]^h[255&A]^(null!==(r=null==s?void 0:s[P+2])&&void 0!==r?r:0),T=d[w>>>24]^u[E>>16&255]^c[A>>8&255]^h[255&O]^(null!==(r=null==s?void 0:s[P+3])&&void 0!==r?r:0),E=S,A=I,O=b,w=T,P+=4;S=o[E>>>24]<<24^o[A>>16&255]<<16^o[O>>8&255]<<8^o[255&w]^(null!==(n=null==s?void 0:s[P])&&void 0!==n?n:0),I=o[A>>>24]<<24^o[O>>16&255]<<16^o[w>>8&255]<<8^o[255&E]^(null!==(n=null==s?void 0:s[P+1])&&void 0!==n?n:0),b=o[O>>>24]<<24^o[w>>16&255]<<16^o[E>>8&255]<<8^o[255&A]^(null!==(n=null==s?void 0:s[P+2])&&void 0!==n?n:0),T=o[w>>>24]<<24^o[E>>16&255]<<16^o[A>>8&255]<<8^o[255&O]^(null!==(n=null==s?void 0:s[P+3])&&void 0!==n?n:0),P+=3,v[t]=x(S^p),v[t+1]=x(T^m),v[t+2]=x(b^f),v[t+3]=x(I^g),p=R,m=C,f=k,g=M,t+=4}return v.buffer}destroy(){this.key=new Uint32Array,this.keySize=null,this.ksRows=null,this.sBox=new Uint32Array,this.invSBox=new Uint32Array,this.subMix=[],this.invSubMix=[],this.keySchedule=null,this.invKeySchedule=null,this.rcon=[]}}class i{constructor(e,t){this.rpc=e,this.logger=t,this.decrypt=(r,n,a,s,o)=>t=>{const i=u.crypto;if(null!=o&&o.useJSCrypto||null==i||!i.subtle){const a=new l;var e;a.expandKey(r);const i=a.decrypt(s,0,n);e=o.plainTextLength?i.slice(0,o.plainTextLength):function(e){var t=new Uint8Array(e),i=t[e.byteLength-1],r=e.byteLength-1;let n=0;if(1<=i&&i<=16)for(let e=r;e>r-i&&t[e]===i;e--)n++;return e=n===i?e.slice(0,r-i+1):e}(i),t(e,void 0,[e])}else i.subtle.importKey("raw",r,a,!1,["decrypt"]).then(e=>i.subtle.decrypt({name:a,iv:n},e,s)).then(e=>{t(e,void 0,[e])}).catch(e=>t(void 0,e))},e.register("decrypt",this.decrypt)}}(L=j=j||{}).MEDIA_ATTACHING="hlsMediaAttaching",L.MEDIA_ATTACHED="hlsMediaAttached",L.MEDIA_DETACHING="hlsMediaDetaching",L.MEDIA_DETACHED="hlsMediaDetached",L.BUFFER_CREATED="hlsBufferCreated",L.BUFFER_APPENDING="hlsBufferAppending",L.BUFFER_APPENDED="hlsBufferAppended",L.BUFFER_FLUSHED="hlsBufferFlushed",L.MANIFEST_LOADING="hlsManifestLoading",L.MANIFEST_LOADED="hlsManifestLoaded",L.MANIFEST_PARSED="hlsManifestParsed",L.LEVEL_SWITCHING="hlsLevelSwitching",L.LEVEL_SWITCHED="hlsLevelSwitched",L.LEVEL_LOADING="hlsLevelLoading",L.LEVEL_LOADED="hlsLevelLoaded",L.LEVEL_UPDATED="hlsLevelUpdated",L.LEVELS_CHANGED="hlsLevelsChanged",L.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",L.AUDIO_TRACK_SWITCH="hlsAudioTrackSwitch",L.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",L.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",L.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",L.SUBTITLE_TRACKS_CREATED="hlsSubtitleTracksCreated",L.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",L.INLINE_STYLES_PARSED="hlsInlineStylesParsed",L.SESSION_DATA_COMPLETE="hlsSessionDataComplete",L.FRAG_LOADING="hlsFragLoading",L.FRAG_LOADED="hlsFragLoaded",L.FRAG_BUFFERED="hlsFragBuffered",L.FRAG_CHANGED="hlsFragChanged",L.INTERNAL_ERROR="hlsInternalError",L.ERROR="hlsError",L.DESTROYING="hlsDestroying",L.KEY_REQUEST_STARTED="hlsKeyRequestStarted",L.LICENSE_CHALLENGE_CREATED="hlsLicenseChallengeCreated",L.LICENSE_RELEASED="hlsLicenseReleased",L.KEY_LOADED="hlsKeyLoaded",L.UNRESOLVED_URI_LOADING="hlsUnresolvedUriLoading",L.DESIRED_RATE_CHANGED="hlsDesiredRateChanged",L.PLAYER_STATE_CHANGE="hlsPlayerStateChange",L.SEEKING="hlsSeeking",L.SEEKED="hlsSeeked",L.STALLED="hlsStalled",L.RESUME_FROM_STALL="hlsResumeFromStall",L.READY_TO_PREFETCH_NEXT_ITEM="hlsReadyToPrefetchNextItem",L.READY_FOR_NEXT_ITEM="hlsReadyForNextItem",L.ITEM_TRANSITIONED="hlsItemTransitioned",L.ITEM_PLAYING="hlsItemPlaying",L.ITEM_EVICTED="hlsItemEvicted",L.DATERANGE_UPDATED="hlsDaterangeUpdated",L.INTERSTITIALS_UPDATED="hlsInterstitialsUpdated",L.INTERSTITIAL_STARTED="hlsInterstitialStarted",L.INTERSTITIAL_ASSET_STARTED="hlsInterstitialAssetStarted",L.INTERSTITIAL_ASSET_ENDED="hlsInterstitialAssetEnded",L.INTERSTITIAL_ENDED="hlsInterstitialEnded",L.BUFFERED_TO_INTERSTITIAL_BOUNDARY="hlsBufferedToInterstitialBoundary",L.OFFLINE_FAIRPLAY_DEVICE_CAPS="hlsOfflineFairplayDeviceCaps";var b,U,V,N=j;(Ci=b=b||{}).FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",Ci.FRAG_PARSING_DATA="hlsFragParsingData",Ci.FRAG_PARSED="hlsFragParsed",Ci.INIT_PTS_FOUND="hlsInitPtsFound";class v extends Error{constructor(e,t,i,r,n,a){super(r),this.type=e,this.details=t,this.fatal=i,this.reason=r,this.response=n,this.handled=!1,a&&(this.stack=a)}}class $ extends v{constructor(e,t,i,r,n){super(e,t,i,r,n),this.response=n}}const G={PlaylistNotReceived:{code:-12884,text:"Playlist not received"},CryptResponseReceivedSlowly:{code:-16833,text:"Crypt key received slowly"},LivePlaylistUpdateError:{code:-12888,text:"Live playlist not updated"},NoResponseFromMediaRequest:{code:-12889,text:"No response for fragment"},IncompatibleAsset:{code:-12927,text:"IncompatibleAsset"},CorruptStream:{code:-16041,text:"Corrupt fragment"},InternalError:{code:-12645,text:"InternalException"},CantSwitchInTime:{code:-12644,text:"CantSwitchInTime"},VideoDecoderBadDataErr:{code:-12909,text:"Buffer error"},InsufficientDataAvailable:{code:-12928,text:"Incomplete data"},AllocationFailed:{code:-12862,text:"AllocationFailed"},PlaylistErrorMissingEXTM3U:{code:-12269,text:"Response doesnt have #EXTM3U tag"},PlaylistErrorInvalidEntry:{code:-12264,text:"Invalid entry"},PlaylistErrorBadTargetDuration:{code:-12271,text:"Invalid targetduration"},NoValidAlternates:{code:-12925,text:"No valid alternates"},FormatError:{code:-12642,text:"Incorrect playlist format"},ContentHasGap:{code:-15419,text:"Gap fragment encountered"},UnsupportedKeySystemError:{code:-6e4,text:"Unsupported Key System"},EmptyLoadSourceError:{code:-60001,text:"Empty loadSource url"},UndefinedItemIdError:{code:-60002,text:"Undefined itemId"},ManifestParseError:{code:-60003,text:"Manifest parse error"},DemuxWorkerError:{code:-60004,text:"Demux worker error"},DecryptWorkerError:{code:-60005,text:"Decrypt worker error"},OutOfRangeSeekError:{code:-60006,text:"Seeked out of playable range"},ExceptionInKeyLoadError:{code:-60007,text:"Exception in Key load"},FragmentAbortError:{code:-60008,text:"Fragment abort error"},ManifestTimeoutError:{code:-60009,text:"Manifest Timeout Error"},PlaylistTimeoutError:{code:-60010,text:"Playlist Timeout Error"},FragmentTimeoutError:{code:-60011,text:"Fragment Timeout Error"},IncompleteSessionData:{code:-60012,text:"Session data not complete after loading all items"},SessionDataLoadTimeout:{code:-60013,text:"Session data load timeout"},FailedDemuxerSanityCheck:{code:-60014,text:"Failed demuxer sanity check"},InvalidADTSSamplingIndex:{code:-60015,text:"Invalid ADTS sampling index"},DemuxerNotFound:{code:-60016,text:"No demux matching with content found"},InvalidAC3Magic:{code:-60029,text:"Invalid ac-3 magic"},InvalidInitTimestamp:{code:-60017,text:"Invalid initPTS or initDTS"},NoAVSamplesFound:{code:-60018,text:"no audio/video samples found"},NoTSSyncByteFound:{code:-60019,text:"TS packet did not start with 0x47"},PESDidNotStartWithADTS:{code:-60020,text:"AAC PES did not start with ADTS header"},NoADTSHeaderInPES:{code:-60021,text:"No ADTS header found in AAC PES"},InvalidDolbyAudioMagic:{code:-60022,text:"Invalid dolby audio magic"},FailedToAllocateVideoMdat:{code:-60023,text:"Fail allocating video mdat"},FailedToAllocateAudioMdat:{code:-60024,text:"Fail allocating audio mdat"},InsufficientEC3Data:{code:-60025,text:"Error parsing ec-3, not enough data"},InvalidEC3Magic:{code:-60026,text:"Invalid ec-3 magic"},ReservedStreamType:{code:-60027,text:"Reserved stream type"},InsufficientAC3Data:{code:-60028,text:"error parsing ac-3, not enough data"},InvalidAC3SamplingRateCode:{code:-60030,text:"Invalid ac-3 samplingRateCode"},LivePlaylistTooFar:{code:-60031,text:"Live playlist too far"},XhrError:{code:-60032,text:"Generic XHR error"},UnsupportedMediaCodec:{code:-60033,text:"Unsupported Audio or video codec on this platform"},FilterOutBasedOnCaps:{code:-60034,text:"All options filtered out based on config or platform capabilities"},UnsupportedVideoDynamicRange:{code:-60035,text:"Unsupported video dynamic range error on this platform"},UnsupportedKeySystemAccess:{code:-60036,text:"Unsupported Key System access on this platform"},SourceBufferRemoveError:{code:-60037,text:"Error while removing source buffer"},SourceBufferAbortError:{code:-60038,text:"Error while aborting source buffer"},SourceBufferUpdatingError:{code:-60039,text:"Error while updating source buffer"},ExceptionInLegacyEventHandler:{code:-60040,text:"Exception in legacy event handler"},ExceptionInKeyRequest:{code:-60041,text:"Exception in key request"},NoValidFirstAlternate:{code:-60042,text:"No valid first alternate"},PlaylistErrorInvalidEXTXDEFINE:{code:-61e3,text:"Encountered undefined/not imported EXT-X-DEFINE property"},PlaylistErrorMissingImportReference:{code:-61001,text:"IMPORT references variable not in master playlist and/or NAME"},PlaylistErrorInvalidSERVERURI:{code:-61002,text:"Encountered undefined/invalid SERVER-URI attribute for EXT-X-CONTENT-STEERING tag"},PlaylistErrorInvalidPATHWAYID:{code:-61003,text:"Encountered invalid PATHWAY-ID attribute for EXT-X-CONTENT-STEERING tag"},PlaylistErrorInvalidSCORE:{code:-61004,text:"Encountered negative/non-number SCORE property"},KeySystemFailedToUpdateSession:{code:-62e3,text:"KeySystem: Promise Rejected while updating session"},KeySystemFailedToGenerateLicenseRenewal:{code:-62001,text:"KeySystem: Failed to generate license renewal"},KeySystemFailedToGenerateLicenseRequest:{code:-62002,text:"KeySystem: Failed to generate license request"},KeySystemAbort:{code:-62003,text:"KeySystem: Aborted"},KeySystemUnexpectedStateTransition:{code:-62004,text:"KeySystem: Unexpected state transition"},KeySystemUnexpectedState:{code:-62005,text:"KeySystem: Unexpected state"},KeySystemCDMUnknownError:{code:-62006,text:"KeySystem: Unknown error from CDM"},KeySystemRequestTimedOut:{code:-62007,text:"Key request timed out"},KeySystemUnexpectedMETHOD:{code:-62008,text:"Unexpected METHOD attribute"},KeySystemUnmatchedString:{code:-62009,text:"KeySystem: string does not match"},KeySystemInternalError:{code:-62010,text:"KeySystem: internal-error"},KeySystemOutputRestricted:{code:-62011,text:"KeySystem: output-restricted"},KeySystemSetupError:{code:-62012,text:"KeySystem: setup error"},KeySystemFailedToInitialize:{code:-62013,text:"KeySystem: could not initialize"},KeySystemFailedToCreateSession:{code:-62014,text:"KeySystem: could not create session"},KeySystemUndefinedNavigator:{code:-62015,text:"KeySystem: navigator undefined"},KeySystemNoKeySystemsToTry:{code:-62016,text:"KeySystem: no key systems to try"},KeySystemNoConstructor:{code:-62017,text:"KeySystem: No constructor"},KeySystemNoKeySystemAccess:{code:-62018,text:"KeySystem: No KeySystemAccess"},KeySystemCertificateLoadError:{code:-62019,text:"KeySystem: Certificate Load Error"}};(Pi=U=U||{}).NETWORK_ERROR="networkError",Pi.MEDIA_ERROR="mediaError",Pi.MUX_ERROR="muxError",Pi.KEY_SYSTEM_ERROR="keySystemError",Pi.OTHER_ERROR="otherError",(Rn=V=V||{}).MANIFEST_LOAD_ERROR="manifestLoadError",Rn.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",Rn.MANIFEST_PARSING_ERROR="manifestParsingError",Rn.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",Rn.MANIFEST_INCOMPATIBLE_VIDEO_RANGE_ERROR="manifestIncompatibleVideoRangeError",Rn.LEVEL_LOAD_ERROR="levelLoadError",Rn.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",Rn.LEVEL_SWITCH_ERROR="levelSwitchError",Rn.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",Rn.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",Rn.SUBTITLE_TRACK_LOAD_ERROR="subtitleTrackLoadError",Rn.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeout",Rn.FRAG_LOAD_ERROR="fragLoadError",Rn.FRAG_LOOP_LOADING_ERROR="fragLoopLoadingError",Rn.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",Rn.FRAG_DECRYPT_ERROR="fragDecryptError",Rn.FRAG_PARSING_ERROR="fragParsingError",Rn.FRAG_ABORT_ERROR="fragAbortError",Rn.REMUX_ALLOC_ERROR="remuxAllocError",Rn.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",Rn.BUFFER_APPEND_ERROR="bufferAppendError",Rn.BUFFER_APPENDING_ERROR="bufferAppendingError",Rn.BUFFER_STALLED_ERROR="bufferStalledError",Rn.BUFFER_FULL_ERROR="bufferFullError",Rn.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",Rn.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",Rn.SOURCE_BUFFER_ERROR="sourceBufferError",Rn.INTERNAL_EXCEPTION="internalException",Rn.WEBVTT_EXCEPTION="webVTTException",Rn.KEY_LOAD_ERROR="keyLoadError",Rn.KEY_LOAD_TIMEOUT="keyLoadTimeOut",Rn.KEY_SYSTEM_GENERIC_ERROR="keySystemGenericError",Rn.CERT_LOAD_ERROR="certificateLoadError",Rn.CERT_LOAD_TIMEOUT="certificateLoadTimeOut",Rn.SESSION_DATA_LOAD_ERROR="sessionDataLoadError",Rn.SESSION_DATA_LOAD_TIMEOUT="sessionDataLoadTimeOut",Rn.STEERING_MANIFEST_LOAD_ERROR="steeringManifestLoadError",Rn.STEERING_MANIFEST_LOAD_TIMEOUT="steeringManifestLoadTimeOut",Rn.STEERING_MANIFEST_PARSING_ERROR="steeringManifestParsingError",Rn.INTERSTITIAL_ASSET_LIST_LOAD_ERROR="interstitialAssetListLoadError",Rn.INTERSTITIAL_ASSET_LIST_LOAD_TIMEOUT="interstitialAssetListLoadTimeout",Rn.INTERSTITIAL_ASSET_LIST_PARSING_ERROR="interstitialAssetListParsingError",Rn.UNKNOWN="";class B extends v{constructor(e,t,i,r){super(U.OTHER_ERROR,V.INTERNAL_EXCEPTION,e,t,i,r)}}class I extends v{constructor(e,t,i){super(U.MEDIA_ERROR,V.FRAG_PARSING_ERROR,e,t,i)}}class F extends v{constructor(e,t,i,r){super(U.MUX_ERROR,V.REMUX_ALLOC_ERROR,e,t,i),this.bytes=r}}function E(e){return e.baseTime/e.timescale}function Q(e,t){return{baseTime:Math.floor(e*t),timescale:t}}function m(e,t){return{baseTime:Math.floor(e.baseTime*t/e.timescale),timescale:t}}function A(e,t){return E(e)>E(t)?e:t}function w(e,t){return(e.baseTime*t.timescale-t.baseTime*e.timescale)/(e.timescale*t.timescale)}function c(e,t){return Q(E(e)+t,e.timescale)}var t=void 0!==u.Buffer?require("events").EventEmitter:class{constructor(){this.eventMap={}}_on(e,t,i=!1){return null==this.eventMap[e]&&(this.eventMap[e]=[]),i?this.eventMap[e].splice(0,0,t):this.eventMap[e].push(t),this}_off(e,t){return null!=this.eventMap[e]&&(this.eventMap[e]=this.eventMap[e].filter(e=>e.listener!==t.listener),0===this.eventMap[e].length&&delete this.eventMap[e]),this}on(e,t){return this._on(e,{listener:t,once:!1})}off(e,t){return this._off(e,{listener:t})}addListener(e,t){return this.on(e,t)}once(e,t){return this._on(e,{listener:t,once:!0})}removeListener(e,t){return this.off(e,t)}removeAllListeners(e){return e&&delete this.eventMap[e],this}setMaxListeners(e){return this}getMaxListeners(){return 1/0}listeners(e){return null==this.eventMap[e]?[]:this.eventMap[e].map(e=>e.listener)}rawListeners(e){return this.listeners(e)}emit(e,...t){if(null==this.eventMap[e])return!1;let i=!1;for(const r of this.eventMap[e]){try{r.listener.apply(this,t)}catch(e){}i=!0}return i}listenerCount(e){return null==this.eventMap[e]?0:this.eventMap[e].length}prependListener(e,t){return this._on(e,{listener:t,once:!1},!0)}prependOnceListener(e,t){return this._on(e,{listener:t,once:!0},!0)}eventNames(){return Object.keys(this.eventMap)}};class r extends t{trigger(e,t){this.emit(e,t)}}function z(e){return"number"==typeof e&&isFinite(e)}function C(e,t){return z(e)?e:t}function a(e,t){const i=Object.assign({},t);for(const r in t)if(r in e){const t=e[r];z(t)&&(i[r]=t)}return i}function K(n,a,s=e=>!0){const o=n.length;if(0!==o){let t,i=Number.NEGATIVE_INFINITY,r=NaN;for(let e=0;e<o;e++){const o=n[e];s(o)&&(r=a(o))>=i&&(i=r,t=o)}return t}}let W=!0;function f(e){return W?"<redacted>":e}function n(e){if(!e)return e;if("object"!=typeof e)return e;{if(Array.isArray(e))return e.map(n);if(e instanceof Set)return new Set(Array.from(e).map(n));const r={};for(var[t,i]of Object.entries(e))r[t]=n(i);return r}}function q(e){return(" "+e).slice(1)}function s(t,e,i){if(!(Array.isArray(e)&&Array.isArray(i)&&e.length&&i.length))return[];var[r,e]=null!==(r=h(e,([e])=>e<=t))&&void 0!==r?r:e[0],i=null!==(i=null===(i=i[e-i[0].mediaSeqNum])||void 0===i?void 0:i.start)&&void 0!==i?i:NaN;return z(i)?[r,i]:[]}function h(t,i){if(Array.isArray(t)&&!(t.length<1))for(let e=t.length-1;0<=e;e--){var r=t[e];if(i(r,e,t))return r}}function o(e){const a=new Map,s=[],o=new Set;return e.forEach(function(e){var t=e[0],e=e[1];a.has(t)||a.set(t,{id:t,afters:[]}),a.has(e)||a.set(e,{id:e,afters:[]}),null===(t=a.get(t))||void 0===t||t.afters.push(e)}),Array.from(a.keys()).forEach(e=>{!function t(e,i){const r=a.get(e);if(r){const n=r.id;o.has(e)||((i=Array.isArray(i)?i:[]).push(n),o.add(e),r.afters.forEach(function(e){if(0<=i.indexOf(e))throw new Error(`Cycle detected :  ${e} is in ${n}`);t(e.toString(),i.map(function(e){return e}))}),s.unshift(n))}}(e,[])}),s}function p(e,t){return e.size===t.size&&Object.values(e).every(e=>t.has(e))}function g(e){let t=5381,i=e.length;for(;i;)t=33*t^e.charCodeAt(--i);return(t>>>0).toString()}function S(e,t,i,r,n){let a,s,o,l=0;const d=navigator.userAgent.toLowerCase(),u=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];a=1+((192&t[i+2])>>>6);var c=(60&t[i+2])>>>2;if(!(u.length-1<c))return s=(1&t[i+2])<<2,s|=(192&t[i+3])>>>6,/firefox/i.test(d)?6<=c?(a=5,o=new Array(4),l=c-3):(a=2,o=new Array(2)):-1!==d.indexOf("android")?(a=2,o=new Array(2)):(a=5,o=new Array(4),l=r&&(-1!==r.indexOf("mp4a.40.29")||-1!==r.indexOf("mp4a.40.5"))||!r&&6<=c?c-3:((r&&-1!==r.indexOf("mp4a.40.2")||!r&&1==s)&&(a=2,o=new Array(2)),c)),o[0]=a<<3,o[0]|=(14&c)>>1,o[1]|=(1&c)<<7,o[1]|=s<<3,5===a&&(o[1]|=(14&l)>>1,o[2]=(1&l)<<7,o[2]|=8,o[3]=0),{esdsConfig:o,samplerate:u[c],channelCount:s,segmentCodec:"aac",codec:"mp4a.40."+a};{const t=new I(!0,`invalid ADTS sampling index:${c}`,G.InvalidADTSSamplingIndex);e.trigger(N.INTERNAL_ERROR,t)}}class d{constructor(e,t,i,r,n){this.observer=e,this.remuxer=t,this.config=i,this.typeSupported=r,this.logger=n}static probe(e,t){throw new Error("Method not implemented")}resetTimeStamp(e){}resetInitSegment(e,t,i,r){}destroy(){}}class y extends d{constructor(e,t,i,r,n){super(e,t,i,r,n),this.observer=e,this.remuxer=t,this.config=i,this.typeSupported=r,this.logger=n,this.esRemuxer=t}}class O{constructor(e,t,i){this.observer=e,this.config=t,this.logger=i}resetInitSegment(){}resetTimeStamp(e){}destroy(){}}function R(e){return String.fromCharCode.apply(null,new Uint16Array(e))}function k(t){const e=new ArrayBuffer(2*t.length),i=new Uint16Array(e);for(let e=0;e<t.length;e++)i[e]=t.charCodeAt(e);return e}let M,P;var e={strToUtf8array:e=>(M=M||new TextEncoder,M.encode(e)),utf8arrayToStr:e=>(P=P||new TextDecoder("utf-8"),P.decode(e)),str2ab:k,ab2str:R},L={strToUtf8array(e){e=u.Buffer.from(e,"utf-8");return new Uint8Array(e.buffer,e.byteOffset,e.byteLength)},utf8arrayToStr:e=>u.Buffer.from(e).toString("utf-8"),str2ab:k,ab2str:R};let Y={strToUtf8array(e){const t=unescape(encodeURIComponent(e)),i=new Uint8Array(t.length);for(let e=0;e<t.length;e++)i[e]=t.charCodeAt(e);return i},utf8arrayToStr:e=>String.fromCharCode.apply(null,Array.from(e)),str2ab:k,ab2str:R};"undefined"!=typeof TextEncoder&&"undefined"!=typeof TextDecoder?Y=e:"function"==typeof(null===(Ea=u.Buffer)||void 0===Ea?void 0:Ea.from)&&(Y=L);const x={name:"ID3"};class D{constructor(e,t){this.logger=t,this._payload=new Uint8Array,this._hasTimeStamp=!1,this._audioType=null,this._length=0,this._frames=[];let i,r,n,a,s=0;for(;;)if(n=D.readUTF(e,s,3),s+=3,"ID3"===n){this._minor=e[s++],this._revision=e[s++];const t=e[s++];128&t&&this.logger.error(x,"id3 tag is unsynchronized"),64&t&&(this._hasExtendedHeader=!0),i=D.readSynchSafeUint32(e.subarray(s,s+4)),s+=4,r=s+i,this._hasExtendedHeader&&(s+=D.readSynchSafeUint32(e.subarray(s,s+4))),!z(this.minor)||2<this.minor?this._parseID3Frames(e,s,r):this.logger.error(x,"[id3] doesn't support older than v2.3 tags"),s=r}else{if("3DI"!==n)return s-=3,void((a=s)&&(this._length=a,this._payload=e.slice(0,a)));s+=7}}static isHeader(e,t){return 73===e[t]&&68===e[t+1]&&51===e[t+2]&&e[t+3]<255&&e[t+4]<255&&e[t+6]<128&&e[t+7]<128&&e[t+8]<128&&e[t+9]<128}static readSynchSafeUint32(e){return 2097152*(127&e[0])+16384*(127&e[1])+128*(127&e[2])+(127&e[3])}static readUTF(e,t,i){let r="",n=t;for(var a=t+i;r+=String.fromCharCode(e[n++]),n<a;);return r}isID3Frame(e,t){return e[t+4]<128&&e[t+5]<128&&e[t+6]<128&&e[t+7]<128}decodeID3Frame(e){return"TXXX"===e.type?this.decodeTxxxFrame(e):"WXXX"===e.type?this.decodeWxxxFrame(e):"PRIV"===e.type?this.decodePrivFrame(e):"T"===e.type[0]?this.decodeTextFrame(e):{key:e.type,data:e.data}}decodeTxxxFrame(e){if(!(z(e.size)&&e.size<2)&&3===e.data[0]){var t=1,i=null!==(i=this.id3utf8ArrayToStr(e.data.subarray(t)))&&void 0!==i?i:"";return t+=i.length+1,{key:"TXXX",description:i,data:null!==(t=this.id3utf8ArrayToStr(e.data.subarray(t)))&&void 0!==t?t:""}}}decodeWxxxFrame(e){if(!(z(e.size)&&e.size<2)&&3===e.data[0]){var t=1,i=null!==(i=this.id3utf8ArrayToStr(e.data.subarray(t)))&&void 0!==i?i:"";return t+=i.length+1,{key:"WXXX",description:i,data:Y.utf8arrayToStr(e.data.subarray(t))}}}decodeTextFrame(e){if(!(z(e.size)&&e.size<2)&&3===e.data[0]){var t=e.data.subarray(1);return{key:e.type,data:null!==(t=this.id3utf8ArrayToStr(t))&&void 0!==t?t:""}}}decodePrivFrame(e){if(!(z(e.size)&&e.size<2)){var t=null!==(t=this.id3utf8ArrayToStr(e.data))&&void 0!==t?t:"";return{key:"PRIV",info:t,data:e.data.slice(t.length+1)}}}_extractID3Frame(e,t,i,r,n){var a=r+i;let s;return a<=n?s={type:t,data:e.slice(r,a)}:this.logger.error(x,`id3 frame ${t} size ${i} exceeded ${n}`),s}_parseID3Frames(e,t,i){let r,n,a,s;for(;t+8<=i;){if(!this.isID3Frame(e,t))return void this.logger.error(x,`[id3] illegal id3 frame @ offset ${t}. skip this id3 tag`);if(r=D.readUTF(e,t,4),t+=4,""===r)return;if(0===(n=D.readSynchSafeUint32(e.subarray(t,t+4))))return;t+=4,e[t++],e[t++],a=t;var o=this._extractID3Frame(e,r,n,a,i);if(o){const e=this.decodeID3Frame(o);e&&this._frames.push(e)}if("PRIV"===r)if(53===n&&"com.apple.streaming.transportStreamTimestamp"===D.readUTF(e,t,44)){t+=44,t+=4;const i=1&e[t++];this._hasTimeStamp=!0,s=((e[t++]<<23)+(e[t++]<<15)+(e[t++]<<7)+e[t++])/45,i&&(s+=47721858.84),s=Math.round(s),this._timeStamp=s}else 45<=n&&"com.apple.streaming.audioDescription"===D.readUTF(e,t,36)?(t+=37,this._audioType=D.readUTF(e,t,4),t+=4,t+=n-41):t+=n;else t+=n}}id3utf8ArrayToStr(e){let t,i,r="",n=0;const a=e.length;for(;n<a;){const a=e[n++];switch(a>>4){case 0:return r;case 1:case 2:case 3:case 4:case 5:case 6:case 7:r+=String.fromCharCode(a);break;case 12:case 13:t=e[n++],r+=String.fromCharCode((31&a)<<6|63&t);break;case 14:t=e[n++],i=e[n++],r+=String.fromCharCode((15&a)<<12|(63&t)<<6|(63&i)<<0)}}}get hasTimeStamp(){return this._hasTimeStamp}get timeStamp(){return this._timeStamp}get audioType(){return this._audioType}get length(){return this._length}get payload(){return this._payload}get frames(){return this._frames}get minor(){return this._minor}get revision(){return this._revision}}var _=D;const H={name:"AACDemuxer"};class X extends y{constructor(){super(...arguments),this.duration=NaN}resetInitSegment(e,t){this.audioConfig=void 0,this.audioTrack=void 0,this.duration=t}static probe(e,t){let i,r;for(i=new _(e,t).length,r=Math.min(e.length-1,i+100);i<r;i++)if(255===e[i]&&240==(246&e[i+1]))return!0;return!1}append(e,t,i,r,n){var a=new _(e,this.logger),s=a.hasTimeStamp&&z(a.timeStamp)?90*a.timeStamp:9e4*t;let o,l,d,u,c,h,p,m,f,g;for(a.length&&(g=a.payload,a.frames.length&&(f=a.frames),m={id3Samples:[{pts:s,dts:s,data:g,frames:f}],inputTimescale:9e4}),d=a.length,h=e.length;d<h-1&&(255!==e[d]||240!=(246&e[d+1]));d++);if(!this.audioConfig&&(this.audioConfig=S(this.observer,e,d,void 0,this.logger),!this.audioConfig))throw"failed to parse adts config";if(!this.audioTrack){const e={id:258,inputTimescale:9e4,timescale:NaN,duration:this.duration,encrypted:!1,keyTagInfo:n},t={len:0,sequenceNumber:0,esSamples:[]};this.audioTrack={info:e,parsingData:t,type:"audio",config:this.audioConfig}}"zaac"!==a.audioType&&"zach"!==a.audioType&&"zacp"!==a.audioType||(this.audioTrack.info.encrypted=!0),l=0;for(var y=9216e4/this.audioConfig.samplerate;d+5<h&&(u=1&e[d+1]?7:9,o=(3&e[d+3])<<11|e[d+4]<<3|(224&e[d+5])>>>5,o-=u,0<o&&d+u+o<=h);)for(c=s+l*y,p={unit:e.subarray(d+u,d+u+o),pts:c,dts:c,keyTagInfo:n},this.audioTrack.parsingData.esSamples.push(p),this.audioTrack.parsingData.len+=o,d+=o+u,l++;d<h-1;d++){if(_.isHeader(e,d)){const t=new _(e.subarray(d),this.logger);if(0<t.length){d+=t.length;const e=t.hasTimeStamp&&z(t.timeStamp)?90*t.timeStamp:s;null==m||m.id3Samples.push({pts:e,dts:e,data:t.payload,frames:t.frames})}else this.logger.error(H,`[id3] invalid length ${h}`)}if(255===e[d]&&240==(246&e[d+1]))break}this.esRemuxer.remuxEsTracks(this.audioTrack,void 0,m,void 0,t,i,r,n)}}class J{bsReadAndUpdate(e,t,i){e=this.readBits(e,t,i);return this.updateOffset(t,i),null!=e?e:0}bsWriteAndUpdate(e,t,i,r){r=this.writeBits(e,t,i,r);return this.updateOffset(t,i),r}bsSkip(e,t){this.updateOffset(e,t)}readBits(i,r,n){if(i&&r){let t=r.byteOffset;const a=r["usedBits"];if(!(8<=a||32<a+n)){let e;const s=new Uint32Array(1),o=new Uint32Array(1),l=new Uint8Array(1);if(!(8<=a||32<n)){if(a){const r=8-a,s=n<r?r-n:0;o[0]=4278190080>>>32-r,e=(i[t]&o[0])>>>s,t+=1,n-=r}for(;0<n;){l[0]=i[t];const r=Math.min(n,8),a=8-r;o[0]=4278190080>>>24+a<<a,s[0]=(l[0]&o[0])>>a,e=e?e<<r|s[0]:s[0],t+=1,n-=r}return e}}}}writeBits(t,i,r,n){if(t&&i){let e=i.byteOffset;var i=i["usedBits"];if(!(8<=i||32<i+r)){const a=new Uint32Array(1),s=new Uint32Array(1),o=new Uint32Array(1),l=new Uint8Array(1);for(a[0]=n,i&&(s[0]=a[0]<<32-r,o[0]=4278190080,l[0]=(s[0]&o[0])>>>24+i,t[e]&=~(o[0]>>>24+i),t[e]|=l[0],e+=1,r-=8-i);0<r;){s[0]=a[0]<<32-r,o[0]=4278190080,l[0]=(s[0]&o[0])>>>24;const d=r<0?8-r:0;t[e]&=~(o[0]>>>24>>>d<<d),t[e]|=l[0],r-=8,e+=1}return 0}}}updateOffset(e,t){var i,r;!e||!t||32<e.usedBits+t||(i=e.usedBits%8,r=Math.floor((i+t)/8),t=(i+t)%8,e.byteOffset+=r,e.usedBits=t)}}function Z(e,t){return 1536/e.samplerate*t}function ee(e,t,i,r){let n;if(i+8>t.length)return n=new I(!0,"error parsing ac-3, not enough data",G.InsufficientAC3Data),void e.trigger(N.INTERNAL_ERROR,n);if(11!==t[i]||119!==t[i+1])return n=new I(!0,"invalid ac-3 magic",G.InvalidAC3Magic),void e.trigger(N.INTERNAL_ERROR,n);var a=t[i+4]>>6;if(3<=a)return n=new I(!0,`invalid ac-3 samplingRateCode:${a}`,G.InvalidAC3SamplingRateCode),void e.trigger(N.INTERNAL_ERROR,n);var s=63&t[i+4],o=t[i+6]>>5;let l=0;2==o?l+=2:(1&o&&1!=o&&(l+=2),4&o&&(l+=2));var d=(t[i+6]<<8|t[i+7])>>12-l&1,u=[2,1,2,3,3,4,4,5][o]+d,e=t[i+5]>>3,i=7&t[i+5];return{samplerate:ie[a],channelCount:u,segmentCodec:"ac3",codec:"ac-3",extraData:a<<22|e<<17|i<<14|o<<11|d<<10|s>>1<<5}}function te(e,t,i){let r;if(i+8>t.length)return r=new I(!0,"error parsing ac-3, not enough data",G.InsufficientAC3Data),void e.trigger(N.INTERNAL_ERROR,r);if(11!==t[i]||119!==t[i+1])return r=new I(!0,"invalid ac-3 magic",G.InvalidAC3Magic),void e.trigger(N.INTERNAL_ERROR,r);var n=t[i+4]>>6;return 3<=n?(r=new I(!0,`invalid ac-3 samplingRateCode:${n}`,G.InvalidAC3SamplingRateCode),void e.trigger(N.INTERNAL_ERROR,r)):(i=63&t[i+4],2*re[3*i+n])}const ie=[48e3,44100,32e3],re=[64,69,96,64,70,96,80,87,120,80,88,120,96,104,144,96,105,144,112,121,168,112,122,168,128,139,192,128,140,192,160,174,240,160,175,240,192,208,288,192,209,288,224,243,336,224,244,336,256,278,384,256,279,384,320,348,480,320,349,480,384,417,576,384,418,576,448,487,672,448,488,672,512,557,768,512,558,768,640,696,960,640,697,960,768,835,1152,768,836,1152,896,975,1344,896,976,1344,1024,1114,1536,1024,1115,1536,1152,1253,1728,1152,1254,1728,1280,1393,1920,1280,1394,1920];class ne extends y{constructor(){super(...arguments),this.duration=NaN}resetInitSegment(e,t){this.audioConfig=void 0,this.audioTrack=void 0,this.duration=t}static probe(e,t){var i=new _(e,t),t=i.length;return!!(i.hasTimeStamp&&11===e[t]&&119===e[t+1]&&(new J).bsReadAndUpdate(e,{byteOffset:t+5,usedBits:0},5)<16)}append(e,t,i,r,n){var a,s=new _(e,this.logger),o=s.hasTimeStamp&&z(s.timeStamp)?90*s.timeStamp:NaN,l=e.byteLength;let d=0,u=s.length;if(this.audioConfig||(this.audioConfig=ee(this.observer,e,u,this.logger)),!this.audioConfig)throw"failed to parse ac3 config";if(!this.audioTrack){const e={id:258,inputTimescale:9e4,timescale:NaN,duration:this.duration,encrypted:!1,keyTagInfo:n},t={len:0,sequenceNumber:0,esSamples:[]};this.audioTrack={info:e,parsingData:t,type:"audio",config:this.audioConfig}}var c=Z(this.audioConfig,this.audioTrack.info.inputTimescale);for("zac3"===s.audioType&&(this.audioTrack.info.encrypted=!0);u<l;){if(_.isHeader(e,u)&&(u+=new _(e.subarray(u),this.logger).length),11!==e[u]||119!==e[u+1]){const e=new I(!0,"invalid ac-3 magic",G.InvalidAC3Magic);return void this.observer.trigger(N.INTERNAL_ERROR,e)}const t=null!==(a=te(this.observer,e,u))&&void 0!==a?a:NaN,i=o+d*c,r={unit:e.subarray(u,u+t),pts:i,dts:i,keyTagInfo:n};this.audioTrack.parsingData.esSamples.push(r),this.audioTrack.parsingData.len+=t,u+=t,d++}this.esRemuxer.remuxEsTracks(this.audioTrack,void 0,{id3Samples:[{pts:o,dts:o,data:s.payload,frames:s.frames}],inputTimescale:this.audioTrack.info.inputTimescale},void 0,t,i,r,n)}}var ae={getFrameLength:function(t,i,r,n){const a=new J;let s,o=!1,l=0;for(;r<i.length;){if(r+8>i.length)return s=new I(!0,"error parsing ec-3, not enough data",G.InsufficientEC3Data),void t.trigger(N.INTERNAL_ERROR,s);let e=0;if(_.isHeader(i,r)&&(e=new _(i.subarray(r),n).length||0,r+=e),11!==i[r]||119!==i[r+1])return s=new I(!0,"invalid ec-3 magic",G.InvalidEC3Magic),void t.trigger(N.INTERNAL_ERROR,s);var d={byteOffset:r+2,usedBits:0},u=a.bsReadAndUpdate(i,d,2),c=a.bsReadAndUpdate(i,d,3);if(0===u||2===u)if(!0===o){if(0===c)break}else o=!0;else if(1!==u)return s=new I(!0,"reserved stream type",G.ReservedStreamType),void t.trigger(N.INTERNAL_ERROR,s);d=2*(a.bsReadAndUpdate(i,d,11)+1);r+=d,l+=d+(e||0)}return l},getAudioConfig:function(t,i,r,n){const a={frmsiz:0,fscod:0,numblkscod:0,acmod:0,lfeon:0,bsid:0,strmtyp:0,substreamid:0,chanmape:0,chanmap:0,mixdef:0,mixdeflen:0,bsmod:0},s={fscod:0,acmod:0,lfeon:0,bsid:0,bsmod:0,chan_loc:0,data_rate:0,num_ind_sub:0,num_dep_sub:[],complexity_index_type_a:0},o=new J;let l,d=!1,u=0;for(;r<i.length;){if(r+8>i.length)return l=new I(!0,"error parsing ec-3, not enough data",G.InsufficientEC3Data),void t.trigger(N.INTERNAL_ERROR,l);let e=0;if(_.isHeader(i,r)&&(e=new _(i.subarray(r),n).length||0,r+=e),11!==i[r]||119!==i[r+1])return l=new I(!0,"invalid ec-3 magic",G.InvalidEC3Magic),void t.trigger(N.INTERNAL_ERROR,l);const h={byteOffset:r+2,usedBits:0};if(a.strmtyp=o.bsReadAndUpdate(i,h,2),a.substreamid=o.bsReadAndUpdate(i,h,3),0===a.strmtyp||2===a.strmtyp){if(!0===d){if(0===a.substreamid)break}else d=!0;s.num_ind_sub++,s.num_dep_sub.push(0)}else{if(1!==a.strmtyp)return l=new I(!0,"reserved stream type",G.ReservedStreamType),void t.trigger(N.INTERNAL_ERROR,l);s.num_dep_sub[s.num_ind_sub-1]++}if(a.frmsiz=o.bsReadAndUpdate(i,h,11),a.fscod=o.bsReadAndUpdate(i,h,2),3===a.fscod?(o.bsSkip(h,2),a.numblkscod=3):a.numblkscod=o.bsReadAndUpdate(i,h,2),a.acmod=o.bsReadAndUpdate(i,h,3),a.lfeon=o.bsReadAndUpdate(i,h,1),a.bsid=o.bsReadAndUpdate(i,h,5),o.bsSkip(h,5),o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,8),0===a.acmod&&(o.bsSkip(h,5),o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,8)),1===a.strmtyp&&(a.chanmape=o.bsReadAndUpdate(i,h,1),a.chanmape&&(a.chanmap=o.bsReadAndUpdate(i,h,16))),o.bsReadAndUpdate(i,h,1)&&(2<a.acmod&&o.bsSkip(h,2),1&a.acmod&&2<a.acmod&&o.bsSkip(h,6),4&a.acmod&&o.bsSkip(h,6),a.lfeon&&o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,5),0===a.strmtyp)){if(o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,6),0===a.acmod&&o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,6),o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,6),a.mixdef=o.bsReadAndUpdate(i,h,2),1===a.mixdef)o.bsSkip(h,5);else if(2===a.mixdef)o.bsSkip(h,12);else if(3===a.mixdef){a.mixdeflen=o.bsReadAndUpdate(i,h,5),o.bsReadAndUpdate(i,h,1)&&(o.bsSkip(h,5),o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,4),o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,4),o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,4),o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,4),o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,4),o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,4),o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,4),o.bsReadAndUpdate(i,h,1)&&(o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,4),o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,4))),o.bsReadAndUpdate(i,h,1)&&(o.bsSkip(h,5),o.bsReadAndUpdate(i,h,1)&&(o.bsSkip(h,7),o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,8)));const t=a.mixdeflen+2+(h.usedBits?1:0);h.byteOffset+=t}if(a.acmod<2&&(o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,14),0===a.acmod&&o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,14)),o.bsReadAndUpdate(i,h,1))if(0===a.numblkscod)o.bsSkip(h,5);else for(let e=0;e<a.numblkscod;e++)o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,5)}if(a.bsmod=0,o.bsReadAndUpdate(i,h,1)&&(a.bsmod=o.bsReadAndUpdate(i,h,3),o.bsSkip(h,2),2===a.acmod&&o.bsSkip(h,4),6<=a.acmod&&o.bsSkip(h,2),o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,8),0===a.acmod&&o.bsReadAndUpdate(i,h,1)&&o.bsSkip(h,8),a.fscod<3&&o.bsSkip(h,1)),0===a.strmtyp&&3!==a.numblkscod&&o.bsSkip(h,1),2!==a.strmtyp||(3===a.numblkscod?1:o.bsReadAndUpdate(i,h,1))&&o.bsReadAndUpdate(i,h,6),o.bsReadAndUpdate(i,h,1)){const t=o.bsReadAndUpdate(i,h,6);if(0===a.strmtyp&&0===a.substreamid&&1===t){const t=o.bsReadAndUpdate(i,h,7),r=o.bsReadAndUpdate(i,h,1),n=o.bsReadAndUpdate(i,h,8);0===t&&1===r&&1<=n&&n<=16&&(s.complexity_index_type_a=n)}}if(a.chanmape)s.chan_loc|=a.chanmap;else{const t=[40960,16384,40960,57344,41472,57856,47104,63488];s.chan_loc|=t[a.acmod]}0===a.strmtyp&&(s.fscod=a.fscod,s.bsid=a.bsid,s.bsmod=a.bsmod,s.acmod=a.acmod,s.lfeon=a.lfeon),s.chan_loc|=a.lfeon?1:0;const p=2*(a.frmsiz+1);r+=p,u+=p+(e||0)}let c=0;for(let e=0;e<16;e++)s.chan_loc&1<<e&&c++;s.lfeon&&c++;let h=10+3*s.num_ind_sub;const p=[48e3,44100,32e3][s.fscod];s.data_rate=p/1536*u*8,h=10+3*s.num_ind_sub;for(let e=0;e<s.num_ind_sub;e++)0<s.num_dep_sub[e]&&h++;0<s.complexity_index_type_a&&(h+=2);var m=new Uint8Array(h),f={byteOffset:0,usedBits:0};o.bsWriteAndUpdate(m,f,32,h),o.bsWriteAndUpdate(m,f,32,1684366131),o.bsWriteAndUpdate(m,f,13,s.data_rate),o.bsWriteAndUpdate(m,f,3,s.num_ind_sub);for(let e=0;e<s.num_ind_sub;e++)o.bsWriteAndUpdate(m,f,2,s.fscod),o.bsWriteAndUpdate(m,f,5,s.bsid),o.bsWriteAndUpdate(m,f,1,0),o.bsWriteAndUpdate(m,f,1,0===e?0:1),o.bsWriteAndUpdate(m,f,3,s.bsmod),o.bsWriteAndUpdate(m,f,3,s.acmod),o.bsWriteAndUpdate(m,f,1,s.lfeon),o.bsWriteAndUpdate(m,f,3,0),o.bsWriteAndUpdate(m,f,4,s.num_dep_sub[e]),0<s.num_dep_sub[e]?o.bsWriteAndUpdate(m,f,9,s.chan_loc):o.bsWriteAndUpdate(m,f,1,0);return 0<s.complexity_index_type_a&&(o.bsWriteAndUpdate(m,f,7,0),o.bsWriteAndUpdate(m,f,1,1),o.bsWriteAndUpdate(m,f,8,s.complexity_index_type_a)),{samplerate:p,channelCount:c,segmentCodec:"ec3",codec:"ec-3",extraDataBytes:m}}};class se extends y{constructor(){super(...arguments),this.duration=NaN}resetInitSegment(e,t){this.audioConfig=void 0,this.audioTrack=void 0,this.duration=t}static probe(e,t){var i=new _(e,t),t=i.length;return!(!i.hasTimeStamp||11!==e[t]||119!==e[t+1]||16!==(new J).bsReadAndUpdate(e,{byteOffset:t+5,usedBits:0},5))}append(e,t,i,r,n){var a,s=new _(e,this.logger),o=s.hasTimeStamp&&z(s.timeStamp)?90*s.timeStamp:NaN,l=e.length;let d=0,u=s.length;if(this.audioConfig||(this.audioConfig=ae.getAudioConfig(this.observer,e,u,this.logger)),!this.audioConfig)throw"failed to parse ec-3 config";if(!this.audioTrack){const e={id:258,inputTimescale:9e4,timescale:NaN,duration:this.duration,encrypted:!1,keyTagInfo:n},t={len:0,sequenceNumber:0,esSamples:[]};this.audioTrack={info:e,parsingData:t,type:"audio",config:this.audioConfig}}var c=Z(this.audioConfig,this.audioTrack.info.inputTimescale);for("zec3"===s.audioType&&(this.audioTrack.info.encrypted=!0);u<l;){const t=null!==(a=ae.getFrameLength(this.observer,e,u,this.logger))&&void 0!==a?a:NaN,i=o+d*c,r={unit:e.subarray(u,u+t),pts:i,dts:i,keyTagInfo:n};this.audioTrack.parsingData.esSamples.push(r),this.audioTrack.parsingData.len+=t,u+=t,d++}this.esRemuxer.remuxEsTracks(this.audioTrack,void 0,{id3Samples:[{pts:o,dts:o,data:s.payload,frames:s.frames}],inputTimescale:this.audioTrack.info.inputTimescale},void 0,t,i,r,n)}}const oe={BitratesMap:[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],SamplingRateMap:[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],SamplesCoefficients:[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],BytesInSlot:[0,1,1,4],onFrame:function(e,t,i,r,n,a,s){r=s+a*(10368e4/r);e.esSamples.push({unit:t,pts:r,dts:r}),e.len+=t.length},onNoise:function(e,t){},parseFrames:function(e,t,i,r,n,a,s){if(r<i+2)return-1;if(255===t[i]||224==(224&t[i+1])){if(r<i+24)return-1;const s=t[i+1]>>3&3,c=t[i+1]>>1&3,h=t[i+2]>>4&15,p=t[i+2]>>2&3,m=!!(2&t[i+2]);if(1!=s&&0!=h&&15!=h&&3!=p){var o=1e3*[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160][14*(3==s?3-c:3==c?3:4)+h-1],l=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3][3*(3==s?0:2==s?1:2)+p],d=m?1:0,u=t[i+3]>>6==3?1:2,d=3==c?(3==s?12:6)*o/l+d<<2:(3==s?144:72)*o/l+d|0;return r<i+d?-1:(oe.onFrame(e,t.subarray(i,i+d),o,l,u,n,a),d)}}let c=i+2;for(;c<r;){if(255===t[c-1]&&224==(224&t[c]))return oe.onNoise(t.subarray(i,c-1),s),c-i-1;c++}return-1},parse:function(e,t,i,r,n){var a=t.length;let s,o=0;for(;i<a&&0<(s=oe.parseFrames(e,t,i,a,o++,r,n));)i+=s},getAudioConfig:function(e,t){var i=e[t+1]>>3&3,r=e[t+1]>>1&3,n=e[t+2]>>4&15,a=e[t+2]>>2&3,s=e[t+2]>>1&1;if(1!=i&&0!=n&&15!=n&&3!=a){var o=3==i?3-r:3==r?3:4,o=1e3*oe.BitratesMap[14*o+n-1],n=3==i?0:2==i?1:2,a=oe.SamplingRateMap[3*n+a],t=e[t+3]>>6==3?1:2,i=oe.SamplesCoefficients[i][r],r=oe.BytesInSlot[r];return{segmentCodec:"mp3",codec:"mp3",samplerate:a,channelCount:t,frameLength:parseInt(i*o/a+s,10)*r}}},isHeaderPattern:function(e,t){return 255===e[t]&&224==(224&e[t+1])&&0!=(6&e[t+1])},probe:function(t,i){if(i+1<t.length&&oe.isHeaderPattern(t,i)){var r=4,n=oe.getAudioConfig(t,i);let e=r;n&&n.frameLength&&(e=n.frameLength);i=i+e;if(i===t.length||i+1<t.length&&oe.isHeaderPattern(t,i))return!0}return!1}};var le=oe;class de extends y{constructor(){super(...arguments),this.duration=NaN}resetInitSegment(e,t){this.audioConfig=void 0,this.audioTrack=void 0,this.duration=t}static probe(e,t){t=new _(e,t);let i,r;if(t.hasTimeStamp)for(i=t.length,r=Math.min(e.length-1,i+100);i<r;i++)if(le.probe(e,i))return!0;return!1}append(e,t,i,r,n){var a=new _(e,this.logger),s=a.hasTimeStamp&&z(a.timeStamp)?90*a.timeStamp:NaN;if(this.audioConfig||(this.audioConfig=le.getAudioConfig(e,a.length)),!this.audioConfig)throw"unable to parse mp3 header";if(!this.audioTrack){const e={id:258,inputTimescale:9e4,timescale:NaN,duration:this.duration,encrypted:!1,keyTagInfo:n},t={len:0,sequenceNumber:0,esSamples:[]};this.audioTrack={info:e,parsingData:t,type:"audio",config:this.audioConfig}}le.parse(this.audioTrack.parsingData,e,a.length,s,this.logger),this.esRemuxer.remuxEsTracks(this.audioTrack,void 0,{id3Samples:[{pts:s,dts:s,data:a.payload,frames:a.frames}],inputTimescale:9e4},void 0,t,i,r)}}function ue(e,t){if("mp4a.40.2"===e){if(1===t)return new Uint8Array([0,200,0,128,35,128]);if(2===t)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(3===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(4===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(5===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(6===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224])}else{if(1===t)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(2===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(3===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}return null}const ce=Math.pow(2,32)-1;class he{static init(){let e;for(e in he.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],free:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],dac3:[],"ac-3":[],dec3:[],"ec-3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[],uuid:[],encv:[],enca:[],frma:[],schm:[],schi:[],senc:[],saio:[],saiz:[],sinf:[],tenc:[],sbgp:[],seig:[],sgpd:[],pssh:[]},he.types)he.types.hasOwnProperty(e)&&(he.types[e]=[e.charCodeAt(0),e.charCodeAt(1),e.charCodeAt(2),e.charCodeAt(3)]);var t=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),i=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);he.HDLR_TYPES={video:t,audio:i};var r=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),n=new Uint8Array([0,0,0,0,0,0,0,0]);he.STTS=he.STSC=he.STCO=n,he.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),he.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),he.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),he.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);t=new Uint8Array([105,115,111,109]),i=new Uint8Array([97,118,99,49]),n=new Uint8Array([0,0,0,1]);he.FTYP=he.box(he.types.ftyp,t,n,t,i),he.DINF=he.box(he.types.dinf,he.box(he.types.dref,r))}static set16(e,t,i){return t[i]=e>>8&255,t[i+1]=255&e,i+2}static set32(e,t,i){return t[i]=e>>24&255,t[i+1]=e>>16&255,t[i+2]=e>>8&255,t[i+3]=255&e,i+4}static box(e){var t=Array.prototype.slice.call(arguments,1);let i=8,r=t.length;for(var n=r;r--;)i+=t[r].byteLength;const a=new Uint8Array(i);for(a[0]=i>>24&255,a[1]=i>>16&255,a[2]=i>>8&255,a[3]=255&i,a.set(e,4),r=0,i=8;r<n;r++)a.set(t[r],i),i+=t[r].byteLength;return a}static hdlr(e){return he.box(he.types.hdlr,he.HDLR_TYPES[e])}static mdat(e){return he.box(he.types.mdat,e)}static mdhd(e,t){t*=e;var i=Math.floor(t/(ce+1)),t=Math.floor(t%(ce+1));return he.box(he.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,255&e,i>>24,i>>16&255,i>>8&255,255&i,t>>24,t>>16&255,t>>8&255,255&t,85,196,0,0]))}static mdia(e){var t=he.mdhd(e.info.timescale,e.info.duration),i=he.hdlr(e.type),e=he.minf(e);return he.box(he.types.mdia,t,i,e)}static mfhd(e){return he.box(he.types.mfhd,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,255&e]))}static minf(e){return"audio"===e.type?he.box(he.types.minf,he.box(he.types.smhd,he.SMHD),he.DINF,he.stbl(e)):he.box(he.types.minf,he.box(he.types.vmhd,he.VMHD),he.DINF,he.stbl(e))}static moof(e,t,i=null){he.types||he.init();i=he.traf(t,e,i);return he.box(he.types.moof,he.mfhd(t.sequenceNumber),i)}static moov(e){let t=e.length;const i=[];for(;t--;)i[t]=he.trak(e[t]);return he.box.apply(null,[he.types.moov,he.mvhd(e[0].info.timescale,e[0].info.duration)].concat(i).concat(he.mvex(e)))}static mvex(e){let t=e.length;const i=[];for(;t--;)i[t]=he.trex(e[t]);return he.box(he.types.mvex,...i)}static mvhd(e,t){t*=e;var i=Math.floor(t/(ce+1)),t=Math.floor(t%(ce+1)),t=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,255&e,i>>24,i>>16&255,i>>8&255,255&i,t>>24,t>>16&255,t>>8&255,255&t,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return he.box(he.types.mvhd,t)}static sdtp(e){const t=e.samples||[],i=new Uint8Array(4+t.length);let r,n;for(n=0;n<t.length;n++)r=t[n].flags,i[n+4]=r.dependsOn<<4|r.isDependedOn<<2|r.hasRedundancy;return he.box(he.types.sdtp,i)}static stbl(e){var t=he.stsd(e),i=he.box(he.types.stts,he.STTS),r=he.box(he.types.stsc,he.STSC),n=he.box(he.types.stsz,he.STSZ),e=he.box(he.types.stco,he.STCO);return he.box(he.types.stbl,t,i,r,n,e)}static avc1(e){let t,i,r,n=[],a=[];var s=e.info.encrypted?he.types.encv:he.types.avc1;for(t=0;t<e.config.sps.length;t++)i=e.config.sps[t],r=i.byteLength,n.push(r>>>8&255),n.push(255&r),n=n.concat(Array.prototype.slice.call(i));for(t=0;t<e.config.pps.length;t++)i=e.config.pps[t],r=i.byteLength,a.push(r>>>8&255),a.push(255&r),a=a.concat(Array.prototype.slice.call(i));var o=he.box(he.types.avcC,new Uint8Array([1,n[3],n[4],n[5],255,224|e.config.sps.length].concat(n).concat([e.config.pps.length]).concat(a))),l=e.config.width,d=e.config.height,u=e.config.pixelRatio[0],c=e.config.pixelRatio[1],h=e.info.encrypted&&e.info.keyTagInfo?he.sinf(e.info.keyTagInfo,e.type,he.types.avc1):new Uint8Array;return he.box(s,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,l>>8&255,255&l,d>>8&255,255&d,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),o,h,he.box(he.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),he.box(he.types.pasp,new Uint8Array([u>>24,u>>16&255,u>>8&255,255&u,c>>24,c>>16&255,c>>8&255,255&c])))}static esds(e){var t=e.esdsConfig.length;return new Uint8Array([0,0,0,0,3,23+t,0,1,0,4,15+t,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([t]).concat(e.esdsConfig).concat([6,1,2]))}static audioStsd(e){var t=e.samplerate;return new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,e.channelCount,0,16,0,0,0,0,t>>8&255,255&t,0,0])}static dac3(e){e=e.extraData;return new Uint8Array([e>>16&255,e>>8&255,255&e])}static dec3(e){return e.extraDataBytes}static mp4a(e,t){let i=he.types.mp4a,r=null;r=e.encrypted&&e.keyTagInfo?(i=he.types.enca,he.sinf(e.keyTagInfo,"audio",he.types.mp4a)):new Uint8Array;e=he.audioStsd(t),t=he.box(he.types.esds,he.esds(t));return he.box(i,e,t,r)}static mp3(e){return he.box(he.types[".mp3"],he.audioStsd(e))}static ac3(e,t){let i=he.types["ac-3"],r=null;return r=e.encrypted&&e.keyTagInfo?(i=he.types.enca,he.sinf(e.keyTagInfo,"audio",he.types["ac-3"])):new Uint8Array,he.box(i,he.audioStsd(t),he.box(he.types.dac3,he.dac3(t)),r)}static ec3(e,t){let i=he.types["ec-3"],r=null;return r=e.encrypted&&e.keyTagInfo?(i=he.types.enca,he.sinf(e.keyTagInfo,"audio",he.types["ec-3"])):new Uint8Array,he.box(i,he.audioStsd(t),he.box(he.types.dec3,he.dec3(t)),r)}static stsd(e){if("audio"!==e.type)return he.box(he.types.stsd,he.STSD,he.avc1(e));if("mp3"===e.config.segmentCodec&&"mp3"===e.config.codec)return he.box(he.types.stsd,he.STSD,he.mp3(e.config));if("ac3"===e.config.segmentCodec)return he.box(he.types.stsd,he.STSD,he.ac3(e.info,e.config));if("ec3"===e.config.segmentCodec)return he.box(he.types.stsd,he.STSD,he.ec3(e.info,e.config));if("aac"===e.config.segmentCodec)return he.box(he.types.stsd,he.STSD,he.mp4a(e.info,e.config));throw`unknown segmentCodec ${e.config.segmentCodec}`}static tkhd(e){var t=e.info.id,i=e.info.duration*e.info.timescale,r=Math.floor(i/(ce+1)),i=Math.floor(i%(ce+1));let n=0,a=0;return"video"===e.type&&(n=e.config.width,a=e.config.height),he.box(he.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,255&t,0,0,0,0,r>>24,r>>16&255,r>>8&255,255&r,i>>24,i>>16&255,i>>8&255,255&i,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,n>>8&255,255&n,0,0,a>>8&255,255&a,0,0]))}static traf(e,t,i=0){var r=he.senc(e),n=he.sdtp(e),a=r.boxData,s=a.length?he.saio(76):new Uint8Array,o=a.length?he.saiz(r.defaultSampleInfoSize,r.sampleInfoSizes):new Uint8Array,l=he.sbgp(e),d=he.sgpd(e),u=e.id,r=Math.floor(t/(ce+1)),t=Math.floor(t%(ce+1));return he.box(he.types.traf,he.box(he.types.tfhd,new Uint8Array([0,2,0,0,u>>24,u>>16&255,u>>8&255,255&u])),he.box(he.types.tfdt,new Uint8Array([1,0,0,0,r>>24,r>>16&255,r>>8&255,255&r,t>>24,t>>16&255,t>>8&255,255&t])),a,s,o,l,d,he.trun(e,n.length+a.length+l.length+d.length+s.length+o.length+16+20+8+16+8+8),n)}static trak(e){if("trakData"in e)return e.trakData;e.info.duration=e.info.duration||4294967295;var t=he.types.trak,i=he.tkhd(e),e=he.mdia(e);return he.box(t,i,e)}static trex(e){e=e.info.id;return he.box(he.types.trex,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,255&e,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}static trun(e,t){const i=e.samples||[],r=i.length,n=12+16*r,a=new Uint8Array(n);let s,o,l,d,u,c;for(t+=8+n,a.set([1,0,15,1,r>>>24&255,r>>>16&255,r>>>8&255,255&r,t>>>24&255,t>>>16&255,t>>>8&255,255&t],0),s=0;s<r;s++)l=(o=i[s]).duration,d=o.size,u=o.flags,c=o.cts,a.set([l>>>24&255,l>>>16&255,l>>>8&255,255&l,d>>>24&255,d>>>16&255,d>>>8&255,255&d,u.isLeading<<2|u.dependsOn,u.isDependedOn<<6|u.hasRedundancy<<4|u.paddingValue<<1|u.isNonSync,61440&u.degradPrio,15&u.degradPrio,c>>>24&255,c>>>16&255,c>>>8&255,255&c],12+16*s);return he.box(he.types.trun,a)}static initSegment(e){he.types||he.init();const t=he.moov(e),i=new Uint8Array(he.FTYP.byteLength+t.byteLength);return i.set(he.FTYP),i.set(t,he.FTYP.byteLength),i}static saio(e){e=e+4+4;return he.box(he.types.saio,new Uint8Array([0,0,0,0,0,0,0,1,e>>24&255,e>>16&255,e>>8&255,255&e]))}static saiz(e,t){z(e)||(e=0);var i=t.length,t=0===e?new Uint8Array(t):new Uint8Array;return he.box(he.types.saiz,new Uint8Array([0,0,0,0,e,i>>24&255,i>>16&255,i>>8&255,255&i]),t)}static senc(e){const t=e.samples||[],i=t.length;let r=0,n=NaN,a=!0;const s=[];if(!e.encrypted||i<=0)return{boxData:new Uint8Array,sampleInfoSizes:s,defaultSampleInfoSize:0};e=e.defaultPerSampleIVSize||0;for(const d of t)d.subsamples&&(r+=d.subsamples.length);if(r<=0)return{boxData:new Uint8Array,sampleInfoSizes:s,defaultSampleInfoSize:0};const o=new Uint8Array(2*i+i*e+6*r+4);let l=this.set32(i,o,0);for(const d of t){const t=d.subsamples||[];let e=2;d.iv&&(o.set(d.iv,l),l+=d.iv.byteLength,e+=d.iv.byteLength),l=this.set16(t.length,o,l);for(const d of t)l=this.set16(d[0],o,l),l=this.set32(d[1],o,l),e+=6;s.push(e),z(n)||(n=e),a=a&&n===e,n=e}return{boxData:he.box(he.types.senc,new Uint8Array([0,0,0,2]),o),defaultSampleInfoSize:a?n:0,sampleInfoSizes:s}}static sinf(e,t,i){return he.box(he.types.sinf,he.frma(i),he.schm(),he.schi(e,t))}static frma(e){return he.box(he.types.frma,new Uint8Array(e))}static schm(){return he.box(he.types.schm,new Uint8Array([0,0,0,0,99,98,99,115,0,1,0,0]))}static schi(e,t){return he.box(he.types.schi,he.tenc(e,t))}static tenc(e,t){let i=0;"video"===t&&(i=25);const r=new Uint8Array(17);if(r[0]=16,e.iv&&16===e.iv.byteLength&&r.set(e.iv,1),!e.keyId)throw"tenc: no key id found in decryptdata";return he.box(he.types.tenc,new Uint8Array([1,0,0,0,0,i,1,0]),e.keyId,r)}static sbgp(e){if(!e.encrypted||0===e.samples.length||!e.samples[0].keyTagInfo)return new Uint8Array;e=e.samples.length;return he.box(he.types.sbgp,new Uint8Array([0,0,0,0]),new Uint8Array(he.types.seig),new Uint8Array([0,0,0,1,e>>24&255,e>>16&255,e>>8&255,255&e,0,1,0,1]))}static sgpd(e){if(!e.encrypted||0===e.samples.length||!e.samples[0].keyTagInfo)return new Uint8Array;var t=e.samples[0].keyTagInfo;let i=0;"video"===e.type&&(i=25);const r=new Uint8Array(17);if(r[0]=16,t.iv&&r.set(t.iv,1),!t.keyId)throw"sgpd: no keyid in decryptdata";return he.box(he.types.sgpd,new Uint8Array([1,0,0,0]),new Uint8Array(he.types.seig),new Uint8Array([0,0,0,37,0,0,0,1]),new Uint8Array([0,i,1,0]),t.keyId,r)}static pssh(e,t,i){if(he.types||he.init(),!e)throw new TypeError("Bad system id");if(16!==e.byteLength)throw new RangeError("Invalid system id");let r,n,a;if(t){r=1,n=new Uint8Array(16*t.length);for(let e=0;e<t.length;e++){const i=t[e];if(16!==i.byteLength)throw new RangeError("Invalid key");n.set(i,16*e)}}else r=0,n=new Uint8Array;0<r?(a=new Uint8Array(4),t&&0<t.length&&new DataView(a.buffer).setUint32(0,t.length,!1)):a=new Uint8Array;var s=new Uint8Array(4);return i&&0<i.byteLength&&new DataView(s.buffer).setUint32(0,i.byteLength,!1),he.box(he.types.pssh,new Uint8Array([r,0,0,0]),e,a,n,s,i||new Uint8Array)}}var pe,me,fe,ge=he;(Ci=pe=pe||{})[Ci.SDR=0]="SDR",Ci[Ci.HDR=1]="HDR",Ci[Ci.HDR10=2]="HDR10",Ci[Ci.DolbyVision=3]="DolbyVision",Ci[Ci.HLG=4]="HLG",(Pi=me=me||{})[Pi.H264=16]="H264",Pi[Pi.HEVC=64]="HEVC",Pi[Pi.VP09=65]="VP09";const ye=new Set(["ac-3","mp4a.a5","mp4a.A5"]),ve=new Set(["ec-3","mp4a.a6","mp4a.A6"]);(Rn=fe=fe||{})[Rn.Family=1]="Family",Rn[Rn.Profile=2]="Profile",Rn[Rn.Compatibility=3]="Compatibility",Rn[Rn.Tier=4]="Tier",Rn[Rn.Level=5]="Level";const Se=/^([^.]+)\.([^.]+)(?:\.([^.])\.([a-zA-Z])([^.]+))?/i,Ie=/^mp4a\.40\.(.*)/,be=/^avc[13]\./,Te=/^h(ev|vc)1\./,Ee=/^dv(h1|he|a1|av)\./,Ae=/^vp09\./,Oe=/^av01\./,we={aac:1024,mp3:1024,ac3:1536,ec3:1536},Re={isAC3:e=>ye.has(e),isEC3:e=>ve.has(e),isDolbyAtmos:(e,t)=>Re.isEC3(e)&&Re.isJOCChannels(t),isJOCChannels(e){const t=e.split("/");return 1<t.length&&void 0!==t[1].split(",").find(e=>"JOC"===e)},isAAC(e){return Boolean(e&&("aac"===e||null!==(e=e.match(Ie))&&"34"!==e[1]))},isMP3(e){return Boolean(e&&("mp3"===e||null!==(e=e.match(Ie))&&"34"===e[1]))},isAVC:e=>be.test(e),isXHEAAC:function(e){return"mp4a.40.42"===e},isALAC:function(e){return"alac"===e},isFLAC:function(e){return"fLaC"===e},isHEVC:e=>Te.test(e),isDolby:e=>Ee.test(e),isVP09:e=>Ae.test(e),isAV1:e=>Oe.test(e),isCompatibleCodecString(e,t){const i=e.split(","),r=t.split(","),n=i.filter(e=>Re.isVideoCodec(e)),a=r.filter(e=>Re.isVideoCodec(e)),s=i.filter(e=>Re.isAudioCodec(e)),o=r.filter(e=>Re.isAudioCodec(e)),l=0===n.length&&0===a.length||n.length===a.length&&Re.isCompatibleVideoCodec(n[0],a[0]),d=0===s.length&&0===o.length||s.length===o.length&&Re.isCompatibleAudioCodec(s[0],o[0]);return l&&d},isVideoCodec:e=>Re.isAVC(e)||Re.isDolby(e)||Re.isHEVC(e)||Re.isVP09(e)||Re.isAV1(e),isAudioCodec:e=>Re.isAC3(e)||Re.isEC3(e)||Re.isAAC(e)||Re.isMP3(e),isCompatibleVideoCodec:(e,t)=>Boolean(e&&t&&(e===t||Re.isDolby(e)&&Re.isDolby(t)||Re.isHEVC(e)&&Re.isHEVC(t)||Re.isAVC(e)&&Re.isAVC(t)||Re.isVP09(e)&&Re.isVP09(t)||Re.isAV1(e)&&Re.isAV1(t))),isCompatibleAudioCodec:(e,t)=>Boolean(e&&t&&(e===t||Re.isAAC(e)&&Re.isAAC(t)||Re.isAC3(e)&&Re.isAC3(t)||Re.isEC3(e)&&Re.isEC3(t)||Re.isMP3(e)&&Re.isMP3(t))),getStickyAtmosStatus:(e,t,i)=>e&&t&&i&&Re.isEC3(t)?Re.isJOCChannels(i):null,getSegmentCodec(e){let t;if(Re.isAAC(e))t="aac";else if(Re.isAC3(e))t="ac3";else if(Re.isEC3(e))t="ec3";else{if("mp3"!==e)throw new Error(`invalid audio config, codec ${e}`);t="mp3"}return t},getChannelCount(e){if(!e)return 0;e=parseInt(e);return z(e)?e:0},avc1toavcoti(e){var t;const i=e.split(".");let r;return 2<i.length?(r=i.shift()+".",r+=parseInt(null!==(t=i.shift())&&void 0!==t?t:"").toString(16),r+=("000"+parseInt(null!==(t=i.shift())&&void 0!==t?t:"").toString(16)).substr(-4)):r=e,r},getDynamicRangeType(e,t){let i=pe.SDR;return t&&("PQ"===e&&Re.isDolby(t)?i=pe.DolbyVision:"PQ"===e&&(Re.isHEVC(t)||Re.isVP09(t)||Re.isAV1(t))?i=pe.HDR10:"HLG"===e&&(-1!==t.indexOf("hvc1")||Re.isVP09(t)||Re.isAV1(t))&&(i=pe.HLG)),i},getCompressionType(e){let t=me.H264;return Re.isHEVC(e)||Re.isDolby(e)?t=me.HEVC:(Re.isVP09(e)||Re.isAV1(e))&&(t=me.VP09),t},isHigherCodecByFamily(e,t){if(!e)return!0;var i=Se.exec(e),r=Se.exec(t);if(!i||!r)return!1;const n=i[fe.Family],a=r[fe.Family];if(n!==a)throw new Error(`mismatch in codec family current/new: ${n}/${a}`);switch(n){case"avc1":case"avc3":return r[fe.Profile]>i[fe.Profile];case"vp09":case"av01":return e<t;case"hvc1":case"hev1":const n="H"===i[fe.Tier]?1:0,a="H"===r[fe.Tier]?1:0;return r[fe.Profile]>i[fe.Profile]||r[fe.Compatibility]>i[fe.Compatibility]||a>n||r[fe.Level]>i[fe.Level];case"dvh1":return r[fe.Profile]>i[fe.Profile]||r[fe.Compatibility]>i[fe.Compatibility];default:return!0}}};class Ce{static getTrack(e,t,i,r,n){let a;switch(Re.getSegmentCodec(i)){case"aac":var s=S(e,1===r?new Uint8Array([255,241,92,64,1,127,252]):new Uint8Array([255,241,92,128,1,191,252]),0,i);s&&(a={type:"audio",info:{id:t,timescale:s.samplerate,duration:0,encrypted:!1,keyTagInfo:void 0},config:s});break;case"ac3":case"ec3":{const i=ee(e,new Uint8Array([11,119,69,17,128,64,47,132]),0);i&&(a={type:"audio",info:{id:t,timescale:i.samplerate,duration:0,encrypted:!1,keyTagInfo:void 0},config:i})}}return a}static getSample(e,t){let i;switch(e){case"mp4a.40.2":case"mp4a.40.5":i=1===t?new Uint8Array([0,208,0,7]):new Uint8Array([33,0,3,64,104,28]);break;case"ac-3":case"ec-3":i=new Uint8Array([11,119,69,17,128,64,47,132,41,3,253,214,124,253,243,215,233,95,185,123,78,20,40,106,97,190,74,253,43,218,208,140,191,176,144,120,214,181,44,124,129,251,91,109,187,109,198,225,43,172,116,140,176,123,38,144,211,247,225,64,29,53,175,96,16,57,121,87,78,203,81,37,7,72,228,132,37,169,38,231,97,229,247,194,208,8,12,83,74,139,137,17,22,26,221,203,107,113,94,93,75,33,208,247,146,105,39,143,6,36,1,227,108,70,11,180,152,218,182,218,209,59,85,104,201,70,37,82,219,68,55,225,144,99,149,0,119,26,14,69,164,241,204,222,81,177,142,80,20,100,97,143,101,221,140,113,31,208,124,25,64,29,49,77,140,30,155,74,214,204,138,229,109,172,95,130,70,230,134,88,59,179,212,155,232,0,0,0,0,0,173,234])}return i}static getSegment(e,i,r,n){if(e){var a=e.info["timescale"],s=e.config["segmentCodec"],o=Ce.getSample(e.config.codec,e.config.channelCount);if(o){const l=[],d={id:e.info.id,sequenceNumber:i,type:"audio",encrypted:!1,samples:l,defaultPerSampleIVSize:0},u=we[s],c=Math.ceil(n*a/u),h={baseTime:Math.round(c*u+r),timescale:a};let t=0;const p=c*o.byteLength+8,m=new Uint8Array(p);m[0]=p>>24&255,m[1]=p>>16&255,m[2]=p>>8&255,m[3]=255&p,ge.types||ge.init(),m.set(ge.types.mdat,4),t+=8;for(let e=0;e<c;e++)l.push({duration:u,size:o.byteLength,cts:0,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:1,isNonSync:0,paddingValue:0}}),m.set(o,t),t+=o.byteLength;const f=ge.moof(r,d),g=new Uint8Array(f.byteLength+m.byteLength);return g.set(f),g.set(m,f.byteLength),{silentFragData:g,endTs:h}}}}}let ke=null;class Me extends O{constructor(e,t,i,r,n){super(e,t,n),this.typeSupported=i,this._initPTS=NaN,this._initDTS=NaN,this.nextAudioTimeOffset=null,this.nextAvcTimeOffset=null,this.videoSampleDuration=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.logger=n.child({name:"EsRemuxer"});const a=navigator.userAgent||"";if(null===ke){const e=a.match(/Chrome\/(\d+)/i);ke=e?parseInt(e[1]):0}}resetTimeStamp(e){this._initPTS=this._initDTS=e,this.nextAudioTimeOffset=this.nextAvcTimeOffset=null}resetInitSegment(){this.currentInitTrack=void 0,this._silentAudioTrack=void 0}remuxEsTracks(r,n,a,s,o,l,d,u,c,h){l||(this.isVideoContiguous=this.isAudioContiguous=!1);var p=this.isVideoContiguous,m=this.isAudioContiguous,f=r&&0<r.parsingData.esSamples.length,g=n&&0<n.parsingData.esSamples.length;let y;l=void 0===c?o:c;let v=l,S=l;if(!this.currentInitTrack){if(r&&r.config.codec&&(this._audioTrackInfo={id:r.info.id,codec:r.config.codec,channelCount:r.config.channelCount}),n&&h&&this._audioTrackInfo){const r=Ce.getTrack(this.observer,this._audioTrackInfo.id,this._audioTrackInfo.codec,this._audioTrackInfo.channelCount,this.logger);if(r){this._silentAudioTrack=Object.assign(Object.assign({},r),{info:Object.assign(Object.assign({},r.info),{inputTimescale:9e4}),parsingData:{len:0,sequenceNumber:0,esSamples:[]}});const a=this._initPTS+Math.round(l*this._silentAudioTrack.info.timescale);y=Ce.getSegment(this._silentAudioTrack,n.parsingData.sequenceNumber,a,h),n.parsingData.sequenceNumber++}}else this._silentAudioTrack=void 0;this.updateInitPTSDTS(n,r,o),this.generateIS(this._silentAudioTrack||r,n)}if(this.currentInitTrack){let t,e,i=null;if(f&&g&&void 0===c){const a=Le(n.parsingData.esSamples),I=(Pe(r.parsingData.esSamples[0].pts,a)-a)/n.info.inputTimescale;v+=Math.max(0,I),S+=Math.max(0,-I)}if(n&&h&&this._silentAudioTrack&&!y){const r=this._initPTS+Math.round((l+this.audioPrimingDelay)*this._silentAudioTrack.info.timescale);y=Ce.getSegment(this._silentAudioTrack,n.parsingData.sequenceNumber,r,h)}if(f){if(z(r.info.timescale)||(this.updateInitPTSDTS(n,r,o),this.generateIS(r,n)),i=this.remuxAudio(r,v,m,d,g?S:void 0,u),g){let e;i&&(e=E(i.endPTS)-E(i.startPTS)),z(n.info.timescale)||(this.updateInitPTSDTS(n,r,o),this.generateIS(r,n)),t=this.remuxVideo(n,S,p,e,h)}}else g&&(t=this.remuxVideo(n,S,p,void 0,h)),t&&r&&r.config.codec&&(i=this.remuxEmptyAudio(r,v,m,d,g?S:void 0,t,u));if(y&&t)e={data1:t.data1,data2:y.silentFragData,startDTS:t.startDTS,startPTS:t.startPTS,endDTS:A(t.endDTS,y.endTs),endPTS:A(t.endPTS,y.endTs),type:"audiovideo",track:this.currentInitTrack};else if(t&&i)e={data1:t.data1,data2:i.data1,startDTS:(g=t.startDTS,u=i.startDTS,E(g)<E(u)?g:u),startPTS:t.startPTS,endDTS:t.endDTS,endPTS:t.endPTS,type:"audiovideo",track:this.currentInitTrack,dropped:t.dropped,framesWithoutIDR:t.framesWithoutIDR,firstKeyframePts:t.firstKeyframePts};else if(t)e={data1:t.data1,startDTS:t.startDTS,startPTS:t.startPTS,endDTS:t.endDTS,endPTS:t.endPTS,type:"video",track:this.currentInitTrack,dropped:t.dropped,framesWithoutIDR:t.framesWithoutIDR,firstKeyframePts:t.firstKeyframePts};else if(i)e={data1:i.data1,startDTS:i.startDTS,startPTS:i.startPTS,endDTS:i.endDTS,endPTS:i.endPTS,type:"audio",track:this.currentInitTrack};else if(this.logger.error("Missing video and audio data"),c){const r=Q(c,1);e={data1:new Uint8Array(0),startDTS:r,startPTS:r,endDTS:r,endPTS:r,type:"video",track:this.currentInitTrack,dropped:1,framesWithoutIDR:1,firstKeyframePts:r}}null!=s&&s.captionSamples.length&&e&&this.remuxText(s,e),null!==(s=null==a?void 0:a.id3Samples)&&void 0!==s&&s.length&&e&&this.remuxID3(a,e),this.observer.trigger(b.FRAG_PARSING_DATA,e)}else this.logger.error("failed to generate IS");this.observer.trigger(b.FRAG_PARSED)}updateInitPTSDTS(e,t,i){let r=1/0,n=1/0;const a=e?e.parsingData.esSamples:[],s=t?t.parsingData.esSamples:[];if(!z(this._initPTS)){if(t&&s.length&&(r=n=s[0].pts-t.info.inputTimescale*i),e&&a.length&&e.config.sps&&e.config.pps){const t=e.info.inputTimescale,s=Le(a),o=Math.round(t*i);e.info.timescale=t,r=Math.min(r,s-o),n=Math.min(n,Pe(a[0].dts,s)-o),this.observer.trigger(b.INIT_PTS_FOUND,{initPTS:Q(r,t)})}if(z(r)&&z(n))this._initPTS=r,this._initDTS=n;else{const e=new I(!1,"invalid initPTS or initDTS",G.InvalidInitTimestamp);this.observer.trigger(N.INTERNAL_ERROR,e)}}}generateIS(e,t){const i=t?t.parsingData.esSamples:[],r=this.typeSupported;let n,a="audio/mp4";if(e&&t&&i.length&&t.config.sps&&t.config.pps){const i=t.info.inputTimescale;t.info.timescale=i,e.info.timescale=e.config.samplerate;const r=he.initSegment([t,e]);n={type:"audiovideo",container:"video/mp4",codec:`${t.config.codec},${e.config.codec}`,initSegment:r}}else if(e){e.info.timescale=e.config.samplerate,"mp3"===e.config.segmentCodec&&(r.mpeg?(a="audio/mpeg",e.config.codec=""):r.mp3&&(e.config.codec="mp3"));const t="mp3"===e.config.segmentCodec&&r.mpeg?new Uint8Array:he.initSegment([e]);n={type:"audio",container:a,codec:e.config.codec,initSegment:t}}else if(t&&i.length&&t.config.sps&&t.config.pps){const e=t.info.inputTimescale;t.info.timescale=e;const i=he.initSegment([t]);n={type:"video",container:"video/mp4",codec:t.config.codec,initSegment:i}}if(n){this.currentInitTrack=n;const e={track:n};this.observer.trigger(b.FRAG_PARSING_INIT_SEGMENT,e)}else{const e=new I(!1,"no audio/video samples found",G.NoAVSamplesFound);this.observer.trigger(N.INTERNAL_ERROR,e)}}remuxVideo(n,e,t,a,i){var s,o;let l,r,d,u=8,c=null!==(s=this.videoSampleDuration)&&void 0!==s?s:NaN,h=Number.POSITIVE_INFINITY,p=Number.NEGATIVE_INFINITY,m=n.parsingData.dropped,f=this.nextAvcTimeOffset;const g=!t&&!!this.config.forceKeyFrameOnDiscontinuity,y=n.parsingData.esSamples,v=n.info.inputTimescale,S=[],I=this._initDTS,b=n.info.encrypted,T=z(i);let E=y.length,A=!1;t&&null!==f||(f=e*v-(y[0].pts-Pe(y[0].dts,y[0].pts)));for(let e=0;e<E;e++){const L=y[e];L.pts=Pe(L.pts,f+I),L.dts=Pe(L.dts,f+I),L.dts<y[0<e?e-1:e].dts&&(A=!0)}A&&y.sort(function(e,t){var i=e.dts-t.dts,r=e.pts-t.pts;return i||r||e.id-t.id});let O=NaN;t=y.findIndex(e=>e.key);y[t]&&(O=y[t].pts),g&&(0<t?(y.splice(0,t),E=y.length,m+=t):-1===t&&(m+=y.length)),d=T?(r=h=O=f=e*v,c=i*v/E,p=r+c*(E-1)):(r=y[0].dts,y[y.length-1].dts);var e=d-r,w=e?Math.round(e/(E-1)):c||v/30;r=Math.max(0,r);let R=0,C=0;for(let e=0;e<E;e++){const L=y[e],x=L.units,a=x.length;let t=0;for(let e=0;e<a;e++)t+=x[e].data.length;C+=t,R+=a,L.length=t,L.dts=Math.max(L.dts,r),T||(h=Math.min(L.pts,h),p=Math.max(L.pts,p))}T||(d=y[E-1].dts,p=Math.max(p,0,h+w));i=C+4*R+8;try{l=new Uint8Array(i)}catch(n){const L=new F(!1,`fail allocating video mdat ${i}`,G.FailedToAllocateVideoMdat,i);return void this.observer.trigger(N.INTERNAL_ERROR,L)}const k=new DataView(l.buffer);k.setUint32(0,i),l.set(he.types.mdat,4);let M=!1;for(let t=0;t<E;t++){const L=y[t],x=L.units;let i=0;const s=[];let e,r=0;for(let e=0,t=x.length;e<t;e++){const L=x[e],a=L.data,D=L.data.byteLength;if(k.setUint32(u,D),u+=4,l.set(a,u),u+=D,i+=4+D,b)if(D<=48||1!==L.type&&5!==L.type)r+=4+D;else{let e=D-32;e%16==0&&(e-=16),s.push([r+36,e]),r=D-32-e}}if(0<r&&s.push([r,0]),T)e=0;else{if(t<E-1)c=y[t+1].dts-L.dts;else{const x=this.config,_=0<t?L.dts-y[t-1].dts:w;if(x.stretchShortVideoTrack&&null!==this.nextAvcTimeOffset){const{maxBufferHole:n,maxSeekHole:s}=x,l=Math.floor(Math.min(null!==(o=null!=n?n:s)&&void 0!==o?o:NaN,null!=s?s:NaN)*v),N=(a?h+a*v:(null!==(o=this.nextAudioTimeOffset)&&void 0!==o?o:NaN)+this._initPTS)-L.pts;N>l?(c=N-_,c<0?c=_:M=!0):c=_}else c=_}e=Math.round(L.pts-L.dts)}S.push({size:i,duration:c,cts:e,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:L.key?2:1,isNonSync:L.key?0:1,paddingValue:0},keyTagInfo:L.keyTagInfo,subsamples:s})}if(S.length&&ke&&ke<70){const n=S[0].flags;n.dependsOn=2,n.isNonSync=0}e=d+c;this.nextAvcTimeOffset=e-(T?0:I),this.videoSampleDuration=M||!c?w:c,this.isVideoContiguous=!0;i={sequenceNumber:n.parsingData.sequenceNumber++,id:n.info.id,type:n.type,encrypted:n.info.encrypted,samples:S,defaultPerSampleIVSize:0},i=he.moof(r+this.audioPrimingDelay*v,i);n.parsingData.esSamples=[];const P=new Uint8Array(i.byteLength+l.byteLength);return P.set(i),P.set(l,i.byteLength),{data1:P,startPTS:Q(h/v,v),endPTS:Q(p/v,v),startDTS:Q(r/v,v),endDTS:Q(e/v,v),type:"video",dropped:m,framesWithoutIDR:t,firstKeyframePts:Q(O/v,v)}}remuxAudio(n,i,r,a,e,s){const t=n.info.inputTimescale,o=t/n.info.timescale,l=("aac"===n.config.segmentCodec?1024:"mp3"===n.config.segmentCodec?1152:1536)*o,d=this._initPTS,u="mp3"===n.config.segmentCodec&&this.typeSupported.mpeg,c=[],h=n.info.encrypted,p=void 0!==e;let m,f,g,y=u?0:8;const v=new J,S=n.parsingData.esSamples;let I=this.nextAudioTimeOffset||-1;const b=i*t,T=S.length&&0<I&&(a&&Math.abs(b-I)<9e3||Math.abs(Pe(S[0].pts-d,b)-I)<20*l),E=this.isAudioContiguous=r=r||!!T;S.forEach(e=>{e.pts=e.dts=Pe(e.pts,b+d)}),E&&-1!==I||(I=0===e?0:a&&!p?b:S[0].pts-d);let A=Math.max(0,I+d);if("aac"===n.config.segmentCodec)for(let i=0,r=A;i<S.length;i++){const M=S[i],e=M.pts,a=e-r,o=a/t;if(a<=-l&&p)0===i&&(A=r=e,this.nextAudioTimeOffset=A-d);else if(a>=l&&o<1e4&&p){let t=Math.round(a/l);r=e-t*l,r<0&&(t--,r+=l),0===i&&(A=r,this.nextAudioTimeOffset=A-d);for(let e=0;e<t;e++){let e=ue(n.config.codec,n.config.channelCount);e=e||M.unit.subarray(0),S.splice(i,0,{unit:e,pts:r,dts:r,keyTagInfo:s}),n.parsingData.len+=e.length,r+=l,i++}}r+=l}let O,w=null,R=null,C=0,k=S.length;for(;k--;)C+=S[k].unit.byteLength;for(let t=0,e=S.length;t<e;t++){const r=S[t],M=r.unit;let e=r.pts;if(null!==R)c[t-1].duration=Math.round((e-R)/o);else{if(E&&"aac"===n.config.segmentCodec&&(e=A),w=e,!(0<C))return null;C+=y;try{O=new Uint8Array(C)}catch(n){const i=new F(!1,`fail allocating audio mdat ${C}`,G.FailedToAllocateAudioMdat,C);return this.observer.trigger(N.INTERNAL_ERROR,i),null}u||(m=new DataView(O.buffer),m.setUint32(0,C),O.set(he.types.mdat,4))}null==O||O.set(M,y);const s=M.byteLength;y+=s;const a=[];if(h)if("ec3"===n.config.segmentCodec){let e=0;for(;e<M.byteLength;){const i=2*(v.bsReadAndUpdate(M,{byteOffset:e+2,usedBits:5},11)+1);e+=i;const r=Math.min(i,16);a.push([r,i-r])}}else{const n=Math.min(s,16);a.push([n,s-n])}f={size:s,cts:0,duration:0,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:1,paddingValue:0,isNonSync:0},keyTagInfo:r.keyTagInfo,subsamples:a},c.push(f),R=e}var a=c.length;if(a){let e=c[a-1].duration;if(2<=a&&(e=c[a-2].duration,f&&(f.duration=e)),A=(null!=R?R:NaN)+o*e,this.nextAudioTimeOffset=A-d,n.parsingData.len=0,u)g=new Uint8Array;else{const i={sequenceNumber:n.parsingData.sequenceNumber++,id:n.info.id,type:n.type,encrypted:n.info.encrypted,samples:c,defaultPerSampleIVSize:0};g=he.moof(((null!=w?w:NaN)+this.audioPrimingDelay*t)/o,i)}const r=new Uint8Array(g.byteLength+(null!==(a=null==O?void 0:O.byteLength)&&void 0!==a?a:NaN));r.set(g),O&&r.set(O,g.byteLength),n.parsingData.esSamples=[];const M={data1:r,startPTS:Q((null!=w?w:NaN)/t,t),endPTS:Q(A/t,t),startDTS:Q((null!=w?w:NaN)/t,t),endDTS:Q(A/t,t),type:"audio"};return this.isAudioContiguous=!0,M}return null}remuxEmptyAudio(t,e,i,r,n,a,s){var o=t.info.inputTimescale,l=o/(t.config.samplerate||o),d=(null!==(d=this.nextAudioTimeOffset)&&void 0!==d?d:NaN)+this._initPTS,u=(1?d:E(a.startDTS)*o)+this._initDTS,o=E(a.endDTS)*o+this._initDTS,c=1024*l,h=Math.ceil((o-u)/c),p=ue(t.config.codec,t.config.channelCount);if(!p)return this.logger.error("Unable to remuxEmptyAudio since we were unable to get a silent frame for given audio codec!"),null;const m=[];for(let e=0;e<h;e++){const i=u+e*c;m.push({unit:p,pts:i,dts:i,keyTagInfo:s}),t.parsingData.len+=p.length}return t.parsingData.esSamples=m,this.remuxAudio(t,e,i,r,n,s)}remuxID3(t,e){var i=t.id3Samples.length;let r;var n=t.inputTimescale;if(i){for(let e=0;e<i;e++)r=t.id3Samples[e],r.pts=r.pts/n,r.dts=r.dts/n;e.id3Samples=t.id3Samples}t.id3Samples=[]}remuxText(t,e){t.captionSamples.sort(function(e,t){return e.pts-t.pts});var i=t.captionSamples.length;let r;var n=t.inputTimescale;if(i){for(let e=0;e<i;e++)r=t.captionSamples[e],r.pts=r.pts/n;e.captionData||(e.captionData={}),e.captionData.ts=t.captionSamples}t.captionSamples=[]}get audioPrimingDelay(){var e;return null!==(e=this.config.audioPrimingDelay)&&void 0!==e?e:0}}function Pe(e,t){var i;if(void 0===t)return e;for(i=t<e?-8589934592:8589934592;4294967296<Math.abs(e-t);)e+=i;return e}function Le(e){return e.reduce((e,t)=>{var i=t.pts-e;return i<-4294967296?Pe(e,t.pts):0<i?e:t.pts},e[0].pts)}function xe(e,t=1/0){if(!e)return"";const i=new Uint8Array(e);let r,n="";for(r=0;r<i.length&&r<t;r++){let e=i[r].toString(16);e.length<2&&(e="0"+e),n+=e}return n}const De={bin2str:e=>String.fromCharCode.apply(null,Array.from(e)),readUint16(e,t){t=e[t]<<8|e[t+1];return t<0?65536+t:t},readSint32:(e,t)=>e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3],readUint32(e,t){t=De.readSint32(e,t);return t<0?4294967296+t:t},writeUint32(e,t,i){e[t]=i>>24,e[t+1]=i>>16&255,e[t+2]=i>>8&255,e[t+3]=255&i},readUint64(e,t){var i=De.readUint32(e,t);return i*=Math.pow(2,32),i+=De.readUint32(e,t+4)},writeUint64(e,t,i){var r=Math.pow(2,32)-1,n=Math.floor(i/(r+1)),r=Math.floor(i%(r+1));De.writeUint32(e,t,n),De.writeUint32(e,t+4,r)},findBox(e,t){let i,r,n,a,s,o=[];if(!t.length)return[];for(i=0;i<e.byteLength;)r=De.readUint32(e,i),n=De.bin2str(e.subarray(i+4,i+8)),a=1<r?i+r:e.byteLength,n===t[0]&&(1===t.length?o.push(e.subarray(i+8,a)):(s=De.findBox(e.subarray(i+8,a),t.slice(1))).length&&(o=o.concat(s))),i=a;return o},findBoxWithOffset(e,t,i,r){let n,a,s,o,l,d=[];if(!i.length)return[];for(n=0;n<e.byteLength;)a=De.readUint32(e,n),s=De.bin2str(e.subarray(n+4,n+8)),o=1<a?n+a:e.byteLength,s===i[0]&&(r&&r.push({offset:n+t,type:s,size:a}),1===i.length?d.push({offset:n+t,type:s,data:e.subarray(n+8,o),boxSize:a,walkedPath:r?r.slice(0):void 0}):(l=De.findBoxWithOffset(e.subarray(n+8,o),n+t+8,i.slice(1),r?r.slice(0):void 0)).length&&(d=d.concat(l),r=r?r.slice(0,-1):void 0)),n=o;return d}},_e={name:"MP4EncryptionRemuxer"};class Ne extends O{constructor(e,t,i,r,n){super(e,t,n)}static _isCommonEncryptionInternal(e){return Boolean(e&&!("NONE"===e||"AES-128"===e))}static remuxInitSegment(c,h,p,m){if(!p)return c;let e=c;if(Ne._isCommonEncryptionInternal(p.method)){const f=p.keyId;let u=!1;const g=[];De.findBoxWithOffset(c,0,["moov","trak"]).forEach(t=>{const o=t.data;let l,i=0;const d=De.findBoxWithOffset(o,0,["mdia","minf","stbl","stsd"],[])[0],e=d.data.subarray(8);let r=!0,n=De.findBoxWithOffset(e,d.offset+16,["enca"]);0===n.length&&(r=!1,n=De.findBoxWithOffset(e,d.offset+16,["encv"])),n.forEach(a=>{let e=null,s=null;i=r?(e=a.data.subarray(28),l="audio",d.offset+16+8+28):(e=a.data.subarray(78),l="video",d.offset+16+8+78),e&&De.findBoxWithOffset(e,i,["sinf"]).forEach(e=>{const t=e.data,i=De.findBox(t,["frma"])[0],r=De.findBox(t,["schm"])[0];if(i)if(r){var n=De.bin2str(r.subarray(4,8));if("aac "===De.bin2str(i.subarray(0,4))&&(ge.types||ge.init(),i.set(ge.types.mp4a,0)),"cbcs"===n||"cenc"===n){m&&m.push(t);const e=De.findBox(t,["schi","tenc"])[0];if(e){const h=8;e.subarray(h,h+16),f&&e.set(f,h);const m=e[6],t=e[7];if(1===m&&0===t){const h=e[24];0<h&&p.iv&&h===p.iv.length&&e.set(p.iv,25)}}}else if("cbc2"===n){u=!0,ge.types||ge.init();const h=De.findBoxWithOffset(t,0,["frma"])[0],m=ge.box(ge.types.schi,ge.tenc(p,l)),f=ge.box(ge.types.sinf,t.subarray(h.offset,h.boxSize),ge.schm(),m);s=ge.box(ge.types.trak,o.subarray(0,e.offset),f,o.subarray(e.offset+e.boxSize));const i=s.subarray(8),r=f.byteLength-e.boxSize;d.walkedPath&&(d.walkedPath.push({type:"stsd",offset:a.offset,size:a.boxSize}),d.walkedPath.forEach(e=>{De.writeUint32(i,e.offset,e.size+r)}))}}else h.error(_e,"missing schm box");else h.error(_e,"missing frma box")}),s=s||c.subarray(t.offset,t.offset+t.boxSize),g.push(s)});var a=De.findBoxWithOffset(o,0,["edts"])[0];a&&(ge.types||ge.init(),o.set(ge.types.free,a.offset+4))}),u&&(e=Ne.remuxCbc2InitSegment(c,g,h)||c)}return e}static remuxCbc2InitSegment(e,t,i){const r=De.findBoxWithOffset(e,0,["ftyp"])[0];if(!r)return i.error(_e,"no ftyp found"),new Uint8Array;const n=De.findBoxWithOffset(e,r.boxSize,["moov"])[0];let a=[],s=0;for(;s<n.data.byteLength;){const e=De.readUint32(n.data,s),i=De.bin2str(n.data.subarray(s+4,s+8)),r=1<e?s+e:n.data.byteLength;"trak"===i?t&&(a=a.concat(t),t=void 0):a.push(n.data.subarray(s,r)),s=r}const o=ge.box(ge.types.moov,...a),l=new Uint8Array(r.boxSize+o.byteLength);return l.set(e.subarray(0,r.boxSize)),l.set(o,r.boxSize),l}static remuxOverflowSegment(i,e){ge.types||ge.init();const t=De.findBoxWithOffset(i,0,["moof","traf","tfdt"],[]);let r,n=i.byteLength;if(t.forEach(e=>{0===e.data[0]&&(n+=4)}),n>i.byteLength){r=new Uint8Array(n);let e=0,t=0;for(;t<i.byteLength;){const n=De.readUint32(i,t),a=De.bin2str(i.subarray(t+4,t+8)),s=1<n?t+n:i.byteLength;if("moof"===a){const n=Ne.remuxOverflowMoof(i.subarray(t+8,s));r.set(n,e),e+=n.byteLength}else r.set(i.subarray(t,s),e),e+=n;t=s}}return r||i}static remuxOverflowMoof(e){let t=0;const i=[];for(;t<e.byteLength;){const r=De.readUint32(e,t);if("traf"===De.bin2str(e.subarray(t+4,t+8))){const a=Ne.remuxOverflowTraf(e.subarray(t+8,t+r));i.push(a)}else i.push(e.subarray(t,t+r));t=1<r?t+r:e.byteLength}const r=ge.box(ge.types.moof,...i),a=r.byteLength-e.byteLength-8;return De.findBoxWithOffset(r,0,["moof","traf","trun"],[]).forEach(e=>{var t;0!=(1&e.data[3])&&(t=De.readUint32(e.data,8),De.writeUint32(e.data,8,t+a))}),De.findBoxWithOffset(r,0,["moof","traf","saio"],[]).forEach(t=>{const i=1&t.data[0];let r=4;1&t.data[3]&&(r+=8);var n=De.readUint32(t.data,r);if(r+=4,i)for(let e=0;e<n;e++){const i=De.readUint64(t.data,r);De.writeUint64(t.data,r,i+a),r+=8}else for(let e=0;e<n;e++){const i=De.readUint32(t.data,r);De.writeUint32(t.data,r,i+a),r+=4}}),r}static remuxOverflowTraf(e){let t=0;const i=[];for(;t<e.byteLength;){var r,n=De.readUint32(e,t);"tfdt"===De.bin2str(e.subarray(t+4,t+8))&&0===e[t+8]?(r=De.readUint32(e,t+12),r=ge.box(ge.types.tfdt,new Uint8Array([1,0,0,0,0,0,0,0,r>>24,r>>16&255,r>>8&255,255&r])),i.push(r)):i.push(e.subarray(t,t+n)),t=1<n?t+n:e.byteLength}return ge.box(ge.types.traf,...i)}remuxText(e,t){e.captionSamples.sort(function(e,t){return e.pts-t.pts}),e.captionSamples.length&&(t.captionData||(t.captionData={}),t.captionData.mp4=e.captionSamples),e.captionSamples=[]}remuxIFrame(r,n,a,s,o){if(n.samples&&n.samples.length&&n.samples[0].data){let e;const u=ge.moof(r*n.timescale,n,this.logger),c=new Uint8Array(u.byteLength+n.samples[0].data.byteLength+8);c.set(u),De.writeUint32(c,u.byteLength,n.samples[0].data.byteLength+8),c.set(ge.types.mdat,u.byteLength+4),c.set(n.samples[0].data,u.byteLength+8),n.sequenceNumber++;var l=n.timescale,d=Q(r+s,l),l=Q(r,l);let t,i;t=a?(e="audiovideo",a.sequenceNumber=n.sequenceNumber,n.sequenceNumber++,i=Ce.getSegment(a,a.sequenceNumber,r*a.info.timescale,s),i?A(i.endTs,d):d):(e="video",d);o={data1:c,data2:null==i?void 0:i.silentFragData,startPTS:l,startDTS:l,endPTS:t,endDTS:t,type:e,dropped:0,track:o};this.observer.trigger(b.FRAG_PARSING_DATA,o),this.observer.trigger(b.FRAG_PARSED)}}remuxEmsgAndRawData(e,t,i,r,n,a,s,o,l,d,u){let c="video";t&&r?c="audiovideo":t?c="audio":r&&(c="video");const h=Math.max(i,e),p={data1:d,track:u,startPTS:Q(o,l),startDTS:Q(o,l),endPTS:{baseTime:NaN,timescale:NaN},endDTS:{baseTime:NaN,timescale:NaN},largestVideoSampleSize:n,type:c,dropped:0};return h&&(p.endPTS=Q(o+h,l),p.endDTS=Q(o+h,l)),a&&a.captionSamples.length&&this.remuxText(a,p),s&&0<s.id3Samples.length&&this.remuxID3(s,p),this.observer.trigger(b.FRAG_PARSING_DATA,p),this.observer.trigger(b.FRAG_PARSED),p}remuxID3(t,e){let i;var r=t.id3Samples.length;if(r){for(let e=0;e<r;e++)i=t.id3Samples[e],i.pts=i.pts-10,i.dts=i.dts-10;e.id3Samples=[...t.id3Samples]}t.id3Samples=[]}}const Fe=Math.pow(2,32)-1,Be=Math.pow(2,20)-1,Ue={name:"MP4Demuxer"},Ve=/\/emsg[-/]ID3/i;class $e extends d{constructor(e,t,i,r=0,n){super(e,t,i,{},n),this.trySEICaptions=!1,this.mp4Remuxer=t,this.audioPrimingDelay=null!==(i=i.audioPrimingDelay)&&void 0!==i?i:0}resetTimeStamp(e){var t;z(e)?null!==(t=this.initData)&&void 0!==t&&t.audio&&!this.initData.video?this.initPtsTs={baseTime:Math.round(e*this.initData.audio.timescale/9e4),timescale:this.initData.audio.timescale}:this.initPtsTs={baseTime:e,timescale:9e4}:this.initPtsTs=void 0}static isHEVCFlavor(e){if(!e)return!1;var t=e.indexOf("."),t=t<0?e:e.substring(0,t);return"hvc1"===t||"hev1"===t||"chvc"===t||"qhvc"===t||"qhev"===t||"muxa"===t||"dvh1"===t||"dvhe"===t||"cdh1"===t||"qdh1"===t||"qdhe"===t}resetInitSegment(t,i,r){if(this._silentAudioTrack=void 0,t&&t.byteLength){var n=Ne.remuxInitSegment(t,this.logger,r),a=this.initData=$e.parseInitSegment(n,this.logger);let e;var s=a.audioCodec,r=a.videoCodec;if(a.audio&&a.video?e={type:"audiovideo",container:"video/mp4",codec:s+","+r,initSegment:n}:(a.audio&&s&&(e={type:"audio",container:"audio/mp4",codec:s,initSegment:n}),a.video&&r&&(e={type:"video",container:"video/mp4",codec:r,initSegment:n})),a.video){const o=a.video,l=t.subarray(o.trakOffset,o.trakOffset+o.trakSize);this._videoTrack=Object.assign(Object.assign({},o),{info:{id:o.id,timescale:o.timescale,duration:i},trakData:l,sequenceNumber:0,samples:[]}),this.trySEICaptions=!Re.isVP09(null!=r?r:"");r=null!==(r=a.caption)&&void 0!==r?r:{};this._captionTrack=Object.assign(Object.assign({},r),{sequenceNumber:0,captionSamples:[]})}if(a.audio&&s&&(this._audioTrack=Object.assign({},a.audio)),a.caption&&(this.trySEICaptions=!1,this._captionTrack=Object.assign(Object.assign({},a.caption),{sequenceNumber:0,captionSamples:[]})),this.remuxedInitDataTrack=e,e){const t={track:e};this.observer.trigger(b.FRAG_PARSING_INIT_SEGMENT,t)}}}static probe(e,t){return 0<De.findBox(e.subarray(0,Math.min(e.length,512e3)),["moof"]).length}static probeInitSegment(e){return 0<De.findBox(e.subarray(0,Math.min(e.length,512e3)),["moov","trak"]).length}static parseHvcC(e,t){let i;if(e&&1===e[0]){const t=e[1];i={profileSpace:t>>6,tierFlag:(32&t)>>5?"H":"L",profileIDC:31&t,profileCompat:De.readUint32(e,2),constraintIndicator:e.subarray(6,12),levelIDC:e[12]}}return i}static hvcCToCodecString(t,i){const r=t+"."+(i.profileSpace?String.fromCharCode(i.profileSpace+"A"-1):"")+i.profileIDC+"."+i.profileCompat.toString(16).toUpperCase()+"."+i.tierFlag+i.levelIDC;let n="";for(let e=i.constraintIndicator.length-1;0<=e;--e){const r=i.constraintIndicator[e];if(0!==r||""!==n){const t=r.toString(16).toUpperCase();n="."+(""===n?t:t+n)}}return r+n}static parseDvcC(e,t){let i;return e&&(i={versionMajor:e[0],versionMinor:e[1],profile:e[2]>>1&127,level:e[2]<<5&32|e[3]>>3&31}),i}static dvcCToCodecString(e,t){return e+"."+$e.checkAndAddLeadingZero(t.profile)+"."+$e.checkAndAddLeadingZero(t.level)}static parseVpcC(e,t){let i;return e&&(i={profile:e[4],level:e[5],bitDepth:e[6]>>4&15}),i}static vpcCToCodecString(e,t){return e+"."+$e.checkAndAddLeadingZero(t.profile)+"."+$e.checkAndAddLeadingZero(t.level)+"."+$e.checkAndAddLeadingZero(t.bitDepth)}static parseAv1C(e,t){let i;if(e){const t=e[1]>>>3,r=(64&e[2])>>6,n=(32&e[2])>>5,a=(8&e[2])>>3,s=(4&e[2])>>2,o=3&e[2];i={profile:t,level:31&e[1],tierFlag:e[2]>>>7?"H":"M",bitDepth:2==t&&r?n?12:10:r?10:8,monochrome:(16&e[2])>>4,chromaSubsampling:`${a}${s}${o}`}}return i}static av1CToCodecString(e,t){var{profile:i,tierFlag:r,monochrome:n,chromaSubsampling:a}=t;return e+"."+i+"."+$e.checkAndAddLeadingZero(t.level)+r+"."+$e.checkAndAddLeadingZero(t.bitDepth)+"."+n+"."+a}static checkAndAddLeadingZero(e){return(e<10?"0":"")+e}static parseInitSegment(e,c){const h={foundLargeTimescale:!1,tracksById:{}};return De.findBoxWithOffset(e,0,["moov","trak"]).forEach(t=>{const i=t.data,r=De.findBox(i,["tkhd"])[0];if(r){var n=0===(s=r[0])?12:20,a=De.readUint32(r,n),e=De.findBox(i,["mdia","mdhd"])[0];if(e){var s,o=0===(s=e[0])?12:20,n=De.readUint32(e,o);o+=4,1e6<=n&&(h.foundLargeTimescale=!0);const l=0===s?De.readUint32(e,o):0,d=De.findBox(i,["mdia","hdlr"])[0];if(d){const r=De.bin2str(d.subarray(8,12)),u={soun:"audio",vide:"video",clcp:"caption",subt:"ttml"}[r]||r;if(u){const r=De.findBox(i,["mdia","minf","stbl","stsd"]);if(r.length){const i=r[0];De.bin2str(i.subarray(12,16));o=$e.parseStsd(i,c);let e;if("caption"===u){const t=Object.assign({id:a,type:u,timescale:n,duration:l,isTimingTrack:!1,sequenceNumber:0,captionSamples:[]},o);h.caption=t,e=t}else if("ttml"===u){const t=Object.assign({id:a,type:"ttml",timescale:n,duration:l,sequenceNumber:0},o);e=t,h.ttml=t,h.ttmlCodec=t.codec}else{const c=Object.assign({id:a,type:u,timescale:n,duration:l,isTimingTrack:!0,trakOffset:t.offset,trakSize:t.boxSize,sequenceNumber:0,samples:[],fragmentDuration:0},o);"video"===u?(h.video=c,h.videoCodec=c.codec):(h.audio=c,h.audioCodec=c.codec),e=c}h.tracksById[a]=e}}}}}}),De.findBoxWithOffset(e,0,["moov","mvex","trex"]).forEach(e=>{var t=e.data,e=De.readUint32(t,4),t=De.readUint32(t,16);h.tracksById[e]&&(h.tracksById[e].defaultSampleSize=t)}),h}static parseStsd(e,t){let r,i;const n=e.subarray(8);let a=De.bin2str(n.subarray(4,8)),s=null,o=null;"enca"===a?(s=De.findBox(n,["enca"])[0],o=s.subarray(28)):"encv"===a&&(s=De.findBox(n,["encv"])[0],o=s.subarray(78));e=!!o;let l;r=0,o&&De.findBox(o,["sinf"]).forEach(e=>{const t=De.findBox(e,["schm"])[0];if(t){var i=De.bin2str(t.subarray(4,8));if("cbcs"===i||"cenc"===i){const t=De.findBox(e,["frma"])[0];t&&(a=De.bin2str(t));e=De.findBox(e,["schi","tenc"])[0];e&&(r=e[7])}}});var d=n.subarray(86);switch(a){case"mp4a":i="mp4a.40.5";break;case"ac-3":case"ec-3":case"alac":case"fLaC":case"c608":default:i=a;break;case"avc1":case"avc3":i=a+".640028";break;case"hvc1":case"hev1":const u=De.findBox(d,["hvcC"])[0];l=$e.parseHvcC(u,t),i=l?$e.hvcCToCodecString(a,l):a+".2.4.H150.B0";break;case"dvh1":case"dvhe":const r=De.findBox(d,["dvcC"])[0];l=$e.parseDvcC(r,t),i=l?$e.dvcCToCodecString(a,l):a+".05.01";break;case"vp09":const n=De.findBox(d,["vpcC"])[0];l=$e.parseVpcC(n,t),i=l?$e.vpcCToCodecString(a,l):a;break;case"av01":const s=De.findBox(d,["av1C"])[0];l=$e.parseAv1C(s,t),i=l?$e.av1CToCodecString(a,l):a}return{codec:i,encrypted:e,defaultPerSampleIVSize:r}}static has32BitTfdts(e){const t=De.findBox(e,["moof","traf","tfdt"]);let i=!1;return t.forEach(e=>{0===e[0]&&(i=!0)}),i}static getStartDtsTs(i,e,t){const r=De.findBox(e,["moof","traf"]);let n,a=Number.MAX_SAFE_INTEGER;return r.map(function(t){return De.findBox(t,["tfhd"]).forEach(e=>{e=De.readUint32(e,4),e=i.tracksById[e];let r;if(e){if(!e.isTimingTrack)return 1/0;r=e.timescale||9e4;e=De.findBox(t,["tfdt"]).map(function(e){let t;const i=e[0];if(t=De.readUint32(e,4),1===i){const i=De.readUint32(e,8);if(t===Fe&&i>Fe-.5*r)return 0;t*=Fe+1,t+=i}return t}),e=0<e.length?e[0]:1/0;isFinite(e)&&e/r<a&&(a=e/r,n={baseTime:e,timescale:r})}})}),n}static offsetStartDTS(r,e,l,n,d){De.findBox(e,["moof","traf"]).map(function(i){return De.findBox(i,["tfhd"]).map(function(e){const t=De.readUint32(e,4),a=r.tracksById[t];if(a){const s=a.timescale||9e4,o="caption"===a.type?0:n;De.findBox(i,["tfdt"]).map(function(t){const i=t[0],r=a.type;if(0===i){let e=De.readUint32(t,4)-Math.round(l.baseTime*s/l.timescale);"video"===r&&e<0&&(e=0),e+=Math.round(o*s),e=Math.max(e,0),De.writeUint32(t,4,e)}else{const i=De.readUint32(t,4);i>Be&&d.error(Ue,`baseMediaDecodeTime larger than can be represented by float for upper 32 bits ${i}`);let e=i;e*=Math.pow(2,32),e+=De.readUint32(t,8),e-=Math.round(l.baseTime*s/l.timescale),"video"===r&&e<0&&(e=0),e+=Math.round(o*s),e=Math.max(e,0);const n=Math.floor(e/(Fe+1)),a=Math.floor(e%(Fe+1));De.writeUint32(t,4,n),De.writeUint32(t,8,a)}})}})})}static writeStartDTS(i,e,a,t){De.findBox(e,["moof","traf"]).map(function(t){return De.findBox(t,["tfhd"]).map(function(e){e=De.readUint32(e,4),e=i.tracksById[e];if(e){const r=e.timescale||9e4,n=Math.round(a*r)/r;De.findBox(t,["tfdt"]).map(function(e){var t,i;0===e[0]?De.writeUint32(e,4,n*r):(i=n*r,i=Math.max(i,0),t=Math.floor(i/(Fe+1)),i=Math.floor(i%(Fe+1)),De.writeUint32(e,4,t),De.writeUint32(e,8,i))})}})})}static parseSAIO(e,t){let i=0,r=0;var n=e[0];r+=4,0!=(1&De.readUint32(e,0))&&(r+=8);var a=16777215&De.readUint32(e,r);return 1==a?(r+=4,i=De.readUint32(e,r),1===n&&(r+=4,i*=Math.pow(2,32),i+=De.readUint32(e,r))):t.error(Ue,`saio entry count error, count is: ${a}`),i}static parseSAIZ(e){let t=0,i=0;return i+=4,0!=(1&De.readUint32(e,0))&&(i+=8),t=e[i],i++,i+=4,0===t&&(t=e[i]),t}static parseSubsample(e,t){const i={subsamples:[]};let r=0;for(e&&(i.iv=t.subarray(0,e),r+=e),r+=2;r+6<=t.byteLength;){const e=De.readUint16(t,r);r+=2;var n=De.readUint32(t,r);r+=4,i.subsamples.push([e,n])}return i}static isSEIMessage(e,t){return e?39===t||40===t:6===t}static parseCLCPSample(e,t,i,r){let n=0;const a=[];let s=0;for(;n<i;){var o=t+n;const r=De.readUint32(e,o);o+=4;var l=De.bin2str(e.subarray(o,o+4));if(o+=4,"cdat"!==l)break;{const t=r-8,d=e.subarray(o,o+t);s+=t,a.push(d),n+=r}}return{cdatList:a,cdatTotalSize:s}}static parseSamples(e,S,I,b,T,E,A){const O=I.timescale,c=I.id;let w,R=e,C=0,k=!1,M=0;return De.findBoxWithOffset(S,0,["moof"]).map(function(e){const t=e.data,u=e.offset;De.findBox(t,["traf"]).map(function(d){var e=De.findBox(d,["tfdt"]).map(function(e){let t;var i=e[0];return t=De.readUint32(e,4),1===i&&(t*=Math.pow(2,32),t+=De.readUint32(e,8)),t/O})[0];return void 0!==e&&(R=e),De.findBox(d,["tfhd"]).map(function(e){var t=De.readUint32(e,4),i=16777215&De.readUint32(e,0),r=0!=(1&i);let g=0;var n=0!=(2&i),a=0!=(8&i);let y=0;var s=0!=(16&i);let v=0;var o=0!=(32&i),i=!r&&0!=(131072&i);let l=8;if(z(I.defaultSampleSize)&&(v=I.defaultSampleSize),t===c){if(r?(g=De.readUint32(e,l),l+=4,g*=Math.pow(2,32),g+=De.readUint32(e,l),l+=4):i&&(g=u),n&&(De.readUint32(e,l),l+=4),a&&(y=De.readUint32(e,l),l+=4),s&&(v=De.readUint32(e,l),l+=4),o&&(De.readUint32(e,l),l+=4),"video"===I.type){let t=0,i=0;De.findBox(d,["saio"]).map(function(e){t=$e.parseSAIO(e,A)}),De.findBox(d,["saiz"]).map(function(e){i=$e.parseSAIZ(e)}),t&&i&&(w=$e.parseSubsample(I.defaultPerSampleIVSize,S.subarray(g+t,g+t+i))),k=$e.isHEVCFlavor(I.codec)}De.findBox(d,["trun"]).map(function(i){var t=i[0],e=16777215&De.readUint32(i,0),r=0!=(1&e);let n=0;var a=0!=(4&e),s=0!=(256&e);let o=0;var l=0!=(512&e);let d=0;var u=0!=(1024&e),c=0!=(2048&e);let h=0;var p=De.readUint32(i,4);let m=8;r&&(n=De.readSint32(i,m),m+=4),a&&(m+=4);let f=n+g;for(let e=0;e<p&&(E<0||C<E);e++){if(s?(o=De.readUint32(i,m),m+=4):o=y,l?(d=De.readUint32(i,m),m+=4):d=v,d>M&&(M=d),u&&(m+=4),c&&(h=0===t?De.readUint32(i,m):De.readSint32(i,m),m+=4),"video"===I.type){if(z(b))I.samples.push({data:S.subarray(f,f+d),size:d,duration:b*O,cts:0,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:2,isNonSync:0,paddingValue:0},subsamples:w?w.subsamples:[],iv:w?w.iv:void 0});else if(I.fragmentDuration+=o,T){let e=0;for(;e<d;){const b=De.readUint32(S,f);f+=4;const T=31&S[f];if(I.seiSamples||(I.seiSamples=[]),$e.isSEIMessage(k,T)){const i=S.subarray(f,f+b);I.seiSamples.push({pts:R+h/O,type:T,data:i,sampleOffset:f,naluSize:b})}f+=b,e+=b+4}}}else if("audio"===I.type)I.fragmentDuration+=o;else if("caption"===I.type){const{cdatList:i,cdatTotalSize:b}=$e.parseCLCPSample(S,f,d,A);if(f+=d,i.length){let t=new Uint8Array;if(1===i.length)t=new Uint8Array(i[0]);else if(1<i.length){let e=0;t=new Uint8Array(b);for(const b of i)t.set(b,e),e+=b.length}I.captionSamples.push({type:3,pts:R,bytes:t})}}C++,R+=o/O}})}})})}),M}static parseEmsg(e,t){let i,r,n,a,s,o="",l="",d=0;if(0===e[0]){for(;"\0"!==De.bin2str(e.subarray(d,d+1));)o+=De.bin2str(e.subarray(d,d+1)),d+=1;for(o+=De.bin2str(e.subarray(d,d+1)),d+=1;"\0"!==De.bin2str(e.subarray(d,d+1));)l+=De.bin2str(e.subarray(d,d+1)),d+=1;l+=De.bin2str(e.subarray(d,d+1)),d+=1,i=De.readUint32(e,12),r=De.readUint32(e,16),a=De.readUint32(e,20),s=De.readUint32(e,24),d=28}else{d+=4,i=De.readUint32(e,d),d+=4;const t=De.readUint32(e,d);d+=4;const r=De.readUint32(e,d);for(d+=4,n=Math.pow(2,32)*t+r,Number.isSafeInteger(n)||(n=Number.MAX_SAFE_INTEGER),a=De.readUint32(e,d),d+=4,s=De.readUint32(e,d),d+=4;"\0"!==De.bin2str(e.subarray(d,d+1));)o+=De.bin2str(e.subarray(d,d+1)),d+=1;for(o+=De.bin2str(e.subarray(d,d+1)),d+=1;"\0"!==De.bin2str(e.subarray(d,d+1));)l+=De.bin2str(e.subarray(d,d+1)),d+=1;l+=De.bin2str(e.subarray(d,d+1)),d+=1}return{schemeIdUri:o,value:l,timeScale:i,presentationTime:n,presentationTimeDelta:r,eventDuration:a,id:s,payload:e.subarray(d,e.byteLength)}}static extractID3PayloadCreateID3Track(e,t,i,r){const n=new _(e.payload,r),a=new Uint8Array(e.payload),s=a.byteLength;let o=0,l=0,d=NaN;if(z(e.presentationTime)?d=e.presentationTime/e.timeScale:z(e.presentationTimeDelta)&&(d=t+e.presentationTimeDelta/e.timeScale),z(d)){const c=e.eventDuration,h=a.subarray(0,10),p=De.bin2str(h.subarray(l,l+3));l+=3,"ID3"!==p&&r.error(Ue,"No ID3 tag found when extracting ID3 payload"),l+=2;var t=a.subarray(l,l+1),e=64&t[0],u=16&t[0];if(l+=1,_.readSynchSafeUint32(a.subarray(l,l+4)),l+=4,e){const m=_.readSynchSafeUint32(a.subarray(l,l+4));l+=4,l+=m}for(;l+2<s;){De.bin2str(a.subarray(l,l+4)),l+=4;const f=_.readSynchSafeUint32(a.subarray(l,l+4));l+=4;const s=d+o*c,h={data:a,pts:s,dts:s,keyTagInfo:void 0,frames:n.frames};i.id3Samples.push(h),l+=f,o++,u&&("DI3"!==De.bin2str(a.subarray(l,l+3))&&r.error(Ue,"End should be DI3 if footer present in extracting ID3 payload"),l+=3,l+=7)}l+2===s&&De.readUint16(a,l)}else r.error(Ue,"No pts found in emsg info when extracting ID3 payload")}append(e,t,i,r,n,a,s){let o=this.initData,l=0,d=0,u=!1,c=!1,h=0;if(void 0===o&&(this.resetInitSegment(e,0),o=this.initData),o){var p=this.initPtsTs,m=$e.getStartDtsTs(o,e,this.logger);p||(this.initPtsTs=p=m?{baseTime:m.baseTime-Math.round(t*m.timescale),timescale:m.timescale}:{baseTime:NaN,timescale:NaN},this.observer.trigger(b.INIT_PTS_FOUND,{initPTS:p})),o.foundLargeTimescale&&$e.has32BitTfdts(e)&&!s&&(e=Ne.remuxOverflowSegment(e,this.logger));const f=De.findBox(e,["emsg"]);if(o.video&&o.video.encrypted&&De.findBox(e,["moof","traf"]).find(function(e){return Boolean(De.findBox(e,["senc"])[0]||De.findBox(e,["saiz"])[0]&&De.findBox(e,["saio"])[0])}),s){const t=this._videoTrack.timescale;s=Math.ceil(s*t)/t;const i=m?this.audioPrimingDelay+E(m):NaN;if(this._videoTrack&&this._audioTrack&&!this._silentAudioTrack){const e=Ce.getTrack(this.observer,this._audioTrack.id,this._audioTrack.codec,2,this.logger);if(!e)throw`unable to create silent audio track for codec ${this._audioTrack.codec}`;this._silentAudioTrack=Object.assign(Object.assign({},e),{sequenceNumber:0});const t=ge.initSegment([this._videoTrack,this._silentAudioTrack]);this.remuxedInitDataTrack={type:"audiovideo",container:"video/mp4",codec:this._silentAudioTrack.config.codec+","+this._videoTrack.codec,initSegment:t};const i={track:this.remuxedInitDataTrack};this.observer.trigger(b.FRAG_PARSING_INIT_SEGMENT,i)}$e.parseSamples(i,e,this._videoTrack,s,!1,1,this.logger),this.remuxedInitDataTrack&&this.mp4Remuxer.remuxIFrame(i,this._videoTrack,this._silentAudioTrack,s,this.remuxedInitDataTrack),this._videoTrack.samples=[]}else{s=m?E(m)-this.audioPrimingDelay:NaN,s=Math.max(0,s);if(f&&0<f.length){const e=f.map(e=>{e=$e.parseEmsg(e,this.logger);return!this._id3Track&&Ve.test(e.schemeIdUri)&&(this._id3Track={id3Samples:[],inputTimescale:9e4}),e}),i=this._id3Track;i&&e.map(e=>{$e.extractID3PayloadCreateID3Track(e,t,i,this.logger)})}(this._videoTrack&&(h=$e.parseSamples(s,e,this._videoTrack,void 0,this.trySEICaptions,-1,this.logger),l=this._videoTrack.fragmentDuration/this._videoTrack.timescale,u=!0,this._videoTrack.fragmentDuration=0,this._captionTrack&&(this.trySEICaptions?($e.extractSEICaptionsFromNALu(this._videoTrack.seiSamples,this._captionTrack),this._videoTrack.seiSamples=[]):$e.parseSamples(s,e,this._captionTrack,void 0,!1,Number.MAX_SAFE_INTEGER,this.logger))),this._audioTrack&&($e.parseSamples(s,e,this._audioTrack,void 0,!1,-1,this.logger),d=this._audioTrack.fragmentDuration/this._audioTrack.timescale,c=!0,this._audioTrack.fragmentDuration=0),this.remuxedInitDataTrack)?(this.mp4Remuxer.remuxEmsgAndRawData(d,c,l,u,h,this._captionTrack,this._id3Track,s,null!==(m=null==m?void 0:m.timescale)&&void 0!==m?m:NaN,e,this.remuxedInitDataTrack),this._id3Track&&(this._id3Track.id3Samples=[])):this.logger.error("missing remuxedInitDataTrack")}}else this.logger.error("mp4-demuxer > append > missing initData")}static extractSEICaptionsFromNALu(s,o){if(s){for(let a=0;a<s.length;++a){var l=s[a],d=l.pts;let t=0;t++;let e=0,i=0,r=!1,n=0;for(;!r&&t<l.data.length;){for(e=0;!(t>=l.data.length)&&(n=l.data[t++],e+=n,255===n););for(i=0;!(t>=l.data.length)&&(n=l.data[t++],i+=n,255===n););const s=l.data.length-t;if(4===e&&t<l.data.length){if(r=!0,181===l.data[t++]){const s=De.readUint16(l.data,t);if(t+=2,49===s){const s=De.readUint32(l.data,t);if(t+=4,1195456820===s&&3===l.data[t++]){const s=l.data[t++];t++;const u=31&s,c=[];if(64&s)for(let e=0;e<u;e++){const s=l.data[t++];if(s===(252&s)){const o=3&s;if(0==o||1==o){const s=l.data[t++],o=l.data[t++];c.push(s),c.push(o)}}else t+=2}0<c.length&&o.captionSamples.push({type:3,pts:d,bytes:c})}}}}else if(i<s)t+=i;else if(i>s)break}}return o}}}const Qe={name:"ExpGolomb"};class Ke{constructor(e,t){this.data=e,this.logger=t,this._bytesAvailable=e.byteLength,this.word=0,this.bitsAvailable=0}get bytesAvailable(){return this._bytesAvailable}loadWord(){const e=this.data,t=this._bytesAvailable,i=e.byteLength-t,r=new Uint8Array(4),n=Math.min(4,t);if(0===n)throw new Error("no bytes available");r.set(e.subarray(i,i+n)),this.word=new DataView(r.buffer).getUint32(0),this.bitsAvailable=8*n,this._bytesAvailable-=n}skipBits(e){var t;this.bitsAvailable>e||(t=(e-=this.bitsAvailable)>>3,e-=t>>3,this._bytesAvailable-=t,this.loadWord()),this.word<<=e,this.bitsAvailable-=e}readBits(e){let t=Math.min(this.bitsAvailable,e);var i=this.word>>>32-t;return 32<e&&this.logger.error(Qe,"Cannot read more than 32 bits at a time"),this.bitsAvailable-=t,0<this.bitsAvailable?this.word<<=t:0<this._bytesAvailable&&this.loadWord(),t=e-t,0<t&&this.bitsAvailable?i<<t|this.readBits(t):i}skipLZ(){let e;for(e=0;e<this.bitsAvailable;++e)if(0!=(this.word&2147483648>>>e))return this.word<<=e,this.bitsAvailable-=e,e;return this.loadWord(),e+this.skipLZ()}skipUEG(){this.skipBits(1+this.skipLZ())}skipEG(){this.skipBits(1+this.skipLZ())}readUEG(){var e=this.skipLZ();return this.readBits(e+1)-1}readEG(){var e=this.readUEG();return 1&e?1+e>>>1:-1*(e>>>1)}readBoolean(){return 1===this.readBits(1)}readUByte(){return this.readBits(8)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}skipScalingList(e){let t,i,r=8,n=8;for(t=0;t<e;t++)0!==n&&(i=this.readEG(),n=(r+i+256)%256),r=0===n?r:n}readSPS(){let e,t,i,r=0,n=0,a=0,s=0;const o=this.readUByte.bind(this),l=this.readBits.bind(this),d=this.readUEG.bind(this),u=this.readBoolean.bind(this),c=this.skipBits.bind(this),h=this.skipEG.bind(this),p=this.skipUEG.bind(this),m=this.skipScalingList.bind(this);o();var f=o();if(l(5),c(3),o(),p(),100===f||110===f||122===f||244===f||44===f||83===f||86===f||118===f||128===f){const e=d();if(3===e&&c(1),p(),p(),c(1),u())for(t=3!==e?8:12,i=0;i<t;i++)u()&&m(i<6?16:64)}p();var g=d();if(0===g)d();else if(1===g)for(c(1),h(),h(),e=d(),i=0;i<e;i++)h();p(),c(1);var y=d(),f=d(),g=l(1);0===g&&c(1),c(1),u()&&(r=d(),n=d(),a=d(),s=d());let v=[1,1];if(u()&&u())switch(o()){case 1:v=[1,1];break;case 2:v=[12,11];break;case 3:v=[10,11];break;case 4:v=[16,11];break;case 5:v=[40,33];break;case 6:v=[24,11];break;case 7:v=[20,11];break;case 8:v=[32,11];break;case 9:v=[80,33];break;case 10:v=[18,11];break;case 11:v=[15,11];break;case 12:v=[64,33];break;case 13:v=[160,99];break;case 14:v=[4,3];break;case 15:v=[3,2];break;case 16:v=[2,1];break;case 255:v=[o()<<8|o(),o()<<8|o()]}return{width:Math.ceil(16*(y+1)-2*r-2*n),height:(2-g)*(f+1)*16-(g?2:4)*(a+s),pixelRatio:v}}readSliceType(){return this.readUByte(),this.readUEG(),this.readUEG()}}const qe=9e4;class He extends y{constructor(e,t,i,r,n){super(e,t,i,r,n),this.pmtParsed=!1,this.iframeMode=!1,this.contiguous=!1}static probe(e,t){return 376<=e.length&&71===e[0]&&71===e[188]}resetInitSegment(e,t,i){this.pmtParsed=!1,this._pmtId=-1;var r={id:-1,inputTimescale:qe,timescale:NaN,duration:0,encrypted:null!=i&&i.isEncrypted,keyTagInfo:i},i={len:0,sequenceNumber:0};this._avcContext={info:Object.assign({},r),parsingData:Object.assign(Object.assign({},i),{esSamples:new Array,dropped:0}),config:{},container:"video/mp2t",type:"video"},this._audioContext={info:Object.assign({},r),parsingData:Object.assign(Object.assign({},i),{esSamples:new Array}),container:"video/mp2t",type:"audio"},this._id3Track={id:-1,inputTimescale:qe,id3Samples:[]},this._txtTrack={inputTimescale:qe,captionSamples:[]},this._duration=t,He.probe(e,this.logger)?this._initSegment=e:e.length&&(this._initSegment=void 0)}append(e,t,i,r,n,a,s){this.contiguous=i,this.iframeMode=void 0!==s,!i&&this._audioContext&&(this._audioContext.audioLastPTS=void 0,this._audioContext.audioOverFlow=void 0,this._audioContext.overflowMissingBytes=void 0);var o=this._initSegment;o&&(this.parseTransportStream(o,n),this._initSegment=void 0),this.parseTransportStream(e,n),this.remuxResult(t,i,r,n,a,s)}parseTransportStream(e,t){const i=this._avcContext,r=this._audioContext,n=this._id3Track;let a,s,o,l,d,u=this.pmtParsed,c=i.info.id,h=r.info.id,p=n.id,m=this._pmtId,f=i.pesData,g=r.pesData,y=n.pesData,v=!1,S=e.length;for(S-=S%188,a=0;a<S;a+=188){if(71!==e[a]){const e=new I(!1,"TS packet did not start with 0x47",G.NoTSSyncByteFound);return void this.observer.trigger(N.INTERNAL_ERROR,e)}if(s=!!(64&e[a+1]),o=((31&e[a+1])<<8)+e[a+2],1<(48&e[a+3])>>4){if(l=a+5+e[a+4],l===a+188)continue}else l=a+4;switch(o){case c:s&&(f&&(d=this._parsePES(f))&&this._parseAVCPES(d,!1),f={data:[],size:0,keyTagInfo:t}),f&&(f.data.push(e.subarray(l,a+188)),f.size+=a+188-l);break;case h:if(s&&!this.iframeMode){if(g&&(d=this._parsePES(g)))switch(r.segmentCodec){case"aac":this._parseAACPES(d);break;case"mp3":this._parseMPEGPES(d);break;case"ac3":case"ec3":this._parseDolbyPES(d)}g={data:[],size:0,keyTagInfo:t}}g&&(g.data.push(e.subarray(l,a+188)),g.size+=a+188-l);break;case p:s&&(y&&(d=this._parsePES(y))&&n.id3Samples.push(d),y={data:[],size:0}),y&&(y.data.push(e.subarray(l,a+188)),y.size+=a+188-l);break;case 0:s&&(l+=e[l]+1),m=this._pmtId=this._parsePAT(e,l);break;case m:s&&(l+=e[l]+1);const o=this._parsePMT(e,l,this.typeSupported);c=o.avcId,0<c&&(i.info.id=c,i.info.encrypted=o.videoEncrypted),h=o.audioId,0<h&&(r.info.id=h,r.segmentCodec=o.audioSegmentCodec,r.info.encrypted=o.audioEncrypted),p=o.id3Id,0<p&&(n.id=p),v&&!u&&(v=!1,a=-188),u=this.pmtParsed=!0;break;case 17:case 8191:break;default:v=!0}}if(f&&(d=this._parsePES(f))?(this._parseAVCPES(d,!0),i.pesData=void 0):i.pesData=f,g&&(d=this._parsePES(g))){switch(r.segmentCodec){case"aac":this._parseAACPES(d);break;case"mp3":this._parseMPEGPES(d);break;case"ac3":case"ec3":this._parseDolbyPES(d)}r.pesData=void 0}else r.pesData=g;y&&(d=this._parsePES(y))?(n.id3Samples.push(d),n.pesData=void 0):n.pesData=y}remuxResult(e,t,i,r,n,a){var s=this._avcContext,o=this._audioContext,l=this._id3Track;let d,u;o.config&&o.segmentCodec&&(d={type:"audio",info:o.info,config:o.config,parsingData:o.parsingData});var c=s.config;"string"==typeof(o=c).codec&&Array.isArray(o.sps)&&Array.isArray(o.pps)&&"number"==typeof o.width&&"number"==typeof o.height&&Array.isArray(o.pixelRatio)&&(u={type:"video",info:s.info,config:c,parsingData:s.parsingData}),this.esRemuxer.remuxEsTracks(d,u,l,this._txtTrack,e,t,i,r,n,a)}destroy(){this._duration=0}_parsePAT(e,t){return(31&e[t+10])<<8|e[t+11]}_parsePMT(e,t,i){var r;const n={audioId:-1,avcId:-1,id3Id:-1,audioEncrypted:!1,videoEncrypted:!1},a=t+3+((15&e[t+1])<<8|e[t+2])-4;for(t+=12+((15&e[t+10])<<8|e[t+11]);t<a;){switch(r=(31&e[t+1])<<8|e[t+2],e[t]){case 207:n.audioEncrypted=!0;case 15:-1===n.audioId&&(n.audioId=r,n.audioSegmentCodec="aac");break;case 21:-1===n.id3Id&&(n.id3Id=r);break;case 219:n.videoEncrypted=!0;case 27:-1===n.avcId&&(n.avcId=r);break;case 3:case 4:!0!==i.mpeg&&!0!==i.mp3||-1===n.audioId&&(n.audioId=r,n.audioSegmentCodec="mp3");break;case 193:n.audioEncrypted=!0;case 129:!0===i.ac3&&-1===n.audioId&&(n.audioId=r,n.audioSegmentCodec="ac3");break;case 194:n.audioEncrypted=!0;case 135:!0===i.ec3&&-1===n.audioId&&(n.audioId=r,n.audioSegmentCodec="ec3")}t+=5+((15&e[t+3])<<8|e[t+4])}return n}_parsePES(e){let i,t,r,n,a,s,o=0;const l=e.data,d=e.keyTagInfo;let u=NaN,c=NaN;if(e&&0!==e.size){for(;l[0].length<19&&1<l.length;){const e=new Uint8Array(l[0].length+l[1].length);e.set(l[0]),e.set(l[1],l[0].length),l[0]=e,l.splice(1,1)}if(i=l[0],1===(i[0]<<16)+(i[1]<<8)+i[2]&&(r=(i[4]<<8)+i[5],!(r&&r>e.size-6))){192&(t=i[7])&&(u=536870912*(14&i[9])+4194304*(255&i[10])+16384*(254&i[11])+128*(255&i[12])+(254&i[13])/2,64&t?(c=536870912*(14&i[14])+4194304*(255&i[15])+16384*(254&i[16])+128*(255&i[17])+(254&i[18])/2,54e5<u-c&&(u=c)):c=u),n=i[8],s=n+9,e.size-=s,a=new Uint8Array(e.size);for(let t=0,e=l.length;t<e;t++){i=l[t];let e=i.byteLength;if(s){if(s>e){s-=e;continue}i=i.subarray(s),e-=s,s=0}a.set(i,o),o+=e}return r&&(r-=n+3),{data:a,pts:u,dts:c,len:r,keyTagInfo:d}}}}pushAccesUnit(e,t){const i=e.avcSample;if(i&&i.units.length&&i.frame){const r=e.parsingData.esSamples,n=r.length;((!0===i.key||e.config.sps&&(n||this.contiguous))&&(i.id=n,i.keyTagInfo=t,e.info.encrypted)&&i.units.forEach(e=>{if(48<e.data.byteLength)switch(e.type){case 1:case 5:e.data=this.discardEPB(e.data)}}),n||isFinite(i.pts))?r.push(i):e.parsingData.dropped++}}_parseAVCPES(a,e){if(!a.data)throw"invalid pes data";const s=this._duration,o=this._avcContext,l=this._txtTrack,t=this._parseAVCNALu(a.data);let d,u,c,h=o.avcSample;const p=a.keyTagInfo;a.data=void 0,t.forEach(n=>{switch(n.type){case 1:if(h&&!this.iframeMode){u=!0,h.frame=!0;const a=n.data;if(4<a.length){const n=new Ke(a,this.logger).readSliceType();2!==n&&4!==n&&7!==n&&9!==n||(h.key=!0)}}break;case 5:u=!0,h&&(h||(h=this._createAVCSample(!0,a.pts,a.dts,""),o.avcSample=h),h.key=!0,h.frame=!0);break;case 6:u=!0,d=new Ke(this.discardEPB(n.data),this.logger),d.readUByte();let e=0,t=0,i=!1,r=0;for(;!i&&1<d.bytesAvailable;){for(e=0;r=d.readUByte(),e+=r,255===r;);for(t=0;r=d.readUByte(),t+=r,255===r;);if(4===e&&0!==d.bytesAvailable){if(i=!0,181===d.readUByte()&&49===d.readUShort()&&1195456820===d.readUInt()&&3===d.readUByte()){const n=d.readUByte(),s=31&n,o=[n,d.readUByte()];for(c=0;c<s;c++)o.push(d.readUByte()),o.push(d.readUByte()),o.push(d.readUByte());this._insertSampleInOrder(l.captionSamples,{type:3,pts:a.pts,bytes:o})}}else if(t<d.bytesAvailable)for(c=0;c<t;c++)d.readUByte()}break;case 7:if(u=!0,!o.config.sps){d=new Ke(n.data,this.logger);const a=d.readSPS();o.config.width=a.width,o.config.height=a.height,o.config.pixelRatio=a.pixelRatio,o.config.sps=[n.data],o.info.duration=s;const l=n.data.subarray(1,4);let t="avc1.";for(c=0;c<3;c++){let e=l[c].toString(16);e.length<2&&(e="0"+e),t+=e}o.config.codec=t}break;case 8:u=!0,o.config.pps||(o.config.pps=[n.data]);break;case 9:u=!1,this.pushAccesUnit(o,p),h=this._createAVCSample(!1,a.pts,a.dts,""),o.avcSample=h;break;case 12:u=!0;break;default:u=!1}h&&u&&h.units.push(n)}),e&&h&&(this.pushAccesUnit(o,p),o.avcSample=void 0)}_createAVCSample(e,t,i,r){return{id:NaN,key:e,pts:t,dts:i,units:new Array,debug:r}}_insertSampleInOrder(t,i){var r=t.length;if(0<r){if(i.pts>=t[r-1].pts)t.push(i);else for(let e=r-1;0<=e;e--)if(i.pts<t[e].pts){t.splice(e,0,i);break}}else t.push(i)}_getLastNalUnit(){const e=this._avcContext;let t,i=e.avcSample;if(!i||0===i.units.length){const t=e.parsingData.esSamples;i=t[t.length-1]}if(i){const e=i.units;t=e[e.length-1]}return t}_parseAVCNALu(e){const t=e.byteLength;let i,r,n=0;const a=this._avcContext;let s=a.naluState||0;const o=s,l=[];let d,u,c,h=-1;for(-1===s&&(h=0,c=31&e[0],s=0,n=1);n<t;)if(i=e[n++],s)if(1!==s)if(i)if(1===i){if(0<=h)d={data:e.subarray(h,n-s-1),type:c},l.push(d);else{const t=this._getLastNalUnit();if(t&&(o&&n<=4-o&&t.state&&(t.data=t.data.subarray(0,t.data.byteLength-o)),r=n-s-1,0<r)){const i=new Uint8Array(t.data.byteLength+r);i.set(t.data,0),i.set(e.subarray(0,r),t.data.byteLength),t.data=i,t.state=0}}s=n<t?(u=31&e[n],h=n,c=u,0):-1}else s=0;else s=3;else s=i?0:2;else s=i?0:1;if(0<=h&&0<=s&&(d={data:e.subarray(h,t),type:c,state:s},l.push(d)),0===l.length){const t=this._getLastNalUnit();if(t){const i=new Uint8Array(t.data.byteLength+e.byteLength);i.set(t.data,0),i.set(e,t.data.byteLength),t.data=i}}return a.naluState=s,l}discardEPB(e){const t=e.byteLength,i=[];let r=1;for(;r<t-2;)0===e[r]&&0===e[r+1]&&3===e[r+2]?(i.push(r+2),r+=2):r++;if(0===i.length)return e;const n=t-i.length,a=new Uint8Array(n);let s=0;for(r=0;r<n;s++,r++)s===i[0]&&(s++,i.shift()),a[r]=e[s];return a}_parseAACPES(e){const i=this._audioContext,{audioLastPTS:r,audioOverFlow:n,parsingData:{esSamples:a}}=i,s=e.keyTagInfo;let o,l,d=e.data,u=0;if(n){const f=i.overflowMissingBytes||0;i.audioOverFlow=void 0,i.overflowMissingBytes=-1;const o=n.byteLength;if(f<=0){const f=new Uint8Array(o+d.byteLength);f.set(n,0),f.set(d,o),d=f}else if(void 0!==r){const i=o-f;n.set(d.subarray(0,f),i);const l={unit:n,pts:r,dts:r,keyTagInfo:s};a.push(l),u=f}}for(o=u,l=d.length;o<l-1&&(255!==d[o]||240!=(246&d[o+1]));o++);if(o!==u){let e,t;const r=o<l-1;if(t=r?(e=`AAC PES did not start with ADTS header,offset:${o}`,G.PESDidNotStartWithADTS):(e="No ADTS header found in AAC PES",G.NoADTSHeaderInPES),!r){const n=new I(!r,e,t);return void this.observer.trigger(N.INTERNAL_ERROR,n)}}if(!i.config){const f=S(this.observer,d,o,void 0,this.logger);if(!f)throw"unable to parse adts header";i.config=f}var c=9216e4/i.config.samplerate;let h;if(isFinite(e.pts))h=e.pts;else{if(!n||void 0===r||!a.length)return;h=r+c}e=void 0!==r&&a.length?h-(r+c):0;void 0!==r&&1<Math.abs(e)&&(h=r+c);let p=r,m=0;for(;o<l;){let e;const r=1&d[o+1]?7:9;let t;if(o+r<=l){const f=(3&d[o+3])<<11|d[o+4]<<3|(224&d[o+5])>>>5;t=Math.max(0,f-r)}if(!r||!t){e=new Uint8Array(l-o),e.set(d.subarray(o,l),0),i.audioOverFlow=e;break}{p=h+m*c;const N=t+r,u=Math.max(0,o+N-l);if(i.overflowMissingBytes=u){e=new Uint8Array(N-r),e.set(d.subarray(o+r,d.length),0),i.audioOverFlow=e;break}{e=d.subarray(o+r,o+N);const u={unit:e,pts:p,dts:p,keyTagInfo:s};for(a.push(u),i.parsingData.len+=t,m++,o+=N;o<l-1&&(255!==d[o]||240!=(246&d[o+1]));o++);}}}i.audioLastPTS=p}_parseMPEGPES(e){var t;"mp3"===(null===(t=this._audioContext)||void 0===t?void 0:t.segmentCodec)&&le.parse(this._audioContext.parsingData,e.data,0,e.pts,this.logger)}_parseDolbyPES(e){var t;const i=this._audioContext,r=this._duration;let n=e.data,a=e.pts;var s=e.keyTagInfo;let o=0,l=0,d=i.audioOverFlow;e=i.audioLastPTS;if(!i.config){let e;if("ac3"===i.segmentCodec?e=ee(this.observer,n,l,this.logger):"ec3"===i.segmentCodec&&(e=ae.getAudioConfig(this.observer,n,l,this.logger)),!e)throw"unable to parse dolby header";i.config=e}if("ac3"!==i.config.segmentCodec&&"ec3"!==i.config.segmentCodec)throw"unexpected config type";var u=1536/i.config.samplerate*i.info.inputTimescale;if(d){const p=new Uint8Array(d.byteLength+n.byteLength);p.set(d,0),p.set(n,d.byteLength),n=p}var c=n.length;if(d&&e){const p=e+u;1<Math.abs(p-a)&&(a=p)}let h=0;for(;l+h<=c;){if(11!==n[l]||119!==n[l+1]){const p=new I(!0,"invalid dolby audio magic",G.InvalidDolbyAudioMagic);return void this.observer.trigger(N.INTERNAL_ERROR,p)}"ac3"===i.segmentCodec?h=null!==(t=te(this.observer,n,l))&&void 0!==t?t:NaN:"ec3"===i.segmentCodec&&(h=null!==(t=ae.getFrameLength(this.observer,n,l,this.logger))&&void 0!==t?t:NaN);const p=a+o*u;i.audioLastPTS=p;const d={unit:n.subarray(l,l+h),pts:p,dts:p,keyTagInfo:s};i.parsingData.esSamples.push(d),i.info.duration=r,i.parsingData.len+=h,l+=h,o++}d=l<c?n.subarray(l,c):void 0,i.audioOverFlow=d}}var je,Ge=He;class ze extends r{constructor(e,t,i,r){super(),this.typeSupported=e,this.config=t,this.vendor=i,this.logger=r}destroy(){this.removeAllListeners();const e=this.demuxer,t=this.remuxer;e&&e.destroy(),t&&t.destroy()}push(i,r,n,a,s,o,l,d,u,c,h,p){if(i){let e=this.demuxer,t=this.remuxer;var m=new Uint8Array(i);if(!e||!t||(s||o)&&(null===(f=this.probeFn)||void 0===f||!f.call(this,m,this.logger))){const{typeSupported:i,config:r}=this,n=[{demux:$e,remux:Ne},{demux:Ge,remux:Me},{demux:se,remux:Me},{demux:ne,remux:Me},{demux:X,remux:Me},{demux:de,remux:Me}];for(const a of n){const n=a.demux["probe"];if(n(m,this.logger)){t=new a.remux(this,r,i,this.vendor,this.logger),e=new a.demux(this,t,r,i,this.logger),this.probeFn=n;break}}if(!e||!t){const i=new I(!0,"no demux|remux matching with content found",G.DemuxerNotFound);return void this.trigger(N.INTERNAL_ERROR,i)}this.remuxer=t,this.demuxer=e}var f=!this.lastKeyTagInfo||r&&"NONE"!==r.method&&(this.lastKeyTagInfo.uri!==r.uri||this.lastKeyTagInfo.iv!==r.iv);if(this.lastKeyTagInfo=r,(s||o||f)&&(e.resetInitSegment(new Uint8Array(n),d,r,s),t.resetInitSegment()),s){const i=c?E(c):void 0;e.resetTimeStamp(i),t.resetTimeStamp(i)}e.append(m,a,l,u,r,h,p)}}}function We(){let e=`${Date.now()}-${Math.random()}`;return"undefined"!=typeof performance&&"function"==typeof performance.now&&(e+=`-${performance.now()}`),e}class Ye{constructor(e,t){this.rpc=e,this.logger=t,this.init=(t,n,a)=>e=>{const i=We(),r=this.demuxers[i]=new ze(t,n,a,this.logger);[b.INIT_PTS_FOUND,b.FRAG_PARSING_INIT_SEGMENT,b.FRAG_PARSING_DATA,b.FRAG_PARSED,N.INTERNAL_ERROR].forEach(t=>{r.on(t,e=>this.rpc.invoke("demuxer.event",[i,t,e])(()=>{}))}),e(i)},this.push=(i,r,n,a,s,o,l,d,u,c,h,p,m)=>e=>{const t=this.demuxers[i];t?(t.push(r,n,a,s,o,l,d,u,c,h,p,m),e()):e(void 0,`Demuxer with id "${i}" does not exist on push`)},this.destroy=i=>e=>{const t=this.demuxers[i];t?(t.destroy(),delete this.demuxers[i],e()):this.logger.error(`Demuxer with id "${i}" does not exist on destroy`)},this.demuxers={},e.register("demuxer.init",this.init),e.register("demuxer.push",this.push),e.register("demuxer.destroy",this.destroy)}}class Xe{constructor(e){this.worker=e,this.handlers={},this.deferers={},this._messageHandler=e=>{var{type:t,id:i,command:r,args:n,result:e,error:a}=e.data;if(t===je.Invoke)try{if(null==this.handlers[r])throw new Error(`command ${r} not found`);null!=n&&this.handlers[r](...n)(this._respond.bind(this,i,r))}catch(a){this._respond(i,r,null,new Error(`command ${r} not found`))}else t===je.Result&&null!=this.deferers[i]&&(this.deferers[i](e,a),delete this.deferers[i])},e.addEventListener("message",this._messageHandler)}register(e,t){return null==this.handlers[e]&&(this.handlers[e]=t,!0)}unregister(e){return null==this.handlers[e]&&(delete this.handlers[e],!0)}invoke(i,r,n){return(e=Xe._fallbackCallback)=>{var t=We();this.deferers[t]=e;t={type:je.Invoke,id:t,command:i,args:r};this._send(t,n)}}teardown(e){this.worker.removeEventListener("message",this._messageHandler),e()}_respond(e,t,i,r,n){r instanceof Error&&(r=`[${r.name}] ${r.message}\n${r.stack}`);r={type:je.Result,id:e,command:t,result:i,error:r};this._send(r,n)}_send(e,t=[]){this.worker.postMessage(e,t.map(e=>ArrayBuffer.isView(e)?e.buffer:e).filter(e=>void 0!==e))}}Xe._fallbackCallback=(e,t)=>{if(null!=t)throw t},(e=je=je||{})[e.Invoke=0]="Invoke",e[e.Result=1]="Result",ArrayBuffer.isView||(ArrayBuffer.isView=function(e){return null!==e&&"object"==typeof e&&e.buffer instanceof ArrayBuffer}),void 0!==lv&&lv&&(Ls=new Xe(u),xs=(n=>{const t=(i=[])=>{const r={};return["fatal","error","warn","info","debug","trace","qe"].forEach(e=>{return r[e]=(t=e,(...e)=>{n.invoke("logger.log",[i,t,...e])((e,t)=>{if(null!=t)throw t})});var t}),r.child=e=>t([...i,e]),r};return t()})(Ls),new i(Ls,xs),new Ye(Ls,xs));var Je={type:null,entityIds:null,skip:!1,payload:null},Ze=!1;function et(e,t,i){tt(e,t,i),Ze=!0}function tt(e,t,i){!1===Ze&&(Je.type=e,Je.entityIds=t,Je.payload=i)}function it(e,t){return e.hasOwnProperty(t)}function rt(e){return Array.isArray(e)}function nt(e){return e.hasOwnProperty("active")}function at(e){return rt(e)}function st(e){var t,{active:i,ids:r,entities:n}=e;return at(i)?(t=r,(r=(e=i).filter(e=>-1<t.indexOf(e))).length===e.length?e:r):!1===it(n,i)?null:i}function ot(t,e){var i,r=Object.keys(t);return Object.getOwnPropertySymbols&&(i=Object.getOwnPropertySymbols(t),e&&(i=i.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),r.push.apply(r,i)),r}function lt(r){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?ot(Object(n),!0).forEach(function(e){var t,i;t=r,e=n[i=e],i in t?Object.defineProperty(t,i,{value:e,enumerable:!0,configurable:!0,writable:!0}):t[i]=e}):Object.getOwnPropertyDescriptors?Object.defineProperties(r,Object.getOwnPropertyDescriptors(n)):ot(Object(n)).forEach(function(e){Object.defineProperty(r,e,Object.getOwnPropertyDescriptor(n,e))})}return r}function dt(e){e=function(e){if("object"!=typeof e||null===e)return e;var t=e[Symbol.toPrimitive];if(void 0===t)return String(e);e=t.call(e,"string");if("object"!=typeof e)return e;throw new TypeError("@@toPrimitive must return a primitive value.")}(e);return"symbol"==typeof e?e:String(e)}function ut(e){return null==e}function ct(e){return ut(e)?[]:Array.isArray(e)?e:[e]}function ht(e,t,i){i=2<arguments.length&&void 0!==i?i:{},t=ct(t),e=e||[];return i.prepend?[...t,...e]:[...e,...t]}function pt(e){return"function"==typeof e}function mt(t){return function(e){if(pt(null==e?void 0:e.lift))return e.lift(function(e){try{return t(e,this)}catch(e){this.error(e)}});throw new TypeError("Unable to lift unknown Observable type")}}var ft=function(e,t){return(ft=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])})(e,t)};function gt(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function i(){this.constructor=e}ft(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}function yt(e,t,i,r){var n,a=arguments.length,s=a<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;0<=o;o--)(n=e[o])&&(s=(a<3?n(s):3<a?n(t,i,s):n(t,i))||s);return 3<a&&s&&Object.defineProperty(t,i,s),s}function vt(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}function St(i,r){var n,a,s,o={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,a&&(s=2&t[0]?a.return:t[0]?a.throw||((s=a.return)&&s.call(a),0):a.next)&&!(s=s.call(a,t[1])).done)return s;switch(a=0,(t=s?[2&t[0],s.value]:t)[0]){case 0:case 1:s=t;break;case 4:return o.label++,{value:t[1],done:!1};case 5:o.label++,a=t[1],t=[0];continue;case 7:t=o.ops.pop(),o.trys.pop();continue;default:if(!((s=0<(s=o.trys).length&&s[s.length-1])||6!==t[0]&&2!==t[0])){o=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){o.label=t[1];break}if(6===t[0]&&o.label<s[1]){o.label=s[1],s=t;break}if(s&&o.label<s[2]){o.label=s[2],o.ops.push(t);break}s[2]&&o.ops.pop(),o.trys.pop();continue}t=r.call(i,o)}catch(e){t=[6,e],a=0}finally{n=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}}function It(e){var t="function"==typeof Symbol&&Symbol.iterator,i=t&&e[t],r=0;if(i)return i.call(e);if(e&&"number"==typeof e.length)return{next:function(){return{value:(e=e&&r>=e.length?void 0:e)&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function bt(e,t){var i="function"==typeof Symbol&&e[Symbol.iterator];if(!i)return e;var r,n,a=i.call(e),s=[];try{for(;(void 0===t||0<t--)&&!(r=a.next()).done;)s.push(r.value)}catch(e){n={error:e}}finally{try{r&&!r.done&&(i=a.return)&&i.call(a)}finally{if(n)throw n.error}}return s}function Tt(e,t){for(var i=0,r=t.length,n=e.length;i<r;i++,n++)e[n]=t[i];return e}function Et(e){return this instanceof Et?(this.v=e,this):new Et(e)}var At=function(e){return e&&"number"==typeof e.length&&"function"!=typeof e};function Ot(e){return pt(null==e?void 0:e.then)}function wt(e){e=e(function(e){Error.call(e),e.stack=(new Error).stack});return e.prototype=Object.create(Error.prototype),e.prototype.constructor=e}var Rt=wt(function(t){return function(e){t(this),this.message=e?e.length+" errors occurred during unsubscription:\n"+e.map(function(e,t){return t+1+") "+e.toString()}).join("\n  "):"",this.name="UnsubscriptionError",this.errors=e}});function Ct(e,t){!e||0<=(t=e.indexOf(t))&&e.splice(t,1)}var kt=(Pt.prototype.unsubscribe=function(){var e,t,i,r,n;if(!this.closed){this.closed=!0;var a=this._parentage;if(a)if(this._parentage=null,Array.isArray(a))try{for(var s=It(a),o=s.next();!o.done;o=s.next())o.value.remove(this)}catch(t){e={error:t}}finally{try{o&&!o.done&&(t=s.return)&&t.call(s)}finally{if(e)throw e.error}}else a.remove(this);a=this.initialTeardown;if(pt(a))try{a()}catch(e){n=e instanceof Rt?e.errors:[e]}a=this._finalizers;if(a){this._finalizers=null;try{for(var l=It(a),d=l.next();!d.done;d=l.next()){var u=d.value;try{xt(u)}catch(e){n=null!=n?n:[],e instanceof Rt?n=Tt(Tt([],bt(n)),bt(e.errors)):n.push(e)}}}catch(e){i={error:e}}finally{try{d&&!d.done&&(r=l.return)&&r.call(l)}finally{if(i)throw i.error}}}if(n)throw new Rt(n)}},Pt.prototype.add=function(e){var t;if(e&&e!==this)if(this.closed)xt(e);else{if(e instanceof Pt){if(e.closed||e._hasParent(this))return;e._addParent(this)}(this._finalizers=null!==(t=this._finalizers)&&void 0!==t?t:[]).push(e)}},Pt.prototype._hasParent=function(e){var t=this._parentage;return t===e||Array.isArray(t)&&t.includes(e)},Pt.prototype._addParent=function(e){var t=this._parentage;this._parentage=Array.isArray(t)?(t.push(e),t):t?[t,e]:e},Pt.prototype._removeParent=function(e){var t=this._parentage;t===e?this._parentage=null:Array.isArray(t)&&Ct(t,e)},Pt.prototype.remove=function(e){var t=this._finalizers;t&&Ct(t,e),e instanceof Pt&&e._removeParent(this)},Pt.EMPTY=((Ea=new Pt).closed=!0,Ea),Pt),Mt=kt.EMPTY;function Pt(e){this.initialTeardown=e,this.closed=!1,this._parentage=null,this._finalizers=null}function Lt(e){return e instanceof kt||e&&"closed"in e&&pt(e.remove)&&pt(e.add)&&pt(e.unsubscribe)}function xt(e){pt(e)?e():e.unsubscribe()}var Dt,_t,Nt={onUnhandledError:null,onStoppedNotification:null,Promise:void 0,useDeprecatedSynchronousErrorHandling:!1,useDeprecatedNextContext:!1},Ft={setTimeout:(_t=function(e,t){for(var i=[],r=2;r<arguments.length;r++)i[r-2]=arguments[r];var n=Ft.delegate;return null!=n&&n.setTimeout?n.setTimeout.apply(n,Tt([e,t],bt(i))):setTimeout.apply(void 0,Tt([e,t],bt(i)))},Ut.toString=function(){return _t.toString()},Ut),clearTimeout:(Dt=function(e){var t=Ft.delegate;return((null==t?void 0:t.clearTimeout)||clearTimeout)(e)},Bt.toString=function(){return Dt.toString()},Bt),delegate:void 0};function Bt(e){return Dt.apply(this,arguments)}function Ut(e,t){return _t.apply(this,arguments)}function Vt(t){Ft.setTimeout(function(){var e=Nt.onUnhandledError;if(!e)throw t;e(t)})}function $t(){}var Qt=Kt("C",void 0,void 0);function Kt(e,t,i){return{kind:e,value:t,error:i}}var qt=null;function Ht(e){if(Nt.useDeprecatedSynchronousErrorHandling){var t=!qt;if(t&&(qt={errorThrown:!1,error:null}),e(),t){var i=qt,t=i.errorThrown,i=i.error;if(qt=null,t)throw i}}else e()}var jt,Gt=(gt(Wt,jt=kt),Wt.create=function(e,t,i){return new Zt(e,t,i)},Wt.prototype.next=function(e){this.isStopped?ri(Kt("N",e,void 0),this):this._next(e)},Wt.prototype.error=function(e){this.isStopped?ri(Kt("E",void 0,e),this):(this.isStopped=!0,this._error(e))},Wt.prototype.complete=function(){this.isStopped?ri(Qt,this):(this.isStopped=!0,this._complete())},Wt.prototype.unsubscribe=function(){this.closed||(this.isStopped=!0,jt.prototype.unsubscribe.call(this),this.destination=null)},Wt.prototype._next=function(e){this.destination.next(e)},Wt.prototype._error=function(e){try{this.destination.error(e)}finally{this.unsubscribe()}},Wt.prototype._complete=function(){try{this.destination.complete()}finally{this.unsubscribe()}},Wt),zt=Function.prototype.bind;function Wt(e){var t=jt.call(this)||this;return t.isStopped=!1,e?Lt(t.destination=e)&&e.add(t):t.destination=ni,t}function Yt(e,t){return zt.call(e,t)}var Xt,Jt=(ti.prototype.next=function(e){var t=this.partialObserver;if(t.next)try{t.next(e)}catch(e){ii(e)}},ti.prototype.error=function(e){var t=this.partialObserver;if(t.error)try{t.error(e)}catch(e){ii(e)}else ii(e)},ti.prototype.complete=function(){var e=this.partialObserver;if(e.complete)try{e.complete()}catch(e){ii(e)}},ti),Zt=(gt(ei,Xt=Gt),ei);function ei(e,t,i){var r=Xt.call(this)||this,e=pt(e)||!e?{next:null!=e?e:void 0,error:null!=t?t:void 0,complete:null!=i?i:void 0}:r&&Nt.useDeprecatedNextContext?((i=Object.create(e)).unsubscribe=function(){return r.unsubscribe()},{next:e.next&&Yt(e.next,i),error:e.error&&Yt(e.error,i),complete:e.complete&&Yt(e.complete,i)}):e;return r.destination=new Jt(e),r}function ti(e){this.partialObserver=e}function ii(e){Vt(e)}function ri(e,t){var i=Nt.onStoppedNotification;i&&Ft.setTimeout(function(){return i(e,t)})}var ni={closed:!0,next:$t,error:function(e){throw e},complete:$t},ai="function"==typeof Symbol&&Symbol.observable||"@@observable";function si(e){return e}var oi=(li.prototype.lift=function(e){var t=new li;return t.source=this,t.operator=e,t},li.prototype.subscribe=function(e,t,i){var r,n=this,a=(r=e)&&r instanceof Gt||r&&pt(r.next)&&pt(r.error)&&pt(r.complete)&&Lt(r)?e:new Zt(e,t,i);return Ht(function(){var e=n.operator,t=n.source;a.add(e?e.call(a,t):t?n._subscribe(a):n._trySubscribe(a))}),a},li.prototype._trySubscribe=function(t){try{return this._subscribe(t)}catch(e){t.error(e)}},li.prototype.forEach=function(r,e){var n=this;return new(e=di(e))(function(e,t){var i=new Zt({next:function(e){try{r(e)}catch(e){t(e),i.unsubscribe()}},error:t,complete:e});n.subscribe(i)})},li.prototype._subscribe=function(e){var t;return null===(t=this.source)||void 0===t?void 0:t.subscribe(e)},li.prototype[ai]=function(){return this},li.prototype.pipe=function(){for(var t,e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];return(0===(t=e).length?si:1===t.length?t[0]:function(e){return t.reduce(function(e,t){return t(e)},e)})(this)},li.prototype.toPromise=function(e){var r=this;return new(e=di(e))(function(e,t){var i;r.subscribe(function(e){return i=e},function(e){return t(e)},function(){return e(i)})})},li.create=function(e){return new li(e)},li);function li(e){e&&(this._subscribe=e)}function di(e){return null!==(e=null!=e?e:Nt.Promise)&&void 0!==e?e:Promise}function ui(e){return pt(e[ai])}function ci(e){return Symbol.asyncIterator&&pt(null==e?void 0:e[Symbol.asyncIterator])}function hi(e){return new TypeError("You provided "+(null!==e&&"object"==typeof e?"an invalid object":"'"+e+"'")+" where a stream was expected. You can provide an Observable, Promise, ReadableStream, Array, AsyncIterable, or Iterable.")}var pi="function"==typeof Symbol&&Symbol.iterator?Symbol.iterator:"@@iterator";function mi(e){return pt(null==e?void 0:e[pi])}function fi(u){return function(e,t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n=function(){var t,i,r;return St(this,function(e){switch(e.label){case 0:t=u.getReader(),e.label=1;case 1:e.trys.push([1,,9,10]),e.label=2;case 2:return[4,Et(t.read())];case 3:return i=e.sent(),r=i.value,i.done?[4,Et(void 0)]:[3,5];case 4:return[2,e.sent()];case 5:return[4,Et(r)];case 6:return[4,e.sent()];case 7:return e.sent(),[3,2];case 8:return[3,10];case 9:return t.releaseLock(),[7];case 10:return[2]}})}.apply(e,t||[]),a=[],i={};return r("next"),r("throw"),r("return"),i[Symbol.asyncIterator]=function(){return this},i;function r(r){n[r]&&(i[r]=function(i){return new Promise(function(e,t){1<a.push([r,i,e,t])||s(r,i)})})}function s(e,t){try{(i=n[e](t)).value instanceof Et?Promise.resolve(i.value.v).then(o,l):d(a[0][2],i)}catch(e){d(a[0][3],e)}var i}function o(e){s("next",e)}function l(e){s("throw",e)}function d(e,t){e(t),a.shift(),a.length&&s(a[0][0],a[0][1])}}(this,arguments)}function gi(e){return pt(null==e?void 0:e.getReader)}function yi(e){if(e instanceof oi)return e;if(null!=e){if(ui(e))return n=e,new oi(function(e){var t=n[ai]();if(pt(t.subscribe))return t.subscribe(e);throw new TypeError("Provided object does not correctly implement Symbol.observable")});if(At(e))return r=e,new oi(function(e){for(var t=0;t<r.length&&!e.closed;t++)e.next(r[t]);e.complete()});if(Ot(e))return i=e,new oi(function(t){i.then(function(e){t.closed||(t.next(e),t.complete())},function(e){return t.error(e)}).then(null,Vt)});if(ci(e))return vi(e);if(mi(e))return s=e,new oi(function(e){var t,i;try{for(var r=It(s),n=r.next();!n.done;n=r.next()){var a=n.value;if(e.next(a),e.closed)return}}catch(e){t={error:e}}finally{try{n&&!n.done&&(i=r.return)&&i.call(r)}finally{if(t)throw t.error}}e.complete()});if(gi(e))return vi(fi(e))}var s,i,r,n;throw hi(e)}function vi(e){return new oi(function(t){!function(i,r){var n,a,s,o,l,e=this,d=function(){var t;return St(this,function(e){switch(e.label){case 0:e.trys.push([0,5,6,11]),n=function(s){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e,t=s[Symbol.asyncIterator];return t?t.call(s):(s=It(s),e={},i("next"),i("throw"),i("return"),e[Symbol.asyncIterator]=function(){return this},e);function i(a){e[a]=s[a]&&function(n){return new Promise(function(e,t){var i,r;i=e,e=t,r=(n=s[a](n)).done,t=n.value,Promise.resolve(t).then(function(e){i({value:e,done:r})},e)})}}}(i),e.label=1;case 1:return[4,n.next()];case 2:if((a=e.sent()).done)return[3,4];if(t=a.value,r.next(t),r.closed)return[2];e.label=3;case 3:return[3,1];case 4:return[3,11];case 5:return t=e.sent(),s={error:t},[3,11];case 6:return e.trys.push([6,,9,10]),a&&!a.done&&(o=n.return)?[4,o.call(n)]:[3,8];case 7:e.sent(),e.label=8;case 8:return[3,10];case 9:if(s)throw s.error;return[7];case 10:return[7];case 11:return r.complete(),[2]}})};return new((l=void 0)||(l=Promise))(function(i,t){function r(e){try{a(d.next(e))}catch(e){t(e)}}function n(e){try{a(d.throw(e))}catch(e){t(e)}}function a(e){var t;e.done?i(e.value):((t=e.value)instanceof l?t:new l(function(e){e(t)})).then(r,n)}a((d=d.apply(e,[])).next())})}(e,t).catch(function(e){return t.error(e)})})}function Si(e,t,i,r,n){return new wi(e,t,i,r,n)}var Ii,bi,Ti,Ei,Ai,Oi,wi=(gt(Vi,Oi=Gt),Vi.prototype.unsubscribe=function(){var e,t;this.shouldUnsubscribe&&!this.shouldUnsubscribe()||(t=this.closed,Oi.prototype.unsubscribe.call(this),t||null===(e=this.onFinalize)||void 0===e||e.call(this))},Vi),L=(gt(Ui,Ai=kt),Ui.prototype.schedule=function(e,t){return this},Ui),Ri={setInterval:(Ei=function(e,t){for(var i=[],r=2;r<arguments.length;r++)i[r-2]=arguments[r];var n=Ri.delegate;return null!=n&&n.setInterval?n.setInterval.apply(n,Tt([e,t],bt(i))):setInterval.apply(void 0,Tt([e,t],bt(i)))},Bi.toString=function(){return Ei.toString()},Bi),clearInterval:(Ti=function(e){var t=Ri.delegate;return((null==t?void 0:t.clearInterval)||clearInterval)(e)},Fi.toString=function(){return Ti.toString()},Fi),delegate:void 0},Ci=(gt(Ni,bi=L),Ni.prototype.schedule=function(e,t){if(void 0===t&&(t=0),this.closed)return this;this.state=e;var i=this.id,e=this.scheduler;return null!=i&&(this.id=this.recycleAsyncId(e,i,t)),this.pending=!0,this.delay=t,this.id=null!==(i=this.id)&&void 0!==i?i:this.requestAsyncId(e,this.id,t),this},Ni.prototype.requestAsyncId=function(e,t,i){return void 0===i&&(i=0),Ri.setInterval(e.flush.bind(e,this),i)},Ni.prototype.recycleAsyncId=function(e,t,i){if(null!=(i=void 0===i?0:i)&&this.delay===i&&!1===this.pending)return t;null!=t&&Ri.clearInterval(t)},Ni.prototype.execute=function(e,t){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;t=this._execute(e,t);if(t)return t;!1===this.pending&&null!=this.id&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))},Ni.prototype._execute=function(e,t){var i,r=!1;try{this.work(e)}catch(e){r=!0,i=e||new Error("Scheduled action threw falsy error")}if(r)return this.unsubscribe(),i},Ni.prototype.unsubscribe=function(){var e,t,i;this.closed||(e=this.id,i=(t=this.scheduler).actions,this.work=this.state=this.scheduler=null,this.pending=!1,Ct(i,this),null!=e&&(this.id=this.recycleAsyncId(t,e,null)),this.delay=null,bi.prototype.unsubscribe.call(this))},Ni),ki={now:function(){return(ki.delegate||Date).now()},delegate:void 0},Mi=(_i.prototype.schedule=function(e,t,i){return void 0===t&&(t=0),new this.schedulerActionCtor(this,e).schedule(i,t)},_i.now=ki.now,_i),Pi=(gt(Di,Ii=Mi),Di.prototype.flush=function(e){var t,i=this.actions;if(this._active)i.push(e);else{this._active=!0;do{if(t=e.execute(e.state,e.delay))break}while(e=i.shift());if(this._active=!1,t){for(;e=i.shift();)e.unsubscribe();throw t}}},Di),Li=new Pi(Ci),xi=Li;function Di(e,t){t=Ii.call(this,e,t=void 0===t?Mi.now:t)||this;return t.actions=[],t._active=!1,t}function _i(e,t){void 0===t&&(t=_i.now),this.schedulerActionCtor=e,this.now=t}function Ni(e,t){var i=bi.call(this,e,t)||this;return i.scheduler=e,i.work=t,i.pending=!1,i}function Fi(e){return Ti.apply(this,arguments)}function Bi(e,t){return Ei.apply(this,arguments)}function Ui(e,t){return Ai.call(this)||this}function Vi(t,i,e,r,n,a){var s=Oi.call(this,t)||this;return s.onFinalize=n,s.shouldUnsubscribe=a,s._next=i?function(e){try{i(e)}catch(e){t.error(e)}}:Oi.prototype._next,s._error=r?function(e){try{r(e)}catch(e){t.error(e)}finally{this.unsubscribe()}}:Oi.prototype._error,s._complete=e?function(){try{e()}catch(e){t.error(e)}finally{this.unsubscribe()}}:Oi.prototype._complete,s}function $i(e){return e&&pt(e.schedule)}function Qi(e){return e instanceof Date&&!isNaN(e)}function Ki(r,e,n){void 0===r&&(r=0),void 0===n&&(n=xi);var a=-1;return null!=e&&($i(e)?n=e:a=e),new oi(function(e){var t=Qi(r)?+r-n.now():r,i=0;return n.schedule(function(){e.closed||(e.next(i++),0<=a?this.schedule(void 0,a):e.complete())},t=t<0?0:t)})}function qi(e,t){return void 0===t&&(t=Li),l=function(){return Ki(e,t)},mt(function(e,t){function i(){var e;null==s||s.unsubscribe(),s=null,n&&(n=!1,e=a,a=null,t.next(e)),o&&t.complete()}function r(){s=null,o&&t.complete()}var n=!1,a=null,s=null,o=!1;e.subscribe(Si(t,function(e){n=!0,a=e,s||yi(l()).subscribe(s=Si(t,i,r))},function(){o=!0,n&&s&&!s.closed||t.complete()}))});var l}function Hi(e){return e[e.length-1]}function ji(e){return pt(Hi(e))?e.pop():void 0}function Gi(e){return $i(Hi(e))?e.pop():void 0}function zi(e,t,i,r,n){void 0===r&&(r=0),void 0===n&&(n=!1);t=t.schedule(function(){i(),n?e.add(this.schedule(null,r)):this.unsubscribe()},r);if(e.add(t),!n)return t}function Wi(s){return mt(function(t,i){var r,n=null,a=!1,n=t.subscribe(Si(i,void 0,void 0,function(e){r=yi(s(e,Wi(s)(t))),n?(n.unsubscribe(),n=null,r.subscribe(i)):a=!0}));a&&(n.unsubscribe(),n=null,r.subscribe(i))})}var Yi=Array.isArray,Xi=Object.getPrototypeOf,Ji=Object.prototype,Zi=Object.keys;function er(e){if(1===e.length){var t=e[0];if(Yi(t))return{args:t,keys:null};if(t&&"object"==typeof t&&Xi(t)===Ji){var i=Zi(t);return{args:i.map(function(e){return t[e]}),keys:i}}}return{args:e,keys:null}}function tr(i,r){return void 0===r&&(r=0),mt(function(e,t){e.subscribe(Si(t,function(e){return zi(t,i,function(){return t.next(e)},r)},function(){return zi(t,i,function(){return t.complete()},r)},function(e){return zi(t,i,function(){return t.error(e)},r)}))})}function ir(i,r){return void 0===r&&(r=0),mt(function(e,t){t.add(i.schedule(function(){return e.subscribe(t)},r))})}function rr(i,r){if(!i)throw new Error("Iterable cannot be null");return new oi(function(t){zi(t,r,function(){var e=i[Symbol.asyncIterator]();zi(t,r,function(){e.next().then(function(e){e.done?t.complete():t.next(e.value)})},0,!0)})})}function nr(e,t){if(null!=e){if(ui(e))return s=t,yi(e).pipe(ir(s),tr(s));if(At(e))return r=e,n=t,new oi(function(e){var t=0;return n.schedule(function(){t===r.length?e.complete():(e.next(r[t++]),e.closed||this.schedule())})});if(Ot(e))return s=t,yi(e).pipe(ir(s),tr(s));if(ci(e))return rr(e,t);if(mi(e))return i=e,a=t,new oi(function(r){var n;return zi(r,a,function(){n=i[pi](),zi(r,a,function(){var e,t,i;try{t=(e=n.next()).value,i=e.done}catch(e){return void r.error(e)}i?r.complete():r.next(t)},0,!0)}),function(){return pt(null==n?void 0:n.return)&&n.return()}});if(gi(e))return t=t,rr(fi(e),t)}var i,a,r,n,s;throw hi(e)}function ar(e,t){return t?nr(e,t):yi(e)}function sr(r,n){return mt(function(e,t){var i=0;e.subscribe(Si(t,function(e){t.next(r.call(n,e,i++))}))})}var or=Array.isArray;function lr(i){return sr(function(e){return t=i,or(e=e)?t.apply(void 0,Tt([],bt(e))):t(e);var t})}function dr(e,r){return e.reduce(function(e,t,i){return e[t]=r[i],e},{})}function ur(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var i=Gi(e),r=ji(e),n=er(e),a=n.args,s=n.keys;if(0===a.length)return ar([],i);var o,l,d,i=new oi((o=a,l=i,void 0===(d=s?function(e){return dr(s,e)}:si)&&(d=si),function(s){cr(l,function(){for(var e=o.length,r=new Array(e),n=e,a=e,t=0;t<e;t++)!function(i){cr(l,function(){var e=ar(o[i],l),t=!1;e.subscribe(Si(s,function(e){r[i]=e,t||(t=!0,a--),a||s.next(d(r.slice()))},function(){--n||s.complete()}))},s)}(t)},s)}));return r?i.pipe(lr(r)):i}function cr(e,t,i){e?zi(i,e,t):t()}function hr(e,i,r,n,a,s,o,t){function l(e){s&&i.next(e),c++;var t=!1;yi(r(e,h++)).subscribe(Si(i,function(e){null==a||a(e),s?m(e):i.next(e)},function(){t=!0},void 0,function(){if(t)try{c--;for(;u.length&&c<n;)!function(){var e=u.shift();o?zi(i,o,function(){return l(e)}):l(e)}();p()}catch(e){i.error(e)}}))}var d,u=[],c=0,h=0,p=function(){!d||u.length||c||i.complete()},m=function(e){return c<n?l(e):u.push(e)};return e.subscribe(Si(i,m,function(){d=!0,p()})),function(){null==t||t()}}function pr(n,a,i){return void 0===i&&(i=1/0),pt(a)?pr(function(i,r){return sr(function(e,t){return a(i,e,r,t)})(yi(n(i,r)))},i):("number"==typeof a&&(i=a),mt(function(e,t){return hr(e,t,n,i)}))}function mr(s,t,o,l,d){return function(e,i){var r=o,n=t,a=0;e.subscribe(Si(i,function(e){var t=a++;n=r?s(n,e,t):(r=!0,e),l&&i.next(n)},d&&function(){r&&i.next(n),i.complete()}))}}function fr(e,t){return mt(mr(e,t,2<=arguments.length,!1,!0))}var gr=Array.isArray;function yr(e){return 1===e.length&&gr(e[0])?e[0]:e}function vr(e){return pr(si,e=void 0===e?1/0:e)}function Sr(e,t){return pt(t)?pr(e,t,1):pr(e,1)}var Ir,br,Tr=wt(function(e){return function(){e(this),this.name="ObjectUnsubscribedError",this.message="object unsubscribed"}}),Er=(gt(wr,br=oi),wr.prototype.lift=function(e){var t=new Ar(this,this);return t.operator=e,t},wr.prototype._throwIfClosed=function(){if(this.closed)throw new Tr},wr.prototype.next=function(n){var a=this;Ht(function(){var t,e;if(a._throwIfClosed(),!a.isStopped){a.currentObservers||(a.currentObservers=Array.from(a.observers));try{for(var i=It(a.currentObservers),r=i.next();!r.done;r=i.next())r.value.next(n)}catch(e){t={error:e}}finally{try{r&&!r.done&&(e=i.return)&&e.call(i)}finally{if(t)throw t.error}}}})},wr.prototype.error=function(t){var i=this;Ht(function(){if(i._throwIfClosed(),!i.isStopped){i.hasError=i.isStopped=!0,i.thrownError=t;for(var e=i.observers;e.length;)e.shift().error(t)}})},wr.prototype.complete=function(){var t=this;Ht(function(){if(t._throwIfClosed(),!t.isStopped){t.isStopped=!0;for(var e=t.observers;e.length;)e.shift().complete()}})},wr.prototype.unsubscribe=function(){this.isStopped=this.closed=!0,this.observers=this.currentObservers=null},Object.defineProperty(wr.prototype,"observed",{get:function(){var e;return 0<(null===(e=this.observers)||void 0===e?void 0:e.length)},enumerable:!1,configurable:!0}),wr.prototype._trySubscribe=function(e){return this._throwIfClosed(),br.prototype._trySubscribe.call(this,e)},wr.prototype._subscribe=function(e){return this._throwIfClosed(),this._checkFinalizedStatuses(e),this._innerSubscribe(e)},wr.prototype._innerSubscribe=function(e){var t=this,i=this,r=i.hasError,n=i.isStopped,a=i.observers;return r||n?Mt:(this.currentObservers=null,a.push(e),new kt(function(){t.currentObservers=null,Ct(a,e)}))},wr.prototype._checkFinalizedStatuses=function(e){var t=this,i=t.hasError,r=t.thrownError,t=t.isStopped;i?e.error(r):t&&e.complete()},wr.prototype.asObservable=function(){var e=new oi;return e.source=this,e},wr.create=function(e,t){return new Ar(e,t)},wr),Ar=(gt(Or,Ir=Er),Or.prototype.next=function(e){var t,i;null===(i=null===(t=this.destination)||void 0===t?void 0:t.next)||void 0===i||i.call(t,e)},Or.prototype.error=function(e){var t,i;null===(i=null===(t=this.destination)||void 0===t?void 0:t.error)||void 0===i||i.call(t,e)},Or.prototype.complete=function(){var e,t;null===(t=null===(e=this.destination)||void 0===e?void 0:e.complete)||void 0===t||t.call(e)},Or.prototype._subscribe=function(e){var t;return null!==(e=null===(t=this.source)||void 0===t?void 0:t.subscribe(e))&&void 0!==e?e:Mt},Or);function Or(e,t){var i=Ir.call(this)||this;return i.destination=e,i.source=t,i}function wr(){var e=br.call(this)||this;return e.closed=!1,e.currentObservers=null,e.observers=[],e.isStopped=!1,e.hasError=!1,e.thrownError=null,e}function Rr(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return vr(1)(ar(e,Gi(e)))}var Cr=new oi(function(e){return e.complete()});function kr(r){return r<=0?function(){return Cr}:mt(function(e,t){var i=0;e.subscribe(Si(t,function(e){++i<=r&&(t.next(e),r<=i&&t.complete())}))})}function Mr(e){return sr(function(){return e})}function Pr(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return ar(e,Gi(e))}function Lr(e,t){function i(e){return e.error(r())}var r=pt(e)?e:function(){return e};return new oi(t?function(e){return t.schedule(i,0,e)}:i)}function xr(a,s){return void 0===s&&(s=si),a=null!=a?a:Dr,mt(function(e,i){var r,n=!0;e.subscribe(Si(i,function(e){var t=s(e);!n&&a(r,t)||(n=!1,r=t,i.next(e))}))})}function Dr(e,t){return e===t}function _r(r,n){return mt(function(e,t){var i=0;e.subscribe(Si(t,function(e){return r.call(n,e,i++)&&t.next(e)}))})}function Nr(a,n){return n?function(e){return e.pipe(Nr(function(i,r){return yi(a(i,r)).pipe(sr(function(e,t){return n(i,e,r,t)}))}))}:mt(function(e,t){var i=0,r=null,n=!1;e.subscribe(Si(t,function(e){r||(r=Si(t,void 0,function(){r=null,n&&t.complete()}),yi(a(e,i++)).subscribe(r))},function(){n=!0,r||t.complete()}))})}function Fr(i,r,n){return r=((r=void 0===r?1/0:r)||0)<1?1/0:r,mt(function(e,t){return hr(e,t,i,r,void 0,!0,n)})}function Br(i){return mt(function(e,t){try{e.subscribe(t)}finally{t.add(i)}})}function Ur(t){return t<=0?function(){return Cr}:mt(function(e,a){var s=[];e.subscribe(Si(a,function(e){s.push(e),t<s.length&&s.shift()},function(){var e,t;try{for(var i=It(s),r=i.next();!r.done;r=i.next()){var n=r.value;a.next(n)}}catch(t){e={error:t}}finally{try{r&&!r.done&&(t=i.return)&&t.call(i)}finally{if(e)throw e.error}}a.complete()},void 0,function(){s=null}))})}function Vr(){return mt(function(e,i){var r,n=!1;e.subscribe(Si(i,function(e){var t=r;r=e,n&&i.next([t,e]),n=!0}))})}var $r,Qr,Kr,qr=(gt(Wr,Kr=Er),Object.defineProperty(Wr.prototype,"value",{get:function(){return this.getValue()},enumerable:!1,configurable:!0}),Wr.prototype._subscribe=function(e){var t=Kr.prototype._subscribe.call(this,e);return t.closed||e.next(this._value),t},Wr.prototype.getValue=function(){var e=this.hasError,t=this.thrownError,i=this._value;if(e)throw t;return this._throwIfClosed(),i},Wr.prototype.next=function(e){Kr.prototype.next.call(this,this._value=e)},Wr),Hr=(gt(zr,Qr=Er),zr.prototype._checkFinalizedStatuses=function(e){var t=this,i=t.hasError,r=t._hasValue,n=t._value,a=t.thrownError,s=t.isStopped,t=t._isComplete;i?e.error(a):(s||t)&&(r&&e.next(n),e.complete())},zr.prototype.next=function(e){this.isStopped||(this._value=e,this._hasValue=!0)},zr.prototype.complete=function(){var e=this._hasValue,t=this._value;this._isComplete||(this._isComplete=!0,e&&Qr.prototype.next.call(this,t),Qr.prototype.complete.call(this))},zr),jr=(gt(Gr,$r=Er),Gr.prototype.next=function(e){var t=this,i=t.isStopped,r=t._buffer,n=t._infiniteTimeWindow,a=t._timestampProvider,t=t._windowTime;i||(r.push(e),n||r.push(a.now()+t)),this._trimBuffer(),$r.prototype.next.call(this,e)},Gr.prototype._subscribe=function(e){this._throwIfClosed(),this._trimBuffer();for(var t=this._innerSubscribe(e),i=this._infiniteTimeWindow,r=this._buffer.slice(),n=0;n<r.length&&!e.closed;n+=i?1:2)e.next(r[n]);return this._checkFinalizedStatuses(e),t},Gr.prototype._trimBuffer=function(){var e=this._bufferSize,t=this._timestampProvider,i=this._buffer,r=this._infiniteTimeWindow,n=(r?1:2)*e;if(e<1/0&&n<i.length&&i.splice(0,i.length-n),!r){for(var a=t.now(),s=0,o=1;o<i.length&&i[o]<=a;o+=2)s=o;s&&i.splice(0,s+1)}},Gr);function Gr(e,t,i){void 0===e&&(e=1/0),void 0===t&&(t=1/0),void 0===i&&(i=ki);var r=$r.call(this)||this;return r._bufferSize=e,r._windowTime=t,r._timestampProvider=i,r._buffer=[],r._infiniteTimeWindow=!0,r._infiniteTimeWindow=t===1/0,r._bufferSize=Math.max(1,e),r._windowTime=Math.max(1,t),r}function zr(){var e=null!==Qr&&Qr.apply(this,arguments)||this;return e._value=null,e._hasValue=!1,e._isComplete=!1,e}function Wr(e){var t=Kr.call(this)||this;return t._value=e,t}function Yr(){for(var t,e=[],i=0;i<arguments.length;i++)e[i]=arguments[i];return 1===(e=yr(e)).length?yi(e[0]):new oi((t=e,function(r){for(var n=[],e=0;n&&!r.closed&&e<t.length;e++)!function(i){n.push(yi(t[i]).subscribe(Si(r,function(e){if(n){for(var t=0;t<n.length;t++)t!==i&&n[t].unsubscribe();n=null}r.next(e)})))}(e)}))}function Xr(e){var e=(t=(e=void 0===e?1/0:e)&&"object"==typeof e?e:{count:e}).count,d=void 0===e?1/0:e,u=t.delay,t=t.resetOnSuccess,i=void 0!==t&&t;return d<=0?si:mt(function(e,s){var o,l=0;!function n(){var a=!1;o=e.subscribe(Si(s,function(e){i&&(l=0),s.next(e)},void 0,function(e){var t,i,r;l++<d?(t=function(){o?(o.unsubscribe(),o=null,n()):a=!0},null!=u?(i="number"==typeof u?Ki(u):yi(u(e,l)),r=Si(s,function(){r.unsubscribe(),t()},function(){s.complete()}),i.subscribe(r)):t()):s.error(e)})),a&&(o.unsubscribe(),o=null,n())}()})}function Jr(s){return mt(function(e,i){var r,n,a=!1;!function t(){r=e.subscribe(Si(i,void 0,void 0,function(e){n||(n=new Er,s(n).subscribe(Si(i,function(){return r?t():a=!0}))),n&&n.next(e)})),a&&(r.unsubscribe(),r=null,a=!1,t())}()})}function Zr(e,t){return Ki(e=(e=void 0===e?0:e)<0?0:e,e,t=void 0===t?Li:t)}function en(e,t){return mt(mr(e,t,2<=arguments.length,!0))}function tn(e){var t=(e=void 0===e?{}:e).connector,h=void 0===t?function(){return new Er}:t,t=e.resetOnError,p=void 0===t||t,t=e.resetOnComplete,m=void 0===t||t,e=e.resetOnRefCountZero,f=void 0===e||e;return function(e){function r(){var e=n;c(),null==e||e.unsubscribe()}var n,a,s,o=0,l=!1,d=!1,u=function(){null==a||a.unsubscribe(),a=void 0},c=function(){u(),n=s=void 0,l=d=!1};return mt(function(e,t){o++,d||l||u();var i=s=null!=s?s:h();t.add(function(){0!=--o||d||l||(a=rn(r,f))}),i.subscribe(t),!n&&0<o&&(n=new Zt({next:function(e){return i.next(e)},error:function(e){d=!0,u(),a=rn(c,p,e),i.error(e)},complete:function(){l=!0,u(),a=rn(c,m),i.complete()}}),yi(e).subscribe(n))})(e)}}function rn(e,t){for(var i=[],r=2;r<arguments.length;r++)i[r-2]=arguments[r];if(!0!==t){if(!1!==t){var n=new Zt({next:function(){n.unsubscribe(),e()}});return t.apply(void 0,Tt([],bt(i))).subscribe(n)}}else e()}function nn(e,t,i){var r,n,a=!1;return e&&"object"==typeof e?(r=e.bufferSize,n=void 0===r?1/0:r,r=e.windowTime,t=void 0===r?1/0:r,a=void 0!==(r=e.refCount)&&r,i=e.scheduler):n=null!=e?e:1/0,tn({connector:function(){return new jr(n,t,i)},resetOnError:!0,resetOnComplete:!1,resetOnRefCountZero:a})}function an(i){return _r(function(e,t){return i<=t})}function sn(){for(var i=[],e=0;e<arguments.length;e++)i[e]=arguments[e];var r=Gi(i);return mt(function(e,t){(r?Rr(i,e,r):Rr(i,e)).subscribe(t)})}function on(l,d){return mt(function(e,n){function a(){return t&&!s&&n.complete()}var s=null,o=0,t=!1;e.subscribe(Si(n,function(t){null==s||s.unsubscribe();var i=0,r=o++;yi(l(t,r)).subscribe(s=Si(n,function(e){return n.next(d?d(t,e,r,i++):e)},function(){s=null,a()}))},function(){t=!0,a()}))})}function ln(e,t){return pt(t)?on(function(){return e},t):on(function(){return e})}function dn(i){return mt(function(e,t){yi(i).subscribe(Si(t,function(){return t.complete()},$t)),t.closed||e.subscribe(t)})}function un(n,a){return void 0===a&&(a=!1),mt(function(e,i){var r=0;e.subscribe(Si(i,function(e){var t=n(e,r++);(t||a)&&i.next(e),t||i.complete()}))})}function cn(e,t,i){var n=pt(e)||t||i?{next:e,error:t,complete:i}:e;return n?mt(function(e,i){var t;null===(t=n.subscribe)||void 0===t||t.call(n);var r=!0;e.subscribe(Si(i,function(e){var t;null===(t=n.next)||void 0===t||t.call(n,e),i.next(e)},function(){var e;r=!1,null===(e=n.complete)||void 0===e||e.call(n),i.complete()},function(e){var t;r=!1,null===(t=n.error)||void 0===t||t.call(n,e),i.error(e)},function(){var e;r&&(null===(e=n.unsubscribe)||void 0===e||e.call(n)),null===(e=n.finalize)||void 0===e||e.call(n)}))}):si}var hn={leading:!0,trailing:!1};function pn(e,t,i){void 0===i&&(i=hn);var h,p=Ki(e,t=void 0===t?Li:t);return void 0===(h=i)&&(h=hn),mt(function(e,t){function i(){var e;a&&(a=!1,e=s,s=null,t.next(e),l||c())}var r=h.leading,n=h.trailing,a=!1,s=null,o=null,l=!1,d=function(){null==o||o.unsubscribe(),o=null,n&&(i(),l&&t.complete())},u=function(){o=null,l&&t.complete()},c=function(e){return o=yi(p).subscribe(Si(t,d,u))};e.subscribe(Si(t,function(e){a=!0,s=e,o&&!o.closed||(r?i:c)()},function(){l=!0,n&&a&&o&&!o.closed||t.complete()}))})}var mn=wt(function(t){return function(e){void 0===e&&(e=null),t(this),this.message="Timeout has occurred",this.name="TimeoutError",this.info=e}});function fn(e,t){var i=Qi(e)?{first:e}:"number"==typeof e?{each:e}:e,o=i.first,l=i.each,e=i.with,d=void 0===e?gn:e,e=i.scheduler,u=void 0===e?null!=t?t:Li:e,i=i.meta,c=void 0===i?null:i;if(null==o&&null==l)throw new TypeError("No timeout provided.");return mt(function(e,t){function i(e){r=zi(t,u,function(){try{s.unsubscribe(),yi(d({meta:c,lastValue:n,seen:a})).subscribe(t)}catch(e){t.error(e)}},e)}var r,n=null,a=0,s=e.subscribe(Si(t,function(e){null==r||r.unsubscribe(),a++,t.next(n=e),0<l&&i(l)},void 0,void 0,function(){null!=r&&r.closed||null==r||r.unsubscribe(),n=null}));a||i(null!=o?"number"==typeof o?o:+o-u.now():l)})}function gn(e){throw new mn(e)}function yn(){for(var o=[],e=0;e<arguments.length;e++)o[e]=arguments[e];var l=ji(o);return mt(function(e,i){for(var t=o.length,r=new Array(t),n=o.map(function(){return!1}),a=!1,s=0;s<t;s++)!function(t){yi(o[t]).subscribe(Si(i,function(e){r[t]=e,a||n[t]||(n[t]=!0,(a=n.every(si))&&(n=null))},$t))}(s);e.subscribe(Si(i,function(e){a&&(e=Tt([e],bt(r)),i.next(l?l.apply(void 0,Tt([],bt(e))):e))}))})}var vn="id";function Sn(e){return rt(e)&&0===e.length}function In(e){return"function"==typeof e}function bn(){return xr((i,e)=>i===e||!(!rt(i)||!rt(e))&&(!(!Sn(i)||!Sn(e))||i.length===e.length&&!1===e.some((e,t)=>i[t]!==e)))}function Tn(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)}function En(e,t,i){var r,n,a=2<arguments.length&&void 0!==i?i:vn,t=In(t)?(n=t,function(){return!n(...arguments)}):(r=ct(t),e=>!1===r.includes(Tn(e)?e[a]:e));if(Array.isArray(e))return e.filter(t)}function An(e,t,i,r){var n,a,s=3<arguments.length&&void 0!==r?r:vn;return a=In(t)?t:(n=ct(t),e=>!0===n.includes(Tn(e)?e[s]:e)),e.map((e,t)=>!0===a(e,t)?Tn(e)?lt(lt({},e),i):i:e)}var On,wn,Rn=(gt(Mn,wn=Ci),Mn.prototype.schedule=function(e,t){return 0<(t=void 0===t?0:t)?wn.prototype.schedule.call(this,e,t):(this.delay=t,this.state=e,this.scheduler.flush(this),this)},Mn.prototype.execute=function(e,t){return 0<t||this.closed?wn.prototype.execute.call(this,e,t):this._execute(e,t)},Mn.prototype.requestAsyncId=function(e,t,i){return null!=(i=void 0===i?0:i)&&0<i||null==i&&0<this.delay?wn.prototype.requestAsyncId.call(this,e,t,i):(e.flush(this),0)},Mn),Cn=new(gt(kn,On=Pi),kn)(Rn);function kn(){return null!==On&&On.apply(this,arguments)||this}function Mn(e,t){var i=wn.call(this,e,t)||this;return i.scheduler=e,i.work=t,i}function Pn(t){return new oi(function(e){yi(t()).subscribe(e)})}function Ln(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var i=ji(e),r=er(e),s=r.args,o=r.keys,r=new oi(function(e){var t=s.length;if(t)for(var r=new Array(t),n=t,a=t,i=0;i<t;i++)!function(t){var i=!1;yi(s[t]).subscribe(Si(e,function(e){i||(i=!0,a--),r[t]=e},function(){return n--},void 0,function(){n&&i||(a||e.next(o?dr(o,r):r),e.complete())}))}(i);else e.complete()});return i?r.pipe(lr(i)):r}var xn=["addListener","removeListener"],Dn=["addEventListener","removeEventListener"],_n=["on","off"];function Nn(i,r,n,e){if(pt(n)&&(e=n,n=void 0),e)return Nn(i,r,n).pipe(lr(e));var e=bt(pt(i.addEventListener)&&pt(i.removeEventListener)?Dn.map(function(t){return function(e){return i[t](r,e,n)}}):pt(i.addListener)&&pt(i.removeListener)?xn.map(Fn(i,r)):pt(i.on)&&pt(i.off)?_n.map(Fn(i,r)):[],2),t=e[0],a=e[1];if(!t&&At(i))return pr(function(e){return Nn(e,r,n)})(yi(i));if(!t)throw new TypeError("Invalid event target");return new oi(function(i){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return i.next(1<e.length?e:e[0])}return t(e),function(){return a(e)}})}function Fn(i,r){return function(t){return function(e){return i[t](r,e)}}}function Bn(r,n,e){return e?Bn(r,n).pipe(lr(e)):new oi(function(i){function e(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return i.next(1===e.length?e[0]:e)}var t=r(e);return pt(n)?function(){return n(e,t)}:void 0})}function Un(e,t,i){return Pn(function(){return e()?t:i})}function Vn(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var i,r=Gi(e),n="number"==typeof Hi(i=e)?i.pop():1/0,i=e;return i.length?1===i.length?yi(i[0]):vr(n)(ar(i,r)):Cr}var $n=new oi($t);function Qn(e){return ur(e).pipe(qi(0))}var Kn={resettable:!1,ttl:null,producerFn:void 0};function qn(e){return!1===ut(e)}var Hn,jn,Gn=new Er,zn=new jr(50,5e3),Wn=new Er,Yn="undefined"!=typeof window,Xn={},Jn={};Yn&&(window.$$stores=Xn,window.$$queries=Jn),(e=Hn=Hn||{}).ASC="asc",e.DESC="desc",(Ls=jn=jn||{}).Set="Set",Ls.Add="Add",Ls.Update="Update",Ls.Remove="Remove";var Zn=!0;function ea(e){return void 0===e}function ta(e,t){var i,r={};for(i of Object.keys(e))r[i]=t(e[i]);return r}function ia(t){Object.freeze(t);var i="function"==typeof t,r=Object.prototype.hasOwnProperty;return Object.getOwnPropertyNames(t).forEach(function(e){!r.call(t,e)||i&&("caller"===e||"callee"===e||"arguments"===e)||null===t[e]||"object"!=typeof t[e]&&"function"!=typeof t[e]||Object.isFrozen(t[e])||ia(t[e])}),t}function ra(e){return null!=e&&"false"!=="".concat(e)}function na(e){return ra(e)&&"Object"===e.constructor.name}var aa=new Er,sa=new qr(!1),oa={activeTransactions:0,batchTransaction:null};function la(){return 0<oa.activeTransactions}function da(e,t){t=1<arguments.length&&void 0!==t?t:void 0;la()||(oa.batchTransaction=new Er),oa.activeTransactions++,sa.next(!0);try{return e.apply(t)}finally{et("@Transaction"),0==--oa.activeTransactions&&(oa.batchTransaction.next(!0),oa.batchTransaction.complete(),sa.next(!1),aa.next(!0))}}function ua(){return function(e,t,i){var r=i.value;return i.value=function(){for(var e=arguments.length,t=new Array(e),i=0;i<e;i++)t[i]=arguments[i];return da(()=>r.apply(this,t),this)},i}}function ca(t){return function(e){return e.pipe(cn(e=>da(()=>t(e))))}}class ha{constructor(e){this.options=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},this.inTransaction=!1,this.cache={active:new qr(!1),ttl:null},this.onInit(e)}setLoading(){var t=0<arguments.length&&void 0!==arguments[0]&&arguments[0];t!==this._value().loading&&(Zn&&tt("Set Loading"),this._setState(e=>lt(lt({},e),{},{loading:t})))}setHasCache(e){var t,i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{restartTTL:!1};e!==this.cache.active.value&&this.cache.active.next(e),i.restartTTL&&(t=this.getCacheTTL())&&(null!==this.cache.ttl&&clearTimeout(this.cache.ttl),this.cache.ttl=setTimeout(()=>this.setHasCache(!1),t))}getValue(){return this.storeValue}setError(t){t!==this._value().error&&(Zn&&tt("Set Error"),this._setState(e=>lt(lt({},e),{},{error:t})))}_select(t){return this.store.asObservable().pipe(sr(e=>t(e.state)),xr())}_value(){return this.storeValue}_cache(){return this.cache.active}get config(){return this.constructor.akitaConfig||{}}get storeName(){return this.config.storeName||this.options.storeName||this.options.name}get deepFreeze(){return this.config.deepFreezeFn||this.options.deepFreezeFn||ia}get cacheConfig(){return this.config.cache||this.options.cache}get _producerFn(){return this.config.producerFn||this.options.producerFn||Kn.producerFn}get resettable(){return(qn(this.config.resettable)?this.config:this.options).resettable}_setState(e){var t,i=!(1<arguments.length&&void 0!==arguments[1])||arguments[1];if(In(e)?(t=e(this._value()),this.storeValue=Zn?this.deepFreeze(t):t):this.storeValue=e,!this.store)return this.store=new qr({state:this.storeValue}),void(Zn&&this.store.subscribe(e=>{var t=e["action"];t&&(e=this.storeName,Wn.next({storeName:e,action:t}))}));la()?this.handleTransaction():this.dispatch(this.storeValue,i)}reset(){this.isResettable()&&(Zn&&tt("Reset"),this._setState(()=>Object.assign({},this._initialState)),this.setHasCache(!1))}update(e){Zn&&tt("Update");var t=this._value(),e=In(e)?In(this._producerFn)?this._producerFn(t,e):e(t):e,e=this.akitaPreUpdate(t,lt(lt({},t),e)),e=na(t)?e:new t.constructor(e);this._setState(e)}updateStoreConfig(e){this.options=lt(lt({},this.options),e)}akitaPreUpdate(e,t){return t}destroy(){var e;Yn&&window.hmrEnabled||this!==Xn[this.storeName]||(delete Xn[this.storeName],e=this.storeName,Gn.next(e),this.setHasCache(!1),this.cache.active.complete(),this.store.complete())}onInit(e){var t,i;(Xn[this.storeName]=this)._setState(()=>e),i=this.storeName,zn.next(i),this.isResettable()&&(this._initialState=e),Zn&&(t=this.storeName,i=this.constructor.name,t||console.error("@StoreConfig({ name }) is missing in ".concat(i)))}dispatch(e){var t=void 0;1<arguments.length&&void 0!==arguments[1]&&!arguments[1]||(t=Je,Ze=!1),this.store.next({state:e,action:t})}watchTransaction(){(oa.batchTransaction?oa.batchTransaction.asObservable():Pr(!0)).subscribe(()=>{this.inTransaction=!1,this.dispatch(this._value())})}isResettable(){return!1!==this.resettable&&(this.resettable||Kn.resettable)}handleTransaction(){this.inTransaction||(this.watchTransaction(),this.inTransaction=!0)}getCacheTTL(){return this.cacheConfig&&this.cacheConfig.ttl||Kn.ttl}}class pa extends ha{constructor(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};super(lt(lt({},{entities:{},ids:[],loading:!0,error:null}),e),t),this.options=t,this.entityActions=new Er,this.entityIdChanges=new Er}get selectEntityAction$(){return this.entityActions.asObservable()}get selectEntityIdChanges$(){return this.entityIdChanges.asObservable()}get idKey(){return this.config.idKey||this.options.idKey||vn}set(t){var i,r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};ut(t)||(Zn&&tt("Set Entity"),i=this.akitaPreAddEntity===pa.prototype.akitaPreAddEntity,this.setHasCache(!0,{restartTTL:!0}),this._setState(e=>{e=function(e){var t,{state:i,entities:a,idKey:r,preAddEntity:n,isNativePreAdd:e}=e;n=rt(a)?(t=(r=function(e,t){var i,r={entities:{},ids:[]};for(i of a){var n=t(i);r.entities[n[e]]=n,r.ids.push(n[e])}return r}(r,n)).entities,r.ids):a.entities&&a.ids?(t=e?a.entities:ta(a.entities,n),a.ids):(t=e?a:ta(a,n),Object.keys(t).map(e=>isNaN(e)?e:Number(e)));n=lt(lt({},i),{},{entities:t,ids:n,loading:!1});return nt(i)&&(n.active=st(n)),n}({state:e,entities:t,idKey:this.idKey,preAddEntity:this.akitaPreAddEntity.bind(this),isNativePreAdd:i});return!1===ea(r.activeId)&&(e.active=r.activeId),e}),this.hasInitialUIState()&&this.handleUICreation(),this.entityActions.next({type:jn.Set,ids:this.ids}))}add(e){var t,i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{loading:!1},e=ct(e);Sn(e)||(t=function(e){var t,i,r,{state:n,entities:e,idKey:a,options:s={},preAddEntity:o}=e,l={},d=[],u=!1;for(t of e)!1===it(n.entities,t[a])&&(l[r=(i=o(t))[a]]=i,s.prepend?d.unshift(r):d.push(r),u=!0);return u?{newState:lt(lt({},n),{},{entities:lt(lt({},n.entities),l),ids:s.prepend?[...d,...n.ids]:[...n.ids,...d]}),newIds:d}:null}({state:this._value(),preAddEntity:this.akitaPreAddEntity.bind(this),entities:e,idKey:this.idKey,options:i}))&&(Zn&&tt("Add Entity"),t.newState.loading=i.loading,this._setState(()=>t.newState),this.hasInitialUIState()&&this.handleUICreation(!0),this.entityActions.next({type:jn.Add,ids:t.newIds}))}update(t,i){var r,n;ea(i)?super.update(t):Sn(n=In(t)?this.ids.filter(e=>t(this.entities[e])):ut(t)?this.ids:ct(t))||(Zn&&tt("Update Entity",n),this._setState(e=>function(e){var t,i,r,n,a,{state:s,ids:o,idKey:l,newStateOrFn:d,preUpdateEntity:u,producerFn:c,onEntityIdChanges:h}=e,p={},m=!1;for(t of o)!1!==it(s.entities,t)&&(i=s.entities[t],r=void 0,a=(r=In(d)?In(c)?c(i,d):d(i):d).hasOwnProperty(l)&&r[l]!==i[l],n=t,a&&(m=!0,n=r[l]),a=lt(lt({},i),r),a=na(i)?a:new(na(r)?i:r).constructor(a),p[n]=u(i,a));var f,g=s.ids,e=s.entities;return m&&([f]=o,e=function(e,t){if(null==e)return{};var i,r=function(e,t){if(null==e)return{};for(var i,r={},n=Object.keys(e),a=0;a<n.length;a++)i=n[a],0<=t.indexOf(i)||(r[i]=e[i]);return r}(e,t);if(Object.getOwnPropertySymbols)for(var n=Object.getOwnPropertySymbols(e),a=0;a<n.length;a++)i=n[a],0<=t.indexOf(i)||Object.prototype.propertyIsEnumerable.call(e,i)&&(r[i]=e[i]);return r}(s.entities,[f].map(dt)),g=s.ids.map(e=>e===f?n:e),h(f,n)),lt(lt({},s),{},{entities:lt(lt({},e),p),ids:g})}({idKey:this.idKey,ids:n,preUpdateEntity:this.akitaPreUpdateEntity.bind(this),state:e,newStateOrFn:i,producerFn:this._producerFn,onEntityIdChanges:(e,t)=>{r={oldId:e,newId:t},this.entityIdChanges.next(lt(lt({},r),{},{pending:!0}))}})),r&&this.entityIdChanges.next(lt(lt({},r),{},{pending:!1})),this.entityActions.next({type:jn.Update,ids:n}))}upsert(e,i,r){var t=3<arguments.length&&void 0!==arguments[3]?arguments[3]:{},n=ct(e),e=t=>e=>it(this.entities,e)===t,a=In(r)?t.baseClass:r?r.baseClass:void 0,s=In(a),t=n.filter(e(!0)),e=n.filter(e(!1)).map(e=>{var t="function"==typeof i?i({}):i,e=lt(lt({},In(r)?r(e,t):t),{},{[this.idKey]:e});return s?new a(e):e});this.update(t,i),this.add(e),Zn&&et("Upsert Entity")}upsertMany(e){var t,i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},r=[],n=[],a={};for(t of e){var s,o,l=this.akitaPreCheckEntity(t),d=l[this.idKey];it(this.entities,d)?(s=this._value().entities[d],o=lt(lt({},this._value().entities[d]),l),o=i.baseClass?new i.baseClass(o):o,o=(s=this.akitaPreUpdateEntity(s,o))[this.idKey],a[o]=s,n.push(o)):(o=i.baseClass?new i.baseClass(l):l,o=(l=this.akitaPreAddEntity(o))[this.idKey],r.push(o),a[o]=l)}Zn&&et("Upsert Many"),this._setState(e=>lt(lt({},e),{},{ids:r.length?[...e.ids,...r]:e.ids,entities:lt(lt({},e.entities),a),loading:!!i.loading})),n.length&&this.entityActions.next({type:jn.Update,ids:n}),r.length&&this.entityActions.next({type:jn.Add,ids:r}),r.length&&this.hasUIStore()&&this.handleUICreation(!0)}replace(e,t){var i=ct(e);if(!Sn(i)){var r,n={};for(r of i)n[r]=lt(lt({},t),{},{[this.idKey]:r});Zn&&tt("Replace Entity",e),this._setState(e=>lt(lt({},e),{},{entities:lt(lt({},e.entities),n)}))}}move(e,t){var i=this.ids.slice();i.splice(t<0?i.length+t:t,0,i.splice(e,1)[0]),Zn&&tt("Move Entity"),this._setState(e=>lt(lt({},e),{},{entities:lt({},e.entities),ids:i}))}remove(t){var o,e;Sn(this.ids)||(e=qn(t),Sn(o=In(t)?this.ids.filter(e=>t(this.entities[e])):e?ct(t):this.ids)||(Zn&&tt("Remove Entity",o),this._setState(s=>function(){var{state:e,ids:t}={state:s,ids:o};if(ut(t))return lt(lt({},a=e),{},{entities:{},ids:[],active:at(a.active)?[]:null});var i,r=e.entities,n={};for(i of e.ids)!1===t.includes(i)&&(n[i]=r[i]);var a=lt(lt({},e),{},{entities:n,ids:e.ids.filter(e=>!1===t.includes(e))});return nt(e)&&(a.active=st(a)),a}()),e||this.setHasCache(!1),this.handleUIRemove(o),this.entityActions.next({type:jn.Remove,ids:o})))}updateActive(e){var t=ct(this.active);Zn&&tt("Update Active",t),this.update(t,e)}setActive(e){e=function(e,t,i){var r;if(rt(e))r=e;else if(Tn(e)){if(ut(i))return;e=Object.assign({wrap:!0},e);var n=t.indexOf(i);if(e.prev){var a=0===n;if(a&&!e.wrap)return;r=a?t[t.length-1]:t[n-1]}else if(e.next){a=t.length===n+1;if(a&&!e.wrap)return;r=a?t[0]:t[n+1]}}else{if(e===i)return;r=e}return r}(e,this.ids,this.active);void 0!==e&&(Zn&&tt("Set Active",e),this._setActive(e))}addActive(e){var i=ct(e);Sn(i)||i.every(e=>-1<this.active.indexOf(e))||(Zn&&tt("Add Active",e),this._setState(e=>{var t=Array.from(new Set([...e.active,...i]));return lt(lt({},e),{},{active:t})}))}removeActive(e){var t=ct(e);Sn(t)||t.some(e=>-1<this.active.indexOf(e))&&(Zn&&tt("Remove Active",e),this._setState(e=>lt(lt({},e),{},{active:Array.isArray(e.active)?e.active.filter(e=>-1===t.indexOf(e)):null})))}toggleActive(e){var t=ct(e),i=t=>e=>this.active.includes(e)===t,e=t.filter(i(!0)),i=t.filter(i(!1));this.removeActive(e),this.addActive(i),Zn&&et("Toggle Active")}createUIStore(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},i={name:"UI/".concat(this.storeName),idKey:this.idKey};return this.ui=new ma(e,lt(lt({},i),t)),this.ui}destroy(){super.destroy(),this.ui instanceof pa&&this.ui.destroy(),this.entityActions.complete()}akitaPreUpdateEntity(e,t){return t}akitaPreAddEntity(e){return e}akitaPreCheckEntity(e){return e}get ids(){return this._value().ids}get entities(){return this._value().entities}get active(){return this._value().active}_setActive(t){this._setState(e=>lt(lt({},e),{},{active:t}))}handleUICreation(){var e=0<arguments.length&&void 0!==arguments[0]&&arguments[0],t=this.ids,i=In(this.ui._akitaCreateEntityFn),r=e=>{var t=this.entities[e],e=i?this.ui._akitaCreateEntityFn(t):this.ui._akitaCreateEntityFn;return lt({[this.idKey]:t[this.idKey]},e)},r=(e?this.ids.filter(e=>ea(this.ui.entities[e])):t).map(r);e?this.ui.add(r):this.ui.set(r)}hasInitialUIState(){return this.hasUIStore()&&!1===ea(this.ui._akitaCreateEntityFn)}handleUIRemove(e){this.hasUIStore()&&this.ui.remove(e)}hasUIStore(){return this.ui instanceof ma}}yt([ua(),vt("design:type",Function),vt("design:paramtypes",[Object,Object,Object,Object]),vt("design:returntype",void 0)],pa.prototype,"upsert",null),yt([ua(),vt("design:type",Function),vt("design:paramtypes",["function"==typeof(xs="undefined"!=typeof T&&T)?xs:Object]),vt("design:returntype",void 0)],pa.prototype,"toggleActive",null);class ma extends pa{constructor(){super(0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},1<arguments.length&&void 0!==arguments[1]?arguments[1]:{})}setInitialEntityState(e){this._akitaCreateEntityFn=e}}var fa=e=>e.pipe(_r(e=>null!=e));function ga(e){return"string"==typeof e}class ya{constructor(e){this.store=e,this.__store__=e,Zn&&(Jn[e.storeName]=this)}select(t){var e,n;if(In(t))e=t;else if(ga(t))e=e=>e[t];else{if(Array.isArray(t))return this.store._select(e=>e).pipe(xr((n=t,function(t,i){var r=In(n[0]);return!1===n.some(e=>r?e(t)!==e(i):t[e]!==i[e])})),sr(i=>In(t[0])?t.map(e=>e(i)):t.reduce((e,t)=>(e[t]=i[t],e),{})));e=e=>e}return this.store._select(e)}selectLoading(){return this.select(e=>e.loading)}selectError(){return this.select(e=>e.error)}getValue(){return this.store._value()}selectHasCache(){return this.store._cache().asObservable()}getHasCache(){return this.store._cache().value}get config(){return this.constructor.akitaQueryConfig}}function va(t,i){return function(e){e=e[t];if(!ea(e))return i?ga(i)?e[i]:i(e):e}}class Sa extends ya{constructor(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};super(e),this.options=t,this.__store__=e}selectAll(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{asObject:!1};return this.select(e=>e.entities).pipe(sr(()=>this.getAll(e)))}getAll(){var e,t,c=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{asObject:!1,filterBy:void 0,limitTo:void 0};return c.asObject?function(e){var r={},{filterBy:n,limitTo:a}=c,{ids:s,entities:o}=e;if(!n&&!a)return o;e=!1===ut(a);if(n&&e)for(var l=0,t=0,i=s.length;t<i&&"break"!==function(t){if(l===a)return"break";var e=s[t],i=o[e];ct(n).every(e=>e(i,t))&&(r[e]=i,l++)}(t);t++);else for(var d=Math.min(a||s.length,s.length),u=0;u<d;u++)!function(t){var e=s[t],i=o[e];if(!n)return r[e]=i;ct(n).every(e=>e(i,t))&&(r[e]=i)}(u);return r}(this.getValue()):(e=c,t=this.config||this.options,e.sortBy=e.sortBy||t&&t.sortBy,e.sortByOrder=e.sortByOrder||t&&t.sortByOrder,function(i){for(var r,e=[],{ids:n,entities:a}=i,{filterBy:s,limitTo:t,sortBy:o,sortByOrder:l}=c,d=0;d<n.length;d++)!function(t){var i=a[n[t]];if(!s)return e.push(i);ct(s).every(e=>e(i,t))&&e.push(i)}(d);o&&(r=In(o)?o:function(r,e){var n=1<arguments.length&&void 0!==e?e:Hn.ASC;return function(e,t){if(!e.hasOwnProperty(r)||!t.hasOwnProperty(r))return 0;var i="string"==typeof e[r]?e[r].toUpperCase():e[r],e="string"==typeof t[r]?t[r].toUpperCase():t[r],t=0;return e<i?t=1:i<e&&(t=-1),n==Hn.DESC?-1*t:t}}(o,l),e=e.sort((e,t)=>r(e,t,i)));t=Math.min(t||e.length,e.length);return t===e.length?e:e.slice(0,t)}(this.getValue()))}selectMany(e,i){return e&&e.length?this.select(e=>e.entities).pipe(sr(t=>{return n=e=>va(e,i)(t),e.reduce((e,t,i,r)=>{t=n(t);return void 0!==t&&e.push(t),e},[]);var n}),bn()):Pr([])}selectEntity(e,t){var i=e;return In(e)&&(i=function(e,t){for(var i of Object.keys(t))if(!0===e(t[i]))return i}(e,this.getValue().entities)),this.select(e=>e.entities).pipe(sr(va(i,t)),xr())}getEntity(e){return this.getValue().entities[e]}selectActiveId(){return this.select(e=>e.active)}getActiveId(){return this.getValue().active}selectActive(t){return rt(this.getActive())?this.selectActiveId().pipe(on(e=>this.selectMany(e,t))):this.selectActiveId().pipe(on(e=>this.selectEntity(e,t)))}getActive(){var e=this.getActiveId();return rt(e)?e.map(e=>this.getValue().entities[e]):ra(e)?this.getEntity(e):void 0}selectCount(e){return this.select(e=>e.entities).pipe(sr(()=>this.getCount(e)))}getCount(e){return(In(e)?this.getAll().filter(e):this.getValue().ids).length}selectLast(e){return this.selectAt(e=>e[e.length-1],e)}selectFirst(e){return this.selectAt(e=>e[0],e)}selectEntityAction(e){if(ut(e))return this.store.selectEntityAction$;var t=rt(e)?e=>e:e=>{var e=e["ids"];return e},i=ct(e);return this.store.selectEntityAction$.pipe(_r(e=>{var e=e["type"];return i.includes(e)}),sr(e=>t(e)))}hasEntity(e){return ut(e)?0<this.getValue().ids.length:In(e)?this.getAll().some(e):rt(e)?e.every(e=>e in this.getValue().entities):e in this.getValue().entities}hasActive(e){var t=this.getValue().active,i=qn(e);return Array.isArray(t)?i?t.includes(e):0<t.length:i?t===e:qn(t)}createUIQuery(){this.ui=new Ia(this.__store__.ui)}selectAt(e,t){return this.select(e=>e.ids).pipe(sr(e),xr(),on(e=>this.selectEntity(e,t)))}}class Ia extends Sa{constructor(e){super(e)}}function ba(){return Math.random().toString(36).slice(2)}var Ta="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:void 0!==dv?dv:{},Ea={};Object.defineProperty(Ea,"__esModule",{value:!0});var L="undefined"!=typeof Symbol&&"symbol"==typeof Symbol("x"),Aa="undefined"!=typeof Map,Oa="undefined"!=typeof Set,wa="undefined"!=typeof Proxy&&void 0!==Proxy.revocable&&"undefined"!=typeof Reflect,Ra=L?Symbol.for("immer-nothing"):((Ds={})["immer-nothing"]=!0,Ds),Ca=L?Symbol.for("immer-draftable"):"__$immer_draftable",ka=L?Symbol.for("immer-state"):"__$immer_state",Ma="undefined"!=typeof Symbol&&Symbol.iterator||"@@iterator",Pa={0:"Illegal state",1:"Immer drafts cannot have computed properties",2:"This object has been frozen and should not be mutated",3:function(e){return"Cannot use a proxy that has been revoked. Did you pass an object from inside an immer function to an async process? "+e},4:"An immer producer returned a new value *and* modified its draft. Either return a new value *or* modify the draft.",5:"Immer forbids circular references",6:"The first or second argument to `produce` must be a function",7:"The third argument to `produce` must be a function or undefined",8:"First argument to `createDraft` must be a plain object, an array, or an immerable object",9:"First argument to `finishDraft` must be a draft returned by `createDraft`",10:"The given draft is already finalized",11:"Object.defineProperty() cannot be used on an Immer draft",12:"Object.setPrototypeOf() cannot be used on an Immer draft",13:"Immer only supports deleting array indices",14:"Immer only supports setting array indices and the 'length' property",15:function(e){return"Cannot apply patch, path doesn't resolve: "+e},16:'Sets cannot have "replace" patches.',17:function(e){return"Unsupported patch operation: "+e},18:function(e){return"The plugin for '"+e+"' has not been loaded into Immer. To enable the plugin, import and call `enable"+e+"()` when initializing your application."},20:"Cannot use proxies if Proxy, Proxy.revocable or Reflect are not available",21:function(e){return"produce can only be called on things that are draftable: plain objects, arrays, Map, Set or classes that are marked with '[immerable]: true'. Got '"+e+"'"},22:function(e){return"'current' expects a draft, got: "+e},23:function(e){return"'original' expects a draft, got: "+e}};function La(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];var n=Pa[e],e=n?"function"==typeof n?n.apply(null,i):n:"unknown error nr: "+e;throw new Error("[Immer] "+e)}var xa=0,Da=1,_a=2,Na=3,Fa=0,Ba=1,Ua=4,Va=5,$a=3;function Qa(e){return!!e&&!!e[ka]}function Ka(t){return!!t&&(function(){if(!t||"object"!=typeof t)return!1;var e=Object.getPrototypeOf(t);return!e||e===Object.prototype}()||Array.isArray(t)||!!t[Ca]||!!t.constructor[Ca]||Ja(t)||Za(t))}var qa="undefined"!=typeof Reflect&&Reflect.ownKeys?Reflect.ownKeys:void 0!==Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:Object.getOwnPropertyNames,Ha=Object.getOwnPropertyDescriptors||function(t){var i={};return qa(t).forEach(function(e){i[e]=Object.getOwnPropertyDescriptor(t,e)}),i};function ja(i,r,t){void 0===t&&(t=!1),Ga(i)===xa?(t?Object.keys:qa)(i).forEach(function(e){t&&"symbol"==typeof e||r(e,i[e],i)}):i.forEach(function(e,t){return r(t,e,i)})}function Ga(e){var t=e[ka];return t?3<t.type_?t.type_-4:t.type_:Array.isArray(e)?Da:Ja(e)?_a:Za(e)?Na:xa}function za(e,t){return Ga(e)===_a?e.has(t):Object.prototype.hasOwnProperty.call(e,t)}function Wa(e,t){return Ga(e)===_a?e.get(t):e[t]}function Ya(e,t,i){var r=Ga(e);r===_a?e.set(t,i):r===Na?(e.delete(t),e.add(i)):e[t]=i}function Xa(e,t){return e===t?0!==e||1/e==1/t:e!=e&&t!=t}function Ja(e){return Aa&&e instanceof Map}function Za(e){return Oa&&e instanceof Set}function es(e){return e.copy_||e.base_}function ts(e){if(Array.isArray(e))return Array.prototype.slice.call(e);var t=Ha(e);delete t[ka];for(var i=qa(t),r=0;r<i.length;r++){var n=i[r],a=t[n];!1===a.writable&&(a.writable=!0,a.configurable=!0),(a.get||a.set)&&(t[n]={configurable:!0,writable:!0,enumerable:a.enumerable,value:e[n]})}return Object.create(Object.getPrototypeOf(e),t)}function is(e,t){ns(e)||Qa(e)||!Ka(e)||(1<Ga(e)&&(e.set=e.add=e.clear=e.delete=rs),Object.freeze(e),t&&ja(e,function(e,t){return is(t,!0)},!0))}function rs(){La(2)}function ns(e){return null==e||"object"!=typeof e||Object.isFrozen(e)}var as,ss={};function os(e){var t=ss[e];return t||La(18,e),t}function ls(e,t){ss[e]||(ss[e]=t)}function ds(){return as||La(0),as}function us(e,t){t&&(os("Patches"),e.patches_=[],e.inversePatches_=[],e.patchListener_=t)}function cs(e){hs(e),e.drafts_.forEach(ms),e.drafts_=null}function hs(e){e===as&&(as=e.parent_)}function ps(e){return as={drafts_:[],parent_:as,immer_:e,canAutoFreeze_:!0,unfinalizedDrafts_:0}}function ms(e){e=e[ka];e.type_===Fa||e.type_===Ba?e.revoke_():e.revoked_=!0}function fs(e,t){t.unfinalizedDrafts_=t.drafts_.length;var i=t.drafts_[0],r=void 0!==e&&e!==i;return t.immer_.useProxies_||os("ES5").willFinalizeES5_(t,e,r),r?(i[ka].modified_&&(cs(t),La(4)),Ka(e)&&(e=gs(t,e),t.parent_||vs(t,e)),t.patches_&&os("Patches").generateReplacementPatches_(i[ka],e,t.patches_,t.inversePatches_)):e=gs(t,i,[]),cs(t),t.patches_&&t.patchListener_(t.patches_,t.inversePatches_),e!==Ra?e:void 0}function gs(i,r,n){if(ns(r))return r;var a,s=r[ka];return s?s.scope_!==i?r:s.modified_?(s.finalized_||(s.finalized_=!0,s.scope_.unfinalizedDrafts_--,a=s.type_===Ua||s.type_===Va?s.copy_=ts(s.draft_):s.copy_,ja(s.type_===$a?new Set(a):a,function(e,t){return ys(i,s,a,e,t,n)}),vs(i,a,!1),n&&i.patches_&&os("Patches").generatePatches_(s,n,i.patches_,i.inversePatches_)),s.copy_):(vs(i,s.base_,!0),s.base_):(ja(r,function(e,t){return ys(i,s,r,e,t,n)},!0),r)}function ys(e,t,i,r,n,a){if(n===i&&La(5),Qa(n)){a=gs(e,n,a&&t&&t.type_!==$a&&!za(t.assigned_,r)?a.concat(r):void 0);if(Ya(i,r,a),!Qa(a))return;e.canAutoFreeze_=!1}Ka(n)&&!ns(n)&&(!e.immer_.autoFreeze_&&e.unfinalizedDrafts_<1||(gs(e,n),t&&t.scope_.parent_||vs(e,n)))}function vs(e,t,i){void 0===i&&(i=!1),e.immer_.autoFreeze_&&e.canAutoFreeze_&&is(t,i)}var Ss={get:function(e,t){if(t===ka)return e;var i,r,n=es(e);if(!za(n,t))return i=e,(r=Ts(n,t))?"value"in r?r.value:null===(r=r.get)||void 0===r?void 0:r.call(i.draft_):void 0;n=n[t];return!e.finalized_&&Ka(n)&&n===bs(e.base_,t)?(As(e),e.copy_[t]=ws(e.scope_.immer_,n,e)):n},has:function(e,t){return t in es(e)},ownKeys:function(e){return Reflect.ownKeys(es(e))},set:function(e,t,i){var r=Ts(es(e),t);if(null!=r&&r.set)return r.set.call(e.draft_,i),!0;if(!e.modified_){var n=bs(es(e),t),r=null==n?void 0:n[ka];if(r&&r.base_===i)return e.copy_[t]=i,e.assigned_[t]=!1,!0;if(Xa(i,n)&&(void 0!==i||za(e.base_,t)))return!0;As(e),Es(e)}return e.copy_[t]=i,e.assigned_[t]=!0,!0},deleteProperty:function(e,t){return void 0!==bs(e.base_,t)||t in e.base_?(e.assigned_[t]=!1,As(e),Es(e)):delete e.assigned_[t],e.copy_&&delete e.copy_[t],!0},getOwnPropertyDescriptor:function(e,t){var i=es(e),r=Reflect.getOwnPropertyDescriptor(i,t);return r&&{writable:!0,configurable:e.type_!==Ba||"length"!==t,enumerable:r.enumerable,value:i[t]}},defineProperty:function(){La(11)},getPrototypeOf:function(e){return Object.getPrototypeOf(e.base_)},setPrototypeOf:function(){La(12)}},Is={};function bs(e,t){var i=e[ka];return(i?es(i):e)[t]}function Ts(e,t){if(t in e)for(var i=Object.getPrototypeOf(e);i;){var r=Object.getOwnPropertyDescriptor(i,t);if(r)return r;i=Object.getPrototypeOf(i)}}function Es(e){e.modified_||(e.modified_=!0,e.parent_&&Es(e.parent_))}function As(e){e.copy_||(e.copy_=ts(e.base_))}ja(Ss,function(e,t){Is[e]=function(){return arguments[0]=arguments[0][0],t.apply(this,arguments)}}),Is.deleteProperty=function(e,t){return isNaN(parseInt(t))&&La(13),Ss.deleteProperty.call(this,e[0],t)},Is.set=function(e,t,i){return"length"!==t&&isNaN(parseInt(t))&&La(14),Ss.set.call(this,e[0],t,i,e[0])};(Ci=Os.prototype).produce=function(e,a,t){if("function"==typeof e&&"function"!=typeof a){var s=a;a=e;var o=this;return function(e){var t=this;void 0===e&&(e=s);for(var i=arguments.length,r=new Array(1<i?i-1:0),n=1;n<i;n++)r[n-1]=arguments[n];return o.produce(e,function(e){return a.call.apply(a,[t,e].concat(r))})}}var i;if("function"!=typeof a&&La(6),void 0!==t&&"function"!=typeof t&&La(7),Ka(e)){var r=ps(this),n=ws(this,e,void 0),l=!0;try{i=a(n),l=!1}finally{(l?cs:hs)(r)}return"undefined"!=typeof Promise&&i instanceof Promise?i.then(function(e){return us(r,t),fs(e,r)},function(e){throw cs(r),e}):(us(r,t),fs(i,r))}if(!e||"object"!=typeof e)return(i=a(e))===Ra?void 0:(void 0===i&&(i=e),this.autoFreeze_&&is(i,!0),i);La(21,e)},Ci.produceWithPatches=function(n,e,t){var i,r,a=this;return"function"==typeof n?function(e){for(var t=arguments.length,i=new Array(1<t?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];return a.produceWithPatches(e,function(e){return n.apply(void 0,[e].concat(i))})}:[this.produce(n,e,function(e,t){i=e,r=t}),i,r]},Ci.createDraft=function(e){Ka(e)||La(8),Qa(e)&&(e=Rs(e));var t=ps(this),e=ws(this,e,void 0);return e[ka].isManual_=!0,hs(t),e},Ci.finishDraft=function(e,t){e=e&&e[ka];e&&e.isManual_||La(9),e.finalized_&&La(10);e=e.scope_;return us(e,t),fs(void 0,e)},Ci.setAutoFreeze=function(e){this.autoFreeze_=e},Ci.setUseProxies=function(e){e&&!wa&&La(20),this.useProxies_=e},Ci.applyPatches=function(e,t){for(var i=t.length-1;0<=i;i--){var r=t[i];if(0===r.path.length&&"replace"===r.op){e=r.value;break}}var n=os("Patches").applyPatches_;return Qa(e)?n(e,t):this.produce(e,function(e){return n(e,t.slice(i+1))})},Pi=Os;function Os(e){this.useProxies_=wa,this.autoFreeze_=!0,"boolean"==typeof(null==e?void 0:e.useProxies)&&this.setUseProxies(e.useProxies),"boolean"==typeof(null==e?void 0:e.autoFreeze)&&this.setAutoFreeze(e.autoFreeze),this.produce=this.produce.bind(this),this.produceWithPatches=this.produceWithPatches.bind(this)}function ws(e,t,i){t=Ja(t)?os("MapSet").proxyMap_(t,i):Za(t)?os("MapSet").proxySet_(t,i):e.useProxies_?function(e,t){var i=Array.isArray(e),r={type_:i?Ba:Fa,scope_:t?t.scope_:ds(),modified_:!1,finalized_:!1,assigned_:{},parent_:t,base_:e,draft_:null,copy_:null,revoke_:null,isManual_:!1},t=r,e=Ss;i&&(t=[r],e=Is);t=Proxy.revocable(t,e),e=t.revoke,t=t.proxy;return r.draft_=t,r.revoke_=e,t}(t,i):os("ES5").createES5Proxy_(t,i);return(i?i.scope_:ds()).drafts_.push(t),t}function Rs(e){return Qa(e)||La(22,e),function i(e){if(!Ka(e))return e;var r,n=e[ka],t=Ga(e);if(n){if(!n.modified_&&(n.type_<4||!os("ES5").hasChanges_(n)))return n.base_;n.finalized_=!0,r=Cs(e,t),n.finalized_=!1}else r=Cs(e,t);return ja(r,function(e,t){n&&Wa(n.base_,e)===t||Ya(r,e,i(t))}),t===Na?new Set(r):r}(e)}function Cs(e,t){switch(t){case _a:return new Map(e);case Na:return Array.from(e)}return ts(e)}function ks(){var r={};function l(i,e){var t=r[i];return t?t.enumerable=e:r[i]=t={configurable:!0,enumerable:e,get:function(){var e=this[ka];return s(e),Ss.get(e,i)},set:function(e){var t=this[ka];s(t),Ss.set(t,i,e)}},t}function n(e){for(var t=e.length-1;0<=t;t--){var i=e[t][ka];if(!i.modified_)switch(i.type_){case Va:u(i)&&Es(i);break;case Ua:a(i)&&Es(i)}}}function a(e){for(var t=e.base_,i=e.draft_,r=qa(i),n=r.length-1;0<=n;n--){var a=r[n];if(a!==ka){var s=t[a];if(void 0===s&&!za(t,a))return!0;var o=i[a],a=o&&o[ka];if(a?a.base_!==s:!Xa(o,s))return!0}}e=!!t[ka];return r.length!==qa(t).length+(e?0:1)}function u(e){var t=e.draft_;if(t.length!==e.base_.length)return!0;t=Object.getOwnPropertyDescriptor(t,t.length-1);return!(!t||t.get)}function s(e){e.revoked_&&La(3,JSON.stringify(es(e)))}ls("ES5",{createES5Proxy_:function(e,t){var i=Array.isArray(e),r=function(e,t){if(e){for(var i=new Array(t.length),r=0;r<t.length;r++)Object.defineProperty(i,""+r,l(r,!0));return i}var n=Ha(t);delete n[ka];for(var a=qa(n),s=0;s<a.length;s++){var o=a[s];n[o]=l(o,e||!!n[o].enumerable)}return Object.create(Object.getPrototypeOf(t),n)}(i,e),e={type_:i?Va:Ua,scope_:t?t.scope_:ds(),modified_:!1,finalized_:!1,assigned_:{},parent_:t,base_:e,draft_:r,copy_:null,revoked_:!1,isManual_:!1};return Object.defineProperty(r,ka,{value:e,writable:!0}),r},willFinalizeES5_:function(e,t,i){i?Qa(t)&&t[ka].scope_===e&&n(e.drafts_):(e.patches_&&function t(e){if(e&&"object"==typeof e){var i=e[ka];if(i){var r=i.base_,n=i.draft_,a=i.assigned_;if((e=i.type_)===Ua)ja(n,function(e){e!==ka&&(void 0!==r[e]||za(r,e)?a[e]||t(n[e]):(a[e]=!0,Es(i)))}),ja(r,function(e){void 0!==n[e]||za(n,e)||(a[e]=!1,Es(i))});else if(e===Va){if(u(i)&&(Es(i),a.length=!0),n.length<r.length)for(var s=n.length;s<r.length;s++)a[s]=!1;else for(var o=r.length;o<n.length;o++)a[o]=!0;for(var l=Math.min(n.length,r.length),d=0;d<l;d++)void 0===a[d]&&t(n[d])}}}}(e.drafts_[0]),n(e.drafts_))},hasChanges_:function(e){return(e.type_===Ua?a:u)(e)}})}function Ms(){var f="replace",g="add",y="remove";function d(e){if(!Ka(e))return e;if(Array.isArray(e))return e.map(d);if(Ja(e))return new Map(Array.from(e.entries()).map(function(e){return[e[0],d(e[1])]}));if(Za(e))return new Set(Array.from(e).map(d));var t,i=Object.create(Object.getPrototypeOf(e));for(t in e)i[t]=d(e[t]);return i}function v(e){return Qa(e)?d(e):e}ls("Patches",{applyPatches_:function(l,e){return e.forEach(function(e){for(var t=e.path,i=e.op,r=l,n=0;n<t.length-1;n++)"object"!=typeof(r=Wa(r,t[n]))&&La(15,t.join("/"));var a=Ga(r),s=d(e.value),o=t[t.length-1];switch(i){case f:switch(a){case _a:return r.set(o,s);case Na:La(16);default:return r[o]=s}case g:switch(a){case Da:return r.splice(o,0,s);case _a:return r.set(o,s);case Na:return r.add(s);default:return r[o]=s}case y:switch(a){case Da:return r.splice(o,1);case _a:return r.delete(o);case Na:return r.delete(e.value);default:return delete r[o]}default:La(17,i)}}),l},generatePatches_:function(c,e,t,i){switch(c.type_){case Fa:case Ua:case 2:return d=e,u=t,h=i,p=c.base_,m=c.copy_,void ja(c.assigned_,function(e,t){var i=Wa(p,e),r=Wa(m,e),t=t?za(p,e)?f:g:y;i===r&&t==f||(e=d.concat(e),u.push(t==y?{op:t,path:e}:{op:t,path:e,value:r}),h.push(t==g?{op:y,path:e}:t==y?{op:g,path:e,value:v(i)}:{op:f,path:e,value:v(i)}))});case Va:case Ba:return function(e,t,i){var r,n=c.base_,a=c.assigned_,s=c.copy_;s.length<n.length&&(n=(r=[s,n])[0],s=r[1],t=(r=[i,t])[0],i=r[1]);for(var o,l=0;l<n.length;l++)a[l]&&s[l]!==n[l]&&(o=e.concat([l]),t.push({op:f,path:o,value:v(s[l])}),i.push({op:f,path:o,value:v(n[l])}));for(var d=n.length;d<s.length;d++){var u=e.concat([d]);t.push({op:g,path:u,value:v(s[d])})}n.length<s.length&&i.push({op:f,path:e.concat(["length"]),value:n.length})}(e,t,i);case $a:return r=e,n=t,a=i,s=c.base_,o=c.copy_,l=0,s.forEach(function(e){var t;o.has(e)||(t=r.concat([l]),n.push({op:y,path:t,value:e}),a.unshift({op:g,path:t,value:e})),l++}),l=0,void o.forEach(function(e){var t;s.has(e)||(t=r.concat([l]),n.push({op:g,path:t,value:e}),a.unshift({op:y,path:t,value:e})),l++})}var r,n,a,s,o,l,d,u,h,p,m},generateReplacementPatches_:function(e,t,i,r){i.push({op:f,path:[],value:t}),r.push({op:f,path:[],value:e.base_})}})}function Ps(){var r=function(e,t){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(e,t)};function i(e,t){function i(){this.constructor=e}r(e,t),e.prototype=(i.prototype=t.prototype,new i)}var n=function(){function e(e,t){return this[ka]={type_:2,parent_:t,scope_:t?t.scope_:ds(),modified_:!1,finalized_:!1,copy_:void 0,assigned_:void 0,base_:e,draft_:this,isManual_:!1,revoked_:!1},this}i(e,Map);var t=e.prototype;return Object.defineProperty(t,"size",{get:function(){return es(this[ka]).size}}),t.has=function(e){return es(this[ka]).has(e)},t.set=function(e,t){var i=this[ka];return l(i),es(i).has(e)&&es(i).get(e)===t||(a(i),Es(i),i.assigned_.set(e,!0),i.copy_.set(e,t),i.assigned_.set(e,!0)),this},t.delete=function(e){if(!this.has(e))return!1;var t=this[ka];return l(t),a(t),Es(t),t.assigned_.set(e,!1),t.copy_.delete(e),!0},t.clear=function(){var t=this[ka];l(t),es(t).size&&(a(t),Es(t),t.assigned_=new Map,ja(t.base_,function(e){t.assigned_.set(e,!1)}),t.copy_.clear())},t.forEach=function(r,n){var a=this;es(this[ka]).forEach(function(e,t,i){r.call(n,a.get(t),t,a)})},t.get=function(e){var t=this[ka];l(t);var i=es(t).get(e);if(t.finalized_||!Ka(i))return i;if(i!==t.base_.get(e))return i;i=ws(t.scope_.immer_,i,t);return a(t),t.copy_.set(e,i),i},t.keys=function(){return es(this[ka]).keys()},t.values=function(){var e,t=this,i=this.keys();return(e={})[Ma]=function(){return t.values()},e.next=function(){var e=i.next();return e.done?e:{done:!1,value:t.get(e.value)}},e},t.entries=function(){var e,i=this,r=this.keys();return(e={})[Ma]=function(){return i.entries()},e.next=function(){var e=r.next();if(e.done)return e;var t=i.get(e.value);return{done:!1,value:[e.value,t]}},e},t[Ma]=function(){return this.entries()},e}();function a(e){e.copy_||(e.assigned_=new Map,e.copy_=new Map(e.base_))}var s=function(){function e(e,t){return this[ka]={type_:$a,parent_:t,scope_:t?t.scope_:ds(),modified_:!1,finalized_:!1,copy_:void 0,base_:e,draft_:this,drafts_:new Map,revoked_:!1,isManual_:!1},this}i(e,Set);var t=e.prototype;return Object.defineProperty(t,"size",{get:function(){return es(this[ka]).size}}),t.has=function(e){var t=this[ka];return l(t),t.copy_?!!t.copy_.has(e)||!(!t.drafts_.has(e)||!t.copy_.has(t.drafts_.get(e))):t.base_.has(e)},t.add=function(e){var t=this[ka];return l(t),this.has(e)||(o(t),Es(t),t.copy_.add(e)),this},t.delete=function(e){if(!this.has(e))return!1;var t=this[ka];return l(t),o(t),Es(t),t.copy_.delete(e)||!!t.drafts_.has(e)&&t.copy_.delete(t.drafts_.get(e))},t.clear=function(){var e=this[ka];l(e),es(e).size&&(o(e),Es(e),e.copy_.clear())},t.values=function(){var e=this[ka];return l(e),o(e),e.copy_.values()},t.entries=function(){var e=this[ka];return l(e),o(e),e.copy_.entries()},t.keys=function(){return this.values()},t[Ma]=function(){return this.values()},t.forEach=function(e,t){for(var i=this.values(),r=i.next();!r.done;)e.call(t,r.value,r.value,this),r=i.next()},e}();function o(i){i.copy_||(i.copy_=new Set,i.base_.forEach(function(e){var t;Ka(e)?(t=ws(i.scope_.immer_,e,i),i.drafts_.set(e,t),i.copy_.add(t)):i.copy_.add(e)}))}function l(e){e.revoked_&&La(3,JSON.stringify(es(e)))}ls("MapSet",{proxyMap_:function(e,t){return new n(e,t)},proxySet_:function(e,t){return new s(e,t)}})}var Rn=new Pi,e=Rn.produce,Ls=Rn.produceWithPatches.bind(Rn),xs=Rn.setAutoFreeze.bind(Rn),Ds=Rn.setUseProxies.bind(Rn),L=Rn.applyPatches.bind(Rn),Ci=Rn.createDraft.bind(Rn),Rn=Rn.finishDraft.bind(Rn);Ea.Immer=Pi,Ea.applyPatches=L,Ea.castDraft=function(e){return e},Ea.castImmutable=function(e){return e},Ea.createDraft=Ci,Ea.current=Rs,Ea.default=e,Ea.enableAllPlugins=function(){ks(),Ps(),Ms()},Ea.enableES5=ks;Ci=Ea.enableMapSet=Ps;Ea.enablePatches=Ms,Ea.finishDraft=Rn,Ea.immerable=Ca,Ea.isDraft=Qa,Ea.isDraftable=Ka,Ea.nothing=Ra,Ea.original=function(e){return Qa(e)||La(23,e),e[ka].base_};var _s=Ea.produce=e;Ea.produceWithPatches=Ls;var Ns=Ea.setAutoFreeze=xs;Ea.setUseProxies=Ds;const Fs=["SDR","PQ","HLG"];function Bs(e){return"bitrate"in e}const Us=/^(?:[^\/;?#]+:)?(?:\/\/)?([^\/\;?#]*)/,Vs=/^((?:[^\/;?#]+:)?)(\/\/[^\/\;?#]*)?(.*?)??(;.*?)?(\?.*?)?(#.*?)?$/,$s=/^([^\/;?#]*)(.*)$/,Qs=/(?:\/|^)\.(?=\/)/g,Ks=/(?:\/|^)\.\.\/(?!\.\.\/).*?(?=\/)/g,qs={buildAbsoluteURL:function(e,t,i){var r;if(i=i||{},e=e.trim(),0===(t=t.trim()).length){if(!i.alwaysNormalize)return e;const t=qs.parseURL(e);if(!t)throw new Error("Error trying to parse base URL.");return t.path=qs.normalizePath(null!==(r=t.path)&&void 0!==r?r:""),qs.buildURLFromParts(t)}const n=qs.parseURL(t);if(!n)throw new Error("Error trying to parse relative URL.");if(n.scheme)return i.alwaysNormalize?(n.path=qs.normalizePath(null!==(r=n.path)&&void 0!==r?r:""),qs.buildURLFromParts(n)):t;const a=qs.parseURL(e);if(!a)throw new Error("Error trying to parse base URL.");if(!a.netLoc&&a.path&&"/"!==a.path[0]){const o=$s.exec(a.path);a.netLoc=null==o?void 0:o[1],a.path=null==o?void 0:o[2]}a.netLoc&&!a.path&&(a.path="/");const s={scheme:a.scheme,netLoc:n.netLoc,path:null,params:n.params,query:n.query,fragment:n.fragment};if(!n.netLoc&&(s.netLoc=a.netLoc,"/"!==(null===(e=n.path)||void 0===e?void 0:e[0])))if(n.path){const o=a.path,t=(null==o?void 0:o.substring(0,o.lastIndexOf("/")+1))+n.path;s.path=qs.normalizePath(t)}else s.path=a.path,n.params||(s.params=a.params,n.query||(s.query=a.query));return null===s.path&&(s.path=i.alwaysNormalize?qs.normalizePath(null!==(i=n.path)&&void 0!==i?i:""):n.path),qs.buildURLFromParts(s)},parseURL:function(e){e=Vs.exec(e);return e?{scheme:e[1]||"",netLoc:e[2]||"",path:e[3]||"",params:e[4]||"",query:e[5]||"",fragment:e[6]||""}:null},normalizePath:function(e){for(e=e.split("").reverse().join("").replace(Qs,"");e.length!==(e=e.replace(Ks,"")).length;);return e.split("").reverse().join("")},buildURLFromParts:function(e){return e.scheme+e.netLoc+e.path+e.params+e.query+e.fragment},getHostName:function(e){if(e){var e=Us.exec(e);return null!==(e=e&&e[1])&&void 0!==e?e:""}},getBaseURL:function(e){if(!e)return null;e=qs.parseURL(e);return e?e.scheme+e.netLoc+e.path:null}};var Hs,js,Gs,zs,Ws,Ys,Xs,Js,Zs,eo,to,io,ro,no=qs;function ao(e){return null!=e&&!e.startsWith("http://")&&!e.startsWith("https://")}function so(e,t){return ao(e)?qs.buildAbsoluteURL(t,e,{alwaysNormalize:!0}):qs.buildAbsoluteURL(e,"",{alwaysNormalize:!0})}function oo(e){var t;return null!=e&&!ao(e)&&null!==(t=qs.getHostName(e))&&void 0!==t?t:null}const lo=[".*.itunes.apple.com"],uo={deviceName:"&xapdn=",deviceModel:"&xapdm=",language:"&xapdl=",dsid:"&xapdsid=",subs:"&xapsub="};function co(e,t){return null==e||null==t||e===t}function ho(e,t){var i,r,n=Bs(e),a=Bs(t),i=oo(e.url),r=t.url;return(!i||i===oo(r))&&(!n&&!a||n&&a&&co(e.pathwayID,t.pathwayID))}(xs=Hs=Hs||{})[xs.DOVI=4]="DOVI",xs[xs.HEVC=3]="HEVC",xs[xs.VP09=2]="VP09",xs[xs.AVC=1]="AVC",xs[xs.UNKNOWN=0]="UNKNOWN",(Ea=js=js||{})[Ea.PQ=3]="PQ",Ea[Ea.HLG=2]="HLG",Ea[Ea.SDR=1]="SDR",Ea[Ea.UNKNOWN=0]="UNKNOWN",(Ds=Gs=Gs||{})[Ds.ALAC=7]="ALAC",Ds[Ds.FLAC=6]="FLAC",Ds[Ds.EC3=5]="EC3",Ds[Ds.AC3=4]="AC3",Ds[Ds.XHEAAC=3]="XHEAAC",Ds[Ds.AAC=2]="AAC",Ds[Ds.MP3=1]="MP3",Ds[Ds.UNKNOWN=0]="UNKNOWN",(xs=zs=zs||{})[xs.VALID=1]="VALID",xs[xs.INVALID=0]="INVALID",(Ea=Ws=Ws||{})[Ea.DO_NOTHING=0]="DO_NOTHING",Ea[Ea.FLUSH_ALL=1]="FLUSH_ALL",Ea[Ea.RESET_MEDIASOURCE=2]="RESET_MEDIASOURCE";const po=["via","x-apple-request-uuid"],mo=["fragLoadPolicy","keyLoadPolicy","certLoadPolicy","playlistLoadPolicy","manifestLoadPolicy","steeringManifestLoadPolicy"],fo={maxNumRetry:4,retryDelayMs:0,maxRetryDelayMs:0},go={maxNumRetry:6,retryDelayMs:1e3,maxRetryDelayMs:8e3},yo={maxNumRetry:0,retryDelayMs:0,maxRetryDelayMs:0},vo={default:{maxTimeToFirstByteMs:5e3,maxLoadTimeMs:2e4,autoRetry:!1,timeoutRetry:yo,errorRetry:yo},interstitial:{maxTimeToFirstByteMs:5e3,maxLoadTimeMs:2e4,autoRetry:!1,timeoutRetry:yo,errorRetry:yo},customURL:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,autoRetry:!1,timeoutRetry:yo,errorRetry:yo}},So={maxNumRetry:8,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"},Io=Object.assign(Object.assign({},So),{maxNumRetry:1}),bo={default:{maxTimeToFirstByteMs:5e3,maxLoadTimeMs:2e4,autoRetry:!1,timeoutRetry:Io,errorRetry:So},interstitial:{maxTimeToFirstByteMs:5e3,maxLoadTimeMs:2e4,autoRetry:!1,timeoutRetry:Io,errorRetry:So},customURL:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,autoRetry:!1,timeoutRetry:Io,errorRetry:So}},To={supportedStorebagVersion:"0.0.0",testGroupId:""},Eo=Object.assign(Object.assign({enableContentSteering:!1,enableBoss:!0,startPosition:NaN,debug:!1,debugLevel:"info",buildType:void 0,abrTrickplayLevelLocked:!1,minFramesBeforeSwitchingLevel:11,minTargetDurations:3,maxBufferLength:60,maxBufferHole:.5,maxSeekHole:2,nudgeFromEventSeek:!0,jaggedSeekTolerance:0,discontinuitySeekTolerance:2,bufferedSegmentEjectionToleranceMs:.5,almostDryBufferSec:.5,maxTotalDurationTolerance:.1,changeType:!1,lowBufferThreshold:.5,lowBufferWatchdogPeriod:.5,highBufferWatchdogPeriod:3,seekWatchdogPeriod:5,nudgeOffset:.1,nudgeMaxRetry:3,maxFragLookUpTolerance:.2,liveSyncDurationCount:3,liveSyncDuration:void 0,liveMaxUnchangedPlaylistRefresh:3,liveEdgeForZeroStartPositon:!1,liveAllowTrickplay:!1,livePlaylistUpdateStaleness:2,liveAllowLowLatencyPlayback:!1,allowFastSwitchUp:!1,desiredIframeFPS:8,leftMediaTimeToAutoPause:10,startTargetDurationFactor:.9,minRequiredStartDuration:4,minRequiredStartDurationLLHLS:2,maxRequiredStartDuration:15,instantBwDurationFactor:.5,enableWorker:!0,enableWebCrypto:!0,keySystemPreference:void 0,useMultipleKeySessions:!1,enablePlayReadyKeySystem:!1,useMediaKeySystemAccessFilter:!1,playReadyMessageFormat:"utf16",livePlaylistRefreshDelay:2500,liveMinPlayingBufferLen:5,enableIFramePreloading:!0,enableItemPreloading:!1,enableInterstitialPlayback:!1,livePlaylistPreloadDelayMs:250,allowInterstitialAssetListDownload:!0,allowServerGeneratedInterstitials:!0,forcePauseOnInterstitialBoundary:!1,adjustedSeekToleranceMs:500,enablePartialInterstitialPlaybackForLiveEdge:!1,useMediaCapabilities:!1,enableID3Cues:!0,certLoadPolicy:vo,keyLoadPolicy:bo,manifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,autoRetry:!1,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}},interstitial:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,autoRetry:!1,timeoutRetry:{maxNumRetry:0,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:0,retryDelayMs:0,maxRetryDelayMs:0}},customURL:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:1e4,autoRetry:!1,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},trickPlaybackConfig:{enabled:!0,minIframeDuration:8},minSteeringRunway:2,partialAppendDurationSec:0,replaceItemAction:Ws.RESET_MEDIASOURCE},To),{playlistLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,autoRetry:!1,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}},interstitial:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,autoRetry:!1,timeoutRetry:{maxNumRetry:0,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:0,retryDelayMs:0,maxRetryDelayMs:0}},customURL:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:1e4,autoRetry:!1,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},fragLoadPolicy:{default:{maxTimeToFirstByteMs:5e3,autoRetry:!1,timeoutRetry:fo,errorRetry:go,forceContentLenCheckIfNoHeader:!1,reportCDNServer:!0},interstitial:{maxTimeToFirstByteMs:5e3,autoRetry:!1,timeoutRetry:{maxNumRetry:0,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:0,retryDelayMs:0,maxRetryDelayMs:0},forceContentLenCheckIfNoHeader:!1,reportCDNServer:!0},customURL:{maxTimeToFirstByteMs:1e4,autoRetry:!1,timeoutRetry:fo,errorRetry:go,reportCDNServer:!0}},steeringManifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,autoRetry:!1,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}},interstitial:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,autoRetry:!1,timeoutRetry:{maxNumRetry:0,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:0,retryDelayMs:0,maxRetryDelayMs:0}},customURL:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:1e4,autoRetry:!1,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},maxNumAddLevelToPenaltyBox:4,firstAudioMustOverlapVideoStart:!1,keyMinHoldTimeBeforeCleanup:15e3,appendErrorMaxRetry:3,xhrSetup:void 0,audioPrimingDelay:0,enableCEA708Captions:!0,customTextTrackCueRenderer:!1,enableWebVTT:!0,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",condenseSubtitleTrack:!1,nativeTextTrackChangeHandling:!0,earlyFragTolerance:7,vttConcurrentLoadCount:1,trottleCheckInterval:2e3,subtitleLeadTime:30,lateTolerance:2,dynamicTextTrackCreation:!1,stretchShortVideoTrack:!1,forceKeyFrameOnDiscontinuity:!0,abrAlgorithm:"default",abrBandWidthFactor:.95,abrBandWidthUpFactor:.9,abrSamplePeriodMs:200,maxStarvationDelay:4,useStickyAtmosFilter:!1,enableRtcReporting:!1,rtcIntervalTimeout:3e5,rtcLogHistoryNumLines:0,rtcLogHistoryMaxLineLength:200,rtcExcludeKeysList:[],useHTTPPlaybackSessionId:!1,warmupCdms:!1,createDummySessionOnStart:!1,maintainMediaKeysBetweenSessions:!0,enablePerformanceLogging:!1,rtcErrStackNumLines:0,overridePlaybackRate:!1,nativeControlsEnabled:!1,useCustomMediaFunctions:!0,seekEventThrottleMs:150,timeAccuracyThresholdSeconds:.25,contentGapPlaythroughIntervalSeconds:.5,enableAdaptiveStartup:!0,bandwidthHistoryWindowSize:12e4,bandwidthHistoryTTL:6e5,bandwidthHistoryAggregationMethod:"quadratic-time-weighted",defaultTargetDuration:10,defaultPartTargetDuration:1,targetStartupMs:4e3,bandwidthHistoryStorageKey:"AppleHLS-bandwidth-estimation",storageKeyPrefix:"AppleHLS-",storage:{get:"undefined"==typeof localStorage?void 0:localStorage.getItem.bind(localStorage),set:"undefined"==typeof localStorage?void 0:localStorage.setItem.bind(localStorage)},minFragmentCount:1,minPlaylistCount:1,enableQueryParamsForITunes:!1,gapless:!1,supportGaplessVideo:!1,useViewportSizeForLevelCap:!1,statDefaults:{playlistLoadTimeMs:500,playlistParseTimeMs:50,fragParseTimeMs:100,fragBufferCreationDelayMs:200,dataFragAppendMs:100,initFragAppendMs:100},disableVideoCodecList:new Set([]),disableAudioCodecList:new Set([Gs.ALAC,Gs.FLAC,Gs.XHEAAC]),useHighestVideoCodecPrivate:!0,sessionDataAutoLoad:{"com.apple.hls.chapters":!0,"_hls.localized-rendition-names":!0},canUseNetworkResourcesForLiveStreamingWhilePaused:!1,liveResumeAtWindowStart:!1,liveOldCueRemovalOffsetSec:600});function Ao(e){var t;return null!==(t=e.serviceName)&&void 0!==t?t:e.itemId}const Oo={itemId:"Nah",mediaOptionId:"Nah"},wo=Object.assign(Object.assign({},Oo),{mediaOptionType:void 0}),Ro=e=>{var{itemId:t,mediaOptionId:e}=e;return"Nah"!==t&&"Nah"!==e};function Co(e){return null!=e&&null!=e.relativeUrl}const ko=(e,t)=>e.itemId===t.itemId&&e.mediaOptionId===t.mediaOptionId;(Ds=Ys=Ys||{})[Ds.Variant=0]="Variant",Ds[Ds.AltAudio=1]="AltAudio",Ds[Ds.Subtitle=2]="Subtitle";const Mo=["variant","altAudio","subtitle"],Po=[Ys.Variant,Ys.AltAudio,Ys.Subtitle],Lo=[Ys.Variant,Ys.AltAudio];(xs=Xs=Xs||{})[xs.Variant=0]="Variant",xs[xs.AltAudio=1]="AltAudio";const xo=["variant","altAudio"];function Do(e){switch(e){case Ys.Variant:return Xs.Variant;case Ys.AltAudio:return Xs.AltAudio;default:return null}}function _o(e){return e===Xs.Variant?Ys.Variant:Ys.AltAudio}(Ea=Js=Js||{})[Ea.Primary=0]="Primary",Ea[Ea.Interstitial=1]="Interstitial";class No{constructor(e=0){this.maxLines=e,this.logs=[]}recordLogs(e){this.maxLines&&(e={timestampMs:e.ts,messages:e.messages,level:e.level.value},this.logs.push(e),this.logs.length>this.maxLines&&this.logs.shift())}getLogs(){return this.logs}}(Ds=Zs=Zs||{})[Ds.NO=0]="NO",Ds[Ds.YES=1]="YES",(xs=eo=eo||{}).UNKNOWN="unkn",xs.VIDEO="vide",xs.AUDIO="soun",xs.SUBTITLE="sbtl",xs.CLOSEDCAPTION="clcp",(Ea=to=to||{}).LowBandwidth="LowBandwidth",Ea.HighBandwidth="HighBandwidth",Ea.PreferredListChanged="PreferredListChanged",Ea.IframeModeChange="IframeModeChange",Ea.None="",Ea.Seek="Seek";class Fo{constructor(){this.hostClock=null,this._timeline=null,this.stopTime=null}get forward(){var e;return 0<(null!==(e=null===(e=this.timeline)||void 0===e?void 0:e.rate)&&void 0!==e?e:0)}get isStarted(){return Boolean(this.hostClock)}start(e){this.stopTime=null,this._timeline=Object.assign({},e);const t={rootTimeSeconds:performance.now()/1e3,rate:1};this.hostClock={timeline:t,getCurrentTime:()=>({seconds:performance.now()/1e3,timeline:t})}}pause(){this.isStarted&&(this.stopTime=this.getCurrentTime())}stop(){this.pause(),this.hostClock=null,this._timeline=null}get timeline(){return this._timeline}getCurrentTime(){if(this.stopTime)return this.stopTime;if(!this.hostClock)return null;var e,t,i=this.hostClock.getCurrentTime();return i&&this.timeline?(e=this.timeline,t=i.timeline,{seconds:(i.seconds-t.rootTimeSeconds)/t.rate*e.rate+e.rootTimeSeconds,timeline:e}):null}}(Ds=io=io||{})[Ds.ContentSteeringPathwayCloner=0]="ContentSteeringPathwayCloner",Ds[Ds.PlatformFilter=1]="PlatformFilter",Ds[Ds.PermanentRemovalFilter=2]="PermanentRemovalFilter",Ds[Ds.PenaltyBoxFilter=3]="PenaltyBoxFilter",Ds[Ds.PathwayPenaltyBoxFilter=4]="PathwayPenaltyBoxFilter",Ds[Ds.CompatibleIdsFilter=5]="CompatibleIdsFilter",Ds[Ds.HDRFilter=6]="HDRFilter",Ds[Ds.ViewportFilter=7]="ViewportFilter",Ds[Ds.HDCPFilter=8]="HDCPFilter",Ds[Ds.MediaFilteringBasedOnMaxAllowedHdcpLevel=9]="MediaFilteringBasedOnMaxAllowedHdcpLevel",Ds[Ds.MatchingPathwayFilter=10]="MatchingPathwayFilter",Ds[Ds.PathwayFilter=11]="PathwayFilter",Ds[Ds.ImageVariantFilter=12]="ImageVariantFilter",Ds[Ds.MediaFilteringBasedOnConfig=13]="MediaFilteringBasedOnConfig",Ds[Ds.MediaFilterBasedOnCaps=14]="MediaFilterBasedOnCaps",Ds[Ds.MediaFilteringBasedOnSecurityLevel=15]="MediaFilteringBasedOnSecurityLevel",Ds[Ds.MediaFilteringBasedOnKeySystemMediaCapabilities=16]="MediaFilteringBasedOnKeySystemMediaCapabilities",Ds[Ds.MediaFilteringBasedOnSystemMediaCapabilities=17]="MediaFilteringBasedOnSystemMediaCapabilities",Ds[Ds.MediaFilteringBasedOnSupportedVideoFormats=18]="MediaFilteringBasedOnSupportedVideoFormats",Ds[Ds.MediaFilteringBasedOnImageIframes=19]="MediaFilteringBasedOnImageIframes",Ds[Ds.MediaFilteringBasedOnAudioAndVideoCodecs=20]="MediaFilteringBasedOnAudioAndVideoCodecs",Ds[Ds.MediaFilteringBasedOnExtendedAudioParameters=21]="MediaFilteringBasedOnExtendedAudioParameters",Ds[Ds.MediaIframeFilterBasedOnCapsOn1080p=22]="MediaIframeFilterBasedOnCapsOn1080p",Ds[Ds.MediaFilterBasedOnMode=23]="MediaFilterBasedOnMode",Ds[Ds.BitrateFilter=24]="BitrateFilter",Ds[Ds.ValidAbrLevelFilter=25]="ValidAbrLevelFilter",Ds[Ds.SdrOnlyFilter=26]="SdrOnlyFilter",Ds[Ds.NonIframeOnlyFilter=27]="NonIframeOnlyFilter",Ds[Ds.IframeOnlyFilter=28]="IframeOnlyFilter",Ds[Ds.ValidFallbackFilter=29]="ValidFallbackFilter",Ds[Ds.ValidAlternatesFilter=30]="ValidAlternatesFilter",Ds[Ds.ErrorHandlingValidAlternatesFilter=31]="ErrorHandlingValidAlternatesFilter",Ds[Ds.RemoveAudioOnlyFilter=32]="RemoveAudioOnlyFilter",Ds[Ds.PathwayRankSelector=33]="PathwayRankSelector",Ds[Ds.HostRankSelector=34]="HostRankSelector",Ds[Ds.LowerPivotQualitySelector=35]="LowerPivotQualitySelector",Ds[Ds.HigherPivotQualitySelector=36]="HigherPivotQualitySelector",Ds[Ds.LowerQualitySelector=37]="LowerQualitySelector",Ds[Ds.HigherQualitySelector=38]="HigherQualitySelector",Ds[Ds.PivotAudioGroupSelector=39]="PivotAudioGroupSelector",Ds[Ds.StartUpTimeSelector=40]="StartUpTimeSelector",Ds[Ds.FirstLevelSelector=41]="FirstLevelSelector",Ds[Ds.FallbackSelector=42]="FallbackSelector",Ds[Ds.QualitySelector=43]="QualitySelector",Ds[Ds.BestAbrLevelSelector=44]="BestAbrLevelSelector",Ds[Ds.GenericTransformer=45]="GenericTransformer",(xs=ro=ro||{})[xs.ABR=0]="ABR",xs[xs.ABRLowestLevel=1]="ABRLowestLevel",xs[xs.ABRIframe=2]="ABRIframe",xs[xs.ABRIframeLowestLevel=3]="ABRIframeLowestLevel",xs[xs.ErrorHandling=4]="ErrorHandling",xs[xs.FirstSelection=5]="FirstSelection",xs[xs.ImageVariant=6]="ImageVariant",xs[xs.ErrorHandlingSdrOnly=7]="ErrorHandlingSdrOnly",xs[xs.CompatibleOptions=8]="CompatibleOptions",xs[xs.PlatformFiltering=9]="PlatformFiltering";class Bo{constructor(e,t={}){this.variants=e,this.generation=t}}class Uo extends Error{constructor(e,t){super(e),this.statusCode=t}get isAuthOrCorsError(){return 401===this.statusCode||403===this.statusCode||407===this.statusCode||0===this.statusCode}}class Vo extends v{constructor(e,t,i,r,n){super(U.NETWORK_ERROR,e,t,i,r),this.isTimeout=n,this.response=r}}class $o extends Vo{constructor(e,t,i,r){super(r?V.MANIFEST_LOAD_TIMEOUT:V.MANIFEST_LOAD_ERROR,e,t,i,r)}}class Qo extends Vo{constructor(e,t,i,r,n,a,s){super(function(e){switch(n){case Ys.Variant:return e?V.LEVEL_LOAD_TIMEOUT:V.LEVEL_LOAD_ERROR;case Ys.AltAudio:return e?V.AUDIO_TRACK_LOAD_TIMEOUT:V.AUDIO_TRACK_LOAD_ERROR;case Ys.Subtitle:return e?V.SUBTITLE_TRACK_LOAD_TIMEOUT:V.SUBTITLE_TRACK_LOAD_ERROR}return V.UNKNOWN}(r),e,t,i,r),this.mediaOptionType=n,this.mediaOptionId=a,this.url=s}}class Ko extends Vo{constructor(e,t,i){super(V.SESSION_DATA_LOAD_ERROR,e,t,i,!1)}}class qo extends Vo{constructor(e,t,i,r,n,a){super(r?V.FRAG_LOAD_TIMEOUT:V.FRAG_LOAD_ERROR,e,t,i,r),this.mediaOptionId=n.mediaOptionId,this.mediaOptionType=n.mediaOptionType,this.stats=a}}class Ho extends mn{constructor(e,t){super(),this.message=e,this.stats=t}}class jo extends Vo{constructor(e,t,i){super(V.FRAG_ABORT_ERROR,!1,"Fragment abort",i,!1),this.candidateMediaOptions=t,this.mediaOptionId=e.mediaOptionId,this.mediaOptionType=e.mediaOptionType}}function Go(e,t){return!e.url||ao(e.url)?t.customURL:t.default}function zo(e,t){return e instanceof Vo?e.isTimeout?t.timeoutRetry:t.errorRetry:null}function Wo(t){return e=>e.pipe(Wi(e=>{if(e instanceof Ho)throw new $o(t,"Timeout",G.ManifestTimeoutError,!0);if(e instanceof Uo)throw new $o(t,e.message,{code:e.statusCode,text:"Manifest network error"},!1);throw e}))}function Yo(t,i,r,n){return e=>e.pipe(Wi(e=>{if(e instanceof Ho)throw new Qo(r,"Timeout",G.PlaylistTimeoutError,!0,t,i,n);if(e instanceof Uo)throw new Qo(r,e.message,{code:e.statusCode,text:"Playlist Network Error"},!1,t,i,n);throw e}))}function Xo(t,i){return e=>e.pipe(Wi(e=>{if(e instanceof Ho)throw new qo(i,"Timeout",G.FragmentTimeoutError,!0,t,e.stats);if(e instanceof Uo)throw new qo(i,e.message,{code:e.statusCode,text:"Fragment Network Error"},!1,t);throw e}))}function Jo(e){var t=e.type,i=e.liveOrEvent;let r="VOD";"EVENT"===t&&i?r="EVENT":t&&0!==t.length&&"LIVE"!==t||!i||(r="LIVE"),e.type!==r&&(e.type=r)}function Zo(e,t,i,r,n){r=el(e,t,r);return i.load(e,r).pipe(Wi(e=>e instanceof Uo&&e.isAuthOrCorsError?Lr(new Uo(`Tried to recover via customUrl, but got auth or cors error: originalStatus=${n.statusCode} retryStatus=${e.statusCode}`,e.statusCode)):Lr(e)))}function el(e,t,i){var r=e["extendMaxTTFB"],{maxLoadTimeMs:n,maxTimeToFirstByteMs:e}=t,n=(null!=n?n:0)-(performance.now()-i),i=z(r)&&0<r?r:e-(performance.now()-i);return Object.assign(Object.assign({},t),{maxLoadTimeMs:n,maxTimeToFirstByteMs:i})}class tl extends t{trigger(e,t){try{this.emit(e,e,t),"hlsFragLoadProgress"!==e.toString()&&(("hlsInternalError"===e||"hlsError"===e)&&t&&t.length&&JSON.stringify(t[0],["fatal","details","reason"]),e.toString())}catch(e){}}}class il{constructor(e,t){this.target=e,this._this=t}eventWithOptions(e,t,i,r=this._this){let n;return n=t?Nn(this.target,e,t):Nn(this.target,e),this.target instanceof tl&&(n=n.pipe(sr(([,e])=>e))),i&&(r&&(i=i.bind(r)),n=n.pipe(cn(i))),n}event(e,t,i=this._this){return this.eventWithOptions(e,void 0,t,i)}listen(e,t,i,r=this._this){return this.event(e,i,r).pipe(dn(t)).subscribe()}}function rl(e,t){return new il(e,t)}function nl(e,t,i){var r;return{currentTarget:null!==(r=null==i?void 0:i.currentTarget)&&void 0!==r?r:e,target:null!==(i=null==i?void 0:i.target)&&void 0!==i?i:e,type:t}}const al=/(\d+)-(\d+)\/(\d+)/,sl=/^CDN-Server:/im,ol=/^Age/im;function ll(g,y){return new oi(function(t){const e=g["extendMaxTTFB"],{maxTimeToFirstByteMs:i,maxLoadTimeMs:r}=y,n=new XMLHttpRequest,a={trequest:performance.now(),tfirst:NaN,tload:NaN,loaded:0,total:NaN,complete:!1},s=rl(n),o=s.event("progress").pipe(tr(Cn),sr(function(e){return isNaN(a.tfirst)&&(a.tfirst=performance.now()),a.loaded=e.loaded,e.lengthComputable&&(a.total=e.total),e.target}),_r(e=>3<=e.readyState),tn()),l=Vn(s.event("readystatechange").pipe(tr(Cn),sr(e=>e.target),cn(e=>{isNaN(a.tfirst)&&3<=e.readyState&&(a.tfirst=performance.now())})),o).pipe(_r(e=>4<=e.readyState),kr(1),on(function(e){if(a.complete=!0,200<=e.status&&e.status<300){a.tload=performance.now(),a.contentType=e.getResponseHeader("Content-Type")||void 0;var t=e.getAllResponseHeaders();if(y.reportCDNServer&&sl.test(t)&&(a.cdnServer=e.getResponseHeader("CDN-Server")||void 0),a.contentLength=y.forceContentLenCheckIfNoHeader?function(e){let t;const i=e.getResponseHeader("Content-Encoding"),r=e.getResponseHeader("Transfer-Encoding"),n=!i||i&&"identity"===i.toLowerCase(),a=!r||r&&"identity"===r.toLowerCase();return n&&a&&(t=function(e){e=al.exec(e||"");return e?parseInt(e[2])-parseInt(e[1])+1:void 0}(e.getResponseHeader("Content-Range")),z(t)||(t=parseInt(null!==(e=e.getResponseHeader("Content-Length"))&&void 0!==e?e:""))),t}(e):void 0,i=e,(r=g).collectServerInstanceInfo&&(r.serverInstanceInfo={},r.collectServerInstanceInfo.forEach(e=>{var t=i.getResponseHeader(e);t&&r.serverInstanceInfo&&(r.serverInstanceInfo[e]=t)})),"arraybuffer"===g.responseType)a.loaded=e.response.byteLength;else if(a.loaded=e.responseText.length,ol.test(t)){const g=e.getResponseHeader("Age");a.age=g?parseInt(g):NaN}else a.age=NaN;if(a.total=a.loaded,g.checkContentLength&&(0===a.total||z(a.contentLength)&&a.total!=a.contentLength))throw new Uo("Network error",e.status);return nr(Pr([e,a]),Cn)}var i,r;throw new Uo("Network error",e.status)}),Wi(function(e){if(e instanceof v)throw e;if(e instanceof mn)throw new Ho(e.message,a);if(!(e instanceof Uo))throw new Uo(e.message,G.XhrError.code);throw e})),d=l.subscribe(t),{url:u,method:c,byteRangeOffset:h,responseType:p,body:m}=g;g.mimeType&&n.overrideMimeType(g.mimeType);try{const y=g.xhrSetup;n.open(c,g.url,!0),y&&y(n,u)}catch(e){throw new Uo(e.message,n.status)}if(n.responseType=p,h&&z(h.start)&&z(h.end)&&0<=h.start&&h.end>h.start){const{start:g,end:y}=h;n.setRequestHeader("Range",`bytes=${g}-${y-1}`)}if(g.headers)for(const[y,t]of Object.entries(g.headers))n.setRequestHeader(y,t);if("POST"===c&&m?n.send(m):n.send(),isFinite(i)&&0<i){const g=z(e)&&0<e?e:i;d.add(Ki(g).pipe(on(()=>(z(a.tfirst)||t.error(new Ho("TTFB Timeout",a)),Cr))).subscribe())}z(r)&&0<r&&d.add(Ki(r).pipe(on(()=>Lr(()=>new Ho("Max load timeout",a)))).subscribe(t));const f=g.onProgress;if(null!=f&&f.cb){const y=f["samplePeriodMs"];let e;e=z(f.samplePeriodMs)&&z(y)&&0<y?Zr(f.samplePeriodMs,Cn).pipe(sr(()=>n)):o,d.add(e.pipe(un(e=>{const{getData:t,cb:i}=f;return!i(g.url,e.status,a,t?e.response:void 0)}),Wi(e=>(t.error(e),Cr))).subscribe())}return()=>{n.abort(),d.unsubscribe()}})}function dl(t){return e=>e.pipe(sr(e=>{return[e.data.response.data,e.stats,null!==(e=t.serverInstanceInfo)&&void 0!==e?e:{}]}))}function ul(t,i,r){const n=Object.assign(Object.assign({},t),{method:"GET",responseType:"arraybuffer"});if(ao(n.url))return r.load(n,i).pipe(dl(n));{const t=performance.now(),e=ll(n,i).pipe(sr(([e,t])=>{return[e.response,t,null!==(t=n.serverInstanceInfo)&&void 0!==t?t:{}]}));return e.pipe(Wi(e=>{if(e instanceof Uo&&e.isAuthOrCorsError)return Zo(n,i,r,t,e).pipe(dl(n));throw e}))}}const cl=(r,e,t,i,n,a,s,o,l)=>{var{relativeUrl:d,byteRangeOffset:u,keyTagInfo:c,iframe:h,isInitSegment:p}=r,m=no.buildAbsoluteURL(e,d,{alwaysNormalize:!0}),d=null!==(e=null==c?void 0:c.method)&&void 0!==e?e:"NONE",{start:c,end:e}=null!=u?u:{},i=Go({url:m},i);let f,g=c,y=e,v=!1,S=z(c)||z(e)?u:void 0;if("AES-128"===d&&e&&(h||p)){const r=e-(null!=c?c:0);r%16&&(y=e+(16-r%16)),z(c)&&0!==c&&(v=!0,g=c-16),z(g)&&z(y)&&(S={start:g,end:y})}return o&&z(r.mediaSeqNum)&&r.mediaOptionType===Ys.Variant&&(f=[],null===(o=i.reportHTTPResponseHeaders)||void 0===o||o.forEach(function(e){po.includes(e)&&Array.isArray(f)&&f.push(e)}),0===f.length&&(f=void 0)),ul({url:m,byteRangeOffset:S,checkContentLength:!0,extendMaxTTFB:l,collectServerInstanceInfo:f,onProgress:s,xhrSetup:t.xhrSetup},i,n).pipe(sr(([e,t,i])=>{if(v){const t=e;r.keyTagInfo&&(r.keyTagInfo.iv=new Uint8Array(t.slice(0,16))),e=t.slice(16)}return{mediaFragment:r,loadedData:e,bwSample:t,serverInfo:i}}),Xo(r,!1))},hl={search:function(e,t){let i,r,n=0,a=(null==e?void 0:e.length)-1;for(;n<=a;){var s=t(r=e[i=(n+a)/2|0]);if(0<s)n=i+1;else{if(!(s<0))return r;a=i-1}}}};var pl,ml,fl,gl,yl,vl=hl;(Ea=pl=pl||{})[Ea.Preroll=0]="Preroll",Ea[Ea.Midroll=1]="Midroll",Ea[Ea.Postroll=2]="Postroll",(Ds=ml=ml||{})[Ds.None=0]="None",Ds[Ds.Out=1]="Out",Ds[Ds.In=2]="In",Ds[Ds.InOut=3]="InOut",(xs=fl=fl||{})[xs.None=0]="None",xs[xs.Skip=1]="Skip",xs[xs.Jump=4]="Jump",xs[xs.SkipJump=5]="SkipJump";class Sl extends ya{constructor(e){super(e),this.store=e,this.interstitials$=this.select("interstitials"),this.pastInterstitials$=this.select("pastInterstitials"),this.interstitialAssets$=this.select("interstitialAssets"),this.activeInterstitialId$=this.select("activeInterstitialId"),this.activeInterstitialAssetId$=this.select("activeInterstitialAssetId"),this.playingInterstitialId$=this.select("playingInterstitialId"),this.playingInterstitialAssetId$=this.select("playingInterstitialAssetId")}getInterstitialForId(t){var e;return null!==(e=null===(e=this.getValue())||void 0===e?void 0:e.interstitials.find(e=>e.identifier===t))&&void 0!==e?e:null}getInterstitialAssetForId(t){var e;return null!==(e=null===(e=this.getValue())||void 0===e?void 0:e.interstitialAssets.find(e=>e.identifier===t))&&void 0!==e?e:null}get interstitials(){var e;return null!==(e=null===(e=this.getValue())||void 0===e?void 0:e.interstitials)&&void 0!==e?e:[]}get pastInterstitials(){var e;return null!==(e=null===(e=this.getValue())||void 0===e?void 0:e.pastInterstitials)&&void 0!==e?e:[]}get interstitialAssets(){var e;return null!==(e=null===(e=this.getValue())||void 0===e?void 0:e.interstitialAssets)&&void 0!==e?e:[]}get activeInterstitialId(){var e;return null!==(e=null===(e=this.getValue())||void 0===e?void 0:e.activeInterstitialId)&&void 0!==e?e:null}get activeInterstitialAssetId(){var e;return null!==(e=null===(e=this.getValue())||void 0===e?void 0:e.activeInterstitialAssetId)&&void 0!==e?e:null}get playingInterstitialId(){var e;return null!==(e=null===(e=this.getValue())||void 0===e?void 0:e.playingInterstitialId)&&void 0!==e?e:null}get playingInterstitialAssetId(){var e;return null!==(e=null===(e=this.getValue())||void 0===e?void 0:e.playingInterstitialAssetId)&&void 0!==e?e:null}get playableInterstitials$(){return this.interstitials$.pipe(sr(e=>e.filter(e=>this.canPlayInterstitial(e))))}get playableInterstitials(){return this.interstitials.filter(e=>this.canPlayInterstitial(e))}get playableInterstitialsForSeek(){return this.interstitials.filter(e=>!e.hasPlayed||e.hasPlayed&&!e.playOnce).reverse()}get realCurrentTimeOffsetMap(){var e;return null!==(e=null===(e=this.getValue())||void 0===e?void 0:e.realCurrentTimeOffsetMap)&&void 0!==e?e:{}}canPlayInterstitial(e){var t=!e.hasPlayed||e.hasPlayed&&!e.playOnce,e=this.pastInterstitials.includes(e.identifier);return!(!t||e)}}class Il extends ha{constructor(){super({interstitials:[],interstitialAssets:[],pastInterstitials:[],activeInterstitialId:null,activeInterstitialAssetId:null,playingInterstitialId:null,playingInterstitialAssetId:null,realCurrentTimeOffsetMap:{}},{name:"interstitials",producerFn:_s,resettable:!0})}}class bl{constructor(e){this.store=e,this._interstitialQuery=new Sl(e)}get interstitialQuery(){return this._interstitialQuery}addInterstitials(i){this.store.update(e=>{var t=i.filter(t=>!e.interstitials.find(e=>e.identifier===t.identifier));e.interstitials=ht(e.interstitials,t)})}updateInterstitial(t,i){this.store.update(({interstitials:e})=>({interstitials:An(e,t,i,"identifier")}))}removeInterstitials(t){this.store.update(({interstitials:e})=>({interstitials:En(e,t,"identifier")}))}addInterstitialToPastEvents(t){this.store.update(({pastInterstitials:e})=>({pastInterstitials:function(e,t,i,r){var n=3<arguments.length&&void 0!==r?r:vn,a=Tn(i);return e.some(e=>a?e[n]===t:e===t)?An(e,t,i,n):ht(e,a?lt(lt({},i),{},{[n]:t}):i)}(e,t,t,"identifier")}))}removeInterstitialsFromPastEvents(t){this.store.update(({pastInterstitials:e})=>({pastInterstitials:En(e,t,"identifier")}))}removeInterstitialsFromPastEventsFromTime(r){var e=this._interstitialQuery.interstitials.reduce((e,t)=>{var i;return E(null!==(i=t.startTime)&&void 0!==i?i:{baseTime:0,timescale:1})>=r&&t.cueType===pl.Midroll&&e.push(t.identifier),e},new Array);this.removeInterstitialsFromPastEvents(e)}addInterstitialAsset(t){this.store.update(e=>{e.interstitialAssets.find(e=>e.identifier===t.identifier)||(e.interstitialAssets=ht(e.interstitialAssets,t))})}updateInterstitialAsset(t,i){this.store.update(({interstitialAssets:e})=>({interstitialAssets:An(e,t,i,"identifier")}))}removeInterstitialAssets(t){this.store.update(({interstitialAssets:e})=>({interstitialAssets:En(e,t,"identifier")}))}setActiveInterstitialId(t){this.store.update(e=>{t&&!e.interstitials.find(e=>e.identifier===t)||(e.activeInterstitialId=t)})}setPlayingInterstitialId(t){this.store.update(e=>{t&&!e.interstitials.find(e=>e.identifier===t)||(e.playingInterstitialId=t)})}setActiveInterstitialAssetId(t){this.store.update(e=>{t&&!e.interstitialAssets.find(e=>e.identifier===t)||(e.activeInterstitialAssetId=t)})}setPlayingInterstitialAssetId(t){this.store.update(e=>{t&&!e.interstitialAssets.find(e=>e.identifier===t)||(e.playingInterstitialAssetId=t)})}updateRealCurrentTimeOffsetMap(t,i){this.store.update(e=>{e.realCurrentTimeOffsetMap[t]=i})}destroy(){this.store.destroy()}reset(){this.store.reset()}}function Tl(e){return new $(U.MEDIA_ERROR,V.INTERSTITIAL_ASSET_LIST_PARSING_ERROR,!1,e,G.FormatError)}function El(){return e=>e.pipe(sr(e=>({responseText:e.data.response.data.toString(),responseURL:e.data.response.uri,stats:e.stats})))}const Al=(t,i,e,r,n)=>{const a=Object.assign(Object.assign({},t),{method:"GET",responseType:"text",extendMaxTTFB:e});if(ao(a.url))return r.load(a,i).pipe(El());{const t=performance.now();return ll(a,i).pipe(sr(([e,t])=>({responseText:e.responseText,responseURL:e.responseURL,stats:t})),Wi(e=>{if(e instanceof Uo&&e.isAuthOrCorsError)return Zo(a,i,r,t,e).pipe(El());throw e}))}};function Ol(e){let t=0;return null==e||!e.resumptionOffset||z(e=E(e.resumptionOffset))&&(t=e),t}function wl(e){e=/interstitial:(.*):asset/.exec(e);return e&&1<e.length?e[1]:null}function Rl(e,i){return function(e){if(null==e||e.length<1)return{element:null,index:-1};var t=e.findIndex(e=>e.itemId===i);return-1<t?{element:e[t],index:t}:{element:null,index:-1}}(e)}function Cl(e){return!!e&&-1===e.indexOf("interstitial")}function kl(e){var{method:t,isEncrypted:i,uri:r,format:n,formatversions:a}=e;return{method:t,isEncrypted:i,uri:r,format:n,formatversions:a,iv:e.ivBuf?new Uint8Array(e.ivBuf):null,keyId:e.keyIdBuf?new Uint8Array(e.keyIdBuf):null,key:e.keyBuf?new Uint8Array(e.keyBuf):null,pssh:e.psshBuf?new Uint8Array(e.psshBuf):null}}function Ml(e){return null!==(e=null==e?void 0:e.mediaOptionKeys.map(e=>e.mediaOptionId))&&void 0!==e?e:[]}(t=gl=gl||{}).MustRequestResponse="MustRequestResponse",t.WaitingForKeyResponse="WaitingForKeyResponse",t.GotKeyResponse="GotKeyResponse";class Pl extends Vo{constructor(e,t,i,r=[]){super(V.KEY_LOAD_TIMEOUT,!1,e,i,!0),this.keyuri=t,this.response=i,this.mediaOptionIds=r}}(Ea=yl=yl||{})[Ea.InvalidState=0]="InvalidState",Ea[Ea.Abort=1]="Abort",Ea[Ea.OutputRestricted=2]="OutputRestricted",Ea[Ea.AlreadyFailedKey=3]="AlreadyFailedKey",Ea[Ea.HttpError=4]="HttpError",Ea[Ea.InternalError=5]="InternalError",Ea[Ea.LicenseServerError=6]="LicenseServerError",Ea[Ea.InsufficientCPC=7]="InsufficientCPC";class Ll extends Vo{constructor(e,t,i,r,n,a=!1,s=[]){super(V.KEY_LOAD_ERROR,a,e,i,!1),this.keyuri=t,this.isOkToRetry=r,this.keyErrorReason=n,this.mediaOptionIds=s}}class xl extends v{constructor(e,t,i,r){super(U.OTHER_ERROR,V.KEY_SYSTEM_GENERIC_ERROR,!0,e,i),this.keyuri=t,this.response=i,this.keysystemstring=r}}function Dl(e,t){return e instanceof Ll?new Ll(e.message,e.keyuri,e.response,e.isOkToRetry,e.keyErrorReason,e.fatal,t):e instanceof Pl?new Pl(e.message,e.keyuri,e.response,t):e?new B(e.fatal,e.reason,G.ExceptionInKeyRequest,e.stack):void 0}const _l={id:"fairplaystreaming",systemStringPrefix:"com.apple.fps",keyFormatString:"com.apple.streamingkeydelivery",securityLevels:{AppleBaseline:0,AppleMain:1,Main:1,Baseline:0}},Nl={id:"playready",systemStringPrefix:"com.microsoft.playready",keyFormatString:"com.microsoft.playready",securityLevels:{SL2000:0,SL3000:1}},Fl={id:"widevine",systemStringPrefix:"com.widevine.alpha",keyFormatString:"urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed",securityLevels:{WIDEVINE_SOFTWARE:0,WIDEVINE_HARDWARE:1}};function Bl(e){return e.replace(/\+/g,"-").replace(/\//g,"_").replace(/\=+$/,"")}class Ul{static strToBase64Encode(e){return btoa(e)}static base64DecodeToStr(e){return atob(e)}static base64Encode(e){return btoa(String.fromCharCode(...e))}static base64UrlEncode(e){return Bl(Ul.base64Encode(e))}static base64Decode(e){return Uint8Array.from(atob(e),e=>e.charCodeAt(0))}}class Vl{static strToBase64Encode(e){return u.Buffer.from(e).toString("base64")}static base64DecodeToStr(e){return u.Buffer.from(e,"base64").toString()}static base64Encode(e){return u.Buffer.from(e).toString("base64")}static base64UrlEncode(e){return Bl(Vl.base64Encode(e))}static base64Decode(e){e=u.Buffer.from(e,"base64");return new Uint8Array(e.buffer,e.byteOffset,e.byteLength)}}var $l,Ql=void 0!==u.Buffer?Vl:Ul;const Kl={avc1:"video/mp4",avc3:"video/mp4",dvav:"video/mp4",dva1:"video/mp4",hev1:"video/mp4",hvc1:"video/mp4",dvh1:"video/mp4",dvhe:"video/mp4"},ql={mp4a:"audio/mp4","ac-3":"audio/mp4","ec-3":"audio/mp4"};function Hl(e){function t(e,t,i){var r=e[t];e[t]=e[i],e[i]=r}t(e,0,3),t(e,1,2),t(e,4,5),t(e,6,7)}function jl(e){const t=e.split(":");let i=null;if("data"===t[0]&&2===t.length){const e=t[1].split(";"),r=e[e.length-1].split(",");if(2===r.length){const t="base64"===r[0],n=r[1];i=t?(e.splice(-1,1),Ql.base64Decode(n)):function(e){const t=Y.strToUtf8array(e).subarray(0,16),i=new Uint8Array(16);return i.set(t,16-t.length),i}(n)}}return i}const Gl=function(e,t){const r={videoCapabilities:[],audioCapabilities:[]};return e&&e.forEach(e=>{var t,i=e.split(".")[0].trim();i in Kl&&(null===(t=r.videoCapabilities)||void 0===t||t.push({contentType:Kl[i]+";codecs="+e,robustness:""}))}),t&&t.forEach(e=>{var t,i=e.split(".")[0].trim();i in ql&&(null===(t=r.audioCapabilities)||void 0===t||t.push({contentType:ql[i]+";codecs="+e,robustness:""}))}),r};let zl={};class Wl{constructor(e,t="",i=null,r=null,n=[]){if(this.method=e,this.uri=t,this.iv=i,this.format=r,this.formatversions=n,this.key=null,this.keyId=null,this.pssh=null,this.isEncrypted=this.method&&"NONE"!==this.method,this.formatversions&&0!==this.formatversions.length||(this.formatversions=[1]),this.isEncrypted){const s=jl(this.uri);if(s)switch(r){case Nl.keyFormatString:{this.format=Nl.keyFormatString,this.pssh=s;const e=new Uint16Array(s.buffer,s.byteOffset,s.byteLength/2),t=String.fromCharCode.apply(null,Array.from(e)),i=t.substring(t.indexOf("<"),t.length),r=(new DOMParser).parseFromString(i,"text/xml").getElementsByTagName("KID")[0];if(r){var a=null;if(a=r.childNodes[0]?r.childNodes[0].nodeValue:r.getAttribute("VALUE")){const t=Ql.base64Decode(a).subarray(0,16);Hl(t),this.keyId=t}}break}case Fl.keyFormatString:this.format=Fl.keyFormatString,this.pssh=s,22<=s.length&&(this.keyId=s.subarray(s.length-22,s.length-6));break;case _l.keyFormatString:this.format=_l.keyFormatString;default:{let e=s.subarray(0,16);if(16!==e.length){const t=new Uint8Array(16);t.set(e,16-e.length),e=t}this.keyId=e;break}}if(!this.keyId||16!==this.keyId.byteLength){let e=zl[this.uri];if(!e){const t=Object.keys(zl).length%Number.MAX_SAFE_INTEGER;e=new Uint8Array(16),new DataView(e.buffer,12,4).setUint32(0,t),zl[this.uri]=e}this.keyId=e}}}get keyTagInfo(){var{method:e,isEncrypted:t,uri:i,iv:r,keyId:n,key:a,format:s,formatversions:o,pssh:l}=this;return{method:e,isEncrypted:t,uri:i,iv:r,keyId:n,key:a,format:s,formatversions:o,pssh:l}}static clearKeyUriToKeyIdMap(){zl={}}}const Yl=Pr(void 0),Xl=Pr(null);function Jl(e,t,i=1){return e.pipe(_r(t),kr(i))}(Ds=$l=$l||{}).NONE="NONE",Ds.GET_REQUEST_INFO="GET_REQUEST_INFO",Ds.GET_CHALLENGE="GET_CHALLENGE",Ds.GET_KEY_RESPONSE="GET_KEY_RESPONSE",Ds.PROCESS_LICENSE="PROCESS_LICENSE";class Zl{constructor(e,t,i,r){this.session=e,this.onkeystatuseschange=t,this.onkeymessage=i,this.logger=r,this.isClosing$=new qr(!1),this.closed$=new qr(!1);const n=rl(this.session);n.listen("keystatuseschange",this.isClosing$.pipe(_r(e=>!0===e)),this.onkeystatuseschange),n.listen("message",this.closed$.pipe(_r(e=>!0===e)),this.onkeymessage)}get isClosing(){return this.isClosing$.value}get isClosed(){return this.closed$.value}destroy(){this.isClosing$.next(!0);const e=this.session;return ar(e.remove().catch(e=>{}).then(()=>e.close()).catch(e=>{})).pipe(cn(()=>{this.isClosing$.next(!1),this.closed$.next(!0)}),Br(()=>{this.isClosing$.next(!1),this.closed$.next(!0)}))}}class ed{constructor(e,t=null){this.decryptdata=e,this._requestState$=new qr($l.NONE),this.destroy$=new Er,this.currentObservable=null,this.session=null,this.oldSessions=[],this.session=t}get requestState(){return this._requestState$.value}get onKeyRequestState$(){return this._requestState$}destroy(){this.destroy$.next()}abort(){var e;this.requestState!==$l.NONE&&(e=new Ll("Aborted",this.decryptdata.uri,G.KeySystemAbort,!0,yl.Abort),this.error(e))}setKeyRequestState(e){if(this.currentObservable){const t=new Ll(`Unexpected state transition ${this.requestState}->${e}`,this.decryptdata.uri,G.KeySystemUnexpectedStateTransition,!0,yl.InvalidState);this.error(t)}this._requestState$.next(e);const t=new Hr;return e===$l.NONE?(t.complete(),this.currentObservable=null):this.currentObservable=t,t}resolveState(e,t){if(!this.currentObservable)return!1;if(e!==this.requestState){const t=new Ll(`Unexpected state ${this.requestState} != ${e}`,this.decryptdata.uri,G.KeySystemUnexpectedState,!0,yl.InvalidState);return this.error(t),!1}if(t instanceof Error)return this.error(t),!1;{const e=this.currentObservable;return this.currentObservable=null,e.next(t),e.complete(),!0}}error(e){if(this.currentObservable){const t=this.currentObservable;this.currentObservable=null,t.error(e)}this.setKeyRequestState($l.NONE)}}function td(e){return`uri=${f(e.uri)} keyId=${xe(e.keyId)}`}class id{constructor(e,t,i,r,n,a,s,o,l){this.mediaKeys=e,this.systemString=t,this.config=i,this.eventEmitter=r,this.useSingleKeySession=n,this.sessionHandler=a,this.customUrlLoader=s,this.ksQuery=o,this.logger=l,this.destroy$=new Er,this.setCert=!1,this.certificate$=new qr(null),this.setCertSubject=new Hr,this._keyStatusChange$=new Er,this.isDestroying=!1,this.shouldDestroyMediaKeys=!i.maintainMediaKeysBetweenSessions,this.sessions=[],this.keyIdToKeyInfo={},this.keyUriToKeyInfo={},this.sessionIdToKeyUri={},this.setCertSubject.next(!1),this.setCertSubject.complete(),this.onkeystatuseschange=this.handleKeyStatusesChange.bind(this),this.onkeymessage=this.handleKeyMessage.bind(this)}get keyStatusChange$(){return this._keyStatusChange$}destroy(){this.isDestroying=!0,this.destroy$.next();for(const e of Object.values(this.keyIdToKeyInfo))this._abortKeyRequest(e);const e=this.sessions.map(e=>e.destroy()),t=Un(()=>0===e.length,Yl,Ln(e)).pipe(Mr(void 0),Br(()=>{this.keyIdToKeyInfo={},this.keyUriToKeyInfo={},this.sessionIdToKeyUri={}}));return Wl.clearKeyUriToKeyIdMap(),t}setServerCertificate(e=new ArrayBuffer(0)){return this.needsCert?(0<e.byteLength&&this.certificate$.next(e),Jl(this.certificate$,e=>null!=e).pipe(fn(1e4)).pipe(on(e=>this.setCert?Pr(!0):this.setCertSubject.isStopped?(this.setCertSubject=new Hr,null===e?this.setCertSubject:ar(this.mediaKeys.setServerCertificate(e)).pipe(cn(e=>{e=void 0===e||e;this.setCert=e,this.setCertSubject.next(e),this.setCertSubject.complete()}),Wi(e=>(this.setCert=!1,this.setCertSubject.error(e),Yl)),on(()=>this.setCertSubject))):this.setCertSubject),Wi(e=>{throw e}))):Pr(!0)}ensureKeyContext(e){var t=e.uri;this.keyUriToKeyInfo[t]||(this.keyUriToKeyInfo[t]=new ed(e));const i=this.keyUriToKeyInfo[t];if(i.session)return i;if(this.useSingleKeySession&&0<this.sessions.length)return i.session=this.sessions[0].session,i;t=this.mediaKeys.createSession();return t?this.sessions.push(new Zl(t,this.onkeystatuseschange,this.onkeymessage,this.logger)):this.logger.error(`${this.systemString} FAIL: could not create MediaKeysSession`),i.session=t,i}createDummySession(){var e=this.mediaKeys.createSession();e?this.sessions.push(new Zl(e,this.onkeystatuseschange,this.onkeymessage,this.logger)):this.logger.error(`${this.systemString} FAIL: could not create MediaKeysSession`)}startKeyRequest(i){const r=i.uri,n=this.ensureKeyContext(i);if(null==n||!n.session)return Lr(new xl("Could not create key session",i.uri,G.KeySystemFailedToCreateSession,this.systemString));let e="";return null!==i.keyId&&(e=Y.utf8arrayToStr(i.keyId)),this.keyIdToKeyInfo[e]=n,Ln([this.getKeyRequestInfo(n),this.setServerCertificate()]).pipe(sr(e=>e[0]),on(e=>{var t;return null===(t=this.sessionHandler)||void 0===t||t.licenseChallengeSubmitted({keyuri:r,keyFormat:this.systemString}),this.generateLicenseChallenge(n,e).pipe(Wi(e=>{var t;throw this.logger.error(`${this.systemString} generateLicenseChallenge Failed ${e.message} ${td(i)}`),null===(t=this.sessionHandler)||void 0===t||t.licenseChallengeError({keyuri:r}),e}))}),on(e=>{var t;if(0===e.length)throw new Ll("empty license",r,G.KeySystemFailedToGenerateLicenseRequest,!0,yl.InternalError);return null===(t=this.sessionHandler)||void 0===t||t.licenseChallengeCreated({keyuri:r,cdmVersion:this.cdmVersion}),this.getKeyRequestResponse(n,e)}),on(e=>{var t;return null===(t=this.sessionHandler)||void 0===t||t.licenseResponseSubmitted({keyuri:r}),this.handleParsedKeyResponse(n,e).pipe(Wi(e=>{var t;throw this.logger.error(`${this.systemString} ParseKeyResponse Failed ${td(i)} error=${e.message}`),null===(t=this.sessionHandler)||void 0===t||t.licenseResponseError({keyuri:r}),e}))}),sr(()=>{var e;return null===(e=this.sessionHandler)||void 0===e||e.licenseResponseProcessed({keyuri:r}),n.setKeyRequestState($l.NONE),this.removeSessions(n.decryptdata,!1).subscribe(),i}),Wi(e=>{throw this.handleKeyExchangeError(n,e),e}),Br(()=>{this._abortKeyRequest(n)}))}_abortKeyRequest(e){var t,i;e&&(i=e.decryptdata.uri,e.decryptdata.keyId&&Y.utf8arrayToStr(e.decryptdata.keyId),e.requestState!==$l.NONE&&(null===(t=this.sessionHandler)||void 0===t||t.keyAborted({keyuri:i})),e.abort())}handleKeyExchangeError(e,t){e.error(t),e.decryptdata.keyId&&Y.utf8arrayToStr(e.decryptdata.keyId)}removeKey(e){return this.removeKeyInternal(e)}removeKeyInternal(t){const i=this.keyUriToKeyInfo[t.uri];if(i&&i.session){var r=i.session;i.abort(),i.destroy();let e="";return i.decryptdata.keyId&&(e=Y.utf8arrayToStr(i.decryptdata.keyId)),delete this.keyIdToKeyInfo[e],delete this.keyUriToKeyInfo[t.uri],this.removeSession(r)}return Yl}removeSessions(e,t){const i=this.keyUriToKeyInfo[e.uri];if(i){const r=i.oldSessions.map(e=>this.removeSession(e));return i.oldSessions=[],Un(()=>0===r.length,Yl,Ln(r)).pipe(on(()=>t?this.removeKeyInternal(e):Yl))}return Yl}removeSession(t){const e=this.sessions.findIndex(e=>e.session===t),i=this.sessions[e];return-1<e&&this.sessions.splice(e,1),delete this.sessionIdToKeyUri[t.sessionId],i?i.destroy():Yl}getKeyRequestInfo(e){var t=e.decryptdata,i=t.uri,e=e.setKeyRequestState($l.GET_REQUEST_INFO);return this.eventEmitter.trigger(N.KEY_REQUEST_STARTED,{keyuri:i,appItemIds:this.ksQuery.getAppItemIds(i),decryptdata:t,timestamp:Date.now()}),e}setKeyRequestInfo(e,t){const i=this.keyUriToKeyInfo[e];return!!i&&i.resolveState($l.GET_REQUEST_INFO,t)}sanitizeRequest(e){return e}generateLicenseChallengeInternal(t,e,i){const r=t.decryptdata,n=t.session,a=r.uri,s=r.keyId;let o;if(null===n)return this.logger.error("key session is null, this should not happen"),Lr(new xl("key session is null",a,G.KeySystemInternalError,r.format));var l=t.setKeyRequestState($l.GET_CHALLENGE);if(n.generateRequestPromise)o=nr(n.generateRequestPromise,Cn).pipe(on(()=>this.generateRequestInitialized(t,"usable"===i)));else{const i=this.generateInitData(null!==s?s:new Uint8Array,r,e);n.generateRequestPromise=n.generateRequest(i.initDataType,null!==i.initData?i.initData:new Uint8Array),o=nr(n.generateRequestPromise,Cn).pipe(cn(()=>{this.sessionIdToKeyUri[n.sessionId]=a}),Wi(e=>{throw new xl(e.message,t.decryptdata.uri,G.KeySystemFailedToGenerateLicenseRequest,this.systemString)}))}return Ln([l,o]).pipe(sr(e=>new Uint8Array(e[0])))}generateLicenseChallenge(e,t){const i=e.decryptdata,r=e.session,n=i.uri,a=i.keyId;if(null===r)return this.logger.error("key session is null, this should not happen"),Lr(new xl("key session is null",f(n),G.KeySystemInternalError,i.format));let s,o;if(Y.utf8arrayToStr(a),e.licenseChallenge&&e.resolveState($l.GET_CHALLENGE,e.licenseChallenge),t=this.sanitizeRequest(t),e.requestInfo=t,this.systemString===Nl.systemStringPrefix){const e=new Uint8Array(a);Hl(e),s=r.keyStatuses.get(e)}else s=r.keyStatuses.get(null!==a?a:new Uint8Array);switch(s){case"status-pending":case"usable":case"expired":case void 0:o=this.generateLicenseChallengeInternal(e,t,s);break;default:o=Lr(new xl(`Bad internal state state=${s}`,n,G.KeySystemUnexpectedState,this.systemString))}return o}setParsedResponse(e,t){const i=this.keyUriToKeyInfo[e];i&&i.resolveState($l.GET_KEY_RESPONSE,t)}handleKeyStatusesChange(e){e.target.keyStatuses.forEach((e,t,i)=>{t=new Uint8Array(t);this.systemString===Nl.systemStringPrefix&&Hl(t);t=Y.utf8arrayToStr(t),t=this.keyIdToKeyInfo[t];t&&this.handleKeyStatusForKey(e,t)})}handleKeyStatusForKey(e,t){if(t){var i=t.decryptdata,r=i.uri;switch(e){case"internal-error":this.logger.error(`${this.systemString} internal-error for key ${td(i)}`),this._signalError(t,new Ll("Got internal error from key system",r,G.KeySystemInternalError,!1,yl.InternalError));break;case"usable":t.requestState===$l.PROCESS_LICENSE&&t.resolveState($l.PROCESS_LICENSE,void 0);break;case"output-restricted":t.session&&this.removeSession(t.session).pipe(dn(this.destroy$)).subscribe(),this._signalError(t,new Ll("output-restricted",r,G.KeySystemOutputRestricted,!1,yl.OutputRestricted));break;case"expired":this._signalRenewal(t)}}}_scheduleRenewal(e,t){Ki(t).pipe(cn(()=>this._signalRenewal(e)),dn(Yr(e.destroy$,this.destroy$,Jl(e.onKeyRequestState$,e=>e===$l.GET_REQUEST_INFO)))).subscribe()}_signalRenewal(e){this._keyStatusChange$.next({decryptdata:e.decryptdata,status:"needs-renewal"})}_signalError(e,t){this._keyStatusChange$.next({decryptdata:e.decryptdata,status:"error",error:t}),e.error(t)}}const rd="org.w3.clearkey",nd={id:"clearkey",systemStringPrefix:rd,keyFormatString:rd,securityLevels:{NONE:0}},ad=["clearkey","fairplaystreaming","playready","widevine"],sd={initDataTypes:["keyids","cenc"]};function od(){return 1}var ld,dd;(xs=[{key:"call",value:function(e,t){return t.subscribe(e)}}])&&function(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}(ud.prototype,xs);function ud(e){var t;!function(e){if(!(e instanceof ud))throw new TypeError("Cannot call a class as a function")}(this),t=void 0,"tag"in this?Object.defineProperty(this,"tag",{value:t,enumerable:!0,configurable:!0,writable:!0}):this.tag=t,this.tag=e}const cd={initDataTypes:["cenc"]},hd=new Uint8Array([148,206,134,251,7,255,79,67,173,184,147,210,250,150,140,162]);(t=ld=ld||{})[t.CENC=1667591779]="CENC",t[t.CBCS=1667392371]="CBCS",dd=dd||{},dd[dd.ISOFFLINE=2]="ISOFFLINE";class pd extends id{constructor(e,t,i,r,n,a,s,o,l){super(e,t,i,r,n,a,s,o,l),this._hasSetRenewal=!1}static get systemId(){return hd}static get requestAccessConfig(){return cd}get needsCert(){return!0}sanitizeRequest(e){return{assetId:e&&e.assetId?new Uint8Array(e.assetId):void 0,ssc:e&&e.ssc?new Uint8Array(e.ssc):void 0,sessionId:e&&e.sessionId?e.sessionId:void 0,isOffline:!(!e||!e.isOffline)}}_scheduleRenewal(e,t){this.useSingleKeySession?this._hasSetRenewal||(this._hasSetRenewal=!0,Ki(t).pipe(cn(()=>{var e=Object.values(this.keyUriToKeyInfo)[0];e&&this._signalRenewal(e)}),Br(()=>{this._hasSetRenewal=!1}),dn(this.destroy$)).subscribe()):super._scheduleRenewal(e,t)}handleParsedKeyResponse(t,e){var i=t.decryptdata.uri,r=e.statusCode,n=e.ckc&&0!==e.ckc.byteLength?e.ckc:e.license&&0!==e.license.byteLength?e.license:void 0;if(0===r&&!n)return Lr(new Ll("License request resulted in HTTP Error",i,{code:r,text:"HTTP Error"},!0,yl.HttpError));if(0!==r)return Lr(void 0===r?new Ll("License server responded with error code: undefined",i,{code:0,text:"Server Error, undefined status code"},!1,yl.LicenseServerError):new Ll("License server responded with error",i,{code:r,text:"Server Error"},!1,yl.LicenseServerError));if(!n)return Lr(new Ll("License server responded with invalid license",i,{code:r,text:"Invalid license"},!1,yl.LicenseServerError));const a=e.renewalDate,s=new Date,o=void 0!==a&&a>s?a.getTime()-s.getTime():0;0<o&&o<Math.pow(2,31)&&this._scheduleRenewal(t,o);const l=this.makeProcessLicenseRequestMessage(t,n,o),d=t.session;if(null===d)return this.logger.error("Key session is null"),Lr(new xl("Key session is null",i,G.InternalError,this.systemString));i=ar(d.update(l)).pipe(cn(()=>{var e=t.decryptdata.keyId,e=d.keyStatuses.get(e);this.handleKeyStatusForKey(e,t)}),Wi(e=>{throw new xl(e.message,t.decryptdata.uri,G.KeySystemFailedToUpdateSession,this.systemString)}));return Ln([t.setKeyRequestState($l.PROCESS_LICENSE),i]).pipe(Mr(void 0))}makeKeyRequests(e){const t=[];for(const i of e){const e=i.decryptdata,r=i.requestInfo,n=e.keyId;t.push({keyId:n||new Uint8Array,assetId:r&&r.assetId?r.assetId:new Uint8Array,ssc:r&&r.ssc?r.ssc:new Uint8Array,versionList:e.formatversions||[]})}return t}getSchemeAndFlags(e,t){e="ISO-23001-7"===e.method?ld.CENC:ld.CBCS;let i=0;return t&&(i|=dd.ISOFFLINE),{scheme:e,flags:i}}generateInitData(e,t,i){var{scheme:r,flags:n}=this.getSchemeAndFlags(t,i.isOffline),i=this.makeKeyRequests([{decryptdata:t,requestInfo:i}]);return{initData:this.makeFpsKeySystemInitData(r,n,i),initDataType:"cenc"}}generateRequestInitialized(t,e){od((f(t.decryptdata.uri),JSON.stringify(t.decryptdata.formatversions)));e=this.makeKeyRequestMessage(t,e);if(!e)return Lr(new Ll("Unable to generate request using existing keySession",t.decryptdata.uri,G.KeySystemFailedToGenerateLicenseRequest,!0,yl.InvalidState));const i=t.session;return null===i?(this.logger.error("Key is session is null"),Cr):ar(i.update(e)).pipe(cn(()=>{t.requestInfo=void 0}),Wi(e=>{throw od((this.systemString,f(t.decryptdata.uri),e.message)),new xl(e.message,t.decryptdata.uri,G.KeySystemFailedToGenerateLicenseRenewal,this.systemString)}))}getKeyRequestResponse(e,t){var i=e.decryptdata.uri,e=e.setKeyRequestState($l.GET_KEY_RESPONSE);return this.eventEmitter.trigger(N.LICENSE_CHALLENGE_CREATED,{keyuri:i,licenseChallenge:t,keysystem:this.systemString,appItemIds:this.ksQuery.getAppItemIds(i)}),e}resolveSPCPromise(e,t){e.resolveState($l.GET_CHALLENGE,t)}}const md=1919710053;function fd(e,t,i){if(!(i+4>e.byteLength)){t=t.getUint32(i);if(!((i+=4)+t>e.byteLength)){e=e.slice(i,i+t);return{pos:i+=t,data:e}}}}function gd(t){const i={},r=new DataView(t.buffer);let n=4;const a=r.getUint32(n);n+=4;for(let e=0;e<a&&n<t.byteLength&&!(n+16>t.byteLength);++e){const a=t.slice(n,n+16);if(n+=16,n+4>t.byteLength)break;var s=fd(t,r,n);if(!s)break;n=s.pos,i[Y.utf8arrayToStr(a)]=s.data}return i}function yd(e,t,i,r){var n=r?r.byteLength:0;return t.setUint32(i,n),n&&e.set(r,i+4),i+(4+n)}function vd(e){let t=4;for(const i of e)t+=28+(i.assetId?i.assetId.byteLength:0)+(i.ssc?i.ssc.byteLength:0)+(i.versionList?4*i.versionList.length:0);return t}function Sd(e,t,i,r){t.setUint32(i,r.length),i+=4;for(const n of r)if(e.set(n.keyId,i),i=yd(e,t,i+=16,n.assetId),i=yd(e,t,i,n.ssc),t.setUint32(i,n.versionList?n.versionList.length:0),i+=4,n.versionList)for(const e of n.versionList)t.setUint32(i,e),i+=4;return i}class Id extends pd{constructor(e,t,i,r,n,a,s,o){super(e,t,i,r,void 0===i.useMultipleKeySessions||!i.useMultipleKeySessions,n,a,s,o),this.offlineKeyExchange=!1,i.createDummySessionOnStart&&this.createDummySession()}makeProcessLicenseRequestMessage(e,t,i){t=new Uint8Array(t);return function(e,t){let i=0;for(const t of e)i+=24+t.ckc.byteLength;let r=0;const n=new Uint8Array(8+i),a=new DataView(n.buffer);t?a.setUint32(0,1868786531):a.setUint32(0,1667982195),a.setUint32(4,e.length),r+=8;for(const t of e)n.set(t.keyId,r),r+=16,a.setUint32(r,t.expirySec),r+=4,r=yd(n,a,r,t.ckc);return n}([{keyId:e.decryptdata.keyId||new Uint8Array,expirySec:i/1e3,ckc:t}],this.offlineKeyExchange)}makeFpsKeySystemInitData(e,t,i){this.isFlagOffline(t)&&(this.offlineKeyExchange=!0);i=function(e,t,i){var r=vd(i),n=0;const a=new Uint8Array(8+r),s=new DataView(a.buffer);return s.setUint32(n,e),s.setUint32(n+4,1<<24|16777215&t),n+=8,Sd(a,s,n,i),a}(e,t,i);return ge.pssh(Id.systemId,[],i)}isFlagOffline(e){return(e&dd.ISOFFLINE)===dd.ISOFFLINE}makeKeyRequestMessage(e){var t;return null!==(t=e.requestInfo)&&void 0!==t&&t.isOffline&&(this.offlineKeyExchange=!0),function(e,t){var i=vd(e),r=0;const n=new Uint8Array(4+i),a=new DataView(n.buffer);return t?a.setUint32(0,1868788331):a.setUint32(0,1668442994),r+=4,Sd(n,a,r,e),n}([{keyId:null!==(t=null===(t=null==e?void 0:e.decryptdata)||void 0===t?void 0:t.keyId)&&void 0!==t?t:new Uint8Array,assetId:null!==(t=null===(t=null==e?void 0:e.requestInfo)||void 0===t?void 0:t.assetId)&&void 0!==t?t:new Uint8Array,ssc:null!==(t=null===(t=null==e?void 0:e.requestInfo)||void 0===t?void 0:t.ssc)&&void 0!==t?t:new Uint8Array,versionList:null!==(e=null===(e=null==e?void 0:e.decryptdata)||void 0===e?void 0:e.formatversions)&&void 0!==e?e:[]}],this.offlineKeyExchange)}handleKeyMessage(e){if(!(e.message.byteLength<4)){const t=new Uint8Array(e.message),i=new DataView(e.message),r=i.getUint32(0);if(!this.isDestroying||r===md)switch(r){case 1667592820:break;case 1919837559:{const e=gd(t);for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t)){const e=this.keyIdToKeyInfo[t];e&&this._signalRenewal(e)}break}case 1936745331:{const e=gd(t);for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t)){const i=this.keyIdToKeyInfo[t],r=e[t];i&&r&&this.resolveSPCPromise(i,r)}break}case md:this._handleLicenseRelease(t);break;case 1667525993:{const e=fd(t,i,4);e&&(this.cdmVersion=Y.utf8arrayToStr(e.data));break}case 1869767536:{const e=fd(t,i,4);if(e){const t=e.data;this.eventEmitter.trigger(N.OFFLINE_FAIRPLAY_DEVICE_CAPS,{capability:t})}break}}}}_handleLicenseRelease(e){new DataView(e.buffer).getUint32(4),this.eventEmitter.trigger(N.LICENSE_RELEASED,{keysystem:this.systemString,itemId:"",releaseRecord:{}})}}Ea=Id;const bd={fpsd:Y.strToUtf8array("fpsd"),fpsi:Y.strToUtf8array("fpsi"),fpsk:Y.strToUtf8array("fpsk"),fkri:Y.strToUtf8array("fkri"),fkai:Y.strToUtf8array("fkai"),fkcx:Y.strToUtf8array("fkcx"),fkvl:Y.strToUtf8array("fkvl")};const Td={initDataTypes:["cenc"]},Ed=new Uint8Array([154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149]);class Ad extends id{constructor(e,t,i,r,n,a,s,o){super(e,t,i,r,!1,n,a,s,o),this.shouldDestroyMediaKeys=!0}static get systemId(){return Ed}static get requestAccessConfig(){return Td}get needsCert(){return!1}generateInitData(e,t){t=t.pssh;return{initData:ge.pssh(Ad.systemId,[],t),initDataType:"cenc"}}removeKey(e){return super.removeSessions(e,!0)}ensureKeyContext(e){const t=e.uri,i=this.keyUriToKeyInfo[t];return null!=i&&i.session&&(i.oldSessions.push(i.session),i.session=null),super.ensureKeyContext(e)}getKeyRequestResponse(e,t){var i=e.decryptdata.uri,r=e.setKeyRequestState($l.GET_KEY_RESPONSE);return this.eventEmitter.trigger(N.LICENSE_CHALLENGE_CREATED,{keyuri:i,licenseChallenge:t,keysystem:this.systemString,keyId:null!==e.decryptdata.keyId?e.decryptdata.keyId:new Uint8Array,appItemIds:this.ksQuery.getAppItemIds(i)}),r}generateRequestInitialized(e){var t=e.licenseChallenge;return e.requestInfo=void 0,e.resolveState($l.GET_CHALLENGE,void 0!==t?t:new Error("undefined challenge")),Yl}handleParsedKeyResponse(t,e){const i=t.decryptdata.uri,r=e.statusCode;if(0!==r)return z(r)?Lr(new Ll("License server responded with error",i,{code:r,text:"Server Error"},!1,yl.LicenseServerError)):Lr(new Ll("License server responded with error code: undefined",i,G.KeySystemInternalError,!1,yl.LicenseServerError));if(!e.license||!e.license.byteLength)return Lr(new Ll("License server responded with invalid license",i,{code:r,text:"Invalid license"},!1,yl.LicenseServerError));if(e.renewalDate){const i=e.renewalDate,r=new Date,n=i>r?i.getTime()-r.getTime():0;0<n&&n<Math.pow(2,31)&&this._scheduleRenewal(t,n)}const n=t.setKeyRequestState($l.PROCESS_LICENSE),a=t.session;return null===a?(this.logger.error("key session is null, this should not happen"),Yl):Ln([n,ar(a.update(e.license)).pipe(cn(()=>{t.resolveState($l.PROCESS_LICENSE,void 0)}),Wi(e=>{throw this.logger.error(`${this.systemString} FAIL: Failed to update with key response message=${e.message}`),new xl(e.message,t.decryptdata.uri,G.KeySystemFailedToUpdateSession,this.systemString)}))]).pipe(Mr(void 0))}handleKeyMessage(e){if(!this.isDestroying){const t=new DOMParser,i=new("utf16"===this.config.playReadyMessageFormat?Uint16Array:Uint8Array)(e.message.buffer||e.message),r=String.fromCharCode.apply(null,Array.from(i)),n=t.parseFromString(r,"application/xml").getElementsByTagName("PlayReadyKeyMessage")[0];if(n&&"LicenseAcquisition"===n.getAttribute("type")){const a=t.parseFromString(r,"application/xml").getElementsByTagName("Challenge")[0];if(a&&"base64encoded"===a.getAttribute("encoding")&&0!==a.childNodes.length){const s=Ql.base64Decode(null!==a.childNodes[0].nodeValue?a.childNodes[0].nodeValue:""),o=Y.utf8arrayToStr(s),l=t.parseFromString(o,"application/xml").getElementsByTagName("KID")[0];e=null,e=l.childNodes[0]?l.childNodes[0].nodeValue:l.getAttribute("VALUE"),e=Ql.base64Decode(null!==e?e:"").subarray(0,16);Hl(e);const d=this.keyIdToKeyInfo[Y.utf8arrayToStr(e)];d&&(d.licenseChallenge=s,d.resolveState($l.GET_CHALLENGE,s))}}}}}Ds=Ad;const Od={initDataTypes:["cenc","keyids"]},wd=new Uint8Array([237,239,139,169,121,214,74,206,163,200,39,220,213,29,33,237]),Rd={clearkey:nd,fairplaystreaming:_l,playready:Nl,widevine:Fl},Cd={clearkey:[["org.w3.clearkey",class extends id{constructor(e,t,i,r,n,a,s,o){super(e,t,i,r,!1,n,a,s,o)}static get requestAccessConfig(){return sd}get needsCert(){return!1}getKeyRequestResponse(e,t){return ul({url:e.decryptdata.uri,xhrSetup:this.config.xhrSetup},{maxLoadTimeMs:0,maxTimeToFirstByteMs:0,autoRetry:!1,timeoutRetry:null,errorRetry:null},this.customUrlLoader).pipe(sr(([e])=>{e=new Uint8Array(e);return{response:this.parseResponse(t,e)}}))}parseResponse(e,t){t={kty:"oct",kid:Ql.base64UrlEncode(e),k:Ql.base64UrlEncode(t)};return Y.strToUtf8array(JSON.stringify({keys:[t]}))}handleParsedKeyResponse(t,e){let i=e.response;void 0===i&&(i=new ArrayBuffer(0));const r=t.setKeyRequestState($l.PROCESS_LICENSE),n=t.session;return null===n?(this.logger.error("Key is session is null"),Cr):Ln([r,ar(n.update(i)).pipe(cn(()=>{var e=t.decryptdata.keyId,e=n.keyStatuses.get(e);this.handleKeyStatusForKey(e,t)}),Wi(e=>{throw new xl(e.message,t.decryptdata.uri,G.KeySystemFailedToUpdateSession,this.systemString)}))]).pipe(Mr(void 0))}generateInitData(e){return{initData:function(e){e={kids:e.map(Ql.base64UrlEncode)};return Y.strToUtf8array(JSON.stringify(e))}([e]),initDataType:"keyids"}}generateRequestInitialized(){return Yl}sanitizeRequest(e){return e}handleKeyMessage(e){if(!this.isDestroying&&"license-request"===e.messageType){e=new Uint8Array(e.message),e=JSON.parse(Y.utf8arrayToStr(e).trim());if(1===e.kids.length){const t=Ql.base64Decode(e.kids[0]),i=Y.utf8arrayToStr(t),r=this.keyIdToKeyInfo[i];r&&r.resolveState($l.GET_CHALLENGE,t)}}}}]],fairplaystreaming:[["com.apple.fps.3_0",class extends pd{constructor(e,t,i,r,n,a,s,o){super(e,t,i,r,!1,n,a,s,o),this.sessions=[],this.keyIdToKeyInfo={},this.keyUriToKeyInfo={},this.sessionIdToKeyUri={}}static get needsCert(){return!0}handleKeyExchangeError(e,t){this.removeKey(e.decryptdata).subscribe(),super.handleKeyExchangeError(e,t)}_abortKeyRequest(e){return!this.isDestroying&&e&&e.requestState!==$l.NONE&&this.removeKey(e.decryptdata).subscribe(),super._abortKeyRequest(e)}makeFpsKeySystemInitData(e,t,i){const r=[bd.fpsd,(n=e,e=t,t=new Uint8Array(4),ge.set32(n,t,0),ge.box(bd.fpsi,new Uint8Array([0,e>>16&255,e>>8&255,255&e]),t))];var n;for(const a of i)r.push(function(t,e,i,r){const n=[bd.fpsk],a=ge.box(bd.fkri,new Uint8Array([0,0,0,0]),t);if(n.push(a),e&&e.byteLength&&n.push(ge.box(bd.fkai,e)),i&&i.byteLength&&n.push(ge.box(bd.fkcx,i)),r&&r.length){const t=new Uint8Array(4*r.length);let e=0;for(const i of r)ge.set32(i,t,e),e+=4;n.push(ge.box(bd.fkvl,t))}return ge.box.apply(null,n)}(a.keyId,a.assetId,a.ssc,a.versionList));i=ge.box.apply(null,r);return ge.pssh(pd.systemId,null,i)}makeKeyRequestMessage(e,t){return t?Y.strToUtf8array("renew"):new Uint8Array}makeProcessLicenseRequestMessage(e,t,i){t=JSON.stringify([{keyID:Ql.base64Encode(e.decryptdata.keyId||new Uint8Array),payload:Ql.base64Encode(new Uint8Array(t))}]);return Y.strToUtf8array(t)}handleKeyMessage(e){const t=e.target,i=t.sessionId,r=e.messageType,n=this.sessionIdToKeyUri[i];let a=null;if(n)a=this.keyUriToKeyInfo[n];else for(const e of Object.values(this.keyUriToKeyInfo))e&&e.session===t&&(a=e);if(a)switch(r){case"license-request":{const t=new Uint8Array(e.message),i=Y.utf8arrayToStr(t);try{JSON.parse(i).forEach(e=>{var t=Ql.base64DecodeToStr(e.keyID),e=Ql.base64Decode(e.payload),t=this.keyIdToKeyInfo[t];t&&this.resolveSPCPromise(t,e)})}catch(e){this.resolveSPCPromise(a,t)}break}case"license-renewal":{const t=new Uint8Array(e.message);this.resolveSPCPromise(a,t);break}case"license-release":this._handleLicenseRelease(t)}}_handleLicenseRelease(e){e.update(Y.strToUtf8array("acknowledged")).catch(e=>{this.logger.error(`Promise error: ${e.message}`)})}}],["com.apple.fps",Ea]],playready:[["com.microsoft.playready.recommendation",Ds]],widevine:[["com.widevine.alpha",class extends id{constructor(e,t,i,r,n,a,s,o){super(e,t,i,r,!1,n,a,s,o),this.shouldDestroyMediaKeys=!0}static get systemId(){return wd}static get requestAccessConfig(){return Od}get needsCert(){return!0}removeKey(e){return super.removeSessions(e,!0)}ensureKeyContext(e){const t=e.uri,i=this.keyUriToKeyInfo[t];return null!=i&&i.session&&(i.oldSessions.push(i.session),i.session=null),super.ensureKeyContext(e)}getKeyRequestResponse(e,t){var i=e.decryptdata.uri,r=e.setKeyRequestState($l.GET_KEY_RESPONSE);return this.eventEmitter.trigger(N.LICENSE_CHALLENGE_CREATED,{keyuri:i,licenseChallenge:t,keysystem:this.systemString,keyId:null!==e.decryptdata.keyId?e.decryptdata.keyId:void 0,appItemIds:this.ksQuery.getAppItemIds(i)}),r}handleParsedKeyResponse(t,e){t.licenseChallenge=void 0;const i=t.decryptdata.uri,r=e.statusCode;if(0!==r)return Lr(void 0===r?new Ll("License server responded with error code: undefined",i,{code:0,text:"Server Error, undefined status code"},!1,yl.LicenseServerError):new Ll("License server responded with error",i,{code:r,text:"Server Error"},!1,yl.LicenseServerError));if(!e.license||!e.license.byteLength)return Lr(new Ll("License server responded with invalid license",i,{code:r,text:"Invalid license"},!1,yl.LicenseServerError));if(e.renewalDate){const i=e.renewalDate,r=new Date,n=i>r?i.getTime()-r.getTime():0;0<n&&n<Math.pow(2,31)&&this._scheduleRenewal(t,n)}const n=t.setKeyRequestState($l.PROCESS_LICENSE),a=t.session;return null===a?(this.logger.error("key session is null, this should not happen"),Yl):Ln([n,ar(a.update(e.license)).pipe(cn(()=>{var e=t.decryptdata.keyId,e=a.keyStatuses.get(null!==e?e:new Uint8Array);this.handleKeyStatusForKey(e,t)}),Wi(e=>{throw this.logger.error(`${this.systemString} FAIL: Failed to update with key response code=${e.code} message=${e.message}`),new xl(e.message,t.decryptdata.uri,G.KeySystemFailedToUpdateSession,this.systemString)}))]).pipe(Mr(void 0))}generateInitData(e,t){return{initData:t.pssh,initDataType:"cenc"}}generateRequestInitialized(e){var t=e.licenseChallenge;return e.requestInfo=void 0,e.resolveState($l.GET_CHALLENGE,void 0!==t?t:new Error("undefined challenge")),Yl}handleKeyMessage(i){if(!this.isDestroying){const r=i.target;let e=null,t=null;if(r.sessionId in this.sessionIdToKeyUri)e=this.sessionIdToKeyUri[r.sessionId],t=this.keyUriToKeyInfo[e];else for(const[i,n]of Object.entries(this.keyUriToKeyInfo))if(n.session===r){e=i,t=n;break}if(t)switch(i.messageType){case"license-request":{const r=new Uint8Array(i.message);t.resolveState($l.GET_CHALLENGE,r);break}}}}}]]},kd=nd.id;class Md{constructor(e){this.config=e,this._idToMediaKeysInfoMap={},this._destroy$=new Er}createMediaKeys(t,e,i,r,n){let a=(this.config.maintainMediaKeysBetweenSessions?Md.idToMediaKeysInfoMap:this._idToMediaKeysInfoMap)[t];if(!a){const s=Gl(e,i),o=new Hr;Md.requestKeySystemAccess(t,s,n,r).pipe(on(e=>(this.config.maintainMediaKeysBetweenSessions?Md.idToMediaKeysInfoMap[t].keySystemAccess=e:this._idToMediaKeysInfoMap[t].keySystemAccess=e,ar(e.createMediaKeys()))),cn(e=>{o.next(e),o.complete()}),Wi(e=>(o.error(new xl(`could not initialize key system: ${e.message}`,"",G.KeySystemFailedToInitialize,t)),Cr)),dn(Md.destroy$)).subscribe(),a=this.config.maintainMediaKeysBetweenSessions?Md.idToMediaKeysInfoMap[t]={mediaKeys$:o,keySystemAccess:null}:this._idToMediaKeysInfoMap[t]={mediaKeys$:o,keySystemAccess:null}}return a.mediaKeys$}destroyMediaKeys(){this.config.maintainMediaKeysBetweenSessions?(Md.destroy$.next(),Md.idToMediaKeysInfoMap={}):(this._destroy$.next(),this._idToMediaKeysInfoMap={})}static getKeySystemIdForDecryptData(e){let t;if(e){t=kd;var i=e.format;for(const e of ad){var r=Rd[e];if((null==r?void 0:r.keyFormatString)===i){t=e;break}}}if(!t)throw Error("No matching key system");return t}static requestKeySystemAccess(e,t,i,r){if("undefined"==typeof navigator||void 0===navigator.requestMediaKeySystemAccess)return Lr(new xl("navigator undefined","",G.KeySystemUndefinedNavigator,e));const n=Cd[e];let a=Lr(new xl("no key systems to try","",G.KeySystemNoKeySystemsToTry,e));for(const e of n){const n=e[0],o=e[1],l=(s=i)&&"object"==typeof s?i:o.requestAccessConfig,d=[Object.assign({},l,t)];a=a.pipe(Wi(()=>Md.requestKeySystemInternal(n,d,r)))}var s;return a}static requestKeySystemInternal(e,t,i){return Pn(()=>ar(navigator.requestMediaKeySystemAccess(e,t)))}make(e,t,i,r,n,a,s,o){var l,d=this.config.maintainMediaKeysBetweenSessions?null===(l=Md.idToMediaKeysInfoMap[e])||void 0===l?void 0:l.keySystemAccess:null===(c=this._idToMediaKeysInfoMap[e])||void 0===c?void 0:c.keySystemAccess;if(!d)throw new xl(`No keySystemAccess for ${e}`,"",G.KeySystemNoKeySystemAccess,e);let u;var c=Rd[e].systemStringPrefix;for(const t of Cd[e])if(t[0]===d.keySystem){u=t[1];break}if(!u)throw new xl(`No constructor associated with ${e}`,"",G.KeySystemNoConstructor,c);return new u(t,c,i,r,n,a,s,o)}static get availableKeySystems(){return Object.keys(Rd)}static getKeySystemFormat(e){e=Rd[e];return e?e.keyFormatString:""}static getKeySystemSecurityLevel(e){e=Rd[e];return e?e.securityLevels:void 0}}Md.idToMediaKeysInfoMap={},Md.destroy$=new Er;const Pd=["avc1.42E01E"],Ld=["mp4a.40.2"];function xd(e,t,i){i=Ml(i);if(t)if(t instanceof mn)t=new Pl("Key request timed out",e,G.KeySystemRequestTimedOut);else if(t instanceof xl){const r=(null==t?void 0:t.response)||G.InternalError;t=new Ll(t.message,e,r,!1,yl.InternalError,!0)}else t instanceof Uo&&(t=new Ll(t.message,e,{code:t.statusCode,text:"Http response error"},!1,yl.HttpError));else t=new Ll("Unknown error from CDM",e,G.KeySystemCDMUnknownError,!1,yl.InternalError);return(t instanceof Ll||t instanceof Pl)&&(t.mediaOptionIds=[...i]),t}class Dd{constructor(e,t,i,n,r,a,s,o,l=void 0,d=new Md(i)){this.ksService=e,this.config=i,this.platformQuery=n,this.eventEmitter=r,this.sessionHandler=a,this.customUrlLoader=s,this.keyErrorHandlingPolicy=l,this.keySystemFactory=d,this.reset$=new Er,this.keyRequest$=new Er,this.abort$=new Er,this.keySystem$=new qr(null),this._keyStatusChange$=new Er,this.firstMediaKeysAttached$=new Hr,this.protectionData={},this.keySystemId=null,this.keyUriToRequest={},this.ksQuery=e.query,this.logger=o.child({name:"eme"}),this.config.warmupCdms&&this.ensureMediaKeys(this.makeDecryptData(this.config.keySystemPreference).keyTagInfo).subscribe();t=t.pipe(on(t=>{const e=this.mediaSink,i=[];let r;return this.mediaSink=t,e&&i.push(e.clearMediaKeys()),t&&(this.keySystem?i.push(this.attachMediaKeys(t)):i.push(Jl(n.platformInfo$,e=>!0===(null==e?void 0:e.requiresCDMAttachOnStart)).pipe(on(()=>this.attachMediaKeys(t)))),this.isKeyCleanupSupported()&&(r=this.ksQuery.selectCount().pipe(sr(e=>4<=e),xr(),on(e=>e?Yl.pipe(Fr(()=>{const t=performance.now(),e=this.ksQuery.getAll();let i=1/0;return e.forEach(e=>{e.minHoldTime>t&&(i=Math.min(e.minHoldTime,i))}),z(i)?Ki(i):Cr},1),on(()=>Qn([t.mediaQuery.bufferedSegmentsTuple$,t.mediaQuery.updating$]).pipe(_r(([,e])=>!1===e),sr(([e])=>{const t=new Set;return e.forEach(e=>e.forEach(e=>{e=null===(e=e.frag.keyTagInfo)||void 0===e?void 0:e.uri;e&&t.add(e)})),t}),xr(p)))):Cr),pr(this._handleKeyCleanup.bind(this))))),r?Vn(Rr(...i),r):Rr(...i)}));Vn(t,this.keyRequest$.pipe(pr(e=>e.pipe(Wi(()=>Cr)))),this.keySystem$.pipe(on(e=>e?e.keyStatusChange$.pipe(cn(e=>{var t=e.decryptdata.uri,i=this.ksQuery.getKeyInfo(t);"needs-renewal"===e.status?this.ksService.updateKeyRequestState(t,gl.MustRequestResponse,e=>e===gl.GotKeyResponse):(i=xd(t,e.error,i),this.ksService.setError(t,i,!0)),this._keyStatusChange$.next(e)})):Cr))).pipe(Br(()=>{this.mediaSink=void 0}),dn(this.reset$)).subscribe()}get keyStatusChange$(){return this._keyStatusChange$}get keySystem(){return this.keySystem$.value}destroy(){const e=this.mediaSink;this.reset$.next();let t=Yl;this.keySystemId=null;const i=this.keySystem;let r=Yl;if(i){const e=this.ksQuery.getAll(),n=new Set;e.forEach(e=>e.mediaOptionKeys.forEach(e=>{n.add(e.itemId)})),t=this.removeItemsAndKeys(Array.from(n),!0),this.keySystem$.next(null),i.shouldDestroyMediaKeys&&this.keySystemFactory.destroyMediaKeys(),r=i.destroy()}this.ksService.removeAll();const n=[Rr(t,r)];return e&&n.push(e.clearMediaKeys()),Ln(n).pipe(sr(()=>{}))}attachMediaKeys(e){return this.keySystem?e.setMediaKeys(this.keySystem.mediaKeys):this.makeKeySystem(this.makeDecryptData(this.config.keySystemPreference)).pipe(cn(()=>{this.firstMediaKeysAttached$.next(!0),this.firstMediaKeysAttached$.complete()}),sr(()=>{}))}makeDecryptData(e){e=e?Md.getKeySystemFormat(e):_l.keyFormatString;return new Wl("NONE",void 0,null,e,[1])}isKeyCleanupSupported(){return!0===this.config.useMultipleKeySessions||"widevine"===this.config.keySystemPreference||"playready"===this.config.keySystemPreference}static _eligibleForCleanup(e,t,i){return"AES-128"!==i.decryptdata.method&&i.requestState!==gl.WaitingForKeyResponse&&!t.has(i.keyUri)&&(e>=i.minHoldTime||0===i.mediaOptionKeys.length&&z(i.minHoldTime))}_handleKeyCleanup(e){var t=performance.now();this.ksQuery.getCount();const i=this.ksQuery.getAll({filterBy:Dd._eligibleForCleanup.bind(null,t,e)}),r=new Array;return da(()=>{for(const t of i){var e=kl(t.decryptdata);r.push(this._removeKey(t.keyUri,e))}}),this.ksQuery.getCount(),r.length?Ln(r):Yl}_removeKey(e,t){this.abort$.next(e),this.ksService.removeKey(e);const i=this.keySystem;return null===i?Yl:i.removeKey(t)}removeItems(t){da(()=>{for(const e of t)this.ksService.removeItemFromKeys(e)})}removeItemsAndKeys(e,t){let i=Yl;return da(()=>{this.removeItems(e),i=this._removeUnusedKeys(t)}),i}_removeUnusedKeys(t){const e=[],i=this.ksQuery.getAll({filterBy:e=>0===e.mediaOptionKeys.length&&(t||z(e.minHoldTime))});for(const t of i)e.push(this._removeKey(t.keyUri,kl(t.decryptdata)));return e.length?Ln(e).pipe(on(()=>Yl)):Yl}get availableKeySystems(){return Md.availableKeySystems}initialize(e,t){var i=this.protectionData;this.protectionData={};var r=this.config.keySystemPreference;for(const o of Md.availableKeySystems){var n=e[o];if(n&&r===o){var a,s=n.certificate,n=n.serverCertUrl?no.buildAbsoluteURL(window.location.href,n.serverCertUrl):void 0;let e;this.protectionData[o]={serverCertUrl:n,certificate:s},s?e=Pr({keysystem:o,certificate:s}):n&&(null===(a=null==i?void 0:i[o])||void 0===a?void 0:a.serverCertUrl)!==n&&(a=ao(n)?t.customURL:t.default,e=ul({url:n,xhrSetup:this.config.xhrSetup},a,this.customUrlLoader).pipe(sr(([e])=>({keysystem:o,certificate:new Uint8Array(e)})))),e&&e.pipe(on(e=>this.onServerCertificateLoaded(e)),Wi(e=>{throw this.logger.error(`Error loading cert: ${e.message}`),this.eventEmitter.trigger(N.INTERNAL_ERROR,{type:U.NETWORK_ERROR,details:V.CERT_LOAD_ERROR,fatal:!1,handled:!0,reason:"Error handling cert",response:G.KeySystemCertificateLoadError,message:e.message,name:"certificateLoadError"}),e}),dn(this.reset$)).subscribe()}}}generateRequest(e,t){return t.pin&&this.ksService.setPinnedKey(e,performance.now()+this.config.keyMinHoldTimeBeforeCleanup),!!this.keySystem&&this.keySystem.setKeyRequestInfo(e,t)}setLicenseResponse(e,t){this.keySystem&&this.keySystem.setParsedResponse(e,t)}getKeyFromDecryptData(e,t,i){var r;if(!e||!e.isEncrypted)return null!==(r=this.platformQuery.platformInfo)&&void 0!==r&&r.requiresCDMAttachOnStart?Jl(this.firstMediaKeysAttached$,e=>e).pipe(sr(()=>e)):Pr(e);let n;return da(()=>{n=this._getKeyFromDecryptData(e,t,i)}),n}_getKeyFromDecryptData(i,r,n){var e;let a=null,s=performance.now()+this.config.keyMinHoldTimeBeforeCleanup;r&&(a=r.mediaOptionId);const o=i.uri;this.ksQuery.hasEntity(o)&&(null!=r&&this.ksService.addMediaOption(o,r),(null===(e=this.ksQuery.getEntity(o))||void 0===e?void 0:e.minHoldTime)===1/0&&(s=1/0),this.ksService.updateMinHoldTime(o,s));const l=this.ksQuery.getKeyInfo(o);if((null==l?void 0:l.error)instanceof Ll&&!1===l.error.isOkToRetry)return Lr(()=>l.error);if(l&&l.requestState!==gl.MustRequestResponse)return l.requestState===gl.GotKeyResponse?Pr(kl(l.decryptdata)):this.keyUriToRequest[o];{if(this.abort$.next(o),!(r||l&&0!==l.mediaOptionKeys.length))return Lr(()=>new Ll("Key not associated with any items",o,G.KeySystemAbort,!1,yl.Abort));let e;this.ksService.upsertKey({keyUri:o,decryptdata:function(e){var{method:t,isEncrypted:i,uri:r,format:n,formatversions:a}=e;return{method:t,isEncrypted:i,uri:r,format:n,formatversions:a,ivBuf:null===(a=e.iv)||void 0===a?void 0:a.buffer,keyIdBuf:null===(a=e.keyId)||void 0===a?void 0:a.buffer,keyBuf:null===(a=e.key)||void 0===a?void 0:a.buffer,psshBuf:null===(e=e.key)||void 0===e?void 0:e.buffer}}(i),minHoldTime:s,mediaOptionKeys:r?[r]:[],requestState:gl.WaitingForKeyResponse});var d=i.method;switch(d){case"SAMPLE-AES":case"ISO-23001-7":case"SAMPLE-AES-CTR":{const r=n.customURL;e=this.fetchKeyEME(i).pipe(fn(void 0!==r.maxLoadTimeMs?r.maxLoadTimeMs:0));break}case"AES-128":e=this.fetchKeyHTTP(i.uri,i,n);break;default:return Lr(new B(!1,`Unexpected METHOD attribute ${d}`,G.KeySystemUnexpectedMETHOD))}let t=e.pipe(sr(e=>{var t=e.decryptdata;return this.ksService.updateKeyValue(o,t.key),e.mediaOptionId=a,this.eventEmitter.trigger(N.KEY_LOADED,e),e.decryptdata}),Wi(e=>{var t=this.ksQuery.getKeyInfo(o);throw e=xd(o,e,t),this.ksService.setError(o,e,!1),null===(t=this.sessionHandler)||void 0===t||t.keyErrorThrown({keyuri:o,mediaOptionId:a,mediaOptionIds:e.mediaOptionIds}),e}));return this.keyErrorHandlingPolicy&&(t=t.pipe(this.keyErrorHandlingPolicy)),t=t.pipe(Br(()=>{var e;null===(e=this.ksQuery.getKeyInfo(o))||void 0===e||e.requestState,this.ksService.updateKeyRequestState(o,gl.MustRequestResponse,e=>e===gl.WaitingForKeyResponse),this.keyUriToRequest[o]=Cr}),tn(),dn(Yr(this.abort$.pipe(_r(e=>e===o)),this.reset$).pipe())),this.keyUriToRequest[o]=t,this.keyRequest$.next(t),t}}fetchKeyEME(e){return this.requestKey(e).pipe(sr(e=>{var t=performance.now(),i=e.uri;return{timestamp:t,keyuri:i,decryptdata:e,appItemIds:this.ksQuery.getAppItemIds(i)}}))}fetchKeyHTTP(e,t,i){return Dd.fetchKeyHTTP(e,this.config,t,i,this.customUrlLoader,this.ksQuery,this.logger)}static fetchKeyHTTP(t,e,i,r,n,a,s){e={url:t,xhrSetup:e.xhrSetup};return ul(e,Go(e,r),n).pipe(sr(([e])=>(i.key=new Uint8Array(e),{decryptdata:i,keyuri:t,timestamp:performance.now(),appItemIds:a.getAppItemIds(t)})))}requestKey(t){return this.makeKeySystem(t).pipe(on(e=>null===e?Cr:e.startKeyRequest(t)))}ensureKeySystem(t){return Pn(()=>{if(null===this.keySystem&&this.keySystemId){this.keySystem$.next(this.keySystemFactory.make(this.keySystemId,t,this.config,this.eventEmitter,this.sessionHandler,this.customUrlLoader,this.ksQuery,this.logger));var e=this.protectionData&&this.protectionData[this.keySystemId];if(e){const t=this.keySystem$.value;return null===t?(this.logger.error("Key system is null after calling keySystemFactory.make. This should not happen"),Lr(new Ll("Key system is null after calling keySystemFactory.make","",G.KeySystemFailedToInitialize,!1,yl.InternalError))):t.setServerCertificate(e.certificate).pipe(Mr(this.keySystem))}}return Pr(this.keySystem)})}makeKeySystem(e){return this.ensureMediaKeys(e).pipe(on(e=>{var t;return Ln([this.ensureKeySystem(e),null!==(e=null===(t=this.mediaSink)||void 0===t?void 0:t.setMediaKeys(e))&&void 0!==e?e:Yl])}),sr(e=>e[0]))}ensureMediaKeys(e){var t=Md.getKeySystemIdForDecryptData(e);if(null==this.keySystemId)this.keySystemId=t;else if(this.keySystemId!==t)return Lr(new Ll(`New key system string does not match existing ${t} !== ${this.keySystemId}`,e.uri,G.KeySystemUnmatchedString,!1,yl.InternalError));return this.keySystemFactory.createMediaKeys(this.keySystemId,Pd,Ld,this.logger,null===(e=this.platformQuery.platformInfo)||void 0===e?void 0:e.keySystemConfig)}onServerCertificateLoaded(e){const t=e.keysystem,i=e.certificate,r=this.protectionData[t];return void 0===r?(this.logger.error(`KeySystemAdapter: ProtectionData for keysystemId:${t} is undefined`),Lr(new xl(`ProtectionData for keysystemId:${t} is undefined`,"undefined",G.InternalError,t))):(r.certificate=i,this.keySystem&&this.keySystemId===t?this.keySystem.setServerCertificate(i).pipe(Mr(void 0)):Yl)}handleKeySystemError(e){e=new xl(e.message,"undefined",G.KeySystemSetupError,"undefined");this.eventEmitter.trigger(N.INTERNAL_ERROR,e)}}function _d(){return e=>e.pipe(_r(e=>null!=e),sr(e=>e))}class Nd extends Sa{constructor(e){super(e)}getKeyInfo(e){e=this.getEntity(e);return null!=e&&e.error?Object.assign(Object.assign({},e),{error:Dl(e.error,Ml(e))}):e}getKeyRequestState$(e){return this.selectEntity(e,e=>null==e?void 0:e.requestState)}getKeyStatus$(e){return this.selectEntity(e,e=>null==e?void 0:e.status)}getKeyError$(e){return this.selectEntity(e,e=>Dl(null==e?void 0:e.error,Ml(e))).pipe(_d())}getAppItemIds(e){const t=new Set,i=null===(e=this.getEntity(e))||void 0===e?void 0:e.mediaOptionKeys;if(i)for(const r of i)r.appItemId&&t.add(r.appItemId);return Array.from(t)}}class Fd extends pa{constructor(){super({},{name:"key-system-store",idKey:"keyUri"})}}class Bd{constructor(e,t){this.store=e,this._logger=t,this._query=new Nd(this.store)}get query(){return this._query}upsertKey(i){const r={};function n(e,t){for(const i of e){const{itemId:e,mediaOptionId:r,appItemId:n}=i;t[e+r]={itemId:e,mediaOptionId:r,appItemId:n}}}n(i.mediaOptionKeys,r),this.store.upsert(i.keyUri,e=>{const t=Object.assign(Object.assign({},e),i);return"mediaOptionKeys"in e&&n(e.mediaOptionKeys,r),t.mediaOptionKeys=Object.values(r),t},()=>Object.assign(Object.assign({},i),{mediaOptionKeys:Object.values(r)}))}removeKey(e){this.store.remove(e)}removeItemFromKeys(i){const e=this._query.getAll();da(()=>{e.forEach(e=>{var t;e.mediaOptionKeys.some(e=>e.itemId===i)&&(t=e.mediaOptionKeys.filter(e=>e.itemId!==i),this.store.update(e.keyUri,{mediaOptionKeys:t}))})})}removeAll(){this.store.remove()}updateKeyValue(e,t){var i=this._query.getEntity(e);i&&(i={requestState:gl.GotKeyResponse,decryptdata:null==i.decryptdata.keyBuf&&null!=t?Object.assign(Object.assign({},i.decryptdata),{keyBuf:t.buffer}):i.decryptdata},this.store.update(e,i))}updateKeyStatus(e,t){var i=this._query.getEntity(e);null!=i&&i.status!==t&&this.store.update(e,{status:t})}updateKeyRequestState(e,t,i){var r=this._query.getEntity(e);null!=r&&(i&&!1===i(r.requestState)||this.store.update(e,{requestState:t}))}updateMinHoldTime(e,t){var i=null===(i=this._query.getEntity(e))||void 0===i?void 0:i.minHoldTime;null!=i&&i!==t&&this.store.update(e,{minHoldTime:t})}setPinnedKey(e,t){var i=null===(i=this._query.getEntity(e))||void 0===i?void 0:i.minHoldTime;if(null!=i&&i!==1/0){const r=this.query.getAll({filterBy:e=>e.minHoldTime===1/0}).map(e=>e.keyUri);da(()=>{0<r.length&&this.store.update(r,{minHoldTime:t}),this.store.update(e,{minHoldTime:1/0})})}}addMediaOption(e,t){var i;const{itemId:r,mediaOptionId:n,appItemId:a}=t,s=null===(i=this._query.getEntity(e))||void 0===i?void 0:i.mediaOptionKeys;s&&!s.some(e=>ko(e,t))&&this.store.update(e,{mediaOptionKeys:[...s,{itemId:r,mediaOptionId:n,appItemId:a}]})}setError(e,t,i){const r={error:Dl(t)};i&&(r.requestState=gl.MustRequestResponse),this.store.update(e,r)}}var Ud={},xs={},Vd={},t={};Object.defineProperty(t,"__esModule",{value:!0}),t.isValidScrollSetting=t.isValidPositionAlignSetting=t.isValidLineAlignSetting=t.isValidLineAndPositionSetting=t.isValidDirectionSetting=t.isValidAlignSetting=t.isValidPercentValue=void 0,t.isValidPercentValue=function(e){return"number"==typeof e&&0<=e&&e<=100},t.isValidAlignSetting=function(e){return"string"==typeof e&&["start","center","end","left","right","middle"].includes(e)},t.isValidDirectionSetting=function(e){return"string"==typeof e&&["","rl","lr"].includes(e)},t.isValidLineAndPositionSetting=function(e){return"number"==typeof e||"auto"===e},t.isValidLineAlignSetting=function(e){return"string"==typeof e&&["start","center","end"].includes(e)},t.isValidPositionAlignSetting=function(e){return"string"==typeof e&&["line-left","center","line-right","auto","left","start","middle","end","right"].includes(e)},t.isValidScrollSetting=function(e){return["","up"].includes(e)};var $d={};Object.defineProperty($d,"__esModule",{value:!0});var Qd={"&amp;":"&","&lt;":"<","&gt;":">","&lrm;":"‎","&rlm;":"‏","&nbsp;":" "},Kd={c:"span",i:"i",b:"b",u:"u",ruby:"ruby",rt:"rt",v:"span",lang:"span"},qd={v:"title",lang:"lang"},Hd={rt:"ruby"},jd={"text-combine-upright":"-webkit-text-combine:horizontal; text-orientation: mixed;"};class Gd{static parseTimeStamp(e){function t(e){var[t,i,r,e]=e.map(e=>e?parseInt(""+e):0);return 3600*t+60*i+r+e/1e3}e=/^(\d+):(\d{2})(:\d{2})?\.(\d{3})/.exec(e);return e?e[3]?t([e[1],e[2],e[3].substring(1),e[4]]):59<parseInt(e[1])?t([e[1],e[2],null,e[4]]):t([null,e[1],e[2],e[4]]):null}static parseContent(a,e,s){var t=e.text;function i(e){return Qd[e]}for(var r,n,o,e=a.document.createElement("div"),l=[],d=e;null!==(r=function(){if(!t)return null;var e=(e=/^([^<]*)(<[^>]+>?)?/.exec(t))[1]||e[2];return t=t.substr(e.length),e}());)if("<"!==r[0])d.appendChild(a.document.createTextNode(r.replace(/&(amp|lt|gt|lrm|rlm|nbsp);/g,i)));else{if("/"===r[1]){l.length&&l[l.length-1]===r.substr(2).replace(">","")&&(l.pop(),d=d.parentNode);continue}var u=Gd.parseTimeStamp(r.substr(1,r.length-2)),c=void 0;if(u){c=a.document.createProcessingInstruction("timestamp",u.toString()),d.appendChild(c);continue}if(!(r=/^<([^.\s/0-9>]+)(\.[^\s\\>]+)?([^>\\]+)?(\\?)>?$/.exec(r)))continue;if(!(c=function(e,t,i){var r=Kd[e];if(!r)return null;var n=a.document.createElement(r);return n.dataset.localName=r,(e=qd[e])&&i&&(n[e]=i.trim()),t&&(s[t]?(i=function(e){var t,i="";for(t in e)i+=jd[t]||t+":"+e[t]+";";return i}(s[t]),n.setAttribute("style",i)):console.info("WebVTT: parseContent: Style referenced, but no style defined for '".concat(t,"'!"))),n}(r[1],r[2],r[3])))continue;if(n=d,Hd[(o=c).dataset.localName]&&Hd[o.dataset.localName]!==n.dataset.localName)continue;l.push(r[1]),d.appendChild(c),d=c}return e}}$d.default=Gd;Ea=Ta&&Ta.__decorate||function(e,t,i,r){var n,a=arguments.length,s=a<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;0<=o;o--)(n=e[o])&&(s=(a<3?n(s):3<a?n(t,i,s):n(t,i))||s);return 3<a&&s&&Object.defineProperty(t,i,s),s};Object.defineProperty(Vd,"__esModule",{value:!0}),Vd.VTTCue=void 0;var zd=t,Wd=$d,Ds=Ea([function(e){var t=e;return"undefined"!=typeof window&&null!=window.VTTCue&&((t=window.VTTCue).create=e.create,t.fromJSON=e.fromJSON,t.prototype.toJSON=e.prototype.toJSON),t}],Ds=class{constructor(e,t,i){this._id="",this._pauseOnExit=!1,this._region=null,this._vertical="",this._snapToLines=!0,this._line="auto",this._lineAlign="start",this._position="auto",this._positionAlign="auto",this._size=100,this._align="center",this.hasBeenReset=!1,this._startTime=e,this._endTime=t,this._text=i}get id(){return this._id}set id(e){this._id=""+e}get pauseOnExit(){return this._pauseOnExit}set pauseOnExit(e){this._pauseOnExit=!!e}get startTime(){return this._startTime}set startTime(e){if("number"!=typeof e)throw new TypeError("Start time must be set to a number: ".concat(e));this._startTime=e,this.hasBeenReset=!0}get endTime(){return this._endTime}set endTime(e){if("number"!=typeof e)throw new TypeError("End time must be set to a number: ".concat(e));this._endTime=e,this.hasBeenReset=!0}get text(){return this._text}set text(e){this._text=""+e,this.hasBeenReset=!0}get region(){return this._region}set region(e){this._region=e,this.hasBeenReset=!0}get vertical(){return this._vertical}set vertical(e){if(!zd.isValidDirectionSetting(e))throw new SyntaxError("An invalid or illegal string was specified for vertical: ".concat(e));this._vertical=e,this.hasBeenReset=!0}get snapToLines(){return this._snapToLines}set snapToLines(e){this._snapToLines=!!e,this.hasBeenReset=!0}get line(){return this._line}set line(e){if(!zd.isValidLineAndPositionSetting(e))throw new SyntaxError("An invalid number or illegal string was specified for line: ".concat(e));this._line=e,this.hasBeenReset=!0}get lineAlign(){return this._lineAlign}set lineAlign(e){if(!zd.isValidLineAlignSetting(e))throw new SyntaxError("An invalid or illegal string was specified for lineAlign: ".concat(e));this._lineAlign=e,this.hasBeenReset=!0}get position(){return this._position}set position(e){if(!zd.isValidLineAndPositionSetting(e))throw new Error("Position must be between 0 and 100 or auto: ".concat(e));this._position=e,this.hasBeenReset=!0}get positionAlign(){return this._positionAlign}set positionAlign(e){if(!zd.isValidPositionAlignSetting(e))throw new SyntaxError("An invalid or illegal string was specified for positionAlign: ".concat(e));this._positionAlign=e,this.hasBeenReset=!0}get size(){return this._size}set size(e){if(e<0||100<e)throw new Error("Size must be between 0 and 100: ".concat(e));this._size=e,this.hasBeenReset=!0}get align(){return this._align}set align(e){if(!zd.isValidAlignSetting(e))throw new SyntaxError("An invalid or illegal string was specified for align: ".concat(e));this._align=e,this.hasBeenReset=!0}getCueAsHTML(){return Wd.default.parseContent(window,this,{})}static create(t){if(!t.hasOwnProperty("startTime")||!t.hasOwnProperty("endTime")||!t.hasOwnProperty("text"))throw new Error("You must at least have start time, end time, and text.");var i=new this(t.startTime,t.endTime,t.text);return Object.keys(t).forEach(e=>{i.hasOwnProperty(e)&&(i[e]=t[e])}),i}static fromJSON(e){return this.create(JSON.parse(e))}toJSON(){var t={};return Object.keys(this).forEach(e=>{this.hasOwnProperty(e)&&"getCueAsHTML"!==e&&"hasBeenReset"!==e&&"displayState"!==e&&(t[e]=this[e])}),t}});Vd.VTTCue=Ds;var Yd={},Ea=Ta&&Ta.__decorate||function(e,t,i,r){var n,a=arguments.length,s=a<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,i,r);else for(var o=e.length-1;0<=o;o--)(n=e[o])&&(s=(a<3?n(s):3<a?n(t,i,s):n(t,i))||s);return 3<a&&s&&Object.defineProperty(t,i,s),s};Object.defineProperty(Yd,"__esModule",{value:!0}),Yd.VTTRegion=void 0;var Xd=t,Ds=Ea([function(e){var t=e;return"undefined"!=typeof window&&null!=window.VTTRegion&&((t=window.VTTRegion).create=e.create,t.fromJSON=e.fromJSON,t.prototype.toJSON=e.prototype.toJSON),t}],Ds=class{constructor(){this._id="",this._lines=3,this._regionAnchorX=0,this._regionAnchorY=100,this._scroll="",this._viewportAnchorX=0,this._viewportAnchorY=100,this._width=100}get id(){return this._id}set id(e){if("string"!=typeof e)throw new Error("ID must be a string.");this._id=e}get lines(){return this._lines}set lines(e){if("number"!=typeof e)throw new TypeError("Lines must be set to a number.");this._lines=e}get regionAnchorX(){return this._regionAnchorX}set regionAnchorX(e){if(!Xd.isValidPercentValue(e))throw new TypeError("RegionAnchorX must be between 0 and 100.");this._regionAnchorX=e}get regionAnchorY(){return this._regionAnchorY}set regionAnchorY(e){if(!Xd.isValidPercentValue(e))throw new TypeError("RegionAnchorY must be between 0 and 100.");this._regionAnchorY=e}get scroll(){return this._scroll}set scroll(e){if("string"==typeof e){e=e.toLowerCase();if(Xd.isValidScrollSetting(e))return void(this._scroll=e)}throw new SyntaxError("An invalid or illegal string was specified.")}get viewportAnchorX(){return this._viewportAnchorX}set viewportAnchorX(e){if(!Xd.isValidPercentValue(e))throw new TypeError("ViewportAnchorX must be between 0 and 100.");this._viewportAnchorX=e}get viewportAnchorY(){return this._viewportAnchorY}set viewportAnchorY(e){if(!Xd.isValidPercentValue(e))throw new TypeError("ViewportAnchorY must be between 0 and 100.");this._viewportAnchorY=e}get width(){return this._width}set width(e){if(!Xd.isValidPercentValue(e))throw new TypeError("Width must be between 0 and 100.");this._lines=e}toJSON(){var t={};return Object.keys(this).forEach(e=>{this.hasOwnProperty(e)&&(t[e]=this[e])}),t}static create(t){var i=new this;return Object.keys(t).forEach(e=>{i.hasOwnProperty(e)&&(i[e]=t[e])}),i}static fromJSON(e){return this.create(JSON.parse(e))}});Yd.VTTRegion=Ds;var Jd={};Object.defineProperty(Jd,"__esModule",{value:!0}),function(e){var r=Ta&&Ta.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){e[r=void 0===r?i:r]=t[i]}),t=Ta&&Ta.__exportStar||function(e,t){for(var i in e)"default"===i||t.hasOwnProperty(i)||r(t,e,i)};Object.defineProperty(e,"__esModule",{value:!0}),e.VTTRegion=e.VTTCue=e.WebVTTParser=e.ParsingError=void 0;var a=Vd;Object.defineProperty(e,"VTTCue",{enumerable:!0,get:function(){return a.VTTCue}});var i=Yd;Object.defineProperty(e,"VTTRegion",{enumerable:!0,get:function(){return i.VTTRegion}});var o=$d;class l extends Error{constructor(e,t){super(),this.name="ParsingError",this.code="number"==typeof e?e:e.code,t?this.message=t:e instanceof l&&(this.message=e.message)}}(e.ParsingError=l).Errors={BadSignature:new l(0,"Malformed WebVTT signature."),BadTimeStamp:new l(1,"Malformed time stamp.")};class d{constructor(){this.values={}}set(e,t){this.get(e)||""===t||(this.values[e]=t)}get(e,t,i){return"object"==typeof t&&"string"==typeof i?this.has(e)?this.values[e]:t[i]:this.has(e)?this.values[e]:t}has(e){return e in this.values}alt(e,t,i){for(var r=0;r<i.length;++r)if(t===i[r]){this.set(e,t);break}}integer(e,t){/^-?\d+$/.test(t)&&this.set(e,parseInt(t,10))}percent(e,t){if(t.match(/^([\d]{1,3})(\.[\d]*)?%$/))try{var i=parseFloat(t);if(0<=i&&i<=100)return this.set(e,i),!0}catch(e){return!1}return!1}}class n{constructor(e,t,i){this.window=e,this.state="INITIAL",this.styleCollector="",this.buffer="",this.decoder=t||new TextDecoder("utf8"),this.regionList=[],this.alreadyCollectedLine="",this.onStylesParsedCallback=i,this._styles={},this.middleOrCenter="center";i=new a.VTTCue(0,0,"middleOrCenter");try{i.align="center","center"!==i.align&&(this.middleOrCenter="middle")}catch(e){this.middleOrCenter="middle"}}static StringDecoder(){return{decode:e=>{if(!e)return"";if("string"!=typeof e)throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(e))}}}reportOrThrowError(e){if(!(e instanceof l&&"function"==typeof this.onparsingerror))throw e;this.onparsingerror(e)}parseOptions(e,t,i,r){var n,a;for(n of r?e.split(r):[e])"string"!=typeof n||2===(a=n.split(i)).length&&t(a[0],a[1])}parseCue(t,e,s){var i=t,r=()=>{var e=o.default.parseTimeStamp(t);if(null===e)throw new l(l.Errors.BadTimeStamp,"Malformed timestamp: "+i);return t=t.replace(/^[^\sa-zA-Z-]+/,""),e},n=()=>{t=t.replace(/^\s+/,"")};if(n(),e.startTime=r(),n(),"--\x3e"!==t.substr(0,3))throw new l(l.Errors.BadTimeStamp,"Malformed time stamp (time stamps must be separated by '--\x3e'): ".concat(i));t=t.substr(3),n(),e.endTime=r(),n(),((e,t)=>{var a=new d;this.parseOptions(e,(e,t)=>{var i,r;switch(e){case"region":for(var n=s.length-1;0<=n;n--)if(s[n].id===t){a.set(e,s[n].region);break}break;case"vertical":a.alt(e,t,["rl","lr"]);break;case"line":r=(i=t.split(","))[0],a.integer(e,r),a.percent(e,r)&&a.set("snapToLines",!1),a.alt(e,r,["auto"]),2===i.length&&a.alt("lineAlign",i[1],["start","middle","center","end"]);break;case"position":i=t.split(","),a.percent(e,i[0]),2===i.length&&a.alt("positionAlign",i[1],["line-left","line-right","center","auto","left","start","middle","end","right"]);break;case"size":a.percent(e,t);break;case"align":a.alt(e,t,["start","center","end","left","right","middle"])}},/:/,/\s/),t.region=a.get("region",null),t.vertical=a.get("vertical",""),t.line=a.get("line",void 0===t.line?"auto":t.line);e=a.get("lineAlign","start");t.lineAlign="center"===e||"middle"===e?this.middleOrCenter:e,t.snapToLines=a.get("snapToLines",!0),t.size=a.get("size",100);e=a.get("align","center");t.align="center"===e||"middle"===e?this.middleOrCenter:e,t.position=a.get("position","auto");e=a.get("positionAlign",{start:"start",left:"start",center:"center",middle:"middle",right:"end",end:"end"},t.align);t.positionAlign="center"===e||"middle"===e?this.middleOrCenter:{start:"start","line-left":"start",left:"start",center:"center",middle:"middle","line-right":"end",right:"end",end:"end"}[e]})(t,e)}parseRegion(e){var n=new d;this.parseOptions(e,(e,t)=>{switch(e){case"id":n.set(e,t);break;case"width":n.percent(e,t);break;case"lines":n.integer(e,t);break;case"regionanchor":case"viewportanchor":var i=t.split(",");if(2!==i.length)break;var r=new d;if(r.percent("x",i[0]),r.percent("y",i[1]),!r.has("x")||!r.has("y"))break;n.set(e+"X",r.get("x")),n.set(e+"Y",r.get("y"));break;case"scroll":n.alt(e,t,["up"])}},/=/,/\s/),n.has("id")&&((e=new i.VTTRegion).width=n.get("width",100),e.lines=n.get("lines",3),e.regionAnchorX=n.get("regionanchorX",0),e.regionAnchorY=n.get("regionanchorY",100),e.viewportAnchorX=n.get("viewportanchorX",0),e.viewportAnchorY=n.get("viewportanchorY",100),e.scroll=n.get("scroll",""),this.onregion&&this.onregion(e),this.regionList.push({id:n.get("id"),region:e}))}parseStyle(e){var t,e=e.split("}");for(t of(e.pop(),e)){var i=null,r=null,n=t.split("{");n[0]&&(i=n[0].trim()),n[1]&&(r=(e=>{for(var t,i,r={},n=e.split(";"),a=0;a<n.length;a++)n[a].includes(":")&&(t=(i=n[a].split(":",2))[0].trim(),i=i[1].trim(),""!==t&&""!==i&&(r[t]=i));return r})(n[1])),i&&r&&(this._styles[i]=r)}this.onStylesParsedCallback&&this.onStylesParsedCallback(this._styles)}parseHeader(e){this.parseOptions(e,function(e,t){"Region"===e&&this.parseRegion(t)},/:/)}parse(e){e&&(this.buffer+=this.decoder.decode(e,{stream:!0}));var t=()=>{for(var e=this.buffer,t=0,i={start:e.length,length:0};t<e.length;){var r=((e,t)=>{var i={start:-1,length:-1};if("\r"===e[t])i.start=t,i.length=1;else if("\n"===e[t])i.start=t,i.length=1;else if("<"===e[t]&&t+1<e.length&&"b"===e[t+1]&&t+2<e.length&&"r"===e[t+2]){for(var r=t+2;r<e.length&&">"!==e[r++];);i.start=t,i.length=r-t}return i})(e,t);if(0<r.length){i=r;break}++t}var n=e.substr(0,i.start);return this.buffer=e.substr(i.start+i.length),n};try{if("INITIAL"===this.state){if(!/\r\n|\n/.test(this.buffer))return this;this.alreadyCollectedLine="";var i=t(),r=/^(ï»¿)?WEBVTT([ \t].*)?$/.exec(i);if(!r||!r[0])throw new l(l.Errors.BadSignature);this.state="HEADER"}for(;this.buffer;){if(!/\r\n|\n/.test(this.buffer))return this;switch(this.alreadyCollectedLine?(i=this.alreadyCollectedLine,this.alreadyCollectedLine=""):i=t(),this.state){case"HEADER":i.includes(":")?this.parseHeader(i):i||(this.state="ID");continue;case"NOTE":i||(this.state="ID");continue;case"STYLE":i?this.styleCollector+=i:(this.parseStyle(this.styleCollector),this.state="ID",this.styleCollector="");continue;case"ID":if(/^NOTE($|[ \t])/.test(i)){this.state="NOTE";break}if(/^STYLE($|[ \t])/.test(i)){this.state="STYLE";break}if(!i)continue;if(this.cue=new a.VTTCue(0,0,""),this.state="CUE",!i.includes("--\x3e")){this.cue.id=i;continue}case"CUE":try{this.parseCue(i,this.cue,this.regionList)}catch(e){this.reportOrThrowError(e),this.cue=null,this.state="BADCUE";continue}this.state="CUETEXT";continue;case"CUETEXT":var n=i.includes("--\x3e");if(!i||n){this.alreadyCollectedLine=i,this.oncue&&this.oncue(this.cue),this.cue=null,this.state="ID";continue}this.cue.text&&(this.cue.text+="\n"),this.cue.text+=i;continue;case"BADCUE":i||(this.state="ID");continue}}}catch(e){this.reportOrThrowError(e),"CUETEXT"===this.state&&this.cue&&this.oncue&&this.oncue(this.cue),this.cue=null,this.state="INITIAL"===this.state?"BADWEBVTT":"BADCUE"}return this}flush(){try{if(this.buffer+=this.decoder.decode(),!this.cue&&"HEADER"!==this.state||(this.buffer+="\n\n",this.parse()),"INITIAL"===this.state)throw new l(l.Errors.BadSignature)}catch(e){this.reportOrThrowError(e)}return this.onflush&&this.onflush(),this}styles(){return this._styles}}e.default=n,e.WebVTTParser=n,t(Jd,e)}(xs);var Zd,t={};!function(e){var r=Ta&&Ta.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){e[r=void 0===r?i:r]=t[i]}),t=Ta&&Ta.__exportStar||function(e,t){for(var i in e)"default"===i||t.hasOwnProperty(i)||r(t,e,i)};Object.defineProperty(e,"__esModule",{value:!0}),e.VTTCue=e.WebVTTRenderer=e.BoxPosition=e.CueStyleBox=e.StyleBox=void 0;var i=Vd;Object.defineProperty(e,"VTTCue",{enumerable:!0,get:function(){return i.VTTCue}});var o=$d,d=[/^(::cue\()(\..*)(\))/,/^(::cue\()(#.*)(\))/,/^(::cue\()(c|i|b|u|ruby|rt|v|lang)(\))/],n=[[1470,1470],[1472,1472],[1475,1475],[1478,1478],[1488,1514],[1520,1524],[1544,1544],[1547,1547],[1549,1549],[1563,1563],[1566,1610],[1645,1647],[1649,1749],[1765,1766],[1774,1775],[1786,1805],[1807,1808],[1810,1839],[1869,1957],[1969,1969],[1984,2026],[2036,2037],[2042,2042],[2048,2069],[2074,2074],[2084,2084],[2088,2088],[2096,2110],[2112,2136],[2142,2142],[2208,2208],[2210,2220],[8207,8207],[64285,64285],[64287,64296],[64298,64310],[64312,64316],[64318,64318],[64320,64321],[64323,64324],[64326,64449],[64467,64829],[64848,64911],[64914,64967],[65008,65020],[65136,65140],[65142,65276],[67584,67589],[67592,67592],[67594,67637],[67639,67640],[67644,67644],[67647,67669],[67671,67679],[67840,67867],[67872,67897],[67903,67903],[67968,68023],[68030,68031],[68096,68096],[68112,68115],[68117,68119],[68121,68147],[68160,68167],[68176,68184],[68192,68223],[68352,68405],[68416,68437],[68440,68466],[68472,68479],[68608,68680],[126464,126467],[126469,126495],[126497,126498],[126500,126500],[126503,126503],[126505,126514],[126516,126519],[126521,126521],[126523,126523],[126530,126530],[126535,126535],[126537,126537],[126539,126539],[126541,126543],[126545,126546],[126548,126548],[126551,126551],[126553,126553],[126555,126555],[126557,126557],[126559,126559],[126561,126562],[126564,126564],[126567,126570],[126572,126578],[126580,126583],[126585,126588],[126590,126590],[126592,126601],[126603,126619],[126625,126627],[126629,126633],[126635,126651],[1114109,1114109]];class l{applyStyles(e,t){for(var i in t=t||this.div,e)e.hasOwnProperty(i)&&(t.style[i]=e[i])}formatStyle(e,t){return 0===e?"0":e+t}}e.StyleBox=l;class u extends l{constructor(e,t,i,r,n){super();var a={start:"left","line-left":"left",left:"left",center:"center",middle:"center","line-right":"right",right:"right",end:"right"}[(this.cue=t).positionAlign]||t.align,a={textAlign:a="middle"===a?"center":a,whiteSpace:"pre-line",position:"absolute"};a.direction=this.determineBidi(this.cueDiv),a.writingMode=this.directionSettingToWritingMode(t.vertical),a.unicodeBidi="plaintext",this.div=e.document.createElement("div"),this.applyStyles(a),a={backgroundColor:r.backgroundColor,display:"inline-block"},this.parseOpacity(a.backgroundColor)&&(a.padding="5px",a.borderRadius="5px"),this.backgroundDiv=e.document.createElement("div"),this.applyStyles(a,this.backgroundDiv),(a={color:i.color,backgroundColor:i.backgroundColor,textShadow:i.textShadow,fontSize:i.fontSize,fontFamily:i.fontFamily,position:"relative",left:"0",right:"0",top:"0",bottom:"0",display:"inline-block",textOrientation:"upright"}).writingMode=this.directionSettingToWritingMode(t.vertical),a.unicodeBidi="plaintext",this.cueDiv=o.default.parseContent(e,t,n),this.applyStyles(a,this.cueDiv),this.backgroundDiv.appendChild(this.cueDiv),this.div.appendChild(this.backgroundDiv);var s=0;if("number"==typeof t.position){a=t.positionAlign||t.align;if(a)switch(a){case"start":case"left":s=t.position;break;case"center":case"middle":s=t.position-t.size/2;break;case"end":case"right":s=t.position-t.size}}""===t.vertical?this.applyStyles({left:this.formatStyle(s,"%"),width:this.formatStyle(t.size,"%")}):this.applyStyles({top:this.formatStyle(s,"%"),height:this.formatStyle(t.size,"%")})}determineBidi(e){var t=[],i="";if(!e||!e.childNodes)return"ltr";function a(e,t){for(var i=t.childNodes.length-1;0<=i;i--)e.push(t.childNodes[i])}for(a(t,e);i=function e(t){if(!t||!t.length)return null;var i=t.pop(),r=i.textContent||i.innerText;if(r){var n=/^.*(\n|\r)/.exec(r);return n?(t.length=0,n[0]):r}return"ruby"===i.tagName?e(t):i.childNodes?(a(t,i),e(t)):void 0}(t);)for(var r=0;r<i.length;r++)if(function(e,t){for(var i of t)if(e>=i[0]&&e<=i[1])return!0;return!1}(i.charCodeAt(r),n))return"rtl";return"ltr"}parseOpacity(e){if(!e||"string"!=typeof e)return null;e=(e=e.replace(/ /g,"").replace("rgba(","").replace(")","")).split(",");return e&&4<=e.length?e[3]:null}directionSettingToWritingMode(e){return""===e?"horizontal-tb":"lr"===e?"vertical-lr":"vertical-rl"}move(e){this.applyStyles({top:this.formatStyle(e.top,"px"),bottom:this.formatStyle(e.bottom,"px"),left:this.formatStyle(e.left,"px"),right:this.formatStyle(e.right,"px"),height:this.formatStyle(e.height,"px"),width:this.formatStyle(e.width,"px")})}}e.CueStyleBox=u;class m{constructor(e){var t,i,r,n,a,s,o,l;e instanceof u&&e.cue?(s=e.cue)&&""!==s.vertical?this.property="width":this.property="height":e instanceof m&&(this.property=e.property||"height"),e instanceof u&&e.div?(r=e.div.offsetHeight,n=e.div.offsetWidth,a=e.div.offsetTop,l=(i=((s=e.div.firstChild)||e.div).getBoundingClientRect())&&i[this.property]||null,s&&s.firstChild&&(o=s.firstChild)&&"string"==typeof o.textContent&&(t=l/this.calculateNewLines(o.textContent))):e instanceof m&&(i=e),this.left=i.left,this.right=i.right,this.top=i.top||a,this.height=i.height||r,this.bottom=i.bottom||a+(i.height||r),this.width=i.width||n,this.lineHeight=null!==l?l:i.lineHeight,this.singleLineHeight=null!==t?t:i.singleLineHeight,this.singleLineHeight||(this.singleLineHeight=41)}calculateNewLines(e){for(var t=1,i=0;i<e.length;i++)"\n"===e[i]&&t++;return t}move(e,t){switch(t=void 0!==t?t:this.singleLineHeight,e){case"+x":this.left+=t,this.right+=t;break;case"-x":this.left-=t,this.right-=t;break;case"+y":this.top+=t,this.bottom+=t;break;case"-y":this.top-=t,this.bottom-=t}}overlaps(e){return this.left<e.right&&this.right>e.left&&this.top<e.bottom&&this.bottom>e.top}overlapsAny(e){for(var t of e)if(this.overlaps(t))return!0;return!1}within(e){return this.top>=e.top&&this.bottom<=e.bottom&&this.left>=e.left&&this.right<=e.right}moveIfOutOfBounds(e,t){switch(t){case"+x":this.left<e.left&&(this.left=e.left,this.right=this.left+this.width);break;case"-x":this.right>e.right&&(this.right=e.right,this.left=this.right-this.width);break;case"+y":this.top<e.top&&(this.top=e.top,this.bottom=this.top+this.height);break;case"-y":this.bottom>e.bottom&&(this.bottom=e.bottom,this.top=this.bottom-this.height)}}toCSSCompatValues(e){return{top:this.top-e.top,bottom:e.bottom-this.bottom,left:this.left-e.left,right:e.right-this.right,height:this.height,width:this.width}}static getSimpleBoxPosition(e){var t=null;e instanceof l&&e.div?t=e.div:e instanceof HTMLElement&&(t=e);var i=t.offsetHeight||0,r=t.offsetWidth||0,n=t.offsetTop||0,a=n+i,s=t.getBoundingClientRect(),{left:e,right:t}=s;return s.top&&(n=s.top),s.height&&(i=s.height),s.width&&(r=s.width),{left:e,right:t,top:n,height:i,bottom:a=s.bottom?s.bottom:a,width:r}}static getBoxPosition(e,t){if(e&&0<e.length){for(var i=0,r=e[0][t],n=0;n<e.length;n++)t in["top","right"]?e[n][t]>r&&(r=e[i=n][t]):t in["bottom","left"]&&e[n][t]<r&&(r=e[i=n][t]);return e[i]}return null}static moveToMinimumDistancePlacement(e,t,i){"height"===e.property?"+y"===t?(e.top=i.topMostBoxPosition.bottom+0,e.bottom=e.top+e.height):"-y"===t&&(e.bottom=i.bottomMostBoxPosition.top-0,e.top=e.bottom-e.height):"width"===e.property&&("+x"===t?(e.left=i.rightMostBoxPosition.right+0,e.right=e.left+e.width):"-x"===t&&(e.right=i.leftMostBoxPosition.left-0,e.left=e.right-e.width))}static moveBoxToLinePosition(e,s,o){var t,n=e.cue,i=new m(e),r=function(){if("number"==typeof n.line&&(n.snapToLines||0<=n.line&&n.line<=100))return n.line;if(!n.track||!n.track.textTrackList||!n.track.textTrackList.mediaElement)return-1;for(var e=0,t=n.track,i=t.textTrackList,r=0;r<i.length&&i[r]!==t;r++)"showing"===i[r].mode&&e++;return-1*++e}(),a=[];if(n.snapToLines){var l=0;switch(n.vertical){case"":a=["+y","-y"],t="height";break;case"rl":a=["+x","-x"],t="width";break;case"lr":a=["-x","+x"],t="width"}var d=i.lineHeight,u=s[t]+d,c=a[0];if(r<0){var h=0;switch(n.vertical){case"":h=s.height-d-.05*s.height;break;case"rl":case"lr":h=-s.width+d+.05*s.width}l=h,a=a.reverse()}else{switch(n.vertical){case"":case"lr":l=d*Math.round(r);break;case"rl":l=s.width-d*Math.round(r)}Math.abs(l)>u&&(l=l<0?-1:1,l*=Math.ceil(u/d)*d)}i.move(c,l)}else{var c=""===n.vertical?s.height:s.width,p=i.lineHeight/c*100;switch(n.lineAlign){case"center":case"middle":r-=p/2;break;case"end":r-=p}switch(n.vertical){case"":e.applyStyles({top:e.formatStyle(r,"%")});break;case"rl":e.applyStyles({right:e.formatStyle(r,"%")});break;case"lr":e.applyStyles({left:e.formatStyle(r,"%")})}a=["+y","-y","+x","-x"],"+y"===n.axis?a=["+y","-y","+x","-x"]:"-y"===n.axis&&(a=["-y","+y","+x","-x"]),i=new m(e)}i=function(e,t){for(var i,r=0;r<t.length;r++){e.moveIfOutOfBounds(s,t[r]);for(var n=0,a=!1;e.overlapsAny(o)&&!(9<n);)a?e.move(t[r]):(o&&0<o.length&&(i=i||{topMostBoxPosition:m.getBoxPosition(o,"top"),bottomMostBoxPosition:m.getBoxPosition(o,"bottom"),leftMostBoxPosition:m.getBoxPosition(o,"left"),rightMostBoxPosition:m.getBoxPosition(o,"right")},m.moveToMinimumDistancePlacement(e,t[r],i)),a=!0),n++}return e}(i,a);e.move(i.toCSSCompatValues(s))}}e.BoxPosition=m;class a{constructor(e,t){var i=!(2<arguments.length&&void 0!==arguments[2])||arguments[2];if(!e)return null;this.window=e,this.overlay=t,this.loggingEnabled=i,this.foregroundStyleOptions={fontFamily:"Helvetica",fontSize:"36px",color:"rgba(255, 255, 255, 1)",textShadow:"",backgroundColor:"rgba(0, 0, 0, 0)"},this.backgroundStyleOptions={backgroundColor:"rgba(0, 0, 0, 0.5)"},this.globalStyleCollection={};e=e.document.createElement("div");e.style.position="absolute",e.style.left="0",e.style.right="0",e.style.top="0",e.style.bottom="0",e.style.margin="1.5%",this.paddedOverlay=e,t.appendChild(this.paddedOverlay),this.initSubtitleCSS()}initSubtitleCSS(){var e=[new i.VTTCue(0,0,"String to init CSS - Won't be visible to user")];this.paddedOverlay.style.opacity="0",this.processCues(e),this.processCues([]),this.paddedOverlay.style.opacity="1"}convertCueToDOMTree(e){return e?o.default.parseContent(this.window,e,this.globalStyleCollection):null}setStyles(e){function t(e,t,i){for(var r in t)t.hasOwnProperty(r)&&(!0===i&&void 0!==e[r]||!1===i)&&(e[r]=t[r])}for(var i in e){var r=!1,n=null;"::cue"===i?(n=this.foregroundStyleOptions,r=!0):"::-webkit-media-text-track-display"===i&&(n=this.backgroundStyleOptions,r=!0);var a=e[i];if(!0===r)t(n,a,r);else for(var s=0;s<d.length;s++){var o,l=d[s].exec(i);l&&4===l.length&&(o=l[2],t(l={},a,r),this.globalStyleCollection[o]=l)}}this.initSubtitleCSS(),this.loggingEnabled&&(console.log("WebVTTRenderer setStyles foregroundStyleOptions: "+JSON.stringify(this.foregroundStyleOptions)),console.log("WebVTTRenderer setStyles backgroundStyleOptions: "+JSON.stringify(this.backgroundStyleOptions)),console.log("WebVTTRenderer setStyles globalStyleCollection: "+JSON.stringify(this.globalStyleCollection)))}processCues(e){if(e){for(;this.paddedOverlay.firstChild;)this.paddedOverlay.removeChild(this.paddedOverlay.firstChild);if(function(e){for(var t=0;t<e.length;t++)if(e[t].hasBeenReset||!e[t].displayState)return!0;return!1}(e)){var t=[],i=m.getSimpleBoxPosition(this.paddedOverlay);1<e.length&&(e=function(e){for(var t=[],i=0,r=0;r<e.length;r++){var n=e[r];if("number"!=typeof n.line)return e;i+=n.line,t.push(n)}return 50<(i/=e.length)?(t.forEach(function(e){e.axis="-y"}),t.sort((e,t)=>t.line-e.line)):(t.forEach(function(e){e.axis="+y"}),t.sort((e,t)=>e.line-t.line)),t}(e));for(var r=0;r<e.length;r++){var n=e[r],a=new u(this.window,n,this.foregroundStyleOptions,this.backgroundStyleOptions,this.globalStyleCollection);this.paddedOverlay.appendChild(a.div),m.moveBoxToLinePosition(a,i,t),n.displayState=a.div,t.push(m.getSimpleBoxPosition(a))}}else for(var s=0;s<e.length;s++)this.paddedOverlay.appendChild(e[s].displayState)}}setSize(e,t){e&&(this.overlay.style.width=e+"px"),t&&(this.overlay.style.height=t+"px")}getOverlay(){return this.overlay}}e.default=a,e.WebVTTRenderer=a,t(Jd,e)}(t),Ea=Ud,Zd=Ta&&Ta.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){e[r=void 0===r?i:r]=t[i]}),Ds=Ta&&Ta.__exportStar||function(e,t){for(var i in e)"default"===i||t.hasOwnProperty(i)||Zd(t,e,i)},Object.defineProperty(Ea,"__esModule",{value:!0}),Ds(xs,Ea),Ds(t,Ea);const eu=9e4;function tu(e,t,i){return e.substr(i||0,t.length)===t}function iu(e){var t=Math.floor(e),i=t+.5,r=t+1;return i<=e?r-e<=e-i?r:i:i-e<=e-t?i:t}function ru(e,t=0,i=8589934592){if(!Number.isFinite(t))return e;var r=i/2,n=Math.abs(e-t)%i;return t+(t<e?-1:1)*(r<n?i-n:-n)}function nu(e){let t=e;return su.hasOwnProperty(e)&&(t=su[e]),String.fromCharCode(t)}function au(t){const i=[];for(let e=0;e<t.length;e++)i.push(t[e].toString(16));return i}const su={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},ou=15,lu=100,du={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},uu={17:2,18:4,21:6,22:8,23:10,19:13,20:15},cu={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},hu={25:2,26:4,29:6,30:8,31:10,27:13,28:15},pu=["white","green","blue","cyan","red","yellow","magenta","black","transparent"],mu={verboseFilter:{DATA:3,DEBUG:3,INFO:2,WARNING:2,TEXT:1,ERROR:0},time:null,verboseLevel:0,setTime:function(e){this.time=e},log:function(e,t){var i=this.verboseFilter[e];this.verboseLevel>=i&&console.log(this.time+" ["+e+"] "+t)}};class fu{constructor(e,t,i,r,n){this.foreground=e||"white",this.underline=t||!1,this.italics=i||!1,this.background=r||"black",this.flash=n||!1}reset(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}setStyles(e){Object.assign(this,e)}isDefault(){return"white"===this.foreground&&!this.underline&&!this.italics&&"black"===this.background&&!this.flash}equals(e){return this.foreground===e.foreground&&this.underline===e.underline&&this.italics===e.italics&&this.background===e.background&&this.flash===e.flash}copy(e){this.foreground=e.foreground,this.underline=e.underline,this.italics=e.italics,this.background=e.background,this.flash=e.flash}toString(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash}}class gu{constructor(e,t,i,r,n,a){this.uchar=e||" ",this.penState=new fu(t,i,r,n,a)}reset(){this.uchar=" ",this.penState.reset()}setChar(e,t){this.uchar=e,this.penState.copy(t)}setPenState(e){this.penState.copy(e)}equals(e){return this.uchar===e.uchar&&this.penState.equals(e.penState)}copy(e){this.uchar=e.uchar,this.penState.copy(e.penState)}isEmpty(){return" "===this.uchar&&this.penState.isDefault()}}class yu{constructor(){this.cueStartTime=null,this.chars=[];for(let e=0;e<lu;e++)this.chars.push(new gu);this.pos=0,this.currPenState=new fu}equals(t){let i=!0;for(let e=0;e<lu;e++)if(!this.chars[e].equals(t.chars[e])){i=!1;break}return i}copy(t){for(let e=0;e<lu;e++)this.chars[e].copy(t.chars[e])}isEmpty(){let t=!0;for(let e=0;e<lu;e++)if(!this.chars[e].isEmpty()){t=!1;break}return t}setCursor(e){this.pos!==e&&(this.pos=e),this.pos<0?(mu.log("ERROR","Negative cursor position "+this.pos),this.pos=0):this.pos>lu&&(mu.log("ERROR","Too large cursor position "+this.pos),this.pos=lu)}moveCursor(e){var t=this.pos+e;if(1<e)for(let e=this.pos+1;e<t+1;e++)this.chars[e].setPenState(this.currPenState);this.setCursor(t)}backSpace(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState)}insertChar(e){144<=e&&this.backSpace();var t=nu(e);this.pos>=lu?mu.log("ERROR","Cannot insert "+e.toString(16)+" ("+t+") at position "+this.pos+". Skipping it!"):(this.chars[this.pos].setChar(t,this.currPenState),this.moveCursor(1))}clearFromPos(e){let t;for(t=e;t<lu;t++)this.chars[t].reset()}clear(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()}clearToEndOfRow(){this.clearFromPos(this.pos)}getTextString(){const t=[];let i=!0;for(let e=0;e<lu;e++){var r=this.chars[e].uchar;" "!==r&&(i=!1),t.push(r)}return i?"":t.join("")}setPenStyles(e){this.currPenState.setStyles(e),this.chars[this.pos].setPenState(this.currPenState)}}class vu{constructor(){this.nrRollUpRows=null,this.lastOutputScreen=null,this.rows=[];for(let e=0;e<ou;e++)this.rows.push(new yu);this.currRow=14,this.reset()}reset(){for(let e=0;e<ou;e++)this.rows[e].clear();this.currRow=14}equals(t){let i=!0;for(let e=0;e<ou;e++)if(!this.rows[e].equals(t.rows[e])){i=!1;break}return i}copy(t){for(let e=0;e<ou;e++)this.rows[e].copy(t.rows[e])}isEmpty(){let t=!0;for(let e=0;e<ou;e++)if(!this.rows[e].isEmpty()){t=!1;break}return t}backSpace(){this.rows[this.currRow].backSpace()}clearToEndOfRow(){this.rows[this.currRow].clearToEndOfRow()}insertChar(e){this.rows[this.currRow].insertChar(e)}setPen(e){this.rows[this.currRow].setPenStyles(e)}moveCursor(e){this.rows[this.currRow].moveCursor(e)}setCursor(e){mu.log("INFO","setCursor: "+e),this.rows[this.currRow].setCursor(e)}setPAC(t){var i;mu.log("INFO","pacData = "+JSON.stringify(t));let r=t.row-1;if(this.nrRollUpRows&&r<this.nrRollUpRows-1&&(r=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==r){for(let e=0;e<ou;e++)this.rows[e].clear();const t=this.currRow+1-this.nrRollUpRows,i=this.lastOutputScreen;if(i){const e=i.rows[t].cueStartTime;if(z(e)&&z(mu.time)&&e<mu.time)for(let e=0;e<this.nrRollUpRows;e++)this.rows[r-this.nrRollUpRows+e+1].copy(i.rows[t+e])}}this.currRow=r;const e=this.rows[this.currRow];if(null!==t.indent){const r=t.indent,n=Math.max(r-1,0);e.setCursor(t.indent),t.color=null!==(i=e.chars[n].penState.foreground)&&void 0!==i?i:""}const n={foreground:t.color,underline:t.underline,italics:t.italics,background:"black",flash:!1};this.setPen(n)}setBkgData(e){mu.log("INFO","bkgData = "+JSON.stringify(e)),this.backSpace(),this.setPen(e),this.insertChar(32)}setRollUpRows(e){this.nrRollUpRows=e}rollUp(){if(null!==this.nrRollUpRows){mu.log("INFO","TEXT "+this.getDisplayText());const e=this.currRow+1-this.nrRollUpRows,t=this.rows.splice(e,1)[0];t.clear(),this.rows.splice(this.currRow,0,t),mu.log("INFO","Rolling up")}else mu.log("DEBUG","roll_up but nrRollUpRows not set yet")}getDisplayText(t){t=t||!1;const i=[];let e="",r;for(let e=0;e<ou;e++){const n=this.rows[e].getTextString();n&&(r=e+1,t?i.push("Row "+r+": '"+n+"'"):i.push(n.trim()))}return 0<i.length&&(e=t?"["+i.join(" | ")+"]":i.join("\n")),e}getTextAndFormat(){return this.rows}}class Su{constructor(e,t){this.mode=null,this.cueStartTime=null,this.lastCueEndTime=null,this.chNr=e,this.outputFilter=t,this.verbose=0,this.displayedMemory=new vu,this.nonDisplayedMemory=new vu,this.lastOutputScreen=new vu,this.currRollUpRow=this.displayedMemory.rows[14],this.writeScreen=this.displayedMemory}reset(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.currRollUpRow=this.displayedMemory.rows[14],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.lastCueEndTime=null}getHandler(){return this.outputFilter}setHandler(e){this.outputFilter=e}setPAC(e){this.writeScreen.setPAC(e)}setBkgData(e){this.writeScreen.setBkgData(e)}setMode(e){e!==this.mode&&(this.mode=e,mu.log("INFO","MODE="+e),"MODE_POP-ON"===this.mode?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),"MODE_ROLL-UP"!==this.mode&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=e)}insertChars(t){for(let e=0;e<t.length;e++)this.writeScreen.insertChar(t[e]);var e=this.writeScreen===this.displayedMemory?"DISP":"NON_DISP";mu.log("INFO",e+": "+this.writeScreen.getDisplayText(!0)),"MODE_PAINT-ON"!==this.mode&&"MODE_ROLL-UP"!==this.mode||(mu.log("TEXT","DISPLAYED: "+this.displayedMemory.getDisplayText(!0)),this.outputDataUpdate())}ccRCL(){mu.log("INFO","RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")}ccBS(){mu.log("INFO","BS - BackSpace"),"MODE_TEXT"!==this.mode&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())}ccAOF(){}ccAON(){}ccDER(){mu.log("INFO","DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()}ccRU(e){mu.log("INFO","RU("+e+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(e)}ccFON(){mu.log("INFO","FON - Flash On"),this.writeScreen.setPen({flash:!0})}ccRDC(){mu.log("INFO","RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")}ccTR(){mu.log("INFO","TR"),this.setMode("MODE_TEXT")}ccRTD(){mu.log("INFO","RTD"),this.setMode("MODE_TEXT")}ccEDM(){mu.log("INFO","EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate(!0)}ccCR(){mu.log("INFO","CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate(!0)}ccENM(){mu.log("INFO","ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset()}ccEOC(){var e;mu.log("INFO","EOC - End Of Caption"),"MODE_POP-ON"===this.mode&&(e=this.displayedMemory,this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=e,this.writeScreen=this.nonDisplayedMemory,mu.log("TEXT","DISP: "+this.displayedMemory.getDisplayText())),this.outputDataUpdate(!0)}ccTO(e){mu.log("INFO","TO("+e+") - Tab Offset"),this.writeScreen.moveCursor(e)}ccMIDROW(e){const t={flash:!1,underline:!1,italics:!1};t.underline=e%2==1,t.italics=46<=e,t.italics?t.foreground="white":(e=Math.floor(e/2)-16,t.foreground=["white","green","blue","cyan","red","yellow","magenta"][e]),mu.log("INFO","MIDROW: "+JSON.stringify(t)),this.writeScreen.setPen(t)}outputDataUpdate(e=!1){var t=mu.time;null!==t&&this.outputFilter&&(this.outputFilter.updateData&&this.outputFilter.updateData(t,this.displayedMemory),null!==this.cueStartTime||this.displayedMemory.isEmpty()?this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue&&z(this.cueStartTime)&&(this.outputFilter.newCue(this.cueStartTime,t,this.lastOutputScreen),!0===e&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue()),this.cueStartTime=this.displayedMemory.isEmpty()?null:t):this.cueStartTime=t,this.lastOutputScreen.copy(this.displayedMemory))}cueSplitAtTime(e){this.outputFilter&&(this.displayedMemory.isEmpty()||(this.outputFilter.newCue&&z(this.cueStartTime)&&this.outputFilter.newCue(this.cueStartTime,e,this.displayedMemory),this.cueStartTime=e))}}var Iu,bu,Tu={newCue:function(e,t,i,r,n,a){let s,o,l,d,u;var c,h,p={foreground:void 0,background:void 0,italics:!1,underline:!1,flash:!1,styleStack:[]};for([c,h]of r.rows.entries())if(o=!0,l=0,d="",!h.isEmpty()){for(let e=0;e<h.chars.length;e++)h.chars[e].uchar.match(/\s/)&&o?l++:(d+=this.getFormattedChar(h.chars[e],p),o=!1);(h.cueStartTime=t)===i&&(i+=1e-4),d=d.trim().replace(/<br(?: \/)?>/gi,"\n"),d+=this.closeStyles(p),s=new Ud.VTTCue(t,i,d),16<=l?l--:l++,u=!navigator.userAgent.match(/Firefox\//)&&7<c?c:c+1,s.snapToLines=!1,s.line=10+5.33*u,s.align="left",s.position=this.getPosition(l,n,a),e.addCue(s)}},getPosition:function(e,t,i){let r=1.3333333333333333;t&&i&&1.6<=t/i&&(r=1.7777777777777777);let n=10+e/32*80,a=10,s=90;return 1.7777777777777777===r&&(n=12.5+.75*n,a=20,s=80),Math.max(a,Math.min(s,n+(navigator.userAgent.match(/Firefox\//)?50:0)))},getRootStyleTag:function(e){var t=e[0];return"c"===t?t:e},closeStyles:function(t){let i="";for(let e=t.styleStack.length-1;0<=e;--e)i+="</"+this.getRootStyleTag(t.styleStack[e])+">",t.styleStack.pop();return i},beginStyleAndBalance:function(e,t){let i="";return"c"===t[0]&&(i+=this.closeStyleAndBalance(e,"c")),i+="<"+t+">",e.styleStack.push(t),i},closeStyleAndBalance:function(t,i){var r=t.styleStack.length;let n=0,a="";for(let e=r-1;0<=e;--e){var s=t.styleStack[e],o=this.getRootStyleTag(s);if(i[0]===s[0]){a+="</"+o+">",t.styleStack.splice(r-1-n);break}"c"===o[0]?(t.background="",t.foreground="",t.flash=!1,a+="</c>"):"u"===o[0]?(t.underline=!1,a+="</u>"):"i"===o[0]&&(t.italics=!1,a+="</i>"),n++}return a},getFormattedChar:function(e,t){var i;let r="",n=e.uchar,a="";var s=e.penState.foreground!==t.foreground,o=e.penState.background!==t.background,l=e.penState.flash!==t.flash;return(s||o||l)&&(a="."+e.penState.foreground,a+=".bg_"+e.penState.background,e.penState.flash&&l&&(a+=".blink"),e.penState.foreground||e.penState.background||e.penState.blink?r+=this.beginStyleAndBalance(t,"c"+a):r+=this.closeStyleAndBalance(t,"c"),s&&(t.foreground=e.penState.foreground),o&&(t.background=e.penState.background),l&&(t.flash=null!==(i=e.penState.flash)&&void 0!==i&&i)),e.penState.underline!==t.underline&&(r+=e.penState.underline?this.beginStyleAndBalance(t,"u"):this.closeStyleAndBalance(t,"u"),t.underline=null!==(i=e.penState.underline)&&void 0!==i&&i),e.penState.italics!==t.italics&&(r+=e.penState.italics?this.beginStyleAndBalance(t,"i"):this.closeStyleAndBalance(t,"i"),t.italics=null!==(e=e.penState.italics)&&void 0!==e&&e),r+n}};class Eu{constructor(e,t){this.handler=e,this.track=t,this.startTime=null,this.endTime=null,this.screen=null}dispatchCue(){null!==this.startTime&&null!==this.endTime&&(this.handler.addCues("cc"+this.track,this.startTime,this.endTime,this.screen),this.startTime=null)}newCue(e,t,i){(null===this.startTime||this.startTime>e)&&(this.startTime=e),this.endTime=t,this.screen=i,this.handler.createHTMLCaptionsTrack(this.track)}}const Au=9e4,Ou=/^(\d{2,}):(\d{2}):(\d{2}):(\d{2})\.?(\d+)?$/,wu=/^(\d*(?:\.\d*)?)(h|m|s|ms|f|t)$/,Ru={extractXML(e){e=De.findBox(e,["mdat"]);return e.length?Y.utf8arrayToStr(e[0]):""},generateCues(e,t,a,i){const r=(new DOMParser).parseFromString(e,"text/xml"),n=r.getElementsByTagName("tt")[0],s="preserve"!==n.getAttribute("xml:space"),o=[];if(!n)return i.error("[subtitle] Invalid ttml"),o;const l=m(t,Au),d={frameRate:30,subFrameRate:1,frameRateMultiplier:0,tickRate:0},u=Object.keys(d).reduce((e,t)=>{var i=n.getAttribute(`ttp:${t}`),i=i&&z(parseInt(i))?parseInt(i):null;return e[t]=i||d[t],e},{frameRate:30,subFrameRate:1,frameRateMultiplier:0,tickRate:0});return r.querySelectorAll("p").forEach(e=>{var t=function r(e,n){return[].slice.call(e.childNodes).reduce((e,t,i)=>{return"br"===t.nodeName&&i?e+"\n":null!==(i=t.childNodes)&&void 0!==i&&i.length?e+r(t,n):n?e+(null!==(i=null===(i=t.textContent)||void 0===i?void 0:i.trim().replace(/\s+/g," "))&&void 0!==i?i:""):e+t.textContent},"")}(e,s);let i=Cu(e.getAttribute("begin"),u);var r=Cu(e.getAttribute("dur"),u);let n=Cu(e.getAttribute("end"),u);!n&&z(i)&&r&&(n=i+r);r=E({baseTime:ru(ru(0)-l.baseTime,a*Au),timescale:Au});if(t&&z(i)&&z(n)){i=ru(i+r-0,0,95443.7176888889),n=ru(n+r-0,0,95443.7176888889);const e=new VTTCue(i,n,t);e.id=g(iu(e.startTime).toString())+g(iu(e.endTime-e.startTime).toString())+g(e.text),o.push(e)}}),o}};function Cu(a,e){if(!a)return null;let t=function(){if(!a)return null;const[e,t,i]=a.split(":"),[r,n]=i.split(".");return 3600*parseInt(e)+60*parseInt(t)+parseInt(r)+parseInt(n)/1e3}();return null===t&&(Ou.test(a)?t=(i=a,r=e,n=Ou.exec(i),i=(0|n[4])+(0|n[5])/r.subFrameRate,3600*(0|n[1])+60*(0|n[2])+(0|n[3])+i/r.frameRate):wu.test(a)&&(t=function(e,t){var e=wu.exec(e),i=Number(e[1]);switch(e[2]){case"h":return 3600*i;case"m":return 60*i;case"ms":return 1e3*i;case"f":return i/t.frameRate;case"t":return i/t.tickRate}return i}(a,e))),t;var i,r,n}(Ea=Iu=Iu||{}).CloseEnough="CloseEnough",Ea.TooFar="TooFar",Ea.Unknown="Unknown",(Ea=bu=bu||{})[Ea.TryAgain=1]="TryAgain",Ea[Ea.Complete=2]="Complete";const ku=e=>"cc1"===e||"cc2"===e;function Mu(t){const i=[];for(let e=0;e<t.length;e++){var r=t[e];("captions"===r.kind||"subtitles"===r.kind||"metadata"===r.kind&&r.customTextTrackCueRenderer)&&i.push(r)}return i}function Pu(e){if(e&&e.cues)for(;0<e.cues.length;)e.removeCue(e.cues[0])}class Lu extends oi{constructor(e,t,i,r){super(e=>{const t=rl(this.hls,this);if(e.add(t.event(N.INLINE_STYLES_PARSED,this.onInlineStylesParsed).pipe(Br(()=>this.destroy())).subscribe()),e.add(Ki(0,this.config.trottleCheckInterval).pipe(on(()=>(this.checkReadyToLoadNextSubtitleFragment(),Yl))).subscribe()),this.config.enableInterstitialPlayback&&(this.config.nativeTextTrackChangeHandling=!1),this.config.nativeTextTrackChangeHandling)if(this.mediaSink.textTracks&&"onchange"in this.mediaSink.textTracks){const t=rl(this.mediaSink.textTracks,this);e.add(t.event("change",this._onTextTracksChanged).subscribe())}else e.add(Ki(0,500).pipe(on(()=>(this._onTextTracksChanged(),Yl))).subscribe())}),this.config=t,this.lastVariantSeqNum=NaN,this.lastDiscoSeqNum=NaN,this.interstitialIsLoading=!1,this.interstitialIsPlaying=!1,this.addCueToInterstitial=!1,this.subtitleTracksCreated=0,this.captionTracksCreated=0,this.tracksReused=0,this.tracksFailed=0,this.destroy$=new Er,this.persistentIdToParsedRecordMap={},this.hls=i,this.logger=r.child({name:"legible"}),this.mediaSink=e,this.id3Track=e.id3TextTrack,this.enableCaption=!0,this.Cues=Tu,this.tracks=[],this.cueRanges=[],this.channelToTrackMap={},this.htmlTextTrackMap={},this.lastCueEndTime=0,this.gotTracks=!1,this.tryAgain$=new qr(bu.TryAgain),this.needNextSubtitle$=new qr(!0)}reset(){this.resetTracks(),this.textTrack1=this.textTrack2=void 0,this.interstitialTextTrack=void 0,this.interstitialCCTrack1=this.interstitialCCTrack2=void 0}destroy(){this.destroy$.next(),this.reset(),this.nativeSubtitleTrackChange$=void 0,this.persistentIdToParsedRecordMap={}}handlePlayingItemChanged(e){var{playingInterstitialId:t,subtitleMediaOption:e}=e;this.interstitialIsPlaying=!!t,this.switchPlayingItemTextTrack(e)}convertCuesIntoSubtitleFragInfo(t,i){const r={};if(null!=t&&0<t.length)for(let e=0;e<t.length;e++){var n=t[e];if(z(n.fragSN)&&n.itemId===i){const a=r[n.fragSN];a?(a.count++,a.startTime=Math.min(n.startTime,a.startTime),a.endTime=Math.max(n.endTime,a.endTime)):r[n.fragSN]={count:1,startTime:n.startTime,endTime:n.endTime}}}return r}checkReadyToLoadNextSubtitleFragment(){let e=!1;this.mediaSink.mediaQuery.currentTime>=this.lastCueEndTime-this.config.subtitleLeadTime&&(e=!0),this.needNextSubtitle$.next(e)}checkReadyToLoadNextSubtitleFragment$(e,t){return e.mediaSeqNum===(null===(t=t[0])||void 0===t?void 0:t.mediaSeqNum)?Pr(!0):(this.checkReadyToLoadNextSubtitleFragment(),this.needNextSubtitle$)}getNextFragment(e,t){t=t.mediaSeqNum+1;return t<e.fragments.length?e.fragments[t-e.startSN]:null}calculateFragInfoMap(e,t,i,r){var n=this.convertCuesIntoSubtitleFragInfo(t,r.itemId);let a={len:0,start:e,end:e},s=e,o=e,l=NaN,d=NaN;for(const t in n)if(Object.prototype.hasOwnProperty.call(n,t)){var u=Number(t);if(z(u)){var c=n[u];if(c&&(!i||this.isFragmentCompleteOrEmpty(u,c.count,i)))if(u===r.startSN&&e<c.startTime&&(s=o=a.start=a.end=e=c.startTime),e>=c.startTime&&(s===e||z(l)&&1<u-l)&&(s=o=c.startTime),e>=c.startTime)o=c.endTime,l=u;else{if(!z(l)||u-l!=1){d=u;break}o=c.endTime,l=u}}}return a={len:o-s,start:s,end:o},{fragInfoMap:n,bufferInfo:a,prevFragSN:l,nextFragSN:d}}findFrags$(i,r,n){return this.tryAgain$.next(bu.TryAgain),this.tryAgain$.pipe(tr(Li),on(()=>{var e=this.findFragmentsForPosition(n,r,i),t=e.foundFrags;return t&&0!==t.length?(this.lastCueEndTime=0,this.needNextSubtitle$.next(!0),Pr(e)):(this.tryAgain$.next(bu.Complete),Cr)}),dn(this.tryAgain$.pipe(_r(e=>e===bu.Complete))),Br(()=>{}))}reviewParsedFrag(i,e,r,n,t){var a=e.frag,s=e.cueRange,o=r.subtitleBufferInfo,l=r.subtitleParsedInfo,e=r.foundFrags;let d=!0;if(a.gap)return Iu.CloseEnough;if(e&&e.length&&a.mediaSeqNum===e[0].mediaSeqNum){if(this.selectedMediaOption==this._interstitialDisableMediaOption&&this.interstitialIsPlaying)return Iu.CloseEnough;if(!r.timelineEstablished)return t?Iu.TooFar:Iu.CloseEnough;if(!s)return Iu.Unknown;if(s.startTime<i){const u=n.fragments,r=a.mediaSeqNum-n.startSN;let e=r,t=s.startTime;for(;e<u.length&&(t+=u[e].duration,!(t>=i));++e);d=e-r<=this.config.earlyFragTolerance}else if(s.startTime>i&&a.mediaSeqNum!==n.startSN){if(!o||!l)return Iu.TooFar;const u=s.startTime-i,r=o.prevFragSN;if(!z(r))return Iu.TooFar;d=a.mediaSeqNum===r+1&&(null===(o=o.fragInfoMap[r])||void 0===o?void 0:o.count)===(null===(l=l[r])||void 0===l?void 0:l.count)||u<=this.config.lateTolerance}}return d?Iu.CloseEnough:Iu.TooFar}isFragmentEmpty(e){return e&&!z(e.startTime)&&0===e.count}isFragmentCompleteOrEmpty(e,t,i){e=i?i[e]:null;return(null==e?void 0:e.count)===t||this.isFragmentEmpty(e)}getEarlierFragmentInSameDisco(e,t,i){var r=t.mediaSeqNum-e.startSN-1;if(r<0||r>e.fragments.length-1)return this.logger.error(`[subtitle] getEarlierFragmentInSameDisco index ${r} out of range`),t;r=e.fragments[r];return r&&r.discoSeqNum===t.discoSeqNum&&!i[t.mediaSeqNum]?r:t}inferSubtitleFragmentForPosition(r,n,a,s,o){var l,d,u;let c,e,h,p,m=null;if(s&&a&&z(s.prevFragSN)&&(c=s.prevFragSN-o.startSN,e=a[s.prevFragSN]),s&&a&&z(s.nextFragSN)&&(h=s.nextFragSN-o.startSN,p=a[s.nextFragSN]),s&&a&&z(c)&&0<=c&&c<o.fragments.length&&e){let t=e.startTime,i=null;const u=z(h)?h:o.fragments.length;for(let e=c;e<u;++e){const h=o.fragments[e];if(!z(n)||h.discoSeqNum===n){if(!(i||z(n)&&h.discoSeqNum!==n)){const r=null===(l=s.fragInfoMap[h.mediaSeqNum])||void 0===l?void 0:l.count;this.isFragmentCompleteOrEmpty(h.mediaSeqNum,null!=r?r:0,a)||(i=h)}if(e===u-1){m={foundFrag:h,timelineEstablished:!0};break}if(t+h.duration>r&&e>c){m={foundFrag:h,timelineEstablished:!0};break}t+=h.duration}}!m&&i&&(m={foundFrag:i,timelineEstablished:!1})}else if(s&&a&&z(h)&&0<=h&&h<o.fragments.length&&p){let t=p.startTime,i=null;for(let e=h-1;0<=e;--e){const c=o.fragments[e];if(!z(n)||c.discoSeqNum===n){if(!z(n)||c.discoSeqNum===n){const r=null===(d=s.fragInfoMap[c.mediaSeqNum])||void 0===d?void 0:d.count;this.isFragmentCompleteOrEmpty(c.mediaSeqNum,null!=r?r:0,a)||(i=c)}if(t<=r){m={foundFrag:c,timelineEstablished:!0};break}t-=c.duration}}!m&&i&&(m={foundFrag:i,timelineEstablished:!1})}else{let t=!0;for(let e=0;e<o.fragments.length;++e){const c=o.fragments[e];if(s&&a&&z(n)&&c.discoSeqNum===n){const n=null!==(u=null===(u=s.fragInfoMap[c.mediaSeqNum])||void 0===u?void 0:u.count)&&void 0!==u?u:0;if(!this.isFragmentCompleteOrEmpty(c.mediaSeqNum,n,a)&&(t=!1,r>=c.start&&r<c.start+c.duration)){m={foundFrag:c,timelineEstablished:!1};break}}}t||m||(m={foundFrag:o.fragments[0],timelineEstablished:!1})}return m}generateFragmentBatch(t,i,e,r,n,a){var s,o;const l=[],d=null==e?void 0:e.foundFrag;if(!d)return{foundFrags:void 0,subtitleParsedInfo:void 0,subtitleBufferInfo:void 0,timelineEstablished:null!==(s=null==e?void 0:e.timelineEstablished)&&void 0!==s&&s};for(let e=d?d.mediaSeqNum-a.startSN:a.fragments.length;e<a.fragments.length&&l.length<t;++e){const t=a.fragments[e];if(t.discoSeqNum===i&&r&&n){const i=null===(o=n.fragInfoMap[t.mediaSeqNum])||void 0===o?void 0:o.count;this.isFragmentCompleteOrEmpty(t.mediaSeqNum,null!=i?i:0,r)||l.push(t)}}return{foundFrags:l,subtitleParsedInfo:null!=r?r:void 0,subtitleBufferInfo:null!=n?n:void 0,timelineEstablished:null==e?void 0:e.timelineEstablished}}findFragmentsForPosition(e,t,i){let r=i.itemId+i.mediaOptionId;var n=this.availableMediaOptions.find(e=>e.mediaOptionId===i.mediaOptionId);n&&n.isInterstitial&&(r="interstitial");let a=this.mediaSink.mediaQuery.getParsedSubtitleRecordsForMediaOption(r);this.config.condenseSubtitleTrack&&n&&z(n.persistentID)&&!n.isInterstitial&&(a&&0<Object.keys(a).length?this.persistentIdToParsedRecordMap[n.persistentID]=a:this.persistentIdToParsedRecordMap[n.persistentID]&&(a=this.persistentIdToParsedRecordMap[n.persistentID]));var n=this.getCuesOfEnabledTrack(null===(s=this.selectedMediaOption)||void 0===s?void 0:s.mediaOptionId,!1),s=this.calculateFragInfoMap(e,n,a,i),n=s.bufferInfo,n=Math.max(e,n.end),n=this.inferSubtitleFragmentForPosition(n,t,a,s,i);return this.generateFragmentBatch(1/0,t,n,a,s,i)}get selectedMediaOption(){let e=this._disabledMediaOption;return this.interstitialIsPlaying&&(e=this._interstitialDisableMediaOption),this.selectedTrack||e}set selectedMediaOption(e){this.selectedTrack="groupId"in e?e:void 0}get selectedTrack(){return this.interstitialIsPlaying?this._interstitialSelectedMediaOption:this._selectedMediaOption}set selectedTrack(e){!this.interstitialIsLoading&&e===this._selectedMediaOption||this.interstitialIsLoading&&e===this._interstitialSelectedMediaOption||(null!=e&&e.isInterstitial?this._interstitialSelectedMediaOption=e:this._selectedMediaOption=e,this.updateTextTrackState(e))}getTrack(t){return this.availableMediaOptions.find(e=>e.mediaOptionId===t)}updateTextTrackState(e){var t;this.mediaSink.textTracks&&(e&&e.isInterstitial&&!this.interstitialIsPlaying||e&&!e.isInterstitial&&this.interstitialIsPlaying||(t=this.selectedTrack?this.getExistingHTMLTextTrack(this.selectedTrack):void 0,e=Mu(this.mediaSink.textTracks),this.performUpdateTextTrack(e,t)))}switchPlayingItemTextTrack(e){var t;this.mediaSink.textTracks&&(t=Mu(this.mediaSink.textTracks),e=e?this.getExistingHTMLTextTrack(e):void 0,this.performUpdateTextTrack(t,e))}performUpdateTextTrack(t,i){for(let e=0;e<t.length;e++){var r=t[e];r===i&&"showing"!==t[e].mode?t[e].mode="showing":r!==i&&"hidden"!==t[e].mode&&(t[e].mode="hidden")}}get availableMediaOptions(){var e;return this.interstitialIsPlaying?null!==(e=this._availableInterstitialMediaOptions)&&void 0!==e?e:[]:null!==(e=this._availableMediaOptions)&&void 0!==e?e:[]}_onTextTracksChanged(){var r,n;if(this.mediaSink&&this.nativeSubtitleTrackChange$){let t=!1,i=NaN;const a=Mu(this.mediaSink.textTracks);for(let e=0;e<a.length;e++)a[e].seen?"showing"===a[e].mode&&(i=null!==(r=this.selectedTrack)&&void 0!==r&&r.isInterstitial?null!==(n=this.selectedTrack.persistentID)&&void 0!==n?n:NaN:null!==(n=a[e].persistentId)&&void 0!==n?n:NaN):(a[e].seen=!0,t=!0);if(!t){const r=this.selectedTrack;if((null==r?void 0:r.persistentID)!==i){const r=this.availableMediaOptions.find(function(e){return e.persistentID===i}),e=null!=r?r:this._disabledMediaOption;e&&this.nativeSubtitleTrackChange$.next(e)}}}}addCues(e,t,i,r){const n=this.cueRanges;let a=!1;for(let e=n.length;e--;){const r=n[e],d=(s=r[0],o=r[1],l=t,Math.min(o,i)-Math.max(s,l));if(0<=d&&(r[0]=Math.min(r[0],t),r[1]=Math.max(r[1],i),a=!0,.5<d/(i-t)))return}var s,o,l;let d;a||n.push([t,i]),this.addCueToInterstitial&&(d=this.channelToTrackMap["i"+e]),d=d||this.channelToTrackMap[e],this.Cues.newCue(d,t,i,r,this.mediaSink.offsetWidth,this.mediaSink.offsetHeight)}getExistingHTMLTextTrackWithChannelNumber(t){var i=this.mediaSink;if(i)for(let e=0;e<i.textTracks.length;e++){var r=i.textTracks[e],n="cc"+t;if(ku(n)&&!0===r[n])return r}return null}sendAddTrackEvent(e,t){let i=null;try{i=new window.Event("addtrack")}catch(e){i=document.createEvent("Event"),i.initEvent("addtrack",!1,!1)}i.track=e,t.dispatchEvent(i)}createHTMLCaptionsTrackGuts(e,t,i,r){var n="cc"+e;if(!this.channelToTrackMap[n]){e=this.getExistingHTMLTextTrackWithChannelNumber(e);if(e)this.channelToTrackMap[n]=e,Pu(this.channelToTrackMap[n]),this.sendAddTrackEvent(this.channelToTrackMap[n],this.mediaSink);else{const a=this.createHTMLTextTrackGuts("captions",t,i,r);a&&ku(n)&&(a[n]=!0,this.channelToTrackMap[n]=a)}}return this.channelToTrackMap[n]}createHTMLCaptionsTrack(e){return this.createHTMLCaptionsTrackGuts(e,this.config[1===e?"captionsTextTrack1Label":"captionsTextTrack2Label"],this.config.captionsTextTrack1LanguageCode,!1)}htmlTextTrackBelongToThisItem(e){return Object.values(this.htmlTextTrackMap).includes(e)}getExistingHTMLTextTrack(e){var t;if(e.isInterstitial)return e.mediaType===eo.CLOSEDCAPTION?1===this.trackChannelNumber(e)?this.interstitialCCTrack1:this.interstitialCCTrack2:this.interstitialTextTrack;let i=this.config.condenseSubtitleTrack?this.htmlTextTrackMap[null!==(t=e.persistentID)&&void 0!==t?t:NaN]:this.htmlTextTrackMap[e.id];return i||this.getExistingHTMLTextTrackFromPreviousItem(e)||(this.config.dynamicTextTrackCreation&&(i=this.createHTMLTextTrack(e)),i)}getExistingHTMLTextTrackFromPreviousItem(t){var i,r=t.mediaType===eo.SUBTITLE?"subtitles":"captions",n=this.mediaSink.textTracks;let a=-1;for(let e=0;e<n.length;++e){var s=n[e];if((null!==(i=s.originalKind)&&void 0!==i?i:s.kind)===r&&s.forced===t.forced&&s.language===t.lang&&!this.htmlTextTrackBelongToThisItem(s)){a=e;break}}return n[a]}getExistingHTMLTextTrackWithSubtitleTrackId(t){var e=this.availableMediaOptions.find(e=>e.id===t);return e?this.getExistingHTMLTextTrack(e):void 0}getExistingHTMLTextTrackIndex(e){var t=this.getExistingHTMLTextTrack(e),i=this.mediaSink.textTracks;let r=-1;for(let e=0;e<i.length;++e)if(i[e]===t){r=e;break}return r}setExistingHTMLTextTrack(e,t){if(z(e.persistentID))return t.persistentId=e.persistentID,this.config.condenseSubtitleTrack?this.htmlTextTrackMap[e.persistentID]=t:this.htmlTextTrackMap[e.id]=t}createHTMLTextTrack(t,i=void 0){var e;if(i)this.tracksReused+=1;else{if("sbtl"===t.mediaType)this.subtitleTracksCreated+=1,i=this.createHTMLTextTrackGuts("subtitles",t.name,t.lang,null!==(e=t.forced)&&void 0!==e&&e);else{let e=1;t.inStreamID&&(e=Number(t.inStreamID.substring(2))),this.captionTracksCreated+=1,i=this.createHTMLCaptionsTrackGuts(e,t.name,t.lang,!1)}i?this.setExistingHTMLTextTrack(t,i):(this.logger.error(`failed to create HTML text track for track ${t.id}: persistent id ${t.persistentID} name ${t.name} lang ${t.lang} inStreamID ${t.inStreamID}`),this.tracksFailed+=1)}return i}createHTMLTextTrackGuts(t,i,r,n){const a=this.mediaSink;if(a){let e=!1;"metadata"!==t&&this.config.customTextTrackCueRenderer&&(e=!0,t="metadata");const s=a.addTextTrack(t,i,r);return e&&(s.customTextTrackCueRenderer=!0,s.originalKind=t),s.forced=n,s}}trackChannelNumber(e){let t=1;return e.inStreamID&&(t=Number(e.inStreamID.substring(2))),t}removeEarlierId3Cues(e){const t=this.mediaSink.id3TextTrack;if(t&&t.cues&&0<t.cues.length)for(;0<t.cues.length;){var i=t.cues[0];if(!(i.startTime<e))break;t.removeCue(i)}}removeEarlierCues(e,t=50){return this.removeCues(e,!0,t)}removeLaterCues(e,t=-1){return this.removeCues(e,!1,t)}removeCues(t,i=!0,r=50){if(this.mediaSink){var n=this.mediaSink.textTracks;for(let e=0;n&&e<n.length;e++){const a=n[e];if(a&&a.cues&&0<a.cues.length){let e=0;for(;0<a.cues.length&&(e<r||r<0);){const r=i?a.cues[0]:a.cues[a.cues.length-1];if(!(i?r.endTime<t:r.startTime>=t))break;a.removeCue(r),e++}}}i?(this.removeEarlierCCCueRanges(t),this.mediaSink.removeEarlierParsedSubtitleFragmentRecord(t)):(this.removeLaterCCCueRanges(t),this.mediaSink.removeLaterParsedSubtitleFragmentRecord(t))}}removeEarlierCCCueRanges(t){const i=this.cueRanges;let r=0;for(let e=0;e<i.length&&!(i[e][0]>t);e++)i[e][1]<t?r++:i[e][0]<t&&i[e][1]>=t&&(i[e][0]=t);0<r&&i.splice(0,r)}removeLaterCCCueRanges(t){const i=this.cueRanges;let r=0;for(let e=i.length-1;0<=e&&!(i[e][1]<=t);e--)i[e][0]>=t?r++:i[e][0]<t&&i[e][1]>=t&&(i[e][0]=t);0<r&&i.splice(-r,r)}_removeHtmlTextTrackMappings(){Object.entries(this.htmlTextTrackMap).forEach(([e,t])=>{z(e)&&t&&(this.htmlTextTrackMap[e]=void 0)})}resetTracks(){var e;this._clearAllTracks(),this.cueRanges=[],null===(e=this.mediaSink)||void 0===e||e.clearAllParsedSubtitleFragmentRecord(),this._removeHtmlTextTrackMappings(),this.persistentIdToParsedRecordMap={}}_clearAllTracks(){var e=this.mediaSink;if(e){var t=e.textTracks;for(let e=0;t&&e<t.length;e++)Pu(t[e])}}_isInterstitialTextTrack(e){return e===this.interstitialTextTrack||e===this.interstitialCCTrack1||e===this.interstitialCCTrack1}endLoadingInterstitials(){this._availableInterstitialMediaOptions=[],this._interstitialDisableMediaOption=void 0,this._interstitialSelectedMediaOption=void 0,this.interstitialIsLoading=!1}getCuesOfEnabledTrack(e,t=!1){if(!e)return[];let i=[];if(t){const t=this._getCuesOfEnabledTrack(e);for(let e=0;e<t.length;e++){var r=t[e];Boolean(r.webVTTCue)&&i.push(r)}}else i=this._getCuesOfEnabledTrack(e);return i}_getCuesOfEnabledTrack(e){var t=this.getTrack(e);let i;if(null!=t&&t.isInterstitial)i=t.mediaType===eo.SUBTITLE?"interstitial":1===this.trackChannelNumber(t)?"interstitialCC1":"interstitialCC2";else{const r=this.config.condenseSubtitleTrack?null==t?void 0:t.persistentID:null==t?void 0:t.id;i=null!=r?r:NaN}e=this.htmlTextTrackMap[i];return null!=t&&t.isInterstitial&&this.interstitialIsPlaying&&e&&this.updateInterstitialTextTrackIfNecessary(t,e),e&&e.cues?Array.from(e.cues):[]}updateInterstitialTextTrackIfNecessary(e,t){e.persistentID!==t.persistentId&&(t.persistentId=e.persistentID,Pu(t),this.mediaSink.clearParsedSubtitleRecordsForMediaOption("interstitial"))}clearInterstitialTextTracks(){Pu(this.interstitialTextTrack),Pu(this.interstitialCCTrack1),Pu(this.interstitialCCTrack2),this.mediaSink.clearParsedSubtitleRecordsForMediaOption("interstitial")}forgetHTMLTextTrackPersistentIDs(){for(let e=0;e<this.mediaSink.textTracks.length;++e)this.mediaSink.textTracks[e].persistentId=void 0}attachSubtitleTracks(){this.gotTracks&&(this.subtitleTracksCreated=0,this.captionTracksCreated=0,this.tracksReused=0,this.tracksFailed=0,this.forgetHTMLTextTrackPersistentIDs(),this.tracks.forEach(e=>{var t;"sbtl"===e.mediaType&&this.config.dynamicTextTrackCreation||(t=this.getExistingHTMLTextTrack(e),this.createHTMLTextTrack(e,t))}))}setTracks(e,t,i){this.htmlTextTrackMap={},this.cueRanges=[],this.config.enableWebVTT&&(this.tracks=e||[]),this.gotTracks=!0,this._availableMediaOptions=e,this._disabledMediaOption=i,this.attachSubtitleTracks(),this.selectedTrack=t,this.nativeSubtitleTrackChange$=new Er,this.mediaSink.textTracksCreated=!0}setInterstitialTracks(e,t,i){this.htmlTextTrackMap||(this.htmlTextTrackMap={}),this.interstitialIsLoading=!0;let r=!1,n=!1,a=!1;e.forEach(e=>{e.mediaType===eo.SUBTITLE?r=!0:1===this.trackChannelNumber(e)?n=!0:a=!0}),!this.interstitialTextTrack&&r&&(this.interstitialTextTrack=this.createHTMLTextTrackGuts("subtitles","interstitialTextTrack","interstitialMulti",!1),this.htmlTextTrackMap.interstitial=this.interstitialTextTrack),!this.interstitialCCTrack1&&n&&(this.interstitialCCTrack1=this.createHTMLTextTrackGuts("captions","interstitialCCTrack1","interstitialMulti",!1),this.interstitialCCTrack1&&(this.htmlTextTrackMap.interstitialCC1=this.interstitialCCTrack1,this.channelToTrackMap.icc1=this.interstitialCCTrack1)),!this.interstitialCCTrack2&&a&&(this.interstitialCCTrack2=this.createHTMLTextTrackGuts("captions","interstitialCCTrack2","interstitialMulti",!1),this.interstitialCCTrack2&&(this.htmlTextTrackMap.interstitialCC2=this.interstitialCCTrack2,this.channelToTrackMap.icc2=this.interstitialCCTrack2)),this._availableInterstitialMediaOptions=e,this._interstitialDisableMediaOption=i,(this.selectedTrack=t)&&(t.mediaType===eo.SUBTITLE?this.interstitialTextTrack&&(this.interstitialTextTrack.persistentId=t.persistentID):1===this.trackChannelNumber(t)?this.interstitialCCTrack1&&(this.interstitialCCTrack1.persistentId=t.persistentID):this.interstitialCCTrack2&&(this.interstitialCCTrack2.persistentId=t.persistentID)),this.nativeSubtitleTrackChange$=new Er}onInlineStylesParsed(e){}processSubtitleFrag(e,t,i,r,n=!0){var a=new Uint8Array(r),e=this.getExistingHTMLTextTrackIndex(e);return t&&r.byteLength?n?this._parseVTTs(e,t,i,a).pipe(sr(e=>(e&&z(e.startTime)&&(this.lastCueEndTime=Math.max(this.lastCueEndTime,e.endTime)),e))):this._parseTTML(e,t,i,a,this.logger).pipe(sr(e=>(e&&z(e.startTime)&&(this.lastCueEndTime=Math.max(this.lastCueEndTime,e.endTime)),e))):Pr(void 0)}processCues(e,n,t,a){const s=this.mediaSink.textTracks[e],i={count:0,startTime:Number.POSITIVE_INFINITY,endTime:0},o=new qr(0);o.pipe(tr(Li),fr((e,t)=>{var i=performance.now();let r=t;for(;r<a.length&&(r-t<100||performance.now()-i<200);++r){const t=a[r];!s||s.cues&&s.cues.getCueById(t.id)||(t.fragSN=n.mediaSeqNum,t.webVTTCue=!0,t.itemId=n.itemId,s.addCue(t),e.count++),e.startTime=Math.min(t.startTime,e.startTime),e.endTime=Math.max(t.endTime,e.endTime)}return r<a.length?o.next(r):o.complete(),e},i),cn(()=>{let e="interstitial";this.selectedTrack&&!this.selectedTrack.isInterstitial&&(e=this.selectedTrack.itemId+this.selectedTrack.mediaOptionId),this.mediaSink.archiveParsedSubtitleFragmentRecord(e,n.mediaSeqNum,i)}),Br(()=>{t.complete()})).subscribe(t)}_parseVTTs(i,r,e,n){return new oi(t=>{!function(e,t,i,r,n,a){const s=Y.utf8arrayToStr(new Uint8Array(e)).trim().replace(/\r\n|\n\r|\n|\r/g,"\n").split("\n"),o=m(t,eu);let l=0,d=0;const u=[];let c=null,h=!0;const p=new Ud.WebVTTParser(window,Ud.WebVTTParser.StringDecoder(),a);p.oncue=function(e){var t=E({baseTime:ru(ru(l)-o.baseTime,i*eu),timescale:eu});e.startTime=ru(e.startTime+t-d,0,95443.7176888889),e.endTime=ru(e.endTime+t-d,0,95443.7176888889),e.id=g(iu(e.startTime).toString())+g(iu(e.endTime-e.startTime).toString())+g(e.text),e.text=decodeURIComponent(encodeURIComponent(e.text)),0<e.endTime&&u.push(e)},p.onparsingerror=function(e){c=e},p.onflush=function(){c&&n?c:r(u)},s.forEach(s=>h&&tu(s,"X-TIMESTAMP-MAP=")?(h=!1,void s.substr(16).split(",").forEach(e=>{if(tu(e,"LOCAL:")){let t;try{t=(i=e.substr(6),r=parseInt(i.substr(-3)),n=parseInt(i.substr(-6,2)),a=parseInt(i.substr(-9,2)),i=9<i.length?parseInt(i.substr(0,i.indexOf(":"))):0,z(r)&&z(n)&&z(a)&&z(i)?(r+=1e3*n,r+=6e4*a,r+=36e5*i):-1)}catch(e){t=-1}-1!==t?d=t/1e3:c=new Error(`Malformed X-TIMESTAMP-MAP: ${s}`)}else tu(e,"MPEGTS:")&&(l=parseInt(e.substr(7)));var i,r,n,a})):void("<br/>"!==s&&"<br>"!==s&&(s=(s=s.replace(/<br\/>/g,"")).replace(/<br>/g,""),p.parse(s+"\n")))),p.flush()}(n,e,r.start,(r.discoSeqNum,e=>{this.processCues(i,r,t,e)}),e=>{},e=>{this.hls.trigger(N.INLINE_STYLES_PARSED,{styles:e})},this.logger)})}_parseTTML(t,i,e,r,n){const a=Ru.extractXML(r),s=Ru.generateCues(a,e,i.start,n);return new oi(e=>{this.processCues(t,i,e,s)})}_ensureParser(){var e,t;this.cea608Parser||(e=new Eu(this,1),t=new Eu(this,2),this.cea608Parser=new class{constructor(e=1,t,i){this.field=e,this.currChNr=-1,this.lastCmdA=null,this.lastCmdB=null,this.channels=[new Su(1,t),new Su(2,i)],this.dataCounters={padding:0,char:0,cmd:0,other:0}}getHandler(e){return this.channels[e].getHandler()}setHandler(e,t){this.channels[e].setHandler(t)}addData(e,t){let i,r,n,a=null;mu.setTime(e);for(let e=0;e<t.length;e+=2)r=127&t[e],n=127&t[e+1],16<=r&&r<=31&&r===this.lastCmdA&&n===this.lastCmdB?(this.lastCmdA=null,this.lastCmdB=null,mu.log("DEBUG","Repeated command ("+au([r,n])+") is dropped")):0!=r||0!=n?(mu.log("DATA","["+au([t[e],t[e+1]])+"] -> ("+au([r,n])+")"),i=this.parseCmd(r,n),i=i||this.parseMidrow(r,n),i=i||this.parsePAC(r,n),i=i||this.parseBackgroundAttributes(r,n),!i&&(a=this.parseChars(r,n),a)&&(this.currChNr&&0<=this.currChNr?this.channels[this.currChNr-1].insertChars(a):mu.log("WARNING","No channel found yet. TEXT-MODE?")),i?this.dataCounters.cmd+=2:a?this.dataCounters.char+=2:(this.dataCounters.other+=2,mu.log("WARNING","Couldn't parse cleaned data "+au([r,n])+" orig: "+au([t[e],t[e+1]])))):this.dataCounters.padding+=2}parseCmd(e,t){var i;if(!((20===e||21===e||28===e||29===e)&&32<=t&&t<=47||(23===e||31===e)&&33<=t&&t<=35))return!1;const r=this.channels[(i=20===e||23===e?1:2)-1];return 20===e||21===e||28===e||29===e?32===t?r.ccRCL():33===t?r.ccBS():34===t?r.ccAOF():35===t?r.ccAON():36===t?r.ccDER():37===t?r.ccRU(2):38===t?r.ccRU(3):39===t?r.ccRU(4):40===t?r.ccFON():41===t?r.ccRDC():42===t?r.ccTR():43===t?r.ccRTD():44===t?r.ccEDM():45===t?r.ccCR():46===t?r.ccENM():47===t&&r.ccEOC():r.ccTO(t-32),this.lastCmdA=e,this.lastCmdB=t,this.currChNr=i,!0}parseMidrow(e,t){var i;if((17===e||25===e)&&32<=t&&t<=47){if((i=17===e?1:2)!==this.currChNr)return mu.log("ERROR","Mismatch channel in midrow parsing"),!1;const r=this.channels[i-1];return r.insertChars([32]),r.ccMIDROW(t),mu.log("DEBUG","MIDROW ("+au([e,t])+")"),this.lastCmdA=e,this.lastCmdB=t,!0}return!1}parsePAC(e,t){if(!((17<=e&&e<=23||25<=e&&e<=31)&&64<=t&&t<=127||(16===e||24===e)&&64<=t&&t<=95))return!1;var i=e<=23?1:2,r=(64<=t&&t<=95?1==i?du:cu:1==i?uu:hu)[e],r=this.interpretPAC(r,t);return this.channels[i-1].setPAC(r),this.lastCmdA=e,this.lastCmdB=t,this.currChNr=i,!0}interpretPAC(e,t){var i;const r={color:void 0,italics:!1,indent:null,underline:!1,row:e};return i=95<t?t-96:t-64,r.underline=1==(1&i),i<=13?r.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(i/2)]:i<=15?(r.italics=!0,r.color="white"):r.indent=4*Math.floor((i-16)/2),r}parseChars(e,t){let i=null,r=null,n=null;var a;if(n=25<=e?(i=2,e-8):(i=1,e),17<=n&&n<=19?(a=t,a=17===n?t+80:18===n?t+112:t+144,mu.log("INFO","Special char '"+nu(a)+"' in channel "+i),r=[a],this.lastCmdA=e,this.lastCmdB=t):32<=e&&e<=127&&(r=0===t?[e]:[e,t],this.lastCmdA=null,this.lastCmdB=null),r){const e=au(r);mu.log("DEBUG",`Char codes =  ${e.join(",")}`)}return r}parseBackgroundAttributes(e,t){let i,r,n;return((16===e||24===e)&&32<=t&&t<=47||(23===e||31===e)&&45<=t&&t<=47)&&(i={underline:!1},16===e||24===e?(r=Math.floor((t-32)/2),i.background=pu[r],t%2==1&&(i.background=i.background+"_semi")):45===t?i.background="transparent":(i.foreground="black",47===t&&(i.underline=!0)),n=this.channels[(e<24?1:2)-1],n.setBkgData(i),this.lastCmdA=null,this.lastCmdB=null,!0)}reset(){for(let e=0;e<this.channels.length;e++)this.channels[e]&&this.channels[e].reset();this.lastCmdA=null,this.lastCmdB=null}cueSplitAtTime(t){for(let e=0;e<this.channels.length;e++)this.channels[e]&&this.channels[e].cueSplitAtTime(t)}}(0,e,t))}setupForFrag(e){var t;e&&e.mediaOptionType===Ys.Variant&&!e.iframe&&(t=e.mediaSeqNum,e=e.discoSeqNum,t===this.lastVariantSeqNum+1&&e===this.lastDiscoSeqNum||this.resetClosedCaptionParser(),this.lastVariantSeqNum=t,this.lastDiscoSeqNum=e)}resetClosedCaptionParser(){var e;null===(e=this.cea608Parser)||void 0===e||e.reset()}addLegibleSamples(e,t,i,r,n,a){this.addCueToInterstitial=!!a,t&&this.addClosedCaptionSamples(e,t),i&&0<i.length&&this.addId3Samples(e,i,r,E(n))}addClosedCaptionSamples(e,t){t.mp4?this.addMP4CaptionSamples(e,t.mp4):t.ts&&this.addTSCaptionSamples(e,t.ts)}addMP4CaptionSamples(e,i){var r;if(this.enableCaption&&this.config.enableCEA708Captions){var n=E(e);this._ensureParser();for(let e=0;e<i.length;e++){let t=i[e].pts-n;var a=i[e].bytes;for(let e=0;e<a.length;e+=2){const i=[];i.push(a[e]),e+1<a.length?i.push(a[e+1]):i.push(80),null===(r=this.cea608Parser)||void 0===r||r.addData(t,i),t+=.03336666666666667}}}}addTSCaptionSamples(e,t){var i;if(this.enableCaption&&this.config.enableCEA708Captions){var r=E(e);this._ensureParser();for(let e=0;e<t.length;e++){var n=t[e].pts-r,a=function(t){var i=31&t[0];let r,n,a,s=2;const o=[];for(let e=0;e<i;e++)r=t[s++],n=127&t[s++],a=127&t[s++],0==n&&0==a||0!=(4&r)&&0==(3&r)&&(o.push(n),o.push(a));return o}(t[e].bytes);null===(i=this.cea608Parser)||void 0===i||i.addData(n,a)}}}addId3Samples(e,t,r,n){var a;if(this.config.enableID3Cues){const s=window.WebKitDataCue||window.VTTCue||window.TextTrackCue,o=E(e);for(let e=0;e<t.length;e++){const l=this._adjustID3PtsForRollover(t[e].pts,r)-o;let i=this._adjustID3PtsForRollover(e<t.length-1?t[e+1].pts:n,r)-o;l===i&&(i+=1e-4),t[e].frames&&(null===(a=t[e].frames)||void 0===a||a.forEach(e=>{if(e&&!this.id3shouldIgnore(e)){const t=new s(l,i,"");t.value=e,this.id3Track.addCue(t)}}))}}}_adjustID3PtsForRollover(e,t){return ru(e*t.timescale,t.baseTime,Math.pow(2,33))/t.timescale}id3shouldIgnore(e){return"PRIV"===e.key&&("com.apple.streaming.transportStreamTimestamp"===e.info||"com.apple.streaming.audioDescription"===e.info)}}class xu{constructor(e){this.logger=e,this.requestMap={},this.gotRequest$=new Er}load(d,u){return new oi(e=>{const{url:t,extendMaxTTFB:i}=d,r=u["maxTimeToFirstByteMs"],n={trequest:performance.now(),tfirst:NaN,tload:NaN,loaded:0,total:NaN,complete:!1},a=this.requestMap[t]=new Hr,s=z(i)&&0<i?i:r,o=a.pipe(fn(s),on(e=>(n.tfirst=performance.now(),this.handleExternalResponse(e,d,u,n))),Wi(e=>{if(e instanceof mn)throw new Ho(e.message,n);throw e}),Br(()=>{delete this.requestMap[t]}));d.onProgress&&d.onProgress.cb(t,0,n,null);const l=o.subscribe(e);return this.gotRequest$.next({uri:t,responseType:d.responseType,userAgent:navigator.userAgent,forInterstitialAssetList:!!d.forInterstitialAssetList,interstitialIdentifier:d.interstitialIdentifier}),()=>{l.unsubscribe(),delete this.requestMap[t]}})}setCustomUrlResponse(e,t){const i=this.requestMap[e];i&&(i.next(t),i.complete(),delete this.requestMap[e])}handleExternalResponse(e,t,i,r){r.tload=performance.now();var n=e.response.status;return 200<=n&&n<300||0===n&&e.response.data?("arraybuffer"===t.responseType&&e.response.data instanceof ArrayBuffer?r.loaded=e.response.data.byteLength:r.loaded=e.response.data.toString().length,r.total=r.loaded,r.complete=!0,nr(Pr({status:n,data:e,stats:r}),Cn)):300===n||302===n||303===n||305===n?this.redirectRequest(e.response.uri,t,i,r):Lr(new Uo("Unable to load custom url",n))}redirectRequest(e,t,i,n){var r=t["extendMaxTTFB"],{maxLoadTimeMs:a,maxTimeToFirstByteMs:s}=i,a=z(a)?a-(performance.now()-n.trequest):void 0,s=z(r)&&0<r?r:s-(performance.now()-n.trequest),i=Object.assign(Object.assign({},i),{maxLoadTimeMs:a,maxTimeToFirstByteMs:s}),t=Object.assign(Object.assign({},t),{url:e});if(z(a)&&a<=0||s<=0)throw new Ho("",n);return ao(e)?this.load(t,i):ll(t,i).pipe(sr(([e,t])=>{var{responseURL:i,status:r}=e,i=i||"",i={uri:i,response:{status:r,uri:i,data:e.response}};return n.loaded=n.total=t.loaded,n.tload=performance.now(),n.complete=!0,{status:e.status,data:i,stats:n}}))}}class Du{constructor(e,t,i){this.xhrLoader=e,this.customUrlLoader=t,this.sessionDataCheckForCompleteness=(e,t)=>{const i=t["sessionDataAutoLoad"],r=Object.assign({},e);return e.complete||e.itemList&&(r.complete=e.itemList.every(e=>!(i[e["DATA-ID"]]&&!e.VALUE&&!e._STATUS&&e.URI))),r},this.logger=i.child({name:"SessionDataLoader"})}loadSessionData(n,a){const s=a["sessionDataAutoLoad"],t=n.itemList||[];let o=Pr(n);return t.forEach(e=>{const i=e["DATA-ID"],r=e.URI;if(r&&s[i]){if("_hls.localized-rendition-names"===i&&function(e){const t=e.split(":");if("data"===t[0]&&2===t.length){const e=t[1].split(";"),i=e[e.length-1].split(",");return 2===i.length?"base64"===i[0]:void 0}}(r)){const n=jl(r);let t="";return null!=n&&(t=Y.utf8arrayToStr(n)),void(o=o.pipe(on(e=>Pr(this.setSessionData(e,i,"VALUE",t)))))}const s=no.buildAbsoluteURL(n.baseUrl,r,{alwaysNormalize:!0}),e="";o=o.pipe(on(t=>this.loadSessionDataItemWithUrl(s,i,e,a,t,this.xhrLoader,this.customUrlLoader).pipe(Wi(e=>(this.logger.error(`Error loading SessionData > url=${f(s)}, id=${i}, err=${e}`),Pr(t))))))}}),o.pipe(sr(e=>{if(t.length<1)return e;e=this.sessionDataCheckForCompleteness(e,a);if(e.complete)return e;throw new B(!1,"Session data not complete after loading all items",G.IncompleteSessionData)}),Br(()=>{}))}loadSessionDataItemWithUrl(r,n,e,t,a,i,s){const o={url:r,method:"GET",responseType:e,xhrSetup:t.xhrSetup,mimeType:"application/xml"},l=Go({url:r},t.fragLoadPolicy);let d;if(ao(r))d=s(o,l).pipe(sr(e=>this.onLoadSuccess(a,n,e.data.response.data.toString(),e.data.response.data)));else{const r=performance.now();d=i(o,l).pipe(sr(([e])=>this.onLoadSuccess(a,n,e.response,e.responseXML)),Wi(e=>{if(e instanceof Uo&&e.isAuthOrCorsError)return t=o,i=l,s(t,el(t,i,r)).pipe(sr(e=>this.onLoadSuccess(a,n,e.data.response.data.toString(),e.data.response.data)));var t,i;throw e}))}return d.pipe(Wi(e=>(e instanceof mn?e=new Ko(!1,e.message,G.SessionDataLoadTimeout):e instanceof Uo&&(e=new Ko(!1,e.message,{code:e.statusCode,text:"Failed to load SessionData"})),this.logger.error(`Unable to load SessionData > err=${e}`),Pr(this.onLoadError(a,n,e)))))}onLoadSuccess(e,t,i,r){let n=null,a=e;if(function(e){const t=/[\s]*<\?xml/i;t.lastIndex=0;var i=t.exec(e);return i||/[\s]*<plist/i.exec(e)}(i)&&(n=r)){const i=function n(e){if(!e)return null;let a=null;var s=e.childNodes;if(s)if(e.tagName){const t=null===(e=e.tagName)||void 0===e?void 0:e.toLowerCase();if("plist"===t){a=[];for(let e=0;e<s.length;++e){const t=s[e];t.tagName&&a.push(n(t))}1===a.length&&(a=a[0])}if("array"===t){a=[];for(let e=0;e<s.length;++e){const t=s[e];t.tagName&&a.push(n(t))}}if("dict"===t){let t,i,r=0;a={};for(let e=0;e<s.length;e++){var o=s[e],l=null===(l=o.tagName)||void 0===l?void 0:l.toLowerCase();l&&(r%2==0?"key"===l&&(t=n(o),r++):(i=n(o),a[t]=i,t=null,i=null,r++))}t&&(a[t]=i,t=null,i=null)}else if("key"===t){const i=s[0];a=i?i.nodeValue:null}else if("string"===t){const i=s[0];a=i?i.nodeValue:null}else if("integer"===t){const i=s[0];a=i&&i.nodeValue?parseInt(i.nodeValue):0}else if("float"===t){const i=s[0];a=i&&i.nodeValue?parseFloat(i.nodeValue):0}else if("date"===t){const i=s[0];a=i&&i.nodeValue?new Date(i.nodeValue):null}else if("data"===t){const i=s[0];a=i&&i.nodeValue?atob(i.nodeValue):null}else"true"===t?a=!0:"false"===t&&(a=!1)}else if(!(s.length<1)){a=[];for(let e=0;e<s.length;++e){const t=s[e];t.tagName&&a.push(n(t))}1===a.length&&(a=a[0])}return a}(n);a=this.setSessionData(e,t,"VALUE",i)}else if(function(e){const t=/[\s]*[\{\[]/;return t.lastIndex=0,t.exec(e)}(i))try{const r=JSON.parse(i);a=this.setSessionData(e,t,"VALUE",r)}catch(r){this.logger.error(`JSON parser error: ${r}`),a=this.setSessionData(e,t,"VALUE",i),a=this.setSessionData(a,t,"_STATUS",-1)}else a=this.setSessionData(e,t,"VALUE",i);return a}setSessionData(t,i,r,n){let a=t;if(t.itemList){let e;const s=[...t.itemList];for(e=0;e<t.itemList.length;++e){const t=Object.assign({},s[e]);if(t["DATA-ID"]===i){t[r]=n,s[e]=t;break}}e===t.itemList.length&&this.logger.error(`Can't set ${r} of session data ${i}`),a=Object.assign(Object.assign({},t),{itemList:s})}else this.logger.error(`Can't set ${r} on uninitialized session data`);return a}onLoadError(e,t,i){return this.setSessionData(e,t,"_STATUS",null===(i=i.response)||void 0===i?void 0:i.code)}}const _u=new Set(["buildType","customTextTrackCueRenderer","debug","debugLevel","disableVideoCodecList","disableAudioCodecList","enablePerformanceLogging","enableQueryParamsForITunes","enableRtcReporting","nativeControlsEnabled","offlinePlayback","playReadyMessageFormat","rtcIntervalTimeout","sessionDataAutoLoad","storage","storageKeyPrefix","supportedStorebagVersion","useCustomMediaFunctions","useHighestVideoCodecPrivate","xhrSetup"]);function Nu(e,t){var i=e.split(".").map(e=>Number.parseInt(e)),r=t.split(".").map(e=>Number.parseInt(e));for(let e=0;e<Math.min(i.length,r.length);e++){if(i[e]<r[e])return!1;if(i[e]>r[e])return!0}return!0}function Fu(t){var i=Math.random();let r=0;for(let e=0;e<t.length;e++)if(r+=t[e],i<r)return e;return t.length-1}function Bu(e){try{return JSON.stringify(e)}catch(e){return'"[Circular]"'}}var Uu,Vu,$u,Qu,Ku=function(e,t,i){var r=i&&i.stringify||Bu;if("object"==typeof e&&null!==e){var n=t.length+1;if(1===n)return e;var a=new Array(n);a[0]=r(e);for(var s=1;s<n;s++)a[s]=r(t[s]);return a.join(" ")}if("string"!=typeof e)return e;var o=t.length;if(0===o)return e;for(var l="",d=0,u=-1,c=e&&e.length||0,h=0;h<c;){if(37===e.charCodeAt(h)&&h+1<c){switch(u=-1<u?u:0,e.charCodeAt(h+1)){case 100:if(o<=d)break;if(u<h&&(l+=e.slice(u,h)),null==t[d])break;l+=Number(t[d]),u=h+=2;break;case 79:case 111:case 106:if(o<=d)break;if(u<h&&(l+=e.slice(u,h)),void 0===t[d])break;var p=typeof t[d];if("string"==p){l+="'"+t[d]+"'",u=h+2,h++;break}if("function"==p){l+=t[d].name||"<anonymous>",u=h+2,h++;break}l+=r(t[d]),u=h+2,h++;break;case 115:if(o<=d)break;u<h&&(l+=e.slice(u,h)),l+=String(t[d]),u=h+2,h++;break;case 37:u<h&&(l+=e.slice(u,h)),l+="%",u=h+2,h++}++d}++h}return-1===u?e:(u<c&&(l+=e.slice(u)),l)},qu=ju,Hu=function(){function t(e){return void 0!==e&&e}try{return"undefined"!=typeof globalThis||Object.defineProperty(Object.prototype,"globalThis",{get:function(){return delete Object.prototype.globalThis,this.globalThis=this},configurable:!0}),globalThis}catch(e){return t(dv)||t(window)||t(this)||{}}}().console||{},Ea={mapHttpRequest:Xu,mapHttpResponse:Xu,wrapRequestSerializer:Ju,wrapResponseSerializer:Ju,wrapErrorSerializer:Ju,req:Xu,res:Xu,err:function(e){var t,i={type:e.constructor.name,msg:e.message,stack:e.stack};for(t in e)void 0===i[t]&&(i[t]=e[t]);return i}};function ju(a){(a=a||{}).browser=a.browser||{};var s=a.browser.transmit;if(s&&"function"!=typeof s.send)throw Error("pino: transmit option must have a send function");var e=a.browser.write||Hu;a.browser.write&&(a.browser.asObject=!0);var t,o=a.serializers||{},l=(t=a.browser.serialize,i=o,Array.isArray(t)?t.filter(function(e){return"!stdSerializers.err"!==e}):!0===t&&Object.keys(i)),t=a.browser.serialize;Array.isArray(a.browser.serialize)&&-1<a.browser.serialize.indexOf("!stdSerializers.err")&&(t=!1),"function"==typeof e&&(e.error=e.fatal=e.warn=e.info=e.debug=e.trace=e),!1===a.enabled&&(a.level="silent");var i=a.level||"info",r=Object.create(e);r.log||(r.log=Zu),Object.defineProperty(r,"levelVal",{get:function(){return"silent"===this.level?1/0:this.levels.values[this.level]}}),Object.defineProperty(r,"level",{get:function(){return this._level},set:function(e){if("silent"!==e&&!this.levels.values[e])throw Error("unknown level "+e);this._level=e,Gu(n,r,"error","log"),Gu(n,r,"fatal","error"),Gu(n,r,"warn","error"),Gu(n,r,"info","log"),Gu(n,r,"debug","log"),Gu(n,r,"trace","log")}});var n={transmit:s,serialize:l,asObject:a.browser.asObject,levels:["error","fatal","warn","info","debug","trace"],timestamp:"function"==typeof(e=a).timestamp?e.timestamp:!1===e.timestamp?ec:tc};return r.levels=ju.levels,r.level=i,r.setMaxListeners=r.getMaxListeners=r.emit=r.addListener=r.on=r.prependListener=r.once=r.prependOnceListener=r.removeListener=r.removeAllListeners=r.listeners=r.listenerCount=r.eventNames=r.write=r.flush=Zu,r.serializers=o,r._serialize=l,r._stdErrSerialize=t,r.child=function(t){if(!t)throw new Error("missing bindings for child Pino");var i,r,e=t.serializers;function n(e){this._childLevel=1+(0|e._childLevel),this.error=Wu(e,t,"error"),this.fatal=Wu(e,t,"fatal"),this.warn=Wu(e,t,"warn"),this.info=Wu(e,t,"info"),this.debug=Wu(e,t,"debug"),this.trace=Wu(e,t,"trace"),i&&(this.serializers=i,this._serialize=r),s&&(this._logEvent=Yu([].concat(e._logEvent.bindings,t)))}return l&&e&&(i=Object.assign({},o,e),r=!0===a.browser.serialize?Object.keys(i):l,delete t.serializers,zu([t],r,i,this._stdErrSerialize)),n.prototype=this,new n(this)},s&&(r._logEvent=Yu()),r}function Gu(e,t,i,r){var u,c,h,p,n=Object.getPrototypeOf(t);t[i]=!(t.levelVal>t.levels.values[i])&&(n[i]||Hu[i]||Hu[r])||Zu,c=t,h=i,!(u=e).transmit&&c[h]===Zu||(c[h]=(p=c[h],function(){for(var e,t,i,r,n,a,s=u.timestamp(),o=new Array(arguments.length),l=Object.getPrototypeOf&&Object.getPrototypeOf(this)===Hu?Hu:this,d=0;d<o.length;d++)o[d]=arguments[d];u.serialize&&!u.asObject&&zu(o,this._serialize,this.serializers,this._stdErrSerialize),u.asObject?p.call(l,function(e,t,i,r){e._serialize&&zu(i,e._serialize,e.serializers,e._stdErrSerialize);var n=i.slice(),i=n[0],a={};r&&(a.time=r),a.level=ju.levels.values[t];var s=1+(0|e._childLevel);if(s<1&&(s=1),null!==i&&"object"==typeof i){for(;s--&&"object"==typeof n[0];)Object.assign(a,n.shift());i=n.length?Ku(n.shift(),n):void 0}else"string"==typeof i&&(i=Ku(n.shift(),n));return void 0!==i&&(a.msg=i),a}(this,h,o,s)):p.apply(l,o),u.transmit&&(n=u.transmit.level||c.level,i=ju.levels.values[n],(r=ju.levels.values[h])<i||(e=this,t={ts:s,methodLevel:h,methodValue:r,transmitLevel:n,transmitValue:ju.levels.values[u.transmit.level||c.level],send:u.transmit.send,val:c.levelVal},l=o,i=t.send,s=t.ts,r=t.methodLevel,n=t.methodValue,t=t.val,a=e._logEvent.bindings,zu(l,e._serialize||Object.keys(e.serializers),e.serializers,void 0===e._stdErrSerialize||e._stdErrSerialize),e._logEvent.ts=s,e._logEvent.messages=l.filter(function(e){return-1===a.indexOf(e)}),e._logEvent.level.label=r,e._logEvent.level.value=n,i(r,e._logEvent,t),e._logEvent=Yu(a)))}))}function zu(e,t,i,r){for(var n in e)if(r&&e[n]instanceof Error)e[n]=ju.stdSerializers.err(e[n]);else if("object"==typeof e[n]&&!Array.isArray(e[n]))for(var a in e[n])t&&-1<t.indexOf(a)&&a in i&&(e[n][a]=i[a](e[n][a]))}function Wu(i,r,n){return function(){var e=new Array(1+arguments.length);e[0]=r;for(var t=1;t<e.length;t++)e[t]=arguments[t-1];return i[n].apply(this,e)}}function Yu(e){return{ts:0,messages:[],bindings:e||[],level:{label:"",value:0}}}function Xu(){return{}}function Ju(e){return e}function Zu(){}function ec(){return!1}function tc(){return Date.now()}ju.levels={values:{fatal:60,error:50,warn:40,info:30,debug:20,trace:10},labels:{10:"trace",20:"debug",30:"info",40:"warn",50:"error",60:"fatal"}},ju.stdSerializers=Ea,ju.stdTimeFunctions=Object.assign({},{nullTime:ec,epochTime:tc,unixTime:function(){return Math.round(Date.now()/1e3)},isoTime:function(){return new Date(Date.now()).toISOString()}});const ic=()=>{};function rc(e,t){const i=(e=t in e?e:console)[t]||e.log;return i?i.bind(e):ic}function nc(r,n,e,t,i){var{time:a,sessionId:s,critical:o,name:l,isEnabled:d,msg:u}=i;if(!(e.size&&!e.has(l)||t.has(l))){let e="";if("data"in i)try{const r=[],n=[];e=JSON.stringify(i.data,(e,t)=>{if("object"==typeof t&&null!==t){var i=n.indexOf(t);if(-1!==i)return`[Circular object reference: '${r[i]}']`;r.push(e),n.push(t)}return t})}catch(r){e=`Log serialization error: "${r}"`}d&&!d.value||r(`${function(){const e=new Date(a),t=e.getTimezoneOffset(),i=ac(Math.floor(Math.abs(t)/60)),r=ac(Math.abs(t)%60);let n=t<=0?"UTC+"+i:"UTC-"+i;return n=r?n+":"+r:n,e.getFullYear()+"-"+ac(e.getMonth()+1)+"-"+ac(e.getDate())+" "+ac(e.getHours())+":"+ac(e.getMinutes())+":"+ac(e.getSeconds())+"."+(e.getMilliseconds()/1e3).toFixed(3).slice(2,5)+" "+n}()}| [SessionID: ${s}] | [${n}] >${o?" [QE Critical]":""} [${l}] ${u||""} ${e}`)}}function ac(e){return e<10?"0"+e:e.toString()}function sc(e,t,i){if(e.has(t))return e.get(t);i=i();return e.set(t,i),i}class oc extends Map{constructor(e,t){super(Array.isArray(e)?e:Array.isArray(t)?t:null),this.max=oc.DEFAULT_MAX,"number"==typeof e?this.max=e:"number"==typeof t&&(this.max=t)}get(e){let t;return super.has(e)?(this.stats&&(this.stats.hits=this.stats.hits?1:this.stats.hits+1),t=super.get(e),super.delete(e),t&&super.set(e,t)):this.stats&&(this.stats.misses=this.stats.misses?1:this.stats.misses+1),t}set(e,t){return this.size>=this.max&&super.delete(super.keys().next().value),super.set(e,t),this}}oc.DEFAULT_MAX=5;function lc(e,r){return e.reduce((e,t)=>{if(((e,t)=>{let i=!0;e.videoCodec&&t.videoCodec&&(i=Re.isCompatibleVideoCodec(e.videoCodec,t.videoCodec));let r=!1;e.videoRange&&t.videoRange?r=e.videoRange==t.videoRange:e.videoRange||t.videoRange||(r=!0);let n=!0;return e.audioCodec&&t.audioCodec&&(n=Re.isCompatibleAudioCodec(e.audioCodec,t.audioCodec)),i&&r&&n})(r,t)){const r=t.audioAlternates&&0<t.audioAlternates.length?t.audioAlternates[0].groupId:void 0;r&&e.audioGroups.add(r),e.mediaOptions.add(t)}var i=t.subtitleAlternates&&0<t.subtitleAlternates.length?t.subtitleAlternates[0].groupId:void 0;i&&e.subtitleGroups.add(i);t=t.closedcaption;return t&&e.closedCaptionGroups.add(t),e},{mediaOptions:new Set,audioGroups:new Set,subtitleGroups:new Set,closedCaptionGroups:new Set})}const dc={clearkey:nd,fairplaystreaming:_l,playready:Nl,widevine:Fl},uc={getKeySystemFormat(e){e=dc[e];return e?e.keyFormatString:""},getKeySystemSecurityLevel(e){e=dc[e];return e?e.securityLevels:null}};class cc{constructor(e){this.option=e}get name(){return this.option.name}get priority(){return this.option.priority}get expiry(){return this.option.expiry}filter(n,e){const a=this.option.initFn&&this.option.initFn(n,e)||(e?Object.assign({},e):{});let t=n;return this.option.firstPassFn&&n.forEach((e,t)=>{var i,r;return null===(r=(i=this.option).firstPassFn)||void 0===r?void 0:r.call(i,e,t,a,n)}),this.option.filterFn&&(t=n.filter((e,t)=>{var i,r;return null===(r=(i=this.option).filterFn)||void 0===r?void 0:r.call(i,e,t,a,n)})),this.option.finalFn&&this.option.finalFn(t,a,n),t}}function hc(e,t,i){return(t||[]).reduce((e,t)=>t.filter(e,i),Array.from(e))}function pc(e,t){return e-t}function mc(e){return()=>e}function fc(i){return(e,t)=>-1*i(e,t)}function gc(...r){return(e,t)=>{for(const i of r){const r=i(e,t);if(r)return r}return 0}}function yc(n,a,{AgtB:s,AltB:o,ABgtPvt:l,ABltPvt:d,ABeqPvt:u,AeqPvt:c,BeqPvt:h}={}){return(e,t)=>{var i=n(e,a),r=n(t,a);return u&&0===i&&0===r?u(e,t):c&&0===i?c(e,t):h&&0===r?h(e,t):0<=i&&r<0||0<i&&r<=0?s?s(e,t):1:i<=0&&0<r||i<0&&0<=r?o?o(e,t):-1:0<=i&&0<=r?l?l(e,t):0:i<=0&&r<=0&&d?d(e,t):0}}function vc(e,t,i){var r=(e,t,i)=>(e-t)*(e-i)<=0;return r(e,i.minValidBitrate,i.maxValidBitrate)&&r(t,i.minValidHeight,i.maxValidHeight)}function Sc(e,t,i,r,n,a){var{targetDuration:s,targetStartupMs:o}=i,l=r["avgPlaylistLoadTimeMs"],d=n["avgParseTimeMs"],{avgBufferCreateMs:i,avgInitFragAppendMs:r,avgDataFragAppendMs:n}=a,{avgBandwidth:a,avgLatencyMs:t}=t;return e.bandwidth<=a&&(e.avgBandwidth||e.bandwidth)*s/a*1e3+l+i+1*(t+d+(r+n))<=o}function Ic(){const r=new Set,n=new Set,i=(e,i)=>((e=>{var t=i?"audio":"video";r.has(e)||n.has(e)||(((e,t)=>{let i=MediaSource.isTypeSupported(`${e}/mp4;codecs=${t}`);return"mp4a.40.34"!==t||i||(i=MediaSource.isTypeSupported(`${e}/mpeg`)),i})(t,e)?r:n).add(e)})(e),n.has(e));return e=>{let t=!1;return!(e.audioCodecList&&(t=e.audioCodecList.some(e=>i(e,!0)),t)||(e.videoCodecList&&(t=e.videoCodecList.some(e=>i(e,!1))),t))}}function bc(e,t){for(const i in e)if(e[i].type===t)return e[i];return{}}function Tc(e,t){var i;if(!t)return{highestPlayableAverageBitRate:void 0,highestPlayablePeakBitRate:void 0,highestPlayableWidth:void 0,highestPlayableHeight:void 0,highestPlayableFrameRate:void 0};const r=null!==(i=e.videoCodec)&&void 0!==i?i:"",n=e.videoRange,a=t.videoDynamicRangeFormats,s=t.videoCodecs,o=Re.getDynamicRangeType(n,r),l=Re.getCompressionType(r),d=function(e,t,i,r){if(!r&&!i)return{};t=i?bc(i,t):{},r=r?bc(r,e):{};let n,a;return a=e===pe.SDR?(n=t,r):(n=r,t),function(e,t){e=Object.entries(e).reduce((e,[t,i])=>(!z(i)&&"object"!=typeof i||(e[t]=i),e),{});return Object.assign(Object.assign({},t),e)}(Object.assign({},n),a)}(o,l,s,a);return l!==me.VP09&&(d.highestPlayablePeakBitRateForClearContent=void 0),d}function Ec(e){return e.reduce((e,t)=>{switch(t.type){case pe.DolbyVision:e.doViSupported=!0;break;case pe.HDR10:e.hdr10Supported=!0;break;case pe.HLG:e.hlgSupported=!0}return e},{doViSupported:!1,hdr10Supported:!1,hlgSupported:!1})}function Ac(e,t){t=uc.getKeySystemSecurityLevel(t);return null!=e&&null!=t&&void 0!==t[e]}function Oc(e,t){return!z(e)||!z(t)||e<=t}function wc(e,n){return e&&"number"!=typeof e?Object.entries(e).reduce((e,t)=>{var[i,r]=t,[t]=e,i=parseFloat(i);return z(i)&&z(r)?z(t)?z(n)?t<i&&i<=n?[i,r]:e:i<t?[i,r]:e:[i,r]:e},[void 0,void 0])[1]:z(e)?e:void 0}function Rc(e){return e.every(e=>e.iframes)}function Cc(e){return"PQ"===e.videoRange||"HLG"===e.videoRange}function kc(e,t){var i=1.35;if(!z(t.width)||!z(t.height))return!1;var r=e.width<t.width*i,n=e.height<t.height*i,i=e.width*e.height<t.width*t.height*i;return r&&n&&i}const Mc=(e=[])=>{const t=e.reduce((e,t,i,r)=>(e[t]=r.length-i,e),{});let i=-1;const r={};return e=>Object.prototype.hasOwnProperty.call(t,e)?t[e]:Object.prototype.hasOwnProperty.call(r,e)?r[e]:r[e]=i--};function Pc(e,{hasScore:i,pivotVariant:r,pathwayPriority:t,enableSteering:n,preferHostOverQuality:a,preferCloseToPivotQuality:s}={hasScore:!1,pivotVariant:null,pathwayPriority:null,enableSteering:!1,preferHostOverQuality:!0,preferCloseToPivotQuality:!1}){const o=(e,t)=>e.bitrate-t.bitrate,l=i?gc((e,t)=>i&&z(e.score)&&z(t.score)?e.score-t.score:0,fc(o)):o,d=(()=>{const t={};let i=0;if(null!=r){const i=oo(r.url);i&&(t[i]=e)}return e=>{e=oo(e.url);return null==e?-1:(Object.prototype.hasOwnProperty.call(t,e)||(t[e]=i++),t[e])}})(),u=(e,t)=>fc(pc)(d(t),d(e)),c=[];return null!=t&&n&&c.push(((e,i=Mc(e))=>(e,t)=>i(e.pathwayID)-i(t.pathwayID))(t)),a&&c.push(u),s&&null!=r?c.push(yc(fc(l),r,{AeqPvt:mc(1),BeqPvt:mc(-1),ABgtPvt:l,ABltPvt:fc(l)})):(null!=r&&c.push(yc(l,r)),c.push(l)),a||c.push(u),null!=r&&c.push(yc((e,t)=>null==e.audioAlternates||null==t.audioAlternates||e.audioAlternates===t.audioAlternates?1:-1,r)),gc(...c)}function Lc(e,t){var r,i,n,e=(e=[...e],r=t[0],e.filter(t=>{const i=performance.now();return!r||r.every(e=>e.expiry<=i||t.mediaOptionId!==e.id)}));return n=t[1],e=e.filter(t=>!n||n.every(e=>t.mediaOptionId!==e)),i=t[2],e=e.filter(t=>!i||i.some(e=>e===t.mediaOptionId))}function xc(e,t,i,r){var n;return e&&null!==(n=e.find(e=>!(0<(null==r?void 0:r.length)&&r.includes(e.mediaOptionId)||z(t)&&e.persistentID!==t)))&&void 0!==n?n:null}function Dc(e,t){var i=e.bitrate;if(e.iframes){e=e.frameRate||1;return i*(t.minIframeDuration/e)}return i}function _c(e){let t=0;var{avgPlaylistLoadTimeMs:i,avgLatencyMs:e}=e;return z(i)?t=i:z(e)&&(t=e),t}function Nc(e,t,i,r,n,a,s,o){var l=n.avgBandwidth,d=t.bitrate,u=Hc(null!=i?i:null,e,r),t=d*u,r=_c(n),d=t/l+C(n.avgLatencyMs,0)/1e3,t=null==i||i.liveOrEvent,l=Gc(n,!1,!1),o=Gc(n,o,t);let c=0;if(a){const h=(null===(t=null===(t=a.sbTuple[Ys.Variant])||void 0===t?void 0:t.buffered)||void 0===t?void 0:t.len)||0,p=i?Fc(e,i,a):Bc(u,e.maxStarvationDelay);c=Math.max(0,Math.ceil((p-h)/u))}null==i||!i.liveOrEvent||i.ptsKnown&&!Uc(i.totalduration,r,s)||(c=1);l=d+l;return{totalTime:d+o+c*l,avgTime:l}}function Fc(e,t,i){var r;let n=1/0;var a=i.playingFrags[t.mediaOptionType];if(a){const{mediaSeqNum:h,part:p,partIndex:r}=a;var s=p?qc(t.parts,h,r):qc(t.fragments,h);n=null!==(u=null==s?void 0:s.duration)&&void 0!==u?u:1/0}var{minRequiredStartDuration:o,maxRequiredStartDuration:l,startTargetDurationFactor:d,liveAllowLowLatencyPlayback:i,minRequiredStartDurationLLHLS:a}=e,{targetduration:s,averagetargetduration:u,partTargetDuration:e}=t,e=d*Math.min(n,u,s,l,i&&z(e)?e:1/0);let c=o;return i&&null!==(r=t.parts)&&void 0!==r&&r.length&&(c=a),Math.max(c,e)}function Bc(e,t){return z(e)?Math.min(e,t):t}function Uc(e,t,i){return t=z(t)?t:0,!z(i)||performance.now()-i+t>1e3*e}function Vc(e,t){t=z(t.avgParseTimeMs)?t.avgParseTimeMs:0;return performance.now()<e?t/1e3:Math.max(0,t-(performance.now()-e))/1e3}function $c(e,t){t=z(t.avgDataFragAppendMs)?t.avgDataFragAppendMs:0;return performance.now()<e?t/1e3:Math.max(0,t-(performance.now()-e))/1e3}function Qc(e,t){const i=e.query.slice(1).split("&"),r=new Map;i.forEach(e=>{var t=e.split("="),e=t[0],t=null!==(t=t[1])&&void 0!==t?t:"";r.set(decodeURIComponent(e),decodeURIComponent(t))});for(const[e,i]of Object.entries(t))i&&r.set(e,i);let n="";for(const[e,t]of Array.from(r.keys()).sort().map(e=>{return[e,null!==(e=r.get(e))&&void 0!==e?e:""]})){const i=encodeURIComponent(e),r=encodeURIComponent(t);n.length?n+=`&${i}=${r}`:n+=`?${i}=${r}`}e.query=n}function Kc(t,i){for(let e=0;e<t.length;e++){t[e]=Object.assign({},t[e]);const r=t[e];if(i["URI-REPLACEMENT"]["PER-RENDITION-URIS"]&&r.stableRenditionID&&i["URI-REPLACEMENT"]["PER-RENDITION-URIS"][r.stableRenditionID])r.url=i["URI-REPLACEMENT"]["PER-RENDITION-URIS"][r.stableRenditionID];else if(r.url){const t=i["URI-REPLACEMENT"].HOST,n=i["URI-REPLACEMENT"].PARAMS,a=no.parseURL(r.url);a&&(t&&(a.netLoc=`//${t}`),n&&Qc(a,n),r.url=no.buildURLFromParts(a))}r.groupId=`${r.groupId}_"${i.ID}"`,r.mediaOptionId=`${r.mediaOptionId}_${i.ID}`}}function qc(e,t,i=NaN){if(null!=e&&e.length)return z(i)?e.find(e=>e.mediaSeqNum===t&&e.partIndex===i):e[t-(null===(e=e[0])||void 0===e?void 0:e.mediaSeqNum)]}function Hc(e,t,i){return i?null!==(i=null==e?void 0:e.partTargetDuration)&&void 0!==i?i:t.defaultPartTargetDuration:null!==(e=null==e?void 0:e.targetduration)&&void 0!==e?e:t.defaultTargetDuration}function jc(e,t,i){return e&&t&&0<i}function Gc(t,i,e){let r=Vc(1/0,t)+$c(1/0,t);if(i){const i=t["avgInitFragAppendMs"];z(i)&&(r+=i/1e3)}if(e){const i=t["avgPlaylistParseTimeMs"];let e=_c(t);z(i)&&(e+=i),r+=e/1e3}return r}function zc(e,t,i,r,n,a,s,o,l,d,u,c,h){var p=s?d.bwUp:d.bwDown,m=e["trickPlaybackConfig"],s=Dc(t,m),d=Hc(null!=i?i:null,e,u),{totalTime:h,avgTime:o}=Nc(e,t,i,u,l,n,h,o),m=Dc({bitrate:t.bandwidth,iframes:t.iframes,frameRate:t.frameRate},m);return{adjustedbw:p,adjustedBitrate:s,fetchDuration:h,rejectLevelDueToPeakBW:s<p&&p<m&&r<=2*d,canFitMultipleSegments:a*((m||t.bitrate||0)*d)/8<=c,validFlowRate:o<=d&&(2*d<=r||h<.5*r||h<d)}}const Wc=[io.ContentSteeringPathwayCloner,io.PathwayPenaltyBoxFilter,io.PermanentRemovalFilter,io.PenaltyBoxFilter,io.CompatibleIdsFilter,io.HDRFilter,io.ViewportFilter,io.HDCPFilter,io.MatchingPathwayFilter],Yc=[io.RemoveAudioOnlyFilter,io.MediaFilteringBasedOnConfig,io.MediaFilteringBasedOnMaxAllowedHdcpLevel,io.MediaFilteringBasedOnSecurityLevel,io.MediaFilteringBasedOnKeySystemMediaCapabilities,io.MediaFilteringBasedOnSystemMediaCapabilities,io.MediaFilteringBasedOnAudioAndVideoCodecs,io.MediaFilteringBasedOnExtendedAudioParameters,io.MediaFilterBasedOnCaps,io.MediaIframeFilterBasedOnCapsOn1080p,io.MediaFilteringBasedOnSupportedVideoFormats],Xc={[ro.ABR]:[...Yc,...Wc,io.NonIframeOnlyFilter,io.ValidAlternatesFilter,io.BitrateFilter,io.ValidAbrLevelFilter,io.HigherQualitySelector],[ro.ABRLowestLevel]:[...Yc,...Wc,io.NonIframeOnlyFilter,io.ValidAlternatesFilter,io.LowerQualitySelector],[ro.ABRIframe]:[...Yc,...Wc,io.IframeOnlyFilter,io.BitrateFilter,io.ValidAbrLevelFilter,io.HigherQualitySelector],[ro.ABRIframeLowestLevel]:[...Yc,...Wc,io.IframeOnlyFilter,io.LowerQualitySelector],[ro.ErrorHandling]:[...Yc,...Wc,io.PathwayRankSelector,io.LowerPivotQualitySelector,io.HostRankSelector,io.PivotAudioGroupSelector,io.ValidFallbackFilter,io.ErrorHandlingValidAlternatesFilter,io.FallbackSelector],[ro.ErrorHandlingSdrOnly]:[...Yc,io.ContentSteeringPathwayCloner,io.PathwayPenaltyBoxFilter,io.PermanentRemovalFilter,io.PenaltyBoxFilter,io.SdrOnlyFilter,io.ViewportFilter,io.HDCPFilter,io.MatchingPathwayFilter,io.PathwayRankSelector,io.LowerPivotQualitySelector,io.HostRankSelector,io.PivotAudioGroupSelector,io.ValidFallbackFilter,io.ErrorHandlingValidAlternatesFilter,io.FallbackSelector],[ro.FirstSelection]:[...Yc,io.ContentSteeringPathwayCloner,io.PathwayPenaltyBoxFilter,io.PermanentRemovalFilter,io.PenaltyBoxFilter,io.CompatibleIdsFilter,io.HDRFilter,io.ViewportFilter,io.HDCPFilter,io.PathwayFilter,io.NonIframeOnlyFilter,io.StartUpTimeSelector,io.FirstLevelSelector],[ro.ImageVariant]:[io.MediaFilteringBasedOnImageIframes,io.MatchingPathwayFilter,io.MediaFilteringBasedOnConfig,io.MediaFilteringBasedOnMaxAllowedHdcpLevel,io.MediaFilteringBasedOnSecurityLevel,io.MediaFilteringBasedOnKeySystemMediaCapabilities,io.MediaIframeFilterBasedOnCapsOn1080p],[ro.CompatibleOptions]:[...Yc,io.ContentSteeringPathwayCloner,io.PathwayPenaltyBoxFilter,io.PermanentRemovalFilter,io.PenaltyBoxFilter,io.HDRFilter,io.ViewportFilter,io.HDCPFilter,io.PathwayFilter],[ro.PlatformFiltering]:[...Yc]};class Jc{constructor(e,t,i,r,n){this.store=e,this.transformersCache=t,this.selection$Cache=i,this.itemId=r,this.logger=n,this._selectTransformers=e=>t=>e.map(e=>t[e]).filter(e=>e)}variantFor(e){var{transformersCache:t,_inputVariants:i}=this;return this._applyTransformers(i,this._transformers(e),t)[0]}variantsFor(e){var{transformersCache:t,_inputVariants:i}=this;return this._applyTransformers(i,this._transformers(e),t,e!==ro.PlatformFiltering)}variantFor$(e){const{selection$Cache:t,transformersCache:i}=this;if(t.has(e))return t.get(e);var r=Qn([this._inputVariants$,this._transformers$(e)]).pipe(sr(([e,t])=>this._applyTransformers(e,t,i)[0]),xr(),tn());return t.set(e,r),r}getCompatibleOptionBasedOnFirstMediaOptions(e){return lc(this.variantsFor(ro.CompatibleOptions),e)}get _inputVariants(){return this.store.getEntity(this.itemId).inputVariants}get _inputVariants$(){return this.store.inputVariantsChanged$}_transformers(e){return this._selectTransformers(Xc[e])(this.store.getEntity(this.itemId).transformers)}_transformers$(e){return this.store.tranformersChanged$.pipe(this._selectTransformers$(Xc[e]))}_selectTransformers$(t){return e=>e.pipe(sr(this._selectTransformers(t)),bn())}_produceVariants(e,t,i){return sc(e,t.generation,()=>{var e=i(t.variants);return e===t.variants?t:new Bo(e)})}_applyTransformers(e,t,i,r=!0){for(const n of t){const t=e.variants,a=sc(i,n,Jc.newTransformerCache);if(e=this._produceVariants(a,e,n.apply.bind(n)),this.transformedMediaOptionInfoPrint(`Boss tansformerID: ${io[n.id]}`,t,e.variants,this.logger),!r&&(0===e.variants.length||Rc(e.variants))){const e=function(e){switch(e){case io.MediaFilteringBasedOnKeySystemMediaCapabilities:return new $(U.MEDIA_ERROR,V.MANIFEST_INCOMPATIBLE_CODECS_ERROR,!0,"no media option with key system access found in playlist",G.UnsupportedKeySystemAccess);case io.MediaFilteringBasedOnSystemMediaCapabilities:case io.MediaFilteringBasedOnAudioAndVideoCodecs:case io.MediaFilteringBasedOnExtendedAudioParameters:return new $(U.MEDIA_ERROR,V.MANIFEST_INCOMPATIBLE_CODECS_ERROR,!0,"no media option with compatible codecs found in manifest",G.UnsupportedMediaCodec);case io.MediaIframeFilterBasedOnCapsOn1080p:case io.MediaFilterBasedOnCaps:return new $(U.MEDIA_ERROR,V.MANIFEST_INCOMPATIBLE_CODECS_ERROR,!0,"no media option within platform/config caps found in manifest",G.FilterOutBasedOnCaps);case io.MediaFilteringBasedOnSupportedVideoFormats:return new $(U.MEDIA_ERROR,V.MANIFEST_INCOMPATIBLE_VIDEO_RANGE_ERROR,!0,"mediaOption with compatible VIDEO-RANGE not found in manifest",G.UnsupportedVideoDynamicRange);default:return}}(n.id);if(e)throw e;break}}return e.variants}static newTransformerCache(){const e=new oc;return e.stats=Jc.TransformerCacheStats,e}transformedMediaOptionInfoPrint(e,t,i,r){t.filter(e=>!i.includes(e)).map(e=>e.mediaOptionId)}}Jc.TransformerCacheStats={hits:0,misses:0};class Zc{constructor(){this.inputVariantsChanged$=new qr(null),this.tranformersChanged$=new qr({}),this.storage={}}getEntity(e){if(e)return this.storage[e]}addEntity(e){this.storage[e.itemId]=e}updateInputVariants(e,t){const i=this.storage[e];i&&(i.inputVariants=new Bo(t),this.inputVariantsChanged$.next(i.inputVariants))}updateTransformers(e,t,i){const r=this.storage[e];r&&(r.transformers[t]=i,this.tranformersChanged$.next(r.transformers))}deleteTransformers(e,t){const i=this.storage[e];i&&(delete i.transformers[t],this.tranformersChanged$.next(i.transformers))}removeEntityByID(e){delete this.storage[e]}resetStore(){this.storage={}}}const eh={NONE:0,"TYPE-0":1,"TYPE-1":2,"TYPE-2":3};function th(e){return e in eh}function ih(e){return null==e?4:eh[e]}function rh(e){return e?Re.isDolby(e)?Hs.DOVI:Re.isHEVC(e)?Hs.HEVC:Re.isVP09(e)?Hs.VP09:Re.isAVC(e)?Hs.AVC:Hs.UNKNOWN:Hs.UNKNOWN}function nh(e){return null==e?void 0:e.substring(0,4)}function ah(e){return e?Re.isALAC(e)?Gs.ALAC:Re.isFLAC(e)?Gs.FLAC:Re.isEC3(e)?Gs.EC3:Re.isAC3(e)?Gs.AC3:Re.isXHEAAC(e)?Gs.XHEAAC:Re.isAAC(e)?Gs.AAC:Re.isMP3(e)?Gs.MP3:Gs.UNKNOWN:Gs.UNKNOWN}function sh(e){return"PQ"===e?js.PQ:"HLG"===e?js.HLG:"SDR"===e?js.SDR:js.UNKNOWN}class oh{constructor(...e){this.identifier=e}ensureSameIdentifierLength(e){if(this.identifier.length!==e.identifier.length)throw new Error(`Identifiers have non-matching lengths! (${this.identifier.length} vs ${e.identifier.length})`)}isGreaterThan(t){this.ensureSameIdentifierLength(t);for(let e=0;e<this.identifier.length;++e){if(this.identifier[e]<t.identifier[e])return!1;if(this.identifier[e]>t.identifier[e])return!0}return!1}isEqualTo(i){return this.ensureSameIdentifierLength(i),this.identifier.every((e,t)=>e===i.identifier[t])}}const lh={getRichestVideoCodec(e){if(e&&e.length)return e&&K(e,rh)},getRichestAudioCodec(e){if(e&&e.length)return e&&K(e,ah)},getRichestChannelLayoutForGroupId(e){if(e&&e.length)return null===(e=K(null!=e?e:[],e=>Re.getChannelCount(e.channels)))||void 0===e?void 0:e.channels}};class dh{apply(i){let r,e=i;return this.initFn&&(r=this.initFn(i)),this.firstPassFn&&i.forEach((e,t)=>this.firstPassFn(e,t,i,r)),this.filterFn&&(e=i.filter((e,t)=>this.filterFn(e,t,i,r))),this.finalFn&&this.finalFn(e,i,r),e.length===i.length?i:e}}(Ea=Uu=Uu||{})[Ea.SelectMinimum=0]="SelectMinimum",Ea[Ea.SelectMaximum=1]="SelectMaximum";class uh extends dh{constructor(e){super(),this.removed=e,this.filterFn=(t,e,i)=>!this.removed||this.removed.every(e=>t.mediaOptionId!==e)}get id(){return io.PermanentRemovalFilter}}class ch extends dh{constructor(e){super(),this.compatibleIds=e,this.filterFn=(t,e,i)=>!this.compatibleIds||this.compatibleIds.some(e=>e===t.mediaOptionId)}get id(){return io.CompatibleIdsFilter}}class hh extends dh{constructor(e){super(),this.penaltyBoxInfo=e,this.filterFn=(t,e,i)=>{const r=performance.now();return!this.penaltyBoxInfo||this.penaltyBoxInfo.every(e=>e.expiry<=r||t.mediaOptionId!==e.id)}}get id(){return io.PenaltyBoxFilter}}class ph extends dh{constructor(e){super(),this.pathwayPenaltyBox=e,this.filterFn=(t,e,i)=>{const r=performance.now();return!this.pathwayPenaltyBox||this.pathwayPenaltyBox.every(e=>e.expiry<=r||t.pathwayID!==e.id)}}get id(){return io.PathwayPenaltyBoxFilter}}class mh extends dh{constructor(e,t){super(),this.hasHdrLevels=e,this.preferHDR=t,this.filterFn=(e,t,i)=>(this.hasHdrLevels&&this.preferHDR)===Cc(e)}get id(){return io.HDRFilter}}class fh extends dh{constructor(e){super(),this.viewportInfo=e,this.initFn=e=>{let t=NaN;return e.forEach(e=>{e&&!e.iframes&&e.videoCodec&&(t=!t||e.bitrate<t?e.bitrate:t)}),{lowestBitrate:t}},this.filterFn=(e,t,i,r)=>!(e&&r&&this.viewportInfo&&e.videoCodec&&r.lowestBitrate)||kc({width:e.width,height:e.height},this.viewportInfo)||e.bitrate===r.lowestBitrate}get id(){return io.ViewportFilter}}class gh extends dh{constructor(e){super(),this.maxHdcpLevel=e,this.filterFn=(e,t,i)=>!th(this.maxHdcpLevel)||ih(e.hdcpLevel)<ih(this.maxHdcpLevel)}get id(){return io.HDCPFilter}}class yh extends dh{constructor(e,t,i=!1,r=null){super(),this.fromVariant=e,this.shouldSwitchHosts=t,this.shouldDownswitch=i,this.excludingOptions=r,this.filterFn=(e,t,i)=>this.hasValidProperties(e)}get id(){return io.ValidFallbackFilter}hasValidProperties(t){var e=!(t.iframes!==this.fromVariant.iframes||this.shouldSwitchHosts&&ho(this.fromVariant,t)),i=this.shouldDownswitch?t.bitrate<this.fromVariant.bitrate:t.bitrate<=this.fromVariant.bitrate;return e&&i&&!(null!==(i=this.excludingOptions)&&void 0!==i&&i.some(e=>e===t.mediaOptionId))}}class vh extends dh{constructor(){super(),this.filterFn=(e,t,i)=>Boolean(e.videoCodec)}get id(){return io.RemoveAudioOnlyFilter}}class Sh extends dh{constructor(e,t){super(),this.disableVideoCodecList=e,this.disableAudioCodecList=t,this.filterFn=(e,t,i)=>(e.videoCodecList||[]).every(e=>{e=rh(e);return!this.disableVideoCodecList.has(e)})&&(e.audioCodecList||[]).every(e=>{e=ah(e);return!this.disableAudioCodecList.has(e)}),0===e.size&&0===t.size&&(this.filterFn=null)}get id(){return io.MediaFilteringBasedOnConfig}}class Ih extends dh{constructor(e,t){super(),this.maxHdcpLevel=e,this.logger=t,this.initFn=()=>({maxHdcpRanking:ih(this.maxHdcpLevel)}),this.filterFn=(e,t,i,r)=>{e=e.hdcpLevel;return!e||ih(e)<=r.maxHdcpRanking},this.finalFn=(e,t)=>{},this.maxHdcpLevel&&th(this.maxHdcpLevel)||(this.initFn=null,this.filterFn=null)}get id(){return io.HDCPFilter}}class bh extends dh{constructor(e,t,i){super(),this.maxSecurityLevel=e,this.keySystemId=t,this.logger=i,this.initFn=e=>{var t=uc.getKeySystemSecurityLevel(this.keySystemId),i=(e,t,i)=>Ac(e,t)?i[e]:-1;return{keyFormat:uc.getKeySystemFormat(this.keySystemId),maxSecurityLevelRanking:i(this.maxSecurityLevel,this.keySystemId,t),securityLevels:t,getSecurityLevelRanking:i}},this.filterFn=(e,t,i,r)=>{e=null!==(e=null===(e=e.allowedCPCMap)||void 0===e?void 0:e[r.keyFormat])&&void 0!==e?e:[];let n=!0;for(const a of e)if(n=r.getSecurityLevelRanking(a,this.keySystemId,r.securityLevels)<=r.maxSecurityLevelRanking,!n)break;return n},this.finalFn=(e,t)=>{},this.maxSecurityLevel&&this.keySystemId&&Ac(this.maxSecurityLevel,this.keySystemId)||(this.initFn=null,this.filterFn=null)}get id(){return io.MediaFilteringBasedOnSecurityLevel}}class Th extends dh{constructor(e,t,i){super(),this.keySystemMediaCapabilities=e,this.keySystemAccessEnabled=t,this.logger=i,this.filterFn=(e,t,i)=>{e=Gl(e.videoCodecList,e.audioCodecList),e=JSON.stringify(e);return!!this.keySystemMediaCapabilities.get(e)},this.finalFn=(e,t)=>{},t&&this.keySystemMediaCapabilities||(this.filterFn=null)}get id(){return io.MediaFilteringBasedOnKeySystemMediaCapabilities}}class Eh extends dh{constructor(e){super(),this.mediaApiCapabilities=e,this.filterFn=(e,t,i)=>{var r;const n=[];if(null===(r=e.videoCodecList)||void 0===r||r.forEach(e=>{n.push(e)}),0<(null===(r=e.audioCodecList)||void 0===r?void 0:r.length)){const t=lh.getRichestAudioCodec(e.audioCodecList);n.push(t)}return!!this.mediaApiCapabilities.get(n.join(","))},this.mediaApiCapabilities||(this.filterFn=null)}get id(){return io.MediaFilteringBasedOnSystemMediaCapabilities}}class Ah extends dh{constructor(e,t,i){super(),this.videoDynamicRangeFormats=e,this.mediaCapabilitiesEnabled=t,this.logger=i,this.initFn=e=>{this.videoDynamicRangeFormats=this.videoDynamicRangeFormats||[],this.mediaCapabilitiesEnabled&&0===this.videoDynamicRangeFormats.length&&(this.videoDynamicRangeFormats=[{type:pe.SDR},{type:pe.HDR},{type:pe.HDR10},{type:pe.DolbyVision},{type:pe.HLG}]);var{doViSupported:t,hdr10Supported:i,hlgSupported:r}=Ec(this.videoDynamicRangeFormats);return{doViSupported:t,hdr10Supported:i,hlgSupported:r}},this.filterFn=(e,t,i,r)=>{var n;switch(Re.getDynamicRangeType(e.videoRange,null!==(n=e.videoCodec)&&void 0!==n?n:"")){case pe.HDR:case pe.HDR10:if(r.hdr10Supported)return!0;break;case pe.DolbyVision:if(r.doViSupported)return!0;break;case pe.HLG:if(r.hlgSupported)return!0;break;default:if("SDR"===e.videoRange||null==e.videoRange)return!0}return!1}}get id(){return io.MediaFilteringBasedOnSupportedVideoFormats}}class Oh extends dh{constructor(e){super(),this.logger=e,this.filterFn=(e,t,i)=>e.iframes&&!!e.imageCodec,this.finalFn=(e,t)=>{}}get id(){return io.MediaFilteringBasedOnImageIframes}}class wh extends dh{constructor(e){super(),this.logger=e,this.initFn=e=>({isSupportedInternal:Ic()}),this.filterFn=(e,t,i,r)=>r.isSupportedInternal(e),this.finalFn=(e,t)=>{}}get id(){return io.MediaFilteringBasedOnAudioAndVideoCodecs}}class Rh extends dh{constructor(e,t){super(),this.audioMediaOptions=e,this.logger=t,this.initFn=e=>{const r=new Set,n=new Set,a=!MediaSource.isTypeSupported('audio/mp4; codecs="mp4a.40.2"; channels="-1"'),s=a&&!MediaSource.isTypeSupported('audio/mp4; codecs="mp4a.40.2"; channels="2"; features="INVALID"'),o=(e,t)=>{const i=t.split("/"),r=parseInt(i[0]);let n,a;if(1<i.length){const t=i[1].split(",")[0];n=`audio/mp4;codecs="${e}";channels="${r}";features="${t}"`,a=`audio/mp4;codecs="${e}";channels="8";features="${t}"`}else n=`audio/mp4;codecs="${e}";channels="${r}"`;let s=MediaSource.isTypeSupported(n);return!s&&a&&(s=MediaSource.isTypeSupported(a)),s},l=(e,t)=>{var i=`${e}/${t}`;r.has(i)||n.has(i)||(o(e,t)?r:n).add(i)};return{checkSupported:o,updateCachedMimeCodecSetsIfNecessary:l,checkUnsupportedMimeCodec:(e,t,i)=>{var r=Re.isDolbyAtmos(e,t);if(s||a&&!r){l(e,t);const a=`${e}/${t}`;return n.has(a)}return!!r}}},this.filterFn=(e,t,i,r)=>{let n=!1;if(e.audioCodecList&&e.audioAlternates){const t=lh.getRichestChannelLayoutForGroupId(e.audioAlternates);if(0<e.audioCodecList.length&&t){const i=lh.getRichestAudioCodec(e.audioCodecList);n=r.checkUnsupportedMimeCodec(i,t,this.logger)}}return!n},this.finalFn=(e,t)=>{}}get id(){return io.MediaFilteringBasedOnExtendedAudioParameters}}class Ch extends dh{constructor(){super(),this.filterFn=(e,t,i)=>!e.iframes||!e.width||!e.height||e.width*e.height<=2488320}get id(){return io.MediaIframeFilterBasedOnCapsOn1080p}}class kh extends dh{constructor(e,t,i){super(),this.sessionKeys=e,this.platformInfo=t,this.logger=i,this.initFn=e=>{var t;return{hasSessionKeys:0<(null===(t=this.sessionKeys)||void 0===t?void 0:t.length)}},this.filterFn=(e,t,i,r)=>{var n=Tc(e,this.platformInfo),{highestPlayablePeakBitRateForClearContent:a,highestPlayablePeakBitRate:s,highestPlayableAverageBitRate:o}=n,l=e.frameRate,o=wc(o,l),s=wc(s,l),l=wc(a,l),r=e.allowedCPCMap||r.hasSessionKeys,s=Oc(e.bandwidth,s);return(r||!l?s:s||Oc(e.bandwidth,l))&&Oc(e.avgBandwidth,o)&&Oc(e.width,n.highestPlayableWidth)&&Oc(e.height,n.highestPlayableHeight)&&Oc(e.frameRate,n.highestPlayableFrameRate)},this.finalFn=(e,t)=>{}}get id(){return io.MediaFilterBasedOnCaps}}class Mh{constructor(e=Uu.SelectMinimum){this.rule=e}get desc(){return Uu[this.rule]}apply(e){const t=this.makeComparator(e),i=[...e],r=i.splice(0,1);for(const e of i){const i=t(e,r[0]);0===i&&r.push(e),(this.rule===Uu.SelectMinimum&&i<0||this.rule===Uu.SelectMaximum&&0<i)&&r.splice(0,r.length,e)}return r.length===e.length?e:r}}(Ea=Vu=Vu||{})[Ea.SelectLowerQuality=0]="SelectLowerQuality",Ea[Ea.SelectHigherQuality=1]="SelectHigherQuality";class Ph extends Mh{constructor(e=Vu.SelectHigherQuality){super(e===Vu.SelectHigherQuality?Uu.SelectMaximum:Uu.SelectMinimum),this.qualityRule=e,this.name="QualitySelector"}get id(){return io.QualitySelector}get desc(){return Vu[this.qualityRule]}makeComparator(e){const i=e.every(e=>null!=e.score),t=(e,t)=>e.bitrate-t.bitrate;return i?gc((e,t)=>i&&z(e.score)&&z(t.score)?e.score-t.score:0,fc(t)):t}}class Lh extends dh{constructor(e,t){super(),this.minBitrate=e,this.maxBitrate=t,this.name="BitrateFilter",this.desc="Filter by bitrate over the inclusive range [minRate, maxRate]",this.filterFn=(e,t,i)=>e.bitrate>=this.minBitrate&&e.bitrate<=this.maxBitrate}get id(){return io.BitrateFilter}}class xh extends dh{constructor(e,t,i,r,n,a,s,o,l,d,u,c,h,p,m,f,g,y=!1){super(),this.currentFragDuration=e,this.maxFetchDuration=t,this.iframeMode=i,this.estimate=r,this.bwStatus=n,this.bwFactor=a,this.bwUpFactor=s,this.abrConfig=o,this.enabledVariantOption=l,this.mediaOptionListInfo=d,this.abrStatus=u,this.mediaOptionDetailsEntityRecord=c,this.bufferedDuration=h,this.maxBufferSize=p,this.mediaBufferInfo=m,this.lowLatencyMode=f,this.logger=g,this.dumpParams=y,this.filterFn=(e,t,i)=>function(e,t,i,r,n,a,s,o,l,d,u,c,h,p,m,f,g){const y=d.mediaOptionId,v=d&&d.iframes===r,S=a.bandwidthSampleCount,I=l.minTargetDurations||1,b=u.hasScore,T=d&&v?d.score:void 0,E=d&&v?d.frameRate:void 0,A=d&&v?d.height:void 0,O=e.mediaOptionId,w=e.score,R=h&&h[O]?h[O].mediaOptionDetails:void 0,C=h&&h[O]?h[O].lastUpdateMillis:null,k=Hc(null!=R?R:null,l,g),M=null!=d&&e.bitrate>d.bitrate,P=null!=d&&e.bitrate<d.bitrate;let L=!0;z(e.frameRate)&&(L=!(null!=E&&(M&&e.frameRate<E||P&&e.frameRate>E)));let x=!0;z(e.height)&&(x=!(M&&null!=A&&A>e.height));u=!(P&&(e.bitrate===d.bitrate-1||e.bitrate===d.bitrate+1));let D=!0;z(w)&&(D=!(b&&M&&null!=T&&(w<T||w===T&&d&&e.bitrate>=d.bitrate)));h=e.iframes===r;if(!(z(k)&&h&&L&&x&&u&&D))return!1;var s=function(e,t,i){let r,n;return 4<=S?(r=e*t,n=e*i):r=n=e/1.8,{bwUp:r,bwDown:n}}(n.avgBandwidth,o,s),{adjustedbw:f,adjustedBitrate:d,fetchDuration:n,rejectLevelDueToPeakBW:s,canFitMultipleSegments:g,validFlowRate:m}=zc(l,e,R,p,f,I,M,(null==d?void 0:d.mediaOptionId)!==e.mediaOptionId,n,s,g,m,C),t=null!=t.find(e=>e.mediaOptionId===y);if(d<f&&g&&!s&&m&&(r||!n||n<i)){if(i=f,f=a.instantBw,(c.fragDownloadSlow||c.fragDownloadTooSlow||z(f)&&f<i)&&t&&v){const _=y===e.mediaOptionId;if(p<=2*k&&(M||_))return!M;if(M&&o*a.instantBw<d)return!1}return!0}return!1}(e,i,(this.currentFragDuration,this.maxFetchDuration),this.iframeMode,this.estimate,this.bwStatus,this.bwFactor,this.bwUpFactor,this.abrConfig,this.enabledVariantOption,this.mediaOptionListInfo,this.abrStatus,this.mediaOptionDetailsEntityRecord,this.bufferedDuration,this.maxBufferSize,this.mediaBufferInfo,this.lowLatencyMode,(this.logger,this.dumpParams))}get id(){return io.ValidAbrLevelFilter}}const Dh=(e,t)=>e===t?0:t<e?1:-1;class _h extends Mh{constructor(e,t,i,r,n,a=Vu.SelectHigherQuality){super(a===Vu.SelectHigherQuality?Uu.SelectMaximum:Uu.SelectMinimum),this.bandwidthHistory=e,this.adaptiveStartupConfig=t,this.playlistEstimate=i,this.fragEstimate=r,this.bufferEstimate=n,this.qualityRule=a,this.name="StartUpTimeSelector"}get id(){return io.StartUpTimeSelector}get desc(){return"Dynamic selector which picks all options that are possible to use with the time allocated"}makeComparator(e){return(e,t)=>{e=this.bandwidthHistory&&this.adaptiveStartupConfig&&this.playlistEstimate&&this.fragEstimate&&!Sc(e,this.bandwidthHistory,this.adaptiveStartupConfig,this.playlistEstimate,this.fragEstimate,this.bufferEstimate)?0:1,t=this.bandwidthHistory&&this.adaptiveStartupConfig&&this.playlistEstimate&&this.fragEstimate&&!Sc(t,this.bandwidthHistory,this.adaptiveStartupConfig,this.playlistEstimate,this.fragEstimate,this.bufferEstimate)?0:1;return Dh(e,t)}}}class Nh extends Mh{constructor(e,t=Vu.SelectHigherQuality){super(t===Vu.SelectHigherQuality?Uu.SelectMaximum:Uu.SelectMinimum),this.firstMediaOptionSelectionMetrics=e,this.qualityRule=t,this.name="FirstLevelSelector"}get id(){return io.FirstLevelSelector}get desc(){return"All static first level selectors chained here"}makeComparator(e){const i=e.every(e=>null!=e.score);return i?gc((e,t)=>i&&z(e.score)&&z(t.score)?e.score-t.score:0,fc((e,t)=>e.bitrate-t.bitrate)):gc((e,t)=>{e=vc(e.bitrate,e.height,this.firstMediaOptionSelectionMetrics),t=vc(t.bitrate,t.height,this.firstMediaOptionSelectionMetrics);return Dh(e,t)},(e,t)=>{e=sh(e.videoRange),t=sh(t.videoRange);return Dh(e,t)},(e,t)=>{e=rh(e.videoCodec),t=rh(t.videoCodec);return Dh(e,t)},(e,t)=>{e=e.audioChannelCount||1,t=t.audioChannelCount||1;return Dh(e,t)},(e,t)=>{e=ah(e.audioCodec),t=ah(t.audioCodec);return Dh(e,t)},(e,t)=>{e=e.bitrate<this.firstMediaOptionSelectionMetrics.maxPreferredBitrate,t=t.bitrate<this.firstMediaOptionSelectionMetrics.maxPreferredBitrate;return Dh(e,t)},(e,t)=>{e=e.height,t=t.height;return Dh(e,t)})}}class Fh extends dh{constructor(){super(),this.filterFn=(e,t,i)=>!1===Cc(e)}get id(){return io.SdrOnlyFilter}}class Bh extends Mh{constructor(e,t=Vu.SelectHigherQuality){super(t===Vu.SelectHigherQuality?Uu.SelectMaximum:Uu.SelectMinimum),this.criteria=e,this.qualityRule=t,this.name="SortSelector"}get id(){return io.FallbackSelector}get desc(){return"Uses the comparator to bubbles up the most desirable quality. By default fallback (higher) quality is selected.             To pick lower quality use qualityRule = QualitySelectorRule.SelectLowerQuality"}makeComparator(e){return Pc(e.length,this.criteria)}}class Uh extends dh{constructor(e,t,i,r,n,a,s,o){super(),this.currentAudioIsAtmos=e,this.altAudioFilterParams=t,this.subtitleFilterParams=i,this.audioPersistentId=r,this.subtitlePersistentId=n,this.mediaOptionMask=a,this.excludingOptions=s,this.switchingAudioLanguage=o,this.filterFn=(e,t,i)=>{var r,n,a,s=Lc(null!==(r=e.subtitleAlternates)&&void 0!==r?r:[],this.subtitleFilterParams);let o=Lc(null!==(a=e.audioAlternates)&&void 0!==a?a:[],this.altAudioFilterParams);return this.switchingAudioLanguage||null==this.currentAudioIsAtmos||(o=(r=o,n=this.currentAudioIsAtmos,0===(a=r.filter(e=>!!e.channels&&n===Re.isJOCChannels(e.channels))).length&&n?r:a)),function(e,t,i,r,n,a,s=[]){let o=!1;var l,d,s=function(e,t,i,r,n){i=z(i)?xc(e,i,0,n):void 0,n=z(r)?xc(t,r,0,n):void 0;return[i||wo,n||wo]}(r,n,t,i,s);return l=[e,...s],d=a,[Ys.Variant,Ys.AltAudio,Ys.Subtitle].reduce((e,t)=>e&&d[t]===Ro(l[t]),!0)&&(o=!0),o}(e,this.audioPersistentId,this.subtitlePersistentId,o,s,this.mediaOptionMask,this.excludingOptions)}}get id(){return io.ValidAlternatesFilter}}class Vh extends dh{constructor(e){super(),this.iframeMode=e,this.filterFn=(e,t,i)=>e.iframes===this.iframeMode}get id(){return io.MediaFilterBasedOnMode}}class $h extends dh{constructor(e){super(),this.currentPathwayID=e,this.filterFn=(e,t,i)=>co(e.pathwayID,this.currentPathwayID)}get id(){return io.MatchingPathwayFilter}}class Qh extends class{apply(e){const t=this.getNewVariants(e);return 0===t.length?e:t.concat(e)}}{constructor(e,t){super(),this.pathwayClones=e,this.clonedPathwayMapping=t}get id(){return io.ContentSteeringPathwayCloner}reOrderCloneRulesIfNeeded(t){const i=new Map;let r,e,n=!1;if(this.pathwayClones.forEach(e=>{i.has(e["BASE-ID"])||t.has(e["BASE-ID"])||(n=!0),i.set(e.ID,e),r?r.push([e["BASE-ID"],e.ID]):r=[[e["BASE-ID"],e.ID]]}),n){try{e=o(r)}catch(t){return}this.pathwayClones=[],e.forEach(e=>{i.has(e)&&this.pathwayClones.push(i.get(e))})}}getNewVariants(t){var i;const r=new Map;t.forEach(e=>{r.has(e.pathwayID)?r.get(e.pathwayID).push(e):r.set(e.pathwayID,[e])}),this.reOrderCloneRulesIfNeeded(r);for(let e=0;e<this.pathwayClones.length;e++){const n=this.pathwayClones[e],a=[],s=n["BASE-ID"];if(!r.has(n.ID)&&!this.clonedPathwayMapping.has(n.ID)&&(r.has(s)||this.clonedPathwayMapping.has(s))){const t=null!==(i=r.get(s))&&void 0!==i?i:this.clonedPathwayMapping.get(s),o=new Map,l=new Map;t.forEach(e=>{const t=Object.assign({},e);if(t.mediaOptionId=`${t.mediaOptionId}_${n.ID}`,a.push(t),t.pathwayID=n.ID,t.url){const r=no.parseURL(t.url);if(n["URI-REPLACEMENT"].HOST&&(r.netLoc=`//${n["URI-REPLACEMENT"].HOST}`),n["URI-REPLACEMENT"].PARAMS&&Qc(r,n["URI-REPLACEMENT"].PARAMS),n["URI-REPLACEMENT"]["PER-VARIANT-URIS"]&&e.stableVariantID&&n["URI-REPLACEMENT"]["PER-VARIANT-URIS"][e.stableVariantID]?t.url=n["URI-REPLACEMENT"]["PER-VARIANT-URIS"][e.stableVariantID]:t.url=no.buildURLFromParts(r),t.audioAlternates&&0<t.audioAlternates.length){const e=`${t.audioAlternates.find(e=>!!e).groupId}_"${n.ID}"`;if(o.has(e))t.audioAlternates=o.get(e);else{const e=[...t.audioAlternates];Kc(e,n),t.audioAlternates=e;var i=t.audioAlternates.find(e=>!!e).groupId;o.set(i,t.audioAlternates)}}if(t.subtitleAlternates&&0<t.subtitleAlternates.length){const e=`${t.subtitleAlternates.find(e=>!!e).groupId}_"${n.ID}"`;if(l.has(e))t.subtitleAlternates=l.get(e);else{const e=[...t.subtitleAlternates];Kc(e,n),t.subtitleAlternates=e;i=t.subtitleAlternates.find(e=>!!e).groupId;l.set(i,t.subtitleAlternates)}}}}),this.clonedPathwayMapping.set(n.ID,a)}}let n=[];for(const[t,i]of this.clonedPathwayMapping)n=n.concat(i);return n}}class Kh{constructor(e){this.store=e,this.staticTransformers={[io.LowerQualitySelector]:new Ph(Vu.SelectLowerQuality),[io.HigherQualitySelector]:new Ph(Vu.SelectHigherQuality),[io.SdrOnlyFilter]:new Fh,[io.NonIframeOnlyFilter]:new Vh(!1),[io.IframeOnlyFilter]:new Vh(!0)},this.transformersCache=new Map,this.selection$Cache=new Map}getQuery(e,t){return this.transformersCache.has(e)||this.transformersCache.set(e,new WeakMap),this.selection$Cache.has(e)||this.selection$Cache.set(e,new oc),new Jc(this.store,this.transformersCache.get(e),this.selection$Cache.get(e),e,t)}setVariants(e,t){this._addEmptyEntity(e),this.store.updateInputVariants(e,t)}setTransformer(e,t,i){this._addEmptyEntity(e),this.store.updateTransformers(e,t,i)}setMultipleTransformers(e,t){for(var[i,r]of t)this.setTransformer(e,i,r)}removeTransformer(e,t){this._addEmptyEntity(e),this.store.deleteTransformers(e,t)}destroyItems(e){e.forEach(this.destroyItem.bind(this))}destroyItem(e){this.transformersCache.delete(e),this.selection$Cache.delete(e),this.store.removeEntityByID(e)}endItem(){this.transformersCache.clear(),this.selection$Cache.clear(),this.store.resetStore()}destroy(){this.transformersCache.clear(),this.selection$Cache.clear(),this.store.resetStore()}_addEmptyEntity(e){this.store.getEntity(e)||this.store.addEntity({itemId:e,inputVariants:new Bo([]),transformers:Object.assign({},this.staticTransformers)})}}const qh={timeRangesToBufferedRange(t){const i=[];for(let e=0;t&&e<t.length;e++)i.push({start:t.start(e),end:t.end(e)});return i},getBufferedInfo(e,t,i){let r,n,a,s,o;var l=this.getBufferedTimeRanges(e,i),d=Math.max(i,.001);for(o=0,r=0,n=a=t;o<l.length;o++){const e=l[o]["start"],i=l[o]["end"];if(t+d>=e&&t<i)n=e,a=i,r=a-t;else if(t+d<e){s=e;break}}return{len:r,start:n,end:a,nextStart:s}},getBufferedTimeRanges(e,t){const i=[],r=e.map(({start:e,end:t})=>({start:e,end:t}));r.sort((e,t)=>e.start-t.start||t.end-e.end);for(let e=0;e<r.length;e++){var n,a=i.length;a?(n=i[a-1].end,r[e].start-n<t?r[e].end>n&&(i[a-1].end=r[e].end):i.push(r[e])):i.push(r[e])}return i},isTimeRangeContainedInRanges(t,i,r=.25){for(let e=0;e<t.length;e++)if(i.start>=t[e].start-r&&i.end<=t[e].end+r)return!0;return!1}};function Hh(e,i){return null==e&&null==i||null!=e&&null!=i&&e.combined===i.combined&&e.sbTuple.every((e,t)=>e===i.sbTuple[t])}function jh(e){return null!=e&&"iframeMediaDuration"in e&&"iframeMediaStart"in e}function Gh(e,t){return e===t||e&&t&&e.itemId===t.itemId&&e.mediaOptionId===t.mediaOptionId&&e.mediaSeqNum===t.mediaSeqNum&&e.discoSeqNum===t.discoSeqNum&&(!e.part&&!t.part||e.part===t.part&&e.partIndex===t.partIndex)}function zh(e,t){return e===t||e&&t&&e.itemId===t.itemId&&e.mediaOptionId===t.mediaOptionId&&e.mediaSeqNum===t.mediaSeqNum&&e.discoSeqNum===t.discoSeqNum}function Wh(e,t){return t&&e&&t.part&&!e.part&&t.itemId===e.itemId&&t.mediaOptionId===e.mediaOptionId&&t.mediaSeqNum===e.mediaSeqNum}function Yh(e){var{itemId:t,mediaOptionId:i,discoSeqNum:r,keyTagInfo:e}=e;return{itemId:t,mediaOptionId:i,discoSeqNum:r,keyId:xe(null==e?void 0:e.keyId)}}function Xh(e,i){return null==e||e.length!==i.length||e.some((e,t)=>e.start!==i[t].start||e.end!==i[t].end)}(Ea=$u=$u||{}).Seek="Seek",Ea.HighBuffer="HighBuffer",Ea.LowBuffer="LowBuffer",Ea.BufferHole="BufferHole",(Ea=Qu=Qu||{})[Ea.AlmostDry=0]="AlmostDry",Ea[Ea.LowWater=1]="LowWater",Ea[Ea.HighWater=2]="HighWater",Ea[Ea.AboveHighWater=3]="AboveHighWater";class Jh extends pa{constructor(){super({},{name:"media-element-store"}),this.query=new Sa(this),this._activeId=""}get activeId(){return this._activeId}startMediaSession(i,r,n,a){return this._activeId=`media session: ${(new Date).toISOString()}`,da(()=>{var e=a,t=Math.max(e,r-e),t={id:this.activeId,desiredRate:!i.autoplay&&i.paused?0:1,paused:i.paused,gotPlaying:!1,seeking:i.seeking,seekTo:null,flushing:!1,readyState:i.readyState,ended:i.ended,bufferedRanges:[],contentGapRanges:[],haveEnough:!1,mediaSourceEntity:null,expectSeekingEvent:!1,expectedSbCount:NaN,bufferMonitorInfo:{waterLevelType:null,almostDryWaterLevelSeconds:n,lowWaterLevelSeconds:e,highWaterLevelSeconds:t,maxBufferSeconds:r},mediaOptionParsedSubtitleRecord:{},textTracksCreated:!1,waitingForDisco:!1};this.add(t),this.setActive(this.activeId)}),this.activeId}_partialForSourceBufferUpdate(e,t,i){var r=this.query.getActive(),n=null==r?void 0:r.mediaSourceEntity;if(r&&n){const a={};a.mediaSourceEntity=Object.assign(Object.assign({},n),{sourceBufferEntities:n.sourceBufferEntities?[...n.sourceBufferEntities]:[null,null]});i=null!==(n=a.mediaSourceEntity.sourceBufferEntities[e])&&void 0!==n?n:i;return i?(a.mediaSourceEntity.sourceBufferEntities[e]=Object.assign(Object.assign({},i),t),a):void 0}}_updateSourceBuffer(e,t,i){i=this._partialForSourceBufferUpdate(e,t,i);i&&this.updateActive(i)}setMediaSourceEntity(e,t){var i=this.query.getActive();i&&this.updateActive({mediaSourceEntity:null!=e&&null!=t?{objectUrl:e,readyState:t,duration:NaN,sourceBufferEntities:[null,null]}:null,bufferedRanges:[],haveEnough:!1,expectSeekingEvent:!1,readyState:0,bufferMonitorInfo:Object.assign(Object.assign({},i.bufferMonitorInfo),{waterLevelType:null}),seeking:!1})}set mediaElementDuration(e){var t=this.query.getActive(),i=null==t?void 0:t.mediaElementDuration;t&&i!==e&&this.updateActive({mediaElementDuration:e})}set primaryContentMediaElementDuration(e){var t=this.query.getActive(),i=null==t?void 0:t.primaryContentMediaElementDuration;t&&i!==e&&(!z(i)||0<e&&i<e)&&this.updateActive({primaryContentMediaElementDuration:e})}set msReadyState(e){var t=this.query.getActive(),i=null===(i=null==t?void 0:t.mediaSourceEntity)||void 0===i?void 0:i.readyState;t&&i!==e&&this.updateActive({mediaSourceEntity:Object.assign(Object.assign({},t.mediaSourceEntity),{readyState:e})})}set readyState(e){var t=this.query.getActive();if(t&&(null==t?void 0:t.readyState)!==e){const i={readyState:e};e>=HTMLMediaElement.HAVE_METADATA&&(i.expectSeekingEvent=null!=t.seekTo),this.updateActive(i)}}set ended(e){var t=this.query.getActive(),i=null==t?void 0:t.ended;t&&i!==e&&this.updateActive({ended:e})}set msDuration(e){var t=this.query.getActive(),i=null===(i=null==t?void 0:t.mediaSourceEntity)||void 0===i?void 0:i.duration;t&&i!==e&&this.updateActive({mediaSourceEntity:Object.assign(Object.assign({},t.mediaSourceEntity),{duration:e})})}set textTracksCreated(e){var t=this.query.getActive(),i=null==t?void 0:t.textTracksCreated;t&&i!==e&&this.updateActive({textTracksCreated:e})}set expectedSbCount(e){var t=this.query.getActive(),i=null==t?void 0:t.expectedSbCount;t&&i!==e&&this.updateActive({expectedSbCount:e})}setSeekToPos(e,t=!1,i,r,n){var a=this.query.getActive();if(a){const s={};z(e)?(s.seekTo={pos:e,fromEvent:t,discoSeqNum:i,inContentGap:r,startPos:n},s.gotPlaying=!1,s.haveEnough=!1,s.expectSeekingEvent=a.readyState>=HTMLMediaElement.HAVE_METADATA):s.seekTo=null,t&&(s.seeking=z(e),s.expectSeekingEvent=!1),this.updateActive(s)}}setLiveSeekableRange(e){this.updateActive({liveSeekableRange:e})}set seeking(e){this.updateActive({seeking:e,expectSeekingEvent:!1})}set paused(e){const t={paused:e};(t.paused=e)&&(t.gotPlaying=!1),this.updateActive(t)}gotPlayingEvent(){var e=this.query.getActive();!e||e.gotPlaying||e.paused||this.updateActive({gotPlaying:!0})}set desiredRate(e){this.updateActive({desiredRate:e})}set haveEnough(e){var t;(null===(t=this.query.getActive())||void 0===t?void 0:t.haveEnough)!==e&&this.updateActive({haveEnough:e})}set flushing(e){var t;!(null===(t=this.query.getActive())||void 0===t||!t.flushing)!=!!e&&this.updateActive({flushing:e})}set waitingForDisco(e){var t;!(null===(t=this.query.getActive())||void 0===t||!t.waitingForDisco)!=!!e&&this.updateActive({waitingForDisco:e})}setSourceBufferUpdating(e){this._updateSourceBuffer(e,{updating:!0,error:void 0})}setTimestampOffset(e,t){var i=this.query.getActive(),i=null===(i=null===(i=null==i?void 0:i.mediaSourceEntity)||void 0===i?void 0:i.sourceBufferEntities)||void 0===i?void 0:i[e];i&&i.timestampOffset!==t&&this._updateSourceBuffer(e,{timestampOffset:t})}setBufferedRangesUpdated(e,t,i,r,n,a){var s=this.query.getActive();if(s){var o=null===(u=null===(d=s.mediaSourceEntity)||void 0===d?void 0:d.sourceBufferEntities)||void 0===u?void 0:u[e],l=null==o?void 0:o.bufferedRanges,d=s.bufferedRanges,u=r||Xh(l,t),l=r||Xh(d,i),d=a&&null!=(null==o?void 0:o.inFlight);if(null!=o&&o.updating||u||l||d){const c={},h=null===(d=null===(d=s.mediaSourceEntity)||void 0===d?void 0:d.sourceBufferEntities)||void 0===d?void 0:d[e];if(h){c.mediaSourceEntity=Object.assign(Object.assign({},s.mediaSourceEntity),{sourceBufferEntities:[...s.mediaSourceEntity.sourceBufferEntities]});const i=Object.assign({},h);i.updating=!1,(u||a)&&(i.bufferedRanges=[...t],i.bufferedSegments=[...h.bufferedSegments]),a&&(r?i.inFlight=null:(s=i,t=n,a=s.inFlight,n=s.bufferedSegments,a&&z(a.startPTS)&&z(a.endPTS)&&function(r,n,a){if(0===r.length||r[0].startPTS>=n.endPTS)r.splice(0,0,n);else{let i=!1;for(let t=r.length-1;-1<t;t--){let e=r[t];var s=e.endPTS-e.startPTS,o=Math.max(n.startPTS,e.startPTS),l=Math.min(n.endPTS,e.endPTS),d=l-o;l<o||d<a||((s=(1-d/s)*e.bytes)<=0?(!e.evicting&&Gh(e.frag,n.frag)&&(n.rebuffered=!0),r.splice(t,1)):(Object.isFrozen(e)&&(e=r[t]=Object.assign({},e)),e.bytes=s,e.startPTS<n.startPTS?e.endPTS=o:(e.startPTS=l,i||(r.splice(t,0,n),i=!0))))}if(!i){let e=r.length-1;for(;0<e&&r[e].startPTS>n.startPTS;)e--;r.splice(e+1,0,n)}}}(n,a,t),s.inFlight=null)),u&&function(i,e){const r=i.bufferedSegments,n=i.bufferedRanges;let a,s=0,o=!1;if(n.length)for(let t=r.length-1;-1<t;t--){let e=r[t];Object.isFrozen(e)&&(e=r[t]=Object.assign({},e)),e.partialFrag&&!e.evicting&&(e.evicting=!0);const u=!e.frag.iframe;u&&e.frag.isLastFragment&&t===r.length-1&&(a=e.frag);var l=e.endPTS-e.startPTS,d=function(e,t){let i,r=0;for(const n of e)if(n.start<=t.endPTS&&n.end>t.startPTS){const e=function(e,t){return Math.min(e.endPTS,t.end)-Math.max(e.startPTS,t.start)}(t,n);e>r&&(i=n,r=e)}else if(0<r)break;return i}(n,e);if(d){const i=Math.max(d.start,e.startPTS),r=Math.min(d.end,e.endPTS),n=r-i;s+=e.bytes*n/l,u&&(n<l&&z(e.appendStart)&&z(e.appendEnd)&&(e.appendStart<i||e.appendEnd>r)&&(e.evicting=!0),e.appendStart=i,e.appendEnd=r)}else r.splice(t,1),o=e.frag===a}else r.length&&r.splice(0,r.length);i.totalDuration=a&&!o&&0<n.length?n[n.length-1].end:1/0,i.gotQuotaExceeded=i.gotQuotaExceeded||e,i.totalBytes=s,i.maxTotalBytes=Math.max(i.totalBytes,i.maxTotalBytes)}(i,r),c.mediaSourceEntity.sourceBufferEntities[e]=i}l&&(c.bufferedRanges=[...i]),this.updateActive(c)}}}updateContentGapRanges(e){this.updateActive({contentGapRanges:e})}updateSourceBufferEntity(e,t){var{mimeType:i,audioCodec:r,videoCodec:t}=t;this._updateSourceBuffer(e,{mimeType:i,audioCodec:r,videoCodec:t,initSegmentInfo:null})}setSourceBufferEntity(e,t){var{mimeType:i,audioCodec:r,videoCodec:t}=t;this._updateSourceBuffer(e,{},{mimeType:i,audioCodec:r,videoCodec:t,updating:!1,bufferedRanges:[],timestampOffset:0,inFlight:null,bufferedSegments:[],totalBytes:0,maxTotalBytes:0,gotQuotaExceeded:!1,totalDuration:1/0})}setInflightSegment(e,t){this._updateSourceBuffer(e,{inFlight:t})}updateInFlightRange(e,t){var i=this.query.getActive(),r=null===(r=null==i?void 0:i.inFlightRanges)||void 0===r?void 0:r[e];if(!(!i||null==r&&null==t||null!=r&&null!=t&&r.start===t.start&&r.end===t.end)){const n=i.inFlightRanges?[...i.inFlightRanges]:[null,null];n[e]=t,this.updateActive({inFlightRanges:n})}}setInitSegmentEntity(e,t){this._updateSourceBuffer(e,{initSegmentInfo:t})}setSourceBufferError(e,t){this._updateSourceBuffer(e,{inFlight:null,updating:!1,error:t})}setStallInfo(e){var t=this.query.getActive(),i=null==t?void 0:t.stallInfo;if(t&&(null==i?void 0:i.currentTime)!==(null==e?void 0:e.currentTime)){const r={stallInfo:e};e&&(r.gotPlaying=!1),this.updateActive(r)}}setNudgeInfo(e){this.updateActive({nudgeInfo:e})}updateWaterLevels(e,t){var i=this.query.getActive(),r=null===(r=null==i?void 0:i.bufferMonitorInfo)||void 0===r?void 0:r.waterLevelType;i&&!Hh(r,{combined:e,sbTuple:t})&&this.updateActive({bufferMonitorInfo:Object.assign(Object.assign({},i.bufferMonitorInfo),{waterLevelType:{combined:e,sbTuple:[...t]}})})}set bufferMonitorTargetDuration(e){var t,i,r,n,a=this.query.getActive();!a||!z(e)||e<=0||({maxBufferSeconds:t,lowWaterLevelSeconds:i,highWaterLevelSeconds:r}=a.bufferMonitorInfo,n=Math.min(e,t),e=Math.max(n,t-e),n===i&&e===r||this.updateActive({bufferMonitorInfo:Object.assign(Object.assign({},a.bufferMonitorInfo),{lowWaterLevelSeconds:n,highWaterLevelSeconds:e})}))}archiveParsedSubtitleFragmentRecord(t,i,r){var n=this.query.getActive();if(n){const a={mediaOptionParsedSubtitleRecord:Object.assign({},n.mediaOptionParsedSubtitleRecord)};let e=a.mediaOptionParsedSubtitleRecord[t];e=e?Object.assign({},e):{},e[i]=r,a.mediaOptionParsedSubtitleRecord[t]=e,this.updateActive(a)}}clearAllParsedSubtitleFragmentRecord(){var e=null===(e=this.query.getActive())||void 0===e?void 0:e.mediaOptionParsedSubtitleRecord;e&&0===Object.keys(e).length||this.updateActive({mediaOptionParsedSubtitleRecord:{}})}clearParsedSubtitleFragmentRecord(e){var t,i=this.query.getActive();if(i&&null!==(t=i.mediaOptionParsedSubtitleRecord)&&void 0!==t&&t[e]){const r=Object.assign({},i.mediaOptionParsedSubtitleRecord);delete r[e],this.updateActive({mediaOptionParsedSubtitleRecord:r})}}removeOldSubtitleFragmentRecord(t){const i=this.query.getActive();if(i){const n={mediaOptionParsedSubtitleRecord:{}};for(const a of Object.keys(i.mediaOptionParsedSubtitleRecord)){let e;var r=i.mediaOptionParsedSubtitleRecord[a];for(const i of Object.keys(r)){const n=Number(i),s=r[n];s.endTime>t&&(e=e||{},e[n]=s)}null!=e&&(n.mediaOptionParsedSubtitleRecord[a]=e)}this.updateActive(n)}}removeLaterSubtitleFragmentRecord(t){const i=this.query.getActive();if(i){const n={mediaOptionParsedSubtitleRecord:{}};for(const a of Object.keys(i.mediaOptionParsedSubtitleRecord)){let e;var r=i.mediaOptionParsedSubtitleRecord[a];for(const i of Object.keys(r)){const n=Number(i),s=r[n];s.startTime<t&&(e=e||{},e[n]=s)}e&&(n.mediaOptionParsedSubtitleRecord[a]=e)}this.updateActive(n)}}}function Zh(e){return null==e?void 0:e.itemStartOffsets[Ys.Variant]}function ep(e){return z(e)&&0!==e&&1!==e}function tp(e){return z(e)&&(0===e||1===e)}class ip extends Error{}class rp{constructor(e){this.value=e,this.waiters=[],this.wcounter=0,this.rcounter=0}lock(e,t=!1){return this._lock(!0,e,t)}unlock(){this._unlock(!0)}readLock(e,t=!1){return this._lock(!1,e,t)}readUnlock(){this._unlock(!1)}_schedule(){const t=[];this.waiters=this.waiters.filter(e=>!this._canLock(e.rw)||(e.rw?++this.wcounter:++this.rcounter,t.push(e),!1));for(const e of t)e.observer.next(this.value),e.observer.complete()}_canLock(e){return e&&0===this.wcounter&&0===this.rcounter||!e&&0===this.wcounter}_lock(i,e,r=!1){"boolean"==typeof e&&([r,e]=[e,void 0]);const t=new oi(e=>{var t=this._canLock(i);if(r&&!t)throw new ip;t?(i?++this.wcounter:++this.rcounter,e.next(),e.complete()):this.waiters.push({rw:i,observer:e})});return e?t.pipe(pr(()=>((e,t,i,r)=>{if(!r)return Pr(e);let n,a;try{n=r(e,t)}catch(e){a=Lr(()=>e)}return a=a||(void 0===n?Pr(e):ar(n)),a.pipe(Br(i))})(this.value,e=>{this.value=e},()=>this._unlock(i),e))):t}_unlock(e){e?this.wcounter=Math.max(this.wcounter-1,0):this.rcounter=Math.max(this.rcounter-1,0),this._schedule()}}class np extends oi{constructor(){super(e=>this._count$.pipe(_r(e=>0===e),kr(1),Mr(void 0)).subscribe(e)),this._count$=new qr(0)}wrap(e){return Pn(()=>(this.add(),ar(e))).pipe(cn({error:e=>this._count$.error(e)}),Br(()=>this.done()))}add(e=1){this._count$.next(this._count$.value+e)}done(e=1){this._count$.next(this._count$.value-e)}}function ap(t,e){return[{threshold:e.highWaterLevelSeconds,level:Qu.HighWater},{threshold:e.lowWaterLevelSeconds,level:Qu.LowWater},{threshold:e.almostDryWaterLevelSeconds,level:Qu.AlmostDry}].find(({threshold:e})=>e<t)}function sp(t,e){return[{threshold:e.almostDryWaterLevelSeconds,level:Qu.AlmostDry},{threshold:e.lowWaterLevelSeconds,level:Qu.LowWater},{threshold:e.highWaterLevelSeconds,level:Qu.HighWater},{threshold:1/0,level:Qu.AboveHighWater}].find(({threshold:e})=>t<=e)}function op(t,i){const e=sp(t.getCurrentWaterLevel(i),t.bufferMonitorInfo).level,r=[null,null];return[Xs.Variant,Xs.AltAudio].forEach(e=>{null!=t.sourceBufferEntityByType(e)&&(r[e]=sp(t.getCurrentWaterLevelByType(e,i),t.bufferMonitorInfo).level)}),{combined:e,sbTuple:r}}function lp(i,r){return ur([i.combinedBuffer$,i.seeking$]).pipe(on(()=>Jl(i.updating$,e=>!e)),tr(Li),sr(()=>i.getCurrentWaterLevel(r)),xr(),on(e=>{const t=Pr(op(i,r));return 0===e?t:t.pipe(Fr(()=>ur([i.paused$,i.stallInfo$]).pipe(sr(([e,t])=>!e&&null==t),xr(),on(e=>e?function t(i,r,e){const n=i.getCurrentWaterLevel(r),a=ap(n,i.bufferMonitorInfo);if(a){const e=a["threshold"];return Ki(Math.ceil(1e3*(n-e))).pipe(on(()=>{const e=ap(i.getCurrentWaterLevel(r),i.bufferMonitorInfo);return(null==e?void 0:e.level)===a.level?t(i,r):Yl}),sr(()=>op(i,r)))}return Cr}(i,r):Cr),kr(1))))}))}class dp extends Sa{constructor(e,t,i){super(t),this.mediaElement=e,this.logger=i}get mediaElementDuration$(){return this.selectActive(({mediaElementDuration:e})=>e)}get primaryContentMediaElementDuration(){var e;return null!==(e=null===(e=this.getActive())||void 0===e?void 0:e.primaryContentMediaElementDuration)&&void 0!==e?e:1/0}get mediaElementDuration(){var e;return null!==(e=null===(e=this.getActive())||void 0===e?void 0:e.mediaElementDuration)&&void 0!==e?e:1/0}get msDuration(){var e;return null!==(e=null===(e=this.mediaSourceEntity)||void 0===e?void 0:e.duration)&&void 0!==e?e:1/0}get minSBDuration(){var e;let i=Number.POSITIVE_INFINITY;return null===(e=null===(e=this.mediaSourceEntity)||void 0===e?void 0:e.sourceBufferEntities)||void 0===e||e.forEach((e,t)=>{e&&(i=z(e.totalDuration)?Math.min(i,e.totalDuration):Number.NEGATIVE_INFINITY)}),z(i)?i:1/0}get currentTime(){return this.mediaElement.currentTime}get clientWidth(){return this.mediaElement.clientWidth}get clientHeight(){return this.mediaElement.clientHeight}getBufferedDuration(e=.5){var t=qh.timeRangesToBufferedRange(this.mediaElement.buffered),e=qh.getBufferedInfo(t,this.currentTime,e);return e.end-e.start}get mediaSourceEntity(){var e;return null===(e=this.getActive())||void 0===e?void 0:e.mediaSourceEntity}get msReadyState(){var e;return null===(e=this.mediaSourceEntity)||void 0===e?void 0:e.readyState}get sourceBufferEntities(){var e;return null===(e=this.mediaSourceEntity)||void 0===e?void 0:e.sourceBufferEntities}sourceBufferEntityByType(e){var t;return null===(t=this.sourceBufferEntities)||void 0===t?void 0:t[e]}initSegmentEntityByType(e){return null===(e=this.sourceBufferEntityByType(e))||void 0===e?void 0:e.initSegmentInfo}get maxBufferSize(){var e=null===(e=this.sourceBufferEntities)||void 0===e?void 0:e[Xs.Variant];let t=1/0;return null!=e&&e.gotQuotaExceeded&&(t=null!==(e=e.maxTotalBytes)&&void 0!==e?e:1/0),t}get seekable(){return this.mediaElement.seekable}get liveSeekableRange(){var e;return null===(e=this.getActive())||void 0===e?void 0:e.liveSeekableRange}get liveSeekableRange$(){return this.selectActive(({liveSeekableRange:e})=>e)}get seekableTimeRanges(){return up(this.liveSeekableRange,this.seekable)}get seekableTimeRanges$(){return ur([this.liveSeekableRange$,this.mediaElementDuration$]).pipe(sr(([e])=>up(e,this.seekable)))}get isPlayingAtLive(){var{liveSeekableRange:e,isIframeRate:t}=this;return null!=e&&!t&&this.currentTime>=e.boundary+(performance.now()-e.tupdate)/1e3}get expectSeekingEvent(){var e;return null!==(e=null===(e=this.getActive())||void 0===e?void 0:e.expectSeekingEvent)&&void 0!==e&&e}get desiredRate(){var e;return(null===(e=this.getActive())||void 0===e?void 0:e.desiredRate)||0}get desiredRate$(){return this.selectActive(({desiredRate:e})=>null!=e?e:0)}get effectiveRate(){return this.isIframeRate?this.desiredRate:this.paused?0:1}get playbackRate(){return this.mediaElement.playbackRate}get isIframeRate(){return ep(this.desiredRate)}get isIframeRate$(){return this.desiredRate$.pipe(sr(ep))}get msObjectUrl$(){return this.selectActive(({mediaSourceEntity:e})=>null==e?void 0:e.objectUrl).pipe(xr())}get msReadyState$(){return this.selectActive(({mediaSourceEntity:e})=>{return null!==(e=null==e?void 0:e.readyState)&&void 0!==e?e:null})}get readyState(){var e;return null!==(e=null===(e=this.getActive())||void 0===e?void 0:e.readyState)&&void 0!==e?e:0}get readyState$(){return this.selectActive(({readyState:e})=>null!=e?e:0)}get mediaSourceEntity$(){return this.selectActive(({mediaSourceEntity:e})=>e)}get expectedSbCount$(){return this.selectActive(({expectedSbCount:e})=>e)}get expectedSbCount(){var e;return null===(e=this.getActive())||void 0===e?void 0:e.expectedSbCount}get paused$(){return this.selectActive(({paused:e})=>e)}get paused(){var e;return null===(e=null===(e=this.getActive())||void 0===e?void 0:e.paused)||void 0===e||e}get flushing$(){return this.selectActive(({flushing:e})=>e)}get flushing(){var e;return null!==(e=null===(e=this.getActive())||void 0===e?void 0:e.flushing)&&void 0!==e&&e}get waitingForDisco$(){return this.selectActive(({waitingForDisco:e})=>e)}get waitingForDisco(){var e;return null!==(e=null===(e=this.getActive())||void 0===e?void 0:e.waitingForDisco)&&void 0!==e&&e}get gotPlaying(){var e;return null!==(e=null===(e=this.getActive())||void 0===e?void 0:e.gotPlaying)&&void 0!==e&&e}get gotPlaying$(){return this.selectActive(({gotPlaying:e})=>e)}get seekTo(){var e;return null===(e=this.getActive())||void 0===e?void 0:e.seekTo}get seekTo$(){return this.selectActive(({seekTo:e})=>e)}get seeking(){var e;return null!==(e=null===(e=this.getActive())||void 0===e?void 0:e.seeking)&&void 0!==e&&e}get seeking$(){return this.selectActive(({seeking:e})=>e)}get seekToPos$(){return this.selectActive(({seekTo:e})=>null==e?void 0:e.pos).pipe(xr())}get seekInProgress(){var e;return z(null===(e=this.seekTo)||void 0===e?void 0:e.pos)}get seekInProgress$(){return this.selectActive(({seekTo:e})=>z(null==e?void 0:e.pos)).pipe(xr())}get nudgeTarget$(){return this.selectActive(({nudgeInfo:e})=>null==e?void 0:e.nudgeTarget)}get nudgeCount(){var e;return null!==(e=null===(e=null===(e=this.getActive())||void 0===e?void 0:e.nudgeInfo)||void 0===e?void 0:e.nudgeCount)&&void 0!==e?e:0}get inFlightRange(){var e;return null===(e=this.getActive())||void 0===e?void 0:e.inFlightRanges}get inFlightRanges$(){return this.selectActive(({inFlightRanges:e})=>e)}get sourceBufferEntities$(){return this.selectActive(({mediaSourceEntity:e})=>null==e?void 0:e.sourceBufferEntities)}sourceBufferEntityByType$(t){return this.selectActive(({mediaSourceEntity:e})=>{return null===(e=null==e?void 0:e.sourceBufferEntities)||void 0===e?void 0:e[t]})}bufferedSegmentsByType$(t){return this.selectActive(({mediaSourceEntity:e})=>{return null!==(e=null===(e=null===(e=null==e?void 0:e.sourceBufferEntities)||void 0===e?void 0:e[t])||void 0===e?void 0:e.bufferedSegments)&&void 0!==e?e:[]})}getBufferedSegmentsByType(e){return null!==(e=null===(e=this.sourceBufferEntityByType(e))||void 0===e?void 0:e.bufferedSegments)&&void 0!==e?e:[]}get bufferedSegmentsTuple$(){return this.selectActive(e=>{var t;return[null!==(t=null===(t=null===(t=null===(t=null==e?void 0:e.mediaSourceEntity)||void 0===t?void 0:t.sourceBufferEntities)||void 0===t?void 0:t[Xs.Variant])||void 0===t?void 0:t.bufferedSegments)&&void 0!==t?t:[],null!==(e=null===(e=null===(e=null===(e=null==e?void 0:e.mediaSourceEntity)||void 0===e?void 0:e.sourceBufferEntities)||void 0===e?void 0:e[Xs.AltAudio])||void 0===e?void 0:e.bufferedSegments)&&void 0!==e?e:[]]})}get timeupdate$(){const e=rl(this.mediaElement);return this._timeupdate$||(this._timeupdate$=e.event("timeupdate").pipe(pn(125,void 0,{leading:!0,trailing:!0}),sr(()=>this.currentTime),_r(e=>z(e)),tn())),this._timeupdate$}get playingEvent$(){return rl(this.mediaElement).event("playing").pipe(sr(()=>{}))}get mediaElementEntity$(){return this.selectActive(e=>Boolean(e))}get ended$(){return this.selectActive(e=>{return null!==(e=null==e?void 0:e.ended)&&void 0!==e&&e})}sbUpdating$(t){return this.selectActive(e=>{return null!==(e=null===(e=null===(e=null===(e=null==e?void 0:e.mediaSourceEntity)||void 0===e?void 0:e.sourceBufferEntities)||void 0===e?void 0:e[t])||void 0===e?void 0:e.updating)&&void 0!==e&&e})}sbUpdating(e){var t;return null!==(e=null===(e=null===(t=null===(t=null===(t=this.getActive())||void 0===t?void 0:t.mediaSourceEntity)||void 0===t?void 0:t.sourceBufferEntities)||void 0===t?void 0:t[e])||void 0===e?void 0:e.updating)&&void 0!==e&&e}sbError(e){var t;return null===(e=null===(t=null===(t=null===(t=this.getActive())||void 0===t?void 0:t.mediaSourceEntity)||void 0===t?void 0:t.sourceBufferEntities)||void 0===t?void 0:t[e])||void 0===e?void 0:e.error}get updating$(){return ur([this.sbUpdating$(Xs.Variant),this.sbUpdating$(Xs.AltAudio)]).pipe(sr(e=>e.some(e=>e)),xr())}get bufferedRangeTuple$(){return this.selectActive(e=>{var t;return[null===(t=null===(t=null===(t=null==e?void 0:e.mediaSourceEntity)||void 0===t?void 0:t.sourceBufferEntities)||void 0===t?void 0:t[Xs.Variant])||void 0===t?void 0:t.bufferedRanges,null===(e=null===(e=null===(e=null==e?void 0:e.mediaSourceEntity)||void 0===e?void 0:e.sourceBufferEntities)||void 0===e?void 0:e[Xs.AltAudio])||void 0===e?void 0:e.bufferedRanges]})}get bufferedRangeTuple(){return[this.getBufferedRangeByType(Xs.Variant),this.getBufferedRangeByType(Xs.AltAudio)]}getBufferedRangeByType$(t){return this.selectActive(e=>{return null!==(e=null===(e=null===(e=null===(e=null==e?void 0:e.mediaSourceEntity)||void 0===e?void 0:e.sourceBufferEntities)||void 0===e?void 0:e[t])||void 0===e?void 0:e.bufferedRanges)&&void 0!==e?e:[]})}getBufferedRangeByType(e){var t;return null!==(e=null===(e=null===(t=this.sourceBufferEntities)||void 0===t?void 0:t[e])||void 0===e?void 0:e.bufferedRanges)&&void 0!==e?e:[]}get combinedBuffer$(){return this.selectActive(e=>{return null!==(e=null==e?void 0:e.bufferedRanges)&&void 0!==e?e:[]})}get combinedBuffer(){var e;return null!==(e=null===(e=this.getActive())||void 0===e?void 0:e.bufferedRanges)&&void 0!==e?e:[]}gotFirstAppend$(e){var t=Jl(ur([this.combinedBuffer$,this.updating$]),([e,t])=>0<(null==e?void 0:e.length)&&!t);return e?nr(t,e):t}get desiredPos(){var e;return C(null===(e=this.seekTo)||void 0===e?void 0:e.pos,this.currentTime)}getMediaBufferInfo(i,e){const t=this.getBufferInfo(i,e),r=[null,null];t.forEach((e,t)=>{r[t]=null!==(e=null===(e=e.bufferedSegments.find(e=>e.startPTS<=i&&e.endPTS>i))||void 0===e?void 0:e.frag)&&void 0!==e?e:null});e=this.getCombinedBufferInfo(i,e);return{pos:i,playbackRate:this.playbackRate,sbTuple:t,combined:e,playingFrags:r}}getBufferInfo(n,a,s){var e;const t=null===(e=this.sourceBufferEntities)||void 0===e?void 0:e.map(e=>null==e?void 0:e.bufferedRanges),i={buffered:{start:n,end:n,len:0},bufferedSegments:[]},o=[i,i];return t&&t.forEach((e,t)=>{if(e){const i=qh.getBufferedInfo(e,n,a),r=null!==(e=this.sourceBufferEntities[t].bufferedSegments)&&void 0!==e?e:[];if(s){let e=!1;for(const n of r)n.frag.itemId===s&&n.startPTS<i.end&&n.endPTS>=i.start&&(e=!0,i.start=Math.max(i.start,n.startPTS),i.end=Math.min(i.end,n.endPTS));e||(i.start=i.end=n),i.len=i.start-i.end}o[t]={buffered:i,bufferedSegments:r}}}),o}getCombinedBufferInfo(e,t){var i=this.getActive();return i?qh.getBufferedInfo(i.bufferedRanges,e,t):null}getContentGapRanges(){var e=this.getActive();return e?e.contentGapRanges:[]}hasGaps$(){return this.selectActive(e=>0<(null==e?void 0:e.contentGapRanges.length))}avoidContentGap(t,i,e){let r=t;var n=this.getActive();if(n)for(let e=0;e<n.contentGapRanges.length;e++){var a=n.contentGapRanges[e];if(t>a.start-i&&t<a.end){r=a.end;break}}return r}get bufferMonitorInfo(){var e;return null!==(e=null===(e=this.getActive())||void 0===e?void 0:e.bufferMonitorInfo)&&void 0!==e?e:null}get bufferMonitorThresholds$(){return this.selectActive(e=>{var t=null==e?void 0:e.bufferMonitorInfo;if(!t)return null;var{almostDryWaterLevelSeconds:i,lowWaterLevelSeconds:r,highWaterLevelSeconds:e,maxBufferSeconds:t}=t;return{almostDryWaterLevelSeconds:i,lowWaterLevelSeconds:r,highWaterLevelSeconds:e,maxBufferSeconds:t}}).pipe(xr((e,t)=>(null==e?void 0:e.lowWaterLevelSeconds)===(null==t?void 0:t.lowWaterLevelSeconds)))}get waterLevelType$(){return this.selectActive(e=>{return null!==(e=null==e?void 0:e.bufferMonitorInfo.waterLevelType)&&void 0!==e?e:null})}waterLevelForType(e){var t;return null!==(e=null===(t=null===(t=this.bufferMonitorInfo)||void 0===t?void 0:t.waterLevelType)||void 0===t?void 0:t.sbTuple[e])&&void 0!==e?e:null}waterLevelChangedForType$(t){return this.waterLevelType$.pipe(sr(e=>null==e?null:null==t?e.combined:e.sbTuple[t]))}isBufferedToEnd$(r,t=!0){return Qn([this.combinedBuffer$,this.selectActive(e=>e.bufferMonitorInfo).pipe(_d(),sr(e=>t?e.almostDryWaterLevelSeconds:Math.max(e.almostDryWaterLevelSeconds,e.lowWaterLevelSeconds/2))),this.seeking$]).pipe(sr(([e,t])=>{var i=this.minSBDuration;if(!e||!z(i))return!1;e=qh.getBufferedInfo(e,this.currentTime,r).end;return Math.abs(i-e)<=t}),xr())}get haveEnough(){var e;return null!==(e=null===(e=this.getActive())||void 0===e?void 0:e.haveEnough)&&void 0!==e&&e}get haveEnough$(){return this.selectActive(({haveEnough:e})=>e)}withinFragDurationOfContentGap(t,i=10){var r=this.getContentGapRanges();for(let e=0;e<r.length;e++)if(t>r[e].start-i&&t<r[e].start)return!0;return!1}static likelyToKeepUp(e,t,i){return t&&e&&i>=e.HAVE_FUTURE_DATA}get playbackLikelyToKeepUp(){return dp.likelyToKeepUp(this.mediaElement,this.haveEnough,this.readyState)}get playbackLikelyToKeepUp$(){return ur([this.haveEnough$,this.readyState$]).pipe(sr(([e,t])=>dp.likelyToKeepUp(this.mediaElement,e,t)),xr())}getCurrentWaterLevel(e){var t=this.currentTime,i=null!==(i=null===(i=this.getActive())||void 0===i?void 0:i.bufferedRanges)&&void 0!==i?i:[];return qh.getBufferedInfo(i,t,e).len}getCombinedMediaSourceBufferInfo(e){var t=this.currentTime,[i,r]=null===(r=null===(i=this.getActive())||void 0===i?void 0:i.mediaSourceEntity)||void 0===r?void 0:r.sourceBufferEntities;return[qh.getBufferedInfo(null!==(i=null==i?void 0:i.bufferedRanges)&&void 0!==i?i:[],t,e),qh.getBufferedInfo(null!==(r=null==r?void 0:r.bufferedRanges)&&void 0!==r?r:[],t,e)]}getCurrentWaterLevelByType(e,t){var i=this.currentTime,e=this.sourceBufferEntityByType(e),e=null!==(e=null==e?void 0:e.bufferedRanges)&&void 0!==e?e:[];return qh.getBufferedInfo(e,i,t).len}canContinuePlaybackWithoutGap(e,t,i,r){if("LIVE"!==e.type)return!0;if(!e.ptsKnown)return!1;var n=this.currentTime,a=performance.now()+i.avgPlaylistLoadTimeMs+1e3*e.targetduration,s=e.fragments,i=s[0].start,s=s[s.length-1].start+s[s.length-1].duration,t=i+(a-t)/1e3;let o=this.getBufferInfo(n,r)[Do(e.mediaOptionType)].buffered["end"];return o>=i-r&&o<=s&&(o=s),t<=o+r}get stallInfo$(){return this.selectActive(e=>{return null!==(e=null==e?void 0:e.stallInfo)&&void 0!==e?e:null})}get stallInfo(){var e;return null!==(e=null===(e=this.getActive())||void 0===e?void 0:e.stallInfo)&&void 0!==e?e:null}get textTracks(){return this.mediaElement.textTracks}get textTracksCreated$(){return this.selectActive(e=>null==e?void 0:e.textTracksCreated)}get mediaOptionParsedSubtitleRecord(){var e;return null===(e=this.getActive())||void 0===e?void 0:e.mediaOptionParsedSubtitleRecord}getParsedSubtitleRecordsForMediaOption(e){return this.mediaOptionParsedSubtitleRecord?this.mediaOptionParsedSubtitleRecord[e]||{}:null}}function up(e,t){let i=qh.timeRangesToBufferedRange(t);if(e){const t=[];for(const r of i)r.end<e.start||r.start>e.edge||t.push({start:Math.max(e.start,r.start),end:Math.min(e.edge,r.end)});i=t}return i}class cp{constructor(e,t,i,r){this.mediaSink=e,this.media=t,this.logger=r,this.useCustomMediaFunctions=i.useCustomMediaFunctions,this.overridePlaybackRate=i.overridePlaybackRate}install(){const e=this.media;e&&(this.useCustomMediaFunctions&&e&&e.play&&e.pause&&(e.originalPlay||(e.originalPlay=e.play.bind(e)),e.originalPause||(e.originalPause=e.pause.bind(e)),e.play=()=>(this.mediaSink.checkForReplay(),this.mediaSink.desiredRate=1,0<e.currentTime&&!e.paused&&!e.ended&&2<e.readyState?Promise.resolve():new Promise((e,t)=>{this.pendingPlayPromises||(this.pendingPlayPromises=[]),this.pendingPlayPromises.push({resolve:e,reject:t})})),e.pause=()=>{this.mediaSink.desiredRate=0}),"function"==typeof HTMLMediaElement&&this.overridePlaybackRate&&Object.defineProperty(e,"playbackRate",{enumerable:!0,configurable:!0,get:function(){return 1},set:function(e){Object.getOwnPropertyDescriptor(HTMLMediaElement.prototype,"playbackRate").set.call(this,e)}}),this.playPromise=null,this.expectPauseEvent=this.expectPlayEvent=!1)}uninstall(){const e=this.media;e&&(e.originalPlay&&(e.play=e.originalPlay,delete e.originalPlay),e.originalPause&&(e.pause=e.originalPause,delete e.originalPause),this.overridePlaybackRate&&(e.playbackRate=1,delete e.playbackRate)),this.playPromise=null,this.expectPauseEvent=this.expectPlayEvent=!1}play(){var e;this.media&&(e=this.mediaSink.flushing,this.playPromise||e||(this.expectPlayEvent=this.expectPlayEvent||this.media.paused,this.playPromise=this._mediaPlayInternal(),this.playPromise&&this.playPromise.then(()=>{this.playPromise=null,this._handlePendingPlayPromises(null)}).catch(e=>{this.playPromise=null,this.expectPlayEvent=!1,this._handlePendingPlayPromises(e||new Error("Play rejected for unknown reason")),"NotAllowedError"===(null==e?void 0:e.name)&&(this.mediaSink.desiredRate=0)})))}pause(e=!1){if(this.media){if(e)return this._handlePendingPlayPromises(null),void this._mediaPauseInternal();this.playPromise?this.playPromise.then(()=>{var e=this.mediaSink.mediaQuery;(0===this.mediaSink.desiredRate||e.seeking&&!e.playbackLikelyToKeepUp)&&this._mediaPauseInternal()}).catch(e=>{}):this._mediaPauseInternal()}}_handlePendingPlayPromises(t){var e,i=null===(e=this.pendingPlayPromises)||void 0===e?void 0:e.length;if(t)for(let e=0;e<i;e++)this.pendingPlayPromises[e].reject(t);else for(let e=0;e<i;e++)this.pendingPlayPromises[e].resolve();this.pendingPlayPromises=[]}_mediaPlayInternal(){return(this.media.originalPlay||this.media.play.bind(this.media))()}_mediaPauseInternal(){return this.expectPauseEvent=this.expectPauseEvent||!this.media.paused,(this.media.originalPause||this.media.pause.bind(this.media))()}}class hp extends Error{}class pp extends v{constructor(e,t,i,r,n){super(U.MEDIA_ERROR,e,t,i,r),this.sbType=n,this.response=r}}class mp extends pp{constructor(e,t,i,r){super(V.BUFFER_ADD_CODEC_ERROR,!1,e,t,i),this.mediaOptionId=r,this.mediaOptionType=_o(this.sbType)}}class fp extends pp{constructor(e,t,i,r,n,a){super(e,t,i,r,n),this.isTimeout=a,this.mediaOptionType=_o(this.sbType)}}class gp extends fp{constructor(e,t,i,r){super(V.BUFFER_FULL_ERROR,!1,e,t,i,!1),this.maxTotalBytes=r}}class yp extends fp{constructor(e,t,i){super(V.BUFFER_APPEND_ERROR,!1,e,t,i,!0)}}class vp extends fp{constructor(e,t,i,r){super(V.BUFFER_APPEND_ERROR,!1,e,t,i,!1),this.mediaOptionId=r,this.mediaOptionType=_o(this.sbType)}}class Sp extends v{constructor(e,t,i,r,n,a,s=NaN){super(U.MEDIA_ERROR,e,t,i,r),this.stallType=n,this.bufferLen=a,this.nudgePosition=s,this.response=r}}class Ip extends oi{constructor(n,e,a,s,o,l,d,u,c){super(e=>{const t=rl(l),i=this.logger=u.child({sb:o});n.setSourceBufferEntity(o,d),d.mimeType.includes("audio/mpeg")&&(this.updateMp3Timestamps=!0);const r=Vn(t.event("updatestart").pipe(cn(()=>{n.setSourceBufferUpdating(o)})),t.event("updateend").pipe(tr(Cn),cn(()=>{var e=qh.timeRangesToBufferedRange(l.buffered),t=qh.timeRangesToBufferedRange(a.buffered);this.updateEndFn&&(this.updateEndFn(),this.updateEndFn=null),n.setBufferedRangesUpdated(o,e,t,!1,c.maxBufferHole,!0)})),t.event("error").pipe(cn(()=>{this.updateEndFn=null,n.setSourceBufferError(o,"Got source buffer error")})),t.event("abort").pipe(cn(()=>{this.updateEndFn=null}))).pipe(on(()=>Cr)).subscribe(e);return()=>{r.unsubscribe();try{"open"===s.readyState&&l.abort(),this.updateEndFn=null,s.removeSourceBuffer(l)}catch(e){i.error(`Error aborting SourceBuffer on unsubscribe: ${e.message}`)}}}),this.mediaElementStore=n,this.mediaElementQuery=e,this.mediaElement=a,this.type=o,this.sourceBuffer=l,this.config=c,this.updateMp3Timestamps=!1}get buffered(){return this.sourceBuffer.buffered}appendBuffer(e,t,i){return Pn(()=>this.sourceBuffer.updating?this._waitForUpdateEndOrError().pipe(on(()=>this.appendBuffer(e,t,i))):this._appendBufferAsync(e,t,i))}clearInitSegmentInfo(){this.mediaElementStore.setInitSegmentEntity(this.type,null)}updateInitSegmentInfo(e){e=Yh(e);this.mediaElementStore.setInitSegmentEntity(this.type,e)}updatePartialSegmentInfo(e){this.clearInitSegmentInfo(),this.abort()}_appendBufferAsync(e,t,i){let r=NaN,n=null;const a=("startPTS"in t?t.frag:t).mediaOptionId,s="startPTS"in t?t.frag.mediaOptionType:void 0;try{"startPTS"in t&&(n={startPTS:t.startPTS,endPTS:t.endPTS,bytes:t.bytes,frag:Object.assign({},t.frag),partialFrag:t.partialFrag}),this.mediaElementStore.setInflightSegment(this.type,n),"initParsedData"in t?this.updateEndFn=this.updateInitSegmentInfo.bind(this,t):t.partialFrag&&(this.updateEndFn=this.updatePartialSegmentInfo.bind(this,t)),r=performance.now(),z(i)&&this.sourceBuffer.timestampOffset!==i&&(this.sourceBuffer.timestampOffset=i),this.sourceBuffer.appendBuffer(e)}catch(e){return this.updateEndFn=null,22===e.code?(this.mediaElementStore.setBufferedRangesUpdated(this.type,qh.timeRangesToBufferedRange(this.sourceBuffer.buffered),qh.timeRangesToBufferedRange(this.mediaElement.buffered),!0,this.config.maxBufferHole,!0),Lr(new gp(e.message,G.AllocationFailed,this.type,this.maxTotalBytes))):(this.mediaElementStore.setInflightSegment(this.type,null),this.mediaElement.error?Lr(new vp(e.message,G.VideoDecoderBadDataErr,this.type,a)):Lr(e))}return this._waitForUpdateEndOrError().pipe(sr(()=>({fragmentType:s,startAppend:r,endAppend:performance.now(),bytesAppend:e.byteLength})),fn(1e4),Wi(e=>{throw e instanceof mn?(this.sourceBuffer.abort(),e=new yp("Append took longer than 10000ms",G.InternalError,this.type)):e instanceof pp&&(e=new vp("Decode error",e.response,this.type,a)),e}))}remove(e,t){return this._waitForUpdateEndOrError().pipe(on(this._removeAsync.bind(this,e,t)))}_removeAsync(e,t){try{this.sourceBuffer.remove(e,t)}catch(e){return Lr(new pp(V.SOURCE_BUFFER_ERROR,!1,e.message,G.SourceBufferRemoveError,this.type))}return this._waitForUpdateEndOrError()}abort(){try{this.sourceBuffer.abort()}catch(e){return Lr(new pp(V.SOURCE_BUFFER_ERROR,!1,e.message,G.SourceBufferAbortError,this.type))}return this._waitForUpdateEndOrError()}get updating(){return this.sourceBuffer.updating}get timestampOffset(){return this.sourceBuffer.timestampOffset}set timestampOffset(e){this.sourceBuffer.timestampOffset=e}get gotQuotaExceeded(){var e;return null!==(e=null===(e=this.mediaElementQuery.sourceBufferEntityByType(this.type))||void 0===e?void 0:e.gotQuotaExceeded)&&void 0!==e&&e}get bufferedSegments(){var e;return null!==(e=null===(e=this.mediaElementQuery.sourceBufferEntityByType(this.type))||void 0===e?void 0:e.bufferedSegments)&&void 0!==e?e:[]}get totalBytes(){var e;return null!==(e=null===(e=this.mediaElementQuery.sourceBufferEntityByType(this.type))||void 0===e?void 0:e.totalBytes)&&void 0!==e?e:0}get maxTotalBytes(){var e=null!==(e=null===(e=this.mediaElementQuery.sourceBufferEntityByType(this.type))||void 0===e?void 0:e.maxTotalBytes)&&void 0!==e?e:1/0;return this.gotQuotaExceeded?e:1/0}_waitForUpdateEndOrError(){return this.sourceBuffer.updating&&this.mediaElementStore.setSourceBufferUpdating(this.type),Jl(this.mediaElementQuery.sbUpdating$(this.type),e=>!1===e).pipe(sr(()=>{if(this.mediaElementQuery.sbError(this.type))throw new pp(V.SOURCE_BUFFER_ERROR,!1,"Got error during sourceBuffer operation",G.SourceBufferUpdatingError,this.type)}))}changeType(e){var t;let i=!1;if(this.config.changeType&&"function"==typeof this.sourceBuffer.changeType)try{this.sourceBuffer.changeType(e),i=!0}catch(i){null===(t=this.logger)||void 0===t||t.error(`changeType(${e}) failed: ${i.msg}`)}return i}}class bp extends oi{constructor(o,l,e,d,t,i){super(e=>{const t=rl(d),i=t.event("sourceopen").pipe(cn(e=>{z(this.initDuration)&&(this.commitMediaSourceAndMediaElementStoreDuration(this.initDuration),this.initDuration=null);e=null!==(e=null==e?void 0:e.target)&&void 0!==e?e:d;l.msReadyState=e.readyState})),r=Vn(t.event("sourceclose"),t.event("sourceended")).pipe(cn(e=>{e=(null!==(e=null==e?void 0:e.target)&&void 0!==e?e:d).readyState;l.msReadyState=e})),n=this.sourceBuffers$.pipe(on(e=>e?Vn(...e.filter(e=>null!=e)):Cr)),a=Vn(i,r,n).pipe(on(()=>Cr)).subscribe(e),s=URL.createObjectURL(d);if(u.WebKitPlaybackTargetAvailabilityEvent)try{o.removeAttribute("src"),Tp(o),o.disableRemotePlayback=!0,Ep(o,s),o.load()}catch(e){o.src=s}else o.src=s;return l.setMediaSourceEntity(s,d.readyState),()=>{a.unsubscribe(),this.initDuration=null,URL.revokeObjectURL(s),this.mediaSrc===s&&(Tp(o),o.removeAttribute("src"),o.load(),l.setMediaSourceEntity(null)),this.sourceBuffers$.next(null)}}),this.mediaElement=o,this.mediaElementStore=l,this.mediaElementQuery=e,this.mediaSource=d,this.logger=t,this.initDuration=i,this.sourceBuffers$=new qr(null)}addAirPlaySource(e){const t=this.mediaElement;!t.src&&0<t.childElementCount&&(t.disableRemotePlayback=!1,Tp(t,1),Ep(t,e,"application/vnd.apple.mpegurl"))}get mediaSrc(){var e=this.mediaElement,e=(null==e?void 0:e.firstChild)||e;return null==e?void 0:e.src}get readyState(){return this.mediaSource.readyState}set duration(e){this.mediaSource.duration=e}get duration(){return this.mediaSource.duration}commitMediaSourceAndMediaElementStoreDuration(e){try{this.duration!==e&&(this.duration=e,this.mediaElementStore.msDuration=e)}catch(e){}}endOfStream(e){this.mediaSource.endOfStream(e)}createSourceBuffers(e,s){const o=this.mediaSource;da(()=>{try{const a=[null,null];e.forEach((t,i)=>{if(t){var{mimeType:r,mediaOptionId:n}=t;let e;try{e=o.addSourceBuffer(r)}catch(t){throw new mp(t.message,G.IncompatibleAsset,i,n)}a[i]=new Ip(this.mediaElementStore,this.mediaElementQuery,this.mediaElement,this.mediaSource,i,e,t,this.logger,s)}}),this.sourceBuffers$.next(a)}catch(e){if(!(e instanceof v))throw new hp(`error initializing sourcebuffers ${e.message} readyState=${o.readyState}`);throw e}})}get needSourceBuffers(){return null==this.sourceBuffers$.value||null==this.sourceBuffers$.value[0]}get sourceBuffers(){return this.sourceBuffers$.value}getSourceBufferByType(e){var t=this.sourceBuffers$.value;return t?t[e]:null}updateLiveSeekableRange(e,t){const i=this.mediaSource;null!=i&&i.setLiveSeekableRange&&"open"===(null==i?void 0:i.readyState)&&i.setLiveSeekableRange(e,t)}clearLiveSeekableRange(){const e=this.mediaSource;null!=e&&e.clearLiveSeekableRange&&"open"===(null==e?void 0:e.readyState)&&e.clearLiveSeekableRange()}}function Tp(e,t=0){for(;e.childElementCount>t;)e.removeChild(e.children[e.childElementCount-1])}function Ep(e,t,i="video/mp4"){const r=dv.document.createElement("source");r.type=i,r.src=t,e.appendChild(r)}function Ap(e,t,i,r,n,a){var s=performance.now()-i;return{type:e,isLowBufferStall:r.len<=n||!a,tstalled:i,stallDurationMs:s,currentTime:t}}class Op extends oi{constructor(I,b,e,t,i,r,n){super(e=>{b.logger=this.logger;const l=this.config,t=b.startMediaSession(I,l.maxBufferLength,l.almostDryBufferSec,l.defaultTargetDuration),i=wp(I,b,this._mediaQuery,this,this.hlsGapless,l,this.logger,this.rtcService),r=this.mediaSource$.pipe(on(e=>e||Cr)),n=this.flushAndCallback$.pipe(_r(e=>!!e),on(({start:e,end:t,cb:i})=>this.flushAll(e,t).pipe(on(()=>Jl(this._mediaQuery.updating$,e=>!1===e)),cn(()=>i())))),a=this._mediaQuery.seekTo$.pipe((c=I,h=this._mediaQuery,m=(p=this).mediaElementStore,f=this.config,g=(g=this.logger).child({name:"seek"}),e=>e.pipe(_r(e=>e&&z(e.pos)),on(function(e){return Jl(ur([h.readyState$,h.flushing$]),([e,t])=>e>=c.HAVE_METADATA&&!1===t).pipe(sr(()=>e),on(function({pos:e,fromEvent:t,inContentGap:i}){p.checkForInconsistentStoreBufferRangesAndUpdate();var r=!t&&c.currentTime!==e;return c.paused||i||!t&&!r||p.pause(),r&&(c.currentTime=e),Jl(h.haveEnough$,e=>e).pipe(sr(()=>({pos:e,fromEvent:t})))}),on(function({pos:e,fromEvent:t}){var i=h.getCombinedBufferInfo(e,0),r=i.nextStart;if((!t||f.nudgeFromEventSeek)&&0===i.len&&z(r)&&e<r&&r-e<=f.maxSeekHole){const c=p.isPosBetweenJaggedStart(e);if(!f.jaggedSeekTolerance||!c)return p.seekTo=r,Cr}r=h.desiredRate;return c.paused&&0!==r&&p.play(),Jl(h.seeking$,e=>!e)}),on(function(){return m.setSeekToPos(null),Cr}),Wi(e=>(g.error(`error during seek ${e.message}`),m.setSeekToPos(null),Cr)))})))),s=this._mediaQuery.desiredRate$.pipe((o=I,d=this._mediaQuery,u=this,e=>e.pipe(on(e=>d.seekInProgress?Cr:0===e?(o.paused||u.pause(),Cr):d.paused$.pipe(on(e=>e?Yr(Jl(d.seekInProgress$,e=>e),Jl(d.haveEnough$,e=>e).pipe(cn(()=>{o.paused&&!o.ended&&u.play()}))):Cr))),on(()=>Cr))));var o,d,u,c,h,p,m,f,g;this.mediaFunctions=this.mediaFunctions||new cp(this,I,l,this.logger),this.mediaFunctions.install();const y=this._startMonitors$.pipe(on(e=>{return e?Vn(function(h,p){const{lowBufferThreshold:m,lowBufferWatchdogPeriod:f,highBufferWatchdogPeriod:g,seekWatchdogPeriod:y}=p,e=Qn([h.desiredRate$,h.ended$,h.combinedBuffer$,h.seekToPos$,h.inFlightRanges$]).pipe(sr(e=>{var t,[i,r,n,a,s]=e;return t=h.currentTime,e=i,i=r,r=n,n=isFinite(a),a=s,s=r.some(e=>e.start<=t&&e.end>t),a=a&&a.some(e=>e&&e.start<=t&&t<=e.end),!(!s&&a||1!==e||i||0===r.length||n&&!s)}),xr()),t=h.combinedBuffer$.pipe(sr(()=>h.getCurrentWaterLevel(0)<=p.lowBufferThreshold||!h.haveEnough?$u.LowBuffer:$u.HighBuffer),xr()),i=Qn([e,h.seekToPos$,h.gotPlaying$,t]).pipe(on(e=>{var[t,i,r]=e;if(!t)return Pr(null);var a,s,o,l,d,n,u,c,e=h.nudgeCount,t=y+1*e;return isFinite(i)||!r?(n=h,u=performance.now(),t=t,c=m,Ki(1e3*t).pipe(sr(()=>{var e=n.currentTime,t=n.getCombinedBufferInfo(e,0);if(null===n.stallInfo||n.stallInfo.type===$u.Seek)return Ap($u.Seek,e,u,t,c,n.haveEnough)}),_d())):(a=h,s=f,o=g+1*e,l=m,d=p.maxBufferHole,Vn(Pr(a.currentTime),a.timeupdate$).pipe(on(e=>{const t=performance.now(),i=a.getCombinedBufferInfo(e,0);let r,n;return r=i.len<=l||!a.haveEnough?i.nextStart&&i.nextStart<=i.end+d?(n=o,$u.BufferHole):(n=s,$u.LowBuffer):(n=o,$u.HighBuffer),Ki(Math.max(100,1e3*n)).pipe(sr(()=>e<a.currentTime?null:Ap(r,e,t,i,l,a.haveEnough)))})))}),tn()),r=i.pipe(_d(),on(e=>Qn([h.seeking$,h.paused$])),on(([e,t])=>e||t?Cr:h.timeupdate$.pipe(Vr(),_r(([e,t])=>z(e)&&z(t)&&e<t),kr(1))),sr(()=>null));return Vn(i,r)}((this.logger,this._mediaQuery),this.config).pipe(cn(e=>{b.setStallInfo(e)})),this.mediaQuery.stallInfo$.pipe((i=b,r=(t=this).config,n=this.logger,e=>e.pipe(Nr(e=>e?function(i,e,r,n){const a=i.mediaQuery;return Vn(Qn([a.seekTo$,a.nudgeTarget$]).pipe(_r(([e,t])=>e&&z(e.pos)&&z(t)&&(e.pos<t||e.pos-t>r.maxSeekHole)),Mr(null)),a.stallInfo$).pipe(yn(a.desiredRate$),tr(Li),sr(([c,e],t)=>{if(!c)return NaN;var h=a.getCombinedBufferInfo(c.currentTime,0),e=ep(e);return function(e,t,i,r,n){var{type:a,isLowBufferStall:s,currentTime:o}=c,l=h.len,d=t.maxSeekHole;let u=NaN;if(s){const i=h.nextStart-o<=d?h.nextStart:1/0;if(z(i))u=i;else if(e.mediaQuery.msDuration-o<t.nudgeOffset)u=o+t.nudgeOffset;else if(0<e.mediaQuery.getContentGapRanges().length){const t=e.mediaQuery.getContentGapRanges();for(let e=0;e<t.length;e++)if(!(t[e].start<o)&&t[e].start-o<=d){u=t[e].start;break}}}else if(n<t.nudgeMaxRetry)u=o+t.nudgeOffset;else{if(!r)throw i.error(`still stuck in high buffer @${o} after ${t.nudgeMaxRetry}, raise fatal error`),new Sp(V.BUFFER_STALLED_ERROR,!0,"got fatal buffer error",G.VideoDecoderBadDataErr,a,l);i.error(`still stuck in high buffer @${o} after ${t.nudgeMaxRetry}, non fatal in iframeMode`)}return z(u)&&e.nudgeSeek(u,n+1),u}(i,r,n,e,t)}),un(e=>z(e)),Br(()=>{e.setNudgeInfo(null)}))}(t,i,r,n):Pr(NaN))))),(a=this.mediaQuery,s=b,o=l.maxBufferHole,Jl(a.readyState$,e=>e>=HTMLMediaElement.HAVE_METADATA).pipe(on(()=>a.bufferMonitorThresholds$),on(e=>z(null==e?void 0:e.lowWaterLevelSeconds)&&z(null==e?void 0:e.highWaterLevelSeconds)?lp(a,o):Cr),xr(Hh),cn(({combined:e,sbTuple:t})=>{s.updateWaterLevels(e,t)})))):Cr;var t,i,r,n,a,s,o})),v=l["contentGapPlaythroughIntervalSeconds"],S=1e3*v;Vn(i,r,a,s,y,n,this.mediaQuery.hasGaps$().pipe(on(e=>e?ur([this.mediaQuery.timeupdate$,this.mediaQuery.desiredRate$]).pipe(tr(Li),on(([e,t])=>e===this.mediaQuery.avoidContentGap(e,this.config.timeAccuracyThresholdSeconds,this.logger)?Cr:0===t?(this.mediaFunctions.pause(!0),Cr):(I.paused&&this.play(),Zr(S).pipe(sr(()=>{var e=this.mediaQuery.currentTime+v,t=e>this.msDuration;return this.seekWithOptions(e,void 0,!1,!1,!0),t&&this.pause(),t}),un(e=>!e))))):Cr))).pipe(on(()=>Cr),Br(()=>{this.toggleTrickPlaybackMode(!1),b.remove(t),this.mediaFunctions.uninstall(),this.mediaFunctions=void 0,b.logger=void 0})).subscribe(e)}),this.mediaElement=I,this.mediaElementStore=b,this.config=e,this.hlsGapless=t,this.logger=i,this.teardownWG$=r,this.rtcService=n,this.flushAndCallback$=new Er,this.mediaSource$=new qr(null),this._startMonitors$=new qr(!0),this.mediaKeysMutex=new rp,this._mediaQuery=new dp(I,b,this.logger),this.logger=i.child({name:"mse"}),this.createId3Track(I),this.mediaFunctions=new cp(this,I,e,this.logger)}get mediaSourceAdapter(){return this.mediaSource$.value}get sourceBuffers(){var e;return null!==(e=null===(e=this.mediaSourceAdapter)||void 0===e?void 0:e.sourceBuffers)&&void 0!==e?e:[]}get needSourceBuffers(){return!this.sourceBuffers[0]}get mediaQuery(){return this._mediaQuery}sourceBuffersBufferedRangeByType(e){var t,e=null===(t=null===(t=this.mediaSourceAdapter)||void 0===t?void 0:t.sourceBuffers)||void 0===t?void 0:t[e];return e?qh.timeRangesToBufferedRange(e.sourceBuffer.buffered):null}createId3Track(e){this.id3Track=e.addTextTrack("metadata","id3"),this.id3Track.mode="hidden"}checkForInconsistentStoreBufferRangesAndUpdate(){var e=qh.timeRangesToBufferedRange(this.mediaElement.buffered),t=this.sourceBuffersBufferedRangeByType(Xs.Variant),i=this.sourceBuffersBufferedRangeByType(Xs.AltAudio),r=null!==(n=null===(r=this.mediaQuery.sourceBufferEntityByType(Xs.Variant))||void 0===r?void 0:r.bufferedRanges)&&void 0!==n?n:null,n=null!==(n=null===(n=this.mediaQuery.sourceBufferEntityByType(Xs.AltAudio))||void 0===n?void 0:n.bufferedRanges)&&void 0!==n?n:null;this.shouldUpdateStoreValues(t,r)&&this.updateMediaElementStoreBufferedRanges(e,Xs.Variant),this.shouldUpdateStoreValues(i,n)&&this.updateMediaElementStoreBufferedRanges(e,Xs.AltAudio)}updateInFlightRange(e,t){this.mediaElementStore.updateInFlightRange(Do(e),t)}shouldUpdateStoreValues(e,i){return!(null==e&&null==i||(null==e?void 0:e.length)==(null==i?void 0:i.length)&&!e.find(t=>{var e=hl.search(i,e=>t.start>=e.start&&t.end<=e.end?0:t.end<e.start?-1:1);return null==e||e.start!=t.start||e.end!=t.end||void 0}))}updateMediaElementStoreBufferedRanges(e,t){var i=this.sourceBuffersBufferedRangeByType(t);i&&!this.mediaQuery.sbUpdating(t)&&this.mediaElementStore.setBufferedRangesUpdated(t,i,e,!1,this.config.maxBufferHole,!1)}destroyMediaSource(){this.mediaSource$.next(null)}reset(){this.stopMonitors(),this.textTracksCreated=!1,this.primaryContentDuration=0,this.clearLiveSeekableRange()}makeMediaSource(){return new MediaSource}openMediaSource(t,i){da(()=>{var e;t?(e=new bp(this.mediaElement,this.mediaElementStore,this.mediaQuery,t,this.logger,i),this.mediaSource$.next(e)):this.mediaSource$.next(null)})}createSourceBuffers(e){const t=this.mediaSourceAdapter;if(!t)throw new Error("createSourceBuffers empty mediaSource");t.createSourceBuffers(e,this.config)}_waitForMediaSourceOpen(i){const r=this.mediaQuery.mediaSourceEntity.objectUrl;return ur([this.mediaQuery.msReadyState$,this.mediaQuery.msObjectUrl$]).pipe(on(([e,t])=>t!==r?Pr(null):"open"===e||"ended"===e?Pr(i):Cr))}get appendOrder(){return this.mediaQuery.isIframeRate?[Xs.Variant,Xs.AltAudio]:[Xs.AltAudio,Xs.Variant]}clearFlush(e){e.forEach(e=>{null!=e&&e.dataSeg&&(e.dataSeg.flushBeforeAppend={start:0,end:0})})}getSwitchPosition(e){return e.reduce((e,t)=>{t=t?t.dataSeg.switchPosition:void 0;return z(t)?z(e)?Math.min(e,t):t:e},void 0)}checkForReplay(){var e=this.mediaElement;e.paused&&!e.seeking&&e.duration&&e.currentTime&&e.currentTime>=e.duration-this.config.maxTotalDurationTolerance&&(this.seekTo=0)}isCompatibleWithSourceBuffers(e){return Rp(e,this.mediaElementStore,this.mediaSourceAdapter,this.mediaQuery.sourceBufferEntities,this.mediaQuery.expectedSbCount,this.config.changeType?Object.assign(Object.assign({},this.config),{changeType:!1}):this.config)}resetMediaSourceIfNeeded(i){const{mediaQuery:r,mediaElementStore:e}=this,t=r["sourceBufferEntities"],n=r.getActive()["expectedSbCount"];if(!t||this.needSourceBuffers)return this._waitForMediaSourceOpen(i);const a=Rp(i,e,this.mediaSourceAdapter,t,n,this.config);if(a.compatible)return this._waitForMediaSourceOpen(i);let s=a.boundary;const o=a.allowance,l=this.getSwitchPosition(i);if(z(l)&&(s=l),!z(s))return Pr(null);const d=r.getCombinedBufferInfo(r.currentTime,this.config.maxBufferHole);let u;return u=ep(this.mediaQuery.desiredRate)?Ki(1e3*(d.end-r.currentTime)):Yr(Jl(Vn(Pr(r.currentTime),r.timeupdate$),e=>0===d.len||s-e<=.001),Jl(r.stallInfo$.pipe(sr(e=>{return null!==(e=null==e?void 0:e.currentTime)&&void 0!==e?e:NaN})),e=>e>=s-o-this.config.discontinuitySeekTolerance)),this.mediaElementStore.waitingForDisco=!0,u.pipe(sr(()=>s),on(e=>{performance.now();var t=r.currentTime;return this.resetMediaSource(Math.max(t,e),a.discoSeqNum,this.msDuration),this._waitForMediaSourceOpen(i).pipe(cn(()=>{var e,t,i,r,n;performance.now(),this.liveSeekableRange&&({start:e,end:t,edge:i,boundary:r,tupdate:n}=this.liveSeekableRange,this.updateLiveSeekableRange(e,t,i,r,n))}))}),Br(()=>{this.mediaElementStore.waitingForDisco=!1}))}resetMediaSource(e=NaN,t,i){var r;z(e)||(e=null!==(r=null===(r=this.mediaQuery.seekTo)||void 0===r?void 0:r.pos)&&void 0!==r?r:this.mediaQuery.currentTime),z(t)||(t=null===(r=this.mediaQuery.seekTo)||void 0===r?void 0:r.discoSeqNum),0<this.sourceBuffers.length&&(this.openMediaSource(this.makeMediaSource(),i),this.seekWithOptions(e,t,!1,!1))}setExpectedSbCount(e){this.mediaElementStore.expectedSbCount=e}get expectedSbCount(){return this.mediaQuery.expectedSbCount}_sbAppendInitSegment(e,t,i){const r=this["mediaQuery"],n=null===(o=this.sourceBuffers)||void 0===o?void 0:o[e],a=null===(s=r.sourceBufferEntities)||void 0===s?void 0:s[e];if(null==t||!t.initSeg)return Xl;if(!n||!a)throw Error(`_appendInitSegment ${Xs[e]} not initialized buffer=${n} entity=${a}`);var s,o=t["initSeg"],s=a.initSegmentInfo;if((t=Yh(o))&&s&&t.itemId===s.itemId&&t.mediaOptionId===s.mediaOptionId&&t.discoSeqNum===s.discoSeqNum&&t.keyId===s.keyId)return Xl;e=_o(e);return n.appendBuffer(o.data,o).pipe(i(n,e,o.mediaOptionId,this.config,this.mediaQuery))}_sbAppendData(e,t,i){const r=this["mediaQuery"],n=null===(d=this.sourceBuffers)||void 0===d?void 0:d[e],a=null===(d=r.sourceBufferEntities)||void 0===d?void 0:d[e];if(null==t||!t.dataSeg)return Xl;if(!n||!a)throw Error(`_sbAppendData ${Xs[e]} not initialized buffer=${n} entity=${a}`);const s=a.initSegmentInfo,{dataSeg:o,offsetTimestamp:l}=t;if(!s)throw new Error(`appendDataSegments: sb[${xo[e]}] null currentInitSegmentInfo`);if(!a)throw new Error(`appendDataSegments: sb[${xo[e]}] null currentSbEntity`);if(!n)throw new Error(`appendDataSegments: sb[${xo[e]}] null source buffer`);var d=E(o.startPts);let u=-1*E(l);n.updateMp3Timestamps&&.1<Math.abs(n.timestampOffset-d)&&(u=d+u);const c=n.timestampOffset!==u,h=d+u,p=E(o.endPts)+u,m=o.firstKeyframePts?E(o.firstKeyframePts)+u:void 0,{part:f=!1,partIndex:g=NaN}=o,y={startPTS:h,endPTS:p,firstKeyframePts:m,bytes:o.data2?o.data1.byteLength+o.data2.byteLength:o.data1.byteLength,partialFrag:o.partialFrag,frag:{itemId:o.itemId,mediaOptionId:o.mediaOptionId,mediaOptionType:o.mediaOptionType,mediaSeqNum:o.mediaSeqNum,discoSeqNum:o.discoSeqNum,keyTagInfo:o.keyTagInfo,isLastFragment:o.isLastFragment,iframe:o.iframe,framesWithoutIDR:o.framesWithoutIDR,dropped:o.dropped,part:f,partIndex:g}},v=_o(e);let S=Yl;t=t.dataSeg.flushBeforeAppend;t&&t.start!==t.end&&(S=this.flushData(e,t.start,t.end));t={fragmentType:Ys.Variant,bytesAppend:0,startAppend:1/0,endAppend:-1/0};return S.pipe(on(()=>Pr(o.data1,o.data2).pipe(_d()).pipe(Sr(e=>n.appendBuffer(e,y,u).pipe(i(n,v,o.mediaOptionId,this.config,this.mediaQuery))))),fr((e,t)=>(e.bytesAppend+=t.bytesAppend,e.startAppend=Math.min(t.startAppend,e.startAppend),e.endAppend=Math.max(t.endAppend,e.endAppend),e),t),cn(()=>{r.getBufferedRangeByType(e),c&&this.mediaElementStore.setTimestampOffset(e,n.timestampOffset)}))}appendDataSegments(t,i){var e=this.appendOrder.map(e=>{if(null==t[e])return null;const r={sbType:e,initAppend:null,dataAppend:null};return Rr(Pn(()=>this._sbAppendInitSegment(e,t[e],i)),Pn(()=>this._sbAppendData(e,t[e],i))).pipe(fr((e,t,i)=>(0===i?r.initAppend=t:r.dataAppend=t,e),r))}).filter(e=>Boolean(e));return 0===e.length?Pr([]):Ln(e)}adjustJaggedStart(e){if(!e.every(e=>null==(null==e?void 0:e.dataSeg))){const{mediaQuery:t,logger:i}=this,{sourceBufferEntities:n,currentTime:r,seekTo:a}=t,s=e.reduce((e,t)=>{var{start:i,end:e}=e;return{start:null!=t&&t.dataSeg.startPts?Math.min(w(t.dataSeg.startPts,t.offsetTimestamp),i):i,end:null!=t&&t.dataSeg.endPts?Math.min(w(t.dataSeg.endPts,t.offsetTimestamp),e):e}},{start:Number.POSITIVE_INFINITY,end:Number.POSITIVE_INFINITY});if(!n)throw new Error("appendSourceBufferData null currentSbEntity");const o=(null==a?void 0:a.pos)||r;if(t.avoidContentGap(o,0,i)===o){e=z(this.config.jaggedSeekTolerance)?this.config.jaggedSeekTolerance:0;let r=NaN;n.forEach((e,t)=>{if(e){e=qh.getBufferedInfo(e.bufferedRanges,o,0);if(0===e.len){const i=e["nextStart"];z(i)&&(!z(r)||i>r)&&(r=i)}}}),z(r)&&s.end>r&&r-o>e&&(z(s.start)&&o+this.config.maxSeekHole<s.start||(this.seekTo=r))}}}addCues(e,t){const i=this.mediaElement.textTracks[e];i&&t.forEach(e=>{i.addCue(e)})}_flushInternal(e,t,i){return Pn(()=>0===e.buffered.length?Yl:e.remove(t,i)).pipe()}flushAll(i,r,n=!1){return 0===this.sourceBuffers.length?Yl:Ln(this.sourceBuffers.map((e,t)=>e?this.flushData(t,i,r,n):Yl)).pipe(Mr(void 0))}flushAndCallback(e,t,i){this.flushAndCallback$.next({start:e,end:t,cb:i})}flushData(t,o,l,d=!1){var e=this["mediaQuery"];return Jl(e.updating$,e=>!1===e).pipe(on(()=>{const r=this.sourceBuffers[t];if(!r)return Yl;let n,a,s=Yl;var e=-1===navigator.userAgent.toLowerCase().indexOf("firefox");if(this.flushing=!0,e)return this._flushInternal(r,o,l);for(let i=0;i<r.buffered.length;i++){let e,t;n=r.buffered.start(i),a=r.buffered.end(i),t=l===1/0?(e=o,l):(e=Math.max(n,o),Math.min(a,l)),Math.min(t,a)>e&&(d||.5<Math.min(t,a)-e)&&(s=s.pipe(on(()=>this._flushInternal(r,e,t))))}return s}),Br(()=>{this.flushing=!1}))}static convertInitSegToCompatInfo(e){return{mimeType:e.mimeType,audioCodec:e.initParsedData.audioCodec,videoCodec:e.initParsedData.videoCodec,startPTSSec:void 0,endPTSSec:void 0,discoSeqNum:e.discoSeqNum,mediaOptionId:e.mediaOptionId}}static combineAppendDataInfoWithCompatInfo(e,t,i,r,n=0){const a=[...t];e.forEach((e,t)=>{null!=e&&e.initSeg&&(a[t]=Op.convertInitSegToCompatInfo(e.initSeg)),1===r&&(a[1]=null)});e=null===(t=a[Xs.Variant])||void 0===t?void 0:t.videoCodec,t=nh(e);if(i&&i.has(t)){const s=i.get(t);a[Xs.Variant].mimeType=a[Xs.Variant].mimeType.replace(e,s),a[Xs.Variant].videoCodec=s}return a}static maxDurationFromAppendDataTuple(e){return e.reduce((e,t)=>t&&z(t.duration)?Math.max(t.duration,e):e,0)}convertSourceBufferEntitiesToCompatInfo(e){const t=e.sourceBufferEntities,i=[null,null];return null==t||t.forEach((e,t)=>{e&&(i[t]={mimeType:e.mimeType,audioCodec:e.audioCodec,videoCodec:e.videoCodec,startPTSSec:void 0,endPTSSec:void 0,discoSeqNum:void 0,mediaOptionId:null===(e=e.initSegmentInfo)||void 0===e?void 0:e.mediaOptionId})}),i}avAppend(i,e,r,n){const{mediaQuery:t,logger:a}=this,s=t.expectedSbCount,d=this.convertSourceBufferEntitiesToCompatInfo(t);if(e.every(e=>null==e))return Pr([null,null]);const o=this.resetMediaSourceIfNeeded(e).pipe(kr(1),on(e=>e?t.updating$.pipe(_r(e=>!1===e),kr(1),Mr(e)):Pr(null)));return(null===i?o:Jl(t.updating$,e=>!1===e).pipe(Mr(e))).pipe(on(t=>{if(!t)return Pr([null,null]);let o=NaN,l=NaN;if(this.needSourceBuffers){o=performance.now();const i=Op.combineAppendDataInfoWithCompatInfo(t,d,n,s,a);this.createSourceBuffers(i),l=performance.now(),this.clearFlush(t)}var e=Op.maxDurationFromAppendDataTuple(t);return(!z(this.msDuration)||this.msDuration<e)&&(this.msDuration=e),t.forEach(e=>{e=null==e?void 0:e.dataSeg;null!=e&&e.cues&&z(null==e?void 0:e.texttrackIdx)&&this.addCues(e.texttrackIdx,e.cues)}),this.appendDataSegments(t,r).pipe(sr(e=>{var t;const i=[null,null];for(const r of e){const{sbType:e,initAppend:n,dataAppend:a}=r,s={fragmentType:_o(e),bufferCreationStart:o,bufferCreationEnd:l,startInitAppend:null!==(t=null==n?void 0:n.startAppend)&&void 0!==t?t:NaN,endInitAppend:null!==(t=null==n?void 0:n.endAppend)&&void 0!==t?t:NaN,initBytesAppend:null!==(t=null==n?void 0:n.bytesAppend)&&void 0!==t?t:NaN,startDataAppend:null!==(t=null==a?void 0:a.startAppend)&&void 0!==t?t:NaN,endDataAppend:null!==(t=null==a?void 0:a.endAppend)&&void 0!==t?t:NaN,dataBytesAppend:null!==(t=null==a?void 0:a.bytesAppend)&&void 0!==t?t:NaN};i[e]=s}return i}),cn(e=>{null===i&&this.adjustJaggedStart(t)}))}),kr(1))}endStream(){try{this.mediaSourceAdapter.endOfStream()}catch(e){}}setMediaKeys(e){return this.teardownWG$.wrap(this.mediaKeysMutex.lock(()=>ar(this.mediaElement.setMediaKeys(e))).pipe(Jr(e=>e.pipe(on((e,t)=>{if(t<3)return Ki(100*t);throw e})))))}clearMediaKeys(){return Pn(()=>{if(!this.mediaElement)return Yl;const e=this.mediaQuery,t=e.getCombinedBufferInfo(e.currentTime,0);return(null!=t&&t.len?Jl(e.combinedBuffer$,e=>!e).pipe(sr(()=>null)):Yl).pipe(on(()=>{const e=-1<navigator.userAgent.toLowerCase().indexOf("chrome");let t=this.setMediaKeys(null);if(e){const e=this.mediaElement.src;this.mediaElement.src="",t=t.pipe(cn(()=>this.mediaElement.src=e))}return t}))})}set seekTo(e){this.seekWithOptions(e,void 0,!1)}seekWithOptions(e,t,i,r=!1,n){var a=this.liveSeekableRange,s=this.mediaElement.currentTime,o=z(this.mediaElement.duration)?this.mediaElement.duration:1/0;let l=0,d=o;if(i&&a){const{start:t,edge:i,end:n,tupdate:u}=a,c=(performance.now()-u)/1e3;if(l=Math.min(o,n,t+c),d=Math.min(o,n,i+c),!r&&e>=d&&s>=d)return!1}const u=Math.max(l,Math.min(d,e));return this.mediaElementStore.setSeekToPos(u,!1,t,n,s),!0}updateContentGapRanges(e,r){var n=.25,a=null===(a=this.mediaQuery)||void 0===a?void 0:a.getContentGapRanges();if(a){let t=[...a];t.sort((e,t)=>t.start-e.start);let i=!0;for(let e=0;e<t.length;e++){const s=t[e];if(r.start>s.start-n&&r.start<s.start+n&&r.end>s.end-n&&r.end<s.end+n)return void(i=!1)}i&&(t.push(r),t.sort()),1<t.length&&(t=qh.getBufferedTimeRanges(t,n)),this.mediaElementStore.updateContentGapRanges(t)}}nudgeSeek(e,t){da(()=>{this.mediaElementStore.setSeekToPos(e),this.mediaElementStore.setNudgeInfo({nudgeTarget:e,nudgeCount:t})})}set desiredRate(e){this.mediaElementStore.desiredRate=e}toggleTrickPlaybackMode(e){if(this.config.overridePlaybackRate){const t=e?2:1;try{this.mediaElement.playbackRate=t}catch(e){this.logger.error({name:"iframes"},`Exception when setting playbackRate=${t}: ${e.message}`)}}const t=this.muteValueOnTrickPlaybackToggle;e&&void 0===t?(this.muteValueOnTrickPlaybackToggle=this.mediaElement.muted,this.mediaElement.muted=e):e||void 0===t||(this.mediaElement.muted=t,this.muteValueOnTrickPlaybackToggle=void 0)}play(){this.mediaFunctions.play()}pause(){this.mediaFunctions.pause()}get expectPlayEvent(){return this.mediaFunctions.expectPlayEvent}set expectPlayEvent(e){this.mediaFunctions.expectPlayEvent=e}get expectPauseEvent(){return this.mediaFunctions.expectPauseEvent}set expectPauseEvent(e){this.mediaFunctions.expectPauseEvent=e}get expectSeekingEvent(){return this.mediaQuery.expectSeekingEvent}set textTracksCreated(e){const t=this["mediaElementStore"];t.textTracksCreated=e}get msDuration(){return this._mediaQuery.msDuration}set msDuration(e){this.mediaSourceAdapter.commitMediaSourceAndMediaElementStoreDuration(e)}set primaryContentDuration(e){this.mediaElementStore.primaryContentMediaElementDuration=e}set haveEnough(e){this.mediaElementStore.haveEnough=e}set flushing(e){this.mediaElementStore.flushing=e}stopMonitors(){this._startMonitors$.value&&this._startMonitors$.next(!1)}startMonitors(){this._startMonitors$.value||this._startMonitors$.next(!0)}set bufferMonitorTargetDuration(e){this.mediaElementStore.bufferMonitorTargetDuration=e}get textTracks(){return this.mediaElement.textTracks}get id3TextTrack(){return this.id3Track}addTextTrack(e,t,i){return this.mediaElement.addTextTrack(e,t,i)}dispatchEvent(e){return this.mediaElement.dispatchEvent(e)}get offsetWidth(){return this.mediaElement.offsetWidth}get offsetHeight(){return this.mediaElement.offsetHeight}get liveSeekableRange(){return this.mediaQuery.liveSeekableRange}get seekable(){return this.mediaQuery.seekable}archiveParsedSubtitleFragmentRecord(e,t,i){return this.mediaElementStore.archiveParsedSubtitleFragmentRecord(e,t,i)}removeEarlierParsedSubtitleFragmentRecord(e){this.mediaElementStore.removeOldSubtitleFragmentRecord(e)}removeLaterParsedSubtitleFragmentRecord(e){this.mediaElementStore.removeLaterSubtitleFragmentRecord(e)}clearParsedSubtitleRecordsForMediaOption(e){return this.mediaElementStore.clearParsedSubtitleFragmentRecord(e)}clearAllParsedSubtitleFragmentRecord(){return this.mediaElementStore.clearAllParsedSubtitleFragmentRecord()}updateLiveSeekableRange(e,t,i,r,n){var a;const s=this.mediaQuery.liveSeekableRange,o=Math.max(null!==(a=null==s?void 0:s.start)&&void 0!==a?a:0,e),l=Math.max(null!==(e=null==s?void 0:s.end)&&void 0!==e?e:0,t),d=Math.max(null!==(t=null==s?void 0:s.edge)&&void 0!==t?t:0,i),u=Math.max(null!==(i=null==s?void 0:s.boundary)&&void 0!==i?i:0,r);da(()=>{this.mediaElementStore.setLiveSeekableRange({start:o,end:l,edge:d,boundary:u,tupdate:n}),this.mediaSourceAdapter.updateLiveSeekableRange(o,l)})}clearLiveSeekableRange(){null!=this.liveSeekableRange&&da(()=>{this.mediaElementStore.setLiveSeekableRange(void 0),this.mediaSourceAdapter.clearLiveSeekableRange()})}isPosBetweenJaggedStart(e){if(this.config.jaggedSeekTolerance&&this.sourceBuffers[Xs.Variant]&&this.sourceBuffers[Xs.AltAudio]){const i=this.mediaQuery.getBufferInfo(e,this.config.jaggedSeekTolerance),t=[Xs.Variant,Xs.AltAudio].reduce((e,t)=>{if(i[t].buffered.len){t=i[t].buffered.start;return e?[Math.min(t,e[0]),Math.max(t,e[1])]:null}return null},[Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY]);if(t&&t[1]-e<=this.config.jaggedSeekTolerance)return!0}return!1}addAirPlaySource(e){this.mediaSourceAdapter.addAirPlaySource(e)}}const wp=(t,r,n,a,s,o,l,d)=>{if(!t)return Cr;const e=rl(t),u=e=>{const t=e.currentTarget,i=t.readyState;r.readyState=i,r.ended=t.ended,"playing"!=e.type&&(e.type,t.currentTime.toFixed(3),t.duration.toFixed(3))};return Vn(e.event("durationchange").pipe(sr(e=>nl(t,"durationchange",e)),ca(e=>{var t=e.currentTarget;r.mediaElementDuration=t.duration,u(e)})),e.event("seeking").pipe(pn(o.seekEventThrottleMs,void 0,{leading:!0,trailing:!0}),sr(e=>nl(t,"seeking",e)),ca(e=>{var t=e.currentTarget,i=t.currentTime;if(t.readyState>=t.HAVE_METADATA){const e=n.seekTo;if(!e||1e-5<Math.abs(e.pos-i)){if(!e||!e.fromEvent){if(s.inGaplessMode&&!o.enableInterstitialPlayback)return void function(e,t,i,r){let n=!1;var a=Zh(t.playingItem);e<a&&(e=a,n=!0);a=Zh(t.loadingItem);t.isPreloading&&(a<e&&(e=a,n=!0),t.dequeueSource("SeekToUnbufferedTimeRanges")),n?i.resetMediaSource(e):r.setSeekToPos(e,!0)}(i,s,a,r);if(a&&!a.expectSeekingEvent&&(t.controls||o.nativeControlsEnabled)&&a.liveSeekableRange&&a.seekWithOptions(i,void 0,!0,!0))return}r.setSeekToPos(i,!0)}else r.seeking=!0}u(e)})),e.event("seeked").pipe(sr(e=>nl(t,"seeked",e)),ca(e=>{var t=e.target;r.seeking=t.seeking,u(e)})),e.event("play").pipe(sr(e=>nl(t,"play",e)),ca(e=>{var t=e.currentTarget;r.paused=t.paused;var i=a.expectPlayEvent,t=t.controls||o.nativeControlsEnabled;!i&&t&&(a.checkForReplay(),r.desiredRate=1),a.expectPlayEvent=!1,u(e)})),e.event("playing").pipe(sr(e=>nl(t,"playing",e)),ca(e=>{var t=e.currentTarget;r.paused=t.paused,r.gotPlayingEvent(),u(e)})),e.event("pause").pipe(sr(e=>nl(t,"pause",e)),ca(e=>{var t=e.currentTarget;r.paused=t.paused;var i=a.expectPauseEvent,t=t.controls||o.nativeControlsEnabled;!i&&t&&(r.desiredRate=0),a.expectPauseEvent=!1,u(e)})),Vn(e.event("loadedmetadata").pipe(sr(e=>nl(t,"loadedmetadata",e))),e.event("loadeddata").pipe(sr(e=>nl(t,"loadeddata",e))),e.event("canplay").pipe(sr(e=>nl(t,"canplay",e))),e.event("canplaythrough").pipe(sr(e=>nl(t,"canplaythrough",e))),e.event("waiting").pipe(sr(e=>nl(t,"waiting",e))),e.event("emptied").pipe(sr(e=>nl(t,"emptied",e))),e.event("ended").pipe(sr(e=>nl(t,"ended",e)))).pipe(ca(u)),e.event("error").pipe(on(()=>{throw t.error}))).pipe(Wi(e=>{var t,i;try{e instanceof MediaError?null==d||d.handleMediaElementError(e,null!==(i=null===(t=null==s?void 0:s.loadingItem)||void 0===t?void 0:t.isInterstitial)&&void 0!==i&&i):l.error(`media event error: ${null==e?void 0:e.message}`)}catch(e){l.error(`MediaError may be undefined on the platform: ${null==e?void 0:e.message}`)}return Cr}),on(()=>Cr))};function Rp(e,s,o,l,t,d){const i=l.filter(e=>Boolean(e)).length,r=e.filter(e=>Boolean(e)).length,u=[null,null];e.forEach((e,t)=>{var i,r,n,a,s,o;e&&(a=e["offsetTimestamp"],s=E(a),i=e.initSeg.mimeType,{audioCodec:r,videoCodec:n}=e.initSeg.initParsedData,o=e["dataSeg"],a=E(o.startPts)-s,s=E(o.endPts)-s,o=o.discoSeqNum,u[t]={audioCodec:r,videoCodec:n,mimeType:i,startPTSSec:a,endPTSSec:s,discoSeqNum:o,mediaOptionId:e.initSeg.mediaOptionId})});let c=i===t,n=r===t;if(1===r&&r<t&&0!==i){const s=e[Ys.Variant]?Ys.Variant:Ys.AltAudio,o=1-s,t=u[s],d=u[o]=function(e,t,i){const r=null==e?void 0:e.bufferedSegments;if(!r)return null;var n=r.find(e=>e.frag.discoSeqNum===t);if(null==n)return null;{const{audioCodec:a,videoCodec:r,mimeType:s}=e;return{mimeType:s,audioCodec:a,videoCodec:r,startPTSSec:n.startPTS,endPTSSec:n.endPTS,discoSeqNum:t,mediaOptionId:i}}}(l[o],t.discoSeqNum,t.mediaOptionId);if(!d&&s===Ys.Variant&&u[s]){const e=l[s].videoCodec,o=u[s].videoCodec;if(c=c&&(e===o||Re.isCompatibleVideoCodec(e,o)),c)return{compatible:c,boundary:NaN,allowance:NaN,discoSeqNum:u[s].discoSeqNum}}n=null!=d}let h=NaN,p=NaN,m=NaN;return n&&u.forEach((t,i)=>{if(!t)return null;z(m)?m!==t.discoSeqNum&&(m=NaN):m=t.discoSeqNum;var r=l[i];if(r){const l=r.audioCodec,n=r.videoCodec,a=r.mimeType,{audioCodec:h,videoCodec:p,mimeType:m}=t;let e=d.changeType;if(e){const t=null===(r=o.sourceBuffers)||void 0===r?void 0:r[i];t&&(!!l==!!h&&!!n==!!p?a!==m&&"string"==typeof m&&(e=t.changeType(m),e&&s.updateSourceBufferEntity(i,u[i])):e=!1)}e||(c=c&&(n===p||Re.isCompatibleVideoCodec(n,p)),c=c&&(l===h||Re.isCompatibleAudioCodec(l,h)))}else c=!1;h=z(h)?(p=Math.abs(t.startPTSSec-h),Math.max(t.startPTSSec,h)):(p=0,t.startPTSSec)}),{compatible:c&&n,boundary:h,allowance:p,discoSeqNum:m}}function Cp(e){return e.matches}class kp extends ya{constructor(e){super(e),this.store=e,this.displaySupportsHdr$=this.select("supportsHdr"),this.platformInfo$=this.select("platformInfo"),this.viewportInfo$=this.select("viewportInfo")}get platformInfo(){return this.getValue().platformInfo}get displaySupportsHdr(){return this.getValue().supportsHdr}get viewportInfo(){return this.getValue().viewportInfo}}class Mp extends ha{constructor(){super({supportsHdr:!0},{name:"platform"})}}class Pp{constructor(e){this.store=e,this._query=new kp(e)}get query(){return this._query}updateSupportsHdr(e){this.store.update({supportsHdr:e})}updatePlatformInfo(e){this.store.update({platformInfo:e})}updateViewportInfo(e){this.store.update({viewportInfo:e})}}function Lp(e){var t;let i=!1;var r=""!==e.identifier,n=0<e.urls.length,e=z(null===(t=e.startTime)||void 0===t?void 0:t.baseTime)||z(e.startDate);return r&&n&&e&&(i=!0),i}const xp={ID:(e,t)=>Object.assign(Object.assign({},e),{identifier:t}),"START-DATE":(e,t,i,r,n)=>{var t=new Date(Date.parse(t)).getTime(),[r,n]=s(t,null!=r?r:[],null!=n?n:[]),n=t&&null!=n?t-r+1e3*n:NaN;return Object.assign(Object.assign({},e),{startTime:{baseTime:n,timescale:1e3}})},"X-ASSET-LIST":(e,t)=>Object.assign(Object.assign({},e),{urls:[t]}),"X-ASSET-URI":(e,t)=>Object.assign(Object.assign({},e),{urls:[t]}),"X-RESUME-OFFSET":(e,t)=>Object.assign(Object.assign({},e),{resumptionOffset:{baseTime:1e3*parseFloat(t),timescale:1e3}}),"X-PLAYOUT-LIMIT":(e,t)=>Object.assign(Object.assign({},e),{playoutLimit:{baseTime:1e3*parseFloat(t),timescale:1e3}}),"X-SNAP":(e,t)=>{var i=-1<t.indexOf("IN"),t=-1<t.indexOf("OUT");let r=ml.None;return i&&t?r=ml.InOut:i?r=ml.In:t&&(r=ml.Out),Object.assign(Object.assign({},e),{snapOptions:r})},"X-RESTRICT":(e,t)=>{var i=-1<t.indexOf("SKIP"),t=-1<t.indexOf("JUMP");let r=fl.None;return i&&t?r=fl.SkipJump:i?r=fl.Skip:t&&(r=fl.Jump),Object.assign(Object.assign({},e),{referenceRestrictions:r})},CUE:Dp,"X-CUE":Dp,default:(e,t,i)=>{if(0!==(null==i?void 0:i.indexOf("X-")))return e;const r=Object.assign({},e);return r.extraAttributes[i]=t,r}};function Dp(e,t){let i=pl.Midroll;-1<t.indexOf("PRE")?i=pl.Preroll:-1<t.indexOf("POST")&&(i=pl.Postroll);let r=!1;return-1<t.indexOf("ONCE")&&(r=!0),Object.assign(Object.assign({},e),{cueType:i,playOnce:r})}function _p(i,e,t){var{daterangeTags:r,pdtToMSN:n}=i;let a=[];e=-1<e.indexOf("interstitial");return r&&!e&&t.allowServerGeneratedInterstitials&&0<n.length&&(a=Object.entries(r).reduce((e,[,t])=>{t=function(e,t,i){if(!e||"com.apple.hls.interstitial"!==e.CLASS)return null;let r={extraAttributes:{},resumptionOffset:{baseTime:NaN,timescale:1e3},identifier:"",cueType:pl.Midroll,snapOptions:ml.None,referenceRestrictions:fl.None,startTime:{baseTime:NaN,timescale:1e3},urls:[],hasPlayed:!1,playOnce:!1,assets:[]};for(const a in e){var n;Object.prototype.hasOwnProperty.call(e,a)&&(n=e[a],r=(xp[a]||xp.default)(r,n,a,t,i))}return Lp(r)?r:null}(t,i.pdtToMSN,i.fragments);return t&&e.push(t),e},[])),a}class Np extends oi{constructor(e,t){super(e=>{null==t||t.add(),e.add(this._handler$.pipe(pr(([e,t,i])=>e(...t).pipe(cn({next(e){i(e,null)},error(e){i(null,e)}})))).subscribe())}),this._vanillaRPC=e,this.teardownWG$=t,this._handler$=new Er}register(e,i){return this._vanillaRPC.register(e,(...t)=>e=>{this._handler$.next([i,t,e])})}invoke(e,t,r){return new oi(i=>{this._vanillaRPC.invoke(e,t,r)((e,t)=>{null!=t?i.error(t):(i.next(e),i.complete())})})}}class Fp extends Np{constructor(e){super(e)}decrypt(e,t,i,r,n){return this.invoke("decrypt",[e,t,i,r,n],[e,t,r])}}class Bp extends Np{constructor(e){super(e),this.rpcService=e,this.sessions={},this._onEvent=(e,t,i)=>()=>{null!=this.sessions[e]&&this.sessions[e].observer.trigger(t,i)},this.rpcService.register("demuxer.event",this._onEvent)}init(e,t,i){return[{maxSeekHole:r,maxBufferHole:n,audioPrimingDelay:a,stretchShortVideoTrack:s,forceKeyFrameOnDiscontinuity:o}]=[t],this.invoke("demuxer.init",[e,t={maxSeekHole:r,maxBufferHole:n,audioPrimingDelay:a,stretchShortVideoTrack:s,forceKeyFrameOnDiscontinuity:o},i],[]).pipe(sr(e=>{var t=new Up(this,e);return this.sessions[e]=t}));var r,n,a,s,o}}class Up{constructor(e,t){this.rpc=e,this.demuxSessionID=t,this.observer=new r}push(e,t,i,r,n,a,s,o,l,d,u,c,h){return this.rpc.invoke("demuxer.push",[this.demuxSessionID,e,t,i,r,n,a,s,o,l,d,u,c],null!=h?h:[e])}destroy(){this.observer.removeAllListeners(),this.rpc.invoke("demuxer.destroy",[this.demuxSessionID],[]).subscribe()}}class Vp{constructor(){this.handlers={}}register(e,t){return null==this.handlers[e]&&(this.handlers[e]=t,!0)}unregister(e){return null==this.handlers[e]&&(delete this.handlers[e],!0)}invoke(e,i){return(t=Vp._fallbackCallback)=>{try{if(null==this.handlers[e])throw new Error(`command ${e} not found`);this.handlers[e](...i)(t)}catch(e){t(void 0,e)}}}teardown(e){this.handlers={},e()}}Vp._fallbackCallback=(e,t)=>{if(null!=t)throw t};const $p=e=>{e=e.child({name:"InlineRPCService"});var t=new Vp;return new i(t,e),new Ye(t,e),t};let Qp;const Kp=t=>{try{if(null==Qp){const t=new Blob(["var exports = {};var module = { exports: exports };function define(f){f()};define.amd = true;("+ov.toString()+")(true);"],{type:"text/javascript"}),r=URL.createObjectURL(t);Qp=new Worker(r)}var e=new Xe(Qp);return i=e,a=t.child({name:"WorkerRPCService"}),i.register("logger.log",(i,r,...n)=>t=>{try{let e=a;for(const a of i)e=e.child(a);"function"==typeof e[r]&&e[r](...n),t()}catch(e){t(void 0,e)}}),e}catch(e){throw t.error("Failed to create WebWorker.",e),e}var i,a},qp=(...r)=>t=>{for(let e=0;e<r.length;e++){const i=r[e];try{return i(t)}catch(t){if(e===r.length-1)throw t}}throw new Error("Missing fallbacks")},Hp=e=>qp(Kp,$p)(e);class jp{constructor(e,t,i){this.hls=e,this.sessionID=t,this.logger=i,this.rtcQuery=null,this.accessLogData=this.createAccessLogEntry(),this.accesslog=[],this.errorlog=[]}reset(){this.rtcQuery=null,this.accesslog=[],this.errorlog=[],this.accessLogData=this.createAccessLogEntry()}destroy(){this.reset()}setRTCQuery(e){this.rtcQuery=e}setupReporter(e){this.accessLogReporter={SessionID:this.sessionID,ClientName:null==e?void 0:e.clientName,ServiceName:null==e?void 0:e.serviceName}}addPlayTime(e){var t=null===(t=this.rtcQuery)||void 0===t?void 0:t.entity(e);t&&(e=t.sessionControlRecord,t=performance.now()-e.eventStartTime,"RTC_STATE_PLAY"===e.state&&(this.accessLogData.PlayTimeWC=(this.accessLogData.PlayTimeWC||0)+t))}updatePlaybackInfo(e,t){var i;null!==e&&(this.accessLogData.ViFrDr=(null===(e=null===(i=this.rtcQuery)||void 0===i?void 0:i.entity(e))||void 0===e?void 0:e.sessionControlRecord.droppedVideoFrames)||0)}updateStallCount(e){var t;"RTC_STATE_PLAY"===(null===(e=null===(e=null===(t=this.rtcQuery)||void 0===t?void 0:t.entity(e))||void 0===e?void 0:e.sessionControlRecord)||void 0===e?void 0:e.state)&&this.accessLogData.StallCount++}updateMediaEngineStallCount(e){var t;"RTC_STATE_PLAY"===(null===(e=null===(e=null===(t=this.rtcQuery)||void 0===t?void 0:t.entity(e))||void 0===e?void 0:e.sessionControlRecord)||void 0===e?void 0:e.state)&&this.accessLogData.MediaEngineStallCount++}updateCanPlay(e){var t;this.accessLogData.StartupTime=null!==(e=null===(e=null===(t=this.rtcQuery)||void 0===t?void 0:t.entity(e))||void 0===e?void 0:e.sessionControlRecord.eventStartTime)&&void 0!==e?e:0}updateFragLoaded(e,t,i){var r;i.fragType===Ys.Variant?(this.accessLogData.NetBytes+=i.bytes,this.accessLogData.ADT+=i.adt,r=this.aggregateFragObserverdBitrate(i,++this.accessLogData.fragmentCnt,this.accessLogData.NetBytes,this.accessLogData.ADT),this.accessLogData.OBRLast=r.obrLast,this.accessLogData.OBRMean=r.obrMean,this.aggregateFragMinMaxBitrate(this.accessLogData,r.obr),z(r=null!==(r=this.hls.realCurrentTime)&&void 0!==r?r:NaN)&&r>i.startPTS&&!t&&this.accessLogData.overdue++,this.hasGap(i.startPTS,i.endPTS,this.accessLogData.lastStartPTS,this.accessLogData.lastEndPTS)&&this.addToAccessLog(e),this.accessLogData.startPTS||(this.accessLogData.startPTS=i.startPTS),this.accessLogData.lastStartPTS=i.startPTS,this.accessLogData.lastEndPTS=i.endPTS,this.accessLogData.videoBytes+=i.bytes,this.accessLogData.videoDuration+=i.duration):i.fragType===Ys.AltAudio&&(this.accessLogData.audioBytes+=i.bytes,this.accessLogData.audioDuration+=i.duration)}addToAccessLog(e){var t=this.getVariantInfo(e),i=null===(r=null===(i=this.rtcQuery)||void 0===i?void 0:i.entity(e))||void 0===r?void 0:r.sessionControlRecord.curLevelUrl,r=null===(r=null===(r=this.rtcQuery)||void 0===r?void 0:r.entity(e))||void 0===r?void 0:r.playEndedRecord.PlayType;if(i&&""!==i){var r=this.translateToAccessLogItem(e,i,t,r);if(r){const n=this.accesslog.length-20;0<n&&this.accesslog.splice(0,n),this.accesslog.push(r)}this.accessLogData=this.createAccessLogEntry();e=null===(e=null===(r=this.rtcQuery)||void 0===r?void 0:r.entity(e))||void 0===e?void 0:e.switchCompleteRecord.MediaDur;this.accessLogData.lastMediaDur=e||this.hls.bufferedDuration}}addToErrorLog(e,t){var i=null===(r=this.rtcQuery)||void 0===r?void 0:r.entity(e);if(i){var r=Number(("mediaError"===t?i.playErrorRecord:i.nwErrorRecord).ErrCode),i=i.sessionControlRecord.curLevelUrl,r=this.translateToErrorLogItem(e,i,{domain:t,code:r});if(r){const e=this.errorlog.length-20;0<e&&this.errorlog.splice(0,e),this.errorlog.push(r)}}}getAccessLog(e){var t;const i=this.accesslog.slice(0),r=null===(t=this.rtcQuery)||void 0===t?void 0:t.entity(e);if(i&&r){const n=r.sessionControlRecord.curLevelUrl;if(n&&""!==n){const r=this.getVariantInfo(e),a=this.translateToAccessLogItem(e,n,r,null===(e=null===(t=this.rtcQuery)||void 0===t?void 0:t.entity(e))||void 0===e?void 0:e.playEndedRecord.PlayType);a&&(a["c-provisional-entry"]=!0,i.push(a))}}return i}get errorLog(){return this.errorlog}createAccessLogEntry(){return{fragmentCnt:0,overdue:0,startPTS:0,obrMax:0,obrMin:0,audioBytes:0,audioDuration:0,videoBytes:0,videoDuration:0,svrAddrChanged:0,svrAddr:"",PlayTimeWC:0,ViFrDr:0,StallCount:0,MediaEngineStallCount:0,ADT:0,NetBytes:0,StartupTime:0,OBRMean:0,OBRLast:0}}convertStringObjectToPrimitive(e){return e?"object"==typeof e?e.toString():e:""}updateSvrAddrStats(t){const i=no.parseURL(t);if(i&&i.netLoc){const t=i.netLoc.indexOf(":");let e=0<=t?i.netLoc.slice(0,t):i.netLoc;e.startsWith("//")&&(e=e.slice(2)),this.accessLogData.svrAddr?e!==this.accessLogData.svrAddr&&this.accessLogData.svrAddrChanged++:this.accessLogData.svrAddrChanged=0,this.accessLogData.svrAddr=e}}translateToAccessLogItem(e,t,i,r){var n=this.convertStringObjectToPrimitive(t);this.updateSvrAddrStats(n);let a=null===(e=null===(t=this.rtcQuery)||void 0===t?void 0:t.entity(e))||void 0===e?void 0:e.switchCompleteRecord.MediaDur;a=a||this.hls.bufferedDuration,a=a||0;const s={uri:n,"s-ip":this.accessLogData.svrAddr,"s-ip-changes":this.accessLogData.svrAddrChanged,"sc-wwan-count":-1,"c-transfer-duration":this.accessLogData.ADT,bytes:this.accessLogData.NetBytes,"c-total-media-requests":this.accessLogData.fragmentCnt,"cs-guid":this.accessLogReporter?null===(n=this.accessLogReporter)||void 0===n?void 0:n.SessionID:"undefined","c-start-time":this.accessLogData.startPTS,"c-startup-time":this.accessLogData.StartupTime,"c-duration-watched":this.accessLogData.PlayTimeWC/1e3,"c-frames-dropped":this.accessLogData.ViFrDr,"c-stalls":this.accessLogData.StallCount+this.accessLogData.MediaEngineStallCount,"c-duration-downloaded":this.accessLogData.lastMediaDur?a-this.accessLogData.lastMediaDur:a,"c-overdue":this.accessLogData.overdue,"c-avg-video-bitrate":8*this.accessLogData.videoBytes/(this.accessLogData.videoDuration||1),"c-observed-max-bitrate":this.accessLogData.obrMax,"c-observed-min-bitrate":this.accessLogData.obrMin,"sc-indicated-bitrate":i.bandwidth||0,"sc-indicated-avg-bitrate":i.avgBandwidth||0,"c-observed-bitrate":this.accessLogData.OBRMean,"c-switch-bitrate":this.accessLogData.OBRLast,"c-provisional-entry":!1};return s["s-playback-type"]=r,this.accessLogData.audioBytes&&(s["c-avg-audio-bitrate"]=8*this.accessLogData.audioBytes/(this.accessLogData.audioDuration||1)),s}translateToErrorLogItem(e,t,i){t=this.convertStringObjectToPrimitive(t);return this.updateSvrAddrStats(t),{date:new Date,"cs-guid":this.accessLogReporter?this.accessLogReporter.SessionID+"-"+e:"undefined",uri:t,"s-ip":this.accessLogData.svrAddr,status:""+i.code,domain:i.domain}}hasGap(e,t,i,r){return void 0!==e&&void 0!==i&&(1<e-(r=void 0===r?0:r)||1<i-t)}aggregateFragObserverdBitrate(e,t,i,r){r=8*i/(r/1e3);return{obr:r,obrLast:8*e.bytes/(e.adt/1e3),obrMean:r/t}}aggregateFragMinMaxBitrate(e,t){(!e.obrMax||t>e.obrMax)&&(e.obrMax=t),(!e.obrMin||t<e.obrMin)&&(e.obrMin=t)}getVariantInfo(e){var t,i=null===(t=null===(i=this.rtcQuery)||void 0===i?void 0:i.entity(e))||void 0===t?void 0:t.sessionControlRecord.curLevelUrl,e=null===(e=null===(e=null===(t=this.rtcQuery)||void 0===t?void 0:t.entity(e))||void 0===e?void 0:e.sessionControlRecord.manifestData)||void 0===e?void 0:e.variantList;return i&&e&&e[i]?e[i]:{}}}class Gp{}Gp.PlayEnded=6101,Gp.Periodic=6110,Gp.PlayStalled=6103,Gp.KeySessionComplete=6104,Gp.PlayLikelyToKeepUp=6105,Gp.PlayRateChanged=6106,Gp.PlayError=6107,Gp.MediaEngineStalled=6108,Gp.SwitchComplete=6109,Gp.VariantEnded=6111,Gp.SeekComplete=6112,Gp.InterstitialStarted=6121,Gp.InterstitialAssetStarted=6122,Gp.InterstitialAssetEnded=6123,Gp.InterstitialEnded=6124,Gp.NwError=6202,Gp.DebugInfo=6203;const zp={avc1:1,avc3:1,hvc1:{SDR:2,HLG:10,PQ:11},hev1:{SDR:2,HLG:10,PQ:11},vp09:{SDR:3,HLG:14,PQ:13},av01:{SDR:4,HLG:15,PQ:16},dvh1:{PQ:12}};class Wp{constructor(e,t,i){this.query=e,this.logger=t,this.config=i,this.rtcExcludeKeysSet=new Set(this.config.rtcExcludeKeysList)}setReportingAgent(e){this.reportingAgent=e}sendPlayEnded(e){var t=Gp.PlayEnded;this.fillAndFire(t,this.query.playEnded(e))}sendPlayStalled(e){var t=Gp.PlayStalled;this.fillAndFire(t,this.query.playStalled(e))}sendMediaEngineStalled(e){var t=Gp.MediaEngineStalled;this.fillAndFire(t,this.query.mediaEngineStalled(e))}sendKeySessionComplete(e){var t=Gp.KeySessionComplete;this.fillAndFire(t,this.query.keySessionComplete(e))}sendPlayLikelyToKeepUp(e){var t=Gp.PlayLikelyToKeepUp;this.fillAndFire(t,this.query.playLikelyToKeepUp(e))}sendPlayRateChange(e){var t=Gp.PlayRateChanged;this.fillAndFire(t,this.query.playRateChanged(e))}sendSwitchComplete(e){var t=Gp.SwitchComplete;this.fillAndFire(t,this.query.switchComplete(e))}sendSeekComplete(e){var t=Gp.SeekComplete;this.fillAndFire(t,this.query.seekComplete(e))}sendVariantEnded(e){var t=Gp.VariantEnded;this.fillAndFire(t,this.query.variantEnded(e))}sendPlayError(e){var t=Gp.PlayError;this.fillAndFire(t,this.query.playError(e))}sendNwError(e){var t=Gp.NwError;this.fillAndFire(t,this.query.nwError(e))}sendDebugInfo(e){var t=Gp.DebugInfo;this.fillAndFire(t,this.query.debugInfo(e))}sendPeriodic(e){var t=Gp.Periodic;this.fillAndFire(t,this.query.periodic(e))}sendInterstitialStart(e){var t=Gp.InterstitialStarted;this.fillAndFire(t,this.query.periodic(e))}sendInterstitialAssetStart(e){var t=Gp.InterstitialAssetStarted;this.fillAndFire(t,this.query.periodic(e))}sendInterstitialAssetEnd(e){var t=Gp.InterstitialAssetEnded;this.fillAndFire(t,this.query.periodic(e))}sendInterstitialEnd(e){var t=Gp.InterstitialEnded;this.fillAndFire(t,this.query.periodic(e))}fillAndFire(e,t){if(t&&(e!==Gp.Periodic||t.PlayTimeWC||t.ADT)){var r=e===Gp.PlayEnded||e===Gp.Periodic?1:0;if(this.reportingAgent){let i={};Object.entries(t).forEach(([e,t])=>{this.rtcExcludeKeysSet.has(e)||("object"==typeof(t=z(t)?Number(Number(t).toFixed(2)):t)?"ServerInfo"===e?Object.entries(null!=t?t:{}).forEach(([e,t])=>{i[e]=t}):"VariantFragLoadInfo"!==e&&"AudioFragLoadInfo"!==e&&"VariantBufferInfo"!==e&&"AudioBufferInfo"!==e||(i[e]=t):i[e]=t)}),i=JSON.parse(JSON.stringify(i));try{this.reportingAgent.issueReportingEvent(e,i,r)}catch(e){}}}}}class Yp{constructor(e,t){this.rtcStore=e,this.logger=t}entity(e){return this.rtcStore.getEntity(e)}playEnded(e){return null===(e=this.rtcStore.getEntity(e))||void 0===e?void 0:e.playEndedRecord}periodic(e){return null===(e=this.rtcStore.getEntity(e))||void 0===e?void 0:e.periodicRecord}sessionControlRecord(e){return null===(e=this.rtcStore.getEntity(e))||void 0===e?void 0:e.sessionControlRecord}playStalled(e){return null===(e=this.rtcStore.getEntity(e))||void 0===e?void 0:e.playStalledRecord}mediaEngineStalled(e){return null===(e=this.rtcStore.getEntity(e))||void 0===e?void 0:e.mediaEngineStalledRecord}keySessionComplete(e){return null===(e=this.rtcStore.getEntity(e))||void 0===e?void 0:e.keySessionCompleteRecord}playLikelyToKeepUp(e){return null===(e=this.rtcStore.getEntity(e))||void 0===e?void 0:e.playLikelyToKeepUpRecord}playRateChanged(e){return null===(e=this.rtcStore.getEntity(e))||void 0===e?void 0:e.playRateChangedRecord}switchComplete(e){return null===(e=this.rtcStore.getEntity(e))||void 0===e?void 0:e.switchCompleteRecord}seekComplete(e){return null===(e=this.rtcStore.getEntity(e))||void 0===e?void 0:e.seekCompleteRecord}variantEnded(e){return null===(e=this.rtcStore.getEntity(e))||void 0===e?void 0:e.variantEndedRecord}playError(e){return null===(e=this.rtcStore.getEntity(e))||void 0===e?void 0:e.playErrorRecord}nwError(e){return null===(e=this.rtcStore.getEntity(e))||void 0===e?void 0:e.nwErrorRecord}debugInfo(e){return null===(e=this.rtcStore.getEntity(e))||void 0===e?void 0:e.debugInfoRecord}interstitialPlayTime(e){return null!==(e=null===(e=this.rtcStore.getEntity(e))||void 0===e?void 0:e.periodicRecord.InterstitialPlayTime)&&void 0!==e?e:0}}class Xp{constructor(e){this.logger=e,this.storage={}}createEntity(e,t,i,r=!1,n=void 0){const a={itemId:e,sessionControlRecord:{state:"RTC_STATE_INIT",rate:0,oldRate:0,eventStartTime:performance.now(),sessionStartTime:performance.now(),lastLikelyToKeepUpTime:performance.now(),lastPeriodicTime:performance.now(),lastWaitForCanPlay:performance.now(),playLikelyToKeepUpEventCounter:1,periodicEventCounter:1,activeKeySessions:{},intervalVariantList:{},sessionVariantList:{}},playEndedRecord:{HLSJSVersion:t,InterstitialsEnabled:i,IsLoopingPlayer:r},periodicRecord:{},playStalledRecord:{},keySessionCompleteRecord:{},playLikelyToKeepUpRecord:{},playRateChangedRecord:{},playErrorRecord:{},mediaEngineStalledRecord:{},switchCompleteRecord:{},variantEndedRecord:{},nwErrorRecord:{},debugInfoRecord:{},seekCompleteRecord:{}};n&&(a.playEndedRecord.TestGroupId=n),this.storage[e]=a}addEntity(e){this.storage[e.itemId]=e}removeEntityByID(e){delete this.storage[e]}resetStore(){this.storage={}}getEntity(e){if(e)return this.storage[e]}updateEnded(e,t){this._prepareEventPlayEnded(e,t)}updatePeriodic(e,t,i){this._prepareEventPeriodic(e,{currentTime:t,isFinal:i})}updateBufferStalled(e,t){var i=this.getEntity(e);if(i){const{sessionControlRecord:r,variantEndedRecord:n,periodicRecord:a,playEndedRecord:s}=i;r.rate=0,n.StallCount=(null!==(i=n.StallCount)&&void 0!==i?i:0)+1,a.StallCount=(null!==(i=a.StallCount)&&void 0!==i?i:0)+1,s.StallCount=(null!==(i=s.StallCount)&&void 0!==i?i:0)+1,this._prepareEventPlayStalled(e,t)}}updateKeyLoaded(e,t){const i=this.getEntity(e);if(i){const r=i["sessionControlRecord"];if(r.activeKeySessions)if("AES-128"===t.method){const e={},i=t.timestamp;e.keyFormat="identity",e.keyDeliveryTime=t.adt,e.currentMediaTime=t.currentTime,e.forInterstitial=t.forInterstitial,e.mediaOptionId=t.mediaOptionId,e.keyInitTime=i-r.sessionStartTime,r.activeKeySessions[t.keyuri]=e}else r.activeKeySessions[t.keyuri].mediaOptionId=t.mediaOptionId;this._prepareEventKeySessionComplete(e,t)}}updateLicenseResponseProcessed(e,t){var i=this.getEntity(e);if(i){const r=i["sessionControlRecord"];if(r.activeKeySessions){const e=r.activeKeySessions[t.keyuri];e.licenseResponseProcessTime=t.timestamp-(e.licenseResponseSubmitTime||0),r.lastKeyDeliveryTime=e.keyDeliveryTime=t.timestamp-(e.licenseChallengeStartTime||0),e.currentMediaTime=t.currentTime,r.finishedKeyUri=t.keyuri}this._prepareEventKeySessionComplete(e,t)}}updateLicenseChallengeError(e,t){e=this.getEntity(e);if(e){const i=e["sessionControlRecord"];if(i.activeKeySessions){const r=i.activeKeySessions[t.keyuri];i.lastKeyErrorType=r.keyErrorType="licenseChallengeError"}}}updateLicenseResponseError(e,t){e=this.getEntity(e);if(e){const i=e["sessionControlRecord"];if(i.activeKeySessions){const r=i.activeKeySessions[t.keyuri];i.lastKeyErrorType=r.keyErrorType="licenseResponseError"}}}updateKeyAborted(e,t){var i=this.getEntity(e);if(i){const r=i["sessionControlRecord"];r.activeKeySessions&&(r.activeKeySessions[t.keyuri].keyErrorType="keyAborted",r.finishedKeyUri=t.keyuri),this._prepareEventKeySessionComplete(e,t)}}updateKeyErrorThrown(e,i){var r;const n=this.getEntity(e);if(n){const a=n["sessionControlRecord"];if(a.activeKeySessions){let t="";(null!==(r=i.mediaOptionIds)&&void 0!==r?r:[]).forEach(e=>t+=e+","),t=t.substring(0,t.length-1);const n=a.activeKeySessions[i.keyuri];n.mediaOptionId=i.mediaOptionId,n.mediaOptionIdsForKey=t,a.finishedKeyUri=i.keyuri}this._prepareEventKeySessionComplete(e,i)}}updateCanPlay(e,t){var i=this.getEntity(e);if(i){const{sessionControlRecord:a,playLikelyToKeepUpRecord:s,playRateChangedRecord:o}=i;this._isIFrameToggle(t.oldRate,t.newRate)?a.iFrameToggle=!0:a.iFrameToggle=!1;var{sessionStartTime:r,lastWaitForCanPlay:n,playLikelyToKeepUpEventCounter:i}=a,n=performance.now()-(1===i?r:n);s.StartupTime=o.StartupTime=n,this._prepareEventPlayLikelyToKeepUp(e,t)}}updateRateChanged(e,t){var i=this.getEntity(e);if(i){const r=i["sessionControlRecord"];r.rate=100*t.rate,0<t.rate&&0===r.oldRate&&(r.playInfo||(r.playInfo=[]),r.playInfo.push({latency:t.latency}),r.curLevelUrl||(r.curLevelUrl=t.url)),this._prepareEventPlayRateChanged(e,t)}}updateMediaError(e,t){var i=this.getEntity(e);if(i){const{sessionControlRecord:r,periodicRecord:n,playEndedRecord:a}=i;if(n.PlayerErrCount=(null!==(i=n.PlayerErrCount)&&void 0!==i?i:0)+1,a.PlayerErrCount=(null!==(i=a.PlayerErrCount)&&void 0!==i?i:0)+1,t.fatal)r.rate=0,n.FatalPlayerErrCount=(null!==(i=n.FatalPlayerErrCount)&&void 0!==i?i:0)+1,a.FatalPlayerErrCount=(null!==(i=a.FatalPlayerErrCount)&&void 0!==i?i:0)+1,a.ErrCode=t.details,a.ErrReason=t.code,a.ErrIsFatal=!0,a.ErrDomain="mediaError",this._prepareEventPlayError(e,t);else{const e=t.details+"/"+t.code;r.nonFatalPlayErrList||(r.nonFatalPlayErrList={}),r.nonFatalPlayErrList[e]=(null!==(t=r.nonFatalPlayErrList[e])&&void 0!==t?t:0)+1}}}prepareNonFatalPlayError(e){var t=this.getEntity(e);if(!t)return!1;const{sessionControlRecord:i,playEndedRecord:r,playErrorRecord:n}=t,a=null!==(e=i.nonFatalPlayErrList)&&void 0!==e?e:{},s=null!==(t=Object.keys(a))&&void 0!==t?t:[];if(s.length<=0)return!1;e=s[0],t=s[0].split("/");return n.ErrDomain="mediaError",n.ErrIsFatal=!1,n.ErrCode=t[0],n.ErrReason=parseInt(t[1]),n.PlayerErrCount=a[e],this._copyCommonKeys(n,r),delete a[e],!0}updateMediaElementError(e,t,i){let r;try{r=JSON.parse(t.message)}catch(e){}var n=r?parseInt(r.ErrReason):void 0,a=r?parseInt(r.ErrDetail):void 0;this._prepareEventPlayError(e,{domain:"mediaElementError",mediaElemCode:t.code,mediaElemReason:n,mediaElemDetail:a,code:void 0,details:void 0,fatal:void 0,forInterstitial:i})}updateDebugInfo(e,t){this._prepareEventDebugInfo(e,{details:t.details,code:t.code,domain:t.domain===U.NETWORK_ERROR?"networkError":"mediaError",stack:t.stack,logs:t.logs,contentUrl:t.contentUrl})}updateMediaEngineStalled(e,t){var i=this.getEntity(e);if(i){const{sessionControlRecord:r,variantEndedRecord:n,periodicRecord:a,playEndedRecord:s}=i;r.rate=0,n.MediaEngineStallCount=(null!==(i=n.MediaEngineStallCount)&&void 0!==i?i:0)+1,a.MediaEngineStallCount=(null!==(i=a.MediaEngineStallCount)&&void 0!==i?i:0)+1,s.MediaEngineStallCount=(null!==(i=s.MediaEngineStallCount)&&void 0!==i?i:0)+1,this._prepareEventMediaEngineStalled(e,t)}}updateLevelSwitched(i,r){var n=this.getEntity(i);if(n){const{sessionControlRecord:d,switchCompleteRecord:u,periodicRecord:c,playEndedRecord:h}=n;c.SwCnt=(null!==(o=c.SwCnt)&&void 0!==o?o:0)+1,h.SwCnt=(null!==(l=h.SwCnt)&&void 0!==l?l:0)+1;var a=performance.now(),s=d.curLevelUrl,n=r.url,o=this._getVariantInfo(s,d),l=this._getVariantInfo(n,d);let e,t=!1;s?(e=l.bandwidth<o.bandwidth?"Down":"Up",t=l.iframes):e="Up",u.BadSw=this._isBadSw(e,d.lastSwitchDir,t,d.lastLevelIsIframe,a,d.lastSwitchTime,r.isSeeking),d.lastSwitchDir=e,d.lastSwitchTime=a,d.lastLevelIsIframe=t,d.curLevelUrl=n,d.variantStartTimeMedia=null!=r.currentTime?r.currentTime:void 0,this._prepareEventSwitchComplete(i,r)}}updateLevelLoadError(i,r){var n=this.getEntity(i);if(n){const{sessionControlRecord:a,switchCompleteRecord:s,periodicRecord:o,playEndedRecord:l}=n,d=performance.now();let e,t=!1;if(a.curLevelUrl){const i=this._getVariantInfo(a.curLevelUrl,a),u=this._getVariantInfo(r.url,a);e=u.bandwidth<i.bandwidth?"Down":"Up",t=u.iframes}else e="Up";o.SwCnt=(null!==(n=o.SwCnt)&&void 0!==n?n:0)+1,l.SwCnt=(null!==(n=l.SwCnt)&&void 0!==n?n:0)+1,s.BadSw=this._isBadSw(e,a.lastSwitchDir,t,a.lastLevelIsIframe,d,a.lastSwitchTime,r.isSeeking),s.SwFail=!0,this._prepareEventSwitchComplete(i,r)}}updateVariantEnd(e,t){this._prepareEventVariantEnded(e,t)}updateNwError(e,t){var i=this.getEntity(e);if(i){const{sessionControlRecord:r,periodicRecord:n,playEndedRecord:a}=i;if(n.NwErrCount=(null!==(i=n.NwErrCount)&&void 0!==i?i:0)+1,a.NwErrCount=(null!==(i=a.NwErrCount)&&void 0!==i?i:0)+1,t.fatal)r.rate=0,n.FatalNwErrCount=(null!==(i=n.FatalNwErrCount)&&void 0!==i?i:0)+1,a.FatalNwErrCount=(null!==(i=a.FatalNwErrCount)&&void 0!==i?i:0)+1,a.ErrCode=t.details,a.ErrReason=t.code,a.ErrIsFatal=!0,a.ErrDomain="networkError",this._prepareEventNwError(e,t);else{const e=t.details+"/"+t.code;r.nonFatalNwErrList||(r.nonFatalNwErrList={}),r.nonFatalNwErrList[e]=(null!==(t=r.nonFatalNwErrList[e])&&void 0!==t?t:0)+1}}}prepareNonFatalNwError(e){var t=this.getEntity(e);if(!t)return!1;const{sessionControlRecord:i,playEndedRecord:r,nwErrorRecord:n}=t,a=null!==(e=i.nonFatalNwErrList)&&void 0!==e?e:{},s=null!==(t=Object.keys(a))&&void 0!==t?t:[];if(s.length<=0)return!1;e=s[0],t=s[0].split("/");return n.ErrDomain="networkError",n.ErrIsFatal=!1,n.ErrCode=t[0],n.ErrReason=parseInt(t[1]),n.NwErrCount=a[e],this._copyCommonKeys(n,r),delete a[e],!0}updateInterstitialPlayTime(e,t){var e=this.getEntity(e);if(e){const{playEndedRecord:i,periodicRecord:r,variantEndedRecord:n,playStalledRecord:a,playErrorRecord:s,mediaEngineStalledRecord:o}=e;i.InterstitialPlayTime=(null!==(e=i.InterstitialPlayTime)&&void 0!==e?e:0)+t,r.InterstitialPlayTime=(null!==(e=r.InterstitialPlayTime)&&void 0!==e?e:0)+t,n.InterstitialPlayTime=(null!==(e=n.InterstitialPlayTime)&&void 0!==e?e:0)+t,a.InterstitialPlayTime=(null!==(e=a.InterstitialPlayTime)&&void 0!==e?e:0)+t,s.InterstitialPlayTime=(null!==(e=s.InterstitialPlayTime)&&void 0!==e?e:0)+t,o.InterstitialPlayTime=(null!==(e=o.InterstitialPlayTime)&&void 0!==e?e:0)+t}}finalize(t,e){const i=this.getEntity(t);if(i){const r=i["sessionControlRecord"];switch(e){case Gp.PlayEnded:r.state="RTC_STATE_STOP",r.oldRate=0,i.playEndedRecord={};break;case Gp.Periodic:{r.lastPeriodicTime=performance.now(),r.periodicEventCounter+=1,r.bufferAppendInfo=[],r.playInfo=[],r.seekInfo=[],r.liveEdgeInfo=[];const t=r.intervalVariantList;t&&Object.keys(t).forEach(e=>{t[e].playTime=0}),i.periodicRecord={};break}case Gp.PlayStalled:r.state="RTC_STATE_STALL",r.oldRate=0,i.playStalledRecord={};break;case Gp.KeySessionComplete:r.activeKeySessions&&r.finishedKeyUri&&delete r.activeKeySessions[r.finishedKeyUri],i.keySessionCompleteRecord={};break;case Gp.PlayLikelyToKeepUp:"RTC_STATE_PLAY"===r.state&&!r.iFrameToggle||(r.state="RTC_STATE_CANPLAY",r.lastLikelyToKeepUpTime=performance.now(),r.playLikelyToKeepUpEventCounter+=1),r.startupLatencyInfo=[],i.playLikelyToKeepUpRecord={};break;case Gp.PlayRateChanged:{const{playEndedRecord:t,playStalledRecord:e,mediaEngineStalledRecord:n,playErrorRecord:a,nwErrorRecord:s}=i;0!==r.rate?(r.state="RTC_STATE_PLAY",delete t.LastStall,delete t.LastMediaEngineStall,delete t.LastPause,delete a.LastPause,delete s.LastPause):(r.state="RTC_STATE_PAUSE",delete e.LastResume,delete n.LastResume,delete a.LastResume,delete s.LastResume),r.oldRate=r.rate,i.playRateChangedRecord={};break}case Gp.PlayError:r.state="RTC_STATE_PLAYERROR",i.playErrorRecord={};break;case Gp.MediaEngineStalled:r.state="RTC_STATE_MEDIAENGINESTALL",r.oldRate=0,i.mediaEngineStalledRecord={};break;case Gp.SwitchComplete:i.switchCompleteRecord={},r.prevLevelUrl=r.curLevelUrl;break;case Gp.VariantEnded:r.decodedFramesForVariant=0,r.decodedFramesForVariantSampleCount=0,i.variantEndedRecord={};break;case Gp.NwError:r.state="RTC_STATE_NWERROR",i.nwErrorRecord={}}r.eventStartTime=performance.now()}}updatePlaybackInfo(e,t){var i,r=this.getEntity(e);if(r){const{sessionControlRecord:n,periodicRecord:a,playEndedRecord:s}=r;z(t.liveEdgeDistance)&&(n.liveEdgeInfo?n.liveEdgeInfo.push({liveEdgeDist:t.liveEdgeDistance}):n.liveEdgeInfo=[{liveEdgeDist:t.liveEdgeDistance}]),n.bufferedRangeTuple=t.bufferedRangeTuple,n.droppedVideoFrames&&t.droppedVideoFrames<n.droppedVideoFrames&&(n.droppedVideoFrames=0),n.decodedFrameCount&&t.decodedFrameCount<n.decodedFrameCount&&(n.decodedFrameCount=0);var r=t.droppedVideoFrames-(null!==(e=n.droppedVideoFrames)&&void 0!==e?e:0),e=t.decodedFrameCount-(null!==(e=n.decodedFrameCount)&&void 0!==e?e:0);n.droppedVideoFrames=t.droppedVideoFrames,n.decodedFrameCount=t.decodedFrameCount,n.decodedFramesForVariant?n.decodedFramesForVariant+=e:n.decodedFramesForVariant=e,n.decodedFramesForVariantSampleCount?n.decodedFramesForVariantSampleCount+=1:n.decodedFramesForVariantSampleCount=1,r&&(3<=r?(a.GroupViFrDr=(null!==(i=a.GroupViFrDr)&&void 0!==i?i:0)+r,a.GroupViFrDrEvtCount=(null!==(i=a.GroupViFrDrEvtCount)&&void 0!==i?i:0)+1,s.GroupViFrDr=(null!==(i=s.GroupViFrDr)&&void 0!==i?i:0)+r,s.GroupViFrDrEvtCount=(null!==(i=s.GroupViFrDrEvtCount)&&void 0!==i?i:0)+1):(a.SparseViFrDr=(null!==(i=a.SparseViFrDr)&&void 0!==i?i:0)+r,a.SparseViFrDrEvtCount=(null!==(i=a.SparseViFrDrEvtCount)&&void 0!==i?i:0)+1,s.SparseViFrDr=(null!==(i=s.SparseViFrDr)&&void 0!==i?i:0)+r,s.SparseViFrDrEvtCount=(null!==(r=s.SparseViFrDrEvtCount)&&void 0!==r?r:0)+1))}}updateBufferAppended(e,t){var e=this.getEntity(e);if(e){const i=e["sessionControlRecord"];i.bufferAppendInfo||(i.bufferAppendInfo=[]),i.bufferAppendInfo.push({latency:t.endAppend-t.startAppend,size:t.bytesAppend}),this._storeStartupTimestamps(i,{type:"BufferAppend",tbegin:t.startAppend,tend:t.endAppend});const r=null!==(e=i.lastBufferAppendTimeForType)&&void 0!==e?e:{};r[t.fragmentType]=Math.round(t.endAppend-i.sessionStartTime),i.lastBufferAppendTimeForType=r}}updateSeek(e,t,i){e=this.getEntity(e);if(e){const r=e["seekCompleteRecord"];r.SeekStart=t.startPos,r.SeekEnd=t.pos,r.FromEvent=t.fromEvent,r.IsSeekPosBuffered=i.some(e=>e.start<=t.pos&&t.pos<=e.end)}}updateSeeked(e,t){var i=this.getEntity(e);if(i){const{sessionControlRecord:r,seekCompleteRecord:n}=i;r.seekInfo||(r.seekInfo=[]),r.seekInfo.push(t),n.SeekLatency=t.latency,this._copyCommonKeys(n,i.playEndedRecord),this._aggregateTimes(e)}}updateManifestParsed(e,t){e=this.getEntity(e);if(e){const{sessionControlRecord:i,playLikelyToKeepUpRecord:r,periodicRecord:n,playEndedRecord:a}=e;r.MasterPlaylistADT=t.adt,n.MasterPlaylistADT=t.adt,a.MasterPlaylistADT=t.adt,this._storeStartupTimestamps(i,{type:"PlaylistParse",tbegin:t.tparsed.tbegin,tend:t.tparsed.tend});const s=this._computeVariantInfo(t.levels);a.IsAudioOnly=t.isAudioOnly,a.IsGapless=t.isGapless,a.IsFirstItem=t.isFirstItem,a.ForInterstitial=t.forInterstitial,a.ItemID=t.itemID,a.MaxVideoQltyIndex=s.maxVideoQltyIndex,a.MaxReWd=s.maxWidth,a.MaxReHt=s.maxHeight,Object.keys(s.variantList).forEach(e=>{e=null!==(e=s.variantList[e].width)&&void 0!==e?e:0;3800<=e?i.support4KStart=performance.now():1850<=e&&e<2e3&&(i.supportHDStart=performance.now())}),i.manifestData={variantList:s.variantList,varListString:s.varListString}}}updateFragLoaded(e,t){var i,e=this.getEntity(e);if(e){const{sessionControlRecord:n,periodicRecord:a,playEndedRecord:s}=e;a.MediaRequestsSent=(null!==(e=a.MediaRequestsSent)&&void 0!==e?e:0)+1,s.MediaRequestsSent=(null!==(e=s.MediaRequestsSent)&&void 0!==e?e:0)+1;const o=t.stats,l=null==o?void 0:o.contentType,d=null==o?void 0:o.loaded,u=(null==o?void 0:o.tload)-(null==o?void 0:o.trequest),c=(null==o?void 0:o.tload)-(null==o?void 0:o.tfirst);null!=o&&o.cdnServer&&(s.LastMediaCDNServer=null===(r=o.cdnServer)||void 0===r?void 0:r.toLowerCase()),t.serverInfo&&(s.ServerInfo=t.serverInfo),n.segmentMimeTypes||(n.segmentMimeTypes=[]),n.segmentMimeTypes.findIndex(e=>e==l)<0&&n.segmentMimeTypes.push(l);var r=[Math.round((null!=d?d:0)/1e3),Math.round(t.duration),Math.round(performance.now()-n.sessionStartTime)];this._storeStartupTimestamps(n,{type:"SegmentLoad",tbegin:o.trequest,tend:o.tload}),t.fragType===Ys.Variant?(n.variantVideoBytes=(null!==(i=n.variantVideoBytes)&&void 0!==i?i:0)+d,n.variantVideoDuration=(null!==(i=n.variantVideoDuration)&&void 0!==i?i:0)+t.duration,n.intervalVideoBytes=(null!==(i=n.intervalVideoBytes)&&void 0!==i?i:0)+d,n.intervalVideoDuration=(null!==(i=n.intervalVideoDuration)&&void 0!==i?i:0)+t.duration,n.sessionVideoBytes=(null!==(i=n.sessionVideoBytes)&&void 0!==i?i:0)+d,n.sessionVideoDuration=(null!==(i=n.sessionVideoDuration)&&void 0!==i?i:0)+t.duration,n.variantFragLoadInfo||(n.variantFragLoadInfo=[]),n.variantFragLoadInfo.push(r),5<n.variantFragLoadInfo.length&&n.variantFragLoadInfo.shift(),n.obrLast=8*d/(t.duration/1e3),a.NetBytes=(null!==(i=a.NetBytes)&&void 0!==i?i:0)+d,a.ADT=(null!==(i=a.ADT)&&void 0!==i?i:0)+u,a.SegmentProcessTime=(null!==(i=a.SegmentProcessTime)&&void 0!==i?i:0)+c,s.ADT=(null!==(i=s.ADT)&&void 0!==i?i:0)+u,s.NetBytes=(null!==(i=s.NetBytes)&&void 0!==i?i:0)+d,s.SegmentProcessTime=(null!==(i=s.SegmentProcessTime)&&void 0!==i?i:0)+c):t.fragType===Ys.AltAudio&&(n.variantAudioBytes=(null!==(i=n.variantAudioBytes)&&void 0!==i?i:0)+d,n.variantAudioDuration=(null!==(i=n.variantAudioDuration)&&void 0!==i?i:0)+t.duration,n.intervalAudioBytes=(null!==(i=n.intervalAudioBytes)&&void 0!==i?i:0)+d,n.intervalAudioDuration=(null!==(i=n.intervalAudioDuration)&&void 0!==i?i:0)+t.duration,n.sessionAudioBytes=(null!==(i=n.sessionAudioBytes)&&void 0!==i?i:0)+d,n.sessionAudioDuration=(null!==(i=n.sessionAudioDuration)&&void 0!==i?i:0)+t.duration,n.audioFragLoadInfo||(n.audioFragLoadInfo=[]),n.audioFragLoadInfo.push(r),5<n.audioFragLoadInfo.length&&n.audioFragLoadInfo.shift())}}updateFragParsed(e,t){var e=this.getEntity(e);if(e){const{sessionControlRecord:i,playEndedRecord:r,periodicRecord:n}=e,a=null!==(e=null===(e=null==t?void 0:t.initFragSample)||void 0===e?void 0:e.tparsed)&&void 0!==e?e:{tbegin:0,tend:0},s=null!==(e=null===(e=null==t?void 0:t.fragSample)||void 0===e?void 0:e.tparsed)&&void 0!==e?e:{tbegin:0,tend:0};this._storeStartupTimestamps(i,{type:"SegmentParse",tbegin:a.tbegin,tend:a.tend}),this._storeStartupTimestamps(i,{type:"SegmentParse",tbegin:s.tbegin,tend:s.tend});t=1e3*Math.round((null!==(t=t.largestVideoSampleSize)&&void 0!==t?t:0)/1e3);(!r.LargestVideoSampleSize||t>r.LargestVideoSampleSize)&&(r.LargestVideoSampleSize=t),(!n.LargestVideoSampleSize||t>n.LargestVideoSampleSize)&&(n.LargestVideoSampleSize=t)}}updateFragBuffered(e,t){var e=this.getEntity(e);if(e){const{periodicRecord:i,playEndedRecord:r}=e;t.fragType===Ys.Variant&&(i.SegmentParseTime=(null!==(e=i.SegmentParseTime)&&void 0!==e?e:0)+t.parseTime,r.SegmentParseTime=(null!==(e=r.SegmentParseTime)&&void 0!==e?e:0)+t.parseTime)}}updateLevelLoaded(e,t){var e=this.getEntity(e);if(e){const{sessionControlRecord:i,periodicRecord:r,playEndedRecord:n}=e,a=t.stats,s=a.tload-a.trequest;this._storeStartupTimestamps(i,{type:"PlaylistLoad",tbegin:a.trequest,tend:a.tload}),r.PlaylistADT=(null!==(e=r.PlaylistADT)&&void 0!==e?e:0)+s,n.PlaylistADT=(null!==(e=n.PlaylistADT)&&void 0!==e?e:0)+s,r.MaxPlaylistDT=Math.max(null!==(e=r.MaxPlaylistDT)&&void 0!==e?e:0,s),n.MaxPlaylistDT=Math.max(null!==(e=n.MaxPlaylistDT)&&void 0!==e?e:0,s),n.PlayType=t.playType,n.ContentDur||(n.ContentDur=300*Math.round((null!==(e=t.totalduration)&&void 0!==e?e:0)/300)),this._setTargetDuration(t.url,t.targetduration,i),i.playlistMimeTypes||(i.playlistMimeTypes=[]),i.playlistMimeTypes.findIndex(e=>e==a.contentType)<0&&i.playlistMimeTypes.push(a.contentType);const o=i.levelUrlLoaded=t.url,l=this._getVariantInfo(o,i),d=i.intervalVariantList,u=i.sessionVariantList;d&&!d[o]&&(d[o]=Object.assign({},l)),u&&!u[o]&&(u[o]=Object.assign({},l))}}updateLevelParsed(e,t){e=this.getEntity(e);e&&(e=e["sessionControlRecord"],this._storeStartupTimestamps(e,{type:"PlaylistParse",tbegin:t.tbegin,tend:t.tend}))}updateLevelsChanged(e,t){e=this.getEntity(e);if(e){const{sessionControlRecord:r,playEndedRecord:i}=e,n=this._computeVariantInfo(t.levels);i.MaxVideoQltyIndex=n.maxVideoQltyIndex,i.MaxReWd=n.maxWidth,i.MaxReHt=n.maxHeight,r.manifestData={variantList:n.variantList,varListString:n.varListString},Object.keys(n.variantList).forEach(e=>{const t=r.intervalVariantList,i=r.sessionVariantList;t&&t[e]&&(t[e].brRnk=n.variantList[e].brRnk),i&&i[e]&&(i[e].brRnk=n.variantList[e].brRnk);e=null!==(e=n.variantList[e].width)&&void 0!==e?e:0;3800<=e?r.support4KStart=performance.now():1850<=e&&e<2e3&&(r.supportHDStart=performance.now())})}}updateLicenseChallengeRequested(e,t){e=this.getEntity(e);if(e){const i=e["sessionControlRecord"],r={},n=t.timestamp;r.licenseChallengeStartTime=n,r.forInterstitial=t.forInterstitial,"RTC_STATE_INIT"===i.state&&(r.keyInitTime=n-i.sessionStartTime),i.activeKeySessions&&(i.activeKeySessions[t.keyuri]=r)}}updateLicenseChallengeReceived(e,t){e=this.getEntity(e);if(e){var e=e["sessionControlRecord"];if(e.activeKeySessions){const i=e.activeKeySessions[t.keyuri];i.licenseChallengeRequestTime=t.timestamp-(i.licenseChallengeStartTime||0)}}}updateLicenseChallengeSubmitted(e,t){e=this.getEntity(e);if(e){var e=e["sessionControlRecord"];if(e.activeKeySessions){const i=e.activeKeySessions[t.keyuri];i.keyFormat=t.keyFormat,i.licenseChallengeSubmitTime=t.timestamp}}}updateLicenseChallengeCreated(e,t){e=this.getEntity(e);if(e){var e=e["sessionControlRecord"];if(e.activeKeySessions){const i=e.activeKeySessions[t.keyuri];i.cdmVersion=t.cdmVersion,i.licenseChallengeCreationTime=t.timestamp-(i.licenseChallengeSubmitTime||0)}}}updateLicenseResponseRequested(e,t){e=this.getEntity(e);if(e){const i=e["sessionControlRecord"],r=i.activeKeySessions?i.activeKeySessions[t.keyuri]:void 0;r&&(r.licenseResponseRequestTime=t.timestamp)}}updateLicenseResponseReceived(e,t){e=this.getEntity(e);if(e){const i=e["sessionControlRecord"],r=i.activeKeySessions?i.activeKeySessions[t.keyuri]:void 0;r&&(r.licenseResponseReceiveTime=t.timestamp-(r.licenseResponseRequestTime||0))}}updateLicenseResponseSubmitted(e,t){e=this.getEntity(e);if(e){const i=e["sessionControlRecord"],r=i.activeKeySessions?i.activeKeySessions[t.keyuri]:void 0;r&&(r.licenseResponseSubmitTime=t.timestamp)}}updateWaitForCanPlay(e){e=this.getEntity(e);if(e){const t=e["sessionControlRecord"];t.lastWaitForCanPlay=performance.now()}}_prepareEventPlayEnded(e,r){var n=this.getEntity(e);if(n){const{sessionControlRecord:l,playEndedRecord:d}=n;d.AvgVideoBitrate=8*(null!==(a=l.sessionVideoBytes)&&void 0!==a?a:0)/(l.sessionVideoDuration||1),d.AvgAudioBitrate=8*(null!==(s=l.sessionAudioBytes)&&void 0!==s?s:0)/(l.sessionAudioDuration||1);n=1e3*Math.round((null!==(o=d.NetBytes)&&void 0!==o?o:0)/1e3);d.NetBytes=n;var a=d.ADT||1,s=a+(d.SegmentProcessTime||1),o=a+(null!==(o=d.SegmentProcessTime)&&void 0!==o?o:0)+(d.SegmentParseTime||1);d.TWOBR=8*n/(a/1e3),d.PerceivedTWOBR=8*n/(s/1e3),d.NetTWOBR=8*n/(o/1e3);var o=this._findTimeWeightedValues("RTC_STATE_PLAY"===l.state?performance.now()-l.eventStartTime:0,l.sessionVariantList||{},l.curLevelUrl);d.PlayerTWIBR=o.twIBR,d.PlayerTWIABR=o.twIABR,d.TWBitRk=o.twBRnk;o=null!==(o=l.curLevelUrl)&&void 0!==o?o:l.levelUrlLoaded,o=this._getVariantInfo(o,l);d.TargetDur=o.targetduration,d.ReWd=o.width,d.ReHt=o.height,d.Codecs=o.codecs,d.VariantList=null===(o=l.manifestData)||void 0===o?void 0:o.varListString;let t="";l.playlistMimeTypes&&(l.playlistMimeTypes.forEach(e=>{t+=e+","}),t=t.slice(0,-1));let i="";l.segmentMimeTypes&&(l.segmentMimeTypes.forEach(e=>{i+=e+","}),i=i.slice(0,-1)),d.PlaylistMimeType=t,d.SegmentMimeType=i,d.Rate=l.rate,d.CurrentMediaTime=z(r)?1e3*r:void 0;r=this._getBufferInfo(l.bufferedRangeTuple);d.VariantBufferInfo=r[Xs.Variant],d.AudioBufferInfo=r[Xs.AltAudio],this._aggregateTimes(e)}}_prepareEventPeriodic(t,i){var r=this.getEntity(t);if(r){const{sessionControlRecord:s,periodicRecord:o,playEndedRecord:l}=r;o.EventCounter=s.periodicEventCounter,o.PInterval=performance.now()-s.lastPeriodicTime,o.AvgVideoBitrate=8*(null!==(n=s.intervalVideoBytes)&&void 0!==n?n:0)/(s.intervalVideoDuration||1),o.AvgAudioBitrate=8*(null!==(a=s.intervalAudioBytes)&&void 0!==a?a:0)/(s.intervalAudioDuration||1);let e=null!==(r=o.NetBytes)&&void 0!==r?r:0;i.isFinal&&(o.NetBytes=e=1e3*Math.round(e/1e3));var n=o.ADT||1,a=n+(o.SegmentProcessTime||1),r=n+(null!==(r=o.SegmentProcessTime)&&void 0!==r?r:0)+(o.SegmentParseTime||1);o.TWOBR=8*e/(n/1e3),o.PerceivedTWOBR=8*e/(a/1e3),o.NetTWOBR=8*e/(r/1e3);r=this._findTimeWeightedValues("RTC_STATE_PLAY"===s.state?performance.now()-s.eventStartTime:0,s.sessionVariantList||{},s.curLevelUrl);o.PlayerTWIBR=r.twIBR,o.PlayerTWIABR=r.twIABR,o.TWBitRk=r.twBRnk;r=this._getVariantInfo(s.curLevelUrl,s);o.TargetDur=r.targetduration,o.ReWd=r.width,o.ReHt=r.height,o.VariantList=null===(r=s.manifestData)||void 0===r?void 0:r.varListString,o.Rate=s.rate,o.CurrentMediaTime=z(i.currentTime)?1e3*i.currentTime:void 0;var i=this._getBufferInfo(s.bufferedRangeTuple);o.VariantBufferInfo=i[Xs.Variant],o.AudioBufferInfo=i[Xs.AltAudio];var i=this._computeMediaStats(s);i&&(o.MedianBufferAppendLatency=i.bufLatencyInfo.median,o.MaxBufferAppendLatency=i.bufLatencyInfo.max,o.MedianBufferAppendSize=i.bufSizeInfo.median,o.MaxBufferAppendSize=i.bufSizeInfo.max,o.MedianSeekLatency=i.seekLatencyInfo.median,o.MaxSeekLatency=i.seekLatencyInfo.max,o.MedianPlayLatency=i.playLatencyInfo.median,o.MaxPlayLatency=i.playLatencyInfo.max,o.MedianLiveEdgeDist=i.liveEdgeDistInfo.median,o.MaxLiveEdgeDist=i.liveEdgeDistInfo.max),o.VariantFragLoadInfo=s.variantFragLoadInfo,o.AudioFragLoadInfo=s.audioFragLoadInfo,o.LastVariantBufferAppendTime=null===(i=s.lastBufferAppendTimeForType)||void 0===i?void 0:i[Ys.Variant],o.LastAudioBufferAppendTime=null===(i=s.lastBufferAppendTimeForType)||void 0===i?void 0:i[Ys.AltAudio],this._copyCommonKeys(o,l),this._aggregateTimes(t)}}_prepareEventPlayStalled(e,t){var i=this.getEntity(e);if(i){const{sessionControlRecord:r,playStalledRecord:n,playEndedRecord:a}=i,s=this._getVariantInfo(r.curLevelUrl,r),o=performance.now();n.PlayTimeWC=null!==(i=a.PlayTimeWC)&&void 0!==i?i:0,n.CurrentMediaTime=z(t.currentTime)?1e3*t.currentTime:void 0;i=this._getBufferInfo(r.bufferedRangeTuple);n.VariantBufferInfo=i[Xs.Variant],n.AudioBufferInfo=i[Xs.AltAudio],n.MediaDur=t.mediaDur,n.BitRnk=s.brRnk,n.Codecs=s.codecs,n.LastLikelyToKeepUp=o-r.lastLikelyToKeepUpTime,n.LastSwitch=o-(r.lastSwitchTime||0),n.StallDetectionTime=t.stallDurationMs,n.StallType=t.type,n.BufferLength=t.bufferLen,"networkError"===a.ErrDomain&&(n.NwErrTime=a.NwErrTime,n.NwErrCode=a.ErrCode),n.LaSwDir=r.lastSwitchDir,n.TargetDur=s.targetduration,n.PlayerIABR=s.avgBandwidth,n.PlayerIBR=s.bandwidth,n.Rate=r.rate,n.OBRLast=r.obrLast,a.NetBytes&&a.ADT&&(n.OBRMean=8*a.NetBytes/(a.ADT/1e3)),n.ForInterstitial=t.forInterstitial,n.VariantFragLoadInfo=r.variantFragLoadInfo,n.AudioFragLoadInfo=r.audioFragLoadInfo,n.LastVariantBufferAppendTime=null===(t=r.lastBufferAppendTimeForType)||void 0===t?void 0:t[Ys.Variant],n.LastAudioBufferAppendTime=null===(t=r.lastBufferAppendTimeForType)||void 0===t?void 0:t[Ys.AltAudio],this._copyCommonKeys(n,a),this._aggregateTimes(e)}}_prepareEventKeySessionComplete(e,t){var i=this.getEntity(e);if(i){const{sessionControlRecord:r,keySessionCompleteRecord:n,playEndedRecord:a}=i,s=r.activeKeySessions?r.activeKeySessions[t.keyuri]:void 0;s&&(n.PlayTimeWC=null!==(t=a.PlayTimeWC)&&void 0!==t?t:0,n.KeyFormat=s.keyFormat,n.CDMVersion=s.cdmVersion,n.MediaOptionId=null!==(t=s.mediaOptionId)&&void 0!==t?t:"keyRenewal",n.LicenseChallengeRequestTime=s.licenseChallengeRequestTime,n.LicenseChallengeCreationTime=s.licenseChallengeCreationTime,n.LicenseResponseReceiveTime=s.licenseResponseReceiveTime,n.LicenseResponseProcessTime=s.licenseResponseProcessTime,n.KeyDeliveryTime=s.keyDeliveryTime,n.CurrentMediaTime=z(s.currentMediaTime)?1e3*s.currentMediaTime:void 0,t=this._getBufferInfo(r.bufferedRangeTuple),n.VariantBufferInfo=t[Xs.Variant],n.AudioBufferInfo=t[Xs.AltAudio],n.LargestVideoSampleSize=a.LargestVideoSampleSize,n.KeyInitTime=s.keyInitTime,s.keyErrorType&&(n.KeyErrorType=s.keyErrorType,n.MediaOptionIdsForKey=s.mediaOptionIdsForKey),n.ForInterstitial=s.forInterstitial,this._copyCommonKeys(n,a),this._aggregateTimes(e))}}_prepareEventPlayLikelyToKeepUp(e,t){var i=this.getEntity(e);if(i){const{sessionControlRecord:r,playLikelyToKeepUpRecord:n,playEndedRecord:a}=i,s=this._getVariantInfo(r.curLevelUrl,r);n.PlayTimeWC=null!==(i=a.PlayTimeWC)&&void 0!==i?i:0,n.EventCounter=r.playLikelyToKeepUpEventCounter,n.PlayerIABR=s.avgBandwidth,n.PlayerIBR=s.bandwidth,n.MediaDur=t.mediaDur,n.BitRnk=s.brRnk,n.Codecs=s.codecs,n.TargetDur=s.targetduration,n.ForInterstitial=t.forInterstitial,n.PlayerStartPos=t.playStartTime,n.CurrentMediaTime=z(t.playStartTime)?1e3*t.playStartTime:void 0;t=this._getBufferInfo(r.bufferedRangeTuple);n.VariantBufferInfo=t[Xs.Variant],n.AudioBufferInfo=t[Xs.AltAudio],n.PlaylistADT=this._computeLatencyFromTimestamps(r.startupLatencyInfo,"PlaylistLoad"),n.PlaylistParseTime=this._computeLatencyFromTimestamps(r.startupLatencyInfo,"PlaylistParse"),n.ADT=this._computeLatencyFromTimestamps(r.startupLatencyInfo,"SegmentLoad"),n.SegmentParseTime=this._computeLatencyFromTimestamps(r.startupLatencyInfo,"SegmentParse"),n.BufferAppendTime=this._computeLatencyFromTimestamps(r.startupLatencyInfo,"BufferAppend"),this._copyCommonKeys(n,a),this._aggregateTimes(e)}}_prepareEventPlayRateChanged(e,t){var i=this.getEntity(e);if(i){const{sessionControlRecord:r,playRateChangedRecord:n,playEndedRecord:a}=i,s=this._getVariantInfo(r.curLevelUrl,r);n.PlayTimeWC=null!==(i=a.PlayTimeWC)&&void 0!==i?i:0,n.Rate=r.rate,n.StNPT=t.currentTime,n.CurrentMediaTime=z(t.currentTime)?1e3*t.currentTime:void 0;i=this._getBufferInfo(r.bufferedRangeTuple);n.VariantBufferInfo=i[Xs.Variant],n.AudioBufferInfo=i[Xs.AltAudio],n.PlayerIABR=s.avgBandwidth,n.PlayerIBR=s.bandwidth,n.BitRnk=s.brRnk,n.MediaDur=t.mediaDur,n.Codecs=s.codecs,n.ForInterstitial=t.forInterstitial,this._copyCommonKeys(n,a),this._aggregateTimes(e)}}_prepareEventPlayError(e,t){var i=this.getEntity(e);if(i){const{sessionControlRecord:r,playErrorRecord:n,playEndedRecord:a}=i,s=null!==(i=r.curLevelUrl)&&void 0!==i?i:r.levelUrlLoaded,o=this._getVariantInfo(s,r),l=performance.now();"mediaElementError"==t.domain?(n.ErrDomain=n.ErrCode="mediaElementError",n.ErrIsFatal=!0,n.ErrCodeMediaElement=t.mediaElemCode,n.ErrReason=t.mediaElemReason,n.ErrDetail=t.mediaElemDetail):(n.ErrCode=t.details,n.ErrReason=t.code,n.ErrIsFatal=t.fatal,n.ErrDomain="mediaError"),n.PlayerErrCount=t.count||1,n.BitRnk=o.brRnk,n.MediaDur=t.mediaDur,n.CurrentMediaTime=z(t.currentTime)?1e3*t.currentTime:void 0;var i=this._getBufferInfo(r.bufferedRangeTuple);n.VariantBufferInfo=i[Xs.Variant],n.AudioBufferInfo=i[Xs.AltAudio],n.Codecs=o.codecs,n.PlayTime=a.PlayTime,n.PlayTimeWC=null!==(i=a.PlayTimeWC)&&void 0!==i?i:0,n.PlayerIABR=o.avgBandwidth,n.PlayerIBR=o.bandwidth,n.LastLikelyToKeepUp=l-r.lastLikelyToKeepUpTime,n.LastSwitch=l-(null!==(i=r.lastSwitchTime)&&void 0!==i?i:0),n.LargestVideoSampleSize=a.LargestVideoSampleSize,n.VideoQltyIndex=o.qltyIndex,n.Rate=r.rate,n.KeyErrorType=r.lastKeyErrorType,n.KeyDeliveryTime=r.lastKeyDeliveryTime,n.ForInterstitial=t.forInterstitial,n.VariantFragLoadInfo=r.variantFragLoadInfo,n.AudioFragLoadInfo=r.audioFragLoadInfo,n.LastVariantBufferAppendTime=null===(t=r.lastBufferAppendTimeForType)||void 0===t?void 0:t[Ys.Variant],n.LastAudioBufferAppendTime=null===(t=r.lastBufferAppendTimeForType)||void 0===t?void 0:t[Ys.AltAudio],this._copyCommonKeys(n,a),this._aggregateTimes(e)}}_prepareEventMediaEngineStalled(e,t){var i=this.getEntity(e);if(i){const{sessionControlRecord:r,mediaEngineStalledRecord:n,playEndedRecord:a}=i,s=performance.now(),o=this._getVariantInfo(r.curLevelUrl,r);n.PlayTimeWC=null!==(i=a.PlayTimeWC)&&void 0!==i?i:0,n.MediaDur=t.mediaDur,n.CurrentMediaTime=z(t.currentTime)?1e3*t.currentTime:void 0;i=this._getBufferInfo(r.bufferedRangeTuple);n.VariantBufferInfo=i[Xs.Variant],n.AudioBufferInfo=i[Xs.AltAudio],n.BitRnk=o.brRnk,n.Codecs=o.codecs,n.LastLikelyToKeepUp=s-r.lastLikelyToKeepUpTime,n.LastSwitch=s-(r.lastSwitchTime||0),n.StallDetectionTime=t.stallDurationMs,n.StallType=t.type,n.BufferLength=t.bufferLen,n.LaSwDir=r.lastSwitchDir,n.TargetDur=o.targetduration,n.PlayerIABR=o.avgBandwidth,n.PlayerIBR=o.bandwidth,n.Rate=r.rate,n.OBRLast=r.obrLast,a.NetBytes&&a.ADT&&(n.OBRMean=8*a.NetBytes/(a.ADT/1e3)),n.ForInterstitial=t.forInterstitial,n.VariantFragLoadInfo=r.variantFragLoadInfo,n.AudioFragLoadInfo=r.audioFragLoadInfo,n.LastVariantBufferAppendTime=null===(t=r.lastBufferAppendTimeForType)||void 0===t?void 0:t[Ys.Variant],n.LastAudioBufferAppendTime=null===(t=r.lastBufferAppendTimeForType)||void 0===t?void 0:t[Ys.AltAudio],this._copyCommonKeys(n,a),this._aggregateTimes(e)}}_prepareEventSwitchComplete(e,t){var i=this.getEntity(e);if(i){const{sessionControlRecord:r,switchCompleteRecord:n,playEndedRecord:a}=i,s=this._getVariantInfo(r.prevLevelUrl,r),o=this._getVariantInfo(r.curLevelUrl,r);n.PlayTimeWC=null!==(i=a.PlayTimeWC)&&void 0!==i?i:0,n.FrBitRnk=s.brRnk,n.ToBitRnk=o.brRnk,n.TimeToBitrate=performance.now()-r.sessionStartTime,n.MediaDur=t.mediaDur,n.CurrentMediaTime=z(t.currentTime)?1e3*t.currentTime:void 0;i=this._getBufferInfo(r.bufferedRangeTuple);n.VariantBufferInfo=i[Xs.Variant],n.AudioBufferInfo=i[Xs.AltAudio],n.Rate=r.rate,n.PlayerIBR=o.bandwidth,n.PlayerIABR=o.avgBandwidth,n.LastPlayerIBR=s.bandwidth,n.LastPlayerIABR=s.avgBandwidth,n.ReWd=o.width,n.ReHt=o.height,n.ForInterstitial=t.forInterstitial,this._computeBitrateTimes(e,o),this._copyCommonKeys(n,a),this._aggregateTimes(e)}}_prepareEventVariantEnded(e,t){var i=this.getEntity(e);if(i){const{sessionControlRecord:r,variantEndedRecord:n,playEndedRecord:a}=i,s=this._getVariantInfo(r.curLevelUrl,r);n.PlayTimeWC=null!==(i=a.PlayTimeWC)&&void 0!==i?i:0,n.Rate=r.rate,n.VarAvgBitrate=s.avgBandwidth,n.VarPeakBitrate=s.bandwidth,n.VarBitRk=s.brRnk,n.VarSTTime=r.variantStartTimeMedia,n.VarEndTime=t.currentTime?1e3*t.currentTime:0,n.CurrentMediaTime=z(t.currentTime)?1e3*t.currentTime:void 0;var i=this._getBufferInfo(r.bufferedRangeTuple);n.VariantBufferInfo=i[Xs.Variant],n.AudioBufferInfo=i[Xs.AltAudio],n.IFR=s.framerate,r.decodedFramesForVariant&&r.decodedFramesForVariantSampleCount&&(n.ODR=r.decodedFramesForVariant/r.decodedFramesForVariantSampleCount),n.ReWd=s.width,n.ReHt=s.height,n.Codecs=s.codecs,n.AvgVideoBitrate=8*(null!==(i=r.variantVideoBytes)&&void 0!==i?i:0)/(r.variantVideoDuration||1),n.AvgAudioBitrate=8*(null!==(i=r.variantAudioBytes)&&void 0!==i?i:0)/(r.variantAudioDuration||1),n.ForInterstitial=t.forInterstitial,this._copyCommonKeys(n,a),this._aggregateTimes(e)}}_prepareEventNwError(e,t){var i=this.getEntity(e);if(i){const{sessionControlRecord:r,nwErrorRecord:n,playEndedRecord:a}=i,s=null!==(i=r.curLevelUrl)&&void 0!==i?i:r.levelUrlLoaded,o=this._getVariantInfo(s,r);n.ErrCode=t.details,n.ErrReason=t.code,n.ErrIsFatal=t.fatal,n.NwErrCount=t.count||1,n.ErrDomain="networkError",n.PlayTime=a.PlayTime,n.PlayTimeWC=null!==(i=a.PlayTimeWC)&&void 0!==i?i:0,n.CurrentMediaTime=z(t.currentTime)?1e3*t.currentTime:void 0;i=this._getBufferInfo(r.bufferedRangeTuple);n.VariantBufferInfo=i[Xs.Variant],n.AudioBufferInfo=i[Xs.AltAudio],n.BitRnk=o.brRnk,n.Codecs=o.codecs,n.Rate=r.rate,n.KeyErrorType=r.lastKeyErrorType,n.KeyDeliveryTime=r.lastKeyDeliveryTime,n.ForInterstitial=t.forInterstitial,n.VariantFragLoadInfo=r.variantFragLoadInfo,n.AudioFragLoadInfo=r.audioFragLoadInfo,n.LastVariantBufferAppendTime=null===(t=r.lastBufferAppendTimeForType)||void 0===t?void 0:t[Ys.Variant],n.LastAudioBufferAppendTime=null===(t=r.lastBufferAppendTimeForType)||void 0===t?void 0:t[Ys.AltAudio],this._copyCommonKeys(n,a),this._aggregateTimes(e)}}_prepareEventDebugInfo(e,t){var i=this.getEntity(e);if(i){const{playEndedRecord:r,debugInfoRecord:n}=i;n.ErrCode=t.details,n.ErrReason=t.code,n.ErrDomain=t.domain,n.ErrStack=t.stack,n.LogHistory=t.logs,n.ContentUrl=t.contentUrl,this._copyCommonKeys(n,r),this._aggregateTimes(e)}}_copyCommonKeys(e,t){e.HLSJSVersion=t.HLSJSVersion,e.PlayType=t.PlayType,e.LastMediaCDNServer=t.LastMediaCDNServer,e.MaxVideoQltyIndex=t.MaxVideoQltyIndex,e.MaxReWd=t.MaxReWd,e.MaxReHt=t.MaxReHt,e.InterstitialsEnabled=t.InterstitialsEnabled,e.IsGapless=t.IsGapless,e.IsLoopingPlayer=t.IsLoopingPlayer,e.IsAudioOnly=t.IsAudioOnly,e.IsFirstItem=t.IsFirstItem,e.ItemID=t.ItemID,e.ServerInfo=t.ServerInfo,e.TestGroupId=t.TestGroupId}_computeVariantInfo(e){const r={};let n=0,a=0,s=0,o=0;const l=this._getMaxNormalizedPeak(e);e.forEach(e=>{var t=this._getVideoFourCC(e.levelCodec),i=null!==(i=this._getVideoQualityIndex(t,e.videoRange))&&void 0!==i?i:0,t={codecs:e.levelCodec,width:e.width,height:e.height,bandwidth:e.bandwidth,avgBandwidth:e.avgBandwidth,framerate:e.frameRate,iframes:e.iframes,brRnk:this._getBitrateRank(e.bandwidth,t,l),qltyIndex:i,targetduration:0,playTime:0};o=i>o?i:o,e.url&&(r[e.url]=t);t=(null!==(t=e.width)&&void 0!==t?t:0)*(null!==(t=e.height)&&void 0!==t?t:0);t>s&&(s=t,n=null!==(t=e.width)&&void 0!==t?t:0,a=null!==(e=e.height)&&void 0!==e?e:0)});e=0<Object.keys(r).length?Object.values(r).map(e=>e.bandwidth+":"+e.avgBandwidth).join(","):"";return{variantList:r,varListString:e,maxVideoQltyIndex:o,maxWidth:n,maxHeight:a}}_getMaxNormalizedPeak(e){let i=0;return e.forEach(e=>{var t=null!==(t=e.bandwidth)&&void 0!==t?t:0,e=this._getNormalizedPeak(t,this._getVideoFourCC(e.levelCodec)),e=Math.max(t,e);i=e>i?e:i}),i}_getNormalizedPeak(e,t){return t&&"object"==typeof zp[t]?1.5*e:1*e}_getVideoFourCC(e){return e&&e.split(",").map(e=>e.split(".")[0].trim()).find(e=>!!zp[e])}_getVideoQualityIndex(e,t){if(e)return"object"==typeof zp[e]&&t?zp[e][t]:zp[e]}_getBitrateRank(e,t,i){t=Math.max(1,this._getNormalizedPeak(e,t));return Math.ceil(100*t/i)}_storeStartupTimestamps(e,t){1===e.playLikelyToKeepUpEventCounter&&(e.startupLatencyInfo||(e.startupLatencyInfo=[]),e.startupLatencyInfo.push(t))}_computeLatencyFromTimestamps(e,t){const i=null==e?void 0:e.filter(e=>e.type===t).sort((e,t)=>e.tbegin-t.tbegin),r=[];return null==i||i.forEach(e=>{const t=r[r.length-1];0===r.length||t.tend<e.tbegin?r.push({tbegin:e.tbegin,tend:e.tend}):t.tend=Math.max(t.tend,e.tend)}),r.reduce((e,t)=>e+(t.tend-t.tbegin),0)}_findTimeWeightedValues(o,l,d){const e={twBRnk:0,twIBR:0,twIABR:0};if(l){let i=0,r=0,n=0,a=0,s=0;Object.values(l).forEach(e=>{let t=e.playTime;d&&e===l[d]&&(t+=null!=o?o:0),t&&(r+=e.bandwidth*t,i+=e.brRnk*t,n+=t,e.avgBandwidth&&(a+=e.avgBandwidth*t,s+=t))}),n&&(e.twBRnk=i/n,e.twIBR=r/n),a&&s&&(e.twIABR=a/s)}return e}_computeMediaStats(e){const t=e.bufferAppendInfo,i=[],r=[];t&&t.forEach&&t.forEach(e=>{i.push(e.latency),r.push(e.size)});const n=this._computeStats(i),a=this._computeStats(r),s=e.seekInfo,o=this._computeStats((null!=s?s:[]).map(e=>e.latency)),l=e.playInfo,d=this._computeStats((null!=l?l:[]).map(e=>e.latency)),u=e.liveEdgeInfo;return{bufLatencyInfo:n,bufSizeInfo:a,seekLatencyInfo:o,playLatencyInfo:d,liveEdgeDistInfo:this._computeStats((null!=u?u:[]).map(e=>e.liveEdgeDist))}}_computeStats(e){let t=0,i=0;if(e){const r=e.filter(e=>0<e);if(0<r.length){t=r.reduce((e,t)=>Math.max(e,t));const e=r.length,n=r.sort((e,t)=>e-t),a=Math.ceil(e/2);i=e%2==0?(n[a]+n[a-1])/2:n[a-1]}}return{max:t,median:i}}_getVariantInfo(e,t){return e&&t.manifestData&&t.manifestData.variantList&&t.manifestData.variantList[e]?t.manifestData.variantList[e]:{}}_getBufferInfo(e){var t;const i=null!==(t=null==e?void 0:e[Xs.Variant])&&void 0!==t?t:[],r=[];0<i.length&&i.forEach(e=>{r.push([Number(e.start.toFixed(2)),Number(e.end.toFixed(2))])});const n=null!==(e=null==e?void 0:e[Xs.AltAudio])&&void 0!==e?e:[],a=[];return 0<n.length&&n.forEach(e=>{a.push([Number(e.start.toFixed(2)),Number(e.end.toFixed(2))])}),[0<r.length?r:void 0,0<a.length?a:void 0]}_setTargetDuration(e,t,i){e&&i.manifestData&&i.manifestData.variantList&&i.manifestData.variantList[e]&&(i.manifestData.variantList[e].targetduration=t)}_computeBitrateTimes(e,t){var i,r,e=this.getEntity(e);if(e){const{playEndedRecord:n,switchCompleteRecord:a,sessionControlRecord:s}=e;!n.StallCount&&!n.MediaEngineStallCount&&t.height&&t.width&&(s.support4KStart&&3800<=t.width&&(null!==(e=s.maxReWd)&&void 0!==e?e:0)<3800?a.TimeTo4K=performance.now()-s.support4KStart-(null!==(i=n.PauseTime)&&void 0!==i?i:0):s.supportHDStart&&1850<=t.width&&t.width<2e3&&(null!==(i=s.maxReWd)&&void 0!==i?i:0)<1850&&(a.TimeToHD=performance.now()-s.supportHDStart-(null!==(r=n.PauseTime)&&void 0!==r?r:0))),s.maxReWd=Math.max(null!==(r=s.maxReWd)&&void 0!==r?r:0,null!==(r=t.width)&&void 0!==r?r:0),s.maxReHt=Math.max(null!==(r=s.maxReHt)&&void 0!==r?r:0,null!==(t=t.height)&&void 0!==t?t:0)}}_isIFrameToggle(e,t){e=Math.abs(e),t=Math.abs(t);return e!==t&&(1<e||1<t)&&!(1<e&&1<t)}_isBadSw(e,t,i,r,n,a,s){let o=a&&t&&(!0===r||!1===r)&&n-a<1e4&&t!==e&&r===i&&!s?!0:!1;return o}_aggregateTimes(e){var t,i,r,n,e=this.getEntity(e);if(e){const{sessionControlRecord:a,playStalledRecord:s,mediaEngineStalledRecord:o,switchCompleteRecord:l,playRateChangedRecord:d,variantEndedRecord:u,playErrorRecord:c,nwErrorRecord:h,periodicRecord:p,playEndedRecord:m}=e,f=performance.now()-a.eventStartTime;switch(a.state){case"RTC_STATE_INIT":p.InitTime=(null!==(t=p.InitTime)&&void 0!==t?t:0)+f,m.InitTime=(null!==(t=m.InitTime)&&void 0!==t?t:0)+f;break;case"RTC_STATE_CANPLAY":p.InitTime=(null!==(t=p.InitTime)&&void 0!==t?t:0)+f,m.InitTime=(null!==(t=m.InitTime)&&void 0!==t?t:0)+f;break;case"RTC_STATE_PAUSE":p.PauseTime=(null!==(i=p.PauseTime)&&void 0!==i?i:0)+f,m.PauseTime=(null!==(i=m.PauseTime)&&void 0!==i?i:0)+f,d.LastPause=(null!==(i=d.LastPause)&&void 0!==i?i:0)+f,m.LastPause=(null!==(i=m.LastPause)&&void 0!==i?i:0)+f,c.LastPause=(null!==(i=c.LastPause)&&void 0!==i?i:0)+f,h.LastPause=(null!==(i=h.LastPause)&&void 0!==i?i:0)+f;break;case"RTC_STATE_STALL":u.StallTime=(null!==(i=u.StallTime)&&void 0!==i?i:0)+f,p.StallTime=(null!==(i=p.StallTime)&&void 0!==i?i:0)+f,m.StallTime=(null!==(i=m.StallTime)&&void 0!==i?i:0)+f,d.LastStall=(null!==(i=d.LastStall)&&void 0!==i?i:0)+f,c.LastStall=(null!==(i=c.LastStall)&&void 0!==i?i:0)+f,m.LastStall=(null!==(i=m.LastStall)&&void 0!==i?i:0)+f;break;case"RTC_STATE_MEDIAENGINESTALL":u.MediaEngineStallTime=(null!==(r=u.MediaEngineStallTime)&&void 0!==r?r:0)+f,p.MediaEngineStallTime=(null!==(r=p.MediaEngineStallTime)&&void 0!==r?r:0)+f,m.MediaEngineStallTime=(null!==(r=m.MediaEngineStallTime)&&void 0!==r?r:0)+f,d.LastMediaEngineStall=(null!==(r=d.LastMediaEngineStall)&&void 0!==r?r:0)+f,c.LastMediaEngineStall=(null!==(r=c.LastMediaEngineStall)&&void 0!==r?r:0)+f,m.LastMediaEngineStall=(null!==(r=m.LastMediaEngineStall)&&void 0!==r?r:0)+f;break;case"RTC_STATE_NWERROR":m.NwErrTime=(null!==(r=m.NwErrTime)&&void 0!==r?r:0)+f,p.NwErrTime=(null!==(r=p.NwErrTime)&&void 0!==r?r:0)+f;break;case"RTC_STATE_PLAYERROR":p.PlayErrTime=(null!==(n=p.PlayErrTime)&&void 0!==n?n:0)+f,m.PlayErrTime=(null!==(n=m.PlayErrTime)&&void 0!==n?n:0)+f;break;case"RTC_STATE_PLAY":{d.RateChangePlayTime=(null!==(n=d.RateChangePlayTime)&&void 0!==n?n:0)+f,l.PlayTime=(null!==(n=l.PlayTime)&&void 0!==n?n:0)+f,l.PlayTimeLastSW=(null!==(n=l.PlayTimeLastSW)&&void 0!==n?n:0)+f*(a.oldRate/100),s.LastResume=(null!==(n=s.LastResume)&&void 0!==n?n:0)+f,o.LastResume=(null!==(n=o.LastResume)&&void 0!==n?n:0)+f,c.LastResume=(null!==(n=c.LastResume)&&void 0!==n?n:0)+f,h.LastResume=(null!==(n=h.LastResume)&&void 0!==n?n:0)+f;const g=(null!==(n=s.StallDetectionTime)&&void 0!==n?n:0)+(null!==(n=o.StallDetectionTime)&&void 0!==n?n:0);u.VarPlayTimeWC=(null!==(n=u.VarPlayTimeWC)&&void 0!==n?n:0)+f-g,u.VarPlayTime=(null!==(n=u.VarPlayTime)&&void 0!==n?n:0)+f*(a.oldRate/100)-g,p.PlayTimeWC=(null!==(n=p.PlayTimeWC)&&void 0!==n?n:0)+f-g,p.PlayTime=(null!==(n=p.PlayTime)&&void 0!==n?n:0)+f*(a.oldRate/100)-g,m.PlayTimeWC=(null!==(n=m.PlayTimeWC)&&void 0!==n?n:0)+f-g,m.PlayTime=(null!==(n=m.PlayTime)&&void 0!==n?n:0)+f*(a.oldRate/100)-g,o.PlayTime=m.PlayTime,s.PlayTime=m.PlayTime;const y=a.curLevelUrl;if(y&&a.intervalVariantList&&a.sessionVariantList){const g=a.intervalVariantList[y];if(!g)break;g.playTime=(null!==(n=g.playTime)&&void 0!==n?n:0)+f;break}break}}}}}const Jp={name:"rtc-service"};class Zp{constructor(e,t,i,r,n,a){this.hls=e,this.config=t,this.hlsjsVersion=i,this.accessLog=r,this.logger=n,this.getLogs=a,this.destroy$=new Er,this.isSeeking=!1,this.seekStart=null,this.seekStartPos=0,this.playStart=Number.NEGATIVE_INFINITY,this.oldRate=0,this.newRate=0,this.periodicInterval=t.rtcIntervalTimeout||3e5,this.intervalFunc=null,this.rtcStore=new Xp(this.logger),this.rtcQuery=new Yp(this.rtcStore,this.logger),this.rtcComponent=new Wp(this.rtcQuery,this.logger,this.config),r.setRTCQuery(this.rtcQuery)}destroy(){this.destroy$.next(),this.clearPeriodic(),this.rtcStore.resetStore()}detachMedia(){this.clearPeriodic();try{var e=this.rtcEventItemId(!0);this.closeRTCSession(e)}catch(e){}}endItem(e,t,i){this.clearPeriodic(),this.closeRTCSession(e),this.rtcStore.removeEntityByID(e)}handleFatalError(e,t,i){var r,n=this.config.rtcErrStackNumLines?e.stack:void 0,i={fatal:!0,details:e.details,code:null===(r=e.response)||void 0===r?void 0:r.code,forInterstitial:t,currentTime:null!==(t=this.hls.realCurrentTime)&&void 0!==t?t:void 0,domain:e.type,stack:!(0<(t=this.config.rtcErrStackNumLines))||null==n?void 0:n.split("\n").slice(0,t).join("\n"),logs:function(e,i){if(e&&0!==e.length&&!(void 0!==i&&i<=0)){const r=new Date(e[0].timestampMs).getTime();return e.map(e=>{const t=JSON.stringify(e.messages);return JSON.stringify([new Date(e.timestampMs).getTime()-r,t.slice(0,i),e.level,+(void 0!==i&&t.length>i)])}).join("\n")}}(null===(t=this.getLogs)||void 0===t?void 0:t.call(this),this.config.rtcLogHistoryMaxLineLength),contentUrl:i};e.type===U.NETWORK_ERROR?(this.rtcStore.updateNwError(this.rtcEventItemId(),i),this.sendAndFinalize(this.rtcEventItemId(),Gp.NwError)):(this.rtcStore.updateMediaError(this.rtcEventItemId(),i),this.sendAndFinalize(this.rtcEventItemId(),Gp.PlayError)),(this.config.rtcErrStackNumLines||this.config.rtcLogHistoryNumLines)&&(this.rtcStore.updateDebugInfo(this.rtcEventItemId(),i),this.sendAndFinalize(this.rtcEventItemId(),Gp.DebugInfo))}handleMediaElementError(e,t){this.rtcStore.updateMediaElementError(this.rtcEventItemId(),e,t),this.sendAndFinalize(this.rtcEventItemId(),Gp.PlayError)}handleNonFatalError(e,t){var i;e.type===U.NETWORK_ERROR?this.rtcStore.updateNwError(this.rtcEventItemId(),{fatal:!1,details:e.details,code:null===(i=e.response)||void 0===i?void 0:i.code,forInterstitial:t,currentTime:null!==(i=this.hls.realCurrentTime)&&void 0!==i?i:void 0}):this.rtcStore.updateMediaError(this.rtcEventItemId(),{fatal:!1,details:e.details,code:null===(e=e.response)||void 0===e?void 0:e.code,forInterstitial:t,currentTime:null!==(t=this.hls.realCurrentTime)&&void 0!==t?t:void 0})}handleFragLoaded(e,t,i){var r;this.checkMediaOptionType(t.mediaOptionType)&&(this.rtcStore.updateFragLoaded(e,{fragType:t.mediaOptionType,duration:t.duration,stats:i,serverInfo:null!==(r=this.serverInfoInstance)&&void 0!==r?r:{}}),this.accessLog.updateFragLoaded(e,this.isSeeking,{fragType:t.mediaOptionType,bytes:i.loaded,duration:t.duration,adt:i.tload-i.trequest,processTime:i.tload-i.tfirst,startPTS:t.start,endPTS:t.start+t.duration}))}handleFragParsed(e){this.rtcStore.updateFragParsed(this.rtcEventItemId(),e)}handleFragBuffered(t){if(this.checkMediaOptionType(t.fragmentType)){let e=0;t.endDataAppend&&t.startDataAppend&&(e=t.endDataAppend-t.startDataAppend);var i=t.fragmentType,t=t.dataBytesAppend;void 0!==i&&void 0!==t&&this.rtcStore.updateFragBuffered(this.rtcEventItemId(),{fragType:i,bytes:t,parseTime:e})}}handleLevelLoaded(e,t,i){if(t&&t.mediaOptionType===Ys.Variant){const e=t.url,r=t.targetduration||0,n=t.totalduration||0;e&&this.rtcStore.updateLevelLoaded(this.rtcEventItemId(),{url:e,targetduration:r,totalduration:n,stats:i,playType:t.type})}}handleLevelParsed(e){this.rtcStore.updateLevelParsed(this.rtcEventItemId(),e)}handleLevelLoadError(e,t){this.rtcStore.updateLevelLoadError(this.rtcEventItemId(),{url:e,mediaDur:this.hls.bufferedDuration,isSeeking:this.isSeeking,forInterstitial:t,currentTime:null!==(t=this.hls.realCurrentTime)&&void 0!==t?t:void 0}),this.sendAndFinalize(this.rtcEventItemId(),Gp.SwitchComplete)}handleLevelSwitched(e,t){var i={url:e.url,isSeeking:this.isSeeking,mediaDur:this.hls.bufferedDuration,currentTime:null!==(i=this.hls.realCurrentTime)&&void 0!==i?i:void 0,forInterstitial:t};e.oldVariant&&(this.rtcStore.updateVariantEnd(this.rtcEventItemId(),{currentTime:null!==(e=this.hls.realCurrentTime)&&void 0!==e?e:void 0,forInterstitial:t}),this.sendAndFinalize(this.rtcEventItemId(),Gp.VariantEnded)),this.rtcStore.updateLevelSwitched(this.rtcEventItemId(),i),this.sendAndFinalize(this.rtcEventItemId(),Gp.SwitchComplete)}handleLevelSwitching(e){this.levelSwitchingUrl=e}handleLevelsChanged(e){this.rtcStore.updateLevelsChanged(this.rtcEventItemId(),{levels:e})}handleManifestParsed(e){var t=e.stats.tload-e.stats.trequest;this.rtcStore.updateManifestParsed(this.rtcEventItemId(),{levels:e.levels,adt:t,tparsed:e.stats.tparsed,contentType:e.stats.contentType,isAudioOnly:this.hls.inGaplessMode,isGapless:this.hls.inGaplessMode,isFirstItem:this.hls.isFirstItem,itemID:((null===(e=this.hls.reportingAgent)||void 0===e?void 0:e.SessionID)||ba())+"-"+this.rtcEventItemId(),forInterstitial:this.hls.interstitialActive}),this.rtcEventItemId()}handleSeek(e,t=null,i=[]){if("SEEKING"===e&&t)this.isSeeking=!0,this.seekStart=performance.now(),this.rtcStore.updateSeek(this.rtcEventItemId(!0),t,i),this.rtcStore.updateWaitForCanPlay(this.rtcEventItemId(!0));else if("SEEKED"===e){this.isSeeking=!1;let e=0;this.seekStart&&(e=performance.now()-this.seekStart),this.seekStart=null,this.rtcStore.updateSeeked(this.rtcEventItemId(!0),{latency:e}),this.sendAndFinalize(this.rtcEventItemId(!0),Gp.SeekComplete)}}handleDesiredRateChanged(e,t){var i;if(0===t||1<Math.abs(e)&&1<Math.abs(t)){const e=null!==(i=this.hls.bufferedDuration)&&void 0!==i?i:0,r=null!==(i=this.hls.realCurrentTime)&&void 0!==i?i:0;this.levelSwitchingUrl&&(this.rtcStore.updateRateChanged(this.rtcEventItemId(!0),{rate:t,latency:0,mediaDur:e,currentTime:r,url:this.levelSwitchingUrl,forInterstitial:this.hls.interstitialActive}),this.sendAndFinalize(this.rtcEventItemId(!0),Gp.PlayRateChanged))}else 1!==e&&1===t&&(this.playStart=performance.now()),this.rtcStore.updateWaitForCanPlay(this.rtcEventItemId(!0));this.oldRate=e,this.newRate=t}handleBufferAppended(e){z(e.startAppend)&&z(e.endAppend)&&this.rtcStore.updateBufferAppended(this.rtcEventItemId(),e)}handleStalled(e,t,i){var t={type:e.type,stallDurationMs:e.stallDurationMs,bufferLen:t,mediaDur:this.hls.bufferedDuration,currentTime:null!==(r=this.hls.realCurrentTime)&&void 0!==r?r:void 0,forInterstitial:i},r=this.rtcEventItemId(!0);!r||(i=null===(i=this.rtcQuery)||void 0===i?void 0:i.entity(r))&&(this.rtcStore.updateWaitForCanPlay(r),i=i.sessionControlRecord.state,e.type===$u.LowBuffer||e.type===$u.Seek&&e.isLowBufferStall?"RTC_STATE_PLAY"===i&&(this.rtcStore.updateBufferStalled(this.rtcEventItemId(!0),t),this.sendAndFinalize(this.rtcEventItemId(!0),Gp.PlayStalled)):"RTC_STATE_PLAY"===i&&(this.rtcStore.updateMediaEngineStalled(this.rtcEventItemId(!0),t),this.sendAndFinalize(this.rtcEventItemId(!0),Gp.MediaEngineStalled)))}handlePlaybackInfo(e,t,i,r){this.rtcStore.updatePlaybackInfo(this.rtcEventItemId(!0),{droppedVideoFrames:e,decodedFrameCount:t,liveEdgeDistance:i,bufferedRangeTuple:r}),this.accessLog.updatePlaybackInfo(this.rtcEventItemId(!0),{droppedVideoFrames:e,decodedFrameCount:t})}checkMediaOptionType(e){return void 0!==e&&(e===Ys.Variant||e===Ys.AltAudio||(this.logger.error(Jp,'Should not have media option type = "%s" in RTC',Mo[e]),!1))}rtcEventItemId(e=!1,t=!1){var i;let r=this.hls.currentItem;return this.hls.isPreloading&&(r=e?this.hls.playingItem:this.hls.loadingItem),null==r?null:!t&&null!==(i=r.parentItemId)&&void 0!==i?i:r.itemId}itemTransitioned(e,t){this.closeRTCSession(e),this.setPeriodic(t)}removeItemList(e){e.forEach(e=>{this.rtcStore.removeEntityByID(e)})}keyRequestStarted(e,t){e.timestamp=performance.now(),e.forInterstitial=t,this.rtcStore.updateLicenseChallengeRequested(this.rtcEventItemId(),e)}keyLoaded(e,t){e.timestamp=performance.now(),e.currentTime=this.hls.realCurrentTime,e.forInterstitial=t,this.rtcStore.updateKeyLoaded(this.rtcEventItemId(),e),this.sendAndFinalize(this.rtcEventItemId(),Gp.KeySessionComplete)}licenseChallengeReceived(e){this.rtcStore.updateLicenseChallengeReceived(this.rtcEventItemId(),{timestamp:performance.now(),keyuri:e.keyuri})}licenseChallengeSubmitted(e){this.rtcStore.updateLicenseChallengeSubmitted(this.rtcEventItemId(),{timestamp:performance.now(),keyFormat:e.keyFormat,keyuri:e.keyuri})}licenseChallengeCreated(e){this.rtcStore.updateLicenseChallengeCreated(this.rtcEventItemId(),{timestamp:performance.now(),cdmVersion:e.cdmVersion,keyuri:e.keyuri}),this.rtcStore.updateLicenseResponseRequested(this.rtcEventItemId(),{timestamp:performance.now(),keyuri:e.keyuri})}licenseResponseSubmitted(e){this.rtcStore.updateLicenseResponseReceived(this.rtcEventItemId(),{timestamp:performance.now(),keyuri:e.keyuri}),this.rtcStore.updateLicenseResponseSubmitted(this.rtcEventItemId(),{timestamp:performance.now(),keyuri:e.keyuri})}licenseResponseProcessed(e){this.rtcStore.updateLicenseResponseProcessed(this.rtcEventItemId(),{timestamp:performance.now(),keyuri:e.keyuri,currentTime:null!==(e=this.hls.realCurrentTime)&&void 0!==e?e:void 0})}licenseChallengeError(e){this.rtcStore.updateLicenseChallengeError(this.rtcEventItemId(),{timestamp:performance.now(),keyuri:e.keyuri})}licenseResponseError(e){this.rtcStore.updateLicenseResponseError(this.rtcEventItemId(),{timestamp:performance.now(),keyuri:e.keyuri})}keyAborted(e){var t,i=this.rtcEventItemId();!i||(i=null===(t=this.rtcQuery)||void 0===t?void 0:t.entity(i))&&i.sessionControlRecord.activeKeySessions&&null!=i.sessionControlRecord.activeKeySessions[e.keyuri]&&(this.rtcStore.updateKeyAborted(this.rtcEventItemId(),{timestamp:performance.now(),keyuri:e.keyuri}),this.sendAndFinalize(this.rtcEventItemId(),Gp.KeySessionComplete))}keyErrorThrown(e){var t,i=this.rtcEventItemId();!i||(i=null===(t=this.rtcQuery)||void 0===t?void 0:t.entity(i))&&i.sessionControlRecord.activeKeySessions&&null!=i.sessionControlRecord.activeKeySessions[e.keyuri]&&(this.rtcStore.updateKeyErrorThrown(this.rtcEventItemId(),e),this.sendAndFinalize(this.rtcEventItemId(),Gp.KeySessionComplete))}setPeriodic(e){this.clearPeriodic(),this.intervalFunc=setInterval(this.handlePeriodic.bind(this,e),this.periodicInterval)}interstitialStarted(e){this.sendAndFinalize(e,Gp.InterstitialStarted)}interstitialAssetStarted(e){this.sendAndFinalize(e,Gp.InterstitialAssetStarted)}interstitialAssetEnded(e,t){this.rtcStore.updateInterstitialPlayTime(e,t),this.sendAndFinalize(e,Gp.InterstitialAssetEnded)}interstitialEnded(e){this.sendAndFinalize(e,Gp.InterstitialEnded)}handlePeriodic(e){var t;this.flushNonFatalErrors(e),this.rtcStore.updatePeriodic(e,null!==(t=this.hls.realCurrentTime)&&void 0!==t?t:void 0,!1),this.sendAndFinalize(e,Gp.Periodic)}clearPeriodic(){this.intervalFunc&&clearInterval(this.intervalFunc),this.intervalFunc=null}flushNonFatalErrors(e){for(;this.rtcStore.prepareNonFatalNwError(e);)this.rtcComponent.sendNwError(e);for(;this.rtcStore.prepareNonFatalPlayError(e);)this.rtcComponent.sendPlayError(e)}closeRTCSession(e){var t;e&&(this.rtcStore.updateVariantEnd(e,{currentTime:null!==(t=this.hls.realCurrentTime)&&void 0!==t?t:void 0,forInterstitial:this.hls.interstitialActive}),this.sendAndFinalize(e,Gp.VariantEnded),this.flushNonFatalErrors(e),this.rtcStore.updatePeriodic(e,null!==(t=this.hls.realCurrentTime)&&void 0!==t?t:void 0,!0),this.sendAndFinalize(e,Gp.Periodic),this.rtcStore.updateEnded(e,null!==(t=this.hls.realCurrentTime)&&void 0!==t?t:void 0),this.sendAndFinalize(e,Gp.PlayEnded))}sendAndFinalize(e,t){if(e){switch(this.accessLog.addPlayTime(e),t){case Gp.PlayEnded:this.rtcComponent.sendPlayEnded(e);break;case Gp.Periodic:this.rtcComponent.sendPeriodic(e);break;case Gp.PlayStalled:this.accessLog.updateStallCount(e),this.rtcComponent.sendPlayStalled(e);break;case Gp.KeySessionComplete:this.rtcComponent.sendKeySessionComplete(e);break;case Gp.PlayLikelyToKeepUp:this.accessLog.updateCanPlay(e),this.rtcComponent.sendPlayLikelyToKeepUp(e);break;case Gp.PlayRateChanged:this.rtcComponent.sendPlayRateChange(e);break;case Gp.PlayError:this.accessLog.addToErrorLog(e,"mediaError"),this.rtcComponent.sendPlayError(e);break;case Gp.MediaEngineStalled:this.accessLog.updateMediaEngineStallCount(e),this.rtcComponent.sendMediaEngineStalled(e);break;case Gp.SwitchComplete:this.accessLog.addToAccessLog(e),this.rtcComponent.sendSwitchComplete(e);break;case Gp.SeekComplete:this.rtcComponent.sendSeekComplete(e);break;case Gp.VariantEnded:this.rtcComponent.sendVariantEnded(e);break;case Gp.NwError:this.accessLog.addToErrorLog(e,"networkError"),this.rtcComponent.sendNwError(e);break;case Gp.DebugInfo:this.rtcComponent.sendDebugInfo(e);break;case Gp.InterstitialStarted:this.rtcComponent.sendInterstitialStart(e);break;case Gp.InterstitialAssetStarted:this.rtcComponent.sendInterstitialAssetStart(e);break;case Gp.InterstitialAssetEnded:this.rtcComponent.sendInterstitialAssetEnd(e);break;case Gp.InterstitialEnded:this.rtcComponent.sendInterstitialEnd(e);break;default:return void this.logger.error(Jp,`Unknown rtc event eventGroupId:${e}`)}this.rtcStore.finalize(e,t)}}}const em=s=>(e,t,i)=>{let r=0,n=0;for(const{timestamp:i,value:a}of e){const e=Math.pow(Math.max(0,i-t)/1e3,s);r+=e*a,n+=e}return r/n},tm={"uniform-time-weighted":em(0),"linear-time-weighted":em(1),"quadratic-time-weighted":em(2),"quadratic-window-weighted":(e,t,i)=>{let r=0,n=0;for(var{timestamp:a,value:s,duration:o}of e){const e=Math.pow(Math.max(0,a-t)/1e3,2)*o/i;r+=e*s,n+=e}return r/n}};function im(e,t){return e.start!==t.start?e.start-t.start:e.end-t.end}function rm(e,t,i){let r=e.length-1;for(;0<=r&&i(t,e[r])<=0;)--r;e.splice(r+1,0,t)}class nm{constructor(e,t="quadratic-time-weighted",i={avgLatencyMs:NaN,avgBandwidth:NaN}){this.windowSize=e,this.aggregationMethod=t,this.latencyEntries=[],this.bandwidthEntries=[],this.minEntries=1,this.cleanUpExpiredEntries=this.cleanUpExpiredEntries.bind(this),this.bwSubject=new qr(i)}get estimate$(){return this.bwSubject.asObservable()}record(e){var{trequest:t,tfirst:i,tload:r,bitsDownloaded:e}=e;t!==r&&i!==r&&(this.recordLatency(t,i),this.recordBandwidth(i,r,1e3*e/(r-i)),this.bwSubject.closed||(i=this.getEstimate(),this.bwSubject.next(i)))}getEstimate(){if(this.latencyEntries.length<this.minEntries)return{avgLatencyMs:NaN,avgBandwidth:NaN};const e=performance.now()-this.windowSize,t=tm[this.aggregationMethod],i=this.latencyEntries.map(({start:e,end:t})=>{e=t-e;return{timestamp:t,value:e,duration:e}});this.bandwidthEntries=function(r){function n(t,i){if(t.length){for(let e=0;e<t.length;e++)if(t[e].start>i.start||t[e].start===i.start&&t[e].end>i.end){t.splice(e,0,i);break}}else t.push(i)}const t=[];for(;r.length;){const o=r[0];r.shift();let e={start:-1,end:-1,bitsPerSec:0};if(t.length&&(e=t[t.length-1]),0===t.length||e.end<=o.start)t.push(o);else if(o.start===e.start)o.end===e.end?e.bitsPerSec+=o.bitsPerSec:o.end<e.end||(e.bitsPerSec+=o.bitsPerSec,o.start=e.end,n(r,o));else{var a=e.end,s=e.bitsPerSec;e.end=o.start;var i={start:o.start,end:Math.min(a,o.end),bitsPerSec:o.bitsPerSec+s};if(t.push(i),a!==o.end){let e=0,t=0,i=0;i=a<o.end?(e=a,t=o.end,o.bitsPerSec):(e=o.end,t=a,s),n(r,{start:e,end:t,bitsPerSec:i})}}}return t}(this.bandwidthEntries);var r=this.bandwidthEntries.map(({start:e,end:t,bitsPerSec:i})=>({timestamp:t,duration:t-e,value:i}));return{avgLatencyMs:t(i,e,this.windowSize),avgBandwidth:t(r,e,this.windowSize)}}getLatest(){if(0===this.latencyEntries.length)return{avgLatencyMs:NaN,avgBandwidth:NaN};var e=this.latencyEntries[this.latencyEntries.length-1],t=this.bandwidthEntries[this.bandwidthEntries.length-1];return{avgLatencyMs:e.end-e.start,avgBandwidth:t.bitsPerSec}}recordLatency(e,t){rm(this.latencyEntries,{start:e,end:t},im),this.updateCleanupTimeout(t)}recordBandwidth(e,t,i){rm(this.bandwidthEntries,{start:e,end:t,bitsPerSec:i},im),this.updateCleanupTimeout(t)}setCleanupTimeout(e){this.cleanupTimeout=setTimeout(this.cleanUpExpiredEntries,Math.max(e-performance.now(),0)),this.cleanupTimestamp=e}clearCleanupTimeout(){void 0!==this.cleanupTimeout&&(clearTimeout(this.cleanupTimeout),this.cleanupTimeout=void 0),this.cleanupTimestamp=void 0}updateCleanupTimeout(e){e+=this.windowSize;(!this.cleanupTimestamp||e<this.cleanupTimestamp)&&(this.clearCleanupTimeout(),this.setCleanupTimeout(e))}cleanUpExpiredEntries(){this.clearCleanupTimeout();const t=performance.now()-this.windowSize;if(this.latencyEntries=this.latencyEntries.filter(e=>e.end>=t),this.bandwidthEntries=this.bandwidthEntries.filter(e=>e.end>=t),this.bwSubject.closed||this.bwSubject.next(this.getEstimate()),0<this.latencyEntries.length||0<this.bandwidthEntries.length){const t=Math.min(...this.latencyEntries.map(e=>e.end),...this.bandwidthEntries.map(e=>e.end));this.updateCleanupTimeout(t)}}destroy(){this.clearCleanupTimeout()}}const am={setCombinedEstimate:function(t,i,e,r){if(void 0!==t.storage.set){var n=t.bandwidthHistoryStorageKey,a={avgLatencyMs:i.avgLatencyMs,avgBandwidth:i.avgBandwidth},a=Object.assign({},a,{expires:Date.now()+t.bandwidthHistoryTTL});try{t.storage.set(n,JSON.stringify(a))}catch(t){}i={maxDuration:i.maxDurationSec,avgFragParseTimeMs:i.avgParseTimeMs,avgFragBufferCreationDelayMs:i.avgBufferCreateMs,avgPlaylistLoadTimeMs:i.avgPlaylistLoadTimeMs,avgPlaylistParseTimeMs:i.avgPlaylistParseTimeMs,avgInitFragAppendMs:i.avgInitFragAppendMs,avgDataFragAppendMs:i.avgDataFragAppendMs};let e=t.storageKeyPrefix;r&&(e+=r);try{t.storage.set(e,JSON.stringify(i))}catch(t){}}},getCombinedEstimate:function(t,i,e){let r={};if(void 0===t.storage.get)return this.convertStorageJsonToCombinedEstimate(r);try{const i=t.storage.get(t.bandwidthHistoryStorageKey);let e=i?JSON.parse(i):null;e=null!=e&&e.expires&&e.expires<Date.now()?null:{avgLatencyMs:null==e?void 0:e.avgLatencyMs,avgBandwidth:null==e?void 0:e.avgBandwidth},r=Object.assign(Object.assign({},r),e)}catch(t){}let n=t.storageKeyPrefix;e&&(n+=e);try{const i=t.storage.get(n),e=i?JSON.parse(i):null;r=Object.assign(Object.assign({},r),e)}catch(t){}return this.convertStorageJsonToCombinedEstimate(r)},convertStorageJsonToCombinedEstimate:function(e){return{avgLatencyMs:(null==e?void 0:e.avgLatencyMs)||NaN,avgBandwidth:(null==e?void 0:e.avgBandwidth)||NaN,maxDurationSec:(null==e?void 0:e.maxDuration)||NaN,avgParseTimeMs:(null==e?void 0:e.avgFragParseTimeMs)||NaN,avgBufferCreateMs:(null==e?void 0:e.avgFragBufferCreationDelayMs)||NaN,avgPlaylistLoadTimeMs:(null==e?void 0:e.avgPlaylistLoadTimeMs)||NaN,avgPlaylistParseTimeMs:(null==e?void 0:e.avgPlaylistParseTimeMs)||NaN,avgInitFragAppendMs:(null==e?void 0:e.avgInitFragAppendMs)||NaN,avgDataFragAppendMs:(null==e?void 0:e.avgDataFragAppendMs)||NaN}},getBandwidthEstimate:function(e,t,i){const r=this.getCombinedEstimate(e,t,i),n={avgLatencyMs:null==r?void 0:r.avgLatencyMs,avgBandwidth:null==r?void 0:r.avgBandwidth};return z(n.avgLatencyMs)||(n.avgLatencyMs=NaN),z(n.avgBandwidth)||(n.avgBandwidth=NaN),n},getPlaylistEstimate:function(e,t,i){const r=this.getCombinedEstimate(e,t,i),n={avgPlaylistLoadTimeMs:null==r?void 0:r.avgPlaylistLoadTimeMs,avgPlaylistParseTimeMs:null==r?void 0:r.avgPlaylistParseTimeMs};return z(n.avgPlaylistLoadTimeMs)||(n.avgPlaylistLoadTimeMs=NaN),z(n.avgPlaylistParseTimeMs)||(n.avgPlaylistParseTimeMs=NaN),n},getFragEstimate:function(e,t,i){const r=this.getCombinedEstimate(e,t,i),n={maxDurationSec:null==r?void 0:r.maxDurationSec,avgParseTimeMs:null==r?void 0:r.avgParseTimeMs};return z(n.maxDurationSec)||(n.maxDurationSec=NaN),z(n.avgParseTimeMs)||(n.avgParseTimeMs=NaN),n},getBufferEstimate:function(e,t,i){const r=this.getCombinedEstimate(e,t,i),n={avgBufferCreateMs:null==r?void 0:r.avgBufferCreateMs,avgInitFragAppendMs:null==r?void 0:r.avgInitFragAppendMs,avgDataFragAppendMs:null==r?void 0:r.avgDataFragAppendMs};return z(n.avgBufferCreateMs)||(n.avgBufferCreateMs=NaN),z(n.avgInitFragAppendMs)||(n.avgInitFragAppendMs=NaN),z(n.avgDataFragAppendMs)||(n.avgDataFragAppendMs=NaN),n}};var sm,om,lm,dm,um,cm,hm=am;class pm{constructor(e=0){this._minSamples=e,this._sum=0,this._max=Number.NEGATIVE_INFINITY,this._numSamples=0}get avg(){return this._numSamples<this._minSamples?NaN:this._sum/this._numSamples}get max(){return 0<this.count?this._max:NaN}get count(){return this._numSamples}reset(){this._sum=0,this._numSamples=0,this._max=Number.NEGATIVE_INFINITY}add(e){this._sum+=e,this._max=Math.max(this._max,e),++this._numSamples}}class mm extends Sa{constructor(e,t,i){super(e),this.id=t,this.logger=i}getBandwidthEstimate(e,t,i=!0){var r;const n=null!==(r=Object.assign({},null===(r=this.statsEntity)||void 0===r?void 0:r.bandwidthEstimate))&&void 0!==r?r:{};return z(n.avgBandwidth)&&z(n.avgLatencyMs)?{avgBandwidth:n.avgBandwidth,avgLatencyMs:n.avgLatencyMs}:null!=e&&e.storage&&i?a(n,am.getBandwidthEstimate(e,this.logger,t)):(n.avgBandwidth=NaN,n.avgLatencyMs=NaN,{avgBandwidth:n.avgBandwidth,avgLatencyMs:n.avgLatencyMs})}getPlaylistEstimate(e,t,i=!0){let r=null!==(n=Object.assign({},null===(n=this.statsEntity)||void 0===n?void 0:n.playlistEstimate))&&void 0!==n?n:{};var n=e=>z(e.avgPlaylistLoadTimeMs)&&z(e.avgPlaylistParseTimeMs);if(n(r))return r;if(null!=e&&e.storage&&i){const i=a(r,am.getPlaylistEstimate(e,this.logger,t));if(n(i))return i}if(null!=e&&e.statDefaults){const t=e.statDefaults;r=a(r,{avgPlaylistLoadTimeMs:t.playlistLoadTimeMs,avgPlaylistParseTimeMs:t.playlistParseTimeMs})}return r}getBufferEstimate(e,t,i=!0){let r=null!==(n=Object.assign({},null===(n=this.statsEntity)||void 0===n?void 0:n.bufferEstimate))&&void 0!==n?n:{};var n=e=>z(e.avgBufferCreateMs)&&z(e.avgDataFragAppendMs)&&z(e.avgInitFragAppendMs);if(n(r))return r;if(null!=e&&e.storage&&i){const i=a(r,am.getBufferEstimate(e,this.logger,t));if(n(i))return i}if(null!=e&&e.statDefaults){const t=e.statDefaults;r=a(r,{avgBufferCreateMs:t.fragBufferCreationDelayMs,avgInitFragAppendMs:t.initFragAppendMs,avgDataFragAppendMs:t.dataFragAppendMs})}return r}getFragEstimate(e,t,i=!0){let r=null!==(n=Object.assign({},null===(n=this.statsEntity)||void 0===n?void 0:n.fragEstimate))&&void 0!==n?n:{};var n=e=>z(e.maxDurationSec)&&z(e.avgParseTimeMs);if(n(r))return r;if(null!=e&&e.storage&&i){const i=a(r,am.getFragEstimate(e,this.logger,t));if(n(i))return i}return null!=e&&e.statDefaults&&(r=a(r,{avgParseTimeMs:e.statDefaults.fragParseTimeMs,maxDurationSec:e.defaultTargetDuration})),r}getCombinedEstimate(e,t,i=!0){return Object.assign(Object.assign(Object.assign(Object.assign({},this.getFragEstimate(e,t,i)),this.getPlaylistEstimate(e,t,i)),this.getBufferEstimate(e,t,i)),this.getBandwidthEstimate(e,t,i))}get statsEntity(){return this.getEntity(this.id)}get bandwidthSample(){var e;return null===(e=this.statsEntity)||void 0===e?void 0:e.bandwidthSample}get bandwidthStatus(){var e;return null!==(e=null===(e=this.statsEntity)||void 0===e?void 0:e.bandwidthStatus)&&void 0!==e?e:{bandwidthSampleCount:0,instantBw:0}}get initFragSample(){var e;return null===(e=this.statsEntity)||void 0===e?void 0:e.initFragSample}get fragSample(){var e;return null===(e=this.statsEntity)||void 0===e?void 0:e.fragSample}get playlistSample(){var e;return null===(e=this.statsEntity)||void 0===e?void 0:e.playlistSample}get bandwidthEstimate$(){return this.selectEntity(this.id,"bandwidthEstimate").pipe(_d())}get fragEstimate$(){return this.selectEntity(this.id,"fragEstimate").pipe(_d())}get playlistEstimate$(){return this.selectEntity(this.id,"playlistEstimate").pipe(_d())}get bufferEstimate$(){return this.selectEntity(this.id,"bufferEstimate").pipe(_d())}combinedEstimate$(e,t){return ur([this.bandwidthEstimate$.pipe(sn(this.getBandwidthEstimate(e,t))),this.fragEstimate$.pipe(sn(this.getFragEstimate(e,t))),this.playlistEstimate$.pipe(sn(this.getPlaylistEstimate(e,t))),this.bufferEstimate$.pipe(sn(this.getBufferEstimate(e,t)))]).pipe(sr(([e,t,i,r])=>Object.assign(Object.assign(Object.assign(Object.assign({},e),t),i),r)))}get bandwidthSample$(){return this.selectEntity(this.id,e=>null==e?void 0:e.bandwidthSample).pipe(_d())}get fragSample$(){return this.selectEntity(this.id,e=>null==e?void 0:e.fragSample).pipe(_d())}get playlistSample$(){return this.selectEntity(this.id,e=>null==e?void 0:e.playlistSample).pipe(_d())}get bufferMetric$(){return this.selectEntity(this.id,e=>null==e?void 0:e.bufferMetric).pipe(_d())}}class fm extends pa{constructor(){super({},{name:"stats-store",resettable:!0})}}class gm{constructor(e,t){this.statsStore=e,this.logger=t,this.queryMap=new Map,this._query=new Sa(e)}getQueryForId(e){let t=this.queryMap.get(e);return t||(t=new mm(this.statsStore,e,this.logger),this.queryMap.set(e,t)),t}remove(e){this.queryMap.delete(e),this.statsStore.remove(e)}removeAll(){this.queryMap.clear(),this.statsStore.remove()}destroy(){this.statsStore.destroy()}setBandwidthSample(t){var i=this._query.getActiveId();if(i){var i=this.getQueryForId(i);if(i){let e=NaN;i=null!==(i=null===(i=i.bandwidthStatus)||void 0===i?void 0:i.bandwidthSampleCount)&&void 0!==i?i:0;t.mediaOptionType===Ys.Variant&&(e=8e3*t.loaded/(t.tload-t.tfirst));i={bandwidthSampleCount:i,instantBw:e};this.statsStore.updateActive({bandwidthSample:t,bandwidthStatus:i})}}}setInitFragSample(e){this.statsStore.updateActive({initFragSample:e})}setFragSample(e){this.statsStore.updateActive({fragSample:e})}setPlaylistSample(e){this.statsStore.updateActive({playlistSample:e})}setBufferMetric(e){this.statsStore.updateActive({bufferMetric:e})}setBandwidthEstimate(e){this.statsStore.updateActive({bandwidthEstimate:e})}setBandWidthStatus(e){this.statsStore.updateActive({bandwidthStatus:e})}setFragEstimate(e){this.statsStore.updateActive({fragEstimate:e})}setPlaylistEstimate(e){this.statsStore.updateActive({playlistEstimate:e})}setBufferEstimate(e){this.statsStore.updateActive({bufferEstimate:e})}setActive(e){this.statsStore.setActive(e)}addEmptyEntity(e){const t={id:e,bandwidthEstimate:{avgLatencyMs:NaN,avgBandwidth:NaN},bandwidthStatus:{bandwidthSampleCount:0,instantBw:NaN},fragEstimate:{maxDurationSec:NaN,avgParseTimeMs:NaN},playlistEstimate:{avgPlaylistLoadTimeMs:NaN,avgPlaylistParseTimeMs:NaN},bufferEstimate:{avgBufferCreateMs:NaN,avgInitFragAppendMs:NaN,avgDataFragAppendMs:NaN}};da(()=>{this.statsStore.add(t),this.statsStore.setActive(t.id)})}}function ym(e,t){if(e===t)return!0;if(!e||!t)return!1;let i=Object.keys(e).length===Object.keys(t).length;for(const r of Object.keys(e))i=i&&(isNaN(e[r])&&isNaN(t[r])||e[r]===t[r]);return i}const vm={"art-lojban":"jbo","en-gb-oed":"en-GB-oxendict","i-ami":"ami","i-bnn":"bnn","i-hak":"hak","i-klingon":"tlh","i-lux":"lb","i-navajo":"nv","i-pwn":"pwn","i-tao":"tao","i-tay":"tay","i-tsu":"tsu","no-bok":"nb","no-nyn":"nn","sgn-be-fr":"sfb","sgn-be-nl":"vgt","sgn-ch-de":"sgg","zh-guoyu":"cmn","zh-hakka":"hak","zh-minnan":"nan","zh-min-nan":"nan","zh-xiang":"hsn"},Sm={afr:"af",aka:"ak",amh:"am",ara:"ar",arg:"an",asm:"as",ava:"av",ave:"ae",aym:"ay",aze:"az",bam:"bm",bel:"be",ben:"bn",bih:"bh",bod:"bo",bos:"bs",bre:"br",bul:"bg",cat:"ca",ces:"cs",cha:"ch",che:"ce",chu:"cu",chv:"cv",cor:"kw",cos:"co",cre:"cr",cym:"cy",dan:"da",deu:"de",div:"dv",dzo:"dz",ell:"el",eng:"en",epo:"eo",est:"et",eus:"eu",ewe:"ee",fao:"fo",fas:"fa",fin:"fi",fra:"fr",fry:"fy",ful:"ff",gla:"gd",gle:"ga",glg:"gl",glv:"gv",grn:"gn",guj:"gu",hat:"ht",heb:"he",her:"hz",hin:"hi",hmo:"ho",hrv:"hr",hun:"hu",hye:"hy",ibo:"ig",ido:"io",iii:"ii",iku:"iu",ile:"ie",ina:"ia",ind:"id",isl:"is",ita:"it",jav:"jv",jpn:"ja",kal:"kl",kan:"kn",kas:"ks",kat:"ka",kau:"kr",kaz:"kk",khm:"km",kik:"ki",kin:"rw",kir:"ky",kom:"kv",kon:"kg",kor:"ko",kua:"kj",kur:"ku",lao:"lo",lat:"la",lav:"lv",lim:"li",lit:"lt",ltz:"lb",lub:"lu",lug:"lg",mah:"mh",mal:"ml",mar:"mr",mkd:"mk",mlg:"mg",mlt:"mt",mol:"mo",mon:"mn",mri:"mi",msa:"ms",mya:"my",nav:"nv",nbl:"nr",nde:"nd",ndo:"ng",nep:"ne",nld:"nl",nno:"nn",nob:"nb",nya:"ny",oci:"oc",oji:"oj",ori:"or",orm:"om",oss:"os",pan:"pa",pli:"pi",pol:"pl",por:"pt",pus:"ps",que:"qu",roh:"rm",ron:"ro",run:"rn",rus:"ru",san:"sa",sin:"si",slk:"sk",slv:"sl",sme:"se",snd:"sd",som:"so",spa:"es",sqi:"sq",srd:"sc",srp:"sr",sun:"su",swa:"sw",swe:"sv",tah:"ty",tam:"ta",tat:"tt",tel:"te",tgk:"tg",tgl:"tl",tha:"th",tir:"ti",ton:"to",tuk:"tk",tur:"tr",uig:"ug",ukr:"uk",urd:"ur",uzb:"uz",ven:"ve",vie:"vi",wln:"wa",yid:"yi",zha:"za",zho:"zh"},Im={in:"id",iw:"he",ji:"yi",jw:"jv",mo:"ro",scc:"sr",scr:"hr",aam:"aas",adp:"dz",aue:"ktz",ayx:"nun",bgm:"bcg",bjd:"drl",ccq:"rki",cjr:"mom",cka:"cmr",cmk:"xch",coy:"pij",cqu:"quh",drh:"mn",gav:"dev",gfx:"vaj",ggn:"gvr",gti:"nyc",guv:"duz",hrr:"jal",ibi:"opa",ilw:"gal",jeg:"oyb",kgc:"tdf",kgh:"kml",koj:"kwv",krm:"bmf",ktr:"dtp",kvs:"gdj",kwq:"yam",kxe:"tvd",kzj:"dtp",kzt:"dtp",lii:"raq",lmm:"rmx",meg:"cir",mst:"mry",mwj:"vaj",myt:"mry",nad:"xny",ncp:"kdz",nnx:"ngv",nts:"pij",oun:"vaj",pcr:"adx",pmc:"huw",pmu:"phr",ppa:"bfy",ppr:"lcq",pry:"prt",puz:"pub",sca:"hle",skk:"oyb",tdu:"dtp",thc:"tpo",thx:"oyb",tie:"ras",tkk:"twm",tlw:"weo",tmp:"tyj",tne:"kak",tsf:"taj",uok:"ema",xba:"cax",xia:"acn",xkh:"waw",xsj:"suj",ybd:"rki",yma:"lrr",ymt:"mtm",yos:"zom",yuu:"yug",asd:"snz",dit:"dif",llo:"ngt",myd:"aog",nns:"nbr",no:"nb",tl:"fil",aju:"jrb",als:"sq",arb:"ar",ayr:"ay",azj:"az",bcc:"bal",bcl:"bik",bxk:"luy",bxr:"bua",cld:"syr",cmn:"zh",cwd:"cr",dgo:"doi",dhd:"mwr",dik:"din",diq:"zza",lbk:"bnc",ekk:"et",emk:"man",esk:"ik",fat:"ak",fuc:"ff",gaz:"om",gbo:"grb",gno:"gon",gug:"gn",gya:"gba",hdn:"hai",hea:"hmn",ike:"iu",kmr:"ku",knc:"kr",kng:"kg",knn:"kok",kpv:"kv",lvs:"lv",mhr:"chm",mup:"raj",khk:"mn",npi:"ne",ojg:"oj",ory:"or",pbu:"ps",pes:"fa",plt:"mg",pnb:"lah",quz:"qu",rmy:"rom",spy:"kln",src:"sc",swh:"sw",ttq:"tmh",tw:"ak",umu:"del",uzn:"uz",xpe:"kpe",xsl:"den",ydd:"yi",zai:"zap",zsm:"ms",zyb:"za",him:"srx",mnk:"man",bh:"bho",aar:"aa",abk:"ab",bak:"ba",bis:"bi",fij:"fj",hau:"ha",ipk:"ik",lat:"la",lin:"ln",nau:"na",nor:"nb",sag:"sg",smo:"sm",sna:"sn",ssw:"ss",sot:"st",tsn:"tn",tso:"ts",twi:"ak",vol:"vo",wol:"wo",xho:"xh",yor:"yo",zul:"zu",alb:"sq",arm:"hy",baq:"eu",bur:"my",chi:"zh",cze:"cs",dut:"nl",fre:"fr",geo:"ka",ger:"de",gre:"el",ice:"is",mac:"mk",mao:"mi",may:"ms",per:"fa",rum:"ro",slo:"sk",tib:"bo",wel:"cy"},bm=[[{lang:"drw"},{lang:"fa",region:"af"}],[{lang:"tnf"},{lang:"fa",region:"af"}],[{lang:"sgn",region:"br"},{lang:"bzs"}],[{lang:"sgn",region:"co"},{lang:"csn"}],[{lang:"sgn",region:"de"},{lang:"gsg"}],[{lang:"sgn",region:"dk"},{lang:"dsl"}],[{lang:"sgn",region:"fr"},{lang:"fsl"}],[{lang:"sgn",region:"gb"},{lang:"bfi"}],[{lang:"sgn",region:"gr"},{lang:"gss"}],[{lang:"sgn",region:"ie"},{lang:"isg"}],[{lang:"sgn",region:"it"},{lang:"ise"}],[{lang:"sgn",region:"jp"},{lang:"jsl"}],[{lang:"sgn",region:"ni"},{lang:"ncs"}],[{lang:"sgn",region:"nl"},{lang:"dse"}],[{lang:"sgn",region:"no"},{lang:"nsi"}],[{lang:"sgn",region:"pt"},{lang:"psr"}],[{lang:"sgn",region:"se"},{lang:"swl"}],[{lang:"sgn",region:"us"},{lang:"ase"}],[{lang:"sgn",region:"za"},{lang:"sfs"}],[{baseName:"no-bokmal"},{lang:"nb"}],[{baseName:"no-nynorsk"},{lang:"nn"}],[{baseName:"aa-saaho"},{lang:"ssy"}],[{lang:"sh"},{lang:"sr",script:"latn"}],[{lang:"cnr"},{lang:"sr",region:"me"}],[{lang:"az",region:"az"},{lang:"az",script:"latn",region:"az"}],[{lang:"bs",region:"ba"},{lang:"bs",script:"latn",region:"ba"}],[{lang:"ha",script:"latn",region:"gh"},{lang:"ha",region:"gh"}],[{lang:"ha",script:"latn",region:"ne"},{lang:"ha",region:"ne"}],[{lang:"ha",script:"latn",region:"ng"},{lang:"ha",region:"ng"}],[{lang:"kk",script:"cyrl",region:"kz"},{lang:"kk",region:"kz"}],[{lang:"kk",script:"cyrl",region:"kg"},{lang:"kk",region:"kg"}],[{lang:"ks",script:"arab",region:"in"},{lang:"ks",region:"in"}],[{lang:"mn",script:"cyrl",region:"mn"},{lang:"mn",region:"mn"}],[{lang:"ms",script:"latn",region:"bn"},{lang:"ms",region:"bn"}],[{lang:"ms",script:"latn",region:"my"},{lang:"ms",region:"my"}],[{lang:"ms",script:"latn",region:"my"},{lang:"ms",region:"my"}],[{lang:"ms",script:"latn",region:"sg"},{lang:"ms",region:"sg"}],[{lang:"pa",region:"in"},{lang:"pa",script:"guru",region:"in"}],[{lang:"pa",region:"pk"},{lang:"pa",script:"arab",region:"pk"}],[{lang:"shi",region:"ma"},{lang:"shi",script:"tfng",region:"ma"}],[{lang:"sr",region:"ba"},{lang:"sr",script:"cyrl",region:"ba"}],[{lang:"sr",region:"me"},{lang:"sr",script:"latn",region:"me"}],[{lang:"sr",region:"rs"},{lang:"sr",script:"cyrl",region:"rs"}],[{lang:"sr",region:"xk"},{lang:"sr",script:"cyrl",region:"xk"}],[{lang:"tzm",script:"latn",region:"ma"},{lang:"tzm",region:"ma"}],[{lang:"ug",script:"arab",region:"cn"},{lang:"ug",region:"cn"}],[{lang:"uz",region:"af"},{lang:"uz",script:"arab",region:"af"}],[{lang:"uz",region:"uz"},{lang:"uz",script:"latn",region:"uz"}],[{lang:"vai",region:"lr"},{lang:"vai",script:"vaii",region:"lr"}],[{lang:"yue",region:"cn"},{lang:"yue",script:"hans",region:"cn"}],[{lang:"yue",region:"hk"},{lang:"yue",script:"hant",region:"hk"}],[{lang:"zh",region:"cn"},{lang:"zh",script:"hans",region:"cn"}],[{lang:"zh",region:"hk"},{lang:"zh",script:"hant",region:"hk"}],[{lang:"zh",region:"mo"},{lang:"zh",script:"hant",region:"mo"}],[{lang:"zh",region:"sg"},{lang:"zh",script:"hans",region:"sg"}],[{lang:"zh",region:"tw"},{lang:"zh",script:"hant",region:"tw"}],[{lang:"prs"},{lang:"fa",region:"af"}],[{lang:"swc"},{lang:"sw",region:"cd"}],[{lang:"hbs"},{lang:"sr",region:"latn"}]],Tm={qaai:"zinh"},Em={bu:"mm",ct:"ki",dd:"de",dy:"bj",fx:"fr",hv:"bf",jt:"um",mi:"um",nh:"vu",nq:"aq",pu:"um",pz:"pa",qu:"eu",rh:"zw",tp:"tl",uk:"gb",vd:"vn",wk:"um",yd:"ye",zr:"cd"},Am=["mni-beng-in","mni-mtei-in","sat-deva-in","sat-olck-in","shi-latn-ma","shi-tfng-ma","vai-latn-lr","vai-vaii-lr","yue-hans-cn","yue-hant-hk","az-arab-ir","az-cyrl-az","az-latn-az","bm-nkoo-ml","bs-cyrl-ba","bs-latn-ba","en-dsrt-us","ff-adlm-gn","ff-latn-sn","ha-arab-ng","hi-latn-in","iu-latn-ca","ks-arab-in","ks-deva-in","mn-mong-cn","ms-arab-my","pa-arab-pk","pa-guru-in","sd-arab-pk","sd-deva-in","sr-cyrl-rs","sr-latn-rs","su-latn-id","uz-arab-af","uz-cyrl-uz","uz-latn-uz","zh-hans-cn","zh-hant-tw","mni-beng","sat-olck","shi-tfng","vai-vaii","yue-hant","az-latn","bs-latn","ff-latn","jbo-001","ks-arab","pa-guru","prg-001","sd-arab","sr-cyrl","su-latn","uz-latn","zh-hans","agq-cm","ar-001","arn-cl","asa-tz","ast-es","bas-cm","bem-zm","bez-tz","bgn-pk","blt-vn","brx-in","bss-cm","byn-er","cad-us","cch-ng","ccp-bd","ceb-ph","cgg-ug","chr-us","cic-us","ckb-iq","dav-ke","dje-ne","doi-in","dsb-de","dua-cm","dyo-sn","ebu-ke","eo-001","ewo-cm","fil-ph","fur-it","gaa-gh","gez-et","gsw-ch","guz-ke","haw-us","hsb-de","ia-001","ife-tg","io-001","jgo-cm","jmc-tz","kab-dz","kaj-ng","kam-ke","kcg-ng","kde-tz","kea-cv","ken-cm","khq-ml","kkj-cm","kln-ke","kok-in","kpe-lr","ksb-tz","ksf-cm","ksh-de","lag-tz","lkt-us","lrc-ir","luo-ke","luy-ke","mai-in","mas-ke","mer-ke","mfe-mu","mgh-mz","mgo-cm","moh-ca","mua-cm","mus-us","myv-ru","mzn-ir","naq-na","nds-de","nmg-cm","nnh-cm","nqo-gn","nso-za","nus-ss","nyn-ug","osa-us","pcm-ng","quc-gt","rof-tz","rwk-tz","sah-ru","saq-ke","sbp-tz","scn-it","sdh-ir","seh-mz","ses-ml","sid-et","sma-se","smj-se","smn-fi","sms-fi","ssy-er","syr-iq","szl-pl","teo-ug","tig-er","trv-tw","trw-pk","twq-ne","tzm-ma","vo-001","vun-tz","wae-ch","wal-et","wbp-au","xog-ug","yav-cm","yi-001","zgh-ma","aa-et","af-za","ak-gh","am-et","an-es","as-in","ba-ru","be-by","bg-bg","bm-ml","bn-bd","bo-cn","br-fr","ca-es","ce-ru","co-fr","cs-cz","cu-ru","cv-ru","cy-gb","da-dk","dv-mv","dz-bt","ee-gh","el-gr","et-ee","eu-es","fa-ir","fy-nl","ga-ie","gd-gb","gl-es","gn-py","gu-in","gv-im","ha-ng","he-il","hi-in","hy-am","id-id","ig-ng","ii-cn","iu-ca","ja-jp","jv-id","ka-ge","ki-ke","kk-kz","kl-gl","km-kh","kn-in","ko-kr","ku-tr","kw-gb","ky-kg","lb-lu","lg-ug","ln-cd","lo-la","lt-lt","lu-cd","mi-nz","ml-in","mr-in","ms-my","mt-mt","my-mm","nb-no","nd-zw","ne-np","nn-no","nr-za","nv-us","ny-mw","oc-fr","om-et","or-in","os-ge","ps-af","qu-pe","rm-ch","rn-bi","sa-in","sc-it","se-no","sg-cf","si-lk","sl-si","sn-zw","sq-al","ss-za","st-za","sv-se","sw-tz","ta-in","te-in","tg-tj","th-th","ti-et","tk-tm","tn-za","ts-za","tt-ru","ug-cn","uk-ua","ur-pk","ve-za","vi-vn","wa-be","wo-sn","xh-za","yo-ng","zu-za"];function Om(e){return e.lang+(e.script?"-"+e.script:"")+(e.region?"-"+e.region:"")}function wm(e,t=!1){let i,r,n;var a=function(e){let t=0,i=-1;const r=[];for(;t<e.length;++t)if(45===e.charCodeAt(t)){const n=e.slice(i+1,t);r.push(n),i=t}if(i<t-1){const n=e.slice(i+1,t);r.push(n),i=t}return r}(e.toLowerCase()),s=a.length,e=a[0];n=3<=s?3<a[2].length?3<a[1].length?(r=a[1],e+"-"+r):(i=a[1],e+"-"+i):(i=a[2],r=a[1],e+"-"+r+"-"+i):2===s?3<a[1].length?(r=a[1],e+"-"+r):(i=a[1],a[0]+"-"+i):a[0];let o={baseName:n,lang:e,script:r,region:i};return t&&(o=((e=o).lang=null===(t=e.lang)||void 0===t?void 0:t.toLowerCase(),e.script=(t=null!==(t=e.script)&&void 0!==t?t:"").length?t[0].toUpperCase()+t.substring(1):"",e.region=null===(t=e.region)||void 0===t?void 0:t.toUpperCase(),e.lang&&(e.baseName=Om(e)),e)),o}const Rm={},Cm={is3LetterLangCode:e=>e in Sm,toLocale(e,t=!1){let i={baseName:void 0,lang:void 0,script:void 0,region:void 0};return e&&(r=e.toLowerCase(),e=null!==(n=vm[r])&&void 0!==n?n:r,i=wm(e),i.baseName=void 0,i=function(t,e){if((n=t).lang&&n.lang in Im&&(n.lang=Im[n.lang]),t=n,e)for(let e=0;e<bm.length;++e){var[i,r]=bm[e],i=function(e,t){let i=[];e.baseName=void 0;for(const n in e)if(Object.prototype.hasOwnProperty.call(e,n)){var r=e[n];if(r!==t[n]){i=null;break}r&&i.push(n)}return i}(i,t);if(i&&0<i.length){!function(e,t,i){for(const r in e)Object.prototype.hasOwnProperty.call(e,r)&&i.includes(r)&&(e[r]=t[r])}(t,r,i);break}}var n;return t}(i,t),i.lang&&Cm.is3LetterLangCode(i.lang)&&(i.lang=Sm[i.lang]),i=function(e){for(const t in Em)if(Object.prototype.hasOwnProperty.call(Em,t)&&e.region===t){e.region=Em[t];break}for(const i in Tm)if(Object.prototype.hasOwnProperty.call(Tm,i)&&e.script===i){e.script=Tm[i];break}return e}(i),i=wm(function(t){for(let e=0;e<Am.length;++e)t===Am[e]&&(t=t.split("-").slice(0,-1).join("-"));return t}(Om(i)),!0)),i;var r,n},shortenLanguageCode(e){if(!e)return"";let t=Rm[e];return null==t&&(Rm[e]=t=null!==(e=null===(e=this.toLocale(e))||void 0===e?void 0:e.baseName)&&void 0!==e?e:""),t}},km={isWebkitMediaElement:e=>"webkitDroppedFrameCount"in e,isHtmlVideoElement:e=>"getVideoPlaybackQuality"in e,timeRangeToArray(t){const i=[];for(let e=0;e<t.length;e++)i.push([t.start(e),t.end(e)]);return i}};function Mm(e){return new $(U.MEDIA_ERROR,V.STEERING_MANIFEST_PARSING_ERROR,!1,e,G.FormatError)}function Pm(t){var i=Object.keys(t);for(let e=0;e<i.length;e++){var r=i[e];if("string"!=typeof r||"string"!=typeof t[r])return Mm(`invalid steering manifest URI-REPLACEMENT item data type, ${r}`)}}function Lm(e){return"string"!=typeof e?Mm("invalid steering manifest PATHWAY-PRIORITY list item data type"):/^[\w\-\.]+$/.test(e)?void 0:Mm("steering manifest contains invalid pathway ID: "+e)}function xm(t,i,r,n){let a,s,o;n.child({name:"content-steering"});try{try{a=JSON.parse(t)}catch(t){throw Mm("steering manifest JSON format is malformed")}if(null==a)throw Mm("steering manifest is empty");if(o={version:a.VERSION,ttl:a.TTL,universal:a.UNIVERSAL,pathwayPriority:a["PATHWAY-PRIORITY"]},null!=a["RELOAD-URI"]){if("string"!=typeof a["RELOAD-URI"])throw Mm("invalid steering manifest RELOAD-URI data type");o.reloadURI=qs.buildAbsoluteURL(i,a["RELOAD-URI"])}if(null!=a["PATHWAY-CLONES"]){const t=a["PATHWAY-CLONES"];o.pathwayClones=[];for(let e=0;e<t.length;e++){const n=t[e],a=Object.prototype.hasOwnProperty.call(n,"BASE-ID"),s=Object.prototype.hasOwnProperty.call(n,"ID"),l=Object.prototype.hasOwnProperty.call(n,"URI-REPLACEMENT");if(!(a&&s&&l))throw Mm("invalid steering manifest PATHWAY-CLONE required attributes missing");{if(function(e){if("string"!=typeof e["BASE-ID"])throw Mm("invalid steering manifest PATHWAY-CLONES list item data type");if("string"!=typeof e.ID)throw Mm("invalid steering manifest PATHWAY-CLONES list item data type");if("object"!=typeof e["URI-REPLACEMENT"])throw Mm("invalid steering manifest URI-REPLACEMENT data type")}(n),r.has(n.ID))continue;const t=n["URI-REPLACEMENT"],i={"BASE-ID":n["BASE-ID"],ID:n.ID,"URI-REPLACEMENT":{}},a=function(e){if(e["URI-REPLACEMENT"].HOST&&"string"!=typeof e["URI-REPLACEMENT"].HOST)return Mm("invalid steering manifest URI-REPLACEMENT item data type");if(e["URI-REPLACEMENT"].PARAMS&&"object"!=typeof e["URI-REPLACEMENT"].PARAMS)return Mm("invalid steering manifest URI-REPLACEMENT item data type");if(e["URI-REPLACEMENT"].PARAMS&&"object"==typeof e["URI-REPLACEMENT"].PARAMS){var t=Pm(e["URI-REPLACEMENT"].PARAMS);if(null!=t)return t}if(e["URI-REPLACEMENT"]["PER-RENDITION-URIS"]&&"object"!=typeof e["URI-REPLACEMENT"]["PER-RENDITION-URIS"])return Mm("invalid steering manifest URI-REPLACEMENT item data type");if(e["URI-REPLACEMENT"]["PER-RENDITION-URIS"]&&"object"==typeof e["URI-REPLACEMENT"]["PER-RENDITION-URIS"]){t=Pm(e["URI-REPLACEMENT"]["PER-RENDITION-URIS"]);if(null!=t)return t}if(e["URI-REPLACEMENT"]["PER-VARIANT-URIS"]&&"object"!=typeof e["URI-REPLACEMENT"]["PER-VARIANT-URIS"])return Mm("invalid steering manifest URI-REPLACEMENT item data type");if(e["URI-REPLACEMENT"]["PER-VARIANT-URIS"]&&"object"==typeof e["URI-REPLACEMENT"]["PER-VARIANT-URIS"]){e=Pm(e["URI-REPLACEMENT"]["PER-VARIANT-URIS"]);if(null!=e)return e}}(n);if(null!=a)throw a;for(const r of["HOST","PARAMS","PER-VARIANT-URIS","PER-RENDITION-URIS"])"HOST"===r&&t[r]?i["URI-REPLACEMENT"].HOST=t[r]:"PARAMS"!==r&&"PER-VARIANT-URIS"!==r&&"PER-RENDITION-URIS"!==r||!t[r]||(i["URI-REPLACEMENT"][r]=t[r]);o.pathwayClones.push(i)}}}const n=function(e){if("number"!=typeof e.version)return Mm("invalid steering manifest VERSION data type");if(e.version<1||1<e.version)return Mm("steering manifest VERSION "+e.version+" is unsupported");if("number"!=typeof e.ttl)return Mm("invalid steering manifest TTL data type");if(e.ttl<0)return Mm("invalid steering manifest TTL value");if(null!=e.reloadURI&&"string"!=typeof e.reloadURI)return Mm("invalid steering manifest RELOAD-URI data type");if(null!=e.universal&&"boolean"!=typeof e.universal)return Mm("invalid steering manifest UNIVERSAL data type");if(!rt(e.pathwayPriority))return Mm("invalid steering manifest PATHWAY-PRIORITY data type");for(const t of e.pathwayPriority){const e=Lm(t);if(null!=e)return e}return e.pathwayClones&&!rt(e.pathwayClones)?Mm("invalid steering manifest PATHWAY-CLONES data type"):void 0}(o);if(null!=n)throw n;return o}catch(t){throw s=t instanceof $?t:Mm(`unknown exception when parsing steering manifest: ${t}`),s}}function Dm(e){return e.every(e=>null==e||!1===e.liveOrEvent)}function _m(e){return e.every(e=>null==e||e.ptsKnown)}function Nm(e,t){switch(e){case lm.SendAlternateToPenaltyBox:e=lm.RetryRequest,401!==t&&403!==t&&407!==t&&t!==G.CorruptStream.code&&t!==G.LivePlaylistUpdateError.code||(e=lm.SendEndCallback);break;case lm.RemoveAlternatePermanently:e=lm.SendEndCallback}return e}function Fm(t,i,r,n,a,s,o,l=!1){var d=s.mediaOptionListQueries[a].mediaOptionFromId(n),u=0!=(t.errorActionFlags&dm.MoveAllAlternatesMatchingHost),e=o.getFallbackMediaOptionTupleFromMediaOptionId(s,a,n,d.backingMediaOptionId,!1,u,l);let{errorAction:c,errorActionFlags:h}=t;if(s.isValidMediaOptionTuple(e))ho(s.enabledVariantMediaOption,e[a])&&(h&=~dm.MoveAllAlternatesMatchingHost);else{i||(c=Nm(c,r),h=0);const a=s.mediaOptionListQueries[Ys.Variant].mediaOptionListInfo.pathwayPriority;let e;if(Bs(d))e=d.pathwayID,!0===d.iframes?(c=lm.DoNothing,h=0):!i&&o.canSwitchToSDR(s,n,u,l)&&(c=t.errorAction,h=dm.SwitchToSDR);else{const t=s.enabledMediaOptionIdByType(Ys.Variant);e=s.variantMediaOptionById(t).pathwayID}if(a&&o.isContentSteeringEnabled()&&a.indexOf(e)<a.length-1)return c=lm.SendPathwayToPenaltyBox,h=dm.SwitchPathway,{errorAction:c,errorActionFlags:h};r===G.ContentHasGap.code&&(c=lm.DoNothing,h=0)}return{errorAction:c,errorActionFlags:h}}function Bm(e){let t,i=0;switch(e){case 0:t=lm.SendAlternateToPenaltyBox,i=dm.MoveAllAlternatesMatchingHost;break;case 410:t=lm.RemoveAlternatePermanently;break;case 500:case 502:case 503:case 504:case 404:case 409:case 401:case 403:case 407:case G.LivePlaylistUpdateError.code:case G.PlaylistNotReceived.code:default:t=lm.SendAlternateToPenaltyBox,i=0}return{errorAction:t,errorActionFlags:i}}function Um(e,t,i,r,n){var a=e.response.code;let s=Bm(a);var{mediaOptionId:o,mediaOptionType:l}=e;return t?s.errorActionFlags&=~dm.MoveAllAlternatesMatchingHost:s=function(e,t,i,r,n){let{errorAction:a,errorActionFlags:s}=t;if(e.isTimeout){const t=e["mediaOptionType"],o=null!==(n=null===(n=n.getErrorInfoByType(t))||void 0===n?void 0:n.timeouts.load)&&void 0!==n?n:0;!i&&r<=o&&(a=lm.SendEndCallback,s=0)}return{errorAction:a,errorActionFlags:s}}(e,s,t,i,r),s=Fm(s,t,a,o,l,r,n,e.isTimeout),e instanceof Qo&&!e.fatal&&(null===(n=n.rtcService)||void 0===n||n.handleLevelLoadError(e.url,r.isInterstitial)),s}function Vm(i,r,n,a,s,o,l,d){var e;r.fatal||null===(e=a.rtcService)||void 0===e||e.handleNonFatalError(r,n.isInterstitial);var{errorAction:u,errorActionFlags:c}=i;let t=!0;switch(u){case lm.RemoveAlternatePermanently:case lm.SendAlternateToPenaltyBox:{if(null==o||null==l)return r.handled=!1,!1;const i=n.itemId;let e=l,t=n.mediaOptionListQueries[o].mediaOptionFromId(l);t.backingMediaOptionId&&(e=t.backingMediaOptionId,t=n.mediaOptionListQueries[o].mediaOptionFromId(e));var h=0!=(c&dm.MoveAllAlternatesMatchingHost),p=0!=(c&dm.MoveAllAlternatesMatchingHDCP),m=0!=(c&dm.SwitchToSDR),f=u===lm.RemoveAlternatePermanently;if(p&&"hdcpLevel"in t){const r=t.hdcpLevel;a.setMaxHdcpLevel(i,r)}m&&a.switchToSDROnly(i,s),h?a.moveAllWithMatchingHosts(i,o,t,f):f?a.removePermanently(i,o,e):a.addToPenaltyBox(i,o,e),n.enabledMediaOptionIdByType(o)===l&&(f=[wo,wo,wo],f=a.getFallbackMediaOptionTupleFromMediaOptionId(n,o,l,null,m,h,d),n.isValidMediaOptionTuple(f)||(r.fatal=!0),r.fatal||a.setEnabledMediaOptions(n.itemId,f));break}case lm.SendPathwayToPenaltyBox:{let e=n.mediaOptionListQueries[o].mediaOptionFromId(l);if(!Bs(e)){const r=n.enabledMediaOptionIdByType(Ys.Variant);e=n.variantMediaOptionById(r)}a.addToPathwayPenaltyBox(n.itemId,e),0!=(c&dm.SwitchPathway)&&a.doPathwaySwitch(n.itemId);break}case lm.SendEndCallback:r.fatal=!0;break;case lm.RetryRequest:case lm.DoNothing:default:t=!1}return r.handled=t,t}function $m(e,t){t instanceof $o||t instanceof Qo||t instanceof qo||(t instanceof Ll||t instanceof Pl)&&f(t.keyuri)}function Qm(e,t,i,r,n,a){if(e.fatal||null==a||a.handleNonFatalError(e,n),e.handled=!0,i&&t<i.maxNumRetry&&z(i.retryDelayMs)){t="linear"===i.backoff?(t+1)*i.retryDelayMs:Math.pow(2,t)*i.retryDelayMs;return t=Math.min(i.maxRetryDelayMs,t),$m(0,e),Ki(t)}return e.fatal=!0,$m(0,e),Lr(()=>e)}function Km(e,t,i,r,n,a,s,o,l,d=!1){return(null==r?void 0:r.errorAction)===lm.RetryRequest?Qm(e,t,i,a.logger,n.isInterstitial,a.rtcService):qm(e,0,r,n,a,s,o,l,d)}function qm(e,t,i,r,n,a,s,o,l=!1){var d;const u=new Hr;return i||e.fatal||null===(d=n.rtcService)||void 0===d||d.handleNonFatalError(e,r.isInterstitial),da(()=>{i&&($m(n.logger,e),Vm(i,e,r,n,a,s,o,l)),u.error(e)}),u}function Hm(e,t,i,r,n,a,s){return qm(e,0,Fm({errorAction:lm.RemoveAlternatePermanently,errorActionFlags:0},!1,e.response.code,i,t,a,n),a,n,s,t,i).pipe(Wi(e=>{throw!1===e.fatal&&r.resetMediaSource(),e}))}function jm(r,n,a=!1){var{discoToMSNMap:s,endSN:o}=r,l=Object.keys(s);for(let i=0;i<l.length;i++){var d=+l[i],u=s[d][0];let e=s[d][1];if(!a&&o<u)return;let t=i===l.length-1;if(!a&&e>o&&(t=!0,e=o),t){const a=function(e,t){var{fragments:i,parts:r,endSN:e}=e;return t<=e?qc(i,t):h(r,e=>e.mediaSeqNum===t)}(r,e),c=a&&!a.part&&(a.isLastFragment||r.liveOrEvent)?1:0;if((null==a?void 0:a.start)+(null==a?void 0:a.duration)+c>n)return d}else{const a=rf(r,s[+l[i+1]][0]);if((null==a?void 0:a.start)>n)return d}}}function Gm(e,t,i){var r=0<i.duration,n=i.start+i.duration,n=null==e||e<n||e-n<1&&i.isLastFragment,t=!z(t)||i.discoSeqNum===t;return r&&n&&t}function zm(e,t,i,r=!1){var n=null===(n=i.discoToMSNMap[t])||void 0===n?void 0:n[0];return function(t,i,r=NaN,n=!1){var e,a=t.fragments;for(let e=r>t.startSN?r-t.startSN:0;e<a.length;++e){const t=a[e],r=t["start"];if(i(t))return{timelineOffset:r,mediaFragment:t}}if(n&&null!==(e=t.parts)&&void 0!==e&&e.length){const n=t.parts;for(let e=0;e<n.length;++e)if(!z(r)||n[e].mediaSeqNum>=r){const r=n[e];if(i(r)){const t=r["start"];return{timelineOffset:t,mediaFragment:r}}}}return null}(i,Gm.bind(null,e,t),n,r)}function Wm(e,t,i,r,n,a,s){var o,a=(o=null!=n?n:[],n=e,qh.isTimeRangeContainedInRanges(o,{start:n.start,end:n.start+n.duration}))||function(t,e,i,r,n){if(n)return!1;if(t.part){if(null!=i.find(e=>Gh(t,e.frag)||!e.frag.part&&Wh(e.frag,t)))return!0}else{const s=i.find(e=>Gh(t,e.frag)||e.frag.part&&Wh(t,e.frag));if(null!=s)return!(!s.frag.part&&(a=t,n=e,(e=s).evicting||!e.rebuffered&&function(e,t,i,r,n){if(t&&z(i.appendEnd)&&z(i.appendStart)){var a=t["end"];if(a+n<i.appendStart&&a>=e.start)return!0;t=e.start+e.duration;if(a>=i.appendEnd&&a<=t)return!0;n=t>i.appendEnd+n;return a>=i.appendStart&&a<=i.appendEnd&&n&&r.some(e=>{return t=i.frag,e=e.frag,t.itemId===e.itemId&&t.mediaOptionId===e.mediaOptionId&&t.mediaSeqNum===e.mediaSeqNum+1&&t.discoSeqNum===e.discoSeqNum;var t})||e.isLastFragment}return!1}(a,n,e,i,r)))}var a;return!1}(e,i,r,a,s),i=s||!i.len?t:i.end,e=!a&&Gm(i,e.discoSeqNum,e);return{shouldLoad:!a&&e,alreadyBuffered:a}}function Ym(e,t){var i=e.start+e.duration/2;let r=null,n=!1;for(let e=t.length-1;0<=e&&(null==r||!n);--e){var a=t[e];!r&&a.startPTS<i&&a.endPTS>i&&(r=a),n=n||0<a.frag.framesWithoutIDR}return(null==r?void 0:r.frag.mediaOptionId)!==e.mediaOptionId&&n}function Xm(e){if(!e)return null;var{itemId:t,mediaOptionId:i,mediaSeqNum:r,discoSeqNum:n,iframe:a,start:s,duration:o,mediaOptionType:l,isLastFragment:d,part:u=!1,partIndex:e=NaN}=e;return{itemId:t,mediaOptionId:i,mediaSeqNum:r,discoSeqNum:n,iframe:a,start:s,duration:o,mediaOptionType:l,isLastFragment:d,part:u,partIndex:e}}function Jm(i,r,n,a,s,o,l,d,u,c=NaN,h=!1){const p=0<=a?1:-1;let m=null;if(!isFinite(c)){const{startSN:c,endSN:b}=i;let t=null;for(let e=r;e>=c&&e<=b&&null==m;e+=p){const r=qc(i.fragments,e);if(null!=r&&r.iframe)f=r,g=Math.max(0,n+s.len*a),y=a,f.iframe&&(0<y&&g>=f.start+f.duration||y<0&&g<f.start)&&!(0<a&&r===i.fragments[i.fragments.length-1])||(m=r);else if(r){const{shouldLoad:i,alreadyBuffered:a}=Wm(r,n,s,o,l,d,u);a||t||(t=r),i&&(m=r)}}if(m||!t||!i.liveOrEvent||i.ptsKnown||h&&n>tf(i,!1)&&n<=tf(i,!0)||(m=t),!1===(null==m?void 0:m.iframe)&&!u){const r=qc(i.fragments,m.mediaSeqNum-p);(null==r?void 0:r.discoSeqNum)===m.discoSeqNum&&Ym(r,o)&&(m=r)}}var f,g,y;if(!h||!tp(a)||m)return m;var t,v,S=i["parts"];let I=null;for(let e=0;e<(null==S?void 0:S.length)&&null==m;e++){const h=S[e],{mediaSeqNum:b,partIndex:p}=h;b<r||b===r&&z(c)&&p<c||({shouldLoad:t,alreadyBuffered:v}=Wm(h,n,s,o,l,d,u),v||I||(I=h),t&&(m=h),!m&&I&&i.liveOrEvent&&!i.ptsKnown&&(m=I))}return m}function Zm(e,t=!1){var i;let r=1/0;null!==(i=e.fragments)&&void 0!==i&&i.length&&(r=e.fragments[0].start);let n=1/0;return null!==(i=e.parts)&&void 0!==i&&i.length&&t&&(n=e.parts[0].start),z(r)||z(n)?Math.min(r,n):0}function ef(e,t=!1){var i;let r=-1/0;if(null!==(i=e.fragments)&&void 0!==i&&i.length){const t=e.fragments[e.fragments.length-1];r=t.start+t.duration}let n=-1/0;if(null!==(i=e.parts)&&void 0!==i&&i.length&&t){const t=e.parts[e.parts.length-1];n=t.start+t.duration}return z(r)||z(n)?Math.max(r,n):0}function tf(e,t=!1){return ef(e,t)-Zm(e,t)}function rf(e,t){var{fragments:i,parts:r,endSN:e}=e;return t<=e?qc(i,t):0<(null==r?void 0:r.length)?qc(r,t,0):void 0}function nf(e,t,i){return e*i.instantBwDurationFactor*1e3/t}function af(e,n,t,a,i,r=!1){const{pos:s,combined:o,playingFrags:l}=t;if(!o||0===o.len)return!1;let d=ep(a)||o.len>=i;var u=n["avDetails"],[c,t]=u,u=Dm(u);let h=ef(c,r);t&&(h=Math.min(h,ef(t,r)));let p=NaN;for(const n of e)if(null!=n){p=n.discoSeqNum;break}if(u)d=d||s>=h-i;else{let e=qc(c.fragments,c.endSN),t=c.targetduration;if(r){const m=c.parts;0<(null==m?void 0:m.length)&&(e=m[m.length-1]),t=null!==(c=c.partTargetDuration)&&void 0!==c?c:e.duration}const m=e?e.duration:t;d=d&&s<=h-m}return d=d||l.every((e,t)=>{var i=n.avDetails[t];if(null==i)return!0;if(null==e)return!1;var r=e["discoSeqNum"];if(!i.discoToMSNMap[r]||z(p)&&r!==p)return!0;var[t,r]=i.discoToMSNMap[r];return a<0&&e.mediaSeqNum===t||0<=a&&e.mediaSeqNum===r&&(!i.liveOrEvent||e.mediaSeqNum!==i.endSN)}),d}function sf(r,e,t,i){if(!e||!t)return NaN;let n=null!==(e=null===(e=qc(e.fragments,t.mediaSeqNum,t.partIndex))||void 0===e?void 0:e.bitrate)&&void 0!==e?e:NaN;if(!z(n))if(i||t.mediaOptionType===Ys.AltAudio){const a=function(){var e=r.audioCodec,t=r.bitrate;if(!t)return NaN;let i=128e3;return e&&(Re.isEC3(e)?i=768e3:Re.isAC3(e)&&(i=64e4)),Math.min(t/2,i)}();n=t.mediaOptionType===Ys.Variant?r.bitrate-a:a}else n=r.bitrate;return n}function of(e,t,i,r,n,a,s,o=!1){var l=e[i],d=l.state;let u=l.tstart,c=0;switch(d){case"loading":c=function(e,t,i,r,n,a=!1){var s;const o=e[i],{bwSample:l,duration:d}=o,u=lf(l),c=df(l,t[i],d),h=n.avgBandwidth;let p=h,m=0;if(z(null==l?void 0:l.tfirst)){const e=performance.now()-l.tfirst;if(e>=r&&0<e){const t=u/e*1e3;p=a?t:Math.min(t,h)}}else m+=n.avgLatencyMs/1e3;if(p===h&&null!==(s=e[Xs.AltAudio-i])&&void 0!==s&&s.bwSample){const r=Xs.AltAudio-i,n=e[r],a=t[r],s=df(n.bwSample,a,n.duration),o=Math.min(s,c);m+=o/(.5*p)+(c-o)/p}else m+=c/p;return m}(e,t,i,r,n,o),u=l.tstart+1e3*c;case"loaded":case"parsing":c+=Vc(u,a),u=l.tstart+1e3*c;case"parsed":case"appending":c+=$c(u,s);break;default:c=1/0}return c}function lf(e){return z(null==e?void 0:e.loaded)?8*e.loaded:0}function df(e,t,i){return r=t,t=i,(z(null==(i=e)?void 0:i.total)?8*i.total:Math.ceil(t*r))-lf(e);var r}function uf(e,t,i,r,n,a,s){const o=r.mediaQuery;t=t.child({name:"haveEnough"});var l=o.getMediaBufferInfo(o.desiredPos,e.maxBufferHole),d=i.enabledVariantMediaOption,t=i.enabledAlternateMediaOptionByType(Ys.AltAudio),t=[n.getQueryForOption(d).mediaOptionDetails,null!=t&&t.url?n.getQueryForOption(t).mediaOptionDetails:null];let u=o.haveEnough;const c=null!=s?s:i.getInFlightFrags();if(null==t[Ys.Variant]||!c||c.every(e=>null==e))return u;var s={variant:d,avDetails:t},i=o.desiredRate,d=c[Ys.Variant],t=null!==(d=null==d?void 0:d.duration)&&void 0!==d?d:t[Ys.Variant].targetduration;return u=!!o.withinFragDurationOfContentGap(o.currentTime,t)||function(i,r,n,a,e,s,o,l){var t;const d=a["combined"],u=null!==(t=null==d?void 0:d.len)&&void 0!==t?t:0,c=Fc(i,n.avDetails[Ys.Variant],a);let h=af(r,n,a,e,c);if(!h&&r.some(e=>null!=e)){const e=r.map((e,t)=>function(i,e,t,r,n,a,s,o,l){var{sbTuple:d,pos:u}=n,c=l["maxBufferHole"],d=null===(m=d[e])||void 0===m?void 0:m.buffered;if((null==d?void 0:d.len)>=r)return 0;const{avDetails:h,variant:p}=t;if(!h[e])return 0;var m=i[e];if(!(d&&m&&((t=m.start+m.duration)>d.end&&(m.start-d.end<=c||m.start<=d.end)&&r<=t-u)))return 1/0;if(0===d.len&&"appending"===m.state)return 0;d=h.map((e,t)=>sf(p,e,i[t],null!=h[Ys.AltAudio])),l=nf(m.duration,n.playbackRate,l);return of(i,d,e,l,a,s,o)}(r,t,n,c,a,s,o,l,i));h=e.reduce((e,t)=>Math.max(e,t),0)<=u}return h}(e,c,s,l,i,a.getBandwidthEstimate(e,void 0,!1),a.getFragEstimate(e,void 0,!1),a.getBufferEstimate(e,void 0,!1)),r.haveEnough=u,u}(Ea=sm=sm||{})[Ea.Low=100]="Low",Ea[Ea.Normal=500]="Normal",Ea[Ea.High=900]="High",(Ea=om=om||{}).ContentSteering="Content Steering",Ea.RateChange="RateChange",Ea.VariantSwitch="Variant Switch",Ea.AudioSwitch="Audio Switch",Ea.SubtitleSwitch="Subtitle Switch",Ea.RendererSwitch="RendererSwitch",Ea.Idle="Idle",(Ea=lm=lm||{})[Ea.DoNothing=0]="DoNothing",Ea[Ea.SendEndCallback=1]="SendEndCallback",Ea[Ea.SendAlternateToPenaltyBox=2]="SendAlternateToPenaltyBox",Ea[Ea.RemoveAlternatePermanently=3]="RemoveAlternatePermanently",Ea[Ea.InsertDiscontinuity=4]="InsertDiscontinuity",Ea[Ea.RetryRequest=5]="RetryRequest",Ea[Ea.SendPathwayToPenaltyBox=6]="SendPathwayToPenaltyBox",(Ea=dm=dm||{})[Ea.DoNothing=0]="DoNothing",Ea[Ea.MoveAllAlternatesMatchingHost=1]="MoveAllAlternatesMatchingHost",Ea[Ea.MoveAllAlternatesMatchingHDCP=2]="MoveAllAlternatesMatchingHDCP",Ea[Ea.SwitchToSDR=4]="SwitchToSDR",Ea[Ea.SwitchPathway=8]="SwitchPathway";const cf={minValidBitrate:2e6,maxValidBitrate:5e6,maxPreferredBitrate:3e6,minValidHeight:480,maxValidHeight:720},hf=3,pf=2;function mf(e,t){var i;let r=hf*e.targetduration;return z(null===(i=e.serverControls)||void 0===i?void 0:i.holdBack)&&(r=Math.max(r,e.serverControls.holdBack)),z(t.liveSyncDuration)?r=Math.max(r,t.liveSyncDuration):z(t.liveSyncDurationCount)&&(r=Math.max(r,t.liveSyncDurationCount*e.targetduration)),r}function ff(e){var t;let i=pf*e.partTargetDuration;return z(i)&&z(null===(t=e.serverControls)||void 0===t?void 0:t.partHoldBack)&&(i=Math.max(i,e.serverControls.partHoldBack)),i}function gf(e,t){let i=mf(e,t);var t=t["liveAllowLowLatencyPlayback"];if(t){const r=ff(e);z(r)&&(i=r)}return Math.max(e.fragments[0].start,ef(e,t)-i)}function yf(e,t){var i=Zm(e,t.liveAllowLowLatencyPlayback),r=ef(e,t.liveAllowLowLatencyPlayback),t=gf(e,t);return{start:i,end:r,edge:t,boundary:Math.max(0,t-2*e.targetduration)}}function vf(e,t){const i=yf(e[Ys.Variant],t),r=e[Ys.AltAudio];if(r){const e=yf(r,t);i.start=Math.max(i.start,e.start),i.end=Math.max(i.start,Math.min(i.end,e.end)),i.edge=Math.max(i.start,Math.min(i.edge,e.edge)),i.boundary=Math.min(i.boundary,e.boundary)}return i}function Sf(e,t,i){i=vf(t,i);return Math.max(i.start,Math.min(i.edge,e))}function If(e,t,i){return!(e.start>t.end+i||e.end<t.start-i)}function bf(){return[new cc({name:"Remove Filter",priority:0,filterFn:(t,e,i)=>!i||i.removed.every(e=>t.mediaOptionId!==e)}),new cc({name:"Penalty Box Filter",priority:1,filterFn:(t,e,i)=>{const r=performance.now();return!i||i.penaltyBoxQueue.every(e=>e.expiry<=r||t.mediaOptionId!==e.id)}}),new cc({name:"Compatible IDs Filter",priority:1,filterFn:(t,e,i)=>!i||null==i.compatibleIds||i.compatibleIds.some(e=>e===t.mediaOptionId)})]}class Tf extends Sa{constructor(e,t,i){super(e),this.itemId=t,this.mediaOptionType=i,this._cachedList=[],this.allowFilters=this._initFilters()}get mediaOptionList(){var e;return(null===(e=this.mediaOptionListInfo)||void 0===e?void 0:e.mediaOptions)||null}get mediaOptionList$(){return this.mediaOptionListInfo$.pipe(sr(({mediaOptions:e})=>e))}mediaOptionFromId(t){return this.mediaOptionList.find(e=>e.mediaOptionId===t)}get hasOptionWithUrl(){var e;return this.mediaOptionList&&null==this._hasOptionWithUrl&&(this._hasOptionWithUrl=this.mediaOptionList.some(Co)),null!==(e=this._hasOptionWithUrl)&&void 0!==e&&e}_getFilteredList(e){return hc(e.mediaOptions,this.allowFilters,e)}_infoChanged(i){const e=this._cachedInfo;return null!=e&&null==i||null==e&&null!=i||e&&i&&(e.mediaOptions!==i.mediaOptions||e.penaltyBoxQueue.length!==i.penaltyBoxQueue.length||e.penaltyBoxQueue.some((e,t)=>i.penaltyBoxQueue[t]!==e)||e.removed.length!==i.removed.length||e.removed.some((e,t)=>i.removed[t]!==e)||e.compatibleIds!==i.compatibleIds)}get filteredMediaOptionList(){const t=performance.now();if(this.mediaOptionListInfo){const{penaltyBoxQueue:e,removed:i}=this.mediaOptionListInfo,r=e.filter(e=>!(e.expiry<=t)),n=Object.assign(Object.assign({},this.mediaOptionListInfo),{penaltyBoxQueue:r,removed:i.slice()});this._infoChanged(n)&&(this._cachedInfo=n,this._cachedList=this._getFilteredList(this.mediaOptionListInfo))}else this._cachedInfo=void 0,this._cachedList=[];return this._cachedList}getFilteredMediaOptionList$(e=!1){return(e?this.mediaOptionListInfo$.pipe(an(1)):this.mediaOptionListInfo$).pipe(on(e=>{const t=[Yl],i=performance.now();for(const r of e.penaltyBoxQueue)z(r.expiry)&&r.expiry>i&&t.push(Ki(r.expiry-i));return Vn(...t).pipe(sr(()=>this.filteredMediaOptionList))}),xr((e,i)=>e===i||(null==e?void 0:e.length)===(null==i?void 0:i.length)&&(null==e?void 0:e.every((e,t)=>e===i[t]))))}triggerPenaltyBoxExpiry(e){const t=[],i=performance.now();for(const r of e)z(r.expiry)&&r.expiry>i&&t.push(Ki(r.expiry-i));const r=Pr(e),n=Vn(...t).pipe(sr(()=>e));return Vn(r,n).pipe(sr(e=>e.filter(e=>!(e.expiry<=performance.now()))))}get penaltyBoxChanged$(){return this.mediaOptionListInfo$.pipe(on(e=>this.triggerPenaltyBoxExpiry(e.penaltyBoxQueue)),bn())}get removedListChanged$(){return this.mediaOptionListInfo$.pipe(sr(e=>null==e?void 0:e.removed),bn())}get compatibleIdsListChanged$(){return this.mediaOptionListInfo$.pipe(sr(e=>null==e?void 0:e.compatibleIds),bn())}get commonFilterParamChanges$(){return Qn([this.penaltyBoxChanged$,this.removedListChanged$,this.compatibleIdsListChanged$])}}function Ef(e){return"PQ"===e.videoRange||"HLG"===e.videoRange}function Af(e,t){return t.iframes===e}function Of(e,{hasScore:t,pivotVariant:i,pathwayPriority:r,enableSteering:n,preferHostOverQuality:a,preferCloseToPivotQuality:s}={hasScore:!1,pivotVariant:null,pathwayPriority:null,enableSteering:!1,preferHostOverQuality:!0,preferCloseToPivotQuality:!1}){const o=[...e];return o.sort(Pc(e.length,{hasScore:t,pivotVariant:i,pathwayPriority:r,enableSteering:n,preferHostOverQuality:a,preferCloseToPivotQuality:s})),o}(Ea=um=um||{})[Ea.Better=1]="Better",Ea[Ea.Same=0]="Same",Ea[Ea.Worse=-1]="Worse";class wf extends Tf{constructor(e,t){super(e,t,Ys.Variant)}static makeFilters(){return[...bf().concat([new cc({name:"HDR Filter",priority:1,filterFn:(e,t,i)=>!i||(i.hasHdrLevels&&i.preferHDR)===Ef(e)}),new cc({name:"Viewport Filter",priority:1,firstPassFn:(e,t,i)=>{if(i&&e&&!e.iframes&&e.videoCodec){const t=!i.lowestBitrate||e.bitrate<i.lowestBitrate?e.bitrate:i.lowestBitrate;i.lowestBitrate=t}},filterFn:(e,t,i)=>!(e&&i&&i.viewportInfo&&e.videoCodec&&i.lowestBitrate)||kc({width:e.width,height:e.height},i.viewportInfo)||e.bitrate===i.lowestBitrate}),new cc({name:"HDCP Filter",priority:2,filterFn:(e,t,i)=>!i||!th(i.maxHdcpLevel)||ih(e.hdcpLevel)<ih(i.maxHdcpLevel)})])].sort((e,t)=>{return(null!==(e=e.priority)&&void 0!==e?e:Number.MAX_SAFE_INTEGER)-(null!==(t=t.priority)&&void 0!==t?t:Number.MAX_SAFE_INTEGER)})}_initFilters(){return wf.kAllowFilters}get mediaOptionListInfo(){var e;return null!==(e=null===(e=this.getEntity(this.itemId))||void 0===e?void 0:e.mediaOptionListTuple[Ys.Variant])&&void 0!==e?e:null}get mediaOptionListInfo$(){return this.selectEntity(this.itemId,e=>{return null===(e=null==e?void 0:e.mediaOptionListTuple)||void 0===e?void 0:e[Ys.Variant]}).pipe(_d())}_infoChanged(i){var e,t;const r=this._cachedInfo;return super._infoChanged(i)||null!=r&&null!=i&&(r.hasHdrLevels!==i.hasHdrLevels||r.preferHDR!==i.preferHDR||r.maxHdcpLevel!==i.maxHdcpLevel||(null===(e=r.viewportInfo)||void 0===e?void 0:e.height)!==(null===(e=i.viewportInfo)||void 0===e?void 0:e.height)||(null===(e=r.viewportInfo)||void 0===e?void 0:e.width)!==(null===(e=i.viewportInfo)||void 0===e?void 0:e.width)||r.hasScore!==i.hasScore||(null===(t=r.pathwayPriority)||void 0===t?void 0:t.length)!==(null===(t=i.pathwayPriority)||void 0===t?void 0:t.length)||(null===(t=r.pathwayPriority)||void 0===t?void 0:t.some((e,t)=>i.pathwayPriority[t]!==e)))||r.pathwayPenaltyBox.length!==i.pathwayPenaltyBox.length||r.pathwayPenaltyBox.some((e,t)=>i.pathwayPenaltyBox[t]!==e)}get hdrMode$(){return this.mediaOptionListInfo$.pipe(sr(e=>!0===e.preferHDR&&e.hasHdrLevels),xr())}get maxHdcpLevel$(){return this.selectEntity(this.itemId,e=>{e=null===(e=null==e?void 0:e.mediaOptionListTuple)||void 0===e?void 0:e[Ys.Variant];return null==e?void 0:e.maxHdcpLevel}).pipe(xr())}get viewportInfo$(){return this.selectEntity(this.itemId,e=>{e=null===(e=null==e?void 0:e.mediaOptionListTuple)||void 0===e?void 0:e[Ys.Variant];return null==e?void 0:e.viewportInfo}).pipe(_d(),xr((e,t)=>e.width===t.width&&e.height===t.height))}get pathwayPenaltyBoxChanged$(){return this.selectEntity(this.itemId,e=>e.mediaOptionListTuple[Ys.Variant].pathwayPenaltyBox).pipe(on(e=>this.triggerPenaltyBoxExpiry(e=null!=e?e:[])),bn())}listFallbackVariants(t,e,i,r,n,a=void 0){var s=this.mediaOptionListInfo,o=null===(l=this.mediaOptionList)||void 0===l?void 0:l.find(e=>e.mediaOptionId===t);if(!o||!s)return[];var l=this.makeFilteredListFromVariant(o,e,a);if(l.length<1)return l;var{hasScore:e,pathwayPriority:s}=s;return wf._listFallbackVariants(l,o,e,s,n,i,r,a)}makeFilteredListFromVariant(e,t,i=void 0){if(!e||!this.mediaOptionList||!this.mediaOptionListInfo)return[];const r=Object.assign({},this.mediaOptionListInfo);t&&(r.compatibleIds=null,r.preferHDR=!1);let n=hc(Array.from(this.mediaOptionList),this.allowFilters,r);return n.length<1||i&&0<i.length&&(n=n.filter(e=>!i.includes(e.mediaOptionId))),n}get hasIframes(){return this.filteredMediaOptionList.some(e=>e.iframes)}static _listFallbackVariants(e,n,t,i,r,a,s=!1,o=null){let l=!1;const d=[];e.forEach(e=>{var t,i,r=!(e.iframes!==n.iframes||a&&ho(n,e)),i=(t=e,i=n.stableVariantID&&t.stableVariantID===n.stableVariantID,s?!i&&t.bitrate<n.bitrate:i||t.bitrate<=n.bitrate||Math.abs(t.bitrate-n.bitrate)<=1||d.some(e=>Math.abs(t.bitrate-e.bitrate)<=1)),i=r&&i;n.mediaOptionId!==e.mediaOptionId?i&&d.push(e):l=i});const u=Of(d,{pivotVariant:n,hasScore:t,pathwayPriority:i,enableSteering:r,preferHostOverQuality:!1,preferCloseToPivotQuality:!0});return!l||o&&o.includes(n.mediaOptionId)||u.push(n),u}getMatchingVariant(e,t){var i,r,n=this.mediaOptionFromId(e),a=t.mediaOptionType===Ys.AltAudio?"audioAlternates":"subtitleAlternates";let s=null;this.mediaOptionListInfo.hasScore;for(const e of this.filteredMediaOptionList)if((e[a]&&0<e[a].length?e[a][0].groupId:void 0)===t.groupId){if(!n){s=e;break}var o=(i=n,r=e,!(o=s)||r.bitrate>o.bitrate&&r.bitrate<=i.bitrate?um.Better:r.bitrate===o.bitrate?um.Same:um.Worse);o!==um.Better&&(o!==um.Same||s.mediaOptionId===n.mediaOptionId||e.mediaOptionId!==n.mediaOptionId&&!ho(n,e))||(s=e)}return s}}wf.kAllowFilters=wf.makeFilters();const Rf={name:"abr"};function Cf(e){return z(null==e?void 0:e.avgBandwidth)}function kf(e){return 0!==e.playbackRate?Math.abs(e.playbackRate):1}function Mf(e,t){return e.getCurrentWaterLevelByType(Xs.Variant,t)/kf(e)}function Pf(t,i,e,r){if(e)return t;let n=-1;if(t<0)return n;for(let e=t;e<i.length;++e){const t=xf(i[e],r);if(t.altAudio&&t.subtitle){n=e;break}}return n}function Lf(e,t,i,r,n,a,s,o){const l=i.mediaOptionListQueries[Ys.Variant].filteredMediaOptionList.filter(Af.bind(null,e));let d=null!=i.currentPathwayID?l.filter(e=>co(e.pathwayID,i.currentPathwayID)):l;if(e&&!d.length&&(d=l),!d.length)return{variantMediaOption:wo.mediaOptionId,holdOffDuration:0,lowestCandidate:null};let u=0;const c=i.nextMinAutoOptionId;if(c!==wo.mediaOptionId){const e=d.findIndex(e=>e.mediaOptionId===c);0<=e&&(u=e)}if(u=Pf(u,d,e,i),u<0)return{variantMediaOption:wo.mediaOptionId,holdOffDuration:0,lowestCandidate:null};let h=d.length-1;const p=i.nextMaxAutoOptionId;if(p!==wo.mediaOptionId){const e=d.findIndex(e=>e.mediaOptionId===p);0<=e&&(h=e)}var m=i.variantMediaOptionById(r.mediaOptionId),f=r.mediaOptionDetails,g=(null==m?void 0:m.iframes)!==e?0:Mf(n,t.maxBufferHole);let y,v;if(e){const e=t.desiredIframeFPS;v=f?f.targetduration/e:0,v=Math.max(1/e,v)}else v=f?f.targetduration:0;var S=t.abrBandWidthUpFactor,I=t.abrBandWidthFactor,g=jc(t.liveAllowLowLatencyPlayback,n.isPlayingAtLive,null!==(m=null===(m=null==f?void 0:f.parts)||void 0===m?void 0:m.length)&&void 0!==m?m:0)?Math.min(ff(f)/t.liveSyncDurationCount,g):g;return y=Nf(d,v,u,h,g,e,a.getCombinedEstimate(t,void 0,!1),a.bandwidthStatus,I,S,t,i,r,n,s,o,!0),y.variantMediaOption===wo.mediaOptionId&&(y=Nf(d,v,u,h,g+Bc(v,t.maxStarvationDelay),e,a.getCombinedEstimate(t,void 0,!1),a.bandwidthStatus,I,S,t,i,r,n,s,o,!0),y.variantMediaOption===wo.mediaOptionId&&0<=u&&(y.variantMediaOption=d[u].mediaOptionId,y.alternates=e?null:xf(d[u],i))),y}function xf(e,t){var i=t.enabledMediaOptionKeys,r=i[Ys.AltAudio],r=Ro(r)?t.mediaOptionListQueries[Ys.AltAudio].getMatchingAlternate(r.mediaOptionId,e):wo,i=i[Ys.Subtitle];return{altAudio:r,subtitle:Ro(i)?t.mediaOptionListQueries[Ys.Subtitle].getMatchingAlternate(i.mediaOptionId,e):wo}}const Df=4,_f=1.8;function Nf(e,t,i,r,n,a,s,o,l,d,u,c,h,p,m,f,g=!1){var y=u.enableBoss;return u.abrAlgorithm,y?function(e,t,i,r,n,a,s,o,l,d,u,c,h,p=!1){const m=l.enabledMediaOptionIdByType(Ys.Variant),f=l.variantMediaOptionById(m),g=l.mediaOptionListQueries[Ys.Variant].mediaOptionListInfo,y=l.abrStatus,v=d.mediaOptionDetailsEntityRecord,S=f&&f.iframes===i?Mf(u,o.maxBufferHole):0,I=u.maxBufferSize,b=u.getMediaBufferInfo(u.desiredPos,o.maxBufferHole),T=jc(o.liveAllowLowLatencyPlayback,u.isPlayingAtLive,null!==(d=null===(d=null===(d=d.mediaOptionDetails)||void 0===d?void 0:d.parts)||void 0===d?void 0:d.length)&&void 0!==d?d:0),E=c.getQuery(l.itemId,h);c.setTransformer(l.itemId,io.ValidAbrLevelFilter,new xh(e,t,i,r,n,a,s,o,f,g,y,v,S,I,b,T,h,p));p=i?E.variantFor(ro.ABRIframe):E.variantFor(ro.ABR);let A=null;return!i&&p&&(A=xf(p,l),A.altAudio&&A.subtitle||(A=null)),p?{variantMediaOption:p.mediaOptionId,holdOffDuration:0,alternates:A,lowestCandidate:null}:{variantMediaOption:wo.mediaOptionId,holdOffDuration:-1,lowestCandidate:null}}(t,n,a,s,o,l,d,u,c,h,p,m,f,g):function(i,r,t,n,a,s,o,l,d,u,c,h,p){const m=o.bandwidthSampleCount,f=c.abrStatus,g=p.maxBufferSize,y=u.minTargetDurations||1,v=c.mediaOptionListQueries[Ys.Variant].mediaOptionListInfo.hasScore;if(!i.length)return{variantMediaOption:wo.mediaOptionId,holdOffDuration:-1,lowestCandidate:null};const S=c.enabledMediaOptionIdByType(Ys.Variant),I=c.variantMediaOptionById(S),b=null!=i.find(e=>e.mediaOptionId===S),T=I&&I.iframes===a,E=I&&T?I.score:void 0,A=I&&T?I.frameRate:void 0,O=I&&T?I.height:void 0,w=T?Mf(p,u.maxBufferHole):0,R=p.getMediaBufferInfo(p.desiredPos,u.maxBufferHole),C=jc(u.liveAllowLowLatencyPlayback,p.isPlayingAtLive,null!==(p=null===(p=null===(p=h.mediaOptionDetails)||void 0===p?void 0:p.parts)||void 0===p?void 0:p.length)&&void 0!==p?p:0);t=Math.max(0,Math.min(i.length-1,t)),r=Math.max(0,Math.min(i.length-1,r));var k=h.mediaOptionDetailsEntityRecord,M=Ff(s.avgBandwidth,d,l,m);let P;for(let e=t;e>=r;e--){const r=i[e];let t=r.mediaOptionId;const l=r.score,h=k&&k[t]?k[t].mediaOptionDetails:void 0,U=k&&k[t]?k[t].lastUpdateMillis:null,V=Hc(h,u,C),$=null!=I&&r.bitrate>I.bitrate,Q=null!=I&&r.bitrate<I.bitrate,K=!(null!=A&&($&&r.frameRate<A||Q&&r.frameRate>A)),p=!($&&null!=O&&O>r.height),m=!(Q&&(r.bitrate===I.bitrate-1||r.bitrate===I.bitrate+1)),q=!(v&&$&&null!=E&&(l<E||l===E&&I&&r.bitrate>=I.bitrate)),H=r.iframes===a;if(z(V)&&H&&K&&p&&m&&q){let e=null;var L=!a;L&&(e=xf(r,c),e.altAudio&&e.subtitle||(e=null));var{adjustedbw:x,adjustedBitrate:D,fetchDuration:_,rejectLevelDueToPeakBW:N,canFitMultipleSegments:F,validFlowRate:B}=zc(u,r,h,w,R,y,$,(null==I?void 0:I.mediaOptionId)!==r.mediaOptionId,s,M,C,g,U);if((a||L&&Boolean(e))&&(P=t),D<x&&F&&!N&&B&&(!L||Boolean(e))&&(a||!_||_<n)){if(B=x,L=f,x=(x=o).instantBw,(L.fragDownloadSlow||L.fragDownloadTooSlow||z(x)&&x<B)&&b&&T)if(w<=2*V&&$)t=S;else if($&&d*o.instantBw<D)continue;return{variantMediaOption:t,holdOffDuration:_,alternates:e,lowestCandidate:P}}}}return{variantMediaOption:wo.mediaOptionId,holdOffDuration:-1,lowestCandidate:P}}(e,i,r,n,a,s,o,l,d,u,c,h,p)}function Ff(e,t,i,r){let n,a;return r>=Df?(n=e*t,a=e*i):n=a=e/_f,{bwUp:n,bwDown:a}}function Bf(t,e){let i=1/0;if(t===wo.mediaOptionId)return i;var r=e.find(e=>e.mediaOptionId===t);if(!r)return 1/0;const n=r.iframes,a=r.bitrate,s=r.frameRate,o=e.find(e=>e.iframes===n&&(void 0===s||e.frameRate>=s)&&e.bitrate>a);return o&&(i=o.bitrate),i}function Uf(e){return"loading"===(null==e?void 0:e.state)&&z(null===(e=e.bwSample)||void 0===e?void 0:e.trequest)}function Vf(e,t){e.fragDownloadSlow=t.fragDownloadSlow||e.fragDownloadSlow,e.fragDownloadTooSlow=t.fragDownloadTooSlow||e.fragDownloadTooSlow}const $f=2e3,Qf=1e3,Kf=100,qf=25;function Hf(e,t,i,r){let{fragDownloadSlow:n,fragDownloadTooSlow:a}=t;t=i.variantMediaOptionById(e.mediaOptionId).bitrate,i=e.bwSample;r=r.child(Rf);r=i.total||Math.max(i.loaded,Math.round(e.duration*t/8)),t=performance.now()-i.tfirst,r=i.loaded*e.duration*1e3/r;return(e.part&&t>=Kf&&t-r>=qf||t>=$f&&t-r>=Qf)&&(n=!0),t>=1e3*e.duration&&(a=!0),{fragDownloadSlow:n,fragDownloadTooSlow:a}}function jf(e,t,i){const{rootPlaylistService:r,rootPlaylistQuery:n}=i,a=Gf(e,t,i);return a&&r.setEnabledMediaOptions(n.itemId,a),null!=a}function Gf(e,t,i){var r;const{rootPlaylistService:n,mediaSink:a,rootPlaylistQuery:s,statsService:o,config:l,mediaLibraryService:d,mediaSelectionBossService:u}=i,c=a.mediaQuery,h=d.getQueryForOption(t),p=n.logger.child(Rf),m=c.isIframeRate,f=s.enabledMediaOptionKeys[Ys.Variant];if(e===to.None)return null;if(m&&e!==to.IframeModeChange&&c.getBufferedSegmentsByType(Xs.Variant).filter(e=>e.frag.iframe).length<l.minFramesBeforeSwitchingLevel)return null;const g=o.getQueryForId(s.statsId),y=[wo,wo,wo];if(e===to.IframeModeChange){const e=s.enabledMediaOptionsBeforeTrickplay;if(n.saveEnabledOptionsForTrickplay(s.itemId,m),!m){const t=function(e,t,i,r){const n=i.mediaOptionListQueries[Ys.Variant].filteredMediaOptionList,a=t.targetStartupMs,s={avgPlaylistParseTimeMs:0,avgPlaylistLoadTimeMs:0},o=r.getFragEstimate(t),l={avgBufferCreateMs:0,avgInitFragAppendMs:0,avgDataFragAppendMs:0},d=o.maxDurationSec,u=r.getBandwidthEstimate(t),c={targetDuration:d,targetStartupMs:a,metricsOverride:{maxValidHeight:0,maxValidBitrate:0,maxPreferredBitrate:0},enableBoss:t.enableBoss,enableContentSteering:t.enableContentSteering},h=n.filter(e=>!e.iframes&&(!e.width||!e.height||e.width*e.height<=2488320));let p=e;0<h.length&&(p=h[0].mediaOptionId);e=h.filter(e=>Sc(e,u,c,s,o,l));return 0<e.length&&(p=e[e.length-1].mediaOptionId),p}(e[Ys.Variant].mediaOptionId,l,s,g);n.setNextMaxAutoOptionId(s.itemId,t);const i=s.variantMediaOptionById(t);null==u||u.setTransformer(s.itemId,io.BitrateFilter,new Lh(0,i.bitrate))}}var v=function(e,t,i,r,n,a,s,o){let l=t.nextMaxAutoOptionId;const d=t.abrStatus["fragDownloadTooSlow"];if(l===wo.mediaOptionId||!d&&Cf(a.getBandwidthEstimate(e)))return u=e,c=t,h=r,e=n,r=a,a=s,s=o.child({name:"abr"}),o=e.isIframeRate,c.enabledMediaOptionIdByType(Ys.Variant),Lf(o,u,c,h,e,r,a,s);if(n.isIframeRate)return{variantMediaOption:l,holdOffDuration:0,lowestCandidate:null,alternates:{altAudio:wo,subtitle:wo}};{const p=t.variantMediaOptionById(l),m=t.enabledAlternateMediaOptionByType(Ys.Subtitle),n=t.enabledAlternateMediaOptionByType(Ys.AltAudio),f=null==n?void 0:n.persistentID,g=null==m?void 0:m.persistentID,y=!t.preferHDR,d=i.getBestMediaOptionTupleFromVariantAndPersistentId(t,p,f,g,void 0,[],void 0,y,!1,!1,!1);return t.isValidMediaOptionTuple(d)?(l=d[Ys.Variant].mediaOptionId,{variantMediaOption:l,holdOffDuration:0,alternates:{altAudio:d[Ys.AltAudio],subtitle:d[Ys.Subtitle]},lowestCandidate:null}):{variantMediaOption:t.enabledMediaOptionKeys[Ys.Variant].mediaOptionId,holdOffDuration:0,lowestCandidate:null}}var u,c,h}(l,s,n,h,c,g,u,p);if(m||e!==to.IframeModeChange||(n.setNextMaxAutoOptionId(s.itemId,wo.mediaOptionId),null==u||u.removeTransformer(s.itemId,io.BitrateFilter)),v.variantMediaOption===f.mediaOptionId)return null;y[Ys.Variant]={itemId:s.itemId,mediaOptionId:v.variantMediaOption};for(const e of[Ys.AltAudio,Ys.Subtitle]){const t=s.enabledMediaOptionIdByType(e);if(t!==wo.mediaOptionId){const i=e===Ys.AltAudio?null===(r=v.alternates)||void 0===r?void 0:r.altAudio:null===(r=v.alternates)||void 0===r?void 0:r.subtitle;y[e]=i||{itemId:s.itemId,mediaOptionId:t}}}return y}function zf(e){return 1e3*(e.averagetargetduration||e.targetduration)}function Wf(e,t){var i;if(e.liveOrEvent){if(null!==(i=e.serverControls)&&void 0!==i&&i.canBlockReload)return!0;e=zf(e);return performance.now()-t>=e}return!1}function Yf(e,t){return null==e||t.endSN!==e.endSN||t.liveOrEvent!==e.liveOrEvent}function Xf(e,t){return null==e||e.partEndSN!==t.partEndSN||e.partEndIndex!==t.partEndIndex}const Jf={NONE:"","AES-128":"","ISO-23001-7":"","SAMPLE-AES":"","SAMPLE-AES-CTR":""};class Zf{constructor(){this._programDateTime=null,this._byteRange=null,this.relurl="",this.baseurl=null,this.isInitSegment=!1,this.mediaSeqNum=NaN,this.discoSeqNum=NaN,this.iframe=!1,this.bitrate=NaN,this.start=NaN,this.duration=NaN,this.lastByteRangeEndOffset=NaN,this.gap=!1,this.part=!1,this.partIndependent=!1,this.partGap=!1,this.partIndex=NaN,this.iframe=!1}getMediaFragment(e,t,i){const r={mediaOptionType:i,relativeUrl:this.relurl,start:this.start,duration:this.duration,mediaSeqNum:this.mediaSeqNum,discoSeqNum:this.discoSeqNum,mediaOptionId:t,itemId:e,isLastFragment:!1,isInitSegment:this.isInitSegment,gap:this.gap};return this.part&&(r.part=this.part,r.partIndependent=this.partIndependent,r.partGap=this.partGap,r.partIndex=this.partIndex),null!==(e=this.byteRange)&&void 0!==e&&e.length&&z(this.byteRangeStartOffset)&&z(this.byteRangeEndOffset)&&(r.byteRangeOffset={start:this.byteRangeStartOffset,end:this.byteRangeEndOffset}),this.iframe&&(r.iframe=this.iframe),this.levelkey&&(r.keyTagInfo=this.levelkey),this.programDateTime&&(r.programDateTime=this.programDateTime),z(this.bitrate)&&(r.bitrate=this.bitrate),r}get programDateTime(){return!this._programDateTime&&this.rawProgramDateTime&&(this._programDateTime=Date.parse(this.rawProgramDateTime)),this._programDateTime}get byteRange(){if(!this._byteRange&&this.rawByteRange){const t=new Array(2),i=this.rawByteRange.split("@",2);var e;1===i.length?(e=this["lastByteRangeEndOffset"],t[0]=e||0):t[0]=parseInt(i[1]),t[1]=parseInt(i[0])+t[0],this._byteRange=t}return this._byteRange}get byteRangeStartOffset(){var e;return null===(e=this.byteRange)||void 0===e?void 0:e[0]}get byteRangeEndOffset(){var e;return null===(e=this.byteRange)||void 0===e?void 0:e[1]}get rangeString(){return 0<=this.start&&0<=this.duration?`${this.start.toFixed(2)}-${(this.start+this.duration).toFixed(2)}`:"N/A"}get fragTag(){return`msn/dsn/partIndex: ${this.mediaSeqNum}/${this.discoSeqNum}/${this.partIndex}`}}const eg={parseMediaCharacteristics:e=>e?e.split(/\s*,\s*/):new Array,addMediaToSelectionArray(e,t,i){if(void 0===e)return-1;const r=e.MediaSelectionGroupOptions;let n=r.find(e=>e.MediaSelectionOptionsMediaType===t.mediaType&&e.MediaSelectionOptionsName===t.name&&e.MediaSelectionOptionsExtendedLanguageTag===t.lang);return n||(n={MediaSelectionOptionsMediaType:null!==(e=t.mediaType)&&void 0!==e?e:eo.UNKNOWN,MediaSelectionOptionsExtendedLanguageTag:t.lang,MediaSelectionOptionsIsDefault:null!==(e=t.default)&&void 0!==e&&e,MediaSelectionOptionsName:t.name,MediaSelectionOptionsPersistentID:i,MediaSelectionOptionsTaggedMediaCharacteristics:null!==(e=t.characteristics)&&void 0!==e?e:[],MediaSelectionOptionsIsAutoSelect:null!==(e=t.autoselect)&&void 0!==e&&e},t.mediaType===eo.SUBTITLE&&(n.MediaSelectionOptionsDisplaysNonForcedSubtitles=t.forced?Zs.NO:Zs.YES),i++,r.push(n)),t.persistentID=n.MediaSelectionOptionsPersistentID,i},makeDefaultClosedCaptionOption:(e,t)=>({itemId:e,mediaOptionType:Ys.Subtitle,id:0,mediaOptionId:"cc1_"+ba(),mediaType:eo.CLOSEDCAPTION,inStreamID:"CC1",groupId:"cc",name:"English-CC",type:"CLOSED-CAPTIONS",default:!1,autoselect:!1,forced:!1,lang:"en",characteristics:["public.accessibility.transcribes-spoken-dialog","public.accessibility.describes-music-and-sound"],persistentID:t,relativeUrl:void 0})},tg=/^(\d+)x(\d+)$/,ig=/\s*(.+?)\s*=((?:\".*?\")|.*?)(?:,|$)/g;class rg{constructor(e){this._record=e}get keys(){return Object.keys(this._record)}hasKey(e){return e in this._record}getInt(e){e=this._record[e];if(e){e=parseInt(e);return e>Number.MAX_SAFE_INTEGER?1/0:e}}getFloat(e){e=this._record[e];if(e)return parseFloat(e)}getResolution(e){e=this._record[e],e=tg.exec(e);let t;return null!==e&&(t={width:parseInt(e[1],10),height:parseInt(e[2],10)}),t}getHex(e){const i=this._record[e];if(i){let t=(i||"0x").slice(2);t=(1&t.length?"0":"")+t;const r=new Uint8Array(t.length/2);for(let e=0;e<t.length/2;e++){const i=parseInt(t.slice(2*e,2*e+2),16);if(!z(i))return;r[e]=i}return r}}getString(e,t=!0){let i=this._record[e];if(i)return 34===i.charCodeAt(0)&&34===i.charCodeAt(i.length-1)&&(i=i.slice(1,-1)),t?q(i):i}matchesEnum(e,t){e=this._record[e];return null!=e&&e===t}}class ng{static parseTags(e){var t;const i={};if(!e)return new rg(i);for(ig.lastIndex=0;null!==(t=ig.exec(e));){const e=t[1],r=t[2];i[e]=r}return new rg(i)}}const ag={ExtractVariableParameter:/{\$(.*?)}/g,LevelPlaylistFast:/#EXTINF:(\d*(?:\.\d+)?)(?:,(.*))?|(?!#)(\S.+)|#EXT-X-BYTERANGE:(.+)|#EXT-X-PROGRAM-DATE-TIME:(.+)|#EXT-X-BITRATE:(.+)|#EXT-X-DATERANGE:(.+)|#EXT-X-PART:(.+)|(#EXT-X-.*)/g,LevelPlaylistSlow:/#EXT-X-(PLAYLIST-TYPE|MEDIA-SEQUENCE|TARGETDURATION|KEY|START|DISCONTINUITY-SEQUENCE|DISCONTINUITY|VERSION|MAP|DEFINE|ENDLIST|I-FRAMES-ONLY|GAP|SERVER-CONTROL|PART-INF|SKIP|RENDITION-REPORT)(?::(.+)){0,1}/,MasterPlaylist:/#EXT-X-STREAM-INF:([^\n\r]*)[\r\n]+([^\r\n]+)|#EXT-X-I-FRAME-STREAM-INF:([^\r\n]+)|#EXT-X-DEFINE:([^\n\r]*)|#EXT-X-CONTENT-STEERING:([^\n\r]*)|#EXT-X-START:([^\n\r]*)/g,MasterPlaylistAlternateMedia:/#EXT-X-MEDIA:(.*)/g,SessionData:/#EXT-X-SESSION-DATA[^:]*:(.*)/g,SessionKeys:/#EXT-X-SESSION-KEY:([^\n\r]*)/g,VARIABLE_PLAYLIST_REGEX:/(NAME|VALUE)=\"(.*)\",(NAME|VALUE)=\"(.*)\"|(IMPORT)=\"(.*)\"/};(Ea=cm=cm||{})[Ea.Audio=0]="Audio",Ea[Ea.Subtitle=1]="Subtitle";class sg{static isValidPlaylist(e){return e.startsWith("#EXTM3U")}static isMediaPlaylist(e){return 0<e.indexOf("#EXTINF:")||0<e.indexOf("#EXT-X-PLAYLIST-TYPE:")}static replaceVariables(e,t,i){let r=e?q(e):void 0;return r&&0<Object.keys(t).length&&(r=r.replace(ag.ExtractVariableParameter,e=>{ag.ExtractVariableParameter.lastIndex=0;e=ag.ExtractVariableParameter.exec(e),e=null==e?void 0:e[1];if(e&&"string"==typeof t[e])return t[e];throw new $(U.MEDIA_ERROR,i?V.MANIFEST_PARSING_ERROR:V.LEVEL_LOAD_ERROR,!1,G.PlaylistErrorInvalidEXTXDEFINE.text,G.PlaylistErrorInvalidEXTXDEFINE)})),r}static parseDecryptData(e,t,i){const r=ng.parseTags(e),n=r.getString("METHOD"),a=(e=n)&&e in Jf?n:null;e=null!==(e=r.getString("KEYFORMAT"))&&void 0!==e?e:"";if(a&&sg.shouldSelectKeyTag(e,a,i)){const s=r.getString("URI"),i=r.getHex("IV");if(s&&r.hasKey("IV")&&!i){const s=new $(U.MEDIA_ERROR,V.MANIFEST_PARSING_ERROR,!0,`Invalid IV: ${r.getString("IV",!1)}`,G.PlaylistErrorInvalidEntry);throw s.url=t,s}const o=s?qs.buildAbsoluteURL(t,s,{alwaysNormalize:!0}):"",n=(r.getString("KEYFORMATVERSIONS")||"1").split("/").map(Number).filter(isFinite);return new Wl(a,o,i,e,n)}}static shouldSelectKeyTag(e,t,i){return"AES-128"===t||"NONE"===t||null==i||e===uc.getKeySystemFormat(i)}static optOutClosedCaption(t){let i=!1,r=!1;if(t)for(let e=0;e<t.length;++e){const n=t[e];if(n.videoCodec&&((r=!0)!==n.iframes&&n.closedcaption&&"none"===n.closedcaption.toLowerCase())){i=!0;break}}return!r||i}static parseRootPlaylistAlternateMediaOptions(o,l,d,u,c,h,p){var m,f,g;const y={MediaSelectionGroupAllowEmptySelection:1,MediaSelectionGroupMediaCharacteristics:["public.audible"],MediaSelectionGroupMediaType:eo.AUDIO,MediaSelectionGroupOptions:[]},v={MediaSelectionGroupAllowEmptySelection:1,MediaSelectionGroupMediaCharacteristics:["public.legible"],MediaSelectionGroupMediaType:eo.SUBTITLE,MediaSelectionGroupOptions:[]},S={videoAlternateOptions:[],audioAlternateOptions:[],subtitleAlternateOptions:[],audioMediaSelectionGroup:y,subtitleMediaSelectionGroup:v,audioGroupMapping:new Map,subtitleGroupMapping:new Map};let I=0;for(ag.MasterPlaylistAlternateMedia.lastIndex=0;null!=(T=ag.MasterPlaylistAlternateMedia.exec(l));){const l=sg.replaceVariables(T[1],c,!0),d=ng.parseTags(l);let e,t,i,r=eo.UNKNOWN;const E=eg.parseMediaCharacteristics(d.getString("CHARACTERISTICS")),A=d.getString("GROUP-ID"),O=d.getString("CHANNELS");let n,a=[];var b=d.getString("TYPE");switch(b){case"VIDEO":r=eo.VIDEO,n=Ys.Variant,t=S.videoAlternateOptions;break;case"AUDIO":r=eo.AUDIO,n=Ys.AltAudio,t=S.audioAlternateOptions,i=y;const o=u.find(e=>{return(null===(e=h.get(e.mediaOptionId))||void 0===e?void 0:e[0])===A});a=o&&null!==(m=o.audioCodecList)&&void 0!==m?m:[];break;case"SUBTITLES":r=eo.SUBTITLE,n=Ys.Subtitle,t=S.subtitleAlternateOptions,i=v;break;case"CLOSED-CAPTIONS":r=eo.CLOSEDCAPTION,n=Ys.Subtitle,e=d.getString("INSTREAM-ID"),t=S.subtitleAlternateOptions,i=v}if(!n||!A||!b)break;var T=Cm.shortenLanguageCode(null!==(f=d.getString("LANGUAGE"))&&void 0!==f?f:"");let s=null!==(f=d.getString("NAME"))&&void 0!==f?f:"";""===s&&(s=T,b===eo.CLOSEDCAPTION&&(s+=" CC"));const w={itemId:o,mediaOptionType:n,mediaType:r,relativeUrl:d.getString("URI"),groupId:A,channels:O,groupCodecList:a,name:s,type:b,default:d.matchesEnum("DEFAULT","YES"),autoselect:d.matchesEnum("AUTOSELECT","YES"),forced:d.matchesEnum("FORCED","YES"),characteristics:E,persistentID:I,id:t?t.length:0,mediaOptionId:`${d.getString("NAME")}_${A}_${I}`,lang:T,isInterstitial:p},R=d.getString("STABLE-RENDITION-ID");R&&(w.stableRenditionID=R),w.mediaType===eo.CLOSEDCAPTION&&e&&(w.inStreamID=e),t&&(w.id=t.length,t.push(w),S.audioGroupMapping&&w.mediaOptionType===Ys.AltAudio&&(S.audioGroupMapping.has(A)?null===(g=S.audioGroupMapping.get(A))||void 0===g||g.push(w):S.audioGroupMapping.set(A,[w])),S.subtitleGroupMapping&&w.mediaOptionType===Ys.Subtitle&&(S.subtitleGroupMapping.has(A)?null===(g=S.subtitleGroupMapping.get(A))||void 0===g||g.push(w):S.subtitleGroupMapping.set(A,[w]))),I=eg.addMediaToSelectionArray(i,w,I)}return{alternateMediaInfo:S}}static parseMediaOptionPlaylist(n,a,s,o,l,d,u,c,h=0,p=!1,m){var f;let g=0,y=0;const v={itemId:l,mediaOptionId:d,mediaOptionType:u,type:"",version:0,url:a,relativeUrl:a,initSegments:{},fragments:[],liveOrEvent:!0,startSN:0,endSN:0,iframesOnly:p,targetduration:0,totalduration:0,averagetargetduration:0,ptsKnown:!1,discoToMSNMap:{},pdtToMSN:[]};let S,t,I=new Wl("NONE"),b=!1,T=!1,E=0,i=null,A=new Zf,r=NaN;const O={};let w,R,C=!0,k=!0,M=!1,P=0,L=0;ag.LevelPlaylistFast.lastIndex=0;for(var x=()=>new $(U.MEDIA_ERROR,V.MANIFEST_PARSING_ERROR,!0,"Invalid key system preference for the playlist",G.IncompatibleAsset);null!==(S=ag.LevelPlaylistFast.exec(n));){const n=S[1];if(n)A.duration=parseFloat(n),A.title=q(S[2]);else if(S[3]||S[8]){if(S[8]&&(A.part=!0),A.part){const n=S[8],a=ng.parseTags(n),s=a.getFloat("DURATION");if(!z(s))break;A.duration=s,w=sg.replaceVariables(a.getString("URI",!1),O,!1),w&&(A.relurl=w),A.partIndependent=a.matchesEnum("INDEPENDENT","YES"),v.hasPartIndependentTag=v.hasPartIndependentTag||null!=a.getString("INDEPENDENT");const o=a.getString("BYTERANGE");if(o&&(A.rawByteRange=o,i)){const n=i.byteRangeEndOffset;n&&(A.lastByteRangeEndOffset=n)}A.partGap=a.matchesEnum("GAP","YES")}if(z(A.duration)){if(T&&!b)throw x();b=!1,T=!1;let e=0;if(A.part?(e=g,z(v.partStartSN)||(v.partStartSN=e),A.partIndex=P++,A.start=y+L+h,v.partEndSN=e,v.partEndIndex=A.partIndex):(e=g++,P=0,L=0,A.start=y+h,w=sg.replaceVariables(S[3],O,!1),w&&(A.relurl=w)),A.levelkey=I,A.mediaSeqNum=e,A.discoSeqNum=E,A.iframe=v.iframesOnly,A.baseurl=a,z(A.byteRangeEndOffset)&&z(A.byteRangeStartOffset)?A.bitrate=8*(A.byteRangeEndOffset-A.byteRangeStartOffset)/A.duration:A.bitrate=r,m&&v.startSN>=m.startSN&&v.startSN<=m.endSN&&(M=!0),!M||!A.part&&m&&e>m.endSN||A.part&&m&&z(m.partEndSN)&&z(m.partEndIndex)&&(e>m.partEndSN||e===m.partEndSN&&A.partIndex>m.partEndIndex)){if(null!=t&&(A.rawProgramDateTime=t,(null==i?void 0:i.discoSeqNum)!==E)){const n=A.programDateTime;n&&v.pdtToMSN.push([n,A.mediaSeqNum])}v.discoToMSNMap[A.discoSeqNum]?v.discoToMSNMap[A.discoSeqNum][1]=A.mediaSeqNum:v.discoToMSNMap[A.discoSeqNum]=[A.mediaSeqNum,A.mediaSeqNum],A.part?(v.parts||(v.parts=[]),L+=A.duration,v.parts.push(A.getMediaFragment(l,d,u))):(v.fragments.push(A.getMediaFragment(l,d,u)),y+=A.duration)}if(t=void 0,i=A,C||!v.initSegments[E]||k)if(v.iframesOnly&&A.byteRangeStartOffset&&0<A.byteRangeStartOffset&&!v.initSegments[E]&&!k){const n=new Zf;if(n.relurl=A.relurl,n.rawByteRange=Math.min(A.byteRangeStartOffset,1316)+"@0",n.baseurl=a,n.isInitSegment=!0,n.discoSeqNum=E,n.levelkey=I,n.iframe=!0,T&&!b)throw x();b=!1,T=!1,v.initSegments[E]=Object.assign(Object.assign({},n.getMediaFragment(l,d,u)),{isInitSegment:!0})}else R&&(v.initSegments[E]=Object.assign(Object.assign({},R),{discoSeqNum:E,isInitSegment:!0}));C=!1,k=!1,A=new Zf}}else if(S[4]){if(A.rawByteRange=q(S[4]),i){const n=i.byteRangeEndOffset;n&&(A.lastByteRangeEndOffset=n)}}else if(S[5])t=q(S[5]);else if(S[6]){const n=parseInt(S[6]);z(n)&&(r=1e3*n)}else if(S[7]){const n=S[7],a=ng.parseTags(n),s=a.getString("ID"),o=a.getString("START-DATE");if(s&&o){let e={ID:s,"START-DATE":o};for(const s of a.keys)switch(s){case"ID":case"START-DATE":break;case"DURATION":case"PLANNED-DURATION":e[s]=a.getFloat(s);break;default:e[s]=a.getString(s)}v.daterangeTags||(v.daterangeTags={}),v.daterangeTags[s]&&(e=sg.validateAndUpdateDateRangeTag(v.daterangeTags[s],e,c)),v.daterangeTags[s]=e}}else if(null!=(S=S[9].match(ag.LevelPlaylistSlow))){const n=S[1],c=sg.replaceVariables(S[2],O,!1);switch(n){case"PLAYLIST-TYPE":v.type=null==c?void 0:c.toUpperCase(),"VOD"===v.type&&(v.liveOrEvent=!1);break;case"MEDIA-SEQUENCE":0===v.fragments.length&&c&&(g=v.startSN=parseInt(c));break;case"TARGETDURATION":c&&(v.targetduration=parseFloat(c));break;case"VERSION":c&&(v.version=parseInt(c));break;case"ENDLIST":v.liveOrEvent=!1;break;case"DISCONTINUITY":E++,C=!0;break;case"DISCONTINUITY-SEQUENCE":c&&(E=parseInt(c));break;case"KEY":const n=c;if(T=!0,!b){const o=sg.parseDecryptData(n,a,s);o&&(I=o,b=!0)}break;case"START":const h=c,p=ng.parseTags(h).getFloat("TIME-OFFSET");z(p)&&(v.startTimeOffset=p);break;case"I-FRAMES-ONLY":v.iframesOnly=!0;break;case"MAP":const m=ng.parseTags(c),N=m.getString("URI");N&&(A.relurl=N);const f=A.rawByteRange,y=A.lastByteRangeEndOffset;if(A.rawByteRange=m.getString("BYTERANGE"),A.baseurl=a,A.isInitSegment=!0,A.levelkey=I,T&&!b)throw x();b=!1,T=!1,R=A.getMediaFragment(l,d,u),k=!0,A=new Zf,A.rawByteRange=f,A.lastByteRangeEndOffset=y;break;case"DEFINE":const S=ag.VARIABLE_PLAYLIST_REGEX.exec(null!=c?c:"");let e,t,i,r;if(S&&(e="NAME"===S[1]?S[2]:S[4],t="VALUE"===S[1]?S[2]:S[4],i=S[5],r=S[6]),!e&&!t&&"IMPORT"===i&&r&&o.hasOwnProperty(r))O[r]=o[r];else{if(!e||i||(null==S?void 0:S[1])===(null==S?void 0:S[3])||O.hasOwnProperty(e)||!t)throw new $(U.MEDIA_ERROR,V.MANIFEST_PARSING_ERROR,!0,G.PlaylistErrorMissingImportReference.text,G.PlaylistErrorMissingImportReference);O[e]=t}break;case"GAP":A.gap=!0;break;case"SERVER-CONTROL":v.serverControls={canSkipUntil:NaN,canSkipDateRanges:!1,canBlockReload:!1};const q=ng.parseTags(c),M=q.getFloat("CAN-SKIP-UNTIL");z(M)&&(v.serverControls.canSkipUntil=M),v.serverControls.canSkipDateRanges=q.matchesEnum("CAN-SKIP-DATERANGES","YES");const P=q.getFloat("HOLD-BACK");z(P)&&(v.serverControls.holdBack=P);const L=q.getFloat("PART-HOLD-BACK");z(L)&&(v.serverControls.partHoldBack=L),v.serverControls.canBlockReload=q.matchesEnum("CAN-BLOCK-RELOAD","YES");break;case"PART-INF":var D=ng.parseTags(c).getFloat("PART-TARGET");z(D)&&(v.partTargetDuration=D);break;case"SKIP":var _=ng.parseTags(c).getInt("SKIPPED-SEGMENTS");z(_)&&(v.skippedSegments=_,g+=_);break;case"RENDITION-REPORT":const F=ng.parseTags(c),B=F.getString("URI");if(!B)break;_={relUri:B,lastMSN:F.getInt("LAST-MSN"),lastPart:F.getInt("LAST-PART")};v.renditionReports?v.renditionReports.push(_):v.renditionReports=[_]}}}if(i&&(A=i),A&&!A.relurl&&(A.part?(null===(f=v.parts)||void 0===f||f.pop(),L-=A.duration):(v.fragments.pop(),y-=A.duration)),!v.liveOrEvent&&0<v.fragments.length&&(v.fragments[v.fragments.length-1].isLastFragment=!0),v.totalduration=y,v.averagetargetduration=y/v.fragments.length,v.endSN=g-1,null!==(f=v.parts)&&void 0!==f&&f.length){const n=v.parts.length-1;v.partEndSN=v.parts[n].mediaSeqNum,v.partEndIndex=v.parts[n].partIndex}return{mediaOptionDetails:v,isDeltaPlaylist:M}}static parseRootPlaylistWithAlternates(t,i,r,n){var a,s;const o=sg.parseRootPlaylist(t,i,r);if(o.playlistParsingError)throw o.playlistParsingError;const{variantMediaOptions:l,masterVariableList:e,variantIdToAlternateGroupIdTuple:d}=o,u=sg.parseRootPlaylistAlternateMediaOptions(t,i,r,o.variantMediaOptions,e,d,n),c=u.alternateMediaInfo,{audioGroupMapping:h,subtitleGroupMapping:p,subtitleAlternateOptions:m,subtitleMediaSelectionGroup:f}=c;let g,y,v;0!==m.length||sg.optOutClosedCaption(l)||(g=eg.makeDefaultClosedCaptionOption(t,0),m.push(g),p.set(g.groupId,[g]),eg.addMediaToSelectionArray(f,g,0));for(let e=0;e<l.length;e++){const i=l[e];g&&(i.closedcaption=g.groupId);const r=null===(a=d.get(i.mediaOptionId))||void 0===a?void 0:a[cm.Audio],n=null===(a=d.get(i.mediaOptionId))||void 0===a?void 0:a[cm.Subtitle],o=i.closedcaption;if(r&&h&&(i.audioAlternates=null!==(s=h.get(r))&&void 0!==s?s:[]),r||(y=y||this.consolidateAlterateEntries(h),i.audioAlternates=y),n&&p&&(i.subtitleAlternates=null!==(s=p.get(n))&&void 0!==s?s:[]),o&&p)if(i.subtitleAlternates&&0<i.subtitleAlternates.length){const t=p.get(o);t&&0<t.length&&(i.subtitleAlternates=i.subtitleAlternates.concat(t))}else i.subtitleAlternates=p.get(o);n||o||(v=v||this.consolidateAlterateEntries(p),i.subtitleAlternates=v)}return Object.assign(Object.assign({},o),u)}static consolidateAlterateEntries(e){var t;let i=[];for(const r of e.keys())i=i.concat(null!==(t=e.get(r))&&void 0!==t?t:[]);return i}static parseRootPlaylist(t,i,e){const r=[],n={},a=new Map,s={};let o,l,d,u,c=0,h=null,p=!0,m=NaN;for(ag.MasterPlaylist.lastIndex=0;null!=(o=ag.MasterPlaylist.exec(i));)if(o[4]){let e,t,i;if(o=ag.VARIABLE_PLAYLIST_REGEX.exec(o[4]),o&&(e="NAME"===o[1]?o[2]:o[4],t="VALUE"===o[1]?o[2]:o[4],i=o[5]),!e||n.hasOwnProperty(e)||i||(null==o?void 0:o[1])===(null==o?void 0:o[3])||!t){u=new $(U.MEDIA_ERROR,V.MANIFEST_PARSING_ERROR,!0,G.PlaylistErrorInvalidEXTXDEFINE.text,G.PlaylistErrorInvalidEXTXDEFINE);break}n[e]=t}else if(o[5]){const t=sg.replaceVariables(o[5],n,!0),i=ng.parseTags(t),S=i.getString("SERVER-URI");if("string"!=typeof S){u=new $(U.MEDIA_ERROR,V.MANIFEST_PARSING_ERROR,!0,G.PlaylistErrorInvalidSERVERURI.text,G.PlaylistErrorInvalidSERVERURI);break}const r=i.getString("PATHWAY-ID");if(i.hasKey("PATHWAY-ID")&&"string"!=typeof r){u=new $(U.MEDIA_ERROR,V.MANIFEST_PARSING_ERROR,!0,G.PlaylistErrorInvalidPATHWAYID.text,G.PlaylistErrorInvalidPATHWAYID);break}h={serverURI:so(S,e),initPathwayID:r||".",initPathwayPriority:[]}}else if(o[6]){const t=ng.parseTags(o[6]).getFloat("TIME-OFFSET");z(t)&&(m=t)}else{d=sg.replaceVariables(o[1]||o[3],n,!0);const i=ng.parseTags(d);l=sg.replaceVariables(o[2]||i.getString("URI"),n,!0);const e=i.getFloat("SCORE");if(void 0!==e&&!z(e)||e&&e<0){u=new $(U.MEDIA_ERROR,V.MANIFEST_PARSING_ERROR,!0,G.PlaylistErrorInvalidSCORE.text,G.PlaylistErrorInvalidSCORE),p=!1;break}p&&void 0===e&&(p=!1);const h=i.getInt("BANDWIDTH"),m=i.getInt("AVERAGE-BANDWIDTH"),v=m||h;if(!v)continue;var f=null!==(g=i.getString("VIDEO-RANGE"))&&void 0!==g?g:"SDR";if(null==(y=f)||!Fs.includes(y))continue;var g=`level_${(v||0)+r.length%1e3/1e3}`;a.set(g,[void 0,void 0]);var y=i.getString("AUDIO");if(y){const t=a.get(g);t&&(t[cm.Audio]=y)}y=i.getString("SUBTITLES");if(y){const t=a.get(g);t&&(t[cm.Subtitle]=y)}const I=i.getString("CODECS"),b={itemId:t,mediaOptionId:g,mediaOptionType:Ys.Variant,relativeUrl:null!=l?l:"",name:i.getString("NAME"),iframes:!!o[3],bandwidth:h||v,avgBandwidth:m,bitrate:v,videoRange:f,frameRate:i.getFloat("FRAME-RATE"),allowedCPCMap:sg.parseAllowedCPC(i.getString("ALLOWED-CPC",!1)),closedcaption:i.getString("CLOSED-CAPTIONS"),levelCodec:I,score:i.getFloat("SCORE"),pathwayID:i.getString("PATHWAY-ID")||"."},T=i.getString("STABLE-VARIANT-ID");T&&(b.stableVariantID=T);f=i.getString("HDCP-LEVEL");th(f)&&(b.hdcpLevel=f);f=i.getResolution("RESOLUTION");if(f&&(b.width=f.width,b.height=f.height),I){b.videoCodecList=new Array,b.audioCodecList=new Array;const t=I.split(/[ ,]+/),i=t["length"];for(let e=0;e<i;e++){const i=t[e];switch(i.slice(0,4)){case"avc1":b.videoCodec=Re.avc1toavcoti(i),b.videoCodecList.push(b.videoCodec);break;case"mjpg":case"jpeg":b.imageCodec=i;case"avc3":case"dvav":case"dva1":case"hev1":case"hvc1":case"dvh1":case"dvhe":case"vp09":case"av01":b.videoCodec=i,b.videoCodecList.push(b.videoCodec);break;case"mp4a":case"ec-3":case"ac-3":b.audioCodec=i,b.audioCodecList.push(b.audioCodec);break;case"stpp":case"wvtt":break;default:b.audioCodec=i,b.audioCodecList.push(b.audioCodec)}}1<b.audioCodecList.length&&(b.audioCodec=lh.getRichestAudioCodec(b.audioCodecList)),1<b.videoCodecList.length&&(b.videoCodec=lh.getRichestVideoCodec(b.videoCodecList))}if(null!=(u=Lm(b.pathwayID)))break;Object.prototype.hasOwnProperty.call(s,b.pathwayID)||(s[b.pathwayID]=c++),r.push(b)}null!=(null==h?void 0:h.initPathwayID)&&(s[h.initPathwayID]=-1,h.initPathwayPriority=Object.keys(s).sort((e,t)=>s[e]-s[t]));const v={variantMediaOptions:r,contentSteeringOption:h,masterVariableList:n,variantIdToAlternateGroupIdTuple:a,playlistParsingError:u,scoreAvailable:p};return z(m)&&(v.startTimeOffset=m),v}static parseAllowedCPC(e){if("string"==typeof e){const n={};return e.split(",").forEach(e=>{const t=e.split(":");let i,r;if(2===t.length)i=t[0].trim(),r=t[1].trim();else{if(!(2<t.length))return;r=t[t.length-1].trim(),t.pop(),i=t.join(":")}if(!(i in n)){let e=new Array;""!==r&&(e=q(r).split("/").map(e=>e.trim())),n[q(i)]=e}}),n}}static parseSessionKeys(e,t,i){var r;const n=[];for(ag.SessionData.lastIndex=0;r=ag.SessionKeys.exec(e);)try{const e=sg.parseDecryptData(r[1],t,i);e&&e.isEncrypted&&n.push(e)}catch(e){}return n}static parseSessionData(t,i,r){let n;const a=[],s=new Set;for(ag.SessionData.lastIndex=0;null!=(n=ag.SessionData.exec(t));){const t=ng.parseTags(n[1]);let e=t.getString("LANGUAGE");var o=t.getString("DATA-ID");if(null!=o){e=Cm.shortenLanguageCode(e);const r=e?o+"|"+e:void 0;if(!r||!s.has(r)){const n={"DATA-ID":o,LANGUAGE:e};for(const i of t.keys){const r=t.getString(i);"VALUE"===i&&r&&"com.apple.hls.other-tags"===o&&(n[i]=function(t){let i;try{i=JSON.parse(Ql.base64DecodeToStr(t))}catch(e){i=t}return i}(r)),i in n||(n[i]=r)}a.push(n),r&&s.add(r)}}else r.error(`Error processing DATA-ID ${o} and LANGUAGE ${e}`)}return{itemList:a,baseUrl:i}}static validateAndUpdateDateRangeTag(e,t,i){let r=!0;const n=Object.assign({},e);for(const e in t)if("ID"!==e){var a=t[e];if(Object.prototype.hasOwnProperty.call(n,e)){if(n[e]!==a){i.error(`Date Range Tag for attribute: "${e}" does not match for ID: "${t.ID}". This violates HLS spec`),r=!1;break}}else n[e]=a}return r?n:e}}var og,lg,dg,ug=sg;function cg(e){var{tloadMillis:t,age:i,partTargetDuration:r=NaN,targetduration:e}=e;if(!z(t)||!z(i))return!1;i=performance.now()-t+1e3*i;return 1e3*r<i||1e3*e<i}const hg=(e,t,s,i,o,r,n,l,d,u,a,c,h)=>{var p;const{itemId:m,mediaOptionId:f,mediaOptionType:g,relativeUrl:y}=e;if(!y)return Lr(()=>new Uo("Missing URL in loadMediaOptionDetails",400));const v=!!Bs(e)&&e.iframes,S=Go(e,r);let I=null!==(e=e.url)&&void 0!==e?e:so(y,t);return c&&c.liveOrEvent&&null!==(p=c.serverControls)&&void 0!==p&&p.canBlockReload?I=function(e,t,i){const r=new URL(e);if(i.liveAllowLowLatencyPlayback){const{nextMSN:e,nextPart:n}=function(e){var t=cg(e),{endSN:i,partEndSN:r=NaN,partEndIndex:n=NaN}=e,a=z(null==e?void 0:e.partEndIndex);if(!t)return a?r===i?{nextMSN:r+1,nextPart:0}:{nextMSN:r,nextPart:n+1}:{nextMSN:i+1,nextPart:NaN};var{tloadMillis:s,age:o,partTargetDuration:t=NaN,targetduration:e}=e,o=performance.now()-s+1e3*o;if(!a)return{nextMSN:i+Math.floor(o/(1e3*e))+1,nextPart:NaN};e=Math.round(e/t),t=Math.round(o/(1e3*t)),n+=1;return{nextMSN:r+Math.floor((t+n)/e),nextPart:(t+n)%e}}(t);if(z(e)&&(r.searchParams.set("_HLS_msn",e.toString()),z(n)&&r.searchParams.set("_HLS_part",n.toString())),z(null===(i=null==t?void 0:t.serverControls)||void 0===i?void 0:i.canSkipUntil)&&z(t.tloadMillis)&&t.fragments.length){const e=performance.now()-t.tloadMillis,n=t.fragments[t.fragments.length-1],a=n.start+n.duration;a+e/1e3-(null!==(i=null===(i=null==t?void 0:t.serverControls)||void 0===i?void 0:i.canSkipUntil)&&void 0!==i?i:0)<a&&r.searchParams.set("_HLS_skip","YES")}}else r.searchParams.set("_HLS_msn",(t.endSN+1).toString());return r.href}(I,c,i):null!=h&&h.renditionReports&&(I=function(t,e,i){var r,n=null===(n=e.renditionReports)||void 0===n?void 0:n.find(e=>no.buildAbsoluteURL(t,e.relUri,{alwaysNormalize:!0})===t);if(n){const a=new URL(t),s=i&&null!==(r=e.partEndSN)&&void 0!==r?r:e.endSN,o=null!==(r=n.lastMSN)&&void 0!==r?r:s,l=o===e.partEndSN?e.partEndIndex:0,d=null!==(n=n.lastPart)&&void 0!==n?n:l;return a.searchParams.set("_HLS_msn",o.toString()),i&&z(d)&&a.searchParams.set("_HLS_part",d.toString()),a.href}return t}(I,h,i.liveAllowLowLatencyPlayback)),Al({url:I,xhrSetup:i.xhrSetup},S,a,n).pipe(tr(Cn),sr(({responseText:e,stats:t})=>{var i=performance.now(),e=sg.parseMediaOptionPlaylist(e,I,d,null!=u?u:{},m,f,g,l,s,v,c);let r=[];g===Ys.Variant&&(r=_p(e.mediaOptionDetails,m,o)),Jo(e.mediaOptionDetails);const n=performance.now(),a=e["mediaOptionDetails"];a.tloadMillis=t.tload,z(t.age)&&(a.age=t.age);i={playlistLoadTimeMs:t.tload-t.trequest,playlistParseTimeMs:n-i,tparsed:{tbegin:i,tend:n}};return{mediaOptionDetails:a,isDeltaPlaylist:e.isDeltaPlaylist,interstitials:r,bwSample:t,playlistSample:i}}),Yo(g,f,!1,I))},pg=(m,e,f,t,g)=>Pr(e).pipe(on(e=>{const{keyTagInfo:t,isInitSegment:i,iframe:r,byteRangeOffset:n}=m,a=null==t?void 0:t.method,{start:s,end:o}=null!=n?n:{};if("AES-128"!==a)return Pr(e);{null==t||!t.uri||t.iv||t.format&&"identity"!==t.format||(t.iv=function(t){const i=new Uint8Array(16);for(let e=12;e<16;e++)i[e]=t>>8*(15-e)&255;return i}(m.mediaSeqNum));const n=e,a=null===(e=null==t?void 0:t.key)||void 0===e?void 0:e.buffer,l=null===(e=null==t?void 0:t.iv)||void 0===e?void 0:e.buffer,d=z(s)&&z(o)&&(r||i)?o-s:0,u=!f.enableWebCrypto||!!d,c=null!==(e=null==a?void 0:a.slice(0))&&void 0!==e?e:new ArrayBuffer(0),h=null!==(e=null==l?void 0:l.slice(0))&&void 0!==e?e:new ArrayBuffer(0),p={useJSCrypto:u,plainTextLength:d};return g.decrypt(c,h,"AES-CBC",n,p)}}));function mg(e,t,i){return e.findIndex(e=>e.mediaSeqNum===t&&e.partIndex===i)}function fg(e,t){if(t.part){const i=e.parts;return Gh(t,i[mg(i,t.mediaSeqNum,t.partIndex)])}const i=e.fragments,r=t.mediaSeqNum-e.startSN;return 0<=r&&r<e.fragments.length&&Gh(t,i[r])}function gg(i,e,r,t,n=!1,a=!1){const{startPts:s,endPts:o}=e,l=i[r];l.startPts=s,l.endPts=o,l.start=t,l.duration=w(o,s);for(let e=r,t=!0;0<e&&(a||t);e--)t=vg(i,e,e-1,s.timescale,n);for(let e=r,t=!0;e<i.length-1&&(a||t);e++)t=vg(i,e,e+1,s.timescale,n)}function yg(t,i,r,n=!1,a=!1,e=!1){if(fg(t,i)){if(i.part){let e=t.parts;var s=mg(e,i.mediaSeqNum,i.partIndex),o=e[s];n&&(e=t.parts=t.parts.slice(),e[s]=Object.assign({},o)),gg(e,i,s,r,n,a)}else{let e=t.fragments;o=i.mediaSeqNum-t.startSN,s=qc(e,i.mediaSeqNum);n&&(e=t.fragments=t.fragments.slice(),e[o]=Object.assign({},s)),gg(e,i,o,r,n,a)}t.totalduration=tf(t,e),t.ptsKnown=!0}}function vg(e,t,i,r,n=!1){var a=e[t];let s=e[i],o=s.start;null==s.startPts&&(o=t<i?a.start+a.duration:Math.max(a.start-s.duration,0));r=z(r)?1/r:Number.EPSILON,r=Math.abs(s.start-o)>r;return!!r&&(n&&(s=e[i]=Object.assign({},s)),r&&(s.start=o),!0)}function Sg(t,i,r,n,a){return e=>e.pipe(Wi(e=>{if(t.logger.error(`Got demux error ${e.message}`),e instanceof I||e instanceof F){lm.SendAlternateToPenaltyBox;return qm(e,0,{errorAction:e.fatal?lm.SendEndCallback:e instanceof F?lm.SendAlternateToPenaltyBox:lm.RemoveAlternatePermanently,errorActionFlags:0},i,t,r,n,a)}throw e}))}function Ig(t,i,r,n,a,s,o,l,d){return a=Math.max(0,a),e=>e.pipe(cn(()=>{null!=r&&l.updateConsecutiveTimeouts(t,r,!1,"load")}),Jr(e=>e.pipe(on((e,t)=>function(e,t,i,r,n,a,s,o,l){var d;if(!(e instanceof v))return Lr(e);let u,c,h,p=!1;if(e instanceof $o)h={errorAction:Nm(Bm((d=e).response.code)["errorAction"],d.response.code),errorActionFlags:0};else if(e instanceof Qo||e instanceof qo){({mediaOptionType:c,mediaOptionId:u,isTimeout:p}=e);const t=null===(d=a.mediaOptionListQueries[c])||void 0===d?void 0:d.mediaOptionFromId(u);if(!r&&e.isTimeout&&null!=t&&(!("iframes"in t)||!0!==t.iframes)&&(s.updateConsecutiveTimeouts(a.itemId,e.mediaOptionType,!0,"load"),e instanceof qo&&e.stats)){const t=performance.now();o.setBandwidthSample(Object.assign(Object.assign({},e.stats),{tfirst:e.stats.tfirst||t,tload:e.stats.tload||t,complete:!0,mediaOptionType:c}))}h=Um(e,r,n,a,s)}return Km(e,t,i,h,a,s,l,c,u,p)}(e,t,zo(e,n),s,a,o,l,d,i)))))}function bg(r,n,a,s,o=!1){var l,d,u,c=r.mediaOptionId===n.mediaOptionId;if("VOD"!==r.type&&r.iframesOnly===n.iframesOnly&&(!a||c)){s=s.child({name:"live"});let e=z(null===(s=n.parts)||void 0===s?void 0:s.length);o||e&&(n.parts=[],n.partStartSN=n.partEndSN=n.partEndIndex=NaN,n.partTargetDuration=NaN,e=!1);const p=r.fragments,m=n.fragments,f=r.parts,g=n.parts,y=z(null==m?void 0:m.length)&&0<m.length;!function(e,r){const t=e.fragments,i=r.fragments;let n=0;var a=qc(t,r.startSN),e=qc(i,r.startSN);if(a&&e&&(n=a.discoSeqNum-e.discoSeqNum),0!==n){const s={};i.forEach(e=>{var t=e.discoSeqNum,i=t+n;r.initSegments[t]&&(s[i]=r.initSegments[t],s[i].discoSeqNum=i),e.discoSeqNum=i}),r.initSegments=s}}(r,n);let t=null,i=null;if(c&&(y&&(t=Tg(p,m)),e&&(i=Tg(f,g))),t||i){if(i&&(yg(n,i,i.start,!1,!0),!t&&y&&0===i.partIndex&&(t=qc(m,i.mediaSeqNum,NaN),Eg(t,i),yg(n,t,t.start,!1,!0))),t&&(yg(n,t,t.start,!1,!0),!i&&e)){const r=mg(g,t.mediaSeqNum,0);0<=r&&(i=g[r],Eg(i,t),yg(n,i,i.start,!1,!0))}}else(m.length||e)&&(m.length&&Ag(p,m,r),e&&Ag(f,g,r));if(a){const a=n.startSN-r.startSN,v=null===(h=p[a])||void 0===h?void 0:h.discoSeqNum;if(z(v)){for(const[a,S]of Object.entries(r.initSegments)){const r=Number(a);r>=v&&!n.initSegments[r]&&(n.initSegments[r]=S)}for(const[a,S]of Object.entries(r.discoToMSNMap)){const r=Number(a);if(r>=v){const a=Math.max(n.startSN,Math.min(null!==(l=null===(l=n.discoToMSNMap[r])||void 0===l?void 0:l[0])&&void 0!==l?l:1/0,S[0])),v=null!==(l=null===(l=n.discoToMSNMap[r])||void 0===l?void 0:l[1])&&void 0!==l?l:S[1];n.discoToMSNMap[r]=[a,v]}}}const S=p.slice(a),s=S[S.length-1].keyTagInfo;if(s)for(const r of m){if((null===(d=r.keyTagInfo)||void 0===d?void 0:d.uri)!==s.uri||(null===(d=r.keyTagInfo)||void 0===d?void 0:d.iv)!==s.iv)break;r.keyTagInfo=s}if(n.fragments=S.concat(m),e){const a=mg(r.parts,n.partStartSN,0),v=f.slice(a),S=v[v.length-1].keyTagInfo;if(S)for(const r of g){if((null===(u=r.keyTagInfo)||void 0===u?void 0:u.uri)!==S.uri||(null===(u=r.keyTagInfo)||void 0===u?void 0:u.iv)!==S.iv)break;r.keyTagInfo=S}n.parts=v.concat(g)}n.fragments.length?n.averagetargetduration=(ef(n,!1)-Zm(n,!1))/n.fragments.length:n.averagetargetduration=n.targetduration,(0<n.pdtToMSN.length||0<r.pdtToMSN.length)&&(n.pdtToMSN=function(i,r){var n=i.fragments;let e=i.pdtToMSN;if(r.startSN>i.startSN){const l=r.fragments[0],t=r.startSN,a=i.pdtToMSN.findIndex(([,e])=>{if(e>=t)return!0});if(e=-1!==a?i.pdtToMSN.slice(a):[],!e.length||e[0][1]!==t){let t=l.programDateTime;if(!z(t)){let e=0;i.pdtToMSN.length&&(e=i.pdtToMSN[0][0]),t=e+1e3*(l.start-n[0].start)}e.unshift([t,r.startSN])}}const t=rf(i,i.endSN),a=null==t?void 0:t.discoSeqNum,s=r.pdtToMSN,o=s.findIndex(([,e])=>{e=rf(r,e);if((null==e?void 0:e.discoSeqNum)>a)return!0});return e=-1!==o?e.concat(s.slice(o)):e.concat(s),e}(r,n))}var h=Zm(n,o),o=ef(n,o);n.ptsKnown=n.ptsKnown||c&&!0===r.ptsKnown&&r.endSN>=n.startSN,n.totalduration=o-h}}function Tg(t,i){let r=null;for(let e=0;e<(null==i?void 0:i.length);e++){const n=i[e],a=qc(t,n.mediaSeqNum,n.partIndex);n&&null!=(null==a?void 0:a.startPts)&&(n.start=a.start,n.duration=a.duration,n.startPts=a.startPts,n.endPts=a.endPts,r=n)}return r}function Eg(e,t){e.start=t.start,e.startPts=t.startPts,e.endPts=c(t.startPts,e.duration)}function Ag(e,t,i){var r=t[0],n=Math.max(0,r.start);let a=0;var s=qc(e,r.mediaSeqNum,r.partIndex);if(s)a=s.start-n;else if(r.part){const t=e[e.length-1];if(t){const o=t.mediaSeqNum,l=t.partIndex;if(o===r.mediaSeqNum&&l===r.partIndex-1||o===r.mediaSeqNum-1&&0===r.partIndex)a=t.start+t.duration-n;else if(null!==(e=i.fragments)&&void 0!==e&&e.length){const o=ef(i,!1),t=r.mediaSeqNum-i.endSN-1,l=r.partIndex;a=o+t*i.averagetargetduration+l*i.partTargetDuration-n}else{const o=ef(i,!0),t=Math.ceil(i.targetduration/i.partTargetDuration);a=o+((r.mediaSeqNum-i.partEndSN-1)*t+t-i.partEndIndex-1+r.partIndex)*i.partTargetDuration-n}}}else a=ef(i)+(r.mediaSeqNum-i.endSN-1)*i.averagetargetduration-n;!function(t,i){i<0&&(i=0);for(let e=0;e<t.length;++e)t[e].start+=i}(t,a)}class Og extends Sa{constructor(e,t){super(e);var{itemId:e,mediaOptionId:t}=this.mediaOption=t;this.mediaOption={itemId:e,mediaOptionId:t}}get itemId(){var e;return null===(e=this.mediaOption)||void 0===e?void 0:e.itemId}get mediaOptionId(){return this.mediaOption.mediaOptionId}get initSegmentEntities(){var e;return null===(e=this.mediaOptionDetailsEntity)||void 0===e?void 0:e.initSegmentCacheEntities}get mediaLibraryEntity(){return this.getEntity(this.itemId)}get mediaOptionDetailsEntityRecord(){var e;return null===(e=this.mediaLibraryEntity)||void 0===e?void 0:e.mediaOptionDetailsEntityRecord}lastUpdatedDetailsEntityByType(t){var i,r=this.mediaOptionDetailsEntityRecord;if(r){let e;for(const a of Object.keys(r)){var n=r[a];(t===(null===(i=n.mediaOptionDetails)||void 0===i?void 0:i.mediaOptionType)&&n&&!e||n&&e&&(null==n?void 0:n.lastUpdateMillis)<(null==e?void 0:e.lastUpdateMillis))&&(e=n)}return e}}get mediaOptionDetailsEntity(){return this.mediaOptionDetailsEntityRecord?this.mediaOptionDetailsEntityRecord[this.mediaOptionId]:null}get mediaOptionDetails(){var e;return null===(e=this.mediaOptionDetailsEntity)||void 0===e?void 0:e.mediaOptionDetails}get playlistDuration(){var e;return null===(e=this.mediaOptionDetailsEntity)||void 0===e?void 0:e.playlistDuration}get mediaOptionDetailsEntity$(){const{itemId:e,mediaOptionId:t}=this;return this.selectEntity(e,e=>{if(null!=e&&e.mediaOptionDetailsEntityRecord)return null==e?void 0:e.mediaOptionDetailsEntityRecord[t]})}get mediaOptionDetails$(){return this.selectEntity(this.itemId,e=>{return null===(e=null==e?void 0:e.mediaOptionDetailsEntityRecord[this.mediaOptionId])||void 0===e?void 0:e.mediaOptionDetails}).pipe(_d())}get playlistDuration$(){return this.mediaOptionDetailsEntity$.pipe(sr(e=>null==e?void 0:e.playlistDuration),_d(),xr())}get live$(){return this.mediaOptionDetails$.pipe(sr(e=>null==e?void 0:e.liveOrEvent),xr())}get liveEdgeGrows$(){return this.mediaOptionDetails$.pipe(sr(e=>e.endSN),xr((e,t)=>t<=e),an(1),Mr(!0))}}class wg extends pa{constructor(){super({},{name:"media-library-store",idKey:"itemId"})}}function Rg(e,t){var{trequest:i,tfirst:r,tload:n,loaded:t}=t;return e.trequest=i,e.tfirst=r,e.tload=n,e.loaded=t,e}function Cg(e){return e.itemId+e.mediaOptionId+e.mediaSeqNum+e.discoSeqNum+(null!==(e=e.partIndex)&&void 0!==e?e:"")}(Ea=og=og||{})[Ea.DISABLED=0]="DISABLED",Ea[Ea.ERRORED=1]="ERRORED",Ea[Ea.SUCCESS=2]="SUCCESS",Ea[Ea.IN_PROGRESS=3]="IN_PROGRESS",(Ea=lg=lg||{})[Ea.Manifest=0]="Manifest",Ea[Ea.Playlist=1]="Playlist",Ea[Ea.Segment=2]="Segment";class kg{constructor(e,t){this._store=e,this.hlsService=t,this.inFlightDetails=null,this._initSegmentRequests$={},this._cachedFrag$=[void 0,void 0],this.queryMap=new Map,this.inFlightFragStats=[],this.prefetchItems={},this._query=new Sa(e)}get query(){return this._query}getQueryForOption(e){var t=e.itemId+e.mediaOptionId;let i=this.queryMap.get(t);return i||(i=new Og(this._store,{itemId:e.itemId,mediaOptionId:e.mediaOptionId}),this.queryMap.set(t,i)),i}createMediaLibraryEntity(e){this._store.add({itemId:e,mediaOptionDetailsEntityRecord:{}})}_libraryEntityForDetails(t,i,e){var r=t["mediaOptionId"],t=this.getQueryForOption(t);if(e||null!==(e=t.mediaOptionDetailsEntityRecord)&&void 0!==e&&e[r]){t=t.mediaOptionDetailsEntityRecord;let e=null==t?void 0:t[r];return e=e||{initSegmentCacheEntities:{},unchangedCount:0},{mediaOptionDetailsEntityRecord:Object.assign(Object.assign({},t),{[r]:Object.assign(Object.assign({},e),i)})}}}_updateDetails(e,t,i){i=this._libraryEntityForDetails(e,t,i);i&&this._store.update(e.itemId,i)}setDetailsLoading(e,t=!0){this._updateDetails(e,{detailsLoading:t},!0)}setLastAccessed(e){this._updateDetails(e,{lastAccessedMillis:performance.now()},!1)}retrieveMediaOptionDetails(e,t,i=!1,r=!1){if(null==t||!Ro(t))return Pr(null);const n=t["itemId"],a=this.getQueryForOption(t);a.hasEntity(n)||this.createMediaLibraryEntity(n);const{rootPlaylistQuery:s,rootPlaylistService:o,config:l}=e,d=l.enableItemPreloading&&this._getSegmentRecord(s.appItemId);if(d){const e=d.cache["details"],i=e;if(i&&i.mediaOptionId===t.mediaOptionId&&i.url===t.url)return i.fragments.forEach(e=>{e.start+=s.itemStartPosition}),this.archiveMediaOptionDetails(o,i,{tfirst:0,tload:0,total:1,trequest:0,loaded:1,complete:!0},!0),Pr(i)}var u=a.mediaOptionDetailsEntity,c=a.mediaOptionDetails;return null==c||r||"VOD"!==c.type&&(!c.liveOrEvent||Wf(c,u.lastUpdateMillis))?(this.setDetailsLoading(t),this.getMediaOptionDetailsCommon(e,t,i)):(this.setLastAccessed(t),Pr(c).pipe().pipe(kr(1)))}getMediaOptionDetailsCommon(e,t,i){const{logger:r,config:n,rootPlaylistQuery:a,rootPlaylistService:s,statsService:o,rtcService:l,interstitialService:d,customUrlLoader:u,itemQueue:c}=e,h=n.playlistLoadPolicy,p=n.keySystemPreference,m=a.masterVariableList,f=this.hlsService.query.extendMaxTTFB,g=this.getQueryForOption(t),y=null==g?void 0:g.mediaOptionDetails,v=null==g?void 0:g.lastUpdatedDetailsEntityByType(t.mediaOptionType),S=null==v?void 0:v.mediaOptionDetails,I={trequest:NaN,tfirst:NaN,tload:NaN,tparse:NaN,tparsed:NaN,loaded:0};return hg(t,a.baseUrl,a.itemStartPosition,n,n,h,u,r,p,m,f,y,S).pipe(cn(e=>{Rg(I,e.bwSample),I.tparsed=performance.now(),I.tparse=I.tparsed-e.playlistSample.playlistParseTimeMs,null==l||l.handleLevelParsed(e.playlistSample.tparsed)}),Ig(t.itemId,c,t.mediaOptionType,Go(t,h),n.maxNumAddLevelToPenaltyBox,i,a,s,o),sr(Mg(t,a,s,this,d,o,n,r)))}archiveMediaOptionDetails(n,a,s,o,e=!1){const{itemId:l,mediaOptionId:d}=a,u=performance.now(),c=ef(a,e);Object.isFrozen(a)||Object.freeze(a),da(()=>{this._query.hasEntity(l)||this.createMediaLibraryEntity(l);const e=this._libraryEntityForDetails(a,{detailsLoading:!1,lastUpdateMillis:u,lastAccessedMillis:u,stats:s},!0);if(e){const t=e.mediaOptionDetailsEntityRecord,i=t[d];o?(i.mediaOptionDetails=a,i.playlistDuration=c,i.unchangedCount=0,e.liveOrEvent=a.liveOrEvent):++i.unchangedCount;const r=function(t,i,r,n=2){const a=[],s=Object.values(t).filter(e=>{var t;return(null===(t=e.mediaOptionDetails)||void 0===t?void 0:t.mediaOptionType)===i&&(null===(t=e.mediaOptionDetails)||void 0===t?void 0:t.iframesOnly)===r&&null!=e.lastAccessedMillis}).sort((e,t)=>e.lastAccessedMillis-t.lastAccessedMillis);for(let e=0;e<s.length-n;++e){const r=s[e].mediaOptionDetails;a.push(r),delete t[r.mediaOptionId]}return a}(t,a.mediaOptionType,a.iframesOnly);r.forEach(e=>{e=e.itemId+e.mediaOptionId;this.queryMap.delete(e)}),this._store.update(l,e),n.setLastLoadedMediaOptionByType(a.itemId,a.mediaOptionType,a)}})}archiveInitSegmentEntity(e,t){var i;if(e||t){const{itemId:r,mediaOptionId:n,discoSeqNum:a}=e||t,s=this._libraryEntityForDetails({itemId:r,mediaOptionId:n},{},!1),o=null===(i=null==s?void 0:s.mediaOptionDetailsEntityRecord)||void 0===i?void 0:i[n];o&&(o.initSegmentCacheEntities=Object.assign(Object.assign({},o.initSegmentCacheEntities),{[a]:[e,t]}),this._store.update(r,s))}}retrieveInitSegmentCacheEntity(e,t,i){var{mediaOptionDetailsEntityRecord:r,mediaOptionDetails:n}=this.getQueryForOption(t),a=t["mediaOptionId"];if(null==r||!r[a])throw new Error("retrieveInitSegmentCacheEntity no details entity");if(!n)throw new Error("retrieveInitSegmentCacheEntity no details");var a=r[a]["initSegmentCacheEntities"];if(a[i]){const[e,t]=a[i];return Pr(t||e)}return this.fetchInitSegmentCacheEntity(e,n,t,i)}fetchInitSegmentCacheEntity(r,e,n,t){if(!e)throw new Error("fetchInitSegmentCacheEntity no details");const i=e["initSegments"],a=i[t];if(!Pg(a))return Pr(null);const s=Cg(a);let o=this._initSegmentRequests$[s];return o=o||(this._initSegmentRequests$[s]=Pn(()=>{const i={trequest:NaN,tfirst:NaN,tload:NaN,tparse:NaN,tparsed:NaN,loaded:0};return xg(r,a,!1).pipe(tr(Cn),on(({loadedData:e,bwSample:t})=>(Rg(i,t),i.tparse=performance.now(),this.parseInitSegment(e,a,n,r))),cn(()=>{i.tparsed=performance.now()}),Br(()=>{delete this._initSegmentRequests$[s]}))}).pipe(tn())),o}parseInitSegment(e,i,r,n){const{rootPlaylistService:t,rootPlaylistQuery:a,mediaParser:s,itemQueue:o}=n,{mediaOptionId:l,mediaOptionType:d}=i,u={segment:void 0,initSegment:new Uint8Array(e),frag:i,ptsKnown:void 0,seeking:void 0,live:void 0,totalDuration:void 0},c=performance.now();return s.parseInitSegment(u,null!==(e=null===navigator||void 0===navigator?void 0:navigator.vendor)&&void 0!==e?e:"").pipe(sr(e=>{var t=performance.now();return n.statsService.setInitFragSample({tparsed:{tbegin:c,tend:t}}),this.archiveInitSegment(e,i,r,n)}),Sg(t,a,o,d,l))}archiveInitSegment(e,t,i,r){const{gaplessInstance:n,config:a}=r;if(!a.supportGaplessVideo){const t=e["track"];n.inGaplessMode&&Re.isVideoCodec(t.codec)&&!a.enableInterstitialPlayback&&n.dequeueSource("InvalidFormat")}i=Lg(e,t,i);return this.archiveInitSegmentEntity(i),i}cacheFrag(e,t){const i=Cg(t),s=t["mediaOptionType"];if(s!==Ys.Subtitle){this.isCachingFrag(t)&&this.clearCacheFragRequest(t.mediaOptionType);var r=new Hr,n=s===Ys.Variant?{getData:!1,cb:(e,t,i,r)=>{var n;const a=null===(n=this._cachedFrag$[s])||void 0===n?void 0:n.onProgressCb;return!!a&&a(e,t,i,r)},samplePeriodMs:e.config.abrSamplePeriodMs}:void 0;return this._cachedFrag$[s]={id:i,result$:r,sub:this._getFragmentAndInitSegment(e,!0,t,n).subscribe(r)},r}}isCachingFrag(e){var t=e["mediaOptionType"];return t!==Ys.Subtitle&&(null===(t=this._cachedFrag$[t])||void 0===t?void 0:t.id)===Cg(e)}clearCacheFragRequest(e){e!==Ys.Subtitle&&this._cachedFrag$[e]&&(this._cachedFrag$[e].sub.unsubscribe(),this._cachedFrag$[e]=void 0)}isSongEnhanced(e,t){return e.sessionData.itemList.some(e=>"com.apple.hls.AudioSessionKeyInfo"===e["DATA-ID"]||"com.apple.hls.audioAssetMetadata"===e["DATA-ID"])}_getFragmentSizes(t,e,i,r,n,a){var{mediaOptionId:s,mediaOptionType:o,duration:l}=e,n=n.partialAppendDurationSec;let d=!1,u=0;if(t&&this.isSongEnhanced(r,a)&&z(n)&&0<n&&o===Ys.Variant&&!i.liveOrEvent&&0===e.start&&!z(e.startPts)){const t=r.variantMediaOptionById(s);u=C(t.avgBandwidth,t.bandwidth);let e=1;const i=r.enabledAlternateMediaOptionByType(Ys.AltAudio);i&&(e=Co(i)&&Ro(i)?2:1),d=1===e&&!t.videoCodec&&z(u)&&0<u&&n<l}let c=e.byteRangeOffset.end;if(d){const t=e.byteRangeOffset.start+Math.floor(u/8*n);t>=c?d=!1:c=t}return d?{partial:!0,duration:n,end:c}:{partial:!1,duration:e.duration,end:c}}createCoalescedFrag(e,t,i,r){const n=Cg(i);if(!Pg(i)||this._initSegmentRequests$[n])return null;{const e={start:i.byteRangeOffset.start,end:r.end},n=Object.assign(Object.assign({},t),{duration:r.duration,byteRangeOffset:e,dataOffset:t.byteRangeOffset.start-i.byteRangeOffset.start});return r.partial&&(n.partialFrag=!0),n}}coalesceSegmentData(a,s){return e=>e.pipe(tr(Cn),on(e=>{var{mediaFragment:t,loadedData:i}=e;if(z(t.dataOffset)){var r=t.dataOffset,n=Object.assign(Object.assign({},s),{keyTagInfo:t.keyTagInfo}),t=new Uint8Array(i,r);return Ln([this.parseInitSegment(new Uint8Array(i,0,r),n,n,a),Pr(Object.assign(Object.assign({},e),{loadedData:t}))])}return Pr([null,e])}))}recallCache(r,n,a,e){var t;const{rootPlaylistQuery:i,config:s}=r,o=a.mediaOptionType;if(o===Ys.Subtitle)throw Error("recallCache invalid type");const l=i.baseUrl,d=s.enableItemPreloading&&null!==(t=this.getPrefetchCache(i.appItemId))&&void 0!==t?t:{},{rootEntity:u,fragRequest:c}=d;return u&&l===u.baseUrl&&c&&c.id===Cg(a)?c.result$.pipe(Wi(e=>{throw this.clearPrefetchCache(),e}),on(e=>{var[t,i]=e,e=n.initSegments[a.discoSeqNum];return t?Ln([this.parseInitSegment(t.loadedData,e,a,r),Pr(i)]):Pr(i).pipe(this.coalesceSegmentData(r,e))})):this.isCachingFrag(a)?(this._cachedFrag$[o].onProgressCb=null==e?void 0:e.cb,this._cachedFrag$[o].result$.pipe(Br(()=>{this.clearCacheFragRequest(o)}))):void(this._cachedFrag$[o]&&this.clearCacheFragRequest(o))}_getFragmentAndInitSegment(e,t,i,r){const{config:n,rootPlaylistQuery:a,logger:s}=e,o=i["mediaOptionType"],l=this.getQueryForOption(i),{mediaOptionId:d,discoSeqNum:u}=i,c=l.mediaOptionDetails;if(o===Ys.Subtitle)throw Error("_getFragmentAndInitSegment invalid type");var h=this.recallCache(e,c,i,r);if(h)return h;if((null===(h=null===(h=l.mediaOptionDetailsEntityRecord[d])||void 0===h?void 0:h.initSegmentCacheEntities)||void 0===h||!h[u])&&_g(c,i)){const p=c.initSegments[i.discoSeqNum],h=this._getFragmentSizes(t,i,l.mediaOptionDetails,a,n,s),o=this.createCoalescedFrag(e,i,p,h);if(o)return xg(e,o,null==e.rtcService.serverInfoInstance,r).pipe(this.coalesceSegmentData(e,p))}return Ln([this.retrieveInitSegmentCacheEntity(e,i,i.discoSeqNum),xg(e,i,null==e.rtcService.serverInfoInstance,r)])}retrieveMediaFragmentCacheEntity(a,s,e,t){if(s===Ys.Subtitle)throw new Error("retrieveMediaFragmentCacheEntity: wrong mediaOptionType");const o=a["rootPlaylistQuery"],{timelineOffset:l,mediaFragment:i}=e.foundFrag,d=i["discoSeqNum"],r=this._getFragmentAndInitSegment(a,!1,i,t).pipe(on(([e,{mediaFragment:t,loadedData:i,bwSample:r,serverInfo:n}])=>{return this.inFlightFragStats[s]&&Rg(this.inFlightFragStats[s],r),a.statsService.setBandwidthSample(Object.assign(Object.assign({},r),{mediaOptionType:t.mediaOptionType})),n&&null==a.rtcService.serverInfoInstance&&(a.rtcService.serverInfoInstance=n),a.playerEvents.triggerFragLoaded(t,r),$g(a,s,t,"parsing",null),function(e,t,i,S,I,b){var r;const n=new Uint8Array(e),{legibleSystemAdapter:a,rootPlaylistService:s,mediaSink:o,mediaParser:T,rootPlaylistQuery:l,mediaLibraryService:E,itemQueue:d}=b,u=o["mediaQuery"],A=E.getQueryForOption(S),{mediaOption:c,mediaOptionDetails:h,mediaOptionDetailsEntityRecord:p}=A,m=h["initSegments"],{itemId:O,mediaOptionId:w}=c,f=p[w]["initSegmentCacheEntities"],{discoSeqNum:R,mediaSeqNum:C,mediaOptionType:k,isLastFragment:M,part:P=!1,partIndex:L=NaN}=S,g=u.seeking,y=h.liveOrEvent,v=m[R],x=f[R],D=k===Ys.Variant&&h.ptsKnown,_={segment:n,frag:S,seeking:g,live:y,ptsKnown:D,totalDuration:h.totalduration,defaultInitPTS:t,iframeMediaStart:jh(S)?S.iframeMediaStart:void 0,iframeDuration:jh(S)?S.iframeMediaDuration:void 0,iframeOriginalStart:jh(S)?S.iframeOriginalStart:void 0};let N;if(null!=i&&(null===(r=S.keyTagInfo)||void 0===r?void 0:r.uri)===(null===(r=i.keyTagInfo)||void 0===r?void 0:r.uri)&&(null===(r=S.keyTagInfo)||void 0===r?void 0:r.iv)===(null===(r=i.keyTagInfo)||void 0===r?void 0:r.iv)){if(N=Pr(i),x){const e=x[0];if(e){const t=e["data"],i=new Uint8Array(t);_.initSegment=i}}}else if(null!=i&&Pg(i.fragment)){const t=Object.assign(Object.assign({},i.fragment),{keyTagInfo:S.keyTagInfo}),I=v?i.data:e;N=E.parseInitSegment(I,t,c,b),_.initSegment=new Uint8Array(I)}else Pg(S)?(N=E.parseInitSegment(e,S,c,b),_.initSegment=n):N=Pr(null);return N.pipe(on(y=>{const v=performance.now();return k===Ys.Variant&&(null==a||a.setupForFrag(S)),T.parseSegment(_,"").pipe(sr(e=>{var t=performance.now(),{startPTS:i,startDTS:r,endPTS:n,endDTS:a,firstKeyframePts:s,framesWithoutIDR:o,largestVideoSampleSize:l,dropped:d,data1:u,data2:c,captionData:h,id3Samples:p,parsedInitSegment:e}=e,t={durationSec:n.baseTime/n.timescale-i.baseTime/i.timescale,parseTimeMs:t-v,tparsed:{tbegin:v,tend:t}};if(b.statsService.setFragSample(t),e){const{track:v,moovData:g,mimeType:I}=e,b=v["initSegment"];y=null===y?Lg(e,S,A):{itemId:O,mediaOptionId:w,discoSeqNum:R,initParsedData:g,data:b,mimeType:I,keyTagInfo:S.keyTagInfo,fragment:S};const n=x?x[0]:null;E.archiveInitSegmentEntity(n,y)}const m=S.keyTagInfo,f={itemId:O,mediaOptionId:w,mediaOptionType:k,mediaSeqNum:C,discoSeqNum:R,part:P,partIndex:L,startDtsTs:r,endDtsTs:a,timelineOffset:I,firstKeyframePts:s,framesWithoutIDR:o,largestVideoSampleSize:l,dropped:d,data1:u,data2:c,startPts:i,endPts:n,keyTagInfo:m,isLastFragment:M,iframe:null!==(n=S.iframe)&&void 0!==n&&n,duration:S.duration,iframeMediaDuration:jh(S)?S.iframeMediaDuration:void 0,iframeOriginalStart:jh(S)?S.iframeOriginalStart:void 0,captionData:h,id3Samples:p};return S.partialFrag&&(f.partialFrag=!0,T.reset()),[y,f]}))}),Sg(s,l,d,k,w))}(i,null===(i=o.getInitPTS(d))||void 0===i?void 0:i.offsetTimestamp,e,t,l,a)}),cn(()=>{$g(a,s,i,"parsed",null)}));return r}updatePTSDTS(e,t,i,r,n=!1){var a=null===(l=this.getQueryForOption({itemId:e,mediaOptionId:t}))||void 0===l?void 0:l.mediaOptionDetails;if(a&&fg(a,r)&&!i.iframeMode&&!r.iframe){var{startDtsTs:s,mediaSeqNum:o,part:e=!1,partIndex:t=NaN}=r,{variantDTS:l,timelineOffset:i}=i,l=w(s,l)+i,i=Object.assign({},a);if(yg(i,r,l,!0,!1,n),!e&&0<(null===(a=i.parts)||void 0===a?void 0:a.length)){const d=i["parts"],u=mg(d,o,0);-1!==u&&yg(i,Object.assign(Object.assign({},d[u]),{startPts:r.startPts,endPts:c(r.startPts,d[u].duration),startDtsTs:r.startDtsTs}),l,!0,!1,n)}else if(e){const d=i["fragments"];if(0===t){const u=qc(d,o);u&&yg(i,Object.assign(Object.assign({},u),{startPts:r.startPts,endPts:c(r.startPts,u.duration),startDtsTs:r.startDtsTs}),l,!0,!1,n)}}n=ef(i,n);this._updateDetails(i,{mediaOptionDetails:i,playlistDuration:n},!1)}}remove(e){this._store.remove(e)}clear(e=!0){this._cachedFrag$.forEach((e,t)=>this.clearCacheFragRequest(t)),e&&this.clearPrefetchCache(),this._initSegmentRequests$={},this._store.remove(),this.queryMap.clear()}clearPrefetchCache(){Object.values(this.prefetchItems).forEach(e=>{const t=e.cache,i=t["fragRequest"];i&&i.sub.unsubscribe(),e.cache={}}),this.prefetchItems={}}addPrefetchItem(e,t,i){var r=this.prefetchItems[e];r&&r.cache.rootEntity||(r={cache:{},status:og.IN_PROGRESS},this.prefetchItems[e]=r)}_getSegmentRecord(e){if(e)return this.prefetchItems[e]}getSegmentRecord(e){return this._getSegmentRecord(e)}getPrefetchCache(e){return null===(e=this.getSegmentRecord(e))||void 0===e?void 0:e.cache}cachePrefetchRootEntity(e,t){const i=this._getSegmentRecord(e);i&&(i.cache.rootEntity=t)}cachePrefetchDetails(e,t){const i=this._getSegmentRecord(e);i&&(i.cache.details=t)}cachePrefetchSegment(e,t,i,r){const n=this._getSegmentRecord(t);if(n){var{rootEntity:a,fragRequest:s}=n.cache;if(!s&&a){const o=a.baseUrl,l=new Hr,d={id:Cg(r),result$:l,sub:this._prefetchFragmentAndInitSegment(e,o,t,i,r).pipe(Xo(r,!1),cn(e=>{n&&(n.status=og.SUCCESS)})).subscribe(l)};return n.cache.fragRequest=d,d.result$.pipe(sr(()=>og.SUCCESS))}}}_prefetchFragmentAndInitSegment(e,t,i,r,n){const a=n["mediaOptionType"];if(a===Ys.Subtitle)throw Error("_getFragmentAndInitSegment invalid type");var s=null!==(o=r.url)&&void 0!==o?o:so(r.relativeUrl,t),o=null==e.rtcService.serverInfoInstance;if(_g(r,n)){const l=r.initSegments[n.discoSeqNum],d={start:l.byteRangeOffset.start,end:null===(t=n.byteRangeOffset)||void 0===t?void 0:t.end,duration:n.duration,partial:!1},a=this.createCoalescedFrag(e,n,l,d);if(a)return Dg(e,s,a,o).pipe(Ng(e,a,i)).pipe(sr(e=>[null,e]))}r=r.initSegments[n.discoSeqNum];return Ln([r?Dg(e,s,r,o).pipe(Ng(e,r,i)):Pr(null),Dg(e,s,n,o).pipe(Ng(e,n,i))])}setPrefetchErrored(e,t){const i=this._getSegmentRecord(e);if(i&&(i.status=og.ERRORED,null==t||t===lg.Segment)){const e=i["cache"];null===(t=e.fragRequest)||void 0===t||t.sub.unsubscribe(),e.fragRequest=void 0}}}function Mg(c,h,p,m,f,g,y,v){return e=>{const t=m.getQueryForOption(c),i=t.mediaOptionDetails,{mediaOptionDetails:r,interstitials:n,isDeltaPlaylist:a}=e,{bwSample:s,playlistSample:o}=e;let l=!0;if(r.liveOrEvent||null!=i&&i.liveOrEvent)if(r.endSN<(null==i?void 0:i.endSN)||r.partEndSN<(null==i?void 0:i.partEndSN)||r.partEndSN===(null==i?void 0:i.partEndSN)&&r.partEndIndex<(null==i?void 0:i.partEndIndex))l=!1;else{const c=r["mediaOptionType"];l=Yf(i,r),!l&&y.liveAllowLowLatencyPlayback&&(l=Xf(i,r)),""===r.type&&(r.type="LIVE"),i&&bg(i,r,a,v,y.liveAllowLowLatencyPlayback);const p=h.lastLoadedMediaOptionByType(c),f=p?null===(e=m.getQueryForOption(p))||void 0===e?void 0:e.mediaOptionDetails:null;!r.ptsKnown&&f&&f.mediaOptionId!==(null==i?void 0:i.mediaOptionId)&&bg(f,r,a,v,y.liveAllowLowLatencyPlayback)}else""===r.type&&(r.type="VOD");const d=f.interstitialQuery,u=d.getInterstitialAssetForId(r.itemId);if(null!=u){const c=d.getInterstitialForId(u.parentIdentifier),h=u.duration||0,p=tf(r,y.liveAllowLowLatencyPlayback),m=c.duration||0;da(()=>{f.updateInterstitialAsset(u.identifier,{duration:p}),f.updateInterstitial(c.identifier,{duration:Math.max(m-h,0)+p})})}if(da(()=>{r&&m.archiveMediaOptionDetails(p,r,s,l,y.liveAllowLowLatencyPlayback),n&&0<n.length&&f.addInterstitials(n),g.setPlaylistSample(o)}),!l&&t.mediaOptionDetailsEntity.unchangedCount>=y.liveMaxUnchangedPlaylistRefresh){const h=G.LivePlaylistUpdateError;throw new Qo(!1,h.text,h,!1,c.mediaOptionType,c.mediaOptionId,i.url)}return r}}function Pg(e){return!0===(null==e?void 0:e.isInitSegment)}function Lg(e,t,i){var{itemId:r,mediaOptionId:n}=i,{keyTagInfo:a,discoSeqNum:s}=t,{track:o,moovData:i,mimeType:e}=e,o=o["initSegment"];return{itemId:r,mediaOptionId:n,discoSeqNum:s,initParsedData:i,data:o,mimeType:e,keyTagInfo:a,fragment:t}}function xg(n,t,i,r){var e;const{rootPlaylistQuery:a,rootPlaylistService:s,config:o,statsService:l,customUrlLoader:d,itemQueue:u,hlsService:c}=n,{itemId:h,mediaOptionType:p,mediaOptionId:m}=t,f=o.fragLoadPolicy,g=z(t.mediaSeqNum),y=a.mediaOptionListQueries[p].mediaOptionFromId(m),v=null!==(e=y.url)&&void 0!==e?e:so(y.relativeUrl,a.baseUrl),S="mediaSink"in n,I=new oi(e=>{if(cl(t,v,o,f,d,0,r,i,c.query.extendMaxTTFB).pipe(Ig(h,u,p,Go(t,f),o.maxNumAddLevelToPenaltyBox,!1,a,s,l),cn(({mediaFragment:e})=>{g&&S&&$g(n,e.mediaOptionType,e,"loaded",null)})).subscribe(e),g&&S&&($g(n,p,t,"loading",null),t.mediaOptionType!==Ys.Subtitle)){const{start:i,duration:r}=t;n.mediaSink.updateInFlightRange(t.mediaOptionType,{start:i,end:i+r})}});return"AES-128"===(null===(e=t.keyTagInfo)||void 0===e?void 0:e.method)?Ln([Fg(n,t.keyTagInfo,{itemId:t.itemId,mediaOptionId:t.mediaOptionId,appItemId:a.appItemId}),I]).pipe(on(([e,t])=>{const{mediaFragment:i,loadedData:r}=t;return i.keyTagInfo.key=e.key,pg(i,r,o,n.logger,n.rpcClients.crypto).pipe(sr(e=>Object.assign(Object.assign({},t),{loadedData:e})))})):I}function Dg(e,t,i,r,n){const{config:a,customUrlLoader:s,hlsService:o}=e,l=a.fragLoadPolicy;return new oi(e=>{cl(i,t,a,l,s,0,n,r,o.query.extendMaxTTFB).pipe().subscribe(e)})}function _g(e,t){if(!e)return!1;var i=e.initSegments[t.discoSeqNum];return null!=i&&null!=i.byteRangeOffset&&i.byteRangeOffset.end===(null===(e=t.byteRangeOffset)||void 0===e?void 0:e.start)&&i.url===t.url}function Ng(n,i,r){return e=>{var t;return"AES-128"===(null===(t=i.keyTagInfo)||void 0===t?void 0:t.method)?Ln([Fg(n,i.keyTagInfo,{itemId:i.itemId,appItemId:r,mediaOptionId:i.mediaOptionId}),e]).pipe(on(([e,t])=>{const{mediaFragment:i,loadedData:r}=t;return i.keyTagInfo.key=e.key,pg(i,r,n.config,n.logger,n.rpcClients.crypto).pipe(sr(e=>Object.assign(Object.assign({},t),{loadedData:e})))})):e}}function Fg(e,t,i){const{keySystemAdapter:r,config:n}=e,a=n["keyLoadPolicy"];return r.getKeyFromDecryptData(t,i,a)}function Bg(t){return e=>e.pipe(sr(e=>Co(e)&&Ro(e)?t.getQueryForOption(e):null))}function Ug(i,r=NaN){return e=>{let t=e.pipe(Bg(i),on(e=>e?e.mediaOptionDetails$:Pr(null)));return z(r)&&0<=r&&(t=t.pipe(kr(r))),t}}function Vg(e,t){return ur([e.enabledMediaOptionByType$(Ys.Variant).pipe(Ug(t)),e.hasAlternateWithUrl(Ys.AltAudio)?e.enabledMediaOptionByType$(Ys.AltAudio).pipe(Ug(t)):Xl])}function $g(e,t,i,r,n,a=!0){const{rootPlaylistQuery:s,logger:o,mediaLibraryService:l}=e,d=s.itemId;if(performance.now(),e.rootPlaylistService.updateInflightFrag(d,t,i,r,null,n),a&&t!==Ys.Subtitle){const t=s.getInFlightFrags(),{config:i,mediaSink:r,statsService:n}=e;uf(i,o,s,r,l,n.getQueryForId(s.statsId),t)}}const Qg={name:"avpipe"},Kg=(o,l)=>e=>{var t;const{config:u,mediaSink:i,iframeClock:c,rootPlaylistQuery:h,rootPlaylistService:r}=o;o.logger.child({name:"anchor"});const p=i.mediaQuery,m=h.isInterstitial,n=p.desiredRate,a=o.config.liveAllowLowLatencyPlayback&&(0===n||1===n);let s;return s=p.readyState>=HTMLMediaElement.HAVE_METADATA&&!z(null===(t=p.seekTo)||void 0===t?void 0:t.pos)&&null==o.hlsQuery.pendingSeek?Vn(e.pipe(kr(1),on(e=>Pr({pos:Sf(p.currentTime,e,u),fromEvent:!1}))),p.seekTo$):p.seekTo$,s.pipe(xr((e,t)=>Math.abs((null==e?void 0:e.pos)-(null==t?void 0:t.pos))<Number.EPSILON&&(null==e?void 0:e.discoSeqNum)===(null==t?void 0:t.discoSeqNum)),_d(),sr((e,t)=>({seekTo:e,switchInfo:0===t?l:[null,null],seekIdx:t}))).pipe(on(({seekTo:o,switchInfo:l,seekIdx:d})=>e.pipe(xr((e,r)=>e&&r&&_m(e)===_m(r)&&Dm(e)===Dm(r)&&e.every((e,t)=>{var i;return!((null==e?void 0:e.endSN)!==(null===(i=r[t])||void 0===i?void 0:i.endSN)||a&&Xf(e,r[t]))})),on(e=>Jl(p.updating$,e=>!e).pipe(Mr(e))),on(e=>{var t,i,r=e[Ys.Variant].iframesOnly;let n=!1;var a=function(o,l,t,i,r,n,a){var s,d;const u=o[Ys.Variant].iframesOnly,c=o[Ys.Variant].itemId,{maxBufferHole:h,firstAudioMustOverlapVideoStart:p,maxFragLookUpTolerance:m,liveAllowLowLatencyPlayback:e}=a,f=t.getBufferInfo(l.pos,h,n?c:void 0),g=t.desiredRate,y=e&&o[Ys.Variant].liveOrEvent&&tp(g),v=i.map(e=>{return null!==(e=null===(e=null==e?void 0:e.switchContext)||void 0===e?void 0:e.userInitiated)&&void 0!==e&&e}),S=f.reduce((e,t,i)=>{const r=v[i],n=o[i],a=y||i===Ys.AltAudio&&p?0:m,s=function(e,t,i,r){if(!t)return Number.POSITIVE_INFINITY;r=null!=r?r:{start:e,end:e,len:0};t=null!=t&&t.iframesOnly?0:a;return i||0===r.len?e:r.end+t}(l.pos,n,r,t.buffered);return Math.min(s,e)},1/0);let I=NaN,b=NaN,T=NaN;if(T=u?(I=r.getCurrentTime().seconds,b=S,jm(o[Ys.Variant],I)):(I=S,b=S,z(l.discoSeqNum)?l.discoSeqNum:jm(o[Ys.Variant],I,y)),!z(T))return null;const E=[null,null],A=[null,null];for(let e=0;e<=A.length;++e){const i=o[e];if(null!=i){const r=null===(s=i.discoToMSNMap[T])||void 0===s?void 0:s[0];if(!z(r))return null;if(u){const o=t.desiredRate,n=i.discoToMSNMap[T][1],a=0<=o?r:n;E[e]=A[e]=Xm(Jm(i,a,I,o,f[e].buffered,f[e].bufferedSegments,[],m,v[e]))}else{const o=t.getBufferInfo(I,h,n?c:void 0)[e],{buffered:a,bufferedSegments:O}=o,s=Jm(i,r,I,1,a,O,t.getContentGapRanges(),m,v[e],NaN,y);(null==s?void 0:s.discoSeqNum)===T&&(A[e]=Xm(s),(p||s.start+s.duration<I)&&e===Ys.Variant&&(b=I=Math.min(s.start,I)))}}}for(let e=0;!u&&e<E.length;++e){const t=o[e];if(t){const i=A[e],r=(null==i?void 0:i.start)+(null==i?void 0:i.duration)>b&&(null==i?void 0:i.start)<=b?i:null===(d=zm(b,T,t,y))||void 0===d?void 0:d.mediaFragment;if(E[e]=Xm(r),!r)return null}}return{pos:b,discoSeqNum:T,anchorFrags:E,nextFrags:A,iframeMode:u,switchInfo:i}}(e,o,p,l,c,m,u);if(!a)return Cr;var s=h.getInFlightFrags(),s=r||function(r,n,e,a,t,s){var i=e.some(e=>null!=e)&&e.every((e,t)=>!e||zh(e,n[t])||zh(e,r.anchorFrags[t])),[o,l]=e;if(!i&&(null==o?void 0:o.discoSeqNum)===r.discoSeqNum&&(null==l?void 0:l.discoSeqNum)===r.discoSeqNum&&(!t||l.start<=o.start)){const n=r.pos;let t=-1/0,i=!0;if(e.forEach(e=>{t=Math.max(e.start),i=i&&e.start<=n&&e.start+e.duration>n}),i||a&&n<=t&&t-n<=s)return!1}return!i}(a,null!==(t=a.nextFrags)&&void 0!==t?t:[null,null],s,p.getBufferInfo(a.pos,u.maxBufferHole).every(e=>{return null===(e=null===(e=null==e?void 0:e.buffered)||void 0===e?void 0:e.len)||void 0===e||e}),u.firstAudioMustOverlapVideoStart,u.maxSeekHole);if(0<d&&p.readyState>=HTMLMediaElement.HAVE_METADATA&&null!==(i=p.combinedBuffer)&&void 0!==i&&i.length&&!r){const l=p.getMediaBufferInfo(o.pos,u.maxBufferHole);n=(l.combined.len||0)<Fc(u,e[Ys.Variant],l)}return Pr({anchorInfo:a,checkForSwitch:n,shouldUpdateAnchor:s,gotValidAnchor:_m(e)||e[Ys.Variant].iframesOnly})}),un(({gotValidAnchor:e})=>!e,!0))),ca(({anchorInfo:e,checkForSwitch:t,shouldUpdateAnchor:i})=>{i&&(t&&jf(to.Seek,h.enabledVariantMediaOption,o)&&(e=null),r.setAVAnchor(h.itemId,e))}))};function qg(t,e,i){return e&&e.start+e.duration>t||(null==i?void 0:i.some(e=>t>=e.start&&t<e.end))}function Hg(s,e,t,i,r,o){if(null==t)return null;const{mediaSink:n,config:a,interstitialController:l,rootPlaylistQuery:d,itemQueue:u}=s,c=n.mediaQuery,h=t["mediaOptionType"],p=l.fragmentIsInterstitialBoundary(t,s);if(h===Ys.Subtitle)return null;if(t.gap){if(!t.iframe){const e=new qo(!1,"fragment is a GAP",G.ContentHasGap,!1,{mediaOptionId:t.mediaOptionId,mediaOptionType:t.mediaOptionType}),i=Um(e,!1,a.maxNumAddLevelToPenaltyBox,s.rootPlaylistQuery,s.rootPlaylistService);i.errorAction===lm.DoNothing?n.updateContentGapRanges(Do(h),{start:t.start,end:t.start+t.duration}):Vm(i,e,s.rootPlaylistQuery,s.rootPlaylistService,u,h,t.mediaOptionId,!1),e.handled=!0}return null}const m=ep(i),f=function(t,i,r,n){let a=t;if(t.iframe){var s=t.start,o=r.end,i=t.duration/Math.abs(i);let e=1/n;r.len<.75&&(e=Math.max(e,.25));i=Math.max(i,e);a=Object.assign(Object.assign({},t),{iframeOriginalStart:s,start:o,iframeMediaStart:o,iframeMediaDuration:i})}return{foundFrag:{mediaFragment:a,timelineOffset:a.start},nextDisco:NaN}}(t,i,r,a.trickPlaybackConfig.minIframeDuration);let g=f.foundFrag.mediaFragment;return m&&h===Ys.AltAudio&&(g=Object.assign(Object.assign({},g),{start:r.end})),$g(s,h,g,"waiting",null,!1),p.pipe(on(e=>{const r=d.enabledMediaOptionSwitchContexts[h];if(e)return Cr;const t=null!=r&&!0===r.userInitiated,i=null==r?void 0:r.triggerEvent,n=[];if(!o&&!t){const s=g.start,a=c.desiredPos,r=null!==(e=null===(e=c.bufferMonitorInfo)||void 0===e?void 0:e.highWaterLevelSeconds)&&void 0!==e?e:g.duration;if(s-a>=r&&n.push(Jl(c.timeupdate$,e=>{let t=e;var i=c.desiredPos;return 0===e&&i!==e&&(t=i),s-t<r})),2===c.expectedSbCount){const a=Ys.AltAudio-h;qg(s,d.getInFlightFragByType(a),c.getBufferedRangeByType(a))||n.push(Jl(ur([d.getInFlightFragByType$(a).pipe(xr(Gh)),c.getBufferedRangeByType$(a)]),([e,t])=>qg(s,e,t)))}}return n.length?Ln(n).pipe(tr(Cn),on(()=>Jg(0,s,f,h,t,i))):Jg(0,s,f,h,t,i)}))}function jg(r,e,n,a,s,o){const{mediaSink:l,rootPlaylistQuery:d,rootPlaylistService:u}=r;return e=>{let t=e.pipe(sr(e=>{var t;let i=NaN;for(const r of e){const e=null===(t=null==r?void 0:r[0])||void 0===t?void 0:t.discoSeqNum;!z(i)&&z(e)&&(i=e)}return function(v,e,i){const{rootPlaylistQuery:r,mediaSink:t,config:S,mediaLibraryService:I}=v,b=t.mediaQuery,n=b.isIframeRate,T=r.isInterstitial;if(i.every(e=>null==(null==e?void 0:e[0])&&null==(null==e?void 0:e[1])))return null;const E=[null,null],a=r.getInitPTS(e),A=[null,null];if(i.every(e=>null==(null==e?void 0:e[1])))return i.forEach((t,i)=>{if(t){var[t]=t;let e=NaN;t&&(e=I.getQueryForOption(t).playlistDuration),E[i]={initSeg:t,dataSeg:void 0,offsetTimestamp:void 0,duration:e}}}),{appendDataTuple:E,initPTSInfo:a,inFlightFrags:A};if(null==a)return null;var s=i[Ys.Variant],e=null==s?void 0:s[1];if(e&&e.iframe!==n)return null;if(s){const[o,v]=s;let e=a.offsetTimestamp;if(n){const o=v.startDtsTs,l=v.timelineOffset,r=Math.round(l*o.timescale);e={baseTime:o.baseTime-r,timescale:o.timescale}}let t=NaN;v&&(t=I.getQueryForOption(v).playlistDuration),E[Xs.Variant]={initSeg:o,dataSeg:v,offsetTimestamp:e,duration:t}}i=i[Ys.AltAudio];if(null!=i){const[o,v]=i;let e=NaN;v&&(e=I.getQueryForOption(v).playlistDuration);let t=a.offsetTimestamp;if(n){const o=b.getBufferInfo(b.desiredPos,0)[Xs.AltAudio].buffered.end,d=v.startPts,r=Q(o,d.timescale);t={baseTime:d.baseTime-r.baseTime,timescale:d.timescale}}E[Xs.AltAudio]={initSeg:o,dataSeg:v,offsetTimestamp:t,duration:e}}const O=t.isCompatibleWithSourceBuffers(E).compatible;return E.forEach((e,t)=>{var i=null==e?void 0:e.dataSeg;if(i){var{itemId:r,mediaOptionId:n,mediaSeqNum:a,discoSeqNum:s,startPts:o,endPts:l,duration:d,iframe:u,isLastFragment:c,part:h=!1,partIndex:p=NaN}=i,m=e["offsetTimestamp"],f=w(o,m),g=w(l,m),e=I.getQueryForOption(i);b.getBufferedRangeByType(t);var o=E[0],l=!o||!o.dataSeg.dropped,m=b.getBufferInfo(f,S.maxBufferHole,T?r:void 0);if(O&&l&&!i.flushBeforeAppend&&(null===(m=null===(m=m[t])||void 0===m?void 0:m.buffered)||void 0===m?void 0:m.len)>=g-f){let e;if(o){const v=f+(g-f)/2,y=b.getBufferedSegmentsByType(t).find(e=>e.startPTS<v&&e.endPTS>v);e=o.dataSeg.mediaOptionId===(null==y?void 0:y.frag.mediaOptionId)}if(!o||e)return E[t]=null,$g(v,t,null,null,!1,!1),null}A[t]={start:f,duration:u?d:g-f,itemId:r,mediaOptionId:n,mediaSeqNum:a,discoSeqNum:s,targetDuration:e.mediaOptionDetails.targetduration,isLastFragment:c,mediaOptionType:t,part:h,partIndex:p}}return null}),A.every(e=>!e)?null:{appendDataTuple:E,inFlightFrags:A,initPTSInfo:a}}(r,i,e)}),(m=r,i=a,f=o,e=>{const{rootPlaylistQuery:y,rootPlaylistService:v,mediaSink:S,legibleSystemAdapter:d,statsService:u,rtcService:c,interstitialController:h,itemQueue:I,playerEvents:p}=m;return e.pipe(on(e=>{if(!e)return Pr(!1);const{appendDataTuple:a,inFlightFrags:g,initPTSInfo:n}=e;g.forEach((e,t)=>{var i;e&&(i=S.isCompatibleWithSourceBuffers(a)["compatible"],$g(m,t,e,"appending",i,!0))}),a.forEach(e=>{var t=null==e?void 0:e.dataSeg;if(t&&n){const i=n.offsetTimestamp,r=null!==(e=null===(e=I.getQueueItemForId(t.itemId))||void 0===e?void 0:e.isInterstitial)&&void 0!==e&&e;d.addLegibleSamples(i,t.captionData,t.id3Samples,t.startPts,t.endPts,r)}});var r,s,o,l,e=(e,t,i,r,n)=>{var a,s,o,l,d,u,c,h,p,m,f=null!==(f=null===(f=g[t])||void 0===f?void 0:f.targetDuration)&&void 0!==f?f:10;return a=S,s=e,o=t,l=i,d=f,u=r,c=y,h=v,p=n,m=I,e=>e.pipe(cn(()=>{h.updateConsecutiveTimeouts(c.itemId,o,!1,"append")}),Jr(e=>e.pipe(on((e,t)=>{var i=e instanceof fp&&e.isTimeout;if(h.updateConsecutiveTimeouts(c.itemId,o,i,"append"),i)return function(e,t,i,r,n,a,s,o,l){let d={errorAction:lm.SendAlternateToPenaltyBox,errorActionFlags:0};var u=a.getCurrentWaterLevel(i.maxBufferHole),c=u<i.almostDryBufferSec;let h=NaN;a=i.appendErrorMaxRetry,i=s.getErrorInfoByType(r),i=i?i.timeouts.append:0;c&&a<=i||a<=t?d.errorAction=lm.SendEndCallback:h=1e3*u;a={retryDelayMs:h,maxNumRetry:a,maxRetryDelayMs:h};return d=Fm(d,!1,e.response.code,n,r,s,o),Km(e,t,a,d,s,o,l,r,n).pipe()}(e,t,u,o,l,p,c,h,m);if(e instanceof gp)return function(e,t,i,r,n,a,s,o,l,d,u){var c=t.type,c=o.getCurrentWaterLevelByType(c,n.maxBufferHole);if(c>=n.almostDryBufferSec&&!o.isIframeRate){const t=1e3*r,n={errorAction:lm.RetryRequest,errorActionFlags:0};return 1e3*c<t&&(d.hasFallbackMediaOptionTuple(l,a,s,!1)?n.errorAction=lm.SendAlternateToPenaltyBox:n.errorAction=lm.SendEndCallback),Km(e,i,{retryDelayMs:t,maxNumRetry:1/0,maxRetryDelayMs:t},n,l,d,u,a,s)}return i<n.appendErrorMaxRetry?t.remove(0,Number.POSITIVE_INFINITY):(e.fatal=!0,Lr(e))}(e,s,t,d,u,o,l,p,c,h,m);if(e instanceof vp){const{mediaOptionType:s,mediaOptionId:o}=e;return Hm(e,s,o,a,h,c,m)}throw e}))))};let t;if(null==i)t=S.avAppend(null,a,e,y.highestVideoCodec);else{const m=Do(i);t=S.avAppend(m,a,e,y.highestVideoCodec)}return t.pipe(kr(1),sr(e=>{let i={};const r=a[Xs.AltAudio],n=null==r?void 0:r.dataSeg;if(da(()=>{g.forEach((e,t)=>{e&&($g(m,t,e,"appended",null,!0,i),t!==Ys.Variant&&t!==Ys.AltAudio||(S.updateInFlightRange(t,null),h.fragmentAppended({isLastFragment:e.isLastFragment,type:e.mediaOptionType,itemId:e.itemId})))});let t=!1;if(e.forEach(e=>{e&&(null==c||c.handleBufferAppended({fragmentType:e.fragmentType,startAppend:e.startDataAppend,endAppend:e.endDataAppend,bytesAppend:e.dataBytesAppend}),e.fragmentType!==Ys.Variant||t||(t=!0,u.setBufferMetric(e),null==c||c.handleFragBuffered(e)))}),null!=n&&n.flushBeforeAppend||z(null==n?void 0:n.switchPosition)||null!=n&&n.triggerEvent){const{itemId:m,mediaOptionId:e}=r.dataSeg;v.setEnabledMediaOptionSwitchContextByType(m,Ys.AltAudio,e,void 0)}}),null!=n&&n.triggerEvent){const m=y.enabledAlternateMediaOptionByType(Ys.AltAudio);p.postAudioTrackSwitched(!0,f,m)}return p.triggerBufferAppended(),!0}),(r=S,s=v,o=y,l=I,e=>e.pipe(Wi(e=>{if(e instanceof mp){var{mediaOptionType:t,mediaOptionId:i}=e;return Hm(e,t,i,r,s,o,l)}throw e}))))}))}),Wi(e=>{if(e instanceof jo){var t=e.candidateMediaOptions;return t?(u.setEnabledMediaOptions(r.rootPlaylistQuery.itemId,t),Cr):Pr(!1)}if(e instanceof v&&!e.fatal)return Pr(!1);throw e}),cn(e=>{e||Lo.forEach(e=>{null!=a&&e!==a||$g(r,e,null,null,!1,!1)})}),Br(()=>{da(()=>{Lo.forEach(e=>{l.updateInFlightRange(e,null)})})}));var m,i,f;return a===Ys.Variant&&(t=t.pipe(on(e=>{if(!s)return Pr(e);const t=Gg(r,0,n);return t?Jl(ur([d.getInFlightFragByType$(Ys.AltAudio),l.mediaQuery.waterLevelChangedForType$(Xs.Variant)]),([e,t])=>t===Qu.AlmostDry||null==e||"appended"===e.state||"waiting"===e.state).pipe(sr(()=>(u.setEnabledMediaOptions(d.itemId,t),e))):Pr(e)}))),t.pipe(Br(()=>{null!=a&&a!==Ys.Variant||u.setFragLoadSlow(d.itemId,{fragDownloadSlow:!1,fragDownloadTooSlow:!1})}))}}function Gg(c,e,t){const{config:i,mediaSelectionBossService:r,mediaSink:n,platformService:a,rootPlaylistService:s,rootPlaylistQuery:o,statsService:l}=c,d=n.mediaQuery,u=l.getQueryForId(o.statsId);if(o.getEntity(o.itemId).manualMode||d.isIframeRate&&i.abrTrickplayLevelLocked)return null;var h,p=o.enabledVariantMediaOption;if(p.mediaOptionId!==t)return null;let m=to.None;f=a,h=null==d?void 0:d.clientWidth,y=null==d?void 0:d.clientHeight,t="object"==typeof window&&window.devicePixelRatio?window.devicePixelRatio:1,y=h&&y?{width:h*t,height:y*t}:void 0,t=(t=f.query.viewportInfo||{})&&y&&(t.width!==y.width||t.height!==y.height),i.useViewportSizeForLevelCap&&t&&(f.updateViewportInfo(y),!0)&&(m=to.PreferredListChanged);var f=o.itemId;let g=!1;!function(e,t,i){const r=e.abrStatus,n=e.enabledVariantMediaOption.bitrate,a=r.fragDownloadSlow||r.fragDownloadTooSlow||i.getBandwidthEstimate().avgBandwidth<n,s=z(null===(t=t.seekTo)||void 0===t?void 0:t.pos);return(!a||r.fragDownloadTooSlow||!s)&&a}(o,d,u)?function(e,t){const i=l.getQueryForId(t.statsId),r=i.getBandwidthEstimate(e),n=t.abrStatus;if(!Cf(r))return!1;var a=(null===(a=i.bandwidthStatus)||void 0===a?void 0:a.bandwidthSampleCount)||0,a=Ff(r.avgBandwidth,e.abrBandWidthUpFactor,e.abrBandWidthFactor,a)["bwUp"];return a>Dc(Object.assign(Object.assign({},t.enabledVariantMediaOption),{bitrate:n.highBWTrigger}),e.trickPlaybackConfig)}(i,o)&&function(){const{config:e,mediaSink:t,mediaLibraryService:i,rootPlaylistQuery:r}=c,n=t.mediaQuery,a=r.enabledVariantMediaOption,s=r.enabledAlternateMediaOptionByType(Ys.AltAudio),o=n.desiredPos,l=n.getMediaBufferInfo(o,e.maxBufferHole),d={variant:a,avDetails:[i.getQueryForOption(a).mediaOptionDetails,null!=s&&s.url?i.getQueryForOption(s).mediaOptionDetails:null]},u=Fc(e,d.avDetails[Ys.Variant],l);return n.gotPlaying||af(r.getInFlightFrags(),d,l,n.desiredRate,u,e.liveAllowLowLatencyPlayback)}()&&(m=to.HighBandwidth,null==r||r.setTransformer(f,io.BitrateFilter,new Lh(p.bitrate,Number.POSITIVE_INFINITY)),s.setNextMinAutoOptionId(p.itemId,p.mediaOptionId)):(m=to.LowBandwidth,o.nextMaxAutoOptionId===wo.mediaOptionId&&(s.setNextMaxAutoOptionId(p.itemId,p.mediaOptionId),g=!0,null==r||r.setTransformer(f,io.BitrateFilter,new Lh(0,p.bitrate))));var y=Gf(m,p,c);return g?s.setNextMaxAutoOptionId(p.itemId,wo.mediaOptionId):m===to.HighBandwidth&&s.setNextMinAutoOptionId(p.itemId,wo.mediaOptionId),null==r||r.removeTransformer(f,io.BitrateFilter),y}function zg(e,t){if(!e)return!1;if(!e.part||e.part&&!1===(null==t?void 0:t.hasPartIndependentTag))return!0;var i,r,n=C(e.partIndex,0),t=(t=null!==(t=t.parts)&&void 0!==t?t:[],i=e.mediaSeqNum,r=n,t.find(e=>e.mediaSeqNum===i&&e.partIndex===r+1||e.mediaSeqNum===i+1&&0===e.partIndex));return!t||t.partIndependent}const Wg=(w,R,e)=>e=>{const{discoSeqNum:t,anchorFrags:i,iframeMode:f,switchInfo:r}=R,o=i.map(e=>{var{mediaSeqNum:t=NaN,part:i=!1,partIndex:e=NaN}=e||{};return{msn:t,part:i,partIndex:e}}),g=i[0].mediaOptionId,{iframeClock:c,mediaSink:n,rootPlaylistQuery:h,mediaLibraryService:y}=w,{itemId:v,appItemId:S}=h,I=n.mediaQuery,b=I.desiredRate,a=b<0?-1:1,{maxBufferHole:T,maxFragLookUpTolerance:E,liveAllowLowLatencyPlayback:s}=w.config,m=s&&(1===b||0===b),l={firstDisco:!0,discoSeqNum:t,complete:!1,step:a,msnsInDisco:[{startMSN:o[0].msn,startPartIndex:o[0].partIndex,length:0,partlength:NaN},{startMSN:o[1].msn,startPartIndex:o[1].partIndex,length:0,partlength:NaN}],nextAnchor:{discoSeqNum:NaN,anchorFrags:[null,null],iframeMode:R.iframeMode,switchInfo:[]}},p=e.pipe(xr((r,e)=>null==e?void 0:e.every((e,t)=>{var i=r[t];return null==i&&null==e||null!=r[t]&&!(i.mediaOptionId!==e.mediaOptionId||Yf(i,e)||m&&Xf(i,e))})),Sr((s,c)=>{var h,e;const p=null!==(h=R.pos)&&void 0!==h?h:I.currentTime;if(l.firstDisco=0===c,0!==c)return Pr(s);{const R=[null,null];Lo.forEach(e=>{var t,i,r,n,a=s[e];a&&({msn:t,part:i,partIndex:r}=o[e],n=null,(n=z(r)?qc(a.parts,t,r):qc(a.fragments,t))&&(R[e]=n))});const c=n.needSourceBuffers&&R.every((e,t)=>{return null==e||(null===(t=s[t].initSegments[e.discoSeqNum])||void 0===t?void 0:t.isInitSegment)&&!y.isCachingFrag(e)})&&!(null!==(e=y.getPrefetchCache(S))&&void 0!==e&&e.fragRequest),h=c?[Rr(Xl,Xl),Rr(Xl,Xl)]:[Xl,Xl],m=I.getBufferInfo(p,T,A?v:void 0);let d=!1,u=!1;if(r){if(r[Ys.Variant]){const{fromId:w,toId:R}=r[Ys.Variant];d=w&&R&&w!==R}if(r[Ys.AltAudio]){const w=r[Ys.AltAudio]["switchContext"];u=null!=w&&!0===w.userInitiated}}R.forEach((i,r)=>{if(i){const a=m[r],s=null!==(n=null==a?void 0:a.bufferedSegments)&&void 0!==n?n:[];let e=!1,t=!1;if(r===Ys.AltAudio&&f&&0<(null==a?void 0:a.buffered.len)&&s.some(e=>e.frag.discoSeqNum===i.discoSeqNum))e=!0,t=!0;else if(!i.iframe){const w=i.start+i.duration,r=s.find(e=>{var t=e.startPTS<=p&&p<e.endPTS;if(e.evicting||!t)return!1;t=Math.max(w,C(e.appendEnd,w));return Math.abs(t-e.endPTS)<E});e=null!=r,t=null!=r&&Gh(r.frag,i)}if(!(r===Ys.AltAudio&&!u&&t||r===Ys.Variant&&(t||e&&d&&!i.isLastFragment&&!Ym(i,s)))){const o=m[r].buffered,l=[];let e;c&&(e=Fg(w,i.keyTagInfo,{itemId:i.itemId,mediaOptionId:i.mediaOptionId,appItemId:S}).pipe(on(()=>Cr)),l.push(y.retrieveInitSegmentCacheEntity(w,i,i.discoSeqNum).pipe(sr(e=>[null==(null==e?void 0:e.initParsedData)?null:e,null])))),l.push(null!==(n=Hg(w,0,i,b,o,!0))&&void 0!==n?n:Xl);var n=l.length?Rr(...l):l[0];h[r]=e?Vn(e,n):n}}});const l=h[Ys.Variant]!==Xl&&zg(R[Ys.Variant],s[Ys.Variant]);return function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var a=ji(e),s=yr(e);return s.length?new oi(function(i){var r=s.map(function(){return[]}),n=s.map(function(){return!1});i.add(function(){r=n=null});for(var e=0;!i.closed&&e<s.length;e++)!function(t){yi(s[t]).subscribe(Si(i,function(e){r[t].push(e),r.every(function(e){return e.length})&&(e=r.map(function(e){return e.shift()}),i.next(a?a.apply(void 0,Tt([],bt(e))):e),r.some(function(e,t){return!e.length&&n[t]})&&i.complete())},function(){n[t]=!0,r[t].length||i.complete()}))}(e);return function(){r=n=null}}):Cr}(h).pipe(jg(w,0,g,null,!1,null===(e=null==r?void 0:r[Ys.AltAudio])||void 0===e?void 0:e.switchContext)).pipe(Ur(1),on(()=>{if(!l)return Pr(s);const{rootPlaylistQuery:e,rootPlaylistService:t}=w,i=Gg(w,0,g);return i?(t.setEnabledMediaOptions(e.itemId,i),Cr):Pr(s)}))}}),en((h,p)=>(Lo.forEach(i=>{var e,t,r=p[i];if(r){const{step:a,discoSeqNum:s,msnsInDisco:o,nextAnchor:l}=h,d=o[i],u=r.discoToMSNMap[s];if(u){let e=u[0];0<a&&(e=Math.min(u[1],r.endSN)),d.length=Math.abs(e-d.startMSN)+1,d.partlength=NaN,m&&u[1]>r.endSN&&(u[1]===r.partEndSN?(d.length=u[1]-d.startMSN,d.partlength=r.partEndIndex+1):(d.partlength=NaN,d.length=u[1]-d.startMSN+1))}const c=l.anchorFrags;if(!c[i]){var n;const o=0<(null===(e=r.parts)||void 0===e?void 0:e.length);n=m&&o?null===(t=qc(r.parts,r.partEndSN,r.partEndIndex))||void 0===t?void 0:t.discoSeqNum:null===(t=qc(r.fragments,0<a?r.endSN:r.startSN))||void 0===t?void 0:t.discoSeqNum;for(let t=s+a;null!=n&&(0<a?t<=n:t>=n);t+=a){const p=r.discoToMSNMap[t];if(p&&(!z(h.nextAnchor.discoSeqNum)||t===h.nextAnchor.discoSeqNum)){const h=p[0<a?0:1];let e=qc(r.fragments,h);e=e||qc(r.parts,h,0),c[i]=Xm(e),l.discoSeqNum=t;break}}}}}),(Dm(p)||z(h.nextAnchor.discoSeqNum)&&h.nextAnchor.anchorFrags.every((e,t)=>null==p[t]||null!=e))&&(h.complete=!0),h),l),un(({complete:e})=>!e,!0),nn({bufferSize:1,refCount:!0})),A=h.isInterstitial,O=[];if(Lo.forEach(l=>{var e=i[l];if(null!=e){const d=y.getQueryForOption(i[l]),u={frag:1,part:NaN};e.part&&(u.frag=0,u.part=e.partIndex);e=p.pipe(cn(({firstDisco:e})=>{var t=I.getBufferedSegmentsByType(Do(l))[0];null!=t&&t.partialFrag&&e&&(u.frag=0)}),Nr(({msnsInDisco:e,nextAnchor:t,discoSeqNum:s,step:o,complete:i})=>nr(Pr(e[l]),Cn).pipe(Fr(e=>{var t=d.mediaOptionDetails;if(!t||t.mediaOptionId!==h.enabledMediaOptionIdByType(l))return Cr;if(u.frag>e.length||m&&u.frag===e.length&&!z(e.partlength)||m&&z(e.partlength)&&u.frag===e.length&&u.part>e.partlength)return Cr;var i=I.currentTime,r=c.isStarted?c.getCurrentTime().seconds:i,{buffered:n,bufferedSegments:a}=I.getBufferInfo(i,T,A?v:void 0)[l],i=c.isStarted?[]:I.getContentGapRanges(),i=Jm(t,e.startMSN+u.frag*o,r,b,n,a,i,E,!1,u.part,m);if(!i||i.discoSeqNum!==s)return u.frag=e.length,u.part=e.partlength,Cr;null!=i&&i.part?(u.frag=Math.abs(i.mediaSeqNum-e.startMSN),u.part=i.partIndex):(u.frag=Math.abs(i.mediaSeqNum-e.startMSN)+1,u.part=NaN);t=zg(i,t);return(null!==(n=Hg(w,0,i,b,n,!1))&&void 0!==n?n:Xl).pipe(sr(e=>l===Ys.Variant?[e,null]:[null,e]),jg(w,0,g,l,t),Mr(e))},1),sr(()=>({nextAnchor:t,type:l,complete:i})))),Ur(1));O.push(e)}}),0<O.length){let e;return e=1===O.length?O[0]:Vn(...O).pipe(un(({type:e,complete:t})=>!f||e!==Ys.Variant||!t,!0)),e.pipe(Ur(1),sr(({nextAnchor:e})=>e),Br(()=>{da(()=>{Lo.forEach(e=>{$g(w,e,null,null,null,!1)})})}))}return Cr};function Yg(s,o,e,t){const l=s["rootPlaylistQuery"],i=t.enabledMediaOptionSwitchInfo$.pipe(_d()),d=s.statsService.getQueryForId(l.statsId);return s.logger.child(Qg),ur([s.mediaSink.mediaQuery.isIframeRate$,i.pipe(on((e,t)=>{var i=l.altMediaOptionHasValidUrl(Ys.AltAudio,null===(i=e[Ys.AltAudio])||void 0===i?void 0:i.toId)?2:1;s.mediaSink.setExpectedSbCount(i);const r=[];e.forEach(({fromId:e,toId:t},i)=>{t=function(t,i,r,n,a){var e,s,o,l;const{rootPlaylistQuery:d,rootPlaylistService:u,mediaSink:c,mediaParser:h,config:p,iframeClock:m,mediaLibraryService:f,hlsService:g}=t,y=c.mediaQuery;if(!n||!a||n===a&&(r===Ys.AltAudio||!m.isStarted))return null;switch(r){case Ys.Variant:{n!==a&&h.reset(Ys.Variant);const t=Do(r),v=d.variantMediaOptionById(n),u=d.variantMediaOptionById(a);if(null==u||null==v)return Yl;if(v.iframes!==u.iframes||u.iframes)return c.mediaQuery.flushing?Jl(c.mediaQuery.flushing$,e=>!e).pipe(sr(()=>{})):Yl;if(!p.allowFastSwitchUp||u.iframes)return Yl;const S=f.getQueryForOption(v).mediaOptionDetails;if(null!=S&&null!=u&&v.bitrate<u.bitrate){S.targetduration;const r=f.getQueryForOption(u),n=r.mediaOptionDetails,a=(null===(o=r.mediaOptionDetailsEntity)||void 0===o?void 0:o.lastUpdateMillis)||0,h=y.getCurrentWaterLevelByType(t,p.maxBufferHole),m=function(e,t,i,r,n,a,s,o){var n=n.nextMaxAutoOptionId,l=a.getCombinedEstimate(e,void 0,!1);if(n!==wo.mediaOptionId&&!Cf(l))return Number.POSITIVE_INFINITY;if(t.mediaOptionId===i.mediaOptionId)return Number.POSITIVE_INFINITY;n=Ff(l.avgBandwidth,e.abrBandWidthUpFactor,e.abrBandWidthFactor,a.bandwidthStatus.bandwidthSampleCount),a=function(){let e=0;var{avgPlaylistLoadTimeMs:t,avgLatencyMs:i}=l;return z(t)?e=t:z(i)&&(e=i),e}(),n=i.bitrate>t.bitrate?n.bwUp:n.bwDown;if(null!=r&&r.liveOrEvent&&(!r.ptsKnown||Uc(r.totalduration,a,o)))return Number.POSITIVE_INFINITY;a=s.seekTo,a=z(null==a?void 0:a.pos)?a.pos:s.currentTime,a=s.getMediaBufferInfo(a,e.maxBufferHole);return Nc(e,i,r,jc(e.liveAllowLowLatencyPlayback,s.isPlayingAtLive,null!==(r=null===(r=null==r?void 0:r.parts)||void 0===r?void 0:r.length)&&void 0!==r?r:0),Object.assign(Object.assign({},l),{avgBandwidth:n}),a,o,!0).totalTime}(p,v,u,n,d.abrStatus,i,y,a)+p.maxStarvationDelay,g=Math.max(d.itemStartOffsets[t]||0,y.currentTime)+m,I=null===(l=null===(s=y.sourceBufferEntityByType(t))||void 0===s?void 0:s.bufferedSegments)||void 0===l?void 0:l.find(e=>e.startPTS>=g);let e;if(I){const t=I.endPTS-I.startPTS;e=I.startPTS+Math.min(Math.max(t-p.maxFragLookUpTolerance,.5*t),.75*t)}if(z(e)&&h>=m)return c.flushData(t,e,1/0)}}break;case Ys.AltAudio:e=d,o=a,l=Co("Nah"===(s=n)?null:e.alternateMediaOptionById(Ys.AltAudio,s)),o=Co("Nah"===s?null:e.alternateMediaOptionById(Ys.AltAudio,o)),!l||o?a&&"Nah"!==a||u.clearMediaOptionSwitchContextByType(d.itemId,Ys.AltAudio):(u.setEnabledMediaOptionSwitchContextByType(d.itemId,Ys.AltAudio,a,void 0),m.isStarted||c.resetMediaSource(y.currentTime)),h.reset(Ys.AltAudio)}return Yl}(s,(o.operation,d),i,e,t);t&&r.push(t)});const n=[];0<t&&n.push(Pr({switching:!0,switchInfo:e}));const a={switching:!1,switchInfo:e};return 0<r.length?n.push(Ln(r).pipe(sr(()=>a))):n.push(Pr(a)),1<n.length?Rr(...n):n[0]}))]).pipe(on(([e,{switching:t,switchInfo:i}])=>{return t||e!==(null===(e=l.variantMediaOptionById(i[0].toId))||void 0===e?void 0:e.iframes)?Cr:function(n,e){const a=n.logger.child(Qg),{rootPlaylistService:s,rootPlaylistQuery:o,config:t}=n,l=o.itemId,i=t.liveAllowLowLatencyPlayback,r=xr((e,t)=>!(e.mediaOptionId!==t.mediaOptionId||Yf(e,t)||i&&Xf(e,t))),d=_r(e=>!e||!e.liveOrEvent||!function(e,t){return performance.now()-e.tloadMillis>1e3*mf(e,t)}(e,t)),u=Pr(o.variantMediaOptionById(e[Ys.Variant].toId)).pipe(Ug(n.mediaLibraryService),r,d),c=o.alternateMediaOptionById(Ys.AltAudio,e[Ys.AltAudio].toId),h=ur([u,Co(c)?Pr(c).pipe(Ug(n.mediaLibraryService),r,d):Xl]),p=h.pipe(Kg(n,e)),m=o.avAnchor$.pipe(an(1),on(function(e,t){if(!e||!z(e.discoSeqNum))return Cr;const{anchorFrags:i,switchInfo:r}=e;return i.some((e,t)=>{t=r[t];return t&&e&&e.mediaOptionId!==t.toId})?Cr:h.pipe(Wg(n,e,a),cn(e=>{var t;(null===(t=null==e?void 0:e.anchorFrags[Ys.Variant])||void 0===t?void 0:t.mediaOptionId)===(null===(t=o.enabledVariantMediaOption)||void 0===t?void 0:t.mediaOptionId)&&s.setAVAnchor(l,e)}))}));return Vn(m,p).pipe(Br(()=>{}))}(s,i)}),Br(()=>{}))}function Xg(e,t,i,r,n,a,s){const o=e["rootPlaylistQuery"],l=o.itemId,d=t.mediaOptionType;e.rootPlaylistService.updateInflightFrag(l,d,t,"loading",a,null);t=o.getInFlightFrags();return d!==Ys.Variant&&"loading"===(null===(a=t[Ys.Variant])||void 0===a?void 0:a.state)||uf(e.config,e.logger,e.rootPlaylistQuery,e.mediaSink,e.mediaLibraryService,e.statsService.getQueryForId(o.statsId),t),d===Ys.Variant&&function(e,t,i){var r;const{config:n,mediaSink:a,rootPlaylistQuery:s,rootPlaylistService:o}=e,l=a.mediaQuery,d=e.logger.child(Rf),u={fragDownloadSlow:null!==(r=null===(r=s.abrStatus)||void 0===r?void 0:r.fragDownloadSlow)&&void 0!==r&&r,fragDownloadTooSlow:null!==(r=null===(r=s.abrStatus)||void 0===r?void 0:r.fragDownloadTooSlow)&&void 0!==r&&r},[c]=t;if(Uf(c)&&(!l.isIframeRate||!n.abrTrickplayLevelLocked))try{Vf(u,function(e,t,i,r,n,a){if(!Uf(e))return n;const s=Hf(e,n,t,r),o=i.bufferMonitorInfo;if(o&&a>Qu.LowWater){const e=i.waterLevelForType(Xs.Variant),t=o["lowWaterLevelSeconds"],r=i.waitingForDisco,n=i.minSBDuration-i.currentTime<=t;e<=Qu.LowWater&&!r&&!n&&(s.fragDownloadSlow=!0)}return s}(c,s,l,d,u,i)),Vf(u,function(e,F,t){const i=F.mediaSink.mediaQuery,{rootPlaylistQuery:r,config:n,logger:a,mediaSelectionBossService:s}=F,o=i.desiredRate,l=e[Ys.Variant];if(0===o||!Uf(l))return t;var{tfirst:d,trequest:u}=l.bwSample,c=z(d),c=performance.now()-(c?d:u),d=nf(l.duration,i.playbackRate,n),u=1e3*Bc(l.duration,n.maxStarvationDelay);if(c<Math.min(u,d))return t;const h=r.enabledVariantMediaOption,p=r.mediaOptionListQueries[Ys.Variant].filteredMediaOptionList.filter(e=>Af(i.isIframeRate,e)&&ho(h,e));if(0===p.length||p[0].mediaOptionId===l.mediaOptionId)return t;if(n.enableBoss&&s){const e=s.getQuery(r.itemId,a),F=i.isIframeRate?e.variantFor(ro.ABRIframeLowestLevel):e.variantFor(ro.ABRLowestLevel);if((null==F?void 0:F.mediaOptionId)===l.mediaOptionId)return t}return function(t,i,r){let{fragDownloadSlow:e,fragDownloadTooSlow:n}=t;const{config:a,rootPlaylistService:s,rootPlaylistQuery:o,mediaSink:l,statsService:d,mediaLibraryService:u,mediaSelectionBossService:c,hlsService:h}=F,p=F.logger.child(Rf),m=l.mediaQuery,[f]=i,g=f.bwSample;if(!z(g.tfirst))return t;var y=performance.now(),v=y-g.tfirst,S=Bc(f.duration,a.maxStarvationDelay);if(m.paused&&v/1e3<S)return t;const I=Ys.Variant,b=f.mediaOptionId,T=o.variantMediaOptionById(b),E=u.getQueryForOption(T),A=f.itemId,O=d.getQueryForId(o.statsId),w=O.getCombinedEstimate(a,void 0,!1),R=Math.max(1,8e3*g.loaded/v),C=[],k=null!=(null===(P=o.enabledAlternateMediaOptionByType(Ys.AltAudio))||void 0===P?void 0:P.url);for(const _ of i)if(_){const N=u.getQueryForOption(_).mediaOptionDetails;N&&C.push(sf(T,N,_,k))}var M=of(i,C,Xs.Variant,0,w,w,w,!0),P=Mf(m,a.maxBufferHole);let L;if(z(P)&&0<P&&!z(null===(D=m.seekTo)||void 0===D?void 0:D.pos))L=P;else{const _=v/1e3;L=_<S?S-_:S}({fragDownloadSlow:e,fragDownloadTooSlow:n}=Hf(f,t,o,p));i=E.mediaOptionDetails,S=jc(a.liveAllowLowLatencyPlayback,m.isPlayingAtLive,null!==(v=null===(D=null==i?void 0:i.parts)||void 0===D?void 0:D.length)&&void 0!==v?v:0),t=2*(Hc(i,a,!1)||f.duration);if(!(S&&w.avgLatencyMs/1e3+T.bitrate/R<f.duration||P<=t&&(M>=L||e)))return h.query.extendMaxTTFB&&h.setExtendMaxTTFB(0),{fragDownloadSlow:e,fragDownloadTooSlow:n};let x;e=!0,h.query.extendMaxTTFB||h.setExtendMaxTTFB(6e5);var D=Object.assign(Object.assign({},w),{avgBandwidth:R}),v=O.bandwidthStatus,i=T.iframes,S=M>=L&&!i,P=Pf(0,r,i,o);if(P<0)return{fragDownloadSlow:e,fragDownloadTooSlow:n};t=Math.max(P,r.findIndex(e=>e&&e.mediaOptionId===T.mediaOptionId)-1);if(S){let e=Nf(r,f.duration,P,t,L,i,D,v,1,1,a,o,E,m,c,p);const N=wo.mediaOptionId;if(e.variantMediaOption!==N)x=e.variantMediaOption;else if((e=Nf(r,f.duration,P,t,M,i,D,v,1,1,a,o,E,m,c,p)).variantMediaOption!==N)x=e.variantMediaOption;else if(a.enableBoss&&c){const _=c.getQuery(o.itemId,p);x=(i?_.variantFor(ro.ABRIframeLowestLevel):_.variantFor(ro.ABRLowestLevel)).mediaOptionId}else x=e.lowestCandidate}else{const _=Pf(0,r.slice(P,t+1).reverse(),i,o);(0<=_||t===P)&&(x=r[t-_].mediaOptionId)}if(null!=x&&x!==o.abrStatus.nextMaxAutoOptionId){s.setNextMaxAutoOptionId(A,x);const _=o.variantMediaOptionById(x);null==c||c.setTransformer(A,io.BitrateFilter,new Lh(0,_.bitrate))}if(S){d.setBandwidthSample(Object.assign(Object.assign({},g),{tfirst:g.tfirst||y,tload:g.tload||y,complete:!0,mediaOptionType:I})),n=!0;const _=s.getEnabledAlternatesForVariant(o,x);if(o.isValidMediaOptionTuple(_))throw new jo({mediaOptionType:I,mediaOptionId:b},_,G.FragmentAbortError)}return{fragDownloadSlow:e,fragDownloadTooSlow:n}}(t,e,p)}(t,e,u))}catch(e){if(e instanceof jo){const e={fragDownloadSlow:!0,fragDownloadTooSlow:!0};o.setFragLoadSlow(s.itemId,e)}throw e}o.setFragLoadSlow(s.itemId,u)}(e,t,i),!1}function Jg(t,a,i,r,s,o){const{mediaSink:l,rootPlaylistQuery:d,config:n,mediaLibraryService:u}=a;if(i&&null!=i.foundFrag){const t=l.mediaQuery,c=i.foundFrag["mediaFragment"],h=Fg(a,c.keyTagInfo,{itemId:c.itemId,mediaOptionId:c.mediaOptionId,appItemId:d.appItemId}),p={getData:!1,cb:Xg.bind(null,a,Xm(c),r===Ys.Variant?t.waterLevelForType(Xs.Variant):void 0),samplePeriodMs:n.abrSamplePeriodMs};let e=u.retrieveMediaFragmentCacheEntity(a,r,i,p).pipe(cn(e=>{const t=a.statsService.getQueryForId(d.statsId),i=t.initFragSample,r=t.fragSample,n=e[1];null===(e=a.rtcService)||void 0===e||e.handleFragParsed({largestVideoSampleSize:n.largestVideoSampleSize,initFragSample:i,fragSample:r});var e=l["mediaQuery"];s&&(n.switchPosition=e.currentTime,n.flushBeforeAppend={start:0,end:Number.POSITIVE_INFINITY}),n.triggerEvent=o}));const m=l.mediaQuery.isIframeRate,f=i.foundFrag.mediaFragment.discoSeqNum;return r===Ys.Variant?e=e.pipe(cn(e=>{var t=function(e,t,i){if(!t)return null;const{rootPlaylistService:r,rootPlaylistQuery:n}=e,a=n.itemId,s=t[1],o=s.iframe;let l=n.getInitPTS(i);if(null==l||!o&&l.iframeMode){const d=null!==(t=s.startDtsTs)&&void 0!==t?t:null;if(null==d)return null;let e=null!==(t=s.timelineOffset)&&void 0!==t?t:0;o&&(e=null!==(t=s.iframeOriginalStart)&&void 0!==t?t:0),d.timescale<1e3&&(d.timescale=1e3*d.timescale,d.baseTime=1e3*d.baseTime);const u=Q(e,d.timescale),n={baseTime:d.baseTime-u.baseTime,timescale:d.timescale};r.setInitPTS(a,i,d,e,n,o),l={variantDTS:d,timelineOffset:e,offsetTimestamp:n,iframeMode:o}}return l}(a,e,f);m||Zg(0,a,e,t)})):m||(e=Ln([e,Jl(d.initPTS$(f),e=>null!=e&&(m||!e.iframeMode))]).pipe(sr(([e,t])=>(Zg(0,a,e,t),e)))),Ln([h,e]).pipe(sr(e=>e[1]))}return Xl}function Zg(e,t,i,r){const{mediaLibraryService:n,rootPlaylistQuery:a,mediaSink:s,config:o}=t,l=a.itemId;null!=r&&(!s.mediaQuery.isIframeRate&&r.iframeMode||i&&!z(i[1].iframeMediaDuration)&&(performance.now(),n.updatePTSDTS(l,i[1].mediaOptionId,r,i[1],o.liveAllowLowLatencyPlayback)))}function ey(e,t,i,r){return e.rootPlaylistQuery.hasClosedCaption||e.rootPlaylistQuery.hasAlternateWithUrl(Ys.Subtitle)?Vn(Yg(e,t,0,r),Jl((n=e)["mediaSink"].mediaQuery.mediaElementEntity$,e=>e).pipe(on(e=>(e=>{const{config:t,logger:i,rootPlaylistQuery:a,rootPlaylistService:s,legibleSystemAdapter:o,itemQueue:r,playerEvents:l}=e,n=a.avAnchor$.pipe(_r(e=>z(null==e?void 0:e.pos)),sr(({pos:e,discoSeqNum:t})=>({pos:e,discoSeqNum:t}))),d=r.getQueueItemForId(a.itemId),u=a.enabledAlternateMediaOptionByType(Ys.Subtitle);if(d.isInterstitial){const e=a.mediaOptionListQueries[Ys.Subtitle].filteredMediaOptionList;if(0===e.length)return Cr;o.setInterstitialTracks(e,u,a.getDisabledMediaOption(Ys.Subtitle))}else if(o.endLoadingInterstitials(),o.gotTracks)u?o.selectedTrack=u:s.clearMediaOptionSwitchContextByType(d.itemId,Ys.Subtitle);else{const e=a.mediaOptionListQueries[Ys.Subtitle].filteredMediaOptionList;o.setTracks(e,u,a.getDisabledMediaOption(Ys.Subtitle)),l.postSubtitleTracksCreated(e,r.activeItem.isInterstitial)}const c=Vn(o.nativeSubtitleTrackChange$.pipe(on(e=>t.enableInterstitialPlayback?(i.error("native video controller subtitle selection is incompatible with interstitials playback"),Cr):(e.mediaOptionId!==o.selectedMediaOption.mediaOptionId&&s.setEnabledMediaOptionByType(e.itemId,Ys.Subtitle,e,!0,{userInitiated:!0}),Cr))),a.enabledMediaOptionByType$(Ys.Subtitle).pipe(sr(e=>{var t;const i=null===(t=a.enabledMediaOptionSwitchContexts)||void 0===t?void 0:t[Ys.Subtitle],r=Ro(e)?a.alternateMediaOptionById(Ys.Subtitle,e.mediaOptionId):e;o.selectedMediaOption=r;const n=!i;return l.postSubtitleTrackSwitch(n,i,r),s.clearMediaOptionSwitchContextByType(d.itemId,Ys.Subtitle),r}))).pipe(xr((e,t)=>(null==e?void 0:e.mediaOptionId)===(null==t?void 0:t.mediaOptionId)));return ur([n,c]).pipe()})(n).pipe((s=>e=>{const{mediaSink:t,rootPlaylistQuery:r,logger:i,mediaLibraryService:n}=s,a=t.mediaQuery;return ur([e,a.isIframeRate$.pipe(sn(!1),Vr(),sr(e=>e[0]&&!e[1]))]).pipe(on(([e])=>{const[,t]=e;return Co(t)&&Ro(t)?n.getQueryForOption(t).mediaOptionDetails$.pipe(on(i=>r.avAnchor$.pipe(_d(),_r(({iframeMode:e})=>!e&&!a.isIframeRate),Sr(({discoSeqNum:t})=>z(t)||z(t=jm(i,a.currentTime))?Jl(r.initPTS$(t),e=>e&&!e.iframeMode).pipe(on(e=>ty(s,i,t,e)),Br(()=>{})):Cr),Br(()=>{})))):Pr([null,null,null])}))})(n))),Br(()=>{}))):Yg(e,t,0,r);var n}const ty=(i,r,n,a)=>{const{legibleSystemAdapter:s,mediaSink:o}=i;return Pn(()=>{const e=o.mediaQuery,t=e.seekTo?e.seekTo.pos:e.currentTime;return s.findFrags$(r,n,t).pipe(on(e=>r&&null!=e&&e.foundFrags?((r,t,n,a,s)=>{const o=r["legibleSystemAdapter"],l=a.foundFrags;return Pn(()=>{let i=l.length;return ar(l).pipe(sr(t=>{if(t.gap){const n=r["mediaSink"];var e;return e.frag=t,e.cueRange=void 0,n.updateContentGapRanges(Xs.Variant,{start:t.start,end:t.start+t.duration}),Pr(e)}return((e,t,i)=>{const{rootPlaylistQuery:l,legibleSystemAdapter:d}=e;return Pn(()=>((e,t,i)=>{const r=e["mediaLibraryService"],n={trequest:NaN,tfirst:NaN,tload:NaN,tparse:NaN,tparsed:NaN,loaded:0},a=xg(e,i,!1).pipe(sr(e=>(Rg(n,e.bwSample),{initPTS:t,data:e,mediaFragment:i})));return r.retrieveInitSegmentCacheEntity(e,i,i.discoSeqNum).pipe(on(e=>Ln([Pr(e),a])))})(e,t,i).pipe(on(([e,{initPTS:t,data:i,mediaFragment:r}])=>{var n,a,s=l.enabledAlternateMediaOptionByType(Ys.Subtitle);let o=!0;return null!==(a=null==e?void 0:e.initParsedData)&&void 0!==a&&a.ttml&&(o=!1),[n,e,a,s,t,i=!0]=[s,r,t,i.loadedData,d,o],(n?t.processSubtitleFrag(n,e,a,s,i):Pr(void 0)).pipe(sr(e=>({frag:r,cueRange:e})))})))})(r,n,t).pipe(function t(i,r){return r?function(e){return Rr(r.pipe(kr(1),mt(function(e,t){e.subscribe(Si(t,$t))})),e.pipe(t(i)))}:pr(function(e,t){return i(e,t).pipe(kr(1),Mr(e))})}(e=>o.checkReadyToLoadNextSubtitleFragment$(t,l).pipe(_r(e=>e))),cn(()=>{i--}))}),vr(r.config.vttConcurrentLoadCount),on(e=>o.reviewParsedFrag(t,e,a,s,i)!==Iu.CloseEnough?(o.tryAgain$.next(bu.TryAgain),Cr):Yl),Br(()=>{0===i&&o.tryAgain$.next(bu.Complete)}))})})(i,t,a.offsetTimestamp,e,r):Yl),Br(()=>{}))})};function iy(t,e,i,r,n,a){return e.pipe(on(e=>i.getEntity(i.itemId)?e.length<1?Cr:e.some(e=>e.priority>t.priority||e.priority===t.priority&&t.priority!==sm.Low)?Yl:n.combinedBuffer$.pipe(on(()=>{var e=i.enabledVariantMediaOption,t=r.getQueryForOption(e).mediaOptionDetails,e=function(e,t){t=e.getCombinedBufferInfo(e.currentTime,t);return t?t.len/kf(e):0}(n,a.maxBufferHole);return t&&e>=Math.min(a.minSteeringRunway*t.targetduration,a.maxBufferLength/2)?Yl:Cr})):Yl))}function ry(e,t,i,r){for(var{mediaOptionId:n}of e.mediaOptionKeys)for(const e of i.mediaOptionListQueries)null!=e.mediaOptionFromId(n)&&r.updateConsecutiveTimeouts(i.itemId,e.mediaOptionType,t,"key")}function ny(i,t,e,r,n,a){const s=r.query.getActiveId(),o=i.keyuri,l=n.getKeyInfo(o);if(!l||!l.mediaOptionKeys.some(({itemId:e})=>e===s))return Cr;const d=r.getQueryForId(s),u=r.logger,c=d.enabledMediaOptionKeys,h=[];for(const t of i.mediaOptionIds){const i=c.some(e=>e.mediaOptionId===t),e=d.mediaOptionListQueries.find(e=>null!=e.mediaOptionFromId(t));if(e){const r=e.mediaOptionType,n={mediaOptionId:t,mediaOptionType:r};i?h.push(n):h.unshift(n)}}let p,m=!1;if(da(()=>{const e=i instanceof Pl;ry(n.getKeyInfo(o),e,d,r);for(const{mediaOptionId:e,mediaOptionType:t}of h)p=function(e,t,i,r,n){let a={errorAction:lm.SendAlternateToPenaltyBox,errorActionFlags:0};if(e instanceof Pl)a.errorAction=lm.SendAlternateToPenaltyBox;else{const t=e.isOkToRetry;e.keyErrorReason===yl.OutputRestricted?(a.errorAction=lm.RemoveAlternatePermanently,a.errorActionFlags|=dm.MoveAllAlternatesMatchingHDCP):t?a=Bm(e.response.code):a.errorAction=lm.RemoveAlternatePermanently}a.errorActionFlags&=~dm.MoveAllAlternatesMatchingHost;var s=r.enabledMediaOptionIdByType(i);return t===s?Fm(a,!1,e.response.code,s,i,r,n,e.isTimeout):a}(i,e,t,d,r),u.error(`[Keys] handleNetworkError uri=${f(i.keyuri)} mediaOptionId=${e} mediaOptionType=${t} action=${JSON.stringify(p)}`),p.errorAction===lm.RetryRequest&&(m=!0),Vm(p,i,d,r,a,t,e)}),m)return Qm(i,t,e,r.logger,d.isInterstitial,r.rtcService);throw $m(0,i),i}class ay{constructor(e,t,i,r,n,a){this.hls=e,this.logger=t,this.rtc=i,this.customUrlLoader=r,this.rootPlaylistService=n,this.mediaLibraryService=a,this.destroy$=new Er,this._rootQuery$=new qr(null),this._mediaElementQuery$=new qr(null),this._interstitialQuery$=new qr(null),this._rateChangeStart=NaN,this.triggerAsyncEvent$=new Er,this.logger=t.child({name:"hls-player-events"}),this._subscribeAndEmit()}destroy(){this.destroy$.next(),this.hls=null,this.rtc=null,this.setRootPlaylistQuery(null),this.setMediaElementQuery(null),this.setInterstitialQuery(null)}setRootPlaylistQuery(e){this._rootQuery$.next(e)}setMediaElementQuery(e){this._mediaElementQuery$.next(e)}setInterstitialQuery(e){this._interstitialQuery$.next(e)}_subscribeAndEmit(){const e=[this.customUrlLoader.gotRequest$.pipe(cn(this._customUrlRequestHandler.bind(this))),this.activeItemListener(this.hls.itemQueue),this.asyncEventTriggerListener(),this._rootQuery$.pipe(on(this._rootPlaylistQueryListener.bind(this))),this._mediaElementQuery$.pipe(on(this._mediaElementQueryListener.bind(this)))];this.hls.config.enableInterstitialPlayback&&e.push(this._interstitialQuery$.pipe(on(e=>this._interstitialQueryListener(e,this.hls.itemQueue)))),Vn(...e).pipe(Wi(e=>{var t=e.message;return this.logger.error(`Got error in HlsPlayerEvents ${t}`,e),Cr}),dn(this.destroy$),Br(()=>{})).subscribe()}activeItemListener(e){return e.activeItemById$.pipe(_d(),cn(e=>{e=e.url;this.hls.trigger(j.MANIFEST_LOADING,{url:e})}))}postSubtitleTracksCreated(e,t){this.triggerAsyncHlsEvent({eventName:j.SUBTITLE_TRACKS_UPDATED,payload:{subtitleTracks:e,fromInterstitial:t}}),this.triggerAsyncHlsEvent({eventName:j.SUBTITLE_TRACKS_CREATED})}_customUrlRequestHandler(e){this.hls.trigger(j.UNRESOLVED_URI_LOADING,e)}_rootPlaylistQueryListener(e){if(!e)return Cr;const t=e.enabledMediaOptionByType$(Ys.Variant).pipe(on(function(e){var t;return e?(null===(t=this.rtc)||void 0===t||t.handleLevelSwitching(e.url),this.hls.trigger(j.LEVEL_SWITCHING,e),nr(this.mediaLibraryService.getQueryForOption(e).mediaOptionDetailsEntity$,Cn).pipe(_r(e=>null!=e&&(e.detailsLoading||performance.now()-e.lastUpdateMillis<1e3)),xr((e,t)=>e.detailsLoading===t.detailsLoading),cn(this._handleLevelLoad.bind(this,e)))):Cr}.bind(this))),i=[];e.sessionData&&i.push(Jl(e.sessionData$,e=>null!=e.complete).pipe(cn(e=>{this.hls.trigger(j.SESSION_DATA_COMPLETE,e)})));const r=e["mediaOptionListQueries"],[n,a]=r;return i.push(n.getFilteredMediaOptionList$(!0).pipe(cn(e=>{const t=e;null===(e=this.rtc)||void 0===e||e.handleLevelsChanged(t),t.forEach(e=>{}),this.hls.trigger(j.LEVELS_CHANGED,{requiresReset:!1,levels:t})}))),i.push(a.getFilteredMediaOptionList$(!1).pipe(cn(e=>{var t=this.hls.itemQueue.activeItem.isInterstitial;this.hls.trigger(j.AUDIO_TRACKS_UPDATED,{audioTracks:e,fromInterstitial:t})}))),Vn(t,nr(Vn(...i),Li))}_mediaElementQueryListener(s){if(!s)return Cr;var e=s.desiredRate$.pipe(sn(0),Vr(),cn(([e,t])=>this.desiredRateChanged(e,t))),t=s.seekTo$.pipe(cn(e=>{var t;e&&z(e.pos)?(null===(t=this.rtc)||void 0===t||t.handleSeek("SEEKING",e,s.combinedBuffer),this.hls.trigger(j.SEEKING,{seekToPos:e.pos})):(null===(t=this.rtc)||void 0===t||t.handleSeek("SEEKED",e),this.hls.trigger(j.SEEKED))})),i=s.playbackLikelyToKeepUp$.pipe(cn(e=>this.hls.trigger(j.PLAYER_STATE_CHANGE,{playbackLikelyToKeepUp:e}))),r=s.gotFirstAppend$(Li).pipe(on(()=>{const e=[];return e.push(s.stallInfo$.pipe(tr(Li),_d(),cn(e=>{var t;null===(t=this.rtc)||void 0===t||t.handleStalled(e,s.getCombinedBufferInfo(e.currentTime,0).len,this.hls.interstitialActive),this.hls.trigger(j.STALLED,e)}))),e.push(Vn(s.timeupdate$.pipe(pn(1e3)),s.gotPlaying$.pipe(_r(e=>e))).pipe(sr(()=>{const t=s.currentTime,e=s.getBufferedSegmentsByType(Xs.Variant);return null==e?void 0:e.find(e=>e.startPTS<=t&&e.endPTS>t)}),_d(),sn(null),Vr(),cn(([e,t])=>{const i=null==t?void 0:t.frag,r=null==e?void 0:e.frag;if(i&&!Gh(r,i)&&(this.hls.trigger(j.FRAG_CHANGED,t),this.hls.inGaplessMode&&this.checkAndTriggerReadyForNext(s,t,this.logger),!r||i.mediaOptionId!==r.mediaOptionId)){const s=this.rootPlaylistService.query.getEntity(i.itemId),e=null==s?void 0:s.mediaOptionListTuple[Ys.Variant].mediaOptions.find(e=>e.mediaOptionId===i.mediaOptionId);if(e){const n=r?r.mediaOptionId:"",a=i.mediaOptionId;null===(t=this.rtc)||void 0===t||t.handleLevelSwitched({url:e.url,mediaOptionId:e.mediaOptionId,oldVariant:""!==n?n:void 0,newVariant:a},this.hls.interstitialActive),this.hls.trigger(j.LEVEL_SWITCHED,e)}}}))),this.hls.inGaplessMode&&e.push(nr(s.isBufferedToEnd$(this.hls.config.maxBufferHole,!1),Li).pipe(_r(e=>!0===e),cn(e=>{if(e&&!this.hls.itemQueue.isPreloading()&&this.hls.inGaplessMode){const i=s.getCombinedBufferInfo(s.currentTime,0);var t=0;i&&(t=i.end,e=s.mediaElementDuration,0<t&&e-s.currentTime<10&&this.hls.trigger(j.READY_FOR_NEXT_ITEM,{duration:t}))}}))),Vn(...e)}));return nr(Vn(e,t,i,r),Cn)}_interstitialQueryListener(d,e){return d?Vn(d.interstitials$.pipe(cn(e=>{this.hls.trigger(j.INTERSTITIALS_UPDATED,{events:e})})),d.playingInterstitialId$.pipe(Vr(),yn(e.activeItemById$),cn(([[e,t],i])=>{var r,n,i=null!==(r=i.parentItemId)&&void 0!==r?r:i.itemId;if(null==e&&null!=t){const e=d.getInterstitialForId(t);this.hls.trigger(j.INTERSTITIAL_STARTED,{event:e}),null===(n=this.rtc)||void 0===n||n.interstitialStarted(i)}else if(null!=e&&null==t){const a=d.getInterstitialForId(e);this.hls.trigger(j.INTERSTITIAL_ENDED,{event:a}),null===(n=this.rtc)||void 0===n||n.interstitialEnded(i)}else if(null!=e&&null!=t&&e!==t){const s=d.getInterstitialForId(e),r=d.getInterstitialForId(t);this.hls.trigger(j.INTERSTITIAL_ENDED,{event:s}),null===(t=this.rtc)||void 0===t||t.interstitialEnded(i),this.hls.trigger(j.INTERSTITIAL_STARTED,{event:r}),null===(t=this.rtc)||void 0===t||t.interstitialStarted(i)}})),d.playingInterstitialAssetId$.pipe(Vr(),yn(d.playingInterstitialId$,e.activeItemById$),cn(([[e,t],i,r])=>{var n,a,r=null!==(n=r.parentItemId)&&void 0!==n?n:r.itemId,i=d.getInterstitialForId(i);if(null==e&&null!=t){const e=d.getInterstitialAssetForId(t);this.hls.trigger(j.INTERSTITIAL_ASSET_STARTED,{asset:e,event:i}),null===(a=this.rtc)||void 0===a||a.interstitialAssetStarted(r)}else if(null!=e&&null==t){const s=d.getInterstitialAssetForId(e);this.hls.trigger(j.INTERSTITIAL_ASSET_ENDED,{asset:s,event:i}),null===(a=this.rtc)||void 0===a||a.interstitialAssetEnded(r,s.duration)}else if(null!=e&&null!=t&&e!==t){const o=d.getInterstitialAssetForId(e),l=d.getInterstitialAssetForId(t);this.hls.trigger(j.INTERSTITIAL_ASSET_ENDED,{asset:o,event:i}),null===(t=this.rtc)||void 0===t||t.interstitialAssetEnded(r,o.duration),this.hls.trigger(j.INTERSTITIAL_ASSET_STARTED,{asset:l,event:i}),null===(i=this.rtc)||void 0===i||i.interstitialAssetStarted(r)}}))):Cr}desiredRateChanged(e,t){var i;ep(e)!==ep(t)?this._rateChangeStart=performance.now():this._rateChangeStart=NaN,null===(i=this.rtc)||void 0===i||i.handleDesiredRateChanged(e,t),this.hls.trigger(j.DESIRED_RATE_CHANGED,{oldRate:e,newRate:t})}checkAndTriggerReadyForNext(e,t,i){var r,n;t&&t.frag&&(r=e.currentTime,(n=e.getCombinedBufferInfo(r,0))&&(r=n.len?n.end:0,n=e.mediaElementDuration,e=e.bufferMonitorInfo,e=Math.max(e.almostDryWaterLevelSeconds,e.lowWaterLevelSeconds/2),n=n-t.endPTS,(0<r&&n<=e||t.frag.isLastFragment)&&this.hls.inGaplessMode&&!this.hls.isPreloading&&this.hls.trigger(j.READY_FOR_NEXT_ITEM,{duration:r})))}asyncEventTriggerListener(){return this.triggerAsyncEvent$.pipe(tr(Li),cn(e=>{this.hls.trigger(e.eventName,e.payload)}))}_handleLevelLoad(e,t){const i=t.mediaOptionDetails,{itemId:r,mediaOptionId:n,mediaOptionType:a,url:s}=e;if(t.detailsLoading){const o={url:f(s),level:n,type:Mo[a]};this.hls.trigger(j.LEVEL_LOADING,o)}else{const o=t.stats,a={mediaOptionId:n,details:i,playlistType:i.type,stats:o},s=this.hls.itemQueue.getQueueItemForId(r),l=null!==(e=null!==(e=null==s?void 0:s.parentItemId)&&void 0!==e?e:null==s?void 0:s.itemId)&&void 0!==e?e:r;if(null===(e=this.rtc)||void 0===e||e.handleLevelLoaded(l,i,a.stats),this.hls.trigger(j.LEVEL_LOADED,a),0===t.unchangedCount){const o={level:0,details:i};this.hls.trigger(j.LEVEL_UPDATED,o)}if(null!=i&&i.daterangeTags){const o={daterangeTags:i.daterangeTags};this.hls.trigger(j.DATERANGE_UPDATED,o)}}}triggerAsyncHlsEvent(e){this.triggerAsyncEvent$.next(e)}postSubtitleTrackSwitch(e,t,i){var r=this.hls.itemQueue.activeItem,n=r.isInterstitial,r=!n&&r.parentItemId;return this.hls.config.enableInterstitialPlayback&&!t&&(n||r&&e)||("persistentID"in i?this.triggerAsyncHlsEvent({eventName:j.SUBTITLE_TRACK_SWITCH,payload:{track:Object.assign({},i),hidden:!1,fromInterstitial:n}}):this.triggerAsyncHlsEvent({eventName:j.SUBTITLE_TRACK_SWITCH,payload:{track:void 0,hidden:!1,fromInterstitial:n}})),Cr}postAudioTrackSwitched(e,t,i){var r,n;i&&(n=!(r=(n=this.hls.itemQueue.activeItem).isInterstitial)&&n.parentItemId,this.hls.config.enableInterstitialPlayback&&!t&&(r||n&&e)||this.triggerAsyncHlsEvent({eventName:j.AUDIO_TRACK_SWITCHED,payload:{id:i.id,track:i,fromInterstitial:r}}))}triggerBufferAppended(){this.hls.trigger(j.BUFFER_APPENDED)}triggerBufferedToInterstitialBoundary(e,t,i,r){this.hls.trigger(j.BUFFERED_TO_INTERSTITIAL_BOUNDARY,{id:e,type:t,timestamp:i,willResetMediaSource:r})}triggerManifestLoaded(e){const t=e.rootMediaOptionsTuple[Ys.Variant],i=t.filter(e=>e.iframes),r={levels:t,audioTracks:e.rootMediaOptionsTuple[Ys.AltAudio],subtitleTracks:e.rootMediaOptionsTuple[Ys.Subtitle],iframeVariants:i,url:e.baseUrl,audioMediaSelectionGroup:e.audioMediaSelectionGroup,subtitleMediaSelectionGroup:e.subtitleMediaSelectionGroup,stats:e.stats,isMediaPlaylist:e.isMediaPlaylist};this.hls.trigger(j.MANIFEST_LOADED,r)}triggerManifestParsed(e){var t={levels:e.mediaOptionListQueries[Ys.Variant].filteredMediaOptionList,firstLevel:0,audio:!1,video:!0,altAudio:!1,audioTracks:e.mediaOptionListQueries[Ys.AltAudio].filteredMediaOptionList,subtitleTracks:e.mediaOptionListQueries[Ys.Subtitle].filteredMediaOptionList,iframeVariants:null!==(t=null===(t=e.rootPlaylistEntity)||void 0===t?void 0:t.iframeVariants)&&void 0!==t?t:[],audioMediaSelectionGroup:e.audioMediaSelectionGroup,subtitleMediaSelectionGroup:e.subtitleMediaSelectionGroup,stats:e.loadStats};this.hls.trigger(j.MANIFEST_PARSED,t),null===(e=this.rtc)||void 0===e||e.handleManifestParsed(t)}triggerFragLoaded(e,t){var i,r={frag:e,stats:t},n=this.hls.itemQueue.getQueueItemForId(e.itemId),n=null!==(i=null!==(i=null==n?void 0:n.parentItemId)&&void 0!==i?i:null==n?void 0:n.itemId)&&void 0!==i?i:e.itemId;null===(i=this.rtc)||void 0===i||i.handleFragLoaded(n,e,t),this.hls.trigger(j.FRAG_LOADED,r)}triggerPrefetchNextItem(e){this.hls.trigger(j.READY_TO_PREFETCH_NEXT_ITEM,{appItemId:e})}}class sy extends Sa{constructor(e){super(e)}get currentConfig(){var e;return null===(e=this.getActive())||void 0===e?void 0:e.config}get extendMaxTTFB(){var e;return null===(e=this.getActive())||void 0===e?void 0:e.extendMaxTTFB}get config$(){return this.selectActive(e=>null==e?void 0:e.config)}get pendingSeek(){var e;return null===(e=this.getActive())||void 0===e?void 0:e.userSeek}get pendingSeek$(){return this.selectActive(e=>null==e?void 0:e.userSeek)}get alternateMatchingInfo(){var e;return null===(e=this.getActive())||void 0===e?void 0:e.alternateMatchingInfo}get alternateMatchingInfo$(){return this.selectActive(e=>null==e?void 0:e.alternateMatchingInfo)}}Ci();class oy extends pa{constructor(){super({},{name:"hls-store"})}}class ly{constructor(e){this.store=e,this._query=new sy(e)}get query(){return this._query}setHlsEntity(e){const t=e.id;da(()=>{this.store.add(n(e)),this.store.setActive(t)})}removeEntity(e){this.store.remove(e)}setUserSeek(e){this.store.updateActive({userSeek:e})}setExtendMaxTTFB(e){this.store.updateActive({extendMaxTTFB:e})}set config(e){this.store.updateActive({config:e})}setAlternateMatchingInfo(e){this.store.updateActive({alternateMatchingInfo:e})}setAudioAlternateMatchingInfo(e){var t=this._query.getActive();t&&(e=Object.assign(Object.assign({},t.alternateMatchingInfo),{audioMatchingInfo:e}),this.store.updateActive({alternateMatchingInfo:e}))}setSubtitleAlternateMatchingInfo(e){var t=this._query.getActive();t&&(e=Object.assign(Object.assign({},t.alternateMatchingInfo),{subtitleMatchingInfo:e}),this.store.updateActive({alternateMatchingInfo:e}))}reset(){this._query.getActive()&&this.store.updateActive({alternateMatchingInfo:void 0,userSeek:void 0,extendMaxTTFB:void 0})}destroy(){this.store.destroy()}}function dy(e,t){const i=e.seekable;let r=0;return 0<i.length&&(r=i.end(i.length-1)),z(r)||(r=e.mediaElementDuration),Math.max(0,r-(t.leftMediaTimeToAutoPause||0))}(vy=vy=vy||{}).AlmostDryWaterLevel="AlmostDryWaterLevel",vy.LowWaterLevel="LowWaterLevel",vy.HighWaterLevel="HighWaterLevel",(vy=dg=dg||{})[vy.Enter=0]="Enter",vy[vy.Exit=1]="Exit";class uy extends Sa{}function cy(e,t){const{appItemId:i,clientName:r,serviceName:n,platformInfo:a}=e,s={appItemId:i,clientName:r,serviceName:n,platformInfo:a};return t&&(s.parentItemId=null!==(t=e.parentItemId)&&void 0!==t?t:e.itemId),s}class hy{constructor(e,t){this.queueItemStore=e,this.logger=t,this.firstItem=!0,this.playing$=new qr(null),this._prefetchItem$=new qr(null),this._query=new uy(e)}static createItem(e,t,i,r,n=!1,a={}){var s;const o=new Date,l=`${o.getHours()}:${o.getMinutes()}:${o.getSeconds()}`,d=function(e){e=null===(e=qs.parseURL(e))||void 0===e?void 0:e.fragment.substr(1);if(!e||0===e.length)return null;const t=new URLSearchParams(e);if(!t.has("t"))return null;e=Number(t.get("t"));return z(e)?e:null}(t);let u=null!==(s=a.initialSeekTime)&&void 0!==s?s:NaN;return z(u)||(z(d)?u=d:z(i.startPosition)&&(u=i.startPosition)),{itemId:`${e}_${l}`,parentItemId:a.parentItemId,clientName:a.clientName,serviceName:a.serviceName,appItemId:a.appItemId,initialRate:a.initialRate,platformInfo:a.platformInfo,loopCount:a.loopCount,itemStartOffsets:a.itemStartOffsets||[0,0],seekImmediately:a.seekImmediately,initialSeekTime:u,name:e,url:t,config:{},isInterstitial:n,itemTimelineStartPosition:0,itemTimelineEndPosition:1/0,replaceItemAction:a.replaceItemAction}}get query(){return this._query}get activeItemById$(){return this._query.selectActiveId().pipe(sr(e=>this._query.getActive()))}get removedItems$(){return this._query.selectEntityAction(jn.Remove).pipe(sr(e=>e))}get activeItem(){return this._query.getActive()}getQueueItemForId(e){return this._query.getEntity(e)}get queueItems$(){return this._query.selectAll().pipe(sr(e=>null!=e?e:[]))}get queueItems(){return this._query.getAll()}get isFirstItem(){return this.firstItem}get playingItem(){return this.playing$.getValue()}get loadingItem(){if(null==this.playingItem)return null;const e=this._query.getAll(),t=e.findIndex(e=>e.itemId===this.playingItem.itemId);return t<0||t>=e.length-1?null:e[t+1]}addQueueItem(e,t,i,r=!1,n={}){let a;return this.prefetchItem&&n.appItemId&&this.prefetchItem.appItemId===n.appItemId?(a=Object.assign(Object.assign(Object.assign({},this.prefetchItem),n),{isInterstitial:r}),this._prefetchItem$.next(null)):a=hy.createItem(e,t,i,this.logger,r,n),null!=this.playingItem&&(a.initialSeekTime=void 0),null!=n&&n.itemStartOffsets&&(a.itemStartOffsets=n.itemStartOffsets,this.firstItem=!1,this.playing$.next(this.activeItem)),da(()=>{this.queueItemStore.add(a),this.queueItemStore.setActive(a.itemId)}),a}addPrefetchItem(e,t,i,r=!1,n={}){if(null!=n.appItemId){const a=hy.createItem(e,t,i,this.logger,r,n);return null!=n&&n.itemStartOffsets&&(a.itemStartOffsets=n.itemStartOffsets),this._prefetchItem$.next(a),a}}get prefetchItem$(){return this._prefetchItem$.asObservable()}get prefetchItem(){return this._prefetchItem$.getValue()}get primaryItem(){var e;return this._query.getEntity(null!==(e=null===(e=this.playingItem)||void 0===e?void 0:e.parentItemId)&&void 0!==e?e:null===(e=this.playingItem)||void 0===e?void 0:e.itemId)}insertQueueItem(e){this.queueItemStore.add(e)}setPlayingItem(e){this.playing$.next(e)}getItemTimelineEndPosition(e){e=this.getQueueItemForId(e);return null==e?void 0:e.itemTimelineEndPosition}updatePlayingItemId(e=!0){this.playing$.next(this.loadingItem),e&&this.clearAllButActive()}resetLoadingItem(){da(()=>{this.loadingItem&&this.removeQueueItem(this.loadingItem.itemId),this.queueItemStore.setActive(this.playingItem.itemId)})}getQueueItemForTime(e,t=!1){for(const i of this.queueItems)if(e>=i.itemTimelineStartPosition&&e<=i.itemTimelineEndPosition&&(!i.isInterstitial||i.isInterstitial&&t))return i;return null}_setActive(e,t,i,r){const n=Object.assign({},this._query.getEntity(e)),a=null!=i?i:n.initialSeekTime;this.firstItem=!1,da(()=>{this.queueItemStore.update(e,{itemStartOffsets:t,initialSeekTime:a,seekImmediately:r}),this.queueItemStore.setActive(e)})}setActiveWithContext(e,t,i,r,n){this.setActiveContext&&this.setActiveContext.itemId===e&&null!=e?(this.setActiveContext.parentItemId=(null==t?void 0:t.parentItemId)||this.setActiveContext.parentItemId,this.setActiveContext.userSwitchAudioTrack=(null==t?void 0:t.userSwitchAudioTrack)||this.setActiveContext.userSwitchAudioTrack,this.setActiveContext.userSwitchSubtitleTrack=(null==t?void 0:t.userSwitchSubtitleTrack)||this.setActiveContext.userSwitchSubtitleTrack):this.setActiveContext=t,this._setActive(e,i,r,n)}reset(){da(()=>{this.resetInternal(),this._setActive(null,[0,0],NaN,!1),this.playing$.next(null)})}resetInternal(){this.clearQueue(),this.setActiveContext=null,this.firstItem=!0}setActive(e,t,i,r){var n;(null===(n=this.setActiveContext)||void 0===n?void 0:n.itemId)!==e&&null!=e&&(this.setActiveContext=null),this._setActive(e,t,i,r)}getActiveItemContext(e){var t;return(null===(t=this.setActiveContext)||void 0===t?void 0:t.itemId)===e&&null!=e?this.setActiveContext:null}clearActiveItemContext(e){var t;(null===(t=this.setActiveContext)||void 0===t?void 0:t.itemId)===e&&null!=e&&(this.setActiveContext=null)}updateItemById(e,t){this.queueItemStore.update(e,t)}isPreloading(){return null!=this.playingItem&&null!=this.loadingItem}setQueueItem(e,t,i,r,n=!1){var a;let s;this.prefetchItem&&r.appItemId&&this.prefetchItem.appItemId===r.appItemId?(s=Object.assign(Object.assign(Object.assign({},this.prefetchItem),r),{initialSeekTime:null!==(a=r.initialSeekTime)&&void 0!==a?a:0}),this._prefetchItem$.next(null)):s=hy.createItem(e,t,i,this.logger,n,r),da(()=>{this.queueItemStore.remove(),this.queueItemStore.add(s),this.queueItemStore.setActive(s.itemId)}),this.playing$.next(this.activeItem)}removeQueueItem(e){this.queueItemStore.remove(e)}clearQueue(){this.queueItemStore.remove()}clearAllButActive(){var e;const t=null===(e=this.activeItem)||void 0===e?void 0:e.itemId;da(()=>{this._query.getAll().forEach(e=>{e.itemId!==t&&this.queueItemStore.remove(e.itemId)})})}}class py{constructor(e,t,i,r,n,a,s,o){this.itemQueue=e,this.interstitialService=t,this.publicQueries$=i,this.config=r,this.rtcQuery=n,this.playerEvents=a,this.customUrlLoader=s,this._primaryDistToLive=NaN,this.queuedInterstitialIdx=-1,this.mediaFragmentAppended$=new Er,this.activeAssets=[],this.savedInterstitials=null,this.savedInterstitialsOffset=[null,null],this.savedSeekValue=null,this.cancelInterstitial$=new Er,this._finishedAppendingAssetForSourceBufferType=[!1,!1],this._reachedBoundaryForSourceBufferType=[!1,!1],this.logger=o.child(py.loggerName)}reset(){this.queuedInterstitials=null,this.queuedInterstitialIdx=-1,this.savedInterstitials=null,this.savedInterstitialsOffset=[null,null],this.activeAssets=[],this.activeInterstitialId=null,this._primaryResumptionTime=void 0,this.savedSeekValue=null,this._reachedBoundaryForSourceBufferType=[!1,!1],this._finishedAppendingAssetForSourceBufferType=[!1,!1]}set mediaQuery(e){this._mediaQuery=e}get activeInterstitial(){return this.activeInterstitialId?this.interstitialService.interstitialQuery.getInterstitialForId(this.activeInterstitialId):null}cancelInterstitial(e,t,i){this.cancelInterstitial$.next({seekTo:e,initialRate:t,seekImmediately:i})}postRollCheck$(t,e){const{config:i,mediaLibraryService:r,rootPlaylistQuery:n}=e;return i.enableInterstitialPlayback?Qn([r.query.selectEntity(n.itemId).pipe(sr(e=>null==e?void 0:e.liveOrEvent)),this.interstitialService.interstitialQuery.playableInterstitials$,t.isBufferedToEnd$(i.maxBufferHole,!1)]).pipe(sr(([e,t,i])=>{var r=this.itemQueue.playingItem;return e||!i||this.activeInterstitial||null!=r&&r.isInterstitial?[]:(this._primaryQueueItem&&this._primaryQueueItem.itemId===r.itemId||(this._primaryQueueItem=r),t.filter(e=>e.cueType===pl.Postroll))}),on(e=>this.getQueuedInterstitials(e,null,i)),sr(e=>(0<e.length&&null!=this.savedInterstitials&&(this.savedInterstitials=null),0!==e.length&&(this.queuedInterstitials=e,this.queueNextInterstitial(t,1/0)))),ln(Cr)):Cr}fragmentIsInterstitialBoundary(a,e){const{config:p,mediaLibraryService:t}=e,i=Pr(!1);if(a.iframe||a.mediaOptionType===Ys.Subtitle)return i;const m=a.mediaOptionType,r=this.interstitialService.interstitialQuery,n=p.enableInterstitialPlayback?r.playableInterstitials:[];if(0===n.length)return i;var s=this.itemQueue.getQueueItemForId(a.itemId);if(!s)return i;const f=a.start,g=f+a.duration,y=t.getQueryForOption(a).mediaOptionDetails,v=y.fragments,S=y.pdtToMSN;if(this._primaryPlaylistType=y.type,s.isInterstitial){if(this.activeInterstitial){const a=r.getInterstitialForId(this.activeInterstitial.identifier);if(a.playoutLimit){const h=E(a.playoutLimit),b=this.getInterstitialStartTime(a,S,v);f>=b+h&&this.cancelInterstitial$.next({})}}return i}this._primaryQueueItem&&this._primaryQueueItem.itemId===s.itemId||(this._primaryQueueItem=s);let I=NaN,o=this.savedInterstitials;if(null==o){let h=NaN;o=n.filter(t=>{var e;const i=t.cueType===pl.Preroll,r=t.cueType===pl.Midroll,n=null!==(e=t.snapOptions)&&void 0!==e?e:ml.None,a="VOD"===this._primaryPlaylistType?this._primaryQueueItem.itemStartOffsets:[0,0],s=this.getInterstitialStartTime(t,S,v),o=!z(h)||s===h,l=a[m]+s,d=f<=l&&g>l&&r;let u=!1;if(p.enablePartialInterstitialPlaybackForLiveEdge&&y.liveOrEvent&&z(t.duration)){u=l<=f&&l+t.duration>f;const h=(null===(e=y.fragments[y.fragments.length-1])||void 0===e?void 0:e.start)||0,c=ef(y,p.liveAllowLowLatencyPlayback)-gf(y,p),i=h-l;I=Math.max(0,i-c)}return!(!(i||d||u)||!o||this.activeInterstitial||!i&&l!==f&&!u&&(this.savedInterstitials||(h=s,this.savedInterstitials=[]),(0===this.savedInterstitials.length||this.savedInterstitials.findIndex(e=>e.identifier===t.identifier)<0)&&this.savedInterstitials.push(t),this.savedInterstitialsOffset[m]||(this.savedInterstitialsOffset[m]=g-l),n!==ml.Out&&n!==ml.InOut||!(l-f<g-l)||(this.savedInterstitials=null,0)))})}if(null==o||0===o.length)return i;var l=o[0],d=l.cueType===pl.Preroll,u=("VOD"===this._primaryPlaylistType?this._primaryQueueItem.itemStartOffsets[m]:0)+E(l.startTime),e=l.snapOptions===ml.Out||l.snapOptions===ml.InOut,s=f<=u&&g>u;d||this.savedInterstitialsOffset[m]||!s||(this.savedInterstitialsOffset[m]=g-u);const c=null!==(l=null===(l=this._mediaQuery)||void 0===l?void 0:l.expectedSbCount)&&void 0!==l?l:0;return(f>=u||s&&e)&&(this._reachedBoundaryForSourceBufferType[m]=!0),d||this._reachedBoundaryForSourceBufferType.every((e,t)=>t>=c||e)?this.getQueuedInterstitials(o,I,p).pipe(yn(this.publicQueries$),sr(([e,[,t]])=>{if(0===e.length)return this.reset(),!1;this.queuedInterstitials=e,this.savedInterstitials=null;var i=e[0].interstitial,r=i.snapOptions,e=r===ml.In||r===ml.InOut;let n=0;r=this.getInterstitialStartTime(i,S,v);return i.cueType!==pl.Preroll&&(n=e?a.start:r),y.liveOrEvent&&(this._primaryDistToLive=ef(y,p.liveAllowLowLatencyPlayback)-n),this.queueNextInterstitial(t,n)})):Pr(this._reachedBoundaryForSourceBufferType[m])}get playback$(){return Vn(this._activeInterstitial$(),this._playingInterstitial$(),this._bufferedToBoundary$())}fragmentAppended(e){this.mediaFragmentAppended$.next(e)}getAdjustedSeek(r,n,e,t=!1,a,s,i){const o=this.interstitialService.interstitialQuery,l=this.config.enableInterstitialPlayback?o.playableInterstitialsForSeek:[];let d,u;if(n<r&&0===l.length)return{adjustedSeek:r};var c=o.getInterstitialForId(o.playingInterstitialId);if(c){const n=null==i?void 0:i.find(e=>e.start<=r&&e.end>=r);return r=n?r:Math.min(r,c.duration),{adjustedSeek:this.seekWithinInterstitial(r,e)}}if(n<r){const e=l.find(e=>{var t=e.cueType===pl.Midroll,i=this.getInterstitialStartTime(e,a,s),e=e.referenceRestrictions===fl.Jump||e.referenceRestrictions===fl.SkipJump;return t&&e&&n<i&&i<=r});if(e){const n=this.getInterstitialStartTime(e,a,s),i=Zh(t?this.itemQueue.activeItem:this.itemQueue.getQueueItemForTime(n));return this.savedSeekValue=r,{adjustedSeek:Math.max(i,i+n-this.config.adjustedSeekToleranceMs/1e3)}}{const n=this.itemQueue.getQueueItemForTime(r);return{adjustedSeek:r+Zh(n)}}}{const n=this.itemQueue.getQueueItemForTime(r),{itemId:e,itemStartOffsets:h}=n;return e!==(null===(t=this.itemQueue.activeItem)||void 0===t?void 0:t.itemId)&&(da(()=>{d=e,u=h[Ys.Variant],this.interstitialService.setActiveInterstitialAssetId(null),this.interstitialService.setActiveInterstitialId(null)}),this.activeInterstitialId=null,this.activeAssets=[]),this.interstitialService.removeInterstitialsFromPastEventsFromTime(r),{adjustedSeek:r+h[Ys.Variant],newItemId:d,startOffset:u}}}getQueuedInterstitials(t,i,e){return function(u,c,h,p){const{interstitials:e,startOffset:m}={interstitials:t,startOffset:i};return ar(e).pipe(Sr(d=>ar(d.urls).pipe(pr(e=>{if(-1!==e.indexOf(".m3u"))return Pr({assets:[{uri:e,duration:d.duration}]});var t,r,n,a,s,o,l;{const i=new URL(e);return z(m)&&i.searchParams.append("_HLS_start_offset",m.toString()),t=i.toString(),e=d.identifier,r=t,n=e,a=u,s=c,o=h,l=p,Pn(()=>{var e=Go({url:r},o),t={url:r,xhrSetup:s.xhrSetup,forInterstitialAssetList:!0,interstitialIdentifier:n};let i;if(a.allowInterstitialAssetListDownload)i=Al(t,e,0,l);else{const r=Object.assign(Object.assign({},t),{method:"GET",responseType:"text",extendMaxTTFB:0});i=l.load(r,e).pipe(El())}return i.pipe(sr(({responseText:e})=>function(e){let t,i,r;try{try{t=JSON.parse(e)}catch(e){throw Tl("interstitial asset list JSON format is malformed")}if(null==t)throw Tl("interstitial asset list is empty");if(!Array.isArray(t.ASSETS))throw Tl("invalid interstitial asset list ASSETS data type");const i=function(e){for(const r of e.assets){const e=(t=r,i=void 0,"string"!=typeof t.uri?Tl("invalid interstitial asset URI data type"):null==(i=t.uri)||0!==i.indexOf("//")&&(-1===i.indexOf("://")||-1===i.indexOf(".")||-1===i.indexOf("/")||i.indexOf(":")>i.indexOf("/")||!(i.indexOf("://")<i.indexOf(".")))?Tl("interstitial asset uri is not absolute "+t.uri):"number"!=typeof t.duration?Tl("invalid interstitial asset DURATION data type"):void 0);if(null!=e)return e}var t,i}(r={assets:t.ASSETS.map(e=>({uri:e.URI,duration:e.DURATION}))});if(null!=i)throw i;return r}catch(e){throw i=e instanceof $?e:Tl(`unknown exception when parsing interstitial asset list: ${e}`),i}}(e)))}).pipe(Wi(()=>Pr({assets:[]})))}}),fr((e,t)=>[...e,...t.assets],[]),sr(e=>({id:d.identifier,assets:e})))),fr((e,t)=>(e[t.id]=t.assets,e),{}))}(e,e,e.playlistLoadPolicy,this.customUrlLoader,this.logger).pipe(sr(r=>t.reduce((e,t)=>{var i=r[t.identifier];return i&&e.push({interstitial:t,assets:i}),e},[])))}queueNextInterstitial(i,r){return!(!this.queuedInterstitials||this.queuedInterstitialIdx>this.queuedInterstitials.length||!this.queuedInterstitials.find(()=>{var e=this.queuedInterstitials[++this.queuedInterstitialIdx];if(e){var{interstitial:t,assets:e}=e;if(this.updateAndSetActive(t,e,r,i))return!0}return!1}))}seekWithinInterstitial(e,n){const t=this.interstitialService.interstitialQuery,i=t.playingInterstitialId,a=t.getInterstitialForId(i),r=null==a?void 0:a.assets.map(e=>this.itemQueue.getQueueItemForId(e)).filter(e=>null!=e);if(0===r.length)return e;const s=Zh(r[0])+e,o=r.reduce((e,t)=>{var i=Zh(t);return i>Zh(e)&&i<s?t:e},r[0]);return this.activeInterstitialId=a.identifier,da(()=>{var e,t,i,r;this.interstitialService.setActiveInterstitialAssetId(o.itemId),this.interstitialService.setActiveInterstitialId(a.identifier),this.interstitialService.removeInterstitialsFromPastEvents([a.identifier]),e=n,t=o.itemId,i=s,r=null!==(r=null===(r=e.sourceBufferEntities)||void 0===r?void 0:r.filter(e=>Boolean(e)).length)&&void 0!==r?r:0,my(Xs.Variant,e,t,i)&&(2!==r||my(Xs.AltAudio,e,t,i))||this.itemQueue.setActive(o.itemId,o.itemStartOffsets),this.itemQueue.playing$.next(o)}),s}_activeInterstitial$(){const r=this.interstitialService.interstitialQuery;return r.activeInterstitialId$.pipe(tr(Li),_d(),yn(this.publicQueries$),sr(([e,[,t]])=>{var i=r.getInterstitialForId(e);return[null!==(e=null===(e=null==i?void 0:i.assets)||void 0===e?void 0:e.map(e=>this.itemQueue.getQueueItemForId(e)))&&void 0!==e?e:[],t,i.cueType]}),on(([s,o,l])=>{if(s.length<1)return Cr;var e=null!==(e=Rl(s,r.activeInterstitialAssetId).element)&&void 0!==e?e:s[0];this.setNextActiveQueueItem(e,!0,o,l),this.activeAssets=s;e=this.mediaFragmentAppended$.pipe(_d(),on(e=>{const{itemId:t,type:i,isLastFragment:r}=e;if(i===Ys.Subtitle)return Cr;if(r){const n=null!==(e=null===(e=this._mediaQuery)||void 0===e?void 0:e.expectedSbCount)&&void 0!==e?e:0,r=this.itemQueue.getQueueItemForId(t);this._finishedAppendingAssetForSourceBufferType[i]=!0;e=this._finishedAppendingAssetForSourceBufferType.every((e,t)=>t>=n||e);if(r&&r.isInterstitial&&e){this._reachedBoundaryForSourceBufferType=[!1,!1],this._finishedAppendingAssetForSourceBufferType=[!1,!1];const n=Rl(s,r.itemId).index,a=s[n+1];return Jl(Pr(a).pipe(on(e=>e||"VOD"===this._primaryPlaylistType?Pr(!0):o.waterLevelChangedForType$(Xs.Variant).pipe(sr(e=>e===Qu.AlmostDry)))),e=>e).pipe(cn(()=>{this.setNextActiveQueueItem(a,!1,o,l)}))}}return Cr}),dn(this.cancelInterstitial$));return Vn(this.cancelInterstitial$.pipe(cn(e=>{this.savedSeekValue=null,this.setNextActiveQueueItem(null,!1,o,l,e.seekTo,e.initialRate,e.seekImmediately)})),e).pipe(ln(Cr))}))}_playingInterstitial$(){return this.publicQueries$.pipe(_r(e=>!!e&&!!e[1]),on(([,e])=>Qn([e.timeupdate$,e.bufferedSegmentsByType$(Xs.Variant)]).pipe(sr(([t,e])=>null==e?void 0:e.find(e=>e.startPTS<=t&&e.endPTS>t)),_r(e=>!!e),sn(null),Vr())),sr(([e,t])=>this.updatePlayingItems(e,t)),xr())}_bufferedToBoundary$(){return this.publicQueries$.pipe(_r(e=>!!e&&!!e[0]&&!!e[1]),on(([e,o])=>e.getInFlightFragByType$(Ys.Variant).pipe(_r(e=>"appending"===(null==e?void 0:e.state)),on(({itemId:e,compatible:t})=>{var i=this.itemQueue.getQueueItemForId(e);if(!i)return Cr;var r=o.sourceBufferEntityByType(Xs.Variant);let n=i.itemStartOffsets[Ys.Variant];var a=i.isInterstitial,e=null==r?void 0:r.bufferedSegments[(null==r?void 0:r.bufferedSegments.length)-1];if(!e&&a){const s=wl(i.itemId);return this.playerEvents.triggerBufferedToInterstitialBoundary(s,dg.Enter,Q(n,1e3),!t),Cr}var r=this.itemQueue.getQueueItemForId(null==e?void 0:e.frag.itemId),e=null!==(e=null==r?void 0:r.isInterstitial)&&void 0!==e&&e;if(n-=null!==(r=Zh(r))&&void 0!==r?r:0,a!==e){const s=a?wl(i.itemId):i.itemId,o=a?dg.Enter:dg.Exit;this.playerEvents.triggerBufferedToInterstitialBoundary(s,o,Q(n,1e3),!t)}return Cr}))))}interstitialIsPlaying(){var e=this.itemQueue.playingItem;return e&&e.isInterstitial}itemIdIsInterstitial(e){var e=this.itemQueue.getQueueItemForId(e);return null!==(e=null==e?void 0:e.isInterstitial)&&void 0!==e&&e}handleError(r){return r instanceof v&&!r.fatal||!this.activeInterstitial?Pr({handled:!1,error:r}):(this.logger.error("Error during interstitial, switching to next available asset or primary content"),this.publicQueries$.pipe(kr(1),sr(([,e])=>{var t=this.interstitialService.interstitialQuery.activeInterstitialAssetId,i=Rl(this.activeAssets,t).index+1;return this.itemQueue.removeQueueItem(t),this.setNextActiveQueueItem(this.activeAssets[i],!1,e,this.activeInterstitial.cueType),{handled:!0,error:r}})))}snapIn(e,t){const i=e["initialSeekTime"];if(!z(i))return NaN;if(null==t||t.iframesOnly||t.mediaOptionType===Ys.Subtitle)return i;t=(null==t?void 0:t.fragments)||[],t=vl.search(t,e=>{var t=e.start,e=t+e.duration,t=i-t,e=e-i;return t<e&&0<=t&&0<=e?0:t});if(t){const r=t.start;return this.itemQueue.updateItemById(e.itemId,{initialSeekTime:r}),r}return i}getInterstitialStartTime(e,t,i){if(e.startTime)return E(e.startTime);var[r,t]=s(e.startDate,t,i),i=Zh(this._primaryQueueItem)||0,i=(e.startDate-r)/1e3+t-i;return this.interstitialService.updateInterstitial(e.identifier,{startTime:{baseTime:i,timescale:1}}),i}updatePlayingItems(e,t){var i;let r=!1;var n=this.interstitialService.interstitialQuery.playingInterstitialId;if(null==e&&null!=t){const a=t.frag,e=this.itemQueue.getQueueItemForId(a.itemId);if(e)if(e.isInterstitial){const a=wl(e.itemId);n!==a&&(null!==n&&(this.rtcQuery.interstitialPlayTime(null!==(i=e.parentItemId)&&void 0!==i?i:e.itemId),this.interstitialService.interstitialQuery.getInterstitialForId(n)),this.interstitialService.interstitialQuery.getInterstitialForId(a),this.interstitialService.setPlayingInterstitialId(a),this.interstitialService.setPlayingInterstitialAssetId(e.itemId),r=!n)}else n&&(this.interstitialService.setPlayingInterstitialAssetId(null),this.interstitialService.setPlayingInterstitialId(null),r=!0)}else if(null!=e&&null!=t){const i=e.frag,s=t.frag,o=this.itemQueue.getQueueItemForId(i.itemId),l=this.itemQueue.getQueueItemForId(s.itemId);if(o&&l&&o.itemId!==l.itemId){this.rtcQuery.interstitialPlayTime(null!==(e=o.parentItemId)&&void 0!==e?e:o.itemId);const a=wl(o.itemId),t=wl(l.itemId);!o.isInterstitial&&l.isInterstitial?n!==t&&(this.interstitialService.interstitialQuery.getInterstitialForId(t),this.interstitialService.setPlayingInterstitialId(t),this.interstitialService.setPlayingInterstitialAssetId(l.itemId),r=!0):o.isInterstitial&&l.isInterstitial?(a&&t&&a!==t&&(this.interstitialService.interstitialQuery.getInterstitialForId(a),this.interstitialService.interstitialQuery.getInterstitialForId(t),this.interstitialService.setPlayingInterstitialId(t)),this.interstitialService.setPlayingInterstitialAssetId(s.itemId)):o.isInterstitial&&!l.isInterstitial&&(this.interstitialService.interstitialQuery.getInterstitialForId(a),this.interstitialService.setPlayingInterstitialAssetId(null),this.interstitialService.setPlayingInterstitialId(null),r=!0)}}return r}setNextActiveQueueItem(r,n,e,t,i,a,s){let o=t===pl.Postroll?[e.mediaElementDuration,e.mediaElementDuration]:this.getCurrentBufferOffsets(e);var[l,d]=o;!z(d)&&z(l)&&(o=[l,l]);const u=this.interstitialService.interstitialQuery;let c=null!=i?i:0;var l=null!==(l=this.activeInterstitial)&&void 0!==l?l:u.getInterstitialForId(u.playingInterstitialId);l&&!i&&(c=Ol(l));let h=o[Ys.Variant]+c;if("VOD"===this._primaryPlaylistType)switch(t){case pl.Preroll:0!==c||i||(h=NaN);break;case pl.Midroll:h+=i?0:this._primaryResumptionTime;break;case pl.Postroll:h=-.5}else h=null!==(t=-this._primaryDistToLive)&&1?t:NaN,0<c&&(h+=c-l.duration);const p=this.savedSeekValue?this.savedSeekValue+c+o[Ys.Variant]:null,m=l?E(l.startTime)+c:1/0;if(r)da(()=>{var e=r.itemStartOffsets.find(z)?r.itemStartOffsets:o,t=wl(u.activeInterstitialAssetId),i=wl(r.itemId);t!==i&&this.interstitialService.updateRealCurrentTimeOffsetMap(i,e),n&&this.itemQueue.updateItemById(this._primaryQueueItem.itemId,{itemTimelineEndPosition:m}),this.itemQueue.setActive(r.itemId,e),this.interstitialService.setActiveInterstitialAssetId(r.itemId)});else if(!this.queueNextInterstitial(e)){const r=hy.createItem(this._primaryQueueItem.name,this._primaryQueueItem.url,this.config,this.logger,!1,Object.assign(Object.assign({},cy(this._primaryQueueItem,!0)),{initialSeekTime:null!=i?i:this._primaryResumptionTime,initialRate:a,itemTimelineEndPosition:this._primaryQueueItem.itemTimelineEndPosition,seekImmediately:s}));r.itemStartOffsets=o,r.initialSeekTime=null!=p?p:h,r.itemTimelineStartPosition=m;const n=null!==(l=null==l?void 0:l.snapOptions)&&void 0!==l?l:ml.None;r.snapIn=n===ml.In||n===ml.InOut,da(()=>{var e;this.itemQueue.insertQueueItem(r),this.itemQueue.setActive(r.itemId,r.itemStartOffsets,r.initialSeekTime,s),null===(e=this.queuedInterstitials)||void 0===e||e.forEach(({interstitial:e})=>{this.interstitialService.updateInterstitial(e.identifier,{hasPlayed:!0}),this.interstitialService.addInterstitialToPastEvents(e.identifier)}),this.interstitialService.setActiveInterstitialAssetId(null),this.interstitialService.setActiveInterstitialId(null)}),this.reset()}}getCurrentBufferOffsets(e){const i=e.getBufferInfo(e.currentTime,this.config.maxBufferHole),r=[1/0,1/0];return Lo.forEach(e=>{var t;0<(null===(t=i[e])||void 0===t?void 0:t.bufferedSegments.length)&&(r[e]=null!==(e=null===(e=i[e])||void 0===e?void 0:e.buffered.end)&&void 0!==e?e:Number.POSITIVE_INFINITY)}),r}updateAndSetActive(o,t,e,l){if(o&&0<t.length){const d=[],u=[];let s=0;return da(()=>{t.forEach((e,t)=>{const i=`interstitial:${o.identifier}:asset_${t+1}`,r=cy(this._primaryQueueItem,!0),n=hy.createItem(i,e.uri,this.config,this.logger,!0,r);let a=[Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY];z(this.savedInterstitialsOffset[0])&&0===this.queuedInterstitialIdx&&0===t&&(a=this.getCurrentBufferOffsets(l).map((e,t)=>Math.max(0,e-this.savedInterstitialsOffset[t]))),n.itemStartOffsets=a,this.interstitialService.addInterstitialAsset({parentIdentifier:o.identifier,identifier:n.itemId,url:e.uri,duration:e.duration}),this.itemQueue.insertQueueItem(n),u.push(n.itemId),d.push(e.uri),s+=e.duration||0});var e=Math.max(s,o.duration||0);this.interstitialService.updateInterstitial(o.identifier,{urls:d,assets:u,duration:e}),this.interstitialService.setActiveInterstitialId(o.identifier)}),!this._primaryResumptionTime&&z(e)&&(this._primaryResumptionTime=e),this.activeInterstitialId=o.identifier,o}return o&&this.interstitialService.removeInterstitials([o.identifier]),null}restoreInterstitialIdx(i){var e;let r;null===(e=this.queuedInterstitials)||void 0===e||e.find(({interstitial:e},t)=>{if(e.identifier===i.identifier)return r=t,!0}),z(r)&&(this.queuedInterstitialIdx=r)}restoreQueuedInterstitialsFromInterstitial(t,e){return e.filter(e=>E(t.startTime)===E(e.startTime))}reloadPlayingItem(t,i,e,r){const n=this.itemQueue.playingItem;if(n)if(n.isInterstitial){const s=this.interstitialService.interstitialQuery,o=s.playingInterstitialId,l=s.getInterstitialForId(o),d=n.itemId,u=Zh(n)+l.duration;r.removeLaterCues(u),e.flushAndCallback(Math.max(u-1,0),1/0,()=>{da(()=>{var e=s.playableInterstitials;this.restoreQueuedInterstitialsFromInterstitial(l,e),this.restoreInterstitialIdx(l),this.interstitialService.setActiveInterstitialAssetId(d),this.interstitialService.setActiveInterstitialId(l.identifier),this.interstitialService.removeInterstitialsFromPastEvents([l.identifier]),this.itemQueue.setActiveWithContext(d,i,n.itemStartOffsets,t)})})}else{const c=this.itemQueue.activeItem;null!=c&&c.isInterstitial&&da(()=>{this.interstitialService.removeInterstitialsFromPastEvents([wl(c.itemId)]),this.queuedInterstitialIdx=-1,this.interstitialService.setActiveInterstitialId(null),this.interstitialService.setActiveInterstitialAssetId(null),this.reset()});var a=this.itemQueue.getItemTimelineEndPosition(n.itemId),r=(r=n,Object.assign(Object.assign({},r),{url:f(r.url)}));z(a)?e.flushAndCallback(Math.max(a-1,0),1/0,()=>{this.itemQueue.setActiveWithContext(n.itemId,i,n.itemStartOffsets,t)}):(this.logger.error(`flushTime unknown: failed to flush before loading primary item ${JSON.stringify(r)}`),this.itemQueue.setActiveWithContext(n.itemId,i,n.itemStartOffsets,t))}}}function my(e,t,i,r){e=t.getBufferedSegmentsByType(e).filter(e=>e.frag.itemId===i).sort((e,t)=>e.startPTS-t.startPTS),e=0<e.length?e[e.length-1]:null;return!(!e||!e.frag.isLastFragment)&&t.getCombinedBufferInfo(r,.5).end>e.startPTS}py.loggerName={name:"Interstitials"};class fy extends qr{constructor(e){super(e),this.pipe=super.pipe,this.next=super.next}get first(){return null==this.value||this.value.length?null:this.value[0]}takeUntil(e){return dn(this.pipe(_r(e)))}}var gy,yy,vy,Sy={findFragmentBySNAndBuffer:function(e,t,i=0,r=0,n=0){let a;e=e?t[e.mediaSeqNum-t[0].mediaSeqNum+1]:null;return a=i<r?(r-n<i&&(n=0),e&&!this.fragmentWithinToleranceTest(i,n,e)?e:hl.search(t,this.fragmentWithinToleranceTest.bind(null,i,n))):t[t.length-1],a},fragmentWithinToleranceTest:function(e,t,i){t=Math.min(t,i.duration);return i.start+i.duration-t<=e?1:i.start-t>e&&i.start?-1:0}};const Iy={name:"seek"};function by(e,t,i){var i=i.getTime(),[e,t]=s(i,e,t),e=t+(i-e)/1e3;return z(e)?Math.max(0,e):0}function Ty(e,t,i,r,n,a,s,o){var l=Dm(i),d=i[Ys.Variant],u=d.totalduration,c=n.itemStartPosition,h=n.startTimeOffset,p=n.itemId,m=null==a?void 0:a.getActiveItemContext(p),n=r["liveEdgeForZeroStartPositon"];if(t&&m&&(a.clearActiveItemContext(p),m.userSwitchAudioTrack||m.userSwitchSubtitleTrack))return null;if(l)return z(e)?0<=e?e=e>ef(d)?Math.max(d.fragments[0].start,ef(d)-d.targetduration):e:c+(u+e):c+Ey(d,h);{const f=!z(e)||e<0;if(t&&(f||0===e&&n&&"LIVE"===d.type)){if(e=1/0,z(d.startTimeOffset)||z(h)){const t=Ey(d,h);e=Math.max(0,null===(d=d.fragments[0])||void 0===d?void 0:d.start)+t}}else f&&(e=1/0);return s?e:Sf(e,i,r)}}function Ey(e,t=NaN){let i=0;if(z(e.startTimeOffset))i=e.startTimeOffset;else{if(!z(t))return i;i=t}t=e.totalduration;Math.abs(i)>t&&(i=0<=i?t:-1*t);let r=i<0?t-Math.abs(i):i;return e.liveOrEvent&&(r=Math.min(r,t-3*e.targetduration)),r}function Ay(e,t,i){var r=i.rootPlaylistQuery.itemId,n=e.getQueueItemForId(r),a=(null===(s=e.playingItem)||void 0===s?void 0:s.itemId)===r,s=a||n.seekImmediately?n.initialSeekTime:null;i.logger.child(Iy),(a||n.seekImmediately)&&e.updateItemById(r,{initialSeekTime:null,seekImmediately:null});const o=t.query;return null!=s&&null==o.pendingSeek&&t.setUserSeek(s),o.pendingSeek$.pipe(function(I){const{config:b,mediaSink:T,rootPlaylistQuery:E,mediaLibraryService:A,itemQueue:O}=i,w=i.logger.child(Iy);return e=>e.pipe(on((e,i)=>{if(null==e)return Cr;var t,r,n,a,s,o,l,d,u,c,h,p,m,f,g,y,v,S=T.mediaQuery.seekTo$.pipe(an(1),_d(),sr(()=>null));return Yr([(t=e,r=0===i,n=b,a=w,s=E,o=A,l=T.mediaQuery,e=O,t instanceof Date?(g=t,y=r,v=n,Vg(s,o).pipe(sr(e=>{var t=e[Ys.Variant],i=Dm(e);let r=by(t.pdtToMSN,t.fragments,g),n=NaN;return i||(r=Sf(r,e,v)),y&&(n=i?ef(t):vf(e,v).end),{seekTo:r,playlistEnd:n}}),kr(1))):(d=t,u=r,c=n,p=l,m=e,f=a,Vg(h=s,o).pipe(_r(e=>null!=e[Ys.Variant]),_r(e=>!(e=>{return c.liveAllowLowLatencyPlayback&&e.liveOrEvent&&0<(null===(e=e.parts)||void 0===e?void 0:e.length)&&(!z(d)||d<0||0===d&&c.liveEdgeForZeroStartPositon)})(e[Ys.Variant])||!cg(e[Ys.Variant])),kr(1),sr(e=>{var t=null!=p.liveSeekableRange,i=Dm(e),t=Ty(d,u,e,c,h,m,t,f);let r=NaN;return u&&(r=i?ef(e[Ys.Variant]):vf(e,c).end),{seekTo:t,playlistEnd:r}})))),S]).pipe(kr(1),sr(e=>{if(!e)return null;var{seekTo:t,playlistEnd:e}=e;return z(e)&&0===i&&(T.msDuration=e),T.seekWithOptions(t,void 0,!0),t}),Br(()=>{I.setUserSeek(void 0)}))}))}(t))}function Oy(t,i){return e=>e.pipe(Xr({delay:e=>{if(t.error(`Got error in ${i} ${e.message} fatal:${null==e?void 0:e.fatal} handled:${null==e?void 0:e.handled}`),!(e instanceof v)||e.fatal)throw e;return e.handled?Yl:Cr}}))}function wy(e,t,i){let r=e.currentTime-t;i=null===(i=e.getCombinedBufferInfo(e.currentTime,i))||void 0===i?void 0:i.start;return z(i)&&i>r&&(r=i),r}function Ry(t,r=!1){return e=>e.pipe(function(t){return e=>e.pipe(Bg(t),on(e=>e?e.mediaOptionDetailsEntity$.pipe(_d()):Pr(null)))}(t),_r(e=>null==e||null!=e.mediaOptionDetails),xr((e,t)=>{var i=null==e?void 0:e.mediaOptionDetails,e=null==t?void 0:t.mediaOptionDetails,t=(null==i?void 0:i.endSN)===(null==e?void 0:e.endSN)&&(null==i?void 0:i.ptsKnown)===(null==e?void 0:e.ptsKnown)&&(null==i?void 0:i.liveOrEvent)===(null==e?void 0:e.liveOrEvent),e=!r||(null==i?void 0:i.partEndSN)===(null==e?void 0:e.partEndSN)&&(null==i?void 0:i.partEndIndex)===(null==e?void 0:e.partEndIndex);return t&&e}))}const Cy=(e,t)=>{let i,r="";return i=e.videoCodec&&e.audioCodec?(r=`${e.videoCodec}, ${e.audioCodec}`,t=null!=t?t:"video/mp4","audiovideo"):e.videoCodec?(r=`${e.videoCodec}`,t=null!=t?t:"video/mp4","video"):(r=`${null!==(e=e.audioCodec)&&void 0!==e?e:""}`,t=null!=t?t:"audio/mp4","audio"),{mimeType:`${t};codecs=${r}`,codec:r,container:t,type:i}};class ky{constructor(e,t,i){this.config=e,this.logger=t,this.demuxClient=i,this.typeSupported={mp4:MediaSource.isTypeSupported("video/mp4"),mpeg:MediaSource.isTypeSupported("audio/mpeg"),mp3:MediaSource.isTypeSupported('audio/mp4; codecs="mp3"'),ac3:MediaSource.isTypeSupported('audio/mp4; codecs="ac-3"'),ec3:MediaSource.isTypeSupported('audio/mp4; codecs="ec-3"')},this.demuxers=[],this.lastInitFrags=[],this.lastFrags=[]}parseInitSegment(e,t){const i=e["frag"],{keyTagInfo:r,mediaOptionType:n}=i;if(this.lastInitFrags[n]=i,$e.probeInitSegment(e.initSegment)){const t=Ne.remuxInitSegment(new Uint8Array(e.initSegment),this.logger,r),i=$e.parseInitSegment(t,this.logger),{mimeType:n,type:a,codec:s,container:o}=Cy(i);return Pr({moovData:i,mimeType:n,track:{type:a,codec:s,initSegment:t,container:o}})}return Pr({moovData:null,mimeType:null,track:{type:null,codec:null,initSegment:e.initSegment,container:null}})}parseSegment(g,e){return this.getDemuxerInfo(g,this.lastFrags,e,this.demuxClient).pipe(on(({demuxer:e,contiguous:t,trackSwitch:i,discontinuity:r,accurateTimeOffset:n})=>{const{frag:p,defaultInitPTS:a}=g,{keyTagInfo:s,start:o,duration:m,mediaOptionType:l}=p;let f;this.lastFrags[l]=p;const d=rl(e.observer);return Pr(d.event(b.FRAG_PARSING_INIT_SEGMENT).pipe(on(e=>{var t;return e.track.initSegment.byteLength!==(null===(t=g.initSegment)||void 0===t?void 0:t.byteLength)&&(f=this.handleInitSegmentData(e)),Cr})),d.event(b.FRAG_PARSING_DATA).pipe(sr(e=>{var{startPTS:t,startDTS:i,firstKeyframePts:r,framesWithoutIDR:n,largestVideoSampleSize:a,dropped:s,data1:o,data2:l,captionData:d,id3Samples:u}=e;let{endPTS:c,endDTS:h}=e;return z(c.baseTime)||(e.endPTS=c=Object.assign(Object.assign({},t),{baseTime:t.baseTime+Q(m,t.timescale).baseTime})),z(h.baseTime)||(e.endDTS=h=Object.assign(Object.assign({},i),{baseTime:i.baseTime+Q(m,i.timescale).baseTime})),z(g.iframeMediaStart)||function(e,t,i,r){let n=NaN,a=NaN;z(i)&&(a=i,n=.01,isFinite(a)&&isFinite(r)&&(a+=r));var s,{startPTS:o,startDTS:i,endPTS:r,endDTS:t}=t;if(!(0<=o.baseTime&&0<=i.baseTime&&0<e.duration&&(null==r||0<w(r,o))&&(null==t||0<w(t,i)))||z(n)&&z(a)&&!(Math.abs(E(i)-a)<=n))throw new I(!1,`Failed demuxer sanity check frag=${function(e){if(!e)return"";let t=["mediaOptionId","mediaSeqNum","discoSeqNum","start","duration"];return null!=e&&e.part&&(t=[...t,"part","partIndex"]),JSON.stringify(e,t)}(e)} parsed=${JSON.stringify({startPTS:o,endPTS:r,startDTS:i,endDTS:t})} ${t={expectedStartDTS:a,fudge:n},s=3,JSON.stringify(t,(e,t)=>!isNaN(t)&&null!=t&&t.toFixed?Number(null==t?void 0:t.toFixed(s)):t)}`,G.FailedDemuxerSanityCheck)}(p,e,g.iframeMediaStart,this.config.audioPrimingDelay),{startPTS:t,endPTS:c,startDTS:i,endDTS:h,firstKeyframePts:r,framesWithoutIDR:n,largestVideoSampleSize:a,dropped:s,data1:o,data2:l,captionData:d,id3Samples:u,parsedInitSegment:f}})),d.event(N.INTERNAL_ERROR).pipe(on(this.handleError)),e.push(g.segment,s,g.initSegment,o,r,i,t,g.totalDuration,n,a,g.iframeMediaStart,g.iframeDuration).pipe(ln(Cr))).pipe(vr(),kr(1))}))}reset(e=void 0){if(null==e)return this.demuxers.forEach(e=>{e&&e.destroy()}),void(this.demuxers=[]);const t=this.demuxers[e];null==t||t.destroy(),this.demuxers[e]=null}willBeTrackSwitch(e,t){var{mediaOptionType:i,mediaOptionId:e}=e,i=(t||this.lastFrags)[i];return!(i&&i.mediaOptionId===e)}getDemuxerInfo(e,r,t,i){const{frag:n,ptsKnown:a,seeking:s,live:o}=e,{discoSeqNum:l,mediaSeqNum:d,mediaOptionType:u}=n;return Pn(()=>{var e=this.demuxers[u];return e?Pr(e):i.init(this.typeSupported,this.config,t).pipe(cn(e=>this.demuxers[u]=e))}).pipe(sr(e=>{var t=r[u],i=this.willBeTrackSwitch(n,r);return{demuxer:e,trackSwitch:i,discontinuity:!(t&&l===t.discoSeqNum),contiguous:!!t&&!i&&t.mediaSeqNum+1===d,accurateTimeOffset:!s&&(a||!o)}}))}handleInitSegmentData(e){var t=e["track"],i=t["initSegment"],r=$e.parseInitSegment(i,this.logger),{mimeType:n,type:a,codec:s,container:e}=Cy(r,t.container);return{moovData:r,mimeType:n,track:Object.assign(Object.assign({},t),{type:a,codec:s,initSegment:i,container:e})}}handleError(e){return Lr(e)}}function My(e,t,i,r,n){const a=t.responseURL;a||(t.responseURL=e);const s=r["keySystemPreference"],{responseText:o,responseURL:l,stats:d}=t,{itemId:u,appItemId:c,itemStartOffsets:h,isInterstitial:p,parentItemId:m}=i,f=Ao(i),g=Object.assign(Object.assign({},d),{tparsed:{tbegin:NaN,tend:NaN},tfiltered:NaN});if(ug.isMediaPlaylist(o)){const t="media-pl-"+ba(),y=performance.now(),d=ug.parseMediaOptionPlaylist(o,a,s||null,{},u,t,Ys.Variant,n,h[Ys.Variant]),p=performance.now();i=[],i=_p(d.mediaOptionDetails,u,r);Jo(d.mediaOptionDetails);e={itemId:u,mediaOptionId:t,mediaOptionType:Ys.Variant,url:e,relativeUrl:e,bandwidth:0,bitrate:0,iframes:d.mediaOptionDetails.iframesOnly,pathwayID:"."};return g.tparsed={tbegin:y,tend:p},{parentItemId:m,itemId:u,statsId:f,appItemId:c,itemStartOffsets:h,rootMediaOptionsTuple:[[e],[],[]],stats:g,interstitials:i,baseUrl:l,initialDetails:d.mediaOptionDetails,isMediaPlaylist:!0}}{const v=performance.now(),t=ug.parseSessionData(o,l,n),y=ug.parseSessionKeys(o,l,null!=s?s:null),r=ug.parseRootPlaylistWithAlternates(u,o,l,p),a=performance.now(),{variantMediaOptions:d,contentSteeringOption:S,masterVariableList:I,startTimeOffset:b}=r,{audioAlternateOptions:T,subtitleAlternateOptions:E,audioMediaSelectionGroup:A,subtitleMediaSelectionGroup:O}=r.alternateMediaInfo;return g.tparsed={tbegin:v,tend:a},{parentItemId:m,itemId:u,statsId:f,appItemId:c,itemStartOffsets:h,interstitials:[],rootMediaOptionsTuple:[d.reverse(),null!=T?T:[],null!=E?E:[]],stats:g,baseUrl:l,audioMediaSelectionGroup:A,subtitleMediaSelectionGroup:O,contentSteeringOption:null!=S?S:void 0,sessionData:t,sessionKeys:y,masterVariableList:I,startTimeOffset:b}}}function Py(e,t,i,r){if(200===t&&r&&10<r.length){if(ug.isValidPlaylist(r))return!0;{const t=new $(U.NETWORK_ERROR,V.MANIFEST_PARSING_ERROR,!0,"response doesnt have #EXTM3U tag",G.PlaylistErrorMissingEXTM3U);throw t.url=e,t}}return!1}function Ly(){const o=new Map,l=navigator&&navigator.mediaCapabilities;return(i,e,t,r,n)=>{const a={type:"media-source"};r?a.video=function(e){const t={contentType:`video/mp4;codecs=${e}`,width:i.width,height:i.height,bitrate:i.bandwidth||i.avgBandwidth,framerate:i.iframes?8:i.frameRate};if(i.videoRange)switch(i.videoRange){case"PQ":Re.isDolby(e)?(t.hdrMetadataType=gy.DoVi,t.colorGamut="rec2020"):(Re.isHEVC(e)||Re.isVP09(e)||Re.isAV1(e))&&(t.hdrMetadataType=gy.HDR10,t.colorGamut="rec2020"),t.transferFunction="pq";break;case"HLG":t.colorGamut="rec2020",t.transferFunction="hlg"}return t}(t):a.audio=function(e,t){const i={contentType:`audio/mp4;codecs=${e}`},r=lh.getRichestChannelLayoutForGroupId(t.audioAlternates);return r&&(i.channels=Re.getChannelCount(r).toString(),i.spatialRendering=Re.isDolbyAtmos(e,r)),i}(t,i);t=JSON.stringify(a);let s;return o.has(t)?s=o.get(t):(s=ar(l&&"function"==typeof l.decodingInfo?l.decodingInfo(a):[void 0]).pipe(sr(e=>!e||e.supported&&(!r||e.powerEfficient))),o.set(t,s)),[...n,s]}}function xy(e){return e.filter(e=>!e.iframes||!e.width||!e.height||e.width*e.height<=2488320)}function Dy(e,t){const i=Ec(t),{doViSupported:r,hdr10Supported:n,hlgSupported:a}=i,s=e.reduce((e,t)=>{var i;switch(Re.getDynamicRangeType(t.videoRange,null!==(i=t.videoCodec)&&void 0!==i?i:"")){case pe.HDR:case pe.HDR10:n&&e.hdrMediaOptions.push(t);break;case pe.DolbyVision:r&&e.hdrMediaOptions.push(t);break;case pe.HLG:a&&e.hdrMediaOptions.push(t);break;default:"SDR"!==t.videoRange&&null!=t.videoRange||e.sdrMediaOptions.push(t)}return e},{hdrMediaOptions:new Array,sdrMediaOptions:new Array});return s}function _y(e){var t=navigator&&navigator.mediaCapabilities;return(e=e||!1)&&t&&"function"==typeof t.decodingInfo}function Ny(e,t,o,d,l,i,u,r){if(u.enableBoss&&i)return n=e,y=t,a=o,s=d,c=l,h=i,m=r,e=_y(null==(p=u)?void 0:p.useMediaCapabilities),i=null==p?void 0:p.keySystemPreference,i=null!=p&&p.useMediaKeySystemAccessFilter&&i&&navigator&&"function"==typeof navigator.requestMediaKeySystemAccess?function(e,i,s){const o=new Map;if(!i)return Pr(null);const r=new Array;return e.forEach(e=>{var t=Array();!function(e,t,i){const r=Gl(t.videoCodecList,t.audioCodecList),n=JSON.stringify(r);let a=Pr(null);o.has(n)||(o.set(n,!1),a=Md.requestKeySystemAccess(e,r,void 0,s).pipe(sr(()=>(o.set(n,!0),null)),Wi(e=>Pr(null)))),i.push(a)}(i,e,t);t=Ln(t);r.push(t)}),Ln(r).pipe(sr(e=>o))}(y,null==p?void 0:p.keySystemPreference,m):Pr(null),y=e?function(e,s){const o=[],l=new Map,d=Ic(),u=Ly();return e.forEach(t=>{var e;let i=[];const r=[];if(null===(e=t.videoCodecList)||void 0===e||e.forEach(e=>{r.push(e),i=u(t,s,e,!0,i)}),0<(null===(e=t.audioCodecList)||void 0===e?void 0:e.length)){const a=lh.getRichestAudioCodec([...t.audioCodecList]);r.push(a),i=u(t,s,a,!1,i)}let n=Pr(t);0<i.length&&(n=Ln(i).pipe(sr(e=>null==e.find(e=>!1===e)?(l.set(r.join(","),!0),t):(l.set(r.join(","),!1),null)),Wi(e=>d(t)?(l.set(r.join(","),!0),Pr(t)):(l.set(r.join(","),!1),null)))),o.push(n)}),Ln(o).pipe(sr(e=>l))}(y,a):Pr(null),Ln([i,y]).pipe(sr(([e,t])=>function(e,t,i,r,n,a,s,o,l){const d=i.getQuery(e,n),u=(null==r?void 0:r.useMediaKeySystemAccessFilter)||!1,c=()=>u&&(null==r?void 0:r.keySystemPreference)&&navigator&&"function"==typeof navigator.requestMediaKeySystemAccess,h=new Map([[io.MediaFilteringBasedOnConfig,new Sh(r.disableVideoCodecList,r.disableAudioCodecList)],[io.MediaFilteringBasedOnMaxAllowedHdcpLevel,new Ih((null==t?void 0:t.maxHdcpLevel)||void 0,n)],[io.MediaFilteringBasedOnSecurityLevel,new bh(null==t?void 0:t.maxSecurityLevel,null==r?void 0:r.keySystemPreference,n)],[io.MediaFilteringBasedOnKeySystemMediaCapabilities,new Th(a,c(),n)],[io.MediaFilterBasedOnCaps,new kh(o,t,n)],[io.MediaIframeFilterBasedOnCapsOn1080p,new Ch],[io.MediaFilteringBasedOnSupportedVideoFormats,new Ah((null==t?void 0:t.videoDynamicRangeFormats)||[],_y(null==r?void 0:r.useMediaCapabilities),n)]]);_y.bind(void 0,null==r?void 0:r.useMediaCapabilities)()?h.set(io.MediaFilteringBasedOnSystemMediaCapabilities,new Eh(s)):(h.set(io.MediaFilteringBasedOnAudioAndVideoCodecs,new wh(n)),h.set(io.MediaFilteringBasedOnExtendedAudioParameters,new Rh(l,n))),i.setMultipleTransformers(e,h);l=d.variantsFor(ro.PlatformFiltering),n=new Map([[io.MediaFilteringBasedOnConfig,new Sh(r.disableVideoCodecList,r.disableAudioCodecList)],[io.MediaFilteringBasedOnMaxAllowedHdcpLevel,new Ih((null==t?void 0:t.maxHdcpLevel)||void 0,n)],[io.MediaFilteringBasedOnSecurityLevel,new bh(null==t?void 0:t.maxSecurityLevel,null==r?void 0:r.keySystemPreference,n)],[io.MediaFilteringBasedOnKeySystemMediaCapabilities,new Th(a,c(),n)],[io.MediaFilteringBasedOnImageIframes,new Oh(n)],[io.MediaIframeFilterBasedOnCapsOn1080p,new Ch]]);i.setMultipleTransformers(e,n);n=d.variantsFor(ro.ImageVariant);let p=(null==t?void 0:t.videoDynamicRangeFormats)||[];_y(null==r?void 0:r.useMediaCapabilities)&&0===p.length&&(p=[{type:pe.SDR},{type:pe.HDR},{type:pe.HDR10},{type:pe.DolbyVision},{type:pe.HLG}]);var{hdrMediaOptions:t,sdrMediaOptions:l}=Dy(l,p);return{hdrMediaOptions:t,sdrMediaOptions:l,imageIframeVariants:n}}(n,c,h,p,m,e,t,s,a)),Wi(e=>{throw e instanceof $&&(e.fatal=!0,e.response=G.IncompatibleAsset),e}));var n,a,s,c,h,p,m,f=(null==l?void 0:l.maxHdcpLevel)||void 0;let g=[...t];(0<u.disableVideoCodecList.size||0<u.disableAudioCodecList.size)&&(g=function(e,t,i){let r=e.filter(e=>!e.videoCodec||e.videoCodecList.every(e=>{e=rh(e);return!t.has(e)}));return r=r.filter(e=>!(!e.iframes&&e.audioCodec)||e.audioCodecList.every(e=>{e=ah(e);return!i.has(e)})),r}(g,u.disableVideoCodecList,u.disableAudioCodecList)),f&&th(f)&&(g=function(e){const t=ih(f);return e.filter(e=>{e=e.hdcpLevel;return!e||ih(e)<=t})}(g));var y=null==l?void 0:l.maxSecurityLevel,t=null==u?void 0:u.keySystemPreference;return y&&t&&Ac(y,t)&&(g=function(e,t,i){function r(e){return Ac(e,i)?n[e]:-1}const n=Md.getKeySystemSecurityLevel(i),a=Md.getKeySystemFormat(i),s=r(t),o=e.filter(e=>{e=null!==(e=null===(e=e.allowedCPCMap)||void 0===e?void 0:e[a])&&void 0!==e?e:[];let t=!0;for(const i of e)if(t=r(i)<=s,!t)break;return t});return[...o]}(g,y,t)),(null!=u&&u.useMediaKeySystemAccessFilter&&t&&navigator&&"function"==typeof navigator.requestMediaKeySystemAccess?function(e,i,a){const s=new Map,r=new Array;return e.forEach(t=>{var e=Array();!function(e,t,i){var r=Gl(t.videoCodecList,t.audioCodecList),t=JSON.stringify(r);let n;s.has(t)?n=s.get(t):(n=Md.requestKeySystemAccess(e,r,void 0,a).pipe(sr(()=>!0),Wi(e=>Pr(!1)),nn({bufferSize:1,refCount:!0})),s.set(t,n)),i.push(n)}(i,t,e);e=Ln(e).pipe(sr(e=>{if(void 0===e.find(e=>!1===e))return t}));r.push(e)}),Ln(r).pipe(sr(e=>e.filter(e=>Boolean(e))))}(g,t,r):Pr(g)).pipe(on(e=>{if(0===e.length||Rc(e))throw new $(U.MEDIA_ERROR,V.MANIFEST_INCOMPATIBLE_CODECS_ERROR,!0,"no media option with key system access found in playlist",G.UnsupportedKeySystemAccess);let r=g.filter(e=>e.iframes&&e.imageCodec);const t=navigator&&navigator.mediaCapabilities,n=!(null==u||!u.useMediaCapabilities)&&t&&"function"==typeof t.decodingInfo;let i;return i=n?function(e,a){const s=[],o=Ic(),l=Ly();return e.forEach(t=>{var e;if(!o(t))return Pr(null);let i=[];if(null===(e=t.videoCodecList)||void 0===e||e.forEach(e=>{i=l(t,a,e,!0,i)}),0<(null===(e=t.audioCodecList)||void 0===e?void 0:e.length)){const n=lh.getRichestAudioCodec([...t.audioCodecList]);i=l(t,a,n,!1,i)}let r=Pr(t);0<i.length&&(r=Ln(i).pipe(sr(e=>null==e.find(e=>!1===e)?t:null),Wi(e=>Pr(null)))),s.push(r)}),Ln(s).pipe(sr(e=>e.filter(e=>Boolean(e))))}(e,o):(a=e,s=Ic(),Pr(e=function(e){const o=new Set,l=new Set,d=!MediaSource.isTypeSupported('audio/mp4; codecs="mp4a.40.2"; channels="-1"'),u=d&&!MediaSource.isTypeSupported('audio/mp4; codecs="mp4a.40.2"; channels="2"; features="INVALID"');return e.filter(e=>{let t=!1;var i;return e.audioCodecList&&e.audioAlternates&&(i=lh.getRichestChannelLayoutForGroupId(e.audioAlternates),0<e.audioCodecList.length&&i&&(t=((e,t)=>{var i,r,n,a=Re.isDolbyAtmos(e,t);if(u||d&&!a){n=`${i=e}/${r=t}`,o.has(n)||l.has(n)||(((e,t)=>{const i=t.split("/"),r=parseInt(i[0]);let n,a;if(1<i.length){const t=i[1].split(",")[0];n=`audio/mp4;codecs="${e}";channels="${r}";features="${t}"`,a=`audio/mp4;codecs="${e}";channels="8";features="${t}"`}else n=`audio/mp4;codecs="${e}";channels="${r}"`;let s=MediaSource.isTypeSupported(n);return!s&&a&&(s=MediaSource.isTypeSupported(a)),s})(i,r)?o:l).add(n);const s=`${e}/${t}`;return l.has(s)}return!!a})(lh.getRichestAudioCodec(e.audioCodecList),i))),!t})}(e=a.filter(s)))),i.pipe(sr(e=>{if(0===e.length||Rc(e))throw new $(U.MEDIA_ERROR,V.MANIFEST_INCOMPATIBLE_CODECS_ERROR,!0,"no media option with compatible codecs found in manifest",G.UnsupportedMediaCodec);if(e=xy(e=function(e,o){const l=0<(null==d?void 0:d.length);return e.filter(e=>{var t=Tc(e,o),{highestPlayablePeakBitRateForClearContent:i,highestPlayablePeakBitRate:r,highestPlayableAverageBitRate:n}=t,a=e.frameRate,s=wc(n,a),n=wc(r,a),r=wc(i,a),a=e.allowedCPCMap||l,n=Oc(e.bandwidth,n);return(a||!i?n:n||Oc(e.bandwidth,r))&&Oc(e.avgBandwidth,s)&&Oc(e.width,t.highestPlayableWidth)&&Oc(e.height,t.highestPlayableHeight)&&Oc(e.frameRate,t.highestPlayableFrameRate)})}(e,l)),r=xy(r),0===e.length||Rc(e))throw new $(U.MEDIA_ERROR,V.MANIFEST_INCOMPATIBLE_CODECS_ERROR,!0,"no media option within platform/config caps found in manifest",G.FilterOutBasedOnCaps);let t=(null==l?void 0:l.videoDynamicRangeFormats)||[];n&&0===t.length&&(t=[{type:pe.SDR},{type:pe.HDR},{type:pe.HDR10},{type:pe.DolbyVision},{type:pe.HLG}]);var{hdrMediaOptions:i,sdrMediaOptions:e}=Dy(e,t);if(0===i.length&&0===e.length||Rc(i)&&Rc(e))throw new $(U.MEDIA_ERROR,V.MANIFEST_INCOMPATIBLE_VIDEO_RANGE_ERROR,!0,"mediaOption with compatible VIDEO-RANGE not found in manifest",G.UnsupportedVideoDynamicRange);return{hdrMediaOptions:i,sdrMediaOptions:e,imageIframeVariants:r}}),Wi(e=>{throw e instanceof $&&(e.fatal=!0,e.response=G.IncompatibleAsset),e}));var a,s}))}(vy=gy=gy||{}).HDR10="smpteSt2086",vy.DoVi="smpteSt2094-10",vy.HDR10Plus="smpteSt2094-40";class Fy extends Tf{constructor(e,t,i,r,n){super(e,t,i),this.codecConfig=r,this.logger=n}static makeFilters(){return bf()}_initFilters(){return Fy.kAllowFilters}get _mediaOptionType(){return this.mediaOptionType}get mediaOptionListInfo(){var e;return null!==(e=null===(e=this.getEntity(this.itemId))||void 0===e?void 0:e.mediaOptionListTuple[this._mediaOptionType])&&void 0!==e?e:null}get mediaOptionListInfo$(){return this.selectEntity(this.itemId,e=>e&&e.mediaOptionListTuple?e.mediaOptionListTuple[this._mediaOptionType]:null).pipe(_d())}getMatchingAlternateWithPersistentId(e,i,t,r,n){if(!t)return null;const a=this._mediaOptionType,s=hc(a===Ys.AltAudio?t.audioAlternates:t.subtitleAlternates,Fy.kAllowFilters,this.mediaOptionListInfo);if(a===Ys.Subtitle||n)return null!==(n=s.find((e,t)=>!(0<(null==r?void 0:r.length)&&r.includes(e.mediaOptionId)||z(i)&&e.persistentID!==i)))&&void 0!==n?n:null;const o=Re.getStickyAtmosStatus(this.codecConfig.useStickyAtmosFilter,t.audioCodec,null==e?void 0:e.channels);let l=null;e=null!==(e=s.find((e,t)=>!(0<(null==r?void 0:r.length)&&r.includes(e.mediaOptionId)||z(i)&&e.persistentID!==i||(l=l||e,null!=o&&o!==Re.isJOCChannels(e.channels)))))&&void 0!==e?e:null;return!e&&o?l:e}getMatchingAlternate(e,t){e=this.mediaOptionFromId(e);return this.getMatchingAlternateWithPersistentId(e,null==e?void 0:e.persistentID,t,[],!1)}packageAlternateMediaOption(e,t){var i=null!==(i=null===(i=this.getEntity(this.itemId))||void 0===i?void 0:i.mediaOptionListTuple[Ys.Subtitle])&&void 0!==i?i:null,i=hc(null!==(e=null==e?void 0:e.subtitleAlternates)&&void 0!==e?e:[],Fy.kAllowFilters,i);return t.mediaType===eo.CLOSEDCAPTION?this.augmentClosedCaptionsWithForcedSubtitles(i,t):t}augmentClosedCaptionsWithForcedSubtitles(e,t){e=this.pairForcedSubtitleMediaOptionWithClosedCaption(t,e);return e?Object.assign(Object.assign({},t),{url:e.url,relativeUrl:e.relativeUrl,backingMediaOptionId:e.mediaOptionId}):t}pairForcedSubtitleMediaOptionWithClosedCaption(e,t){let i;return e&&e.mediaType===eo.CLOSEDCAPTION&&(i=Fy.pairForcedSubtitleMediaOptionWithClosedCaptionInList(e,t,this.logger)),i}static pairForcedSubtitleMediaOptionWithClosedCaptionInList(t,e,i){return e.find(function(e){return e.mediaType===eo.SUBTITLE&&e.lang===t.lang&&e.forced&&e.autoselect})}}Fy.kAllowFilters=Fy.makeFilters();class By extends dh{constructor(e){super(),this.pathwayPriority=e,this.name="PathwayFilter",this.initFn=e=>({pathwayRanking:Mc(this.pathwayPriority)}),this.firstPassFn=(e,t,i,r)=>{var n=r.pathwayRanking(e.pathwayID);(null==r.selectedPathwayRanking||n>r.selectedPathwayRanking)&&(r.selectedPathway=e.pathwayID,r.selectedPathwayRanking=n)},this.filterFn=(e,t,i,r)=>e.pathwayID===r.selectedPathway}get id(){return io.PathwayFilter}get desc(){return`pathwayPriority: ${JSON.stringify(this.pathwayPriority)}`}}class Uy extends Sa{constructor(e,t,i,r){super(e),this._rootPlaylistStore=e,this.itemId=t,this.logger=r,this.mediaOptionListQueries=[new wf(e,this.itemId),new Fy(e,this.itemId,Ys.AltAudio,i,this.logger),new Fy(e,this.itemId,Ys.Subtitle,i,this.logger)]}get rootPlaylistEntity(){return this.getEntity(this.itemId)}get parentItemId(){var e;return null===(e=this.rootPlaylistEntity)||void 0===e?void 0:e.parentItemId}get statsId(){var e;return null===(e=this.rootPlaylistEntity)||void 0===e?void 0:e.statsId}get appItemId(){var e;return null===(e=this.rootPlaylistEntity)||void 0===e?void 0:e.appItemId}get rootMediaOptionsTuple(){var e=null===(e=this.rootPlaylistEntity)||void 0===e?void 0:e.mediaOptionListTuple;return e?[e[0].mediaOptions,e[1].mediaOptions,e[2].mediaOptions]:[[],[],[]]}get itemStartOffsets(){var e;return null!==(e=this.rootPlaylistEntity)&&void 0!==e&&e.itemStartOffsets?this.rootPlaylistEntity.itemStartOffsets.map(e=>z(e)?e:0):[0,0]}get itemStartPosition(){return this.itemStartOffsets[0]}get startTimeOffset(){var e;return null===(e=this.rootPlaylistEntity)||void 0===e?void 0:e.startTimeOffset}get highestVideoCodec(){var e;return null===(e=this.rootPlaylistEntity)||void 0===e?void 0:e.highestVideoCodec}get baseUrl(){var e;return null===(e=this.rootPlaylistEntity)||void 0===e?void 0:e.baseUrl}get avAnchor(){var e;return null===(e=this.rootPlaylistEntity)||void 0===e?void 0:e.avAnchor}get audioMediaSelectionGroup(){var e;return null!==(e=null===(e=this.rootPlaylistEntity)||void 0===e?void 0:e.audioMediaSelectionGroup)&&void 0!==e?e:null}get subtitleMediaSelectionGroup(){var e;return null!==(e=null===(e=this.rootPlaylistEntity)||void 0===e?void 0:e.subtitleMediaSelectionGroup)&&void 0!==e?e:null}get audioMediaSelectionOptions(){var e;return null!==(e=null===(e=null===(e=this.rootPlaylistEntity)||void 0===e?void 0:e.audioMediaSelectionGroup)||void 0===e?void 0:e.MediaSelectionGroupOptions)&&void 0!==e?e:[]}get subtitleMediaSelectionOptions(){var e;return null!==(e=null===(e=null===(e=this.rootPlaylistEntity)||void 0===e?void 0:e.subtitleMediaSelectionGroup)||void 0===e?void 0:e.MediaSelectionGroupOptions)&&void 0!==e?e:[]}get contentSteeringOption(){var e;return null===(e=this.rootPlaylistEntity)||void 0===e?void 0:e.contentSteeringOption}get masterVariableList(){var e;return null===(e=this.rootPlaylistEntity)||void 0===e?void 0:e.masterVariableList}get loadStats(){var e;return null===(e=this.rootPlaylistEntity)||void 0===e?void 0:e.loadStats}get isMediaPlaylist(){var e;return null===(e=this.rootPlaylistEntity)||void 0===e?void 0:e.isMediaPlaylist}getInitPTS(e){var t;return null===(t=this.rootPlaylistEntity)||void 0===t?void 0:t.initPtsRecord[e]}get abrStatus$(){return this.selectEntity(this.itemId,e=>null==e?void 0:e.abrStatus)}get abrStatus(){var e;return null===(e=this.rootPlaylistEntity)||void 0===e?void 0:e.abrStatus}get nextMaxAutoOptionId(){var e;return null===(e=null===(e=this.rootPlaylistEntity)||void 0===e?void 0:e.abrStatus)||void 0===e?void 0:e.nextMaxAutoOptionId}get nextMinAutoOptionId(){var e;return null===(e=null===(e=this.rootPlaylistEntity)||void 0===e?void 0:e.abrStatus)||void 0===e?void 0:e.nextMinAutoOptionId}initPTS$(t){return this.selectEntity(this.itemId,({initPtsRecord:e})=>e[t])}get rootPlaylistEntity$(){return this.selectEntity(this.itemId).pipe(_r(e=>Boolean(e)),sr(e=>e))}get rootPlaylistEntityAdded$(){return this.selectEntityAction(jn.Add).pipe(sr(e=>e.map(e=>this.getEntity(e))))}get rootMediaOptionsTuple$(){return this.selectEntity(this.itemId,e=>[e.mediaOptionListTuple[0].mediaOptions,e.mediaOptionListTuple[1].mediaOptions,e.mediaOptionListTuple[2].mediaOptions])}get sessionData(){var e;return null===(e=this.rootPlaylistEntity)||void 0===e?void 0:e.sessionData}get sessionData$(){return this.selectEntity(this.itemId,({sessionData:e})=>e).pipe(_d())}get avAnchor$(){return this.selectEntity(this.itemId,"avAnchor")}get enabledMediaOptionKeys$(){return this.selectEntity(this.itemId,"enabledMediaOptionKeys").pipe(_r(e=>Boolean(e)))}get enabledMediaOptionKeys(){var e;return null!==(e=null===(e=this.getEntity(this.itemId))||void 0===e?void 0:e.enabledMediaOptionKeys)&&void 0!==e?e:[wo,wo,wo]}get enabledMediaOptionSwitchContexts(){var e;return null!==(e=null===(e=this.getEntity(this.itemId))||void 0===e?void 0:e.mediaOptionSwitchContexts)&&void 0!==e?e:[null,null,null]}get enabledMediaOptions$(){return ur([this.enabledMediaOptionByType$(Ys.Variant),this.enabledMediaOptionByType$(Ys.AltAudio),this.enabledMediaOptionByType$(Ys.Subtitle)])}rawEnabledMediaOptionByType$(t){return this.selectEntity(this.itemId,e=>null==e?void 0:e.enabledMediaOptionKeys[t]).pipe(_d(),sr(e=>{if(!Ro(e))return wo;var e=this.enabledMediaOptionKeys[t]["mediaOptionId"];return null!==(e=this.mediaOptionListQueries[t].mediaOptionFromId(e))&&void 0!==e?e:wo}))}enabledMediaOptionByType$(e){return this.rawEnabledMediaOptionByType$(e).pipe(xr((e,t)=>e.mediaOptionId===t.mediaOptionId&&e.relativeUrl===t.relativeUrl))}enabledMediaOptionSwitchForType$(r){return this.rawEnabledMediaOptionByType$(r).pipe(sn(null),Vr(),sr(([e,t])=>{var i=null===(i=this.enabledMediaOptionSwitchContexts)||void 0===i?void 0:i[r];return{fromId:null==e?void 0:e.mediaOptionId,toId:null==t?void 0:t.mediaOptionId,switchContext:i}}),xr((e,t)=>e.fromId===t.fromId&&e.toId===t.toId))}enabledMediaOptionsSwitchInfo$(e){const t=this.hasAlternateWithUrl(Ys.AltAudio),i=ur(Lo.map(e=>e!==Ys.AltAudio||t?this.enabledMediaOptionSwitchForType$(e).pipe():Pr({fromId:void 0,toId:Oo.mediaOptionId,switchContext:void 0})));return t?i.pipe(qi(0)):i}enabledMediaOptionIdByType(e){return this.getEntity(this.itemId).enabledMediaOptionKeys[e].mediaOptionId}get enabledMediaOptionsBeforeTrickplay(){return this.getEntity(this.itemId).enabledMediaOptionsBeforeTrickplay}variantMediaOptionById(e){return this.mediaOptionListQueries[Ys.Variant].mediaOptionFromId(e)}alternateMediaOptionById(e,t){return this.mediaOptionListQueries[e].mediaOptionFromId(t)}enabledAlternateMediaOptionByType(e){var t=this.enabledMediaOptionIdByType(e);return this.alternateMediaOptionById(e,t)}get enabledVariantMediaOption(){var e=this.enabledMediaOptionIdByType(Ys.Variant);return this.variantMediaOptionById(e)}get enabledVariantMediaOption$(){return this.enabledMediaOptionKeys$.pipe(sr(e=>{var t,e=e[Ys.Variant];return Ro(e)&&null!==(t=this.mediaOptionListQueries[Ys.Variant].mediaOptionFromId(e.mediaOptionId))&&void 0!==t?t:wo}))}lastLoadedMediaOptionByType(e){var t;return null===(t=this.getEntity(this.itemId).lastLoadedMediaOptionKeys)||void 0===t?void 0:t[e]}lastLoadedMediaOptionByType$(t){return this.selectEntity(this.itemId).pipe(_d(),sr(e=>e.lastLoadedMediaOptionKeys),_d(),sr(e=>e[t]))}get nextMediaOptionsKeys$(){return this.selectEntity(this.itemId,"nextMediaOptionKeys")}get filteredMediaOptions$(){return ur([this.mediaOptionListQueries[0].getFilteredMediaOptionList$(),this.mediaOptionListQueries[1].getFilteredMediaOptionList$(),this.mediaOptionListQueries[2].getFilteredMediaOptionList$()])}getDisabledMediaOption(e){return{itemId:this.itemId,mediaOptionType:e,mediaOptionId:"Nah",relativeUrl:void 0}}getEnabledMediaOptionMask(){return this.enabledMediaOptionKeys.map(e=>Ro(e))}get isInterstitial(){var e;return null!==(e=null===(e=this.getEntity(this.itemId))||void 0===e?void 0:e.isInterstitial)&&void 0!==e&&e}altMediaOptionHasValidUrl(e,t){return Co(this.alternateMediaOptionById(e,t))}hasAlternateWithUrl(e){return this.mediaOptionListQueries[e].hasOptionWithUrl}hasClosedCaption(){return!!this.rootMediaOptionsTuple[Ys.Subtitle].some(e=>e.mediaType===eo.CLOSEDCAPTION)}get hdrMode$(){return this.mediaOptionListQueries[Ys.Variant].hdrMode$}get pathwayPenaltyBox$(){return this.mediaOptionListQueries[Ys.Variant].pathwayPenaltyBoxChanged$}get viewportInfo$(){return this.mediaOptionListQueries[Ys.Variant].viewportInfo$}get variantRemoved$(){return this.mediaOptionListQueries[Ys.Variant].removedListChanged$}get variantCompatibleIds$(){return this.mediaOptionListQueries[Ys.Variant].compatibleIdsListChanged$}get variantPenaltyBox$(){return this.mediaOptionListQueries[Ys.Variant].penaltyBoxChanged$}get combinedVariantFilterChange$(){return this.mediaOptionListQueries[Ys.Variant].commonFilterParamChanges$}get combinedAltAudioFilterChange$(){return this.mediaOptionListQueries[Ys.AltAudio].commonFilterParamChanges$}get combinedSubtitleFilterChange$(){return this.mediaOptionListQueries[Ys.Subtitle].commonFilterParamChanges$}get maxHdcpLevel$(){return this.mediaOptionListQueries[Ys.Variant].maxHdcpLevel$}get currentPathwayID(){var e;return null===(e=this.enabledVariantMediaOption)||void 0===e?void 0:e.pathwayID}get currentPathwayID$(){return this.enabledVariantMediaOption$.pipe((i="pathwayID",xr(function(e,t){return e[i]===t[i]})),sr(e=>e.pathwayID));var i}getErrorInfoByType(e){var t;return null===(t=null===(t=this.rootPlaylistEntity)||void 0===t?void 0:t.errorsByType)||void 0===t?void 0:t[e]}getInFlightFrags(){return[this._rootPlaylistStore.inFlightFragTuple[0].value,this._rootPlaylistStore.inFlightFragTuple[1].value]}getInFlightFragByType(e){var t;return e!==Ys.Subtitle&&null!==(t=this.getInFlightFrags()[e])&&void 0!==t?t:null}getInFlightFragByType$(e){return e===Ys.Subtitle?Xl:this._rootPlaylistStore.inFlightFragTuple[e]}matchAlternates(e,t,i,r){var n=this.enabledAlternateMediaOptionByType(Ys.AltAudio),a=(null==n?void 0:n.persistentID)!==t,t=z(t)?this.mediaOptionListQueries[Ys.AltAudio].getMatchingAlternateWithPersistentId(n,t,e,r,a):void 0,a=this.enabledAlternateMediaOptionByType(Ys.Subtitle),r=z(i)?this.mediaOptionListQueries[Ys.Subtitle].getMatchingAlternateWithPersistentId(a,i,e,r,!1):void 0;return[t||wo,r||wo]}getLegacyMatchingAlternateWithPersistentId(e,t,i){var r=this.enabledAlternateMediaOptionByType(e),n=e===Ys.AltAudio&&(null==r?void 0:r.persistentID)!==t;let a=this.mediaOptionListQueries[e].getMatchingAlternateWithPersistentId(r,t,i,[],n);return a=a||this.mediaOptionListQueries[e].getMatchingAlternateWithPersistentId(r,t,void 0,[],n),a}isValidMediaOptionTuple(i,e=void 0){const r=e||this.getEnabledMediaOptionMask();return[Ys.Variant,Ys.AltAudio,Ys.Subtitle].reduce((e,t)=>e&&r[t]===Ro(i[t]),!0)}matchGroup(e,t,i,r){let n=!1;switch(e.type){case"CLOSED-CAPTIONS":n=!r||e.groupId===r;break;case"SUBTITLES":n=!i||e.groupId===i;break;case"AUDIO":n=!t||e.groupId===t}return n}get preferHDR(){return this.mediaOptionListQueries[Ys.Variant].mediaOptionListInfo.preferHDR}get hasHdrLevels(){return this.mediaOptionListQueries[Ys.Variant].mediaOptionListInfo.hasHdrLevels}}class Vy extends pa{constructor(){super({},{name:"root-playlist-store",idKey:"itemId",producerFn:_s}),this.inFlightFragTuple=[new qr(void 0),new qr(void 0)]}setInFlightFrag(e,t){this.inFlightFragTuple[e].next(t)}}function $y(e,t){return null==e.url&&null!=e.relativeUrl&&(e.url=so(e.relativeUrl,t),e.relativeUrl=e.url),e.url}(vy=yy=yy||{})[vy.NoMatch=0]="NoMatch",vy[vy.BaseNameMatch=1]="BaseNameMatch",vy[vy.LanguageTagMatch=2]="LanguageTagMatch";class Qy{constructor(e,t,i,r,n,a,s){this.store=e,this.hlsService=t,this.logger=i,this.config=r,this.rtcService=n,this.statsService=a,this.mediaSelectionBossService=s,this.queryMap=new Map,this._query=new Sa(e)}isContentSteeringEnabled(){return this.config.enableContentSteering}get query(){return this._query}getQueryForId(e){let t=this.queryMap.get(e);return t||(t=new Uy(this.store,e,this.config,this.logger),this.queryMap.set(e,t)),t}removeItems(e){this.store.remove(e),Array.isArray(e)?e.forEach(e=>this.queryMap.delete(e)):this.queryMap.delete(e)}removeAll(){this.store.remove(),this.queryMap.clear()}setRootPlaylistEntity(e,t){da(()=>{this.store.replace(e,t),this.store.setActive(e)})}setActive(e){this.store.setActive(e)}setSessionData(e,t){this.store.update(e,e=>{e.sessionData=t})}setAVAnchor(e,t){this.store.update(e,e=>{e.avAnchor=t})}setEnabledMediaOptionSwitchContextByType(e,r,t,n){var i=this.getQueryForId(e);i.enabledMediaOptionKeys[r].mediaOptionId===t&&(i=null===(i=i.enabledMediaOptionSwitchContexts)||void 0===i?void 0:i[r],null==n&&null==i||this.store.update(e,e=>{var t;const i=null!==(t=e.mediaOptionSwitchContexts)&&void 0!==t?t:[null,null,null];i[r]=n?{userInitiated:n.userInitiated,switchPosition:n.switchPosition}:null,e.mediaOptionSwitchContexts=i}))}clearMediaOptionSwitchContextByType(e,t){var i;null!=(null===(i=null===(i=this._query.getEntity(e))||void 0===i?void 0:i.mediaOptionSwitchContexts)||void 0===i?void 0:i[t])&&this.store.update(e,e=>{e.mediaOptionSwitchContexts&&(e.mediaOptionSwitchContexts[t]=null)})}saveEnabledOptionsForTrickplay(e,t){this.store.update(e,e=>{e.enabledMediaOptionsBeforeTrickplay=t?e.enabledMediaOptionKeys:null})}setEnabledMediaOptionByType(r,n,a,s=!1,o=void 0){a=a||{itemId:r,mediaOptionId:"Nah"},this.store.update(r,e=>{var t;const i=null!==(t=[...e.enabledMediaOptionKeys])&&1?t:[wo,wo,wo];if(i[n]={itemId:r,mediaOptionId:a.mediaOptionId},this._updateEnabledMediaOptionKeys(e,i),s){const r=null!==(t=e.mediaOptionSwitchContexts)&&void 0!==t?t:[null,null,null];r[n]=o?{userInitiated:o.userInitiated,switchPosition:o.switchPosition,triggerEvent:o.triggerEvent}:null,e.mediaOptionSwitchContexts=r}})}_associateForcedSubtitleWithClosedCaption(e,t,i,r){if((null==i?void 0:i.mediaType)===eo.CLOSEDCAPTION){t=r.variantMediaOptionById(t),r=r.mediaOptionListQueries[Ys.Subtitle].packageAlternateMediaOption(t,i);if(r.relativeUrl!==i.relativeUrl){const n=Xy(t,r,e.mediaOptionListTuple[Ys.Subtitle].mediaOptions,this.logger);e.mediaOptionListTuple[Ys.Subtitle].mediaOptions=n}}}_updateEnabledMediaOptionKeys(e,i){var t,r,n;const a=null!==(t=e.enabledMediaOptionKeys)&&void 0!==t?t:[wo,wo,wo];let s;for(let t=0;t<i.length;++t){const o=i[t],l=a[t].mediaOptionId!==o.mediaOptionId;if(l){a[t]=Object.assign({},o);const i=e.mediaOptionListTuple[t].mediaOptions.find(e=>e.mediaOptionId===o.mediaOptionId);i&&$y(i,e.baseUrl)}const d=this.getQueryForId(o.itemId);if(t===Ys.Variant){const i=d.mediaOptionListQueries[t].mediaOptionList;if(l){const s=e.mediaOptionListTuple[Ys.Variant].mediaOptions.find(e=>e.mediaOptionId===a[t].mediaOptionId),u=e.mediaOptionListTuple[Ys.Variant],{mediaOptions:c,hasScore:h,pathwayPriority:p}=u,m=Of(c,{hasScore:h,pivotVariant:s,pathwayPriority:p,enableSteering:this.config.enableContentSteering,preferHostOverQuality:!0,preferCloseToPivotQuality:!1});m.some((e,t)=>c[t]!==e)&&(u.mediaOptions=m),e.abrStatus=(r=o.mediaOptionId,n=i,n=Bf(r,n),{fragDownloadSlow:!1,fragDownloadTooSlow:!1,nextMinAutoOptionId:wo.mediaOptionId,nextMaxAutoOptionId:wo.mediaOptionId,highBWTrigger:n})}else e.abrStatus.highBWTrigger=Bf(o.mediaOptionId,i);s=o}else if(t===Ys.Subtitle&&Ro(o)){const i=d.alternateMediaOptionById(t,o.mediaOptionId);this._associateForcedSubtitleWithClosedCaption(e,s.mediaOptionId,i,d)}}e.enabledMediaOptionKeys=a,e.nextMediaOptionKeys=void 0}setManualMode(e,t){this.store.update(e,e=>{e.manualMode=t})}setEnabledMediaOptions(e,i){this.store.update(e,e=>{var t=i.map(({mediaOptionId:e,itemId:t})=>({mediaOptionId:e,itemId:t}));this._updateEnabledMediaOptionKeys(e,t)})}setEnabledMediaOptionsAndSwitchContexts(e,i,r){this.store.update(e,e=>{var t=i.map(({mediaOptionId:e,itemId:t})=>({mediaOptionId:e,itemId:t}));this._updateEnabledMediaOptionKeys(e,t),e.mediaOptionSwitchContexts=r})}setNextMediaOptions(e,i){this.store.update(e,e=>{var t=i?i.map(({itemId:e,mediaOptionId:t})=>({itemId:e,mediaOptionId:t})):null;e.nextMediaOptionKeys=t})}updateEnabledMediaOptions(e){this.store.update(e,e=>{e.nextMediaOptionKeys&&!0!==e.manualMode&&this._updateEnabledMediaOptionKeys(e,[...e.nextMediaOptionKeys]),e.nextMediaOptionKeys=void 0})}setLastLoadedMediaOptionByType(r,n,a){a=a||{itemId:r,mediaOptionId:"Nah"},this.store.update(r,e=>{var t;const i=null!==(t=e.lastLoadedMediaOptionKeys)&&void 0!==t?t:[wo,wo,wo];i[n]={itemId:r,mediaOptionId:a.mediaOptionId},e.lastLoadedMediaOptionKeys=i})}setViewportInfo(e,t){this.store.update(e,e=>{e&&(e.mediaOptionListTuple[Ys.Variant].viewportInfo=t)})}static doUpdateRootHDRSwitch(e,t,i,r,n,a,s,o,l){const d=e.mediaOptionListTuple.map(e=>Object.assign({},e));d[Ys.Variant].preferHDR=a,d[Ys.Variant].hasHdrLevels=s;const u=t.query.getEntity(e.itemId),c=i.getQueryForId(e.statsId),h=c.getBandwidthEstimate(l,null==u?void 0:u.serviceName),p=c.getPlaylistEstimate(l,null==u?void 0:u.serviceName),m=c.getFragEstimate(l,null==u?void 0:u.serviceName),f=c.getBufferEstimate(l,null==u?void 0:u.serviceName),g={targetDuration:m.maxDurationSec||(null==l?void 0:l.defaultTargetDuration),targetStartupMs:null==l?void 0:l.targetStartupMs,enableBoss:l.enableBoss,enableContentSteering:l.enableContentSteering};return Jy(null,Object.assign(Object.assign({},e),{mediaOptionListTuple:d,nextMediaOptionKeys:null}),r,n,o,l,g,h,p,m,f)}switchToSDROnly(e,i){var t;if(this.config.enableBoss){const i=new Map([[io.HDRFilter,new mh(!1,!1)],[io.CompatibleIdsFilter,new ch(null)]]);null===(t=this.mediaSelectionBossService)||void 0===t||t.setMultipleTransformers(e,i)}this.store.update(e,e=>{var t=Qy.doUpdateRootHDRSwitch(e,i,this.statsService,this.mediaSelectionBossService,this.hlsService,!1,!1,this.logger,this.config)["mediaOptionListTuple"];e.mediaOptionListTuple=t})}doPathwaySwitch(e,t,i){const r=this.getQueryForId(e),n=r["rootPlaylistEntity"];if(n&&(t=t||n.mediaOptionListTuple[Ys.Variant].pathwayPriority)&&0<t.length){const a=this.statsService.getQueryForId(n.statsId);da(()=>{var e=Jy(null,Object.assign(Object.assign({},n),{mediaOptionListTuple:[Object.assign(Object.assign({},n.mediaOptionListTuple[Ys.Variant]),{pathwayPriority:t}),Object.assign(Object.assign({},n.mediaOptionListTuple[Ys.AltAudio]),{compatibleIds:null}),n.mediaOptionListTuple[Ys.Subtitle]]}),this.mediaSelectionBossService,this.hlsService,this.logger,this.config,{targetStartupMs:this.config.targetStartupMs,targetDuration:a.getFragEstimate().maxDurationSec,enableBoss:this.config.enableBoss,enableContentSteering:this.config.enableContentSteering},a.getBandwidthEstimate(),a.getPlaylistEstimate(),a.getFragEstimate(),a.getBufferEstimate(),i);this.setRootPlaylistEntity(r.itemId,e)})}}setHDRPreference(n,a,s,o){var e=null===(e=null===(e=this.getQueryForId(n))||void 0===e?void 0:e.mediaOptionListQueries[Ys.Variant])||void 0===e?void 0:e.mediaOptionListInfo;(null==e?void 0:e.preferHDR)===s||s&&!e.hasHdrLevels||this.store.update(n,e=>{var t,i=e.mediaOptionListTuple[Ys.Variant],r=new mh(i.hasHdrLevels,s);null===(t=this.mediaSelectionBossService)||void 0===t||t.setTransformer(n,io.HDRFilter,r);i=Qy.doUpdateRootHDRSwitch(e,a,this.statsService,this.mediaSelectionBossService,this.hlsService,s,i.hasHdrLevels,this.logger,this.config);if(o)return i;e.mediaOptionListTuple=i.mediaOptionListTuple})}setPathwayPriority(e,t){this.store.update(e,e=>{e&&(e.mediaOptionListTuple[Ys.Variant].pathwayPriority=t)})}setInitPTS(e,t,i,r,n,a){this.store.update(e,e=>{e.initPtsRecord[t]={variantDTS:i,timelineOffset:r,offsetTimestamp:n,iframeMode:a}})}static prunePenaltyBox(e,t){return e.filter(e=>!(e.expiry<=t))}static addToPenaltyBox(e,t,i,r=12e4){return e.push({id:i,expiry:t+r})}addToPenaltyBox(e,r,n){var t;if(this.store.update(e,({mediaOptionListTuple:e})=>{const t=e[r],i=performance.now();t.penaltyBoxQueue=Qy.prunePenaltyBox(t.penaltyBoxQueue,i),Qy.addToPenaltyBox(t.penaltyBoxQueue,i,n)}),this.config.enableBoss){const n=new hh([...this.getQueryForId(e).mediaOptionListQueries[r].mediaOptionListInfo.penaltyBoxQueue]);null===(t=this.mediaSelectionBossService)||void 0===t||t.setTransformer(e,io.PenaltyBoxFilter,n)}}addToPathwayPenaltyBox(e,i){this.store.update(e,({mediaOptionListTuple:e})=>{var t=e[Ys.Variant],e=performance.now();Qy.addToPenaltyBox(t.pathwayPenaltyBox,e,i.pathwayID,3e5)});var t=this.config.enableBoss,r=this.config.enableContentSteering;if(t&&r){const i=new ph(this.getQueryForId(e).mediaOptionListQueries[Ys.Variant].mediaOptionListInfo.pathwayPenaltyBox);null===(r=this.mediaSelectionBossService)||void 0===r||r.setTransformer(e,io.PathwayPenaltyBoxFilter,i)}}prunePathwayPenaltyBox(e){this.store.update(e,({mediaOptionListTuple:e})=>{const t=e[Ys.Variant],i=performance.now();t.pathwayPenaltyBox=Qy.prunePenaltyBox(t.pathwayPenaltyBox,i)})}prunePenaltyBox(e,r=null){this.store.update(e,({mediaOptionListTuple:e})=>{var e=r?[e[r]]:e,t=performance.now();for(const i of e)i.penaltyBoxQueue=Qy.prunePenaltyBox(i.penaltyBoxQueue,t)})}removePermanently(e,r,n){var t;if(this.store.update(e,({mediaOptionListTuple:e})=>{const t=e[r],i=new Set(t.removed);i.add(n),t.removed=Array.from(i)}),this.config.enableBoss){const n=new uh([...this.getQueryForId(e).mediaOptionListQueries[r].mediaOptionListInfo.removed]);null===(t=this.mediaSelectionBossService)||void 0===t||t.setTransformer(e,io.PermanentRemovalFilter,n)}}moveAllWithMatchingHosts(e,n,a,s){var t;if(this.store.update(e,({mediaOptionListTuple:e,baseUrl:t})=>{const i=e[n];i.mediaOptions.forEach(e=>{$y(e,t)});e=[...i.mediaOptions].filter(e=>ho(a,e)).map(e=>e.mediaOptionId);if(s){const r=new Set([...i.removed,...e]);i.removed=Array.from(r)}else{const r=performance.now();i.penaltyBoxQueue=Qy.prunePenaltyBox(i.penaltyBoxQueue,r);for(const n of e)Qy.addToPenaltyBox(i.penaltyBoxQueue,r,n)}}),this.config.enableBoss){const a=new hh([...this.getQueryForId(e).mediaOptionListQueries[n].mediaOptionListInfo.penaltyBoxQueue]);null===(t=this.mediaSelectionBossService)||void 0===t||t.setTransformer(e,io.PenaltyBoxFilter,a)}}setMaxHdcpLevel(e,i,r=!1){var t;this.store.update(e,({mediaOptionListTuple:e})=>{const t=e[Ys.Variant];(r||ih(i)<ih(t.maxHdcpLevel))&&(t.maxHdcpLevel=i)}),this.config.enableBoss&&(null===(t=this.mediaSelectionBossService)||void 0===t||t.setTransformer(e,io.HDCPFilter,new gh(i)))}updateConsecutiveTimeouts(e,i,r,n){var t=null===(t=null===(t=this.getQueryForId(e).getErrorInfoByType(i))||void 0===t?void 0:t.timeouts)||void 0===t?void 0:t[n];(r||0!==t&&null!=t)&&this.store.update(e,e=>{const t=e.errorsByType||[{timeouts:{load:0,append:0,key:0}},{timeouts:{load:0,append:0,key:0}},{timeouts:{load:0,append:0,key:0}}];r?++t[i].timeouts[n]:t[i].timeouts[n]=0,e.errorsByType=t})}updateInflightFrag(t,i,r,n,a,s){if(!(i===Ys.Subtitle||r&&r.itemId!==t)){var o=this.store.inFlightFragTuple[i].value;if(o||r){if(a&&null!=o&&o.bwSample){let e=Object.keys(a).length!==Object.keys(o.bwSample).length;if(!e)for(const[i,f]of Object.entries(o.bwSample))if(a[i]!==f){e=!0;break}if(!e)return}if(r){var{start:l,duration:d,mediaOptionId:u,mediaSeqNum:c,discoSeqNum:h,iframe:p,isLastFragment:m,mediaOptionType:r}=r;let e=null==o?void 0:o.tstart;n!==(null==o?void 0:o.state)&&(e=performance.now());s={itemId:t,mediaOptionId:u,mediaOptionType:r,mediaSeqNum:c,discoSeqNum:h,start:l,duration:d,tstart:e,state:n,iframe:p,isLastFragment:m,compatible:s,bwSample:a?Object.assign({},a):null};this.store.setInFlightFrag(i,s)}else this.store.setInFlightFrag(i,void 0)}}}setNextMaxAutoOptionId(e,t){this.store.update(e,({abrStatus:e})=>{e.nextMaxAutoOptionId=t})}setNextMinAutoOptionId(e,t){this.store.update(e,({abrStatus:e})=>{e.nextMinAutoOptionId=t})}setHighBWTrigger(e,t){this.store.update(e,({abrStatus:e})=>{e.highBWTrigger=t})}setFragLoadSlow(e,t){var i=this._query.getEntity(e);null!=i&&(i=i.abrStatus,(null==t?void 0:t.fragDownloadSlow)!==(null==i?void 0:i.fragDownloadSlow)||(null==t?void 0:t.fragDownloadTooSlow)!==(null==i?void 0:i.fragDownloadTooSlow))&&this.store.update(e,({abrStatus:e})=>{e.fragDownloadSlow=t.fragDownloadSlow,e.fragDownloadTooSlow=t.fragDownloadTooSlow})}pickMediaOptionTupleByAlternateMatchingInfo(e,t,i,r=!1,n=!1){var a=e.enabledMediaOptionIdByType(Ys.Variant),s=e.variantMediaOptionById(a),o=t===Ys.AltAudio?null===(a=i.audioMatchingInfo)||void 0===a?void 0:a.persistentId:null===(o=i.subtitleMatchingInfo)||void 0===o?void 0:o.persistentId;let l,d;if(t===Ys.AltAudio){const t=e.enabledAlternateMediaOptionByType(Ys.Subtitle);d=null==t?void 0:t.persistentID,l=o}else{const t=e.enabledAlternateMediaOptionByType(Ys.AltAudio);l=null==t?void 0:t.persistentID,d=o}const u=e.getEnabledMediaOptionMask();return u[t]=!!(z(o)&&0<=o),s?this.getBestMediaOptionTupleFromVariantAndPersistentId(e,s,l,d,u,void 0,void 0,r,n,!1,!0):[wo,wo,wo]}getFallbackMediaOptionTupleFromMediaOptionId(e,t,i,r,n=!1,a=!1,s=!1,o=!1){var l=r?[r]:[i],d=e.enabledMediaOptionIdByType(Ys.Variant),r=e.variantMediaOptionById(d),d=t===Ys.AltAudio?e.alternateMediaOptionById(Ys.AltAudio,i):e.enabledAlternateMediaOptionByType(Ys.AltAudio),d=null==d?void 0:d.persistentID,i=t===Ys.Subtitle?e.alternateMediaOptionById(Ys.Subtitle,i):e.enabledAlternateMediaOptionByType(Ys.Subtitle),i=null==i?void 0:i.persistentID;return r?this.getBestMediaOptionTupleFromVariantAndPersistentId(e,r,d,i,void 0,l,t,n,a,s,o):[wo,wo,wo]}hasFallbackMediaOptionTuple(e,t,i,r){var n=e.mediaOptionListQueries[t].mediaOptionFromId(i);return e.isValidMediaOptionTuple(this.getFallbackMediaOptionTupleFromMediaOptionId(e,t,i,n.backingMediaOptionId,!1,r))}setLegacyAlternateMediaOption(e,t,i,r,n=void 0){var a=e.enabledMediaOptionIdByType(Ys.Variant),a=e.variantMediaOptionById(a),a=e.getLegacyMatchingAlternateWithPersistentId(i,r,a);a&&this.setEnabledMediaOptionByType(t,i,a,!0,n)}setEnabledMediaOptionTupleWithMatchedGroups(t,i,e,r,n=void 0){var a;const s=r.getQueryForId(t),o=i===Ys.AltAudio?null===(a=e.audioMatchingInfo)||void 0===a?void 0:a.persistentId:null===(a=e.subtitleMatchingInfo)||void 0===a?void 0:a.persistentId,l=this.pickMediaOptionTupleByAlternateMatchingInfo(s,i,e);if(!s.isValidMediaOptionTuple(l))return this.setLegacyAlternateMediaOption(s,t,i,o,n);da(()=>{this.setEnabledMediaOptionByType(t,i,l[i],!0,n);var e=l[Ys.Variant];this.setEnabledMediaOptionByType(t,Ys.Variant,e);e=i===Ys.AltAudio?Ys.Subtitle:Ys.AltAudio;l[e].mediaOptionId!==s.enabledMediaOptionIdByType(e)&&this.setEnabledMediaOptionByType(t,e,l[e],!1)})}canSwitchToSDR(e,t,i,r=!1){var n=e.mediaOptionListQueries[Ys.Variant].mediaOptionFromId(t);if(!n)return!1;if(!Ef(n))return!1;r=this.getFallbackMediaOptionTupleFromMediaOptionId(e,Ys.Variant,t,n.backingMediaOptionId,!0,i,r);return e.isValidMediaOptionTuple(r)}getBestMediaOptionTupleFromVariantAndPersistentId(t,i,r,n,a,s,o,l,d,u,c){let h;const p=this.config,m=t.mediaOptionListQueries[Ys.Variant];if(p.enableBoss){const o=null===(f=this.mediaSelectionBossService)||void 0===f?void 0:f.getQuery(t.itemId,this.logger),c={hasScore:t.mediaOptionListQueries[Ys.Variant].mediaOptionListInfo.hasScore,pivotVariant:i,pathwayPriority:t.mediaOptionListQueries[Ys.Variant].mediaOptionListInfo.pathwayPriority,enableSteering:p.enableContentSteering,preferHostOverQuality:!0,preferCloseToPivotQuality:!0},m=new Map([[io.ValidFallbackFilter,new yh(i,d,u,s)],[io.FallbackSelector,new Bh(c)]]),g=t.enabledMediaOptionKeys[Ys.AltAudio],y=Ro(g)?t.alternateMediaOptionById(Ys.AltAudio,g.mediaOptionId):null,v=Re.getStickyAtmosStatus(p.useStickyAtmosFilter,i.audioCodec,null==y?void 0:y.channels),S=[t.mediaOptionListQueries[Ys.AltAudio].mediaOptionListInfo.penaltyBoxQueue,t.mediaOptionListQueries[Ys.AltAudio].mediaOptionListInfo.removed,t.mediaOptionListQueries[Ys.AltAudio].mediaOptionListInfo.compatibleIds],I=[t.mediaOptionListQueries[Ys.Subtitle].mediaOptionListInfo.penaltyBoxQueue,t.mediaOptionListQueries[Ys.Subtitle].mediaOptionListInfo.removed,t.mediaOptionListQueries[Ys.Subtitle].mediaOptionListInfo.compatibleIds],b=(null==y?void 0:y.persistentID)!==r,T=new Uh(v,S,I,r,n,a||t.getEnabledMediaOptionMask(),s,b);m.set(io.ErrorHandlingValidAlternatesFilter,T),m.set(io.ValidAlternatesFilter,T),null===(f=this.mediaSelectionBossService)||void 0===f||f.setMultipleTransformers(t.itemId,m);let e=[wo,wo,wo];var f=l?o.variantFor(ro.ErrorHandlingSdrOnly):o.variantFor(ro.ErrorHandling);return f&&(h=t.matchAlternates(f,r,n,s),e=[f,...h]),e}const g=m.listFallbackVariants(i.mediaOptionId,l,d,u,this.config.enableContentSteering,s);let y=[wo,wo,wo];for(let e=g.length;0<e--;){const o=g[e];h=t.matchAlternates(o,r,n,s);const l=Ky(t,o,r,n,a,s);if(l){y=l;break}}return c&&!t.isValidMediaOptionTuple(y,a)&&(y=function(e,t,i,r,n,a,s){let o=Number.POSITIVE_INFINITY;const l=t.filteredMediaOptionList;let d=[wo,wo,wo];for(const t of l){const l=Ky(i,t,r,n,a,s),u=Math.abs(t.bitrate-e.bitrate);l&&u<o&&(d=l,o=u)}return d}(i,m,t,r,n,a,s)),y}getAlternatesForVariant(e,t,i,r){var n=e.variantMediaOptionById(t),t=this.config;if(t.enableBoss){const a={hasScore:e.mediaOptionListQueries[Ys.Variant].mediaOptionListInfo.hasScore,pivotVariant:n,pathwayPriority:e.mediaOptionListQueries[Ys.Variant].mediaOptionListInfo.pathwayPriority,enableSteering:t.enableContentSteering,preferHostOverQuality:!0,preferCloseToPivotQuality:!0},s=new Map([[io.ValidFallbackFilter,new yh(n,!1,!1,[])],[io.FallbackSelector,new Bh(a)]]),o=e.enabledMediaOptionKeys[Ys.AltAudio],l=Ro(o)?e.alternateMediaOptionById(Ys.AltAudio,o.mediaOptionId):null,d=Re.getStickyAtmosStatus(t.useStickyAtmosFilter,n.audioCodec,null==l?void 0:l.channels),u=[e.mediaOptionListQueries[Ys.AltAudio].mediaOptionListInfo.penaltyBoxQueue,e.mediaOptionListQueries[Ys.AltAudio].mediaOptionListInfo.removed,e.mediaOptionListQueries[Ys.AltAudio].mediaOptionListInfo.compatibleIds],c=[e.mediaOptionListQueries[Ys.Subtitle].mediaOptionListInfo.penaltyBoxQueue,e.mediaOptionListQueries[Ys.Subtitle].mediaOptionListInfo.removed,e.mediaOptionListQueries[Ys.Subtitle].mediaOptionListInfo.compatibleIds],h=(null==l?void 0:l.persistentID)!==i,p=new Uh(d,u,c,i,r,e.getEnabledMediaOptionMask(),[],h);s.set(io.ErrorHandlingValidAlternatesFilter,p),s.set(io.ValidAlternatesFilter,p),null===(t=this.mediaSelectionBossService)||void 0===t||t.setMultipleTransformers(e.itemId,s)}return[n,...e.matchAlternates(n,i,r,[])]}getEnabledAlternatesForVariant(e,t){var i=e.enabledAlternateMediaOptionByType(Ys.AltAudio),i=null!==(r=null==i?void 0:i.persistentID)&&void 0!==r?r:void 0,r=e.enabledAlternateMediaOptionByType(Ys.Subtitle),r=null!==(r=null==r?void 0:r.persistentID)&&void 0!==r?r:void 0;return this.getAlternatesForVariant(e,t,i,r)}setLoading(e){this.store.setLoading(e)}}function Ky(e,t,i,r,n,a){a=e.matchAlternates(t,i,r,a);return e.isValidMediaOptionTuple([t,...a],n)?[t,...a]:null}function qy(e,t,n,i,r){let a;return function(e,t){if(e&&z(null==t?void 0:t.persistentId)){e=Cl(e.itemId),t=Cl(t.itemId);return e&&t}return!1}(t,n)&&(a=i.find(function(e){if(e.MediaSelectionOptionsPersistentID!==n.persistentId)return!1;if(n.language){var{baseName:t,lang:i,region:r}=Cm.toLocale(n.language);return Boolean(jy({baseName:t,lang:i,region:r},e))}return!0})),a=a||(r&&n?function(t,i,r=!1){let n=null;const{baseName:a,lang:s,region:o}=Cm.toLocale(t.language),l=[!0,!1];for(let e=0;e<l.length;++e){const d=l[e];for(let e=0;e<i.length;e++){const l=i[e];if(!(l.MediaSelectionOptionsIsAutoSelect!==d||r&&l.MediaSelectionOptionsDisplaysNonForcedSubtitles)){const t=jy({baseName:a,lang:s,region:o},l);if((null==t?void 0:t.matchType)===yy.BaseNameMatch){n=t.option;break}(null==t?void 0:t.matchType)===yy.LanguageTagMatch&&(n=t.option)}}if(n)break}return n}(n,i):i.find(function(e){return e.MediaSelectionOptionsIsDefault})),a}const Hy=(e,i,r,n,t,a)=>{if(r){let t=qy(0,e,i,r.MediaSelectionGroupOptions,a.enableInterstitialPlayback);return t=t||r.MediaSelectionGroupOptions[0],n.find(e=>e.persistentID===(null==t?void 0:t.MediaSelectionOptionsPersistentID))}};function jy(e,t){var i=Cm.toLocale(t.MediaSelectionOptionsExtendedLanguageTag);return i.baseName&&e.baseName&&i.baseName===e.baseName?{matchType:yy.BaseNameMatch,option:t}:i.lang===e.lang?{matchType:yy.LanguageTagMatch,option:t}:null}const Gy=(e,t,i,r)=>{var{rootMediaOptionsTuple:n,itemId:e}=e;let a=Array.from(n[Ys.Variant]);n=Array.from(n[Ys.AltAudio]);let s=!1,o=!1;a=a.map(e=>{var t;return e.audioCodecList&&e.audioAlternates&&((t=null==(t=e.audioAlternates&&0<e.audioAlternates.length?e.audioAlternates[0]:void 0)?void 0:t.channels)&&(e.audioChannelCount=parseInt(t))),e});i=i.enableBoss;return i&&(null==t||t.setVariants(e,[...a])),a.forEach(e=>{s=s||Boolean(e.videoCodec),o=o||Boolean(e.audioCodec)||Boolean(e.audioAlternates)}),s&&o&&(i?null==t||t.setTransformer(e,io.RemoveAudioOnlyFilter,new vh):a=a.filter(({videoCodec:e})=>Boolean(e))),{variantMediaOptions:a,audioAlternateOptions:n}},zy=(r,e,t,i,n,a,s,o,l)=>Ny(r.itemId,s,o,r.sessionKeys,e,t,i,l).pipe(sr(({hdrMediaOptions:e,sdrMediaOptions:t,imageIframeVariants:i})=>{t=e.concat(t),e=0<e.length;return function(e,t,i,r,n,a){var{parentItemId:s,itemId:o,statsId:l,itemStartOffsets:d,rootMediaOptionsTuple:u,audioMediaSelectionGroup:c,subtitleMediaSelectionGroup:h,startTimeOffset:p=NaN,appItemId:m}=e,f=Array.from(u[Ys.AltAudio]),g=Array.from(u[Ys.Subtitle]),y=t.every(e=>z(e.score)),v=e.baseUrl,u=null===(S=e.contentSteeringOption)||void 0===S?void 0:S.initPathwayPriority,S=e.sessionData;return{parentItemId:s,itemId:o,statsId:l,appItemId:m,baseUrl:v,mediaOptionListTuple:[{mediaOptions:t,hasHdrLevels:i,hasScore:y,preferHDR:r,compatibleIds:null,penaltyBoxQueue:[],removed:[],pathwayPriority:u,pathwayPenaltyBox:[]},{mediaOptions:f,compatibleIds:null,penaltyBoxQueue:[],removed:[]},{mediaOptions:g,penaltyBoxQueue:[],removed:[]}],audioMediaSelectionGroup:c,subtitleMediaSelectionGroup:h,enabledMediaOptionKeys:[wo,wo,wo],mediaOptionSwitchContexts:[null,null,null],avAnchor:null,itemStartOffsets:d,startTimeOffset:p,initPtsRecord:{},contentSteeringOption:e.contentSteeringOption,masterVariableList:e.masterVariableList,loadStats:e.stats,isMediaPlaylist:e.isMediaPlaylist,isInterstitial:n,iframeVariants:a,abrStatus:{fragDownloadSlow:!1,fragDownloadTooSlow:!1,nextMinAutoOptionId:wo.mediaOptionId,nextMaxAutoOptionId:wo.mediaOptionId,highBWTrigger:NaN},sessionData:S}}(r,t,e,n,a,i)})),Wy=(t,i,r,n,a,s,o)=>{if(n){const s=qy(0,t,i,n.MediaSelectionGroupOptions,o.enableInterstitialPlayback);let e;return s&&(e=a.find(e=>e.mediaType===eo.CLOSEDCAPTION?(!r||e.groupId===r)&&e.persistentID===s.MediaSelectionOptionsPersistentID:e.mediaType===eo.SUBTITLE?e.persistentID===s.MediaSelectionOptionsPersistentID:void 0)),e}};function Yy(e,t,i,r,n,a,s,o){const l=e.mediaOptionListTuple[Ys.Variant],d=[...wf.kAllowFilters];e.contentSteeringOption&&i.enableContentSteering&&d.push(new cc({name:"Content Steering Pathway Filter",priority:5,initFn:(e,t={})=>{var i=Mc(t.pathwayPriority);return Object.assign(Object.assign({},t),{pathwayRanking:i})},firstPassFn(e,t,i,r){var n=i.pathwayRanking(e.pathwayID);(null==i.selectedPathwayRanking||n>i.selectedPathwayRanking)&&(i.selectedPathway=e.pathwayID,i.selectedPathwayRanking=n)},filterFn:(e,t,i)=>e.pathwayID===i.selectedPathway}));var u=hc(l.mediaOptions,d,Object.assign(Object.assign({},l),{compatibleIds:null})),e=e.itemId;if(i.enableBoss){const c=new Map([[io.PermanentRemovalFilter,new uh([...l.removed])],[io.CompatibleIdsFilter,new ch(null)],[io.PenaltyBoxFilter,new hh([...l.penaltyBoxQueue])],[io.HDRFilter,new mh(l.hasHdrLevels,l.preferHDR)],[io.ViewportFilter,new fh(l.viewportInfo)],[io.HDCPFilter,new gh(l.maxHdcpLevel)]]);i.enableContentSteering&&c.set(io.PathwayFilter,new By(l.pathwayPriority)),null==r||r.setMultipleTransformers(e,c)}return{firstVariant:function(e,t,i,r,n,a,s,o,l,d,u,c=!1){let h;if(!(!t||t.length<1||t.every(e=>e.iframes))){if(c&&n){const t=n.getQuery(e,a),i=new Map([[io.FirstLevelSelector,new Nh(cf)],[io.StartUpTimeSelector,new _h(s,o,l,d,u)]]);n.setMultipleTransformers(e,i),h=t.variantFor(ro.FirstSelection)}else h=r?(S=s,I=o,b=l,T=d,E=u,t.reduceRight((e,t)=>{if(t.iframes)return e;let i=e;const r=(n=t.score,a=S&&I&&b&&T&&!Sc(t,S,I,b,T,E)?zs.INVALID:zs.VALID,new oh(a,n));var n,a;return(!e||r.isGreaterThan(e.bestRank)||r.isEqualTo(e.bestRank)&&t.bandwidth<e.selected.bandwidth)&&(i={selected:t,bestRank:r}),i},null).selected):(p=i,m=s,f=o,g=l,y=d,v=u,t.reduceRight((e,t)=>{if(t.iframes)return e;let i=e;const r=function(e,t,i,r,n,a,s){var o,l=vc(e.bitrate,e.height,t)?zs.VALID:zs.INVALID,d=sh(e.videoRange),{videoCodecRank:u,audioCodecRank:c}={videoCodecRank:rh((o=e).videoCodec),audioCodecRank:ah(o.audioCodec)},o=e.bitrate<t.maxPreferredBitrate?zs.VALID:zs.INVALID,t=e.audioChannelCount||1,s=i&&r&&n&&a&&!Sc(e,i,r,n,a,s)?zs.INVALID:zs.VALID;return new oh(l,d,u,t,c,s,o,e.height)}(t,p,m,f,g,y,v);return(!e||r.isGreaterThan(e.bestRank)||r.isEqualTo(e.bestRank)&&t.bitrate>e.selected.bitrate)&&(i={selected:t,bestRank:r}),i},null).selected);return h}var p,m,f,g,y,v,S,I,b,T,E}(e,u,cf,l.hasScore,r,t,n,i,a,s,o,i.enableBoss),filteredVariants:u}}function Xy(e,t,i,r){if((null==t?void 0:t.mediaType)===eo.CLOSEDCAPTION){r=Fy.pairForcedSubtitleMediaOptionWithClosedCaptionInList(t,null!==(e=e.subtitleAlternates)&&void 0!==e?e:[],r);if(r)return t=Object.assign(Object.assign({},t),{url:r.url,relativeUrl:r.relativeUrl,backingMediaOptionId:r.mediaOptionId}),i.map(e=>e.mediaOptionId===t.mediaOptionId?t:e)}return i}function Jy(t,i,r,e,n,a,s,o,l,d,u,c){var h,p=i.itemId,m=null!==(h=null==c?void 0:c.size)&&void 0!==h?h:0;let{firstVariant:f,filteredVariants:g}=Yy(i,n,s,r,o,l,d,u);m=(null!==(h=null==c?void 0:c.size)&&void 0!==h?h:0)-m;m&&function(e,t,i){const r=new Map,n=new Map,a=i.mediaOptionListTuple[Ys.Variant],s=Array.from(e.values());let o=e.size-t;for(;o<e.size;o++){const e=s[o];a.mediaOptions=a.mediaOptions.concat(e),e.forEach(e=>{var t;null===(t=e.audioAlternates)||void 0===t||t.forEach(e=>{var t=`${e.groupId}_${e.persistentID}`;r.has(t)||r.set(t,e)}),null===(e=e.subtitleAlternates)||void 0===e||e.forEach(e=>{var t=`${e.groupId}_${e.persistentID}`;n.has(t)||n.set(t,e)})})}const l=i.mediaOptionListTuple[Ys.AltAudio],d=Array.from(r.values());l.mediaOptions=l.mediaOptions.concat(d);const u=i.mediaOptionListTuple[Ys.Subtitle],c=Array.from(n.values());u.mediaOptions=l.mediaOptions.concat(c)}(c,m,i);const y=i.mediaOptionListTuple[Ys.Variant],v=i.mediaOptionListTuple[Ys.AltAudio],S=i.mediaOptionListTuple[Ys.Subtitle];if(!f){const t=y.preferHDR;y.preferHDR=!t&&y.hasHdrLevels,y.preferHDR!==t&&({firstVariant:f,filteredVariants:g}=Yy(i,n,s,r,o,l,d,u))}if(!f)throw new B(!0,"No valid first variant found",0===g.length?G.NoValidAlternates:G.NoValidFirstAlternate);c=f.audioAlternates?hc(f.audioAlternates,Fy.kAllowFilters,v):[],m=f.subtitleAlternates?hc(f.subtitleAlternates,Fy.kAllowFilters,S):[],l={itemId:p,mediaOptionId:null!==(o=null==f?void 0:f.mediaOptionId)&&void 0!==o?o:null},d=e.query.alternateMatchingInfo,u=null!=c&&c.length?Hy(t,null==d?void 0:d.audioMatchingInfo,i.audioMediaSelectionGroup,c,n,a):null,o=null==u?void 0:u.mediaOptionId,c=o?{itemId:p,mediaOptionId:o}:wo,o=m.length?Wy(t,null==d?void 0:d.subtitleMatchingInfo,f.closedcaption,i.subtitleMediaSelectionGroup,m,n,a):null,m=null!=m&&m.length?null==o?void 0:o.mediaOptionId:null,m=m?{itemId:p,mediaOptionId:m,mediaOptionType:Ys.Subtitle}:wo;const{mediaOptions:I,audioGroups:b,subtitleGroups:T}=s.enableBoss?(null==r?void 0:r.getQuery(p,n)).getCompatibleOptionBasedOnFirstMediaOptions(f):lc(g,f),E=Array.from(I).map(e=>e.mediaOptionId);for(const t of y.mediaOptions)$y(t,i.baseUrl);const A=Of(y.mediaOptions,{hasScore:y.hasScore,pivotVariant:f,pathwayPriority:y.pathwayPriority,enableSteering:s.enableContentSteering,preferHostOverQuality:!0,preferCloseToPivotQuality:!1}),O=Object.assign(Object.assign({},y),{mediaOptions:A,compatibleIds:E}),w=[],R=v.mediaOptions.reduce((e,t)=>(b.has(t.groupId)&&(e.persistentIds.add(t.persistentID),w.push(t.mediaOptionId),e.filteredAudioMediaOptions.push(t),e.altAudio||(e.altAudio=!!t.relativeUrl)),e),{filteredAudioMediaOptions:[],persistentIds:new Set,altAudio:!1}),C=Object.assign(Object.assign({},v),{compatibleIds:w});let k=i.audioMediaSelectionGroup;const M=null==k?void 0:k.MediaSelectionGroupOptions;if(M){const t=M.reduce((e,t)=>(R.persistentIds.has(t.MediaSelectionOptionsPersistentID)&&e.push(t),e),new Array);k=Object.assign(Object.assign({},k),{MediaSelectionGroupOptions:t})}const P=Object.assign({},S);P.mediaOptions=Xy(f,o,P.mediaOptions,n);const L=P.mediaOptions.reduce((e,t)=>(T.has(t.groupId)&&(e.persistentIds.add(t.persistentID),e.filteredSubtitleMediaOptions.push(t)),e),{filteredSubtitleMediaOptions:[],persistentIds:new Set});let x=i.subtitleMediaSelectionGroup;const D=null==x?void 0:x.MediaSelectionGroupOptions;if(D){const t=D.reduce((e,t)=>(L.persistentIds.has(t.MediaSelectionOptionsPersistentID)&&e.push(t),e),new Array);x=Object.assign(Object.assign({},x),{MediaSelectionGroupOptions:t})}const _=[O,C,P],N=new Map;if(a.useHighestVideoCodecPrivate){const t=((null==O?void 0:O.mediaOptions)||[]).length,i=e=>{var t=nh(e),t=N.get(t);return Re.isHigherCodecByFamily(t,e)?1:0};for(let e=0;e<t;e++){const t=O.mediaOptions[e].videoCodecList;if(t){const r=K(t,i);N.set(nh(r),r)}}}let F=[null,null,null];if(!d&&Cl(p)){const i={};u&&(i.audioMatchingInfo={itemId:p,persistentId:u.persistentID,language:u.lang,name:u.name}),o&&(i.subtitleMatchingInfo={itemId:p,persistentId:o.persistentID,language:o.lang,name:o.name,forced:o.forced}),t?F=[null,t.userSwitchAudioTrack&&u?{userInitiated:!0,triggerEvent:!0}:null,t.userSwitchSubtitleTrack&&o?{userInitiated:!0}:null]:Cl(p)&&!t&&(F=[null,u?{triggerEvent:!0}:null,null]),e.setAlternateMatchingInfo(i)}e={fragDownloadSlow:!1,fragDownloadTooSlow:!1,nextMinAutoOptionId:wo.mediaOptionId,nextMaxAutoOptionId:wo.mediaOptionId,highBWTrigger:Bf(l.mediaOptionId,O.mediaOptions)};return Object.assign(Object.assign({},i),{enabledMediaOptionKeys:[l,c,m],mediaOptionSwitchContexts:F,mediaOptionListTuple:_,audioMediaSelectionGroup:k,abrStatus:e,highestVideoCodec:N})}function Zy(i,e,n,a,s,t,o,r,l,d,u,c,h,p){const{itemId:m,platformInfo:f,isInterstitial:g,serviceName:y}=i,v=Ao(i),S=n.getQueryForId(m),I=n["logger"],b=p.getActiveItemContext(m);if(S.hasEntity(m)){n.setActive(m);const i=u.alternateMatchingInfo;if(b&&i){const e=[null,null!=b&&b.userSwitchAudioTrack?{userInitiated:!0,triggerEvent:!0}:null,null!=b&&b.userSwitchSubtitleTrack?{userInitiated:!0}:null];!function(e,t,i,r,n,a,s){var o=[!0,Boolean(t.audioMatchingInfo),Boolean(t.subtitleMatchingInfo)],l=n.preferHDR,d=n.enabledVariantMediaOption,u=t.audioMatchingInfo,c=t.subtitleMatchingInfo;let h=null==u?void 0:u.persistentId,p=null==c?void 0:c.persistentId;if(!z(h)){const e=qy(0,r,t.audioMatchingInfo,n.audioMediaSelectionGroup.MediaSelectionGroupOptions,s.enableInterstitialPlayback);h=null==e?void 0:e.MediaSelectionOptionsPersistentID}if(!z(p)){const e=qy(0,r,t.subtitleMatchingInfo,n.subtitleMediaSelectionGroup.MediaSelectionGroupOptions,s.enableInterstitialPlayback);p=null==e?void 0:e.MediaSelectionOptionsPersistentID}l=a.getBestMediaOptionTupleFromVariantAndPersistentId(n,d,h,p,o,[],null,!l,!1,!1,!1);Ro(l[Ys.Variant])&&a.setEnabledMediaOptionsAndSwitchContexts(e,l,i)}(m,i,e,b,S,n,l)}return Pr(S)}n.setLoading(!0);var T=!l.enableItemPreloading||null===(T=a.getPrefetchCache(i.appItemId))||void 0===T?void 0:T.rootEntity;let E;if(T)E=Pr(T).pipe(sr(e=>{const t=Object.assign({},e);return t.itemStartOffsets=i.itemStartOffsets,t}));else{a.clearPrefetchCache();const u=performance.now();E=function(t,e,i,r,n,a){const s=t["url"],o=Go(t,e);return Al({url:s,onProgress:{getData:!0,cb:Py},xhrSetup:n.xhrSetup},o,a,i).pipe(sr(e=>My(s,e,t,n,r)),Wo(!1))}(i,e,t,I,l,r.query.extendMaxTTFB).pipe(Ig(m,p,null,Go(i,e),0,!1,S,n,c),on(e=>{h.triggerManifestLoaded(e);var{initialDetails:t,stats:i,interstitials:r}=e;t&&(a.archiveMediaOptionDetails(n,t,Object.assign({},i),!0,l.liveAllowLowLatencyPlayback),l.enableInterstitialPlayback&&0<r.length&&s.addInterstitials(r));var t=d.displaySupportsHdr,{variantMediaOptions:i,audioAlternateOptions:r}=Gy(e,o,l);return zy(e,f,o,l,t,g,i,r,I)}),sr(e=>{var t=l.enableAdaptiveStartup?A.getCombinedEstimate(l,y):null;return Object.isFrozen(e.loadStats)||(e.loadStats.tfiltered=performance.now()),ev(0,b,e,r,o,u,l,t,I)}))}const A=c.getQueryForId(v);return E.pipe(sr(e=>(n.setRootPlaylistEntity(m,e),S)),Br(()=>{n.setLoading(!1)}))}function ev(e,t,i,r,n,a,s,o,l){a=performance.now()-a,a=s.targetStartupMs>a?s.targetStartupMs-a:s.targetStartupMs;return Jy(t,i,n,r,l,s,s.enableAdaptiveStartup?{targetDuration:(null==o?void 0:o.maxDurationSec)||s.defaultTargetDuration,targetStartupMs:a,enableBoss:s.enableBoss,enableContentSteering:s.enableContentSteering}:void 0,o,o,o,o)}function tv(e,t){const{mediaSink:i,itemQueue:r}=e,n=i["mediaQuery"];return Jl(Qn([n.desiredRate$,n.waterLevelChangedForType$(Xs.Variant)]).pipe(sr(([e,t])=>!(ep(e)||t<Qu.HighWater||r.isPreloading()))),e=>e).pipe(on(()=>t))}function iv(n,a,s,o){const{config:l,mediaLibraryService:d}=n;return e=>e.pipe(Xr({delay:(e,t)=>{if(e instanceof B||!(e instanceof v))return e.handled=!0,e.fatal=!1,d.setPrefetchErrored(a,o),Lr(()=>e);let i;switch(o){case lg.Manifest:i=Go({url:s},l.manifestLoadPolicy);break;case lg.Playlist:i=Go({url:s},l.playlistLoadPolicy);break;case lg.Segment:i=Go({url:s},l.fragLoadPolicy);break;default:return Lr(()=>e)}i.maxLoadTimeMs=C(i.maxLoadTimeMs,2e4);var r=zo(e,i);return Qm(e,t-1,r,0,!1,null).pipe(on(()=>tv(n,Pr(og.IN_PROGRESS)).pipe(sr(()=>0))))}}))}const rv="prefetch";class nv{constructor(e,t,i,r){this.hls=e,this.rtcService=t,this.config=i,this.logger=r,this.destroy$=new Er,this.subscribeAndUpdateStore(),this.registerForEvents()}destroy(){this.rtcService.destroy(),this.destroy$.next()}registerForEvents(){const e=rl(this.hls,this);Vn(e.event(N.KEY_REQUEST_STARTED,this._keyRequestStarted,this),e.event(N.KEY_LOADED,this._keyLoaded,this)).pipe(dn(this.destroy$)).subscribe()}subscribeAndUpdateStore(){this.hls.mediaElementQuery$.pipe(on(e=>this.mediaElementQueryListener(e)),dn(this.destroy$)).subscribe(),this.hls.itemQueue.activeItemById$.pipe(cn(t=>{if(t&&!t.parentItemId){let e=!1;if(this.hls.userInfo?this.hls.userInfo.internalBuild?e=!0:this.hls.userInfo.diagnosticsAndUsage&&(e=this.config.enableRtcReporting):e=this.config.enableRtcReporting,e){const t=this.hls.reportingAgent;t&&this.rtcService.rtcComponent.setReportingAgent(t)}else this.rtcService.rtcComponent.setReportingAgent(null);this.rtcService.serverInfoInstance=null;var i=t.itemId;this.rtcService.rtcStore.createEntity(i,this.rtcService.hlsjsVersion,this.config.enableInterstitialPlayback,0<t.loopCount,this.config.testGroupId),!this.hls.isFirstItem&&this.hls.inGaplessMode||this.rtcService.setPeriodic(i)}}),dn(this.destroy$)).subscribe()}mediaElementQueryListener(e){return e.gotPlaying$.pipe(cn(e=>{if(e){const e=this.rtcService.oldRate,t=this.rtcService.newRate||1;1<Math.abs(e)&&1<Math.abs(t)||(this.rtcService.rtcStore.updateCanPlay(this.rtcService.rtcEventItemId(!0),{mediaDur:this.hls.bufferedDuration,oldRate:e,newRate:t,forInterstitial:this.hls.interstitialActive,playStartTime:this.hls.realCurrentTime}),this.rtcService.sendAndFinalize(this.rtcService.rtcEventItemId(!0),Gp.PlayLikelyToKeepUp),this.rtcService.rtcStore.updateRateChanged(this.rtcService.rtcEventItemId(!0),{rate:t,latency:z(this.rtcService.playStart)?performance.now()-this.rtcService.playStart:0,mediaDur:this.hls.bufferedDuration,currentTime:this.hls.realCurrentTime,url:this.rtcService.levelSwitchingUrl,forInterstitial:this.hls.interstitialActive}),this.rtcService.sendAndFinalize(this.rtcService.rtcEventItemId(!0),Gp.PlayRateChanged))}}))}_keyRequestStarted(e){this.rtcService.keyRequestStarted(e,this.hls.interstitialActive)}_keyLoaded(e){var t;e.method=null===(t=e.decryptdata)||void 0===t?void 0:t.method,this.rtcService.keyLoaded(e,this.hls.interstitialActive)}}function av(n,a,s){return e=>{var t,i,r;return ur([(t=n,i=a,r=s,e.pipe(on(e=>{if(!e)return Pr(null);e=new Lu(e,t,i,r);return Vn(e,Pr(e))}))),e]).pipe(sr(([e,t])=>({legibleSystemAdapter:e,mediaSink:t})))}}nv.loggerName={name:"rtc-service"};tl;return class sv extends tl{constructor(e={},t,i,r,n=ba()){var a,s,o,l;if(super(),this.sessionID=n,this.destroy$=new Er,this.mediaElement$=new qr(null),this._rootQuery$=new qr(null),this._mediaElementQuery$=new qr(null),this._interstitialQuery$=new qr(null),this.mediaElementAdapter=null,this.rpcService=null,this.rpcClients=null,this.hlsService=new ly(new oy),this.mediaLibService=(a=this.hlsService,new kg(new wg,a)),this.platformService=new Pp(new Mp),this.interstitialService=new bl(new Il),this.keySystemAdapter=null,this.legibleSystemAdapter=null,this.iframeClock=new Fo,this.gaplessCapable=!0,this.teardownWG$=new np,this.commitedEarlyAlternateSelection=!1,this._pipelineCtx$=new qr(void 0),this.operationQueue$=new Er,this._queueOps=[],this._queueOpsChanged$=new Er,this.loggingEnabled=new qr(!0),e.liveSyncDurationCount&&e.liveSyncDuration)throw new Error("Illegal hls.js config: don't mix up liveSyncDurationCount and liveSyncDuration");let d="silent";e.debug&&(d=e.debugLevel),this.logStore=new No(null!==(a=e.rtcLogHistoryNumLines)&&void 0!==a?a:Eo.rtcLogHistoryNumLines),this.logger=null!==(a=this.logger)&&void 0!==a?a:((e,t={},i)=>{let r;return r=qu(([a={}]=[t],Object.assign(Object.assign({},a),{customLevels:Object.assign(Object.assign({},a.customLevels||{}),{qe:35,timing:35})}))).child({sessionId:e,name:"hls",isEnabled:i}),r.qe=function(t,e=[],i=[]){const r=new Set(e),n=new Set(i);return e=>{r.size&&!r.has(e.name)||n.has(e.name)||t.info(e)}}(r,t.allowed,t.disallowed),(n=r).perf=function(e){var t;null!=(t=e)&&"object"==typeof t&&"critical"in t&&"name"in t&&"data"in t?(e.data.tnow=performance.now(),n.info(e)):n.info({name:"timing"},"string"==typeof e?e:JSON.stringify(e))},r.sessionId=e,"function"!=typeof r.isLevelEnabled&&(r.isLevelEnabled=function(e){return this.levels.values[e]>=this.levelVal||this.levelVal<=35&&("qe"===e||"perf"===e)}.bind(r)),r;var n,a})(n,(s={allowed:e.allowedLogs,buildType:e.buildType,consoleOverride:"boolean"!=typeof e.debug?e.debug:void 0,disallowed:e.disallowedLogs,level:"log"===d?"debug":d,sendLogs:e.sendLogs||null,storeLogs:this.logStore.recordLogs.bind(this.logStore)},o=s["consoleOverride"],_=new Set(s.allowed),l=new Set(s.disallowed),Object.assign({name:"hls",timestamp:s.sendLogs?qu.stdTimeFunctions.epochTime:qu.stdTimeFunctions.isoTime,browser:{asObject:!0,serialize:!0,transmit:{send:(e,t)=>{var i;null===(i=s.storeLogs)||void 0===i||i.call(s,t)}},write:{debug:nc.bind(null,rc(o||console,"debug"),"debug",_,l),info:nc.bind(null,rc(o||console,"info"),"info",_,l),warn:nc.bind(null,rc(o||console,"warn"),"warn",_,l),error:nc.bind(null,rc(o||console,"error"),"error",_,l),fatal:nc.bind(null,rc(o||console,"error"),"fatal",_,l)}}},s)),this.loggingEnabled),this.itemQueue=(o=this.logger,_=new pa({},{name:"item-queue",idKey:"itemId",resettable:!0}),new hy(_,o)),this.statsService=(l=this.logger,new gm(new fm,l));const u=function(e,t,i,r){if(r.child({name:"remote-config"}),!(e&&i&&(n=e,r=To,null!=n&&n.BagDict&&n.ConfigurationDict&&function(e,t){return e&&t&&(e=e.split("."),t=t.supportedStorebagVersion.split("."),e[0]===t[0])}(n.Version,r))))return{};var n;const a=e.ConfigurationDict;let s={};const o=e.BagDict[i.clientName],l=o?o[i.serviceName]:null;if(function(t,i){if(!t||!i)return!1;const r=t.VersionRange;if(!r)return!1;const n=r[0],e=r[1];if(!(n&&e&&Nu(n,e)))return!1;var a=t.SamplingThreshold;if(!(z(a)&&a<=1&&0<=a))return!1;var s=t.Configurations;if(!s)return!1;let o=0;for(const t of s){if(!t)return!1;const d=t[0],r=t[1],n=d?i[d]:null;let e=!1;if(n&&(e=null!=n.GroupId&&"string"==typeof n.GroupId&&n.GroupId.length<20),!e)return!1;if(!(d&&n&&n.Patch&&z(r)))return!1;o+=r}if(a=Math.abs(1-o)<=Number.EPSILON,!(s&&0<s.length&&a))return!1;const l=new Date(t.ExpirationDate);return l&&l.getTime()>Date.now()}(l,a)&&l){const d=Math.max(0,Math.min(l.SamplingThreshold,1)),u=0===Fu([d,1-d]);if(e=l,i=t,t=e.VersionRange,e=t[0],t=t[1],(null==e||Nu(i,e))&&(null==t||Nu(t,i))&&u){const d=(t=l.Configurations.map(e=>[a[e[0]],e[1]]),i=Fu(t.map(([,e])=>e)),t[i][0]),c=Object.keys(d.Patch).filter(e=>(e=>e in Eo&&!_u.has(e))(e)).reduce((e,t)=>(Object.prototype.hasOwnProperty.call(d.Patch,t)&&(e[t]=d.Patch[t]),e),{});s.testGroupId=d.GroupId,s=Object.assign(s,c)}}return s}(r,sv.version,i,this.logger),F=Object.assign(Object.assign(Object.assign({},Eo),e),u);if(F.maxRequiredStartDuration<F.minRequiredStartDuration||F.minRequiredStartDuration<0||F.minRequiredStartDuration<F.minRequiredStartDurationLLHLS)throw new Error("Illegal config: bad maxRequiredStartDuration or minRequiredStartDuration or config.minRequiredStartDurationLLHLS");_=(this.hlsConfig=F).buildType,W="production"===_,Ns(!0),Zn=!1,Yn&&(delete window.$$stores,delete window.$$queries),this.hlsConfig.audioPrimingDelay=0,this.accessLogInstance=new jp(this,n,this.logger),this.rtcService=new Zp(this,F,sv.version,this.accessLogInstance,this.logger,this.logStore.getLogs.bind(this.logStore)),this.rtcController=new nv(this,this.rtcService,F,this.logger),F.enableBoss&&(this._mediaSelectionBossService=new Kh(new Zc)),this.rootPlaylistService=this.rootPlaylistService=(o=this.hlsService,l=this.logger,r=F,i=this.rtcService,e=this.statsService,_=this._mediaSelectionBossService,new Qy(new Vy,o,l,r,i,e,_)),this.customUrlLoader=new xu(this.logger),this.sessionDataLoader=new Du(ll,this.customUrlLoader.load,this.logger);const c=this.hlsService;c.setHlsEntity({id:n,config:F});var h,p,m,f,g,y,v,S,I,b,T,E,A,O,w,R,C,k,M,P,L,x,D,e=this.platformService.query,_=new Bd(new Fd),n=this.interstitialService.interstitialQuery;this._interstitialQuery$.next(n),this.playerEvents=new ay(this,this.logger,this.rtcService,this.customUrlLoader,this.rootPlaylistService,this.mediaLibService),this.interstitialController=new py(this.itemQueue,this.interstitialService,ur([this._rootQuery$,this._mediaElementQuery$,this._interstitialQuery$]),F,this.rtcService.rtcQuery,this.playerEvents,this.customUrlLoader,this.logger),this.playerEvents.setInterstitialQuery(n);const N=(R=this.platformService,(()=>{if("function"==typeof matchMedia){const t=matchMedia("(dynamic-range: high)"),e=matchMedia("bad query");if(t.media!==e.media){let e;return e="function"==typeof t.addEventListener?Nn(t,"change"):"function"==typeof t.addListener?Bn(t.addListener.bind(t),t.removeListener.bind(t)):Cr,Vn(Pr(t.matches),e.pipe(sr(Cp)))}}return Pr(!0)})().pipe(cn(e=>{R.updateSupportsHdr(e)})).pipe(ln(Cr))),B=this.mediaElement$.pipe((T=F,A=(E=this).logger,O=this.teardownWG$,w=this.rtcService,e=>e.pipe(on(e=>{if(!e)return Pr(null);const t=new Op(e,new Jh,T,E,A,O,w);return t.openMediaSource(new MediaSource),Vn(t,Pr(t))}))),cn(e=>{e=null!==(e=null==e?void 0:e.mediaQuery)&&void 0!==e?e:null,this.playerEvents.setMediaElementQuery(e),this._mediaElementQuery$.next(e)}),Br(()=>{this.playerEvents.setInterstitialQuery(null),this._mediaElementQuery$.next(null)}),tn()),U=(h=_,p=B,m=this.teardownWG$,f=F,g=e,v=(y=this).rtcService,S=this.customUrlLoader,I=this.logger,C=F.keyLoadPolicy,k=this.rootPlaylistService,M=_.query,P=this.itemQueue,b=e=>e.pipe(ca(e=>{const t=k.query.getActiveId(),i=M.getKeyInfo(e.uri);i&&i.mediaOptionKeys.some(({itemId:e})=>e===t)&&ry(i,!1,k.getQueryForId(t),k)}),Xr({delay:(e,t)=>{if(e instanceof Pl||e instanceof Ll)return ny(e,t-1,zo(e,Go({url:e.keyuri},C)),k,M,P);throw e}})),new oi(e=>{const t=new Dd(h,p,f,g,y,v,S,I,b);return e.next(t),function(){m.wrap(t.destroy()).subscribe()}}).pipe(cn(e=>this.keySystemAdapter=e)));this.rpcService=(()=>{let e=null;return null!=F.createRPCService&&(e=qp(F.createRPCService,$p)),F.enableWorker&&null==e&&(e=Hp),null==e&&(e=$p),e(this.logger)})(),this.rpcClients=(_=this.rpcService,{crypto:new Fp(_),mux:new Bp(_)});const V=this.itemQueue.activeItemById$.pipe(on(e=>ur([this.replaceItemAction(e,this.itemQueue,this.mediaElementAdapter,this.logger),this._makeActiveItemAdapters(e,this.itemQueue.isPreloading(),F)]).pipe(sr(([,e])=>e))),Xr({delay:this._handleError.bind(this)})),$=this.itemQueue.activeItemById$.pipe(sr(e=>e?Ao(e):void 0),_d(),xr(),(L=F,x=this.statsService,D=this.logger,e=>e.pipe(xr(),on(e=>{var t,i,r,n,a,s,o,l,d,u;i=e,(t=x).getQueryForId(i).hasEntity(i)?t.setActive(i):t.addEmptyEntity(i);const c=x.getQueryForId(e),{fragSample$:h,playlistSample$:p,bandwidthSample$:m,bufferMetric$:f}=c;return Vn(nr(p,Li).pipe((d=L,u=x,e=>e.pipe(en((e,t)=>(e.playlistLoadTimeMs.add(t.playlistLoadTimeMs),e.playlistParseTimeMs.add(t.playlistParseTimeMs),e),{playlistLoadTimeMs:new pm(d.minPlaylistCount),playlistParseTimeMs:new pm(d.minPlaylistCount)}),sr(e=>({avgPlaylistLoadTimeMs:e.playlistLoadTimeMs.avg,avgPlaylistParseTimeMs:e.playlistParseTimeMs.avg})),xr(ym),cn(e=>{u.setPlaylistEstimate(e)})))),nr(m,Li).pipe((o=L,l=x,n=>new oi(e=>{const t=new nm(o.bandwidthHistoryWindowSize,o.bandwidthHistoryAggregationMethod,{avgLatencyMs:NaN,avgBandwidth:NaN}),i=t.estimate$,r=Vn(n.pipe(_r(e=>e.complete),sr(e=>({trequest:e.trequest,tfirst:e.tfirst,tload:e.tload,bitsDownloaded:8*e.loaded})),on(e=>(t.record(e),Cr))),i.pipe(xr(),cn(e=>{l&&l.setBandwidthEstimate(e)}))).subscribe(e);return()=>{r.unsubscribe(),t.destroy()}}))),nr(h,Li).pipe((a=L,s=x,e=>e.pipe(en((e,t)=>(e.durationSec.add(t.durationSec),e.fragParseMs.add(t.parseTimeMs),e),{durationSec:new pm,fragParseMs:new pm(a.minFragmentCount)}),sr(e=>({maxDurationSec:e.durationSec.max,avgParseTimeMs:e.fragParseMs.avg})),xr(ym),cn(e=>s.setFragEstimate(e))))),nr(f,Li).pipe((r=L,n=x,e=>e.pipe(en((e,t)=>(z(t.bufferCreationStart)&&z(t.bufferCreationEnd)&&e.bufferCreateMs.add(t.bufferCreationEnd-t.bufferCreationStart),z(t.startInitAppend)&&z(t.endInitAppend)&&e.initFragAppendMs.add(t.endInitAppend-t.startInitAppend),z(t.startDataAppend)&&z(t.endDataAppend)&&e.dataFragAppendMs.add(t.endDataAppend-t.startDataAppend),e),{bufferCreateMs:new pm,initFragAppendMs:new pm,dataFragAppendMs:new pm(r.minFragmentCount)}),sr(e=>({avgBufferCreateMs:e.bufferCreateMs.avg,avgInitFragAppendMs:e.initFragAppendMs.avg,avgDataFragAppendMs:e.dataFragAppendMs.avg})),xr(ym),cn(e=>{n.setBufferEstimate(e)}))))).pipe(on(()=>Cr),Br(()=>{hm.setCombinedEstimate(L,Object.assign({},c.getCombinedEstimate()),D,e),x.remove(e)}))})))),Q=ur([V,B.pipe(av(F,this,this.logger),cn(({legibleSystemAdapter:e,mediaSink:t})=>{this.legibleSystemAdapter=e,this.interstitialController.mediaQuery=null==t?void 0:t.mediaQuery,this.mediaElementAdapter=t}))]).pipe(cn(([e,t])=>{var i,{legibleSystemAdapter:r,mediaSink:n}=t;e&&this.keySystemAdapter&&r&&n?({rootPlaylistQuery:i,mediaParser:t,config:e}=e,this._pipelineCtx$.next({logger:this.logger,config:e,hlsService:this.hlsService,platformService:this.platformService,statsService:this.statsService,rtcService:this.rtcService,rpcClients:this.rpcClients,hlsQuery:this.hlsService.query,rootPlaylistService:this.rootPlaylistService,rootPlaylistQuery:i,mediaLibraryService:this.mediaLibService,keySystemAdapter:this.keySystemAdapter,legibleSystemAdapter:r,mediaSink:n,mediaParser:t,iframeClock:this.iframeClock,playerEvents:this.playerEvents,mediaSelectionBossService:this._mediaSelectionBossService,interstitialService:this.interstitialService,interstitialController:this.interstitialController,customUrlLoader:this.customUrlLoader,gaplessInstance:this,itemQueue:this.itemQueue,operationQueue$:this.operationQueue$})):this._pipelineCtx$.next(void 0)})),K=this._pipelineCtx$.pipe(tr(Cn),on(s=>{var e,i,r,t,n,a,p,m,f,o,l,d,u,c,h,g,y,v,S,I,b,T,E,A;if(!s)return Cr;if(s.rootPlaylistQuery.itemId!==(null===(e=this.itemQueue.activeItem)||void 0===e?void 0:e.itemId))return Cr;const{rootPlaylistQuery:O,mediaSink:w,itemQueue:R,logger:C,config:k}=s,M=w.mediaQuery,P=O.mediaOptionListQueries[Ys.Variant].hasIframes,L=function(r){if(!r)return Cr;const{logger:e,config:t,platformService:i,rootPlaylistService:n,rootPlaylistQuery:a,keySystemAdapter:s,mediaSink:o,mediaParser:l,gaplessInstance:d,operationQueue$:u,itemQueue:c}=r,h=a["itemId"],p=[(f=e,g=a,y=u,new oi(function(e){const r={};var i;r.enabledMediaOptionSwitchInfo$=new qr(void 0),y.pipe((i=(e,t,i)=>e.execute(e,t,i,r),t=>new oi(e=>function(e,i,r){const n=new fy([]);let a=0,s=0,t=!1;const o=()=>{!t||n.value.length||a||i.complete()},l=e=>{a++;let t=!1;i.add(ar(r(e,s++,n)).pipe(cn({next(e){i.next(e)},error(e){i.error(e)},complete(){t=!0}}),Br(()=>{if(t)try{for(a--;n.value.length&&a<1;){var e=n.value[0];n.next(n.value.slice(1)),l(e)}o()}catch(e){i.error(e)}})).subscribe())};i.add(e.pipe(cn({next:e=>a<1?l(e):n.next([...n.value,e]),error(e){i.error(e)},complete(){t=!0,o()}})).subscribe())}(t,e,i))),on(()=>Cr)).subscribe(e),e.add(g.enabledMediaOptionsSwitchInfo$(f).subscribe(r.enabledMediaOptionSwitchInfo$))}))],m=s.keyStatusChange$.pipe((v=r,e=>e.pipe(pr((e,t)=>{var{decryptdata:i,status:r,error:n}=e,e=v["itemQueue"];if("needs-renewal"===r)return Fg(v,i,void 0);if("error"!==r||!(n instanceof Ll||n instanceof Pl)||n.handled)return Cr;{const{rootPlaylistService:a,keySystemAdapter:t}=v;return ny(n,0,null,a,t.ksQuery,e)}}),on(()=>Cr))));var f,g,y,v;const S=i.query,I=a.mediaOptionListQueries[Ys.Variant],b=I.filteredMediaOptionList,T=I.mediaOptionListInfo.hasHdrLevels;return T?p.push(S.displaySupportsHdr$.pipe(xr(),on(e=>(e=function(s,o,l){const{config:d,logger:e,mediaLibraryService:u,mediaSink:t,rootPlaylistQuery:c,rootPlaylistService:h,itemQueue:p}=s,m=t["mediaQuery"];return{operation:om.RendererSwitch,priority:sm.Normal,execute:(t,e,i,r)=>{var n=Pn(()=>(h.setHDRPreference(o,p,l,!0),Yl)).pipe(on(e=>ey(s,t,0,r).pipe(dn(iy(t,i,c,u,m,d))))),a=Pn(()=>Yl);return Un(()=>!1,Pn(()=>Yl),Rr(n,a))},logger:e}}(r,h,e),u.next(e),Cr)))):p.push(Pn(()=>{var e=function(n){const{logger:e,rootPlaylistQuery:a,mediaLibraryService:s,mediaSink:t,config:o}=n,l=t.mediaQuery;return{operation:om.VariantSwitch,priority:sm.Normal,execute:(e,t,i,r)=>ey(n,e,0,r).pipe(dn(iy(e,i,a,s,l,o))),logger:e}}(r);return u.next(e),Cr})),p.push(nr(m,Li).pipe(Oy(e,"keyStatusChange")),function(u){const{rootPlaylistQuery:c,mediaSink:h,mediaLibraryService:e,config:p,itemQueue:m}=u,{livePlaylistUpdateStaleness:i,liveAllowLowLatencyPlayback:f}=p,g=h.mediaQuery,t=ur([c.enabledMediaOptionByType$(Ys.Variant).pipe(Ry(e,f)),c.hasAlternateWithUrl(Ys.AltAudio)?c.enabledMediaOptionByType$(Ys.AltAudio).pipe(Ry(e,f)):Xl]);return ur([t,g.msReadyState$,g.desiredRate$]).pipe(on(([e,t])=>"open"!==t||!e[Ys.Variant]||e.some(e=>null!=e&&!0===e.mediaOptionDetails.liveOrEvent&&!function(e,t,i=!1){var r=null==e?void 0:e.mediaOptionDetails;if(!r)return!1;var n=performance.now(),e=e.lastUpdateMillis||n;return i?n-e<t*r.partTargetDuration*1e3:n-e<t*r.targetduration*1e3}(e,i,f))?Cr:Jl(g.updating$,e=>!e).pipe(Mr(e),ca(([e,t])=>{var i;const r=g.bufferedRangeTuple,n=[e.mediaOptionDetails,null==t?void 0:t.mediaOptionDetails],a=!Dm(n),s=_m(n);let o=!0,l=NaN;if(a)if(s){const u=vf(n,p),m=Math.max(e.lastUpdateMillis,null!==(i=null==t?void 0:t.lastUpdateMillis)&&void 0!==i?i:-1/0);h.updateLiveSeekableRange(u.start,u.end,u.edge,u.boundary,m),function(e,r,n,a){if(1!==a.desiredRate)return!1;const t=a.desiredPos,s=n.maxSeekHole,o={avgPlaylistLoadTimeMs:0,avgPlaylistParseTimeMs:0},l=a.getBufferInfo(t,s);return e.map(e=>e?yf(e.mediaOptionDetails,n):null),!e.every((e,t)=>{var i=null==e?void 0:e.mediaOptionDetails;return!(null!=i&&!a.canContinuePlaybackWithoutGap(i,e.lastUpdateMillis,o,s))||(e=r[t],t=null===(t=l[t])||void 0===t?void 0:t.buffered,!(!e||!t)&&(e={start:e.start,end:e.start+e.duration},i=yf(i,n),If(e,t,s)&&If(e,i,s)))})}([e,t],c.getInFlightFrags(),p,g)&&(l=p.liveResumeAtWindowStart?0:1/0)}else o=!1;else h.clearLiveSeekableRange();if(o){const u=r[Xs.Variant],c=r[Xs.AltAudio],e=null!==(t=null===(t=null==u?void 0:u[u.length-1])||void 0===t?void 0:t.end)&&void 0!==t?t:0,p=null!==(t=null===(t=null==c?void 0:c[c.length-1])||void 0===t?void 0:t.end)&&void 0!==t?t:0,d=Math.max(e,p),g=isNaN(h.msDuration)?0:h.msDuration,a=Math.max(ef(n[Ys.Variant],f),n[Ys.AltAudio]?ef(n[Ys.AltAudio],f):0);h.msDuration=Math.max(g,a,d);const s=Zh(m.getQueueItemForId(n[Ys.Variant].itemId))||0;h.primaryContentDuration=a-s}return isNaN(l)||u.interstitialController.interstitialIsPlaying()||h.seekWithOptions(l,void 0,!0),Cr}))))}(r),function(){const{mediaSink:e,interstitialController:n,statsService:c}=r,t=e.mediaQuery;return ur([Pr(r),t.desiredRate$.pipe(Vr())]).pipe(on(([e,[t,i]])=>{const{rootPlaylistQuery:s,config:o,mediaSink:r,mediaLibraryService:l,itemQueue:d}=e,u=r.mediaQuery;if(0===t&&1===i){const e=Lo.every(e=>{const t=s.enabledMediaOptionKeys[e],i=l.getQueryForOption(t),r=c.getQueryForId(s.statsId),n=d.getQueueItemForId(s.itemId),a=i.mediaOptionDetailsEntity;return!(null!==(e=null==a?void 0:a.mediaOptionDetails)&&void 0!==e&&e.ptsKnown)||u.canContinuePlaybackWithoutGap(a.mediaOptionDetails,a.lastUpdateMillis,r.getPlaylistEstimate(o,null==n?void 0:n.serviceName),o.maxBufferHole)});if(!e&&!n.interstitialIsPlaying())return r.pause(),r.flushAll(0,1/0,!0)}return Cr}),ln(Cr))}()),t.useViewportSizeForLevelCap&&b.some(e=>z(e.width)&&z(e.height))&&p.push(S.viewportInfo$.pipe(xr((e,t)=>e&&t&&e.width===t.width&&e.height===t.height),cn(e=>{n.setViewportInfo(h,e)}))),(T||b.some(e=>null!=e.hdcpLevel))&&p.push(ur([a.hdrMode$.pipe(xr()),a.maxHdcpLevel$.pipe(xr())]).pipe(an(1),on(([])=>((null==c?void 0:c.playingItem.itemId)!==h||d.inGaplessMode||0!==a.itemStartPosition||(o.resetMediaSource(),l.reset()),Cr)))),I.hasIframes&&p.push(function(){const{rootPlaylistQuery:a,mediaSelectionBossService:s,mediaSink:e}=r,t=e.mediaQuery,i=a.enabledVariantMediaOption$;return ur([Pr(r),t.desiredRate$.pipe(Vr())]).pipe(xr((e,t)=>e[1]===t[1]),yn(i),on(([[e,[t,i]],r])=>{if(t=ep(t),i=ep(i),t===i)return Cr;const n=e["rootPlaylistService"];return i&&a.nextMaxAutoOptionId===wo.mediaOptionId&&(n.setNextMaxAutoOptionId(a.itemId,r.mediaOptionId),null==s||s.setTransformer(a.itemId,io.BitrateFilter,new Lh(0,r.bitrate))),Cr}))}()),Vn(...p).pipe(on(()=>Cr))}(s).pipe(Xr({delay:this._handleError.bind(this)})),x=R.activeItem;ep(x.initialRate)&&this._setRateInternal(this.desiredRate,x.initialRate,x.initialSeekTime),O.isInterstitial||this.commitedEarlyAlternateSelection||this.commitAlternateMatchingInfo(C),this.mediaElementAdapter.addAirPlaySource(x.url);const D=M.gotFirstAppend$(Li).pipe(on(()=>{const e=[function(e){const t=e.mediaSink.mediaQuery,i=e.rootPlaylistQuery.statsId;return nr(Vn(t.seekTo$.pipe(_r(e=>z(null==e?void 0:e.pos))),t.flushing$.pipe(Vr(),_r(([e,t])=>!0===e&&!1===t))),Li).pipe(cn(()=>uf(e.config,e.logger,e.rootPlaylistQuery,e.mediaSink,e.mediaLibraryService,e.statsService.getQueryForId(i))))}(s),function(a){const{rootPlaylistQuery:s,mediaLibraryService:r,mediaSink:o,config:l}=a;return Jl(s.lastLoadedMediaOptionByType$(Ys.Variant),e=>!!e).pipe(on(e=>{if(!(e=r.getQueryForOption(e).mediaOptionDetails))return Cr;o.startMonitors(),o.bufferMonitorTargetDuration=e.targetduration;const t=performance.now(),i=[];return Po.forEach(e=>{e!==Ys.Variant&&!s.hasAlternateWithUrl(e)||i.push(s.enabledMediaOptionByType$(e).pipe(Bg(r),on(e=>e?e.mediaOptionDetailsEntity$:Cr),xr((e,t)=>(null==e?void 0:e.lastUpdateMillis)===(null==t?void 0:t.lastUpdateMillis)),_r(e=>!1===(null==e?void 0:e.detailsLoading)&&e.lastUpdateMillis>t)))}),Vn(...i).pipe(tr(Li),cn(e=>{const t=o.mediaQuery,i=a.legibleSystemAdapter,r=e.mediaOptionDetails,n=e.lastUpdateMillis;if(r.liveOrEvent&&i&&t.readyState>=HTMLMediaElement.HAVE_METADATA)if(r.mediaOptionType!==Ys.Variant||Ro(s.enabledMediaOptionKeys[Ys.Subtitle])){if(r.mediaOptionType===Ys.Subtitle){const a=wy(t,l.liveOldCueRemovalOffsetSec,l.maxBufferHole);i.removeEarlierCues(a)}}else{const a=wy(t,l.liveOldCueRemovalOffsetSec,l.maxBufferHole);i.removeEarlierId3Cues(a)}if(function(e,t,i,r,l){return i=function(e,t,i,r,n){if(!t.ptsKnown)return 0;var a=t.targetduration,s=yf(t,l).start,r=n.canContinuePlaybackWithoutGap(t,i,{avgPlaylistLoadTimeMs:0,avgPlaylistParseTimeMs:0},r);let o=Math.max(0,e-a);return e<s&&!r&&(o=s),o}(r.desiredPos,e,t,i,r),r=yf(e,l).end,{expired:e.liveOrEvent&&e.ptsKnown&&r<i,windowEnd:r,minPosition:i}}(r,n,l.maxBufferHole,t,l).expired){const a=G.LivePlaylistTooFar;throw new Qo(!1,a.text,a,!1,r.mediaOptionType,r.mediaOptionId,r.url)}}))}))}(s).pipe(Oy(C,"enabledOptions")),M.ended$.pipe(on(e=>e?Cr:Jl(Qn([M.gotPlaying$,M.readyState$]),([e,t])=>!0===e||t>=HTMLMediaElement.HAVE_METADATA).pipe(on(()=>Ki(0,1e3)),cn(()=>{this.playbackInfo(F,M)}))))];return this.inGaplessMode||e.push(function(){const{config:e,mediaSink:t,rootPlaylistQuery:i,mediaLibraryService:r,gaplessInstance:n}=s,a=t["mediaQuery"];return ur([Vg(i,r),a.msReadyState$,a.updating$,a.isIframeRate$,a.isBufferedToEnd$(e.maxBufferHole,!n.inGaplessMode)]).pipe(_r(([,e,t,i,r])=>"open"===e&&!1===t&&!i&&r),cn(([e])=>{null!=e[0]&&e.every(e=>null==e||!1===e.liveOrEvent&&!1===e.iframesOnly)&&!n.inGaplessMode&&t.endStream()}),ln(Cr))}()),P&&k.enableIFramePreloading&&e.push((t=>{const{config:e,logger:i,mediaLibraryService:r,rootPlaylistQuery:n}=t;if(!e.enableIFramePreloading)return Pr(og.DISABLED);var a=n.enabledMediaOptionByType$(Ys.Variant).pipe(on(e=>function(e,t){var i=t.mediaOptionListQueries[Ys.Variant].hasIframes,t=null!==(t=null===(t=e.getEntity(t.itemId))||void 0===t?void 0:t.liveOrEvent)&&void 0!==t&&t;return i&&!t}(r.getQueryForOption(e),n)?function(e,t){const{rootPlaylistQuery:i,logger:r,config:n,mediaSink:a,statsService:s,mediaLibraryService:o,mediaSelectionBossService:l}=t,d=a["mediaQuery"],u=s.getQueryForId(i.statsId),c=Lf(!0,n,i,o.getQueryForOption(e),d,u,l,r),h=i.variantMediaOptionById(c.variantMediaOption);return o.retrieveMediaOptionDetails(t,h,!0,!1)}(e,t).pipe(kr(1),Nr(e=>function(e,t){const{mediaSink:i,mediaLibraryService:r,rootPlaylistQuery:n}=t,a=i["mediaQuery"],s=a.currentTime,o=zm(s,jm(e,s),e);return null!=o&&o.mediaFragment?(e=o.mediaFragment,Ln([Fg(t,e.keyTagInfo,{itemId:e.itemId,mediaOptionId:e.mediaOptionId,appItemId:n.appItemId}),r.retrieveInitSegmentCacheEntity(t,e,e.discoSeqNum)]).pipe(Mr(og.SUCCESS))):Lr("Unable to find fragment for iframe prefetch")}(e,t)),Wi(e=>(i.error(rv,`got error ${e.message} in prefetch`),Pr(og.ERRORED)))):Pr(og.DISABLED)));return tv(t,a).pipe(kr(1),Br(()=>{}))})(s)),k.enableItemPreloading&&this.inGaplessMode&&(this.mediaLibService.clearPrefetchCache(),this.playerEvents.triggerPrefetchNextItem(this.itemQueue.activeItem.appItemId),e.push((e=>{const{config:t,logger:i,mediaLibraryService:r,itemQueue:n}=e,a=i.child({name:rv}),s=Object.assign(Object.assign({},e),{logger:a});return t.enableItemPreloading?n.prefetchItem$.pipe(_d(),xr((e,t)=>t.appItemId===e.appItemId)).pipe(on(t=>{var e=null==t?void 0:t.url;return e?(r.addPrefetchItem(t.appItemId,e,a),tv(s,function(i,r){const{logger:e,mediaLibraryService:n,hlsService:t}=r,a=i.url,s=i.appItemId,o=t.query.currentConfig,l=o.manifestLoadPolicy;return function(a,e,t,s,o,i){const r=Go({url:a.url},e),{mediaSelectionBossService:l,statsService:n,hlsService:d,platformService:u}=t;return Al({url:a.url,onProgress:null,xhrSetup:o.xhrSetup},r,i,null).pipe(sr(e=>My(a.url,e,a,o,s)),on(e=>{var t=u.query,i=t.displaySupportsHdr,{variantMediaOptions:r,audioAlternateOptions:n}=Gy(e,l,o);return zy(e,t.platformInfo,l,o,i,a.isInterstitial,r,n,s)}),sr(e=>{const t=n.getQueryForId(a.serviceName),i=o.enableAdaptiveStartup?t.getCombinedEstimate(o,a.serviceName):null;return Object.isFrozen(e.loadStats)||(e.loadStats.tfiltered=performance.now()),ev(0,null,e,d,l,performance.now(),o,i,s)}),Wo(!1))}(i,l,r,e,o,t.query.extendMaxTTFB).pipe(iv(r,s,a,lg.Manifest),sr(t=>(n.cachePrefetchRootEntity(s,t),t.mediaOptionListTuple[Ys.Variant].mediaOptions.find(e=>e.mediaOptionId===t.enabledMediaOptionKeys[Ys.Variant].mediaOptionId))),on(e=>{var t=e.mediaOptionId;return function(a,s,e,t,o){const{logger:l,hlsService:i}=e,{playlistLoadPolicy:r,keySystemPreference:d}=t,n=Go({url:o},r),u=i.query.extendMaxTTFB;return Al({url:o,xhrSetup:t.xhrSetup},n,u,null).pipe(sr(({responseText:e,responseURL:t,stats:i})=>{t=t||o;var r=performance.now(),n=sg.parseMediaOptionPlaylist(e,null!=t?t:o,d,{},a,s,Ys.Variant,l,0,!1,null),e=performance.now(),t=n["mediaOptionDetails"],e={playlistLoadTimeMs:i.tload-i.trequest,playlistParseTimeMs:e-r,tparsed:{tbegin:r,tend:e}};return{mediaOptionDetails:t,isDeltaPlaylist:n.isDeltaPlaylist,interstitials:[],bwSample:i,playlistSample:e}}),Yo(Ys.Variant,s,!1,o))}(i.itemId,t,r,o,e.url).pipe(iv(r,s,e.url,lg.Playlist),on(e=>{var t=e["mediaOptionDetails"];n.cachePrefetchDetails(s,t);var i=t.fragments[0],e=null!==(e=t.url)&&void 0!==e?e:so(t.relativeUrl,no.getBaseURL(a));return n.cachePrefetchSegment(r,s,t,i).pipe(iv(r,s,e,lg.Segment))}))}))}(t,s)).pipe(Wi(e=>(a.error(`Caught unhandled error in item prefetch path: ${JSON.stringify(e)}`),r.setPrefetchErrored(t.appItemId),Pr(og.ERRORED))))):Pr(og.DISABLED)}),kr(1),Br(()=>{})):Pr(og.DISABLED)})(s))),O.sessionData&&e.push(nr(Jl(M.gotPlaying$,e=>e),Li).pipe(on(()=>ur([O.sessionData$,this.hlsService.query.config$])),kr(1),on(([e,t])=>this.sessionDataLoader.loadSessionData(e,t)),cn(e=>{this.rootPlaylistService.setSessionData(O.itemId,e)}),Wi(e=>(this.logger.error(`SessionData err:${e.message}`),Cr)))),Vn(...e)})),_=[Ay(this.itemQueue,this.hlsService,s),L];null!=O.contentSteeringOption&&_.push(Pr(s).pipe((E=k,A=k.steeringManifestLoadPolicy,e=>e.pipe(on(i=>{const{logger:t,operationQueue$:r,rootPlaylistQuery:e,statsService:n,itemQueue:a,customUrlLoader:s,hlsService:o}=i,l=e["itemId"],d=e["rootPlaylistEntity"],u=d["contentSteeringOption"],c=new Map;if(null==u||!i.config.enableContentSteering)return $n;const h=n.getQueryForId(e.statsId),p=a.getQueueItemForId(l),m=new qr(3e5);let f=u["serverURI"],g=d["baseUrl"];const y=o.query.extendMaxTTFB;return Yl.pipe(on(()=>function(r,i,n,a,s,o,l,d,u,c){return Pn(()=>{var e=jl(r);if(null!=e)return Pr({responseText:Y.utf8arrayToStr(e),responseURL:r});const t=qs.parseURL(r),i=[];return t&&""!==t.query&&"?"!==t.query&&i.push(t.query.substr(1)),null!=o&&i.push(`_HLS_pathway=${encodeURIComponent(o)}`),null!=d&&z(d.avgBandwidth)&&i.push(`_HLS_throughput=${Math.round(d.avgBandwidth)}`),0<i.length&&t&&(t.query="?"+i.join("&"),r=qs.buildURLFromParts(t)),e=Go({url:r},a),Al({url:r,xhrSetup:n.xhrSetup},e,u,s)}).pipe(sr(({responseText:e,responseURL:t})=>({steeringManifest:xm(e,i,l,c),responseURL:t})))}(f,g,E,A,s,e.currentPathwayID,new Set([...c.keys()]),h.getBandwidthEstimate(E,null==p?void 0:p.serviceName),y,t)),cn(({steeringManifest:e,responseURL:t})=>{g=t,null!=e.reloadURI&&(f=e.reloadURI),m.next(1e3*e.ttl),e=function(s,o,l){const{config:d,logger:e,mediaLibraryService:u,mediaSink:t,rootPlaylistQuery:c,rootPlaylistService:h,mediaSelectionBossService:p}=s,m=t["mediaQuery"];return{operation:om.ContentSteering,priority:sm.Low,execute:(t,e,i,r)=>{var n=Pn(()=>(da(()=>{var e,t=o["pathwayPriority"],i=(r=c["rootPlaylistEntity"]).mediaOptionListTuple[Ys.Variant],r=null!==(e=o.pathwayClones)&&void 0!==e?e:[];(function(t=[],i=[]){if(t.length!==i.length)return!1;for(let e=0;e<t.length;e++)if(t[e]!==i[e])return!1;return!0})(i.pathwayPriority,t)&&!r.length||(e=d.enableBoss,i=d.enableContentSteering,e&&i&&(null==p||p.setTransformer(c.itemId,io.ContentSteeringPathwayCloner,new Qh(r,l))),h.doPathwaySwitch(c.itemId,t,l))}),Yl)).pipe(on(e=>ey(s,t,0,r).pipe(dn(iy(t,i,c,u,m,d))))),a=Pn(()=>Yl);return Un(()=>!1,Pn(()=>Yl),Rr(n,a))},logger:e}}(i,e,c),r.next(e)}),Wi(e=>(t.error("error in Content Steering epic:",e),Yl)),(v=()=>m.pipe(un(e=>0<e),on(e=>Ki(e))),mt(function(t,i){var r,n,a=!1,s=!1,o=!1,l=function(){return o&&s&&(i.complete(),!0)},d=function e(){o=!1,r=t.subscribe(Si(i,void 0,function(){o=!0,l()||(n||(n=new Er,v().subscribe(Si(i,function(){r?d():a=!0},function(){s=!0,l()}))),n.next())})),a&&(r.unsubscribe(),r=null,a=!1,e())};d()})));var v}),ln($n))))),F.enableBoss&&this._mediaSelectionBossService&&_.push((i=O,r=this._mediaSelectionBossService,i.hdrMode$.pipe(on(e=>{var t=new mh(i.hasHdrLevels,i.preferHDR);return null==r||r.setTransformer(i.itemId,io.HDRFilter,t),Cr}))),(b=O,T=this._mediaSelectionBossService,b.maxHdcpLevel$.pipe(on(e=>(e=new gh(e),null==T||T.setTransformer(b.itemId,io.HDCPFilter,e),Cr)))),(v=this.rootPlaylistService,S=O,I=this._mediaSelectionBossService,S.pathwayPenaltyBox$.pipe(on(e=>{var t;return null!=v&&v.isContentSteeringEnabled()&&(t=new ph(e),null==I||I.setTransformer(S.itemId,io.PathwayPenaltyBoxFilter,t),function(e,i){if(e.rootPlaylistEntity){const t=e.rootPlaylistEntity.mediaOptionListTuple[Ys.Variant].pathwayPriority;if(t&&t.find(t=>!i.find(e=>e.id===t))!==e.currentPathwayID)return!0}return!1}(S,e)&&v.doPathwaySwitch(S.itemId)),Cr}))),(g=O,y=this._mediaSelectionBossService,g.viewportInfo$.pipe(on(e=>(e=new fh(e),null==y||y.setTransformer(g.itemId,io.ViewportFilter,e),Cr)))),(c=O,h=this._mediaSelectionBossService,c.variantRemoved$.pipe(on(e=>(e=new uh(e),null==h||h.setTransformer(c.itemId,io.PermanentRemovalFilter,e),Cr)))),(d=O,u=this._mediaSelectionBossService,d.variantCompatibleIds$.pipe(on(e=>(e=new ch(e),null==u||u.setTransformer(d.itemId,io.CompatibleIdsFilter,e),Cr)))),(o=O,l=this._mediaSelectionBossService,o.variantPenaltyBox$.pipe(on(e=>(e=new hh(e),null==l||l.setTransformer(o.itemId,io.PenaltyBoxFilter,e),Cr)))),(p=O,m=this._mediaSelectionBossService,f=this.hlsConfig,N=p.enabledMediaOptionKeys$.pipe(xr((e,t)=>e[Ys.AltAudio].mediaOptionId===t[Ys.AltAudio].mediaOptionId&&e[Ys.Subtitle].mediaOptionId===t[Ys.Subtitle].mediaOptionId)),Qn([p.combinedAltAudioFilterChange$,p.combinedSubtitleFilterChange$,N]).pipe(on(([e,t,i])=>{const r=p.mediaOptionListQueries,n=p.getEnabledMediaOptionMask(),a=p.enabledVariantMediaOption,s=p.enabledMediaOptionKeys[Ys.AltAudio],o=Ro(s)?p.alternateMediaOptionById(Ys.AltAudio,s.mediaOptionId):null,l=Re.getStickyAtmosStatus(f.useStickyAtmosFilter,a.audioCodec,null==o?void 0:o.channels),d=r[Ys.AltAudio].mediaOptionFromId(i[Ys.AltAudio].mediaOptionId),u=r[Ys.Subtitle].mediaOptionFromId(i[Ys.Subtitle].mediaOptionId),c=new Uh(l,e,t,null==d?void 0:d.persistentID,null==u?void 0:u.persistentID,n,[null==u?void 0:u.backingMediaOptionId],!1),h=new Map([[io.ValidAlternatesFilter,c],[io.ErrorHandlingValidAlternatesFilter,c]]);return null==m||m.setMultipleTransformers(p.itemId,h),Cr}))),(t=this.rootPlaylistService,n=O,a=this._mediaSelectionBossService,n.currentPathwayID$.pipe(on(e=>(null!=t&&t.isContentSteeringEnabled()&&(null==a||a.setTransformer(n.itemId,io.MatchingPathwayFilter,new $h(e))),Cr))))),k.enableInterstitialPlayback&&_.push(this.interstitialController.postRollCheck$(M,s)),(this.inGaplessMode||k.enableInterstitialPlayback)&&_.push(this.itemQueue.playing$.pipe(_d(),xr((e,t)=>e.itemId===t.itemId),on(n=>{const a=this.rootPlaylistQueryFor(n.itemId);return Jl(a.rootPlaylistEntity$,e=>!!e).pipe(on(e=>{if(k.enableInterstitialPlayback){const e=this.interstitialService.interstitialQuery.playingInterstitialId,i=Zh(n),r=a.enabledAlternateMediaOptionByType(Ys.Subtitle);this.legibleSystemAdapter.handlePlayingItemChanged({playingInterstitialId:e,startTime:i,subtitleMediaOption:r});var t={itemId:n.itemId,isInterstitial:n.isInterstitial};this.trigger(j.ITEM_PLAYING,t)}return this.inGaplessMode&&Cl(n.itemId)&&!n.parentItemId?Pr(n):Cr}))}),Vr(),cn(([e,t])=>{var i=e.itemId,r=t.itemId,e=Zh(t),t={prevItemId:i,nextItemId:r,nextStartTime:e,nextDuration:M.msDuration-e};this.trigger(j.ITEM_TRANSITIONED,t),this.rtcService.itemTransitioned(i,r),this.legibleSystemAdapter.removeEarlierCues(e)}),ln(Cr))),P&&_.push(function(o){const{config:l,iframeClock:d,mediaSink:e}=s,u=e["mediaQuery"];return u.desiredRate$.pipe(on(s=>ep(s)?Ki(0,Math.abs(1e3/s)).pipe(sr(()=>{let e=null;const t=u.seekable;if(!d.isStarted||t.length<1)return e;var i=d.getCurrentTime().seconds,r=null!==(a=Zh(o.getQueueItemForTime(i)))&&void 0!==a?a:0;let n=t.start(0);z(n)||(n=0);var a=dy(u,l);return 1<s&&a<=i?(e={newRate:0,postFlushSeek:a},d.pause()):s<0&&i-r-n<s/-2&&(e={newRate:1,postFlushSeek:n}),e}),_d(),kr(1)):Cr))}(this.itemQueue).pipe(cn(({newRate:e,postFlushSeek:t})=>{this._setRateInternal(this.desiredRate,e,t)}))),this.inGaplessMode&&this.isPreloading&&_.push(M.timeupdate$.pipe(on(e=>{if(this.inGaplessMode&&this.isPreloading){var t=this.itemQueue.playingItem,i=this.itemQueue.loadingItem,r=this.itemQueue.activeItem,n=Zh(i);if(z(n)&&n<=e&&t!==r)return this.itemQueue.updatePlayingItemId(!k.enableInterstitialPlayback),this.traverseItemBoundary(i,this.interstitialController,O,w)}return Cr})));var N=x.loopCount;return z(N)&&0<N&&_.push(M.isBufferedToEnd$(k.maxBufferHole).pipe(_r(e=>e),sr(e=>{const t=this.itemQueue.activeItem,i=Zh(t),r=M.minSBDuration-i;if(Math.abs(r)<k.maxBufferHole)return null;var n=null==t?void 0:t.loopCount;if(z(n)&&0<n||n===1/0){const e=M.getBufferInfo(M.currentTime,F.maxBufferHole),k=[null!==(n=null===(n=e[Ys.Variant])||void 0===n?void 0:n.buffered.end)&&void 0!==n?n:0,null!==(n=null===(n=e[Ys.AltAudio])||void 0===n?void 0:n.buffered.end)&&void 0!==n?n:0],i=Object.assign(Object.assign({},cy(t,!1)),{itemStartOffsets:k,initialSeekTime:z(t.initialSeekTime)?t.initialSeekTime-Zh(t)+k[Ys.Variant]:NaN,parentItemId:null!==(n=t.parentItemId)&&void 0!==n?n:t.itemId,loopCount:t.loopCount-1,seekImmediately:!1});return{activeItem:t,nextItem:hy.createItem(t.name,t.url,this.hlsConfig,this.logger,!1,i)}}}),_d(),on(({nextItem:e})=>(da(()=>{this.itemQueue.insertQueueItem(e),this.itemQueue.setActive(e.itemId,e.itemStartOffsets,e.initialSeekTime)}),Cr)))),Vn(..._,D)})),q=this.itemQueue.removedItems$.pipe(pr(t=>{const i=[];return da(()=>{var e;this.mediaLibService.remove(t),this.rootPlaylistService.removeItems(t),this.rtcService.removeItemList(t),i.push(this.keySystemAdapter.removeItemsAndKeys(t,!1)),F.enableBoss&&(null===(e=this._mediaSelectionBossService)||void 0===e||e.destroyItems(t))}),i})),H=[];F.enableInterstitialPlayback&&H.push(this.interstitialController.playback$.pipe(cn(e=>{e&&F.forcePauseOnInterstitialBoundary&&this.setRate(0)}))),Vn(this._queueOpsChanged$.pipe(Sr(()=>0===this._queueOps.length?Cr:this._queueOps.shift())).pipe(Wi(e=>Cr)),B.pipe(Wi(e=>Cr)),U.pipe(Wi(this._handleError.bind(this))),Vn(N,q,Q,K,...H,$,this.teardownWG$).pipe(Wi(e=>this._handleError(e)))).pipe(Br(()=>{var e,t,i,r;try{this.detachMedia(),this.trigger(j.DESTROYING),this.playerEvents.destroy(),null===(e=this.accessLogInstance)||void 0===e||e.destroy(),null===(t=this.rtcController)||void 0===t||t.destroy(),F.enableBoss&&(null===(i=this._mediaSelectionBossService)||void 0===i||i.destroy()),this.mediaLibService.clear(),this.rootPlaylistService.removeAll(),this.statsService.destroy(),this.itemQueue.clearQueue(),c.removeEntity(this.sessionID),this.interstitialService.reset(),this.interstitialController.reset(),this._queueOps=[],this._rootQuery$.next(null),this._mediaElementQuery$.next(null),this._interstitialQuery$.next(null),null===(r=this._mediaParser)||void 0===r||r.reset(),this.hlsConfig.xhrSetup=void 0,this.accessLogInstance.reset()}catch(e){this.logger.error(`Got error in finalize ${e.message}`)}}),dn(Yr(this.destroy$))).subscribe()}get rootPlaylistQuery$(){return nr(this._rootQuery$.pipe(fa),Li)}get mediaElementQuery$(){return nr(this._mediaElementQuery$.pipe(fa),Li)}get interstitialQuery$(){return nr(this._interstitialQuery$.pipe(fa),Li)}get _activeRootQuery(){return this._rootQuery$.value}rootPlaylistQueryFor(e){return this.rootPlaylistService.getQueryForId(e)}get _mediaElementQuery(){return this._mediaElementQuery$.value}static get version(){return"2.510.3"}static get Events(){return j}static get ErrorTypes(){return U}static get ErrorDetails(){return V}get Events(){return sv.Events}get ErrorTypes(){return sv.ErrorTypes}get ErrorDetails(){return sv.ErrorDetails}static get DefaultConfig(){return n(Eo)}get DefaultConfig(){return sv.DefaultConfig}static isSupported(){try{const e=window.MediaSource||window.WebKitMediaSource,t=window.SourceBuffer||window.WebKitSourceBuffer,i=e&&"function"==typeof e.isTypeSupported&&e.isTypeSupported('video/mp4; codecs="avc1.42E01E,mp4a.40.2"'),r=!t||t.prototype&&"function"==typeof t.prototype.appendBuffer&&"function"==typeof t.prototype.remove;return!!i&&!!r}catch(e){return!1}}static loadRemoteConfigurations(e,t,i){var r,n,a,s={maxNumRetry:0,maxRetryDelayMs:0,retryDelayMs:0};return r=e,n={xhrSetup:i},a=Object.assign(Object.assign({},t),{autoRetry:!1,timeoutRetry:s,errorRetry:s}),Pn(()=>ll({url:r,xhrSetup:n.xhrSetup,method:"GET",responseType:"text",extendMaxTTFB:0},a).pipe(sr(([e])=>JSON.parse(e.responseText))))}replaceItemAction(e,t,i,r){if(!i||!e)return Yl;var n=i.mediaQuery.combinedBuffer.length;return n&&e.replaceItemAction==Ws.RESET_MEDIASOURCE?(t.updateItemById(e.itemId,{replaceItemAction:Ws.DO_NOTHING}),i.resetMediaSource(0),Yl):n&&e.replaceItemAction==Ws.FLUSH_ALL?(t.updateItemById(e.itemId,{replaceItemAction:Ws.DO_NOTHING}),i.flushAll(0,1/0).pipe(on(()=>Jl(this.mediaElementAdapter.mediaQuery.updating$,e=>!e)),sr(()=>{this.mediaElementAdapter.msDuration=0}))):Yl}traverseItemBoundary(t,i,e,r){let n=t.initialSeekTime;const a=r.mediaQuery,s=a.getBufferedSegmentsByType(Xs.Variant).find(e=>e.frag.itemId===t.itemId);return Jl(null!=s&&s.frag?Pr(s.frag):e.lastLoadedMediaOptionByType$(Ys.Variant),e=>!!e).pipe(on(e=>{if(null!=(e=null===(e=this.mediaLibService.getQueryForOption(e))||void 0===e?void 0:e.mediaOptionDetails)&&e.liveOrEvent){const t=gf(e,this.hlsConfig);n=Math.min(t,n)}return this.hlsConfig.enableInterstitialPlayback&&t.snapIn&&i&&(n=i.snapIn(t,e)),Jl(a.mediaElementDuration$,e=>(!z(n)||e>n)&&0<e).pipe(sr(e=>n<0?Math.max(Zh(t),e+n):n),sr(e=>this._seekAcrossJaggedSegment(Zh(t),e,a)),cn(e=>{z(e)&&e>=a.currentTime-this.hlsConfig.maxSeekHole&&r.seekWithOptions(e,void 0,!0,!1)}),ln(Cr))}))}_seekAcrossJaggedSegment(e,t,i){const r=z(t)?t:e,n=i.getCombinedBufferInfo(r,0).nextStart;if(z(n)){const e=i.getBufferedSegmentsByType(Xs.Variant).find(e=>e.startPTS<=r&&e.endPTS>r);e&&e.startPTS<=n&&e.endPTS>n&&(t=n)}return t}commitAlternateMatchingInfo(e){var t=null===(t=null===(t=this.hlsService.query.alternateMatchingInfo)||void 0===t?void 0:t.audioMatchingInfo)||void 0===t?void 0:t.persistentId;z(t)&&(this.audioSelectedPersistentID=t),z(t=null===(t=null===(t=this.hlsService.query.alternateMatchingInfo)||void 0===t?void 0:t.subtitleMatchingInfo)||void 0===t?void 0:t.persistentId)&&(this.subtitleSelectedPersistentID=t),this.commitedEarlyAlternateSelection=!0}_handleError(e){var t;try{var i,r=e.message;if(this.logger.error(`Got unhandled or fatal error ${r}`),i=e instanceof v?e:new B(!0,e.message,G.InternalError,e.stack),null===(t=this.rtcService)||void 0===t||t.handleFatalError(i,this.interstitialActive,this.itemQueue.playingItem.url),i.fatal&&this.isPreloading&&!this.hlsConfig.enableInterstitialPlayback&&this.dequeueSource("FatalErrorWhileLoading"),i.fatal)return this.interstitialController.handleError(i).pipe(cn(({handled:e,error:t})=>{e&&this.trigger(j.ERROR,Object.assign(Object.assign({},t),{fatal:!1,interstitial:!0}))}),_r(({handled:e,error:t})=>!e&&t.fatal),pr(({error:e})=>this.mediaElementAdapter&&this.mediaElementAdapter.mediaQuery.gotPlaying?Jl(this.mediaElementAdapter.mediaQuery.stallInfo$,e=>null!=e).pipe(Mr(e)):Pr(e)),pr(e=>(this.trigger(j.ERROR,e),Cr)));this.trigger(j.ERROR,i)}catch(e){throw this.logger.error(`Error thrown inside _handleError ${e.message}`,e),e}return Cr}playbackInfo(r,n){var a,s;const o=this.mediaElement$.getValue();if(o){let e=NaN;if(n.isPlayingAtLive){const u=n.liveSeekableRange,r=u.edge;e=(a=C(r+(performance.now()-u.tupdate)/1e3,r)-n.currentTime,s=Math.pow(10,3),Math.round(a*s)/s)}const l=o.readyState>=o.HAVE_FUTURE_DATA,d={readyToPlay:l,playbackLikelyToKeepUp:n.haveEnough&&l,rate:o.playbackRate,paused:o.paused,position:o.currentTime,duration:o.duration,seekableTimeRanges:this.seekableTimeRanges.map(e=>[e.start,e.end]),loadedTimeRanges:km.timeRangeToArray(o.buffered),interstitialActive:this.interstitialActive,liveEdgeDistance:e};let t=0,i=0;if(km.isHtmlVideoElement(o)){const u=o.getVideoPlaybackQuality;if(u&&typeof u==typeof Function){const u=o.getVideoPlaybackQuality();t=d.droppedVideoFrames=u.droppedVideoFrames,d.corruptedVideoFrames=u.corruptedVideoFrames,d.totalVideoFrames=u.totalVideoFrames,i=d.totalVideoFrames-t}}else km.isWebkitMediaElement(o)&&(t=d.droppedVideoFrames=o.webkitDroppedFrameCount,i=d.decodedFrameCount=o.webkitDecodedFrameCount);r.enablePerformanceLogging&&n.getCombinedMediaSourceBufferInfo(r.maxBufferHole),null===(r=this.rtcService)||void 0===r||r.handlePlaybackInfo(t,i,e,n.bufferedRangeTuple)}}get currentItem(){return this.isPreloading?this.playingItem:this.itemQueue.activeItem}get realCurrentTime(){var e,t;const i=this._mediaElementQuery;if(!i){const t=this.itemQueue.activeItem;return null!==(e=null==t?void 0:t.initialSeekTime)&&void 0!==e?e:NaN}if(this.iframeClock.isStarted){const e=i.seekable,t=0<e.length?C(e.start(0),0):0,r=dy(i,this.hlsConfig),n=this.iframeClock.getCurrentTime().seconds;return Math.max(t,Math.min(r,n))}let r=i.desiredPos;const n=Zh(this.playingItem);if(z(r)&&z(n))if(this.hlsConfig.enableInterstitialPlayback)if(this.interstitialActive){const e=this.interstitialService.interstitialQuery,i=e.playingInterstitialId;r-=(null!==(t=e.realCurrentTimeOffsetMap[i])&&void 0!==t?t:[0,0])[Ys.Variant]}else r-=n;else r-=n;return Math.max(0,r)}set realCurrentTime(e){var t=Zh(this.playingItem);!this.hlsConfig.enableInterstitialPlayback&&z(t)&&(e+=t),this.seekTo=e}get realDuration(){return this._mediaElementQuery?this._mediaElementQuery.primaryContentMediaElementDuration:1/0}get bufferedDuration(){var e;const t=this._mediaElementQuery;return null!==(e=null==t?void 0:t.getBufferedDuration())&&void 0!==e?e:0}get sessionData(){var e=this._activeRootQuery;return null==e?void 0:e.sessionData}get supportedFrameRates(){const e=this.hlsConfig.trickPlaybackConfig["enabled"],t=this.hlsConfig["liveAllowTrickplay"],i=[0,1],r=this._activeRootQuery,n=this.mediaLibService.query;return e&&r&&n.getEntity(r.itemId)&&(n.getEntity(r.itemId).liveOrEvent&&!t||i.push(8,24,48,96)),i}loadSource(e,i,t){i&&Object.keys(i).filter(e=>0<=["itemId","streamID"].indexOf(e)).reduce((e,t)=>t in i?Object.assign(e,{[t]:i[t]}):e,{}),this._queueOps=[Pn(this._endItemAndLoadInternal.bind(this,{url:e,itemOptions:i,initialSeekTime:t}))],this._queueOpsChanged$.next()}generateItemId(e){return null!=e?e:ba()}_loadSourceInternal(e,t={},i){var r,n,a,s,o,l;if("playready"===this.hlsConfig.keySystemPreference&&!this.hlsConfig.enablePlayReadyKeySystem)throw new B(!0,"Playready key system is not supported now",G.UnsupportedKeySystemError);if(!e||!e.trim().length)throw new B(!0,"Empty loadSource url",G.EmptyLoadSourceError);if(e=no.buildAbsoluteURL(window.location.href,e,{alwaysNormalize:!0}),null!==(l=null==t?void 0:t.appData)&&void 0!==l&&l.reportingAgent&&(this.reportingAgent=t.appData.reportingAgent),null!=t&&t.userInfo&&(this.userInfo=t.userInfo),null===(s=this.accessLogInstance)||void 0===s||s.setupReporter(null==t?void 0:t.appData),null!=t&&t.platformInfo&&this.platformService.updatePlatformInfo(t.platformInfo),function(e,t){if(t){const t=oo(e);return void 0!==lo.find(e=>new RegExp(e).exec(null!=t?t:""))}return!1}(e,this.hlsConfig.enableQueryParamsForITunes)){const d={language:t.language,dsid:t.dsid,subs:t.subs};r=e,n=null==t?void 0:t.platformInfo,a=d,o=n.model,l=n.manufacturer,o&&l&&(s=r,o=n.model,l=n.manufacturer,n=-1!==s.indexOf("?"),o=encodeURIComponent(null!=o?o:""),l=encodeURIComponent(null!=l?l:""),r=(s=n?s:s+"?")+uo.deviceName+l+uo.deviceModel+o),e=r=function(e,t){var i;let r;for(r in e=-1!==e.indexOf("?")?e:e+"?",t)t[r]&&(e+=uo[r]+("subs"===r?encodeURIComponent(null!==(i=t[r])&&void 0!==i?i:""):t[r]));return e}(r,a)}this.commitedEarlyAlternateSelection=!1,i={initialSeekTime:i,platformInfo:null==t?void 0:t.platformInfo,clientName:null===(i=null==t?void 0:t.appData)||void 0===i?void 0:i.clientName,serviceName:null===(i=null==t?void 0:t.appData)||void 0===i?void 0:i.serviceName,appItemId:null==t?void 0:t.itemId,appName:null===(i=null==t?void 0:t.appData)||void 0===i?void 0:i.appName,loopCount:null==t?void 0:t.loopCount,replaceItemAction:null==t?void 0:t.replaceItemAction},t=this.generateItemId(null==t?void 0:t.itemId),this.itemQueue.setQueueItem(t,e,this.hlsConfig,i,!1)}prefetchSource(e,t,i){if(null==t||!t.itemId)return!1;var r=this.generateItemId(null==t?void 0:t.itemId),t={itemStartOffsets:[0,0],initialSeekTime:i,platformInfo:null==t?void 0:t.platformInfo,clientName:null===(i=null==t?void 0:t.appData)||void 0===i?void 0:i.clientName,serviceName:null===(i=null==t?void 0:t.appData)||void 0===i?void 0:i.serviceName,appItemId:null==t?void 0:t.itemId,appName:null===(i=null==t?void 0:t.appData)||void 0===i?void 0:i.appName,loopCount:null==t?void 0:t.loopCount};return this.itemQueue.addPrefetchItem(r,e,this.hlsConfig,!1,t),!0}queueSource(e,t,i){var r;null!=t&&t.userInfo&&(this.userInfo=t.userInfo);const n=null===(r=this._mediaElementQuery)||void 0===r?void 0:r.getBufferInfo(null===(r=this._mediaElementQuery)||void 0===r?void 0:r.currentTime,0),a=Lo.map(e=>null!==(e=null===(e=n[e])||void 0===e?void 0:e.buffered.end)&&void 0!==e?e:0),s={itemStartOffsets:a,initialSeekTime:i,platformInfo:null==t?void 0:t.platformInfo,clientName:null===(i=null==t?void 0:t.appData)||void 0===i?void 0:i.clientName,serviceName:null===(i=null==t?void 0:t.appData)||void 0===i?void 0:i.serviceName,appItemId:null==t?void 0:t.itemId,appName:null===(i=null==t?void 0:t.appData)||void 0===i?void 0:i.appName,loopCount:null==t?void 0:t.loopCount},o=this.generateItemId(null==t?void 0:t.itemId);this.itemQueue.addQueueItem(o,e,this.hlsConfig,!1,s)}dequeueSource(e="ApplicationInitiated"){if(!this.hlsConfig.enableInterstitialPlayback)return this.hlsConfig.supportGaplessVideo||this.isPreloading||"InvalidFormat"!==e||!this.isFirstItem?void(this.isPreloading&&(this._queueOps.push(this._dequeueSource(e)),this._queueOpsChanged$.next())):(this.logger.error("First item has invalid format for gapless. Probably video. Disabling gapless."),void(this.gaplessCapable=!1))}_dequeueSource(e="ApplicationInitiated"){const t=this.loadingItem.url,i=this.loadingItem.itemId,r=Zh(this.loadingItem);return this.mediaElementAdapter.flushAll(r,1/0).pipe(cn(()=>{this.mediaElementAdapter.msDuration=r,this.legibleSystemAdapter.removeLaterCues(this.mediaElementAdapter.msDuration),this.itemQueue.resetLoadingItem(),"InvalidFormat"!==e&&"FatalErrorWhileLoading"!==e||(this.gaplessCapable=!1),this.triggerItemEvicted({url:t,itemId:i},e)}))}triggerItemEvicted(e,t){null!==e?(t={url:e.url,evictedItemId:e.itemId,reason:t},Object.assign(Object.assign({},t),{url:f(e.url)}),this.trigger(j.ITEM_EVICTED,t)):this.logger.error("dequeueSource called with no playing or loading item")}endSource(){if(this.gaplessCapable=!1,this.isPreloading){const e=Zh(this.loadingItem);this.mediaElementAdapter.flushAndCallback(e,1/0,()=>{this.mediaElementAdapter.msDuration=e,this.legibleSystemAdapter.removeLaterCues(this.mediaElementAdapter.msDuration),this.itemQueue.resetLoadingItem()})}}get inGaplessMode(){return this.hlsConfig.gapless&&this.gaplessCapable}get isPreloading(){return this.itemQueue.isPreloading()}get isFirstItem(){return this.itemQueue.isFirstItem}get loadingItem(){return this.itemQueue.loadingItem}get playingItem(){return this.itemQueue.playingItem}get primaryItem(){let e=this.playingItem.itemId;var t;return this.hlsConfig.enableInterstitialPlayback&&this.playingItem.isInterstitial&&(this.currentItem.isInterstitial||(e=this.currentItem.itemId),(t=this.itemQueue.primaryItem)&&(e=t.itemId)),e}get url(){return this.playingItem?this.playingItem.url:this.loadingItem?this.loadingItem.url:void 0}destroy(){const t=this["logger"];return this.destroy$.next(),null!=this.rpcService&&(this.teardownWG$.add(),this.rpcService.teardown(e=>{e&&t.error("RPCService teardown error:",e),this.teardownWG$.done()}),this.rpcService=null),this.toggleLogging(!1),this.iframeClock.stop(),this.teardownWG$.toPromise()}attachMedia(e){this.trigger(j.MEDIA_ATTACHING,{media:e}),this.mediaElement$.next(e),this.trigger(j.MEDIA_ATTACHED,{media:e})}detachMedia(){var e;this.mediaElement$.getValue()&&(this._pipelineCtx$.next(void 0),this.trigger(j.MEDIA_DETACHING),null===(e=this.rtcService)||void 0===e||e.detachMedia(),this.iframeClock.stop(),this.mediaElement$.next(null),this.trigger(j.MEDIA_DETACHED))}handleResolvedUri(e,t){this.customUrlLoader.setCustomUrlResponse(e,{uri:t.uri,response:t})}get levels(){var e;return null!==(e=null===(e=this._activeRootQuery)||void 0===e?void 0:e.mediaOptionListQueries[Ys.Variant].filteredMediaOptionList)&&void 0!==e?e:[]}get audioTracks(){var e;return null!==(e=null===(e=this._activeRootQuery)||void 0===e?void 0:e.mediaOptionListQueries[Ys.AltAudio].filteredMediaOptionList)&&void 0!==e?e:[]}get audioMediaOptions(){var e;return null!==(e=null===(e=this._activeRootQuery)||void 0===e?void 0:e.audioMediaSelectionOptions)&&void 0!==e?e:[]}get subtitleMediaOptions(){var e;return null!==(e=null===(e=this._activeRootQuery)||void 0===e?void 0:e.subtitleMediaSelectionOptions)&&void 0!==e?e:[]}getAudioMediaOptionsForItem(e){return null!==(e=this.rootPlaylistQueryFor(e).audioMediaSelectionOptions)&&void 0!==e?e:[]}getSubtitleMediaOptionsForItem(e){return null!==(e=this.rootPlaylistQueryFor(e).subtitleMediaSelectionOptions)&&void 0!==e?e:[]}get playbackLikelyToKeepUp(){var e;return null!==(e=null===(e=this._mediaElementQuery)||void 0===e?void 0:e.playbackLikelyToKeepUp)&&void 0!==e&&e}bufferedRangesForPlayerType(e){if(!this._mediaElementQuery)return[];const o=e===Js.Interstitial,t=this._mediaElementQuery.getBufferedSegmentsByType(Xs.Variant).reduce((e,t)=>{var i=this.itemQueue.getQueueItemForId(t.frag.itemId);if(i.isInterstitial===o){const o=Zh(i),r=z(i.initialSeekTime)?i.initialSeekTime:0,n=Math.max(0,r-o),a=null!==(i=t.appendStart)&&void 0!==i?i:0,s=null!==(t=t.appendEnd)&&void 0!==t?t:0;e.push({start:Math.max(0,a-o+n),end:Math.max(0,s-o+n)})}return e},[]);return qh.getBufferedTimeRanges(t,this.hlsConfig.maxBufferHole)}seekableTimeRangesForPlayerType(e){if(e!==Js.Interstitial)return 0===this._mediaElementQuery.getBufferedSegmentsByType(Xs.Variant).filter(e=>!(null!=(e=this.itemQueue.getQueueItemForId(e.frag.itemId))&&e.isInterstitial)).length?[{start:0,end:this.realDuration}]:this.seekableTimeRanges.map(e=>{var t=this.itemQueue.getQueueItemForTime((e.end-e.start)/2);return t?(t=Zh(t),{start:Math.max(0,e.start-t),end:e.end-t}):e});{const t=this.interstitialService.interstitialQuery,i=[],r=null!==(e=t.playingInterstitialId)&&void 0!==e?e:t.activeInterstitialId;if(r){const n=t.getInterstitialForId(r);n&&i.push({start:0,end:null!==(e=n.duration)&&void 0!==e?e:0})}return i}}set desiredRate(e){null!=e&&this.setRate(e)}get desiredRate(){var e;return null!==(e=null===(e=this._mediaElementQuery)||void 0===e?void 0:e.desiredRate)&&void 0!==e?e:0}get effectiveRate(){var e;return null!==(e=null===(e=this._mediaElementQuery)||void 0===e?void 0:e.effectiveRate)&&void 0!==e?e:0}get iframeMode(){var e;return null!==(e=null===(e=this._mediaElementQuery)||void 0===e?void 0:e.isIframeRate)&&void 0!==e&&e}get accessLog(){var e;if(!this.accessLogInstance||!this._activeRootQuery)return[];var t=this._activeRootQuery.itemId,i=this.itemQueue.getQueueItemForId(t),t=null!==(i=null!==(e=null==i?void 0:i.parentItemId)&&void 0!==e?e:null==i?void 0:i.itemId)&&void 0!==i?i:t;return this.accessLogInstance&&this._activeRootQuery?this.accessLogInstance.getAccessLog(t):[]}get errorLog(){return this.accessLogInstance?this.accessLogInstance.errorLog:[]}setRate(e){this.logger.child({name:"iframes"});const t=this.desiredRate;if(e===t)return-2;if(!this.mediaElementAdapter||isNaN(e))return-1;e=Number(e);const i=Math.abs(e);if(!this.supportedFrameRates.some(e=>e===i))return-3;if(ep(e)){if(this.interstitialActive)return-1;if(this.playingItem&&this.playingItem.itemId!==this.itemQueue.activeItem.itemId){const t=this.rootPlaylistService.getQueryForId(this.playingItem.itemId);if(null==t||!t.mediaOptionListQueries[Ys.Variant].hasIframes)return-1;if(this.loadingItem&&this.loadingItem.isInterstitial)return this.interstitialController.cancelInterstitial(this.realCurrentTime,e,!0),0}const t=this._activeRootQuery;if(null==t||!t.mediaOptionListQueries[Ys.Variant].hasIframes)return-1}return this._setRateInternal(t,e),0}_setRateInternal(e,t,i){const r=ep(e),n=ep(t),a=this.mediaElementAdapter;if(n?this.iframeClock.start({rootTimeSeconds:null!=i?i:this.realCurrentTime,rate:t}):this.iframeClock.stop(),n||r!==n){const r=this._pipelineCtx$.value;r&&this.operationQueue$.next(this._makeRateChangeOp(r,e,t,i))}else a.desiredRate=t}toggleLogging(e){this.loggingEnabled.next(e)}_makeRateChangeOp(l,d,u,c){return{operation:om.RateChange,priority:sm.High,execute:(e,t,i,r)=>Pn(()=>{const{mediaSink:e,config:t,rootPlaylistQuery:i}=l,r=e.mediaQuery,n=ep(d),a=ep(u);let s,o=NaN;if(a!==n){const l=e.mediaQuery;if(o=a?l.getBufferInfo(0,0)[Ys.Variant].buffered.end:C(c,this.iframeClock.getCurrentTime().seconds),t.enableInterstitialPlayback&&z(o)){const l=a?1/0:0,d=this._currentMediaOptionDetails;o=this.interstitialController.getAdjustedSeek(o,l,e.mediaQuery,!a,null==d?void 0:d.pdtToMSN,null==d?void 0:d.fragments).adjustedSeek}s=Pn(()=>(e.haveEnough=!1,e.pause(),e.flushAll(0,1/0)))}else if(a){const l=1/this.config.trickPlaybackConfig.minIframeDuration;s=e.flushData(Xs.Variant,r.currentTime+l,1/0)}if(e.desiredRate=u,a!==n&&(jf(to.IframeModeChange,i.enabledVariantMediaOption,l),e.toggleTrickPlaybackMode(a)),null==s)return z(o)&&(this.mediaElementAdapter.seekTo=o),Yl;{const l=[s];return z(o)&&l.push(Pn(()=>r.flushing?(e.seekTo=o,Yl):Yr([Jl(r.seekTo$.pipe(an(1)),e=>z(null==e?void 0:e.pos)),Jl(r.updating$,e=>!e).pipe(cn(()=>this.mediaElementAdapter.seekTo=o))]))),Ln(l)}}).pipe(on(()=>ey(l,e,0,r).pipe(dn(iy(e,i,l.rootPlaylistQuery,l.mediaLibraryService,l.mediaSink.mediaQuery,l.config))))),logger:l.logger}}set skip(e){this._mediaElementQuery&&(this.iframeClock.isStarted&&this.iframeClock.start({rootTimeSeconds:this.realCurrentTime+e,rate:this.desiredRate}),this.realCurrentTime=Math.max(0,this.realCurrentTime+e))}gaplessSeekTo(e){const t=Zh(this.playingItem);if(z(t)&&e<t&&(e=t),this.isPreloading){e>Zh(this.loadingItem)&&(e=Zh(this.loadingItem));const t=this._mediaElementQuery.getBufferInfo(this._mediaElementQuery.currentTime,this.hlsConfig.maxBufferHole)[Ys.Variant];t&&e<t.buffered.start&&this.dequeueSource("SeekToUnbufferedTimeRanges")}this.hlsService.setUserSeek(e)}interstitialSeekTo(e){var t,i=this.itemQueue.activeItem;if(!i)return e;const r=i.isInterstitial?Js.Interstitial:Js.Primary,n=this.realCurrentTime,a=this._currentMediaOptionDetails,{adjustedSeek:s,newItemId:o,startOffset:l}=this.interstitialController.getAdjustedSeek(e,n,this._mediaElementQuery,!1,null==a?void 0:a.pdtToMSN,null==a?void 0:a.fragments,this.seekableTimeRangesForPlayerType(r));if((s<n||0===s)&&!this.interstitialActive){const e=(null!==(t=null===(t=this._mediaElementQuery)||void 0===t?void 0:t.getBufferedSegmentsByType(Xs.Variant))&&void 0!==t?t:[]).find(e=>{var t=this.itemQueue.getQueueItemForId(e.frag.itemId);return null!==(t=null==t?void 0:t.isInterstitial)&&void 0!==t&&t&&s<e.appendStart&&this._mediaElementQuery.currentTime>e.appendStart});if(e||o)return this.interstitialController.reset(),void this.mediaElementAdapter.flushAndCallback(Math.max(s-1,0),1/0,()=>{o&&this.itemQueue.setActive(o,[l,l],s,!0)})}else if((null===(t=this.playingItem)||void 0===t?void 0:t.itemId)!==i.itemId&&(null===(t=this.playingItem)||void 0===t||!t.isInterstitial)&&s>=e){const d=wl(i.itemId)||wl(null===(i=this.itemQueue.loadingItem)||void 0===i?void 0:i.itemId);if(d){const u=this.interstitialService.interstitialQuery.getInterstitialForId(d),c=this.interstitialController.getInterstitialStartTime(u,null==a?void 0:a.pdtToMSN,null==a?void 0:a.fragments);if(s>c)return void this.interstitialController.cancelInterstitial(e,null,!0)}}this.hlsService.setUserSeek(s)}set seekTo(e){var t=Number(e);z(t)?this.hlsConfig.enableInterstitialPlayback?this.interstitialSeekTo(t):this.inGaplessMode?this.gaplessSeekTo(t):(this.iframeClock.isStarted&&this.iframeClock.start({rootTimeSeconds:t,rate:this.desiredRate}),this.hlsService.setUserSeek(t)):this.logger.error(`[seek] got invalid seek value ${e}`)}seekToDate(e){this.hlsService.setUserSeek(e)}get availableProgramDateTime(){return new Map(this._currentDateToMediaTimeArray)}get _currentDateToMediaTimeArray(){var e,t=this._currentMediaOptionDetails;if(!t)return[];const i=this.primaryItem,r=this.itemQueue.getQueueItemForId(i),n=null!==(e=null==t?void 0:t.pdtToMSN)&&void 0!==e?e:[],a=this.hlsConfig.enableInterstitialPlayback?Zh(r):0,s=null!==(e=null==t?void 0:t.fragments)&&void 0!==e?e:[],o=null==t?void 0:t.startSN;return 0===n.length||0===s.length?[]:n.map(([e,t])=>[e,(null===(t=s[t-o])||void 0===t?void 0:t.start)-a])}get _currentMediaOptionDetails(){if(this._activeRootQuery&&this.playingItem){var e=this.primaryItem;return this.itemQueue.getQueueItemForId(e),(e=this.rootPlaylistService.getQueryForId(e).lastLoadedMediaOptionByType(Ys.Variant))&&Ro(e)?this.mediaLibService.getQueryForOption(e).mediaOptionDetails:void 0}}get playingDate(){var e=this._currentMediaOptionDetails;if(e){var t=this.primaryItem,t=this.itemQueue.getQueueItemForId(t),t=this.hlsConfig.enableInterstitialPlayback?Zh(t):0;return function(e,t,i){if(e&&0!==e.length){var[e,t]=function(t,e,i){if(!(Array.isArray(e)&&Array.isArray(i)&&e.length&&i.length))return[];var[r,e]=null!==(r=h(e,([,e])=>i[e-i[0].mediaSeqNum].start<=t))&&void 0!==r?r:e[0];return z(e=null!==(e=null===(e=i[e-i[0].mediaSeqNum])||void 0===e?void 0:e.start)&&void 0!==e?e:NaN)?[r,e]:[]}(i,e,t);return z(t=e+1e3*(i-t))?new Date(t):void 0}}(e.pdtToMSN,e.fragments,this.realCurrentTime+t)}}get seekableTimeRanges(){var e;return null!==(e=null===(e=this._mediaElementQuery)||void 0===e?void 0:e.seekableTimeRanges)&&void 0!==e?e:[]}get isLive(){if(!this.playingItem)return!1;var e=this.playingItem.isInterstitial?this.playingItem.parentItemId:this.playingItem.itemId;return null!==(e=null===(e=this.mediaLibService.query.getEntity(e))||void 0===e?void 0:e.liveOrEvent)&&void 0!==e&&e}get isPlayingAtLive(){var e;return null!==(e=null===(e=this._mediaElementQuery)||void 0===e?void 0:e.isPlayingAtLive)&&void 0!==e&&e}set variantId(e){}selectPersistentID(t,e,i){var r;const n=this._activeRootQuery,a=null===(r=this.playingItem)||void 0===r?void 0:r.itemId;if(!n||Cl(a)){const r=null==n?void 0:n.itemId;!n||Cl(r)?t===Ys.AltAudio?this.primaryAudioSelectedPersistentID=e:this.primarySubtitleSelectedPersistentID=e:(this.logger.error(`[${Mo[t]}] reloading playingItem ${a} to load persistentID ${e}`),da(()=>{this.updateMatchingInfoWithSelectedMediaArray(a,i);const e={parentItemId:this.playingItem.parentItemId,itemId:this.playingItem.itemId};t===Ys.AltAudio?e.userSwitchAudioTrack=!0:e.userSwitchSubtitleTrack=!0,this.reloadPlayingItem(e)}))}else this.logger.error(`[${Mo[t]}] attempting to set persistentID ${e} when playing interstitial ${a}`)}get audioSelectedPersistentID(){var e;return null===(e=null===(e=this.hlsService.query.alternateMatchingInfo)||void 0===e?void 0:e.audioMatchingInfo)||void 0===e?void 0:e.persistentId}set audioSelectedPersistentID(e){var t=[{MediaSelectionGroupMediaType:eo.AUDIO,MediaSelectionOptionsPersistentID:e}];this.selectPersistentID(Ys.AltAudio,e,t)}set primaryAudioSelectedPersistentID(t){var e;const i=this._activeRootQuery,r=null==i?void 0:i.mediaOptionListQueries[Ys.AltAudio].filteredMediaOptionList,n=null==i?void 0:i.itemId;if(r)t!==(null===(e=i.enabledAlternateMediaOptionByType(Ys.AltAudio))||void 0===e?void 0:e.persistentID)&&(e={itemId:n,language:null==(e=r.find(e=>e.persistentID===t))?void 0:e.lang,name:null==e?void 0:e.name,persistentId:t},this.hlsService.setAudioAlternateMatchingInfo(e),e=this.hlsService.query.alternateMatchingInfo,this.rootPlaylistService.setEnabledMediaOptionTupleWithMatchedGroups(n,Ys.AltAudio,e,this.rootPlaylistService,{userInitiated:!0,triggerEvent:!0}));else if(z(t)&&!(t<0)){const a={itemId:n,language:void 0,name:void 0,persistentId:t};this.hlsService.setAudioAlternateMatchingInfo(a)}}get subtitleSelectedPersistentID(){var e;return null===(e=null===(e=this.hlsService.query.alternateMatchingInfo)||void 0===e?void 0:e.subtitleMatchingInfo)||void 0===e?void 0:e.persistentId}set subtitleSelectedPersistentID(e){var t=[{MediaSelectionGroupMediaType:eo.SUBTITLE,MediaSelectionOptionsPersistentID:e,MediaSelectionOptionsDisplaysNonForcedSubtitles:Zs.YES}];this.selectPersistentID(Ys.Subtitle,e,t)}set primarySubtitleSelectedPersistentID(t){const e=this._activeRootQuery,i=null==e?void 0:e.mediaOptionListQueries[Ys.Subtitle].filteredMediaOptionList;if(i){if(t!==(null===(n=e.enabledAlternateMediaOptionByType(Ys.Subtitle))||void 0===n?void 0:n.persistentID)){var r=e.itemId;if(0!==i.length||z(t)&&!(t<0))if(z(t)&&-1!==t){const a=i.find(e=>e.persistentID===t),e={itemId:r,language:null==a?void 0:a.lang,name:null==a?void 0:a.name,forced:null==a?void 0:a.forced,persistentId:t};this.hlsService.setSubtitleAlternateMatchingInfo(e);var n=this.hlsService.query.alternateMatchingInfo;this.rootPlaylistService.setEnabledMediaOptionTupleWithMatchedGroups(r,Ys.Subtitle,n,this.rootPlaylistService,{userInitiated:!0})}else this.hlsService.setSubtitleAlternateMatchingInfo(null),this.rootPlaylistService.setEnabledMediaOptionByType(r,Ys.Subtitle,wo)}}else if(z(t)&&!(t<0)){const a={language:void 0,name:void 0,forced:void 0,persistentId:t};this.hlsService.setSubtitleAlternateMatchingInfo(a)}}get iframeVariants(){var e;return null!==(e=null===(e=this._activeRootQuery)||void 0===e?void 0:e.rootPlaylistEntity.iframeVariants)&&void 0!==e?e:[]}loadImageIframeData$(n,a){var e;return Yr([this.rootPlaylistQuery$.pipe(kr(1),on(t=>{var e=this.itemQueue.playingItem.itemId;let i;this.config.enableBoss&&(i=this._mediaSelectionBossService.getQuery(e,this.logger));const r=function(e,t,i){if(!e)throw new TypeError("Expected variant array");if(!(i=t?e.find(e=>e.mediaOptionId===t):i?i.variantFor(ro.ImageVariant):e[0]))throw new Error(`Could not find image I-frame variant "${t}" of ${e.length} avaiable variants`);return i}(null==t?void 0:t.rootPlaylistEntity.iframeVariants,null==a?void 0:a.variantId,i);return function(a,s,o,l,d,u,c,h,p,m){if(null==a||!Ro(a))return Pr(null);const e=a["itemId"],t=l.getQueryForOption(a);t.hasEntity(e)||l.createMediaLibraryEntity(e);const f=t.mediaOptionDetails;if(f&&("VOD"===f.type||f.liveOrEvent&&!Wf(f,t.mediaOptionDetailsEntity.lastUpdateMillis)))return l.setLastAccessed(a),Pr(f);var i=l.inFlightDetails;return null!==i&&ko(i.mediaOption,a)?i.request:(i=Pn(()=>{var{playlistLoadPolicy:e,keySystemPreference:t}=h,i=s.masterVariableList,r=c.query.extendMaxTTFB,n=a.mediaOptionType;return l.setDetailsLoading(a),hg(a,s.baseUrl,s.itemStartOffsets[n],h,h,e,p,m,t,i,r,f).pipe(sr(Mg(a,s,o,l,d,u,h,m)),Wi(e=>{if(f)return Pr(f);throw e}),Br(()=>{l.inFlightDetails=null,l.setDetailsLoading(a,!1)}))}).pipe(tn()),l.inFlightDetails={mediaOption:a,request:i},i)}(r,t,this.rootPlaylistService,this.mediaLibService,this.interstitialService,this.statsService,this.hlsService,this.hlsConfig,this.customUrlLoader,this.logger).pipe(kr(1),on(e=>function(e,i,t,r,n=0,a){const s=i.fragments,o=e+(z(n)?n:0),l=Math.min(1,Math.max(0,null!==(a=null==a?void 0:a.snapToNextFrameFactor)&&void 0!==a?a:0));let d=vl.search(s,e=>{var t=e.start,i=e.duration,e=o+i*l;return t<=e&&e<t+i?0:e-t});if(!d){let e,t;if(s.length){const i=s[s.length-1];e=s[0].start,t=i.start+i.duration,o<t&&o+1>e?d=s[0]:o>e&&o-1<t&&(d=s[s.length-1])}if(!d)return Lr(new Error(`Could not find fragment at pos ${o} in playlist "${i.mediaOptionId}" [${e}-${t}]`))}return cl(d,i.url||"",t,t.fragLoadPolicy,r).pipe(sr(({mediaFragment:e,loadedData:t,bwSample:i})=>n?[Object.assign(Object.assign({},e),{start:e.start-n}),t,i]:[e,t,i]))}(n,e,this.hlsConfig,this.customUrlLoader,(this.logger,t.itemStartPosition),a)),sr(e=>function([e,t,i],r){if(!(t=De.findBox(new Uint8Array(t),["mdat"])).length)throw new Error("could not find mdat");return{fragment:e,data:t[0],stats:i,variant:r}}(e,r)))}),fn(null!==(e=null==a?void 0:a.timeoutMs)&&void 0!==e?e:5e3)),this.destroy$]).pipe(sr(e=>{if(!e)throw new Error("Player destroyed");return e}))}get selectedMediaArray(){return this._activeRootQuery?this.getSelectedMediaArrayFromMatchingInfo():[]}set selectedMediaArray(e){this._activeRootQuery&&e.forEach(e=>{e.MediaSelectionGroupMediaType===eo.AUDIO||e.MediaSelectionOptionsMediaType===eo.AUDIO?this.audioSelectedPersistentID=e.MediaSelectionOptionsPersistentID:e.MediaSelectionGroupMediaType!==eo.SUBTITLE&&e.MediaSelectionOptionsMediaType!==eo.SUBTITLE&&e.MediaSelectionOptionsMediaType!==eo.CLOSEDCAPTION||(this.subtitleSelectedPersistentID=e.MediaSelectionOptionsPersistentID)})}getHTMLTextTrack(e){return this.legibleSystemAdapter.getExistingHTMLTextTrackWithSubtitleTrackId(e)}get keysystems(){return this.keySystemAdapter.availableKeySystems}setProtectionData(e){this.keySystemAdapter.initialize(e,this.hlsService.query.currentConfig.certLoadPolicy)}generateKeyRequest(e,t){this.keySystemAdapter.generateRequest(e,t)&&this.rtcService.licenseChallengeReceived({keyuri:e})}setLicenseResponse(e,t){this.keySystemAdapter.setLicenseResponse(e,t)}get interstitialActive(){return!!this.interstitialService.interstitialQuery.playingInterstitialId}removeInterstitials(e){this.interstitialService.removeInterstitials(e)}cancelInterstitial(e,t){var i=this.interstitialService.interstitialQuery.getInterstitialForId(e);i&&(t=null!=t?t:E(i.startTime)+Ol(i),i=wl(this.itemQueue.playingItem.itemId),this.itemQueue.playingItem.isInterstitial&&i===e&&this.interstitialController.cancelInterstitial(t,null,!0))}createInterstitials(e){e=e.filter(e=>Lp(e)),this.interstitialService.addInterstitials(e)}updateInterstitial(e,t){this.interstitialService.updateInterstitial(e,t)}redoPlatformCapabilities(){return this.reloadPlayingItem({parentItemId:this.playingItem.parentItemId,itemId:this.playingItem.itemId})}getSelectedMediaArrayFromMatchingInfo(e=null){const t=[],i=this.hlsService.query.alternateMatchingInfo,r=null==i?void 0:i.audioMatchingInfo,n=null==i?void 0:i.subtitleMatchingInfo;if(e&&!Cl(e))return this.logger.error("attempt to query non-primary item's selectedMediaArray"),[];if(r&&!Cl(r.itemId))return this.logger.error(`audio matching info set by non-primary items: ${null==r?void 0:r.itemId}`),[];if(n&&!Cl(n.itemId))return this.logger.error(`subtitle matching info set by non-primary items: ${null==n?void 0:n.itemId}`),[];if(r){const e={MediaSelectionGroupMediaType:eo.AUDIO,MediaSelectionOptionsPersistentID:r.persistentId};t.push(e)}if(n){const e={MediaSelectionGroupMediaType:eo.SUBTITLE,MediaSelectionOptionsPersistentID:n.persistentId,MediaSelectionOptionsForced:n.forced};t.push(e)}return t}updateMatchingInfoWithSelectedMediaArray(r,e){var n=this.itemQueue.getQueueItemForId(r),a=this.rootPlaylistService.getQueryForId(null==n?void 0:n.itemId);if(a){const s=e.find(e=>e.MediaSelectionGroupMediaType===eo.AUDIO);let t;if(s){let e=s.MediaSelectionOptionsExtendedLanguageTag;if(!e){const r=(null!==(n=a.audioMediaSelectionOptions)&&void 0!==n?n:[]).find(e=>e.MediaSelectionOptionsPersistentID===s.MediaSelectionOptionsPersistentID);e=null==r?void 0:r.MediaSelectionOptionsExtendedLanguageTag}t={itemId:r,language:e,name:s.MediaSelectionOptionsName,persistentId:s.MediaSelectionOptionsPersistentID}}const o=e.find(e=>e.MediaSelectionGroupMediaType===eo.SUBTITLE);let i;if(o){let e=o.MediaSelectionOptionsExtendedLanguageTag;if(!e){const r=(null!==(a=a.subtitleMediaSelectionOptions)&&void 0!==a?a:[]).find(e=>e.MediaSelectionOptionsPersistentID===o.MediaSelectionOptionsPersistentID);e=null==r?void 0:r.MediaSelectionOptionsExtendedLanguageTag}i={itemId:r,language:e,name:o.MediaSelectionOptionsName,persistentId:o.MediaSelectionOptionsPersistentID,forced:!o.MediaSelectionOptionsDisplaysNonForcedSubtitles}}da(()=>{s&&this.hlsService.setAudioAlternateMatchingInfo(t),o&&this.hlsService.setSubtitleAlternateMatchingInfo(i)})}}changeTracks(e,t=!0){const i=(this.playingItem||this.loadingItem).itemId,r=this.itemQueue.primaryItem.itemId,n=t?r:i,a=Cm.toLocale(e).baseName;let s=[];e&&(s=[{MediaSelectionGroupMediaType:eo.AUDIO,MediaSelectionOptionsExtendedLanguageTag:a},{MediaSelectionGroupMediaType:eo.SUBTITLE,MediaSelectionOptionsExtendedLanguageTag:a,MediaSelectionOptionsDisplaysNonForcedSubtitles:Zs.YES}]),da(()=>{this.updateMatchingInfoWithSelectedMediaArray(n,s),this.reloadPlayingItem({parentItemId:this.playingItem.parentItemId,itemId:this.playingItem.itemId,userSwitchAudioTrack:!0,userSwitchSubtitleTrack:!0})})}reloadPlayingItem(e=null){var t,i,r;this._mediaElementQuery?(i=null==(t=this.itemQueue.activeItem)?void 0:t.itemId,r=this._mediaElementQuery.currentTime,this.hlsConfig.enableInterstitialPlayback?this.interstitialController.reloadPlayingItem(r,e,this.mediaElementAdapter,this.legibleSystemAdapter):(this.itemQueue.setActive(null,t.itemStartOffsets),this.itemQueue.setActiveWithContext(i,e,t.itemStartOffsets,r,!0))):this.logger.error("mediaSink not ready yet")}endItem(){this._queueOps=[Pn(this._endItemAndLoadInternal.bind(this,void 0))],this._queueOpsChanged$.next()}_endItemAndLoadInternal(a){var e;const s=null===(e=this.itemQueue.activeItem)||void 0===e?void 0:e.itemId,o=!!a,l=!!this.mediaLibService.getSegmentRecord(null===(e=null==a?void 0:a.itemOptions)||void 0===e?void 0:e.itemId),d=[];return da(()=>{var e,t;if(s){const a=this.hlsService.query.currentConfig,t=this.realCurrentTime,r=this.interstitialActive;this._pipelineCtx$.next(void 0);var i=!this.hlsConfig.enableItemPreloading||!l;if(this.mediaLibService.clear(i),this.rootPlaylistService.removeAll(),this.hlsService.reset(),a.enableInterstitialPlayback&&(null===(e=this.interstitialService)||void 0===e||e.reset(),null===(e=this.interstitialController)||void 0===e||e.reset()),null===(e=this.legibleSystemAdapter)||void 0===e||e.reset(),null===(e=this.mediaElementAdapter)||void 0===e||e.reset(),this.itemQueue.resetInternal(),a.enableBoss&&(null===(e=this._mediaSelectionBossService)||void 0===e||e.destroyItem(s)),d.push(Pn(()=>(this.rtcService.endItem(s,t,r),Yl))),this.mediaElementAdapter){const a=this.mediaElementAdapter.mediaQuery;if(a.combinedBuffer.length){let e;this.mediaElementAdapter.haveEnough=!1,a.paused||this.mediaElementAdapter.pause(),o?this.hlsConfig.replaceItemAction===Ws.DO_NOTHING&&(e=this.mediaElementAdapter.flushAll(0,1/0)):e=this.mediaElementAdapter.flushAll(0,1/0).pipe(on(()=>Jl(this.mediaElementAdapter.mediaQuery.updating$,e=>!e)),sr(()=>{this.mediaElementAdapter.msDuration=0})),e&&d.unshift(e)}}}if(o){const n=null!==(t=a.itemOptions)&&void 0!==t?t:{};s&&this.hlsConfig.replaceItemAction&&(n.replaceItemAction=this.hlsConfig.replaceItemAction),this._loadSourceInternal(a.url,n,a.initialSeekTime)}}),0<d.length?Ln(d).pipe(sr(()=>{})):Yl}levelWithPersistentId(e){}startLoad(e){z(e)&&(this.seekTo=e)}stopLoad(){}get config(){return this.hlsConfig}get media(){return null!=this.mediaElement$.value}set subtitleDisplay(e){}_makeActiveItemAdapters(o,e,t){var i;if(this.playerEvents.setRootPlaylistQuery(null),this._rootQuery$.next(null),null===(i=this._mediaParser)||void 0===i||i.reset(),!o)return Pr(null);const r=Object.assign({},t);if(null!=o&&o.isInterstitial)for(const o of mo){const e=t[o].interstitial,i=t[o];r[o]=Object.assign(Object.assign({},i),{default:e,customURL:e})}return ur([Zy(o,t.manifestLoadPolicy,this.rootPlaylistService,this.mediaLibService,this.interstitialService,this.customUrlLoader,this._mediaSelectionBossService,this.hlsService,t,this.platformService.query,this.hlsService.query,this.statsService,this.playerEvents,this.itemQueue).pipe(on(e=>(this.playerEvents.setRootPlaylistQuery(e),this._rootQuery$.next(e),this.playerEvents.triggerManifestParsed(e),Vn(function(e,t,i,r,n,a,s,o,l,d,u,c){const h=t["canUseNetworkResourcesForLiveStreamingWhilePaused"],p={rootPlaylistQuery:r,rootPlaylistService:i,statsService:a,rtcService:s,logger:e,config:t,interstitialService:o,customUrlLoader:u,itemQueue:c,hlsService:l},m=[];return Po.forEach(e=>{e!==Ys.Variant&&!r.hasAlternateWithUrl(e)||m.push(r.enabledMediaOptionByType$(e).pipe(on(e=>Co(e)&&Ro(e)?n.retrieveMediaOptionDetails(p,e,!1,!1).pipe(Fr(t=>function(e){if(!e)return Cr;var{mediaOptionDetails:t,lastUpdateMillis:i,unchangedCount:e}=e;if(null==t||!t.liveOrEvent)return Cr;if(Wf(t,i))return Ki(0).pipe();let r=zf(t);return 0<e&&(r/=2,r=Math.max(r,5e3)),r-=performance.now()-i,r+=0,r=Math.max(1e3,Math.round(r)),Ki(r).pipe()}(n.getQueryForOption(t).mediaOptionDetailsEntity).pipe(on(()=>h?Pr(!0):d.pipe(on(e=>e?e.desiredRate$:Pr(0))).pipe(sr(e=>0!==e),xr())),on(e=>e?n.retrieveMediaOptionDetails(p,t,!1,!0):Cr),kr(1)),1)):Cr)))}),Vn(...m).pipe(Oy(e,"loadMediaOptions"))}(this.logger,r,this.rootPlaylistService,e,this.mediaLibService,this.statsService,this.rtcService,this.interstitialService,this.hlsService,this.mediaElementQuery$,this.customUrlLoader,this.itemQueue).pipe(on(()=>Cr)),Pr(e))))),Pn(()=>(null==this._mediaParser&&(this._mediaParser=new ky(t,this.logger,this.rpcClients.mux)),Pr(this._mediaParser))),Pr(r)]).pipe(on(e=>{var[t,i,r]=e,s={logger:this.logger,config:r,statsService:this.statsService,rootPlaylistQuery:t,rootPlaylistService:this.rootPlaylistService,interstitialService:this.interstitialService,mediaParser:i,gaplessInstance:this,keySystemAdapter:this.keySystemAdapter,rpcClients:this.rpcClients,rtcService:this.rtcService,customUrlLoader:this.customUrlLoader,itemQueue:this.itemQueue,hlsService:this.hlsService},e=null===(e=this.itemQueue.getQueueItemForId(t.itemId))||void 0===e?void 0:e.name;return(e=s.config.enableItemPreloading?this.mediaLibService.getPrefetchCache(e):void 0)&&e.fragRequest?Pr({rootPlaylistQuery:t,mediaParser:i,config:r}):Vn(function(e,t,i){const r=s["rootPlaylistQuery"],n=function(s,o,l,d,u){const c=l.rootPlaylistQuery.appItemId;return e=>e.pipe(Ug(s,1),on((i,r)=>{if(i&&0===r){const n=Object.values(i.initSegments);let e,t=NaN;if(i.liveOrEvent)1===n.length&&(t=n[0].discoSeqNum);else{const s=d.pendingSeek;r=s instanceof Date?by(i.pdtToMSN,i.fragments,s):Ty(null!==(r=null!=s?s:u)&&void 0!==r?r:0,!0,[i,null],l.config,l.rootPlaylistQuery,void 0,!1,l.logger),e=Sy.findFragmentBySNAndBuffer(void 0,i.fragments,r,ef(i)),t=C(null==e?void 0:e.discoSeqNum,NaN)}const a=new Array;if(e?a.push(s.cacheFrag(l,e)):z(t)&&a.push(s.retrieveInitSegmentCacheEntity(l,i,t)),null!=e&&e.keyTagInfo&&o){const s=e.keyTagInfo;a.push(o.getKeyFromDecryptData(s,{itemId:e.itemId,mediaOptionId:e.mediaOptionId,appItemId:c},l.config.keyLoadPolicy))}if(0<a.length)return Ln(a)}return Yl}),kr(1),on(()=>Cr),Wi(e=>(l.logger.error(`prefetchFirstSegAndKey: err=${e.message}`),Cr)))}(e,t,s,i,o.initialSeekTime),a=[r.enabledMediaOptionByType$(Ys.Variant).pipe(n)];return r.hasAlternateWithUrl(Ys.AltAudio)&&a.push(r.enabledMediaOptionByType$(Ys.AltAudio).pipe(n)),Vn(...a)}(this.mediaLibService,this.keySystemAdapter,this.hlsService.query),Pr({rootPlaylistQuery:t,mediaParser:i,config:r}))}))}}},"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||dv).Hls=t()}(!1);
//# sourceMappingURL=hls.js.map
